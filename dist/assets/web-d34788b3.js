import{W as li,E as rt}from"./index-dfe763da.js";/*!
 *  Spatial Plugin - Adds support for stereo and 3D audio where Web Audio is supported.
 *  
 *  howler.js v2.2.3
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */function ci(f,o,u,_){f.prototype._pos=[0,0,0],f.prototype._orientation=[0,0,-1,0,1,0],f.prototype.stereo=function(C){var S=this;if(!S.ctx||!S.ctx.listener)return S;for(var x=S._howls.length-1;x>=0;x--)S._howls[x].stereo(C);return S},f.prototype.pos=function(C,S,x){var L=this;if(!L.ctx||!L.ctx.listener)return L;if(S=typeof S!="number"?L._pos[1]:S,x=typeof x!="number"?L._pos[2]:x,typeof C=="number")L._pos=[C,S,x],typeof L.ctx.listener.positionX<"u"?(L.ctx.listener.positionX.setTargetAtTime(L._pos[0],o.ctx.currentTime,.1),L.ctx.listener.positionY.setTargetAtTime(L._pos[1],o.ctx.currentTime,.1),L.ctx.listener.positionZ.setTargetAtTime(L._pos[2],o.ctx.currentTime,.1)):L.ctx.listener.setPosition(L._pos[0],L._pos[1],L._pos[2]);else return L._pos;return L},f.prototype.orientation=function(C,S,x,L,I,E){var F=this;if(!F.ctx||!F.ctx.listener)return F;var M=F._orientation;if(S=typeof S!="number"?M[1]:S,x=typeof x!="number"?M[2]:x,L=typeof L!="number"?M[3]:L,I=typeof I!="number"?M[4]:I,E=typeof E!="number"?M[5]:E,typeof C=="number")F._orientation=[C,S,x,L,I,E],typeof F.ctx.listener.forwardX<"u"?(F.ctx.listener.forwardX.setTargetAtTime(C,o.ctx.currentTime,.1),F.ctx.listener.forwardY.setTargetAtTime(S,o.ctx.currentTime,.1),F.ctx.listener.forwardZ.setTargetAtTime(x,o.ctx.currentTime,.1),F.ctx.listener.upX.setTargetAtTime(L,o.ctx.currentTime,.1),F.ctx.listener.upY.setTargetAtTime(I,o.ctx.currentTime,.1),F.ctx.listener.upZ.setTargetAtTime(E,o.ctx.currentTime,.1)):F.ctx.listener.setOrientation(C,S,x,L,I,E);else return M;return F},u.prototype.init=function(C){return function(S){var x=this;return x._orientation=S.orientation||[1,0,0],x._stereo=S.stereo||null,x._pos=S.pos||null,x._pannerAttr={coneInnerAngle:typeof S.coneInnerAngle<"u"?S.coneInnerAngle:360,coneOuterAngle:typeof S.coneOuterAngle<"u"?S.coneOuterAngle:360,coneOuterGain:typeof S.coneOuterGain<"u"?S.coneOuterGain:0,distanceModel:typeof S.distanceModel<"u"?S.distanceModel:"inverse",maxDistance:typeof S.maxDistance<"u"?S.maxDistance:1e4,panningModel:typeof S.panningModel<"u"?S.panningModel:"HRTF",refDistance:typeof S.refDistance<"u"?S.refDistance:1,rolloffFactor:typeof S.rolloffFactor<"u"?S.rolloffFactor:1},x._onstereo=S.onstereo?[{fn:S.onstereo}]:[],x._onpos=S.onpos?[{fn:S.onpos}]:[],x._onorientation=S.onorientation?[{fn:S.onorientation}]:[],C.call(this,S)}}(u.prototype.init),u.prototype.stereo=function(C,S){var x=this;if(!x._webAudio)return x;if(x._state!=="loaded")return x._queue.push({event:"stereo",action:function(){x.stereo(C,S)}}),x;var L=typeof o.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof S>"u")if(typeof C=="number")x._stereo=C,x._pos=[C,0,0];else return x._stereo;for(var I=x._getSoundIds(S),E=0;E<I.length;E++){var F=x._soundById(I[E]);if(F)if(typeof C=="number")F._stereo=C,F._pos=[C,0,0],F._node&&(F._pannerAttr.panningModel="equalpower",(!F._panner||!F._panner.pan)&&v(F,L),L==="spatial"?typeof F._panner.positionX<"u"?(F._panner.positionX.setValueAtTime(C,o.ctx.currentTime),F._panner.positionY.setValueAtTime(0,o.ctx.currentTime),F._panner.positionZ.setValueAtTime(0,o.ctx.currentTime)):F._panner.setPosition(C,0,0):F._panner.pan.setValueAtTime(C,o.ctx.currentTime)),x._emit("stereo",F._id);else return F._stereo}return x},u.prototype.pos=function(C,S,x,L){var I=this;if(!I._webAudio)return I;if(I._state!=="loaded")return I._queue.push({event:"pos",action:function(){I.pos(C,S,x,L)}}),I;if(S=typeof S!="number"?0:S,x=typeof x!="number"?-.5:x,typeof L>"u")if(typeof C=="number")I._pos=[C,S,x];else return I._pos;for(var E=I._getSoundIds(L),F=0;F<E.length;F++){var M=I._soundById(E[F]);if(M)if(typeof C=="number")M._pos=[C,S,x],M._node&&((!M._panner||M._panner.pan)&&v(M,"spatial"),typeof M._panner.positionX<"u"?(M._panner.positionX.setValueAtTime(C,o.ctx.currentTime),M._panner.positionY.setValueAtTime(S,o.ctx.currentTime),M._panner.positionZ.setValueAtTime(x,o.ctx.currentTime)):M._panner.setPosition(C,S,x)),I._emit("pos",M._id);else return M._pos}return I},u.prototype.orientation=function(C,S,x,L){var I=this;if(!I._webAudio)return I;if(I._state!=="loaded")return I._queue.push({event:"orientation",action:function(){I.orientation(C,S,x,L)}}),I;if(S=typeof S!="number"?I._orientation[1]:S,x=typeof x!="number"?I._orientation[2]:x,typeof L>"u")if(typeof C=="number")I._orientation=[C,S,x];else return I._orientation;for(var E=I._getSoundIds(L),F=0;F<E.length;F++){var M=I._soundById(E[F]);if(M)if(typeof C=="number")M._orientation=[C,S,x],M._node&&(M._panner||(M._pos||(M._pos=I._pos||[0,0,-.5]),v(M,"spatial")),typeof M._panner.orientationX<"u"?(M._panner.orientationX.setValueAtTime(C,o.ctx.currentTime),M._panner.orientationY.setValueAtTime(S,o.ctx.currentTime),M._panner.orientationZ.setValueAtTime(x,o.ctx.currentTime)):M._panner.setOrientation(C,S,x)),I._emit("orientation",M._id);else return M._orientation}return I},u.prototype.pannerAttr=function(){var C=this,S=arguments,x,L,I;if(!C._webAudio)return C;if(S.length===0)return C._pannerAttr;if(S.length===1)if(typeof S[0]=="object")x=S[0],typeof L>"u"&&(x.pannerAttr||(x.pannerAttr={coneInnerAngle:x.coneInnerAngle,coneOuterAngle:x.coneOuterAngle,coneOuterGain:x.coneOuterGain,distanceModel:x.distanceModel,maxDistance:x.maxDistance,refDistance:x.refDistance,rolloffFactor:x.rolloffFactor,panningModel:x.panningModel}),C._pannerAttr={coneInnerAngle:typeof x.pannerAttr.coneInnerAngle<"u"?x.pannerAttr.coneInnerAngle:C._coneInnerAngle,coneOuterAngle:typeof x.pannerAttr.coneOuterAngle<"u"?x.pannerAttr.coneOuterAngle:C._coneOuterAngle,coneOuterGain:typeof x.pannerAttr.coneOuterGain<"u"?x.pannerAttr.coneOuterGain:C._coneOuterGain,distanceModel:typeof x.pannerAttr.distanceModel<"u"?x.pannerAttr.distanceModel:C._distanceModel,maxDistance:typeof x.pannerAttr.maxDistance<"u"?x.pannerAttr.maxDistance:C._maxDistance,refDistance:typeof x.pannerAttr.refDistance<"u"?x.pannerAttr.refDistance:C._refDistance,rolloffFactor:typeof x.pannerAttr.rolloffFactor<"u"?x.pannerAttr.rolloffFactor:C._rolloffFactor,panningModel:typeof x.pannerAttr.panningModel<"u"?x.pannerAttr.panningModel:C._panningModel});else return I=C._soundById(parseInt(S[0],10)),I?I._pannerAttr:C._pannerAttr;else S.length===2&&(x=S[0],L=parseInt(S[1],10));for(var E=C._getSoundIds(L),F=0;F<E.length;F++)if(I=C._soundById(E[F]),I){var M=I._pannerAttr;M={coneInnerAngle:typeof x.coneInnerAngle<"u"?x.coneInnerAngle:M.coneInnerAngle,coneOuterAngle:typeof x.coneOuterAngle<"u"?x.coneOuterAngle:M.coneOuterAngle,coneOuterGain:typeof x.coneOuterGain<"u"?x.coneOuterGain:M.coneOuterGain,distanceModel:typeof x.distanceModel<"u"?x.distanceModel:M.distanceModel,maxDistance:typeof x.maxDistance<"u"?x.maxDistance:M.maxDistance,refDistance:typeof x.refDistance<"u"?x.refDistance:M.refDistance,rolloffFactor:typeof x.rolloffFactor<"u"?x.rolloffFactor:M.rolloffFactor,panningModel:typeof x.panningModel<"u"?x.panningModel:M.panningModel};var q=I._panner;q||(I._pos||(I._pos=C._pos||[0,0,-.5]),v(I,"spatial"),q=I._panner),q.coneInnerAngle=M.coneInnerAngle,q.coneOuterAngle=M.coneOuterAngle,q.coneOuterGain=M.coneOuterGain,q.distanceModel=M.distanceModel,q.maxDistance=M.maxDistance,q.refDistance=M.refDistance,q.rolloffFactor=M.rolloffFactor,q.panningModel=M.panningModel}return C},_.prototype.init=function(C){return function(){var S=this,x=S._parent;S._orientation=x._orientation,S._stereo=x._stereo,S._pos=x._pos,S._pannerAttr=x._pannerAttr,C.call(this),S._stereo?x.stereo(S._stereo):S._pos&&x.pos(S._pos[0],S._pos[1],S._pos[2],S._id)}}(_.prototype.init),_.prototype.reset=function(C){return function(){var S=this,x=S._parent;return S._orientation=x._orientation,S._stereo=x._stereo,S._pos=x._pos,S._pannerAttr=x._pannerAttr,S._stereo?x.stereo(S._stereo):S._pos?x.pos(S._pos[0],S._pos[1],S._pos[2],S._id):S._panner&&(S._panner.disconnect(0),S._panner=void 0,x._refreshBuffer(S)),C.call(this)}}(_.prototype.reset);var v=function(C,S){S=S||"spatial",S==="spatial"?(C._panner=o.ctx.createPanner(),C._panner.coneInnerAngle=C._pannerAttr.coneInnerAngle,C._panner.coneOuterAngle=C._pannerAttr.coneOuterAngle,C._panner.coneOuterGain=C._pannerAttr.coneOuterGain,C._panner.distanceModel=C._pannerAttr.distanceModel,C._panner.maxDistance=C._pannerAttr.maxDistance,C._panner.refDistance=C._pannerAttr.refDistance,C._panner.rolloffFactor=C._pannerAttr.rolloffFactor,C._panner.panningModel=C._pannerAttr.panningModel,typeof C._panner.positionX<"u"?(C._panner.positionX.setValueAtTime(C._pos[0],o.ctx.currentTime),C._panner.positionY.setValueAtTime(C._pos[1],o.ctx.currentTime),C._panner.positionZ.setValueAtTime(C._pos[2],o.ctx.currentTime)):C._panner.setPosition(C._pos[0],C._pos[1],C._pos[2]),typeof C._panner.orientationX<"u"?(C._panner.orientationX.setValueAtTime(C._orientation[0],o.ctx.currentTime),C._panner.orientationY.setValueAtTime(C._orientation[1],o.ctx.currentTime),C._panner.orientationZ.setValueAtTime(C._orientation[2],o.ctx.currentTime)):C._panner.setOrientation(C._orientation[0],C._orientation[1],C._orientation[2])):(C._panner=o.ctx.createStereoPanner(),C._panner.pan.setValueAtTime(C._stereo,o.ctx.currentTime)),C._panner.connect(C._node),C._paused||C._parent.pause(C._id,!0).play(C._id,!0)}}/*!
 *  howler.js v2.2.3
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */var yt=function(){this.init()};yt.prototype={init:function(){var f=this||ce;return f._counter=1e3,f._html5AudioPool=[],f.html5PoolSize=10,f._codecs={},f._howls=[],f._muted=!1,f._volume=1,f._canPlayEvent="canplaythrough",f._navigator=typeof window<"u"&&window.navigator?window.navigator:null,f.masterGain=null,f.noAudio=!1,f.usingWebAudio=!0,f.autoSuspend=!0,f.ctx=null,f.autoUnlock=!0,f._setup(),f},volume:function(f){var o=this||ce;if(f=parseFloat(f),o.ctx||ht(),typeof f<"u"&&f>=0&&f<=1){if(o._volume=f,o._muted)return o;o.usingWebAudio&&o.masterGain.gain.setValueAtTime(f,ce.ctx.currentTime);for(var u=0;u<o._howls.length;u++)if(!o._howls[u]._webAudio)for(var _=o._howls[u]._getSoundIds(),v=0;v<_.length;v++){var C=o._howls[u]._soundById(_[v]);C&&C._node&&(C._node.volume=C._volume*f)}return o}return o._volume},mute:function(f){var o=this||ce;o.ctx||ht(),o._muted=f,o.usingWebAudio&&o.masterGain.gain.setValueAtTime(f?0:o._volume,ce.ctx.currentTime);for(var u=0;u<o._howls.length;u++)if(!o._howls[u]._webAudio)for(var _=o._howls[u]._getSoundIds(),v=0;v<_.length;v++){var C=o._howls[u]._soundById(_[v]);C&&C._node&&(C._node.muted=f?!0:C._muted)}return o},stop:function(){for(var f=this||ce,o=0;o<f._howls.length;o++)f._howls[o].stop();return f},unload:function(){for(var f=this||ce,o=f._howls.length-1;o>=0;o--)f._howls[o].unload();return f.usingWebAudio&&f.ctx&&typeof f.ctx.close<"u"&&(f.ctx.close(),f.ctx=null,ht()),f},codecs:function(f){return(this||ce)._codecs[f.replace(/^x-/,"")]},_setup:function(){var f=this||ce;if(f.state=f.ctx&&f.ctx.state||"suspended",f._autoSuspend(),!f.usingWebAudio)if(typeof Audio<"u")try{var o=new Audio;typeof o.oncanplaythrough>"u"&&(f._canPlayEvent="canplay")}catch(u){f.noAudio=!0}else f.noAudio=!0;try{var o=new Audio;o.muted&&(f.noAudio=!0)}catch(u){}return f.noAudio||f._setupCodecs(),f},_setupCodecs:function(){var f=this||ce,o=null;try{o=typeof Audio<"u"?new Audio:null}catch(I){return f}if(!o||typeof o.canPlayType!="function")return f;var u=o.canPlayType("audio/mpeg;").replace(/^no$/,""),_=f._navigator?f._navigator.userAgent:"",v=_.match(/OPR\/([0-6].)/g),C=v&&parseInt(v[0].split("/")[1],10)<33,S=_.indexOf("Safari")!==-1&&_.indexOf("Chrome")===-1,x=_.match(/Version\/(.*?) /),L=S&&x&&parseInt(x[1],10)<15;return f._codecs={mp3:!!(!C&&(u||o.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!u,opus:!!o.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!o.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!o.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(o.canPlayType('audio/wav; codecs="1"')||o.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!o.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!o.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(o.canPlayType("audio/x-m4a;")||o.canPlayType("audio/m4a;")||o.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(o.canPlayType("audio/x-m4b;")||o.canPlayType("audio/m4b;")||o.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(o.canPlayType("audio/x-mp4;")||o.canPlayType("audio/mp4;")||o.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!L&&o.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!L&&o.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!o.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(o.canPlayType("audio/x-flac;")||o.canPlayType("audio/flac;")).replace(/^no$/,"")},f},_unlockAudio:function(){var f=this||ce;if(!(f._audioUnlocked||!f.ctx)){f._audioUnlocked=!1,f.autoUnlock=!1,!f._mobileUnloaded&&f.ctx.sampleRate!==44100&&(f._mobileUnloaded=!0,f.unload()),f._scratchBuffer=f.ctx.createBuffer(1,1,22050);var o=function(u){for(;f._html5AudioPool.length<f.html5PoolSize;)try{var _=new Audio;_._unlocked=!0,f._releaseHtml5Audio(_)}catch(I){f.noAudio=!0;break}for(var v=0;v<f._howls.length;v++)if(!f._howls[v]._webAudio)for(var C=f._howls[v]._getSoundIds(),S=0;S<C.length;S++){var x=f._howls[v]._soundById(C[S]);x&&x._node&&!x._node._unlocked&&(x._node._unlocked=!0,x._node.load())}f._autoResume();var L=f.ctx.createBufferSource();L.buffer=f._scratchBuffer,L.connect(f.ctx.destination),typeof L.start>"u"?L.noteOn(0):L.start(0),typeof f.ctx.resume=="function"&&f.ctx.resume(),L.onended=function(){L.disconnect(0),f._audioUnlocked=!0,document.removeEventListener("touchstart",o,!0),document.removeEventListener("touchend",o,!0),document.removeEventListener("click",o,!0),document.removeEventListener("keydown",o,!0);for(var I=0;I<f._howls.length;I++)f._howls[I]._emit("unlock")}};return document.addEventListener("touchstart",o,!0),document.addEventListener("touchend",o,!0),document.addEventListener("click",o,!0),document.addEventListener("keydown",o,!0),f}},_obtainHtml5Audio:function(){var f=this||ce;if(f._html5AudioPool.length)return f._html5AudioPool.pop();var o=new Audio().play();return o&&typeof Promise<"u"&&(o instanceof Promise||typeof o.then=="function")&&o.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(f){var o=this||ce;return f._unlocked&&o._html5AudioPool.push(f),o},_autoSuspend:function(){var f=this;if(!(!f.autoSuspend||!f.ctx||typeof f.ctx.suspend>"u"||!ce.usingWebAudio)){for(var o=0;o<f._howls.length;o++)if(f._howls[o]._webAudio){for(var u=0;u<f._howls[o]._sounds.length;u++)if(!f._howls[o]._sounds[u]._paused)return f}return f._suspendTimer&&clearTimeout(f._suspendTimer),f._suspendTimer=setTimeout(function(){if(f.autoSuspend){f._suspendTimer=null,f.state="suspending";var _=function(){f.state="suspended",f._resumeAfterSuspend&&(delete f._resumeAfterSuspend,f._autoResume())};f.ctx.suspend().then(_,_)}},3e4),f}},_autoResume:function(){var f=this;if(!(!f.ctx||typeof f.ctx.resume>"u"||!ce.usingWebAudio))return f.state==="running"&&f.ctx.state!=="interrupted"&&f._suspendTimer?(clearTimeout(f._suspendTimer),f._suspendTimer=null):f.state==="suspended"||f.state==="running"&&f.ctx.state==="interrupted"?(f.ctx.resume().then(function(){f.state="running";for(var o=0;o<f._howls.length;o++)f._howls[o]._emit("resume")}),f._suspendTimer&&(clearTimeout(f._suspendTimer),f._suspendTimer=null)):f.state==="suspending"&&(f._resumeAfterSuspend=!0),f}};var ce=new yt,lt=function(f){var o=this;if(!f.src||f.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}o.init(f)};lt.prototype={init:function(f){var o=this;return ce.ctx||ht(),o._autoplay=f.autoplay||!1,o._format=typeof f.format!="string"?f.format:[f.format],o._html5=f.html5||!1,o._muted=f.mute||!1,o._loop=f.loop||!1,o._pool=f.pool||5,o._preload=typeof f.preload=="boolean"||f.preload==="metadata"?f.preload:!0,o._rate=f.rate||1,o._sprite=f.sprite||{},o._src=typeof f.src!="string"?f.src:[f.src],o._volume=f.volume!==void 0?f.volume:1,o._xhr={method:f.xhr&&f.xhr.method?f.xhr.method:"GET",headers:f.xhr&&f.xhr.headers?f.xhr.headers:null,withCredentials:f.xhr&&f.xhr.withCredentials?f.xhr.withCredentials:!1},o._duration=0,o._state="unloaded",o._sounds=[],o._endTimers={},o._queue=[],o._playLock=!1,o._onend=f.onend?[{fn:f.onend}]:[],o._onfade=f.onfade?[{fn:f.onfade}]:[],o._onload=f.onload?[{fn:f.onload}]:[],o._onloaderror=f.onloaderror?[{fn:f.onloaderror}]:[],o._onplayerror=f.onplayerror?[{fn:f.onplayerror}]:[],o._onpause=f.onpause?[{fn:f.onpause}]:[],o._onplay=f.onplay?[{fn:f.onplay}]:[],o._onstop=f.onstop?[{fn:f.onstop}]:[],o._onmute=f.onmute?[{fn:f.onmute}]:[],o._onvolume=f.onvolume?[{fn:f.onvolume}]:[],o._onrate=f.onrate?[{fn:f.onrate}]:[],o._onseek=f.onseek?[{fn:f.onseek}]:[],o._onunlock=f.onunlock?[{fn:f.onunlock}]:[],o._onresume=[],o._webAudio=ce.usingWebAudio&&!o._html5,typeof ce.ctx<"u"&&ce.ctx&&ce.autoUnlock&&ce._unlockAudio(),ce._howls.push(o),o._autoplay&&o._queue.push({event:"play",action:function(){o.play()}}),o._preload&&o._preload!=="none"&&o.load(),o},load:function(){var f=this,o=null;if(ce.noAudio){f._emit("loaderror",null,"No audio support.");return}typeof f._src=="string"&&(f._src=[f._src]);for(var u=0;u<f._src.length;u++){var _,v;if(f._format&&f._format[u])_=f._format[u];else{if(v=f._src[u],typeof v!="string"){f._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}_=/^data:audio\/([^;,]+);/i.exec(v),_||(_=/\.([^.]+)$/.exec(v.split("?",1)[0])),_&&(_=_[1].toLowerCase())}if(_||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),_&&ce.codecs(_)){o=f._src[u];break}}if(!o){f._emit("loaderror",null,"No codec support for selected audio sources.");return}return f._src=o,f._state="loading",window.location.protocol==="https:"&&o.slice(0,5)==="http:"&&(f._html5=!0,f._webAudio=!1),new ct(f),f._webAudio&&ui(f),f},play:function(f,o){var u=this,_=null;if(typeof f=="number")_=f,f=null;else{if(typeof f=="string"&&u._state==="loaded"&&!u._sprite[f])return null;if(typeof f>"u"&&(f="__default",!u._playLock)){for(var v=0,C=0;C<u._sounds.length;C++)u._sounds[C]._paused&&!u._sounds[C]._ended&&(v++,_=u._sounds[C]._id);v===1?f=null:_=null}}var S=_?u._soundById(_):u._inactiveSound();if(!S)return null;if(_&&!f&&(f=S._sprite||"__default"),u._state!=="loaded"){S._sprite=f,S._ended=!1;var x=S._id;return u._queue.push({event:"play",action:function(){u.play(x)}}),x}if(_&&!S._paused)return o||u._loadQueue("play"),S._id;u._webAudio&&ce._autoResume();var L=Math.max(0,S._seek>0?S._seek:u._sprite[f][0]/1e3),I=Math.max(0,(u._sprite[f][0]+u._sprite[f][1])/1e3-L),E=I*1e3/Math.abs(S._rate),F=u._sprite[f][0]/1e3,M=(u._sprite[f][0]+u._sprite[f][1])/1e3;S._sprite=f,S._ended=!1;var q=function(){S._paused=!1,S._seek=L,S._start=F,S._stop=M,S._loop=!!(S._loop||u._sprite[f][2])};if(L>=M){u._ended(S);return}var se=S._node;if(u._webAudio){var K=function(){u._playLock=!1,q(),u._refreshBuffer(S);var $=S._muted||u._muted?0:S._volume;se.gain.setValueAtTime($,ce.ctx.currentTime),S._playStart=ce.ctx.currentTime,typeof se.bufferSource.start>"u"?S._loop?se.bufferSource.noteGrainOn(0,L,86400):se.bufferSource.noteGrainOn(0,L,I):S._loop?se.bufferSource.start(0,L,86400):se.bufferSource.start(0,L,I),E!==1/0&&(u._endTimers[S._id]=setTimeout(u._ended.bind(u,S),E)),o||setTimeout(function(){u._emit("play",S._id),u._loadQueue()},0)};ce.state==="running"&&ce.ctx.state!=="interrupted"?K():(u._playLock=!0,u.once("resume",K),u._clearTimer(S._id))}else{var J=function(){se.currentTime=L,se.muted=S._muted||u._muted||ce._muted||se.muted,se.volume=S._volume*ce.volume(),se.playbackRate=S._rate;try{var $=se.play();if($&&typeof Promise<"u"&&($ instanceof Promise||typeof $.then=="function")?(u._playLock=!0,q(),$.then(function(){u._playLock=!1,se._unlocked=!0,o?u._loadQueue():u._emit("play",S._id)}).catch(function(){u._playLock=!1,u._emit("playerror",S._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),S._ended=!0,S._paused=!0})):o||(u._playLock=!1,q(),u._emit("play",S._id)),se.playbackRate=S._rate,se.paused){u._emit("playerror",S._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}f!=="__default"||S._loop?u._endTimers[S._id]=setTimeout(u._ended.bind(u,S),E):(u._endTimers[S._id]=function(){u._ended(S),se.removeEventListener("ended",u._endTimers[S._id],!1)},se.addEventListener("ended",u._endTimers[S._id],!1))}catch(pe){u._emit("playerror",S._id,pe)}};se.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(se.src=u._src,se.load());var le=window&&window.ejecta||!se.readyState&&ce._navigator.isCocoonJS;if(se.readyState>=3||le)J();else{u._playLock=!0,u._state="loading";var ue=function(){u._state="loaded",J(),se.removeEventListener(ce._canPlayEvent,ue,!1)};se.addEventListener(ce._canPlayEvent,ue,!1),u._clearTimer(S._id)}}return S._id},pause:function(f){var o=this;if(o._state!=="loaded"||o._playLock)return o._queue.push({event:"pause",action:function(){o.pause(f)}}),o;for(var u=o._getSoundIds(f),_=0;_<u.length;_++){o._clearTimer(u[_]);var v=o._soundById(u[_]);if(v&&!v._paused&&(v._seek=o.seek(u[_]),v._rateSeek=0,v._paused=!0,o._stopFade(u[_]),v._node))if(o._webAudio){if(!v._node.bufferSource)continue;typeof v._node.bufferSource.stop>"u"?v._node.bufferSource.noteOff(0):v._node.bufferSource.stop(0),o._cleanBuffer(v._node)}else(!isNaN(v._node.duration)||v._node.duration===1/0)&&v._node.pause();arguments[1]||o._emit("pause",v?v._id:null)}return o},stop:function(f,o){var u=this;if(u._state!=="loaded"||u._playLock)return u._queue.push({event:"stop",action:function(){u.stop(f)}}),u;for(var _=u._getSoundIds(f),v=0;v<_.length;v++){u._clearTimer(_[v]);var C=u._soundById(_[v]);C&&(C._seek=C._start||0,C._rateSeek=0,C._paused=!0,C._ended=!0,u._stopFade(_[v]),C._node&&(u._webAudio?C._node.bufferSource&&(typeof C._node.bufferSource.stop>"u"?C._node.bufferSource.noteOff(0):C._node.bufferSource.stop(0),u._cleanBuffer(C._node)):(!isNaN(C._node.duration)||C._node.duration===1/0)&&(C._node.currentTime=C._start||0,C._node.pause(),C._node.duration===1/0&&u._clearSound(C._node))),o||u._emit("stop",C._id))}return u},mute:function(f,o){var u=this;if(u._state!=="loaded"||u._playLock)return u._queue.push({event:"mute",action:function(){u.mute(f,o)}}),u;if(typeof o>"u")if(typeof f=="boolean")u._muted=f;else return u._muted;for(var _=u._getSoundIds(o),v=0;v<_.length;v++){var C=u._soundById(_[v]);C&&(C._muted=f,C._interval&&u._stopFade(C._id),u._webAudio&&C._node?C._node.gain.setValueAtTime(f?0:C._volume,ce.ctx.currentTime):C._node&&(C._node.muted=ce._muted?!0:f),u._emit("mute",C._id))}return u},volume:function(){var f=this,o=arguments,u,_;if(o.length===0)return f._volume;if(o.length===1||o.length===2&&typeof o[1]>"u"){var v=f._getSoundIds(),C=v.indexOf(o[0]);C>=0?_=parseInt(o[0],10):u=parseFloat(o[0])}else o.length>=2&&(u=parseFloat(o[0]),_=parseInt(o[1],10));var S;if(typeof u<"u"&&u>=0&&u<=1){if(f._state!=="loaded"||f._playLock)return f._queue.push({event:"volume",action:function(){f.volume.apply(f,o)}}),f;typeof _>"u"&&(f._volume=u),_=f._getSoundIds(_);for(var x=0;x<_.length;x++)S=f._soundById(_[x]),S&&(S._volume=u,o[2]||f._stopFade(_[x]),f._webAudio&&S._node&&!S._muted?S._node.gain.setValueAtTime(u,ce.ctx.currentTime):S._node&&!S._muted&&(S._node.volume=u*ce.volume()),f._emit("volume",S._id))}else return S=_?f._soundById(_):f._sounds[0],S?S._volume:0;return f},fade:function(f,o,u,_){var v=this;if(v._state!=="loaded"||v._playLock)return v._queue.push({event:"fade",action:function(){v.fade(f,o,u,_)}}),v;f=Math.min(Math.max(0,parseFloat(f)),1),o=Math.min(Math.max(0,parseFloat(o)),1),u=parseFloat(u),v.volume(f,_);for(var C=v._getSoundIds(_),S=0;S<C.length;S++){var x=v._soundById(C[S]);if(x){if(_||v._stopFade(C[S]),v._webAudio&&!x._muted){var L=ce.ctx.currentTime,I=L+u/1e3;x._volume=f,x._node.gain.setValueAtTime(f,L),x._node.gain.linearRampToValueAtTime(o,I)}v._startFadeInterval(x,f,o,u,C[S],typeof _>"u")}}return v},_startFadeInterval:function(f,o,u,_,v,C){var S=this,x=o,L=u-o,I=Math.abs(L/.01),E=Math.max(4,I>0?_/I:_),F=Date.now();f._fadeTo=u,f._interval=setInterval(function(){var M=(Date.now()-F)/_;F=Date.now(),x+=L*M,x=Math.round(x*100)/100,L<0?x=Math.max(u,x):x=Math.min(u,x),S._webAudio?f._volume=x:S.volume(x,f._id,!0),C&&(S._volume=x),(u<o&&x<=u||u>o&&x>=u)&&(clearInterval(f._interval),f._interval=null,f._fadeTo=null,S.volume(u,f._id),S._emit("fade",f._id))},E)},_stopFade:function(f){var o=this,u=o._soundById(f);return u&&u._interval&&(o._webAudio&&u._node.gain.cancelScheduledValues(ce.ctx.currentTime),clearInterval(u._interval),u._interval=null,o.volume(u._fadeTo,f),u._fadeTo=null,o._emit("fade",f)),o},loop:function(){var f=this,o=arguments,u,_,v;if(o.length===0)return f._loop;if(o.length===1)if(typeof o[0]=="boolean")u=o[0],f._loop=u;else return v=f._soundById(parseInt(o[0],10)),v?v._loop:!1;else o.length===2&&(u=o[0],_=parseInt(o[1],10));for(var C=f._getSoundIds(_),S=0;S<C.length;S++)v=f._soundById(C[S]),v&&(v._loop=u,f._webAudio&&v._node&&v._node.bufferSource&&(v._node.bufferSource.loop=u,u&&(v._node.bufferSource.loopStart=v._start||0,v._node.bufferSource.loopEnd=v._stop,f.playing(C[S])&&(f.pause(C[S],!0),f.play(C[S],!0)))));return f},rate:function(){var f=this,o=arguments,u,_;if(o.length===0)_=f._sounds[0]._id;else if(o.length===1){var v=f._getSoundIds(),C=v.indexOf(o[0]);C>=0?_=parseInt(o[0],10):u=parseFloat(o[0])}else o.length===2&&(u=parseFloat(o[0]),_=parseInt(o[1],10));var S;if(typeof u=="number"){if(f._state!=="loaded"||f._playLock)return f._queue.push({event:"rate",action:function(){f.rate.apply(f,o)}}),f;typeof _>"u"&&(f._rate=u),_=f._getSoundIds(_);for(var x=0;x<_.length;x++)if(S=f._soundById(_[x]),S){f.playing(_[x])&&(S._rateSeek=f.seek(_[x]),S._playStart=f._webAudio?ce.ctx.currentTime:S._playStart),S._rate=u,f._webAudio&&S._node&&S._node.bufferSource?S._node.bufferSource.playbackRate.setValueAtTime(u,ce.ctx.currentTime):S._node&&(S._node.playbackRate=u);var L=f.seek(_[x]),I=(f._sprite[S._sprite][0]+f._sprite[S._sprite][1])/1e3-L,E=I*1e3/Math.abs(S._rate);(f._endTimers[_[x]]||!S._paused)&&(f._clearTimer(_[x]),f._endTimers[_[x]]=setTimeout(f._ended.bind(f,S),E)),f._emit("rate",S._id)}}else return S=f._soundById(_),S?S._rate:f._rate;return f},seek:function(){var f=this,o=arguments,u,_;if(o.length===0)f._sounds.length&&(_=f._sounds[0]._id);else if(o.length===1){var v=f._getSoundIds(),C=v.indexOf(o[0]);C>=0?_=parseInt(o[0],10):f._sounds.length&&(_=f._sounds[0]._id,u=parseFloat(o[0]))}else o.length===2&&(u=parseFloat(o[0]),_=parseInt(o[1],10));if(typeof _>"u")return 0;if(typeof u=="number"&&(f._state!=="loaded"||f._playLock))return f._queue.push({event:"seek",action:function(){f.seek.apply(f,o)}}),f;var S=f._soundById(_);if(S)if(typeof u=="number"&&u>=0){var x=f.playing(_);x&&f.pause(_,!0),S._seek=u,S._ended=!1,f._clearTimer(_),!f._webAudio&&S._node&&!isNaN(S._node.duration)&&(S._node.currentTime=u);var L=function(){x&&f.play(_,!0),f._emit("seek",_)};if(x&&!f._webAudio){var I=function(){f._playLock?setTimeout(I,0):L()};setTimeout(I,0)}else L()}else if(f._webAudio){var E=f.playing(_)?ce.ctx.currentTime-S._playStart:0,F=S._rateSeek?S._rateSeek-S._seek:0;return S._seek+(F+E*Math.abs(S._rate))}else return S._node.currentTime;return f},playing:function(f){var o=this;if(typeof f=="number"){var u=o._soundById(f);return u?!u._paused:!1}for(var _=0;_<o._sounds.length;_++)if(!o._sounds[_]._paused)return!0;return!1},duration:function(f){var o=this,u=o._duration,_=o._soundById(f);return _&&(u=o._sprite[_._sprite][1]/1e3),u},state:function(){return this._state},unload:function(){for(var f=this,o=f._sounds,u=0;u<o.length;u++)o[u]._paused||f.stop(o[u]._id),f._webAudio||(f._clearSound(o[u]._node),o[u]._node.removeEventListener("error",o[u]._errorFn,!1),o[u]._node.removeEventListener(ce._canPlayEvent,o[u]._loadFn,!1),o[u]._node.removeEventListener("ended",o[u]._endFn,!1),ce._releaseHtml5Audio(o[u]._node)),delete o[u]._node,f._clearTimer(o[u]._id);var _=ce._howls.indexOf(f);_>=0&&ce._howls.splice(_,1);var v=!0;for(u=0;u<ce._howls.length;u++)if(ce._howls[u]._src===f._src||f._src.indexOf(ce._howls[u]._src)>=0){v=!1;break}return Qe&&v&&delete Qe[f._src],ce.noAudio=!1,f._state="unloaded",f._sounds=[],f=null,null},on:function(f,o,u,_){var v=this,C=v["_on"+f];return typeof o=="function"&&C.push(_?{id:u,fn:o,once:_}:{id:u,fn:o}),v},off:function(f,o,u){var _=this,v=_["_on"+f],C=0;if(typeof o=="number"&&(u=o,o=null),o||u)for(C=0;C<v.length;C++){var S=u===v[C].id;if(o===v[C].fn&&S||!o&&S){v.splice(C,1);break}}else if(f)_["_on"+f]=[];else{var x=Object.keys(_);for(C=0;C<x.length;C++)x[C].indexOf("_on")===0&&Array.isArray(_[x[C]])&&(_[x[C]]=[])}return _},once:function(f,o,u){var _=this;return _.on(f,o,u,1),_},_emit:function(f,o,u){for(var _=this,v=_["_on"+f],C=v.length-1;C>=0;C--)(!v[C].id||v[C].id===o||f==="load")&&(setTimeout((function(S){S.call(this,o,u)}).bind(_,v[C].fn),0),v[C].once&&_.off(f,v[C].fn,v[C].id));return _._loadQueue(f),_},_loadQueue:function(f){var o=this;if(o._queue.length>0){var u=o._queue[0];u.event===f&&(o._queue.shift(),o._loadQueue()),f||u.action()}return o},_ended:function(f){var o=this,u=f._sprite;if(!o._webAudio&&f._node&&!f._node.paused&&!f._node.ended&&f._node.currentTime<f._stop)return setTimeout(o._ended.bind(o,f),100),o;var _=!!(f._loop||o._sprite[u][2]);if(o._emit("end",f._id),!o._webAudio&&_&&o.stop(f._id,!0).play(f._id),o._webAudio&&_){o._emit("play",f._id),f._seek=f._start||0,f._rateSeek=0,f._playStart=ce.ctx.currentTime;var v=(f._stop-f._start)*1e3/Math.abs(f._rate);o._endTimers[f._id]=setTimeout(o._ended.bind(o,f),v)}return o._webAudio&&!_&&(f._paused=!0,f._ended=!0,f._seek=f._start||0,f._rateSeek=0,o._clearTimer(f._id),o._cleanBuffer(f._node),ce._autoSuspend()),!o._webAudio&&!_&&o.stop(f._id,!0),o},_clearTimer:function(f){var o=this;if(o._endTimers[f]){if(typeof o._endTimers[f]!="function")clearTimeout(o._endTimers[f]);else{var u=o._soundById(f);u&&u._node&&u._node.removeEventListener("ended",o._endTimers[f],!1)}delete o._endTimers[f]}return o},_soundById:function(f){for(var o=this,u=0;u<o._sounds.length;u++)if(f===o._sounds[u]._id)return o._sounds[u];return null},_inactiveSound:function(){var f=this;f._drain();for(var o=0;o<f._sounds.length;o++)if(f._sounds[o]._ended)return f._sounds[o].reset();return new ct(f)},_drain:function(){var f=this,o=f._pool,u=0,_=0;if(!(f._sounds.length<o)){for(_=0;_<f._sounds.length;_++)f._sounds[_]._ended&&u++;for(_=f._sounds.length-1;_>=0;_--){if(u<=o)return;f._sounds[_]._ended&&(f._webAudio&&f._sounds[_]._node&&f._sounds[_]._node.disconnect(0),f._sounds.splice(_,1),u--)}}},_getSoundIds:function(f){var o=this;if(typeof f>"u"){for(var u=[],_=0;_<o._sounds.length;_++)u.push(o._sounds[_]._id);return u}else return[f]},_refreshBuffer:function(f){var o=this;return f._node.bufferSource=ce.ctx.createBufferSource(),f._node.bufferSource.buffer=Qe[o._src],f._panner?f._node.bufferSource.connect(f._panner):f._node.bufferSource.connect(f._node),f._node.bufferSource.loop=f._loop,f._loop&&(f._node.bufferSource.loopStart=f._start||0,f._node.bufferSource.loopEnd=f._stop||0),f._node.bufferSource.playbackRate.setValueAtTime(f._rate,ce.ctx.currentTime),o},_cleanBuffer:function(f){var o=this,u=ce._navigator&&ce._navigator.vendor.indexOf("Apple")>=0;if(!f.bufferSource)return o;if(ce._scratchBuffer&&f.bufferSource&&(f.bufferSource.onended=null,f.bufferSource.disconnect(0),u))try{f.bufferSource.buffer=ce._scratchBuffer}catch(_){}return f.bufferSource=null,o},_clearSound:function(f){var o=/MSIE |Trident\//.test(ce._navigator&&ce._navigator.userAgent);o||(f.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var ct=function(f){this._parent=f,this.init()};ct.prototype={init:function(){var f=this,o=f._parent;return f._muted=o._muted,f._loop=o._loop,f._volume=o._volume,f._rate=o._rate,f._seek=0,f._paused=!0,f._ended=!0,f._sprite="__default",f._id=++ce._counter,o._sounds.push(f),f.create(),f},create:function(){var f=this,o=f._parent,u=ce._muted||f._muted||f._parent._muted?0:f._volume;return o._webAudio?(f._node=typeof ce.ctx.createGain>"u"?ce.ctx.createGainNode():ce.ctx.createGain(),f._node.gain.setValueAtTime(u,ce.ctx.currentTime),f._node.paused=!0,f._node.connect(ce.masterGain)):ce.noAudio||(f._node=ce._obtainHtml5Audio(),f._errorFn=f._errorListener.bind(f),f._node.addEventListener("error",f._errorFn,!1),f._loadFn=f._loadListener.bind(f),f._node.addEventListener(ce._canPlayEvent,f._loadFn,!1),f._endFn=f._endListener.bind(f),f._node.addEventListener("ended",f._endFn,!1),f._node.src=o._src,f._node.preload=o._preload===!0?"auto":o._preload,f._node.volume=u*ce.volume(),f._node.load()),f},reset:function(){var f=this,o=f._parent;return f._muted=o._muted,f._loop=o._loop,f._volume=o._volume,f._rate=o._rate,f._seek=0,f._rateSeek=0,f._paused=!0,f._ended=!0,f._sprite="__default",f._id=++ce._counter,f},_errorListener:function(){var f=this;f._parent._emit("loaderror",f._id,f._node.error?f._node.error.code:0),f._node.removeEventListener("error",f._errorFn,!1)},_loadListener:function(){var f=this,o=f._parent;o._duration=Math.ceil(f._node.duration*10)/10,Object.keys(o._sprite).length===0&&(o._sprite={__default:[0,o._duration*1e3]}),o._state!=="loaded"&&(o._state="loaded",o._emit("load"),o._loadQueue()),f._node.removeEventListener(ce._canPlayEvent,f._loadFn,!1)},_endListener:function(){var f=this,o=f._parent;o._duration===1/0&&(o._duration=Math.ceil(f._node.duration*10)/10,o._sprite.__default[1]===1/0&&(o._sprite.__default[1]=o._duration*1e3),o._ended(f)),f._node.removeEventListener("ended",f._endFn,!1)}};var Qe={},ui=function(f){var o=f._src;if(Qe[o]){f._duration=Qe[o].duration,ii(f);return}if(/^data:[^;]+;base64,/.test(o)){for(var u=atob(o.split(",")[1]),_=new Uint8Array(u.length),v=0;v<u.length;++v)_[v]=u.charCodeAt(v);St(_.buffer,f)}else{var C=new XMLHttpRequest;C.open(f._xhr.method,o,!0),C.withCredentials=f._xhr.withCredentials,C.responseType="arraybuffer",f._xhr.headers&&Object.keys(f._xhr.headers).forEach(function(S){C.setRequestHeader(S,f._xhr.headers[S])}),C.onload=function(){var S=(C.status+"")[0];if(S!=="0"&&S!=="2"&&S!=="3"){f._emit("loaderror",null,"Failed loading audio file with status: "+C.status+".");return}St(C.response,f)},C.onerror=function(){f._webAudio&&(f._html5=!0,f._webAudio=!1,f._sounds=[],delete Qe[o],f.load())},di(C)}},di=function(f){try{f.send()}catch(o){f.onerror()}},St=function(f,o){var u=function(){o._emit("loaderror",null,"Decoding audio data failed.")},_=function(v){v&&o._sounds.length>0?(Qe[o._src]=v,ii(o,v)):u()};typeof Promise<"u"&&ce.ctx.decodeAudioData.length===1?ce.ctx.decodeAudioData(f).then(_).catch(u):ce.ctx.decodeAudioData(f,_,u)},ii=function(f,o){o&&!f._duration&&(f._duration=o.duration),Object.keys(f._sprite).length===0&&(f._sprite={__default:[0,f._duration*1e3]}),f._state!=="loaded"&&(f._state="loaded",f._emit("load"),f._loadQueue())},ht=function(){if(ce.usingWebAudio){try{typeof AudioContext<"u"?ce.ctx=new AudioContext:typeof webkitAudioContext<"u"?ce.ctx=new webkitAudioContext:ce.usingWebAudio=!1}catch(v){ce.usingWebAudio=!1}ce.ctx||(ce.usingWebAudio=!1);var f=/iP(hone|od|ad)/.test(ce._navigator&&ce._navigator.platform),o=ce._navigator&&ce._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),u=o?parseInt(o[1],10):null;if(f&&u&&u<9){var _=/safari/.test(ce._navigator&&ce._navigator.userAgent.toLowerCase());ce._navigator&&!_&&(ce.usingWebAudio=!1)}ce.usingWebAudio&&(ce.masterGain=typeof ce.ctx.createGain>"u"?ce.ctx.createGainNode():ce.ctx.createGain(),ce.masterGain.gain.setValueAtTime(ce._muted?0:ce._volume,ce.ctx.currentTime),ce.masterGain.connect(ce.ctx.destination)),ce._setup()}};ci(yt,ce,lt,ct);/*!
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Barcode Reader JS Edition
 * @website http://www.dynamsoft.com
 * @copyright Copyright 2022, Dynamsoft Corporation
 * @author Dynamsoft
 * @version 9.2.13 (js 20220810)
 * @fileoverview Dynamsoft JavaScript Library for Barcode Reader
 * More info on DBR JS: https://www.dynamsoft.com/barcode-reader/sdk-javascript/
 */const $e=typeof self>"u";let Ze,Pe,st,ut,Re;if(typeof navigator<"u"&&(Ze=navigator,Pe=Ze.userAgent,st=Ze.platform,ut=Ze.mediaDevices),!$e){const f={init:function(){this.browser=this.searchString(this.dataBrowser)||"unknownBrowser",this.version=this.searchVersion(Pe)||this.searchVersion(Ze.appVersion)||0,this.OS=this.searchString(this.dataOS)||"unknownOS",this.OS=="Linux"&&Pe.indexOf("Windows NT")!=-1&&(this.OS="HarmonyOS")},searchString:function(o){for(let u=0;u<o.length;u++){let _=o[u].string,v=o[u].prop;if(this.versionSearchString=o[u].versionSearch||o[u].identity,_){if(_.indexOf(o[u].subString)!=-1)return o[u].identity}else if(v)return o[u].identity}},searchVersion:function(o){let u=o.indexOf(this.versionSearchString);if(u!=-1)return parseFloat(o.substring(u+this.versionSearchString.length+1))},dataBrowser:[{string:Pe,subString:"Edge",identity:"Edge"},{string:Pe,subString:"OPR",identity:"OPR"},{string:Pe,subString:"Chrome",identity:"Chrome"},{string:Ze.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{string:Pe,subString:"Firefox",identity:"Firefox"},{string:Pe,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"}],dataOS:[{string:Pe,subString:"HarmonyOS",identity:"HarmonyOS"},{string:Pe,subString:"Android",identity:"Android"},{string:Pe,subString:"iPhone",identity:"iPhone"},{string:st,subString:"Win",identity:"Windows"},{string:st,subString:"Mac",identity:"Mac"},{string:st,subString:"Linux",identity:"Linux"}]};f.init(),Re={browser:f.browser,version:f.version,OS:f.OS}}$e&&(Re={browser:"ssr",version:0,OS:"ssr"});const fi=typeof WebAssembly<"u"&&Pe&&!(/Safari/.test(Pe)&&!/Chrome/.test(Pe)&&/\(.+\s11_2_([2-6]).*\)/.test(Pe)),gi=!(typeof Worker>"u"),ri=!(!ut||!ut.getUserMedia),pi=async()=>{let f=!1;if(ri)try{(await ut.getUserMedia({video:!0})).getTracks().forEach(o=>{o.stop()}),f=!0}catch(o){}return f};Re.browser==="Chrome"&&Re.version>66||Re.browser==="Safari"&&Re.version>13||Re.browser==="OPR"&&Re.version>43||Re.browser==="Edge"&&Re.version;const _i=(()=>{if(!$e&&document.currentScript){let f=document.currentScript.src,o=f.indexOf("?");if(o!=-1)f=f.substring(0,o);else{let u=f.indexOf("#");u!=-1&&(f=f.substring(0,u))}return f.substring(0,f.lastIndexOf("/")+1)}return"./"})(),nt=" is not allowed to change after `createInstance` or `loadWasm` is called.",mi=!$e&&document.currentScript&&(document.currentScript.getAttribute("data-license")||document.currentScript.getAttribute("data-productKeys")||document.currentScript.getAttribute("data-licenseKey")||document.currentScript.getAttribute("data-handshakeCode")||document.currentScript.getAttribute("data-organizationID"))||"",vi=!$e&&document.currentScript&&document.currentScript.getAttribute("data-sessionPassword")||"",bt=f=>{if(f==null)f=[];else{f=f instanceof Array?[...f]:[f];for(let o=0;o<f.length;++o){if(!$e){let u=document.createElement("a");u.href=f[o],f[o]=u.href}f[o].endsWith("/")||(f[o]+="/")}}return f};var Ee,dt,vt,He;(function(f){f[f.IPF_Binary=0]="IPF_Binary",f[f.IPF_BinaryInverted=1]="IPF_BinaryInverted",f[f.IPF_GrayScaled=2]="IPF_GrayScaled",f[f.IPF_NV21=3]="IPF_NV21",f[f.IPF_RGB_565=4]="IPF_RGB_565",f[f.IPF_RGB_555=5]="IPF_RGB_555",f[f.IPF_RGB_888=6]="IPF_RGB_888",f[f.IPF_ARGB_8888=7]="IPF_ARGB_8888",f[f.IPF_RGB_161616=8]="IPF_RGB_161616",f[f.IPF_ARGB_16161616=9]="IPF_ARGB_16161616",f[f.IPF_ABGR_8888=10]="IPF_ABGR_8888",f[f.IPF_ABGR_16161616=11]="IPF_ABGR_16161616",f[f.IPF_BGR_888=12]="IPF_BGR_888"})(Ee||(Ee={})),function(f){f[f.DBR_SYSTEM_EXCEPTION=1]="DBR_SYSTEM_EXCEPTION",f[f.DBR_SUCCESS=0]="DBR_SUCCESS",f[f.DBR_UNKNOWN=-1e4]="DBR_UNKNOWN",f[f.DBR_NO_MEMORY=-10001]="DBR_NO_MEMORY",f[f.DBR_NULL_REFERENCE=-10002]="DBR_NULL_REFERENCE",f[f.DBR_LICENSE_INVALID=-10003]="DBR_LICENSE_INVALID",f[f.DBR_LICENSE_EXPIRED=-10004]="DBR_LICENSE_EXPIRED",f[f.DBR_FILE_NOT_FOUND=-10005]="DBR_FILE_NOT_FOUND",f[f.DBR_FILETYPE_NOT_SUPPORTED=-10006]="DBR_FILETYPE_NOT_SUPPORTED",f[f.DBR_BPP_NOT_SUPPORTED=-10007]="DBR_BPP_NOT_SUPPORTED",f[f.DBR_INDEX_INVALID=-10008]="DBR_INDEX_INVALID",f[f.DBR_BARCODE_FORMAT_INVALID=-10009]="DBR_BARCODE_FORMAT_INVALID",f[f.DBR_CUSTOM_REGION_INVALID=-10010]="DBR_CUSTOM_REGION_INVALID",f[f.DBR_MAX_BARCODE_NUMBER_INVALID=-10011]="DBR_MAX_BARCODE_NUMBER_INVALID",f[f.DBR_IMAGE_READ_FAILED=-10012]="DBR_IMAGE_READ_FAILED",f[f.DBR_TIFF_READ_FAILED=-10013]="DBR_TIFF_READ_FAILED",f[f.DBR_QR_LICENSE_INVALID=-10016]="DBR_QR_LICENSE_INVALID",f[f.DBR_1D_LICENSE_INVALID=-10017]="DBR_1D_LICENSE_INVALID",f[f.DBR_DIB_BUFFER_INVALID=-10018]="DBR_DIB_BUFFER_INVALID",f[f.DBR_PDF417_LICENSE_INVALID=-10019]="DBR_PDF417_LICENSE_INVALID",f[f.DBR_DATAMATRIX_LICENSE_INVALID=-10020]="DBR_DATAMATRIX_LICENSE_INVALID",f[f.DBR_PDF_READ_FAILED=-10021]="DBR_PDF_READ_FAILED",f[f.DBR_PDF_DLL_MISSING=-10022]="DBR_PDF_DLL_MISSING",f[f.DBR_PAGE_NUMBER_INVALID=-10023]="DBR_PAGE_NUMBER_INVALID",f[f.DBR_CUSTOM_SIZE_INVALID=-10024]="DBR_CUSTOM_SIZE_INVALID",f[f.DBR_CUSTOM_MODULESIZE_INVALID=-10025]="DBR_CUSTOM_MODULESIZE_INVALID",f[f.DBR_RECOGNITION_TIMEOUT=-10026]="DBR_RECOGNITION_TIMEOUT",f[f.DBR_JSON_PARSE_FAILED=-10030]="DBR_JSON_PARSE_FAILED",f[f.DBR_JSON_TYPE_INVALID=-10031]="DBR_JSON_TYPE_INVALID",f[f.DBR_JSON_KEY_INVALID=-10032]="DBR_JSON_KEY_INVALID",f[f.DBR_JSON_VALUE_INVALID=-10033]="DBR_JSON_VALUE_INVALID",f[f.DBR_JSON_NAME_KEY_MISSING=-10034]="DBR_JSON_NAME_KEY_MISSING",f[f.DBR_JSON_NAME_VALUE_DUPLICATED=-10035]="DBR_JSON_NAME_VALUE_DUPLICATED",f[f.DBR_TEMPLATE_NAME_INVALID=-10036]="DBR_TEMPLATE_NAME_INVALID",f[f.DBR_JSON_NAME_REFERENCE_INVALID=-10037]="DBR_JSON_NAME_REFERENCE_INVALID",f[f.DBR_PARAMETER_VALUE_INVALID=-10038]="DBR_PARAMETER_VALUE_INVALID",f[f.DBR_DOMAIN_NOT_MATCHED=-10039]="DBR_DOMAIN_NOT_MATCHED",f[f.DBR_RESERVEDINFO_NOT_MATCHED=-10040]="DBR_RESERVEDINFO_NOT_MATCHED",f[f.DBR_AZTEC_LICENSE_INVALID=-10041]="DBR_AZTEC_LICENSE_INVALID",f[f.DBR_LICENSE_DLL_MISSING=-10042]="DBR_LICENSE_DLL_MISSING",f[f.DBR_LICENSEKEY_NOT_MATCHED=-10043]="DBR_LICENSEKEY_NOT_MATCHED",f[f.DBR_REQUESTED_FAILED=-10044]="DBR_REQUESTED_FAILED",f[f.DBR_LICENSE_INIT_FAILED=-10045]="DBR_LICENSE_INIT_FAILED",f[f.DBR_PATCHCODE_LICENSE_INVALID=-10046]="DBR_PATCHCODE_LICENSE_INVALID",f[f.DBR_POSTALCODE_LICENSE_INVALID=-10047]="DBR_POSTALCODE_LICENSE_INVALID",f[f.DBR_DPM_LICENSE_INVALID=-10048]="DBR_DPM_LICENSE_INVALID",f[f.DBR_FRAME_DECODING_THREAD_EXISTS=-10049]="DBR_FRAME_DECODING_THREAD_EXISTS",f[f.DBR_STOP_DECODING_THREAD_FAILED=-10050]="DBR_STOP_DECODING_THREAD_FAILED",f[f.DBR_SET_MODE_ARGUMENT_ERROR=-10051]="DBR_SET_MODE_ARGUMENT_ERROR",f[f.DBR_LICENSE_CONTENT_INVALID=-10052]="DBR_LICENSE_CONTENT_INVALID",f[f.DBR_LICENSE_KEY_INVALID=-10053]="DBR_LICENSE_KEY_INVALID",f[f.DBR_LICENSE_DEVICE_RUNS_OUT=-10054]="DBR_LICENSE_DEVICE_RUNS_OUT",f[f.DBR_GET_MODE_ARGUMENT_ERROR=-10055]="DBR_GET_MODE_ARGUMENT_ERROR",f[f.DBR_IRT_LICENSE_INVALID=-10056]="DBR_IRT_LICENSE_INVALID",f[f.DBR_MAXICODE_LICENSE_INVALID=-10057]="DBR_MAXICODE_LICENSE_INVALID",f[f.DBR_GS1_DATABAR_LICENSE_INVALID=-10058]="DBR_GS1_DATABAR_LICENSE_INVALID",f[f.DBR_GS1_COMPOSITE_LICENSE_INVALID=-10059]="DBR_GS1_COMPOSITE_LICENSE_INVALID",f[f.DBR_DOTCODE_LICENSE_INVALID=-10061]="DBR_DOTCODE_LICENSE_INVALID",f[f.DMERR_NO_LICENSE=-2e4]="DMERR_NO_LICENSE",f[f.DMERR_LICENSE_SYNC_FAILED=-20003]="DMERR_LICENSE_SYNC_FAILED",f[f.DMERR_TRIAL_LICENSE=-20010]="DMERR_TRIAL_LICENSE",f[f.DMERR_FAILED_TO_REACH_LTS=-20200]="DMERR_FAILED_TO_REACH_LTS"}(dt||(dt={})),function(f){f[f.IMRDT_IMAGE=1]="IMRDT_IMAGE",f[f.IMRDT_CONTOUR=2]="IMRDT_CONTOUR",f[f.IMRDT_LINESEGMENT=4]="IMRDT_LINESEGMENT",f[f.IMRDT_LOCALIZATIONRESULT=8]="IMRDT_LOCALIZATIONRESULT",f[f.IMRDT_REGIONOFINTEREST=16]="IMRDT_REGIONOFINTEREST",f[f.IMRDT_QUADRILATERAL=32]="IMRDT_QUADRILATERAL"}(vt||(vt={})),function(f){f[f.BF_ALL=4265607167]="BF_ALL",f[f.BF_ONED=3147775]="BF_ONED",f[f.BF_GS1_DATABAR=260096]="BF_GS1_DATABAR",f[f.BF_CODE_39=1]="BF_CODE_39",f[f.BF_CODE_128=2]="BF_CODE_128",f[f.BF_CODE_93=4]="BF_CODE_93",f[f.BF_CODABAR=8]="BF_CODABAR",f[f.BF_ITF=16]="BF_ITF",f[f.BF_EAN_13=32]="BF_EAN_13",f[f.BF_EAN_8=64]="BF_EAN_8",f[f.BF_UPC_A=128]="BF_UPC_A",f[f.BF_UPC_E=256]="BF_UPC_E",f[f.BF_INDUSTRIAL_25=512]="BF_INDUSTRIAL_25",f[f.BF_CODE_39_EXTENDED=1024]="BF_CODE_39_EXTENDED",f[f.BF_GS1_DATABAR_OMNIDIRECTIONAL=2048]="BF_GS1_DATABAR_OMNIDIRECTIONAL",f[f.BF_GS1_DATABAR_TRUNCATED=4096]="BF_GS1_DATABAR_TRUNCATED",f[f.BF_GS1_DATABAR_STACKED=8192]="BF_GS1_DATABAR_STACKED",f[f.BF_GS1_DATABAR_STACKED_OMNIDIRECTIONAL=16384]="BF_GS1_DATABAR_STACKED_OMNIDIRECTIONAL",f[f.BF_GS1_DATABAR_EXPANDED=32768]="BF_GS1_DATABAR_EXPANDED",f[f.BF_GS1_DATABAR_EXPANDED_STACKED=65536]="BF_GS1_DATABAR_EXPANDED_STACKED",f[f.BF_GS1_DATABAR_LIMITED=131072]="BF_GS1_DATABAR_LIMITED",f[f.BF_PATCHCODE=262144]="BF_PATCHCODE",f[f.BF_PDF417=33554432]="BF_PDF417",f[f.BF_QR_CODE=67108864]="BF_QR_CODE",f[f.BF_DATAMATRIX=134217728]="BF_DATAMATRIX",f[f.BF_AZTEC=268435456]="BF_AZTEC",f[f.BF_MAXICODE=536870912]="BF_MAXICODE",f[f.BF_MICRO_QR=1073741824]="BF_MICRO_QR",f[f.BF_MICRO_PDF417=524288]="BF_MICRO_PDF417",f[f.BF_GS1_COMPOSITE=2147483648]="BF_GS1_COMPOSITE",f[f.BF_MSI_CODE=1048576]="BF_MSI_CODE",f[f.BF_CODE_11=2097152]="BF_CODE_11",f[f.BF_NULL=0]="BF_NULL"}(He||(He={}));const Ct=f=>f&&typeof f=="object"&&typeof f.then=="function",wt=Re.OS=="iPhone"||Re.OS=="Android"||Re.OS=="HarmonyOS"?2048:4096;class Y{constructor(){this._instanceID=void 0,this._ifSaveOriginalImageInACanvas=!1,this.oriCanvas=null,this.oriCanvasData=null,this.canvas=null,this.bFilterRegionInJs=!1,this._region=null,this._timeStartDecode=null,this._timeEnterInnerDBR=null,this._timeGetMessage=null,this.decodeRecords={},this.bDestroyed=!1,this._lastErrorCode=0,this._lastErrorString="",this._lastInnerDecodeDuration=0,this.intervalTime=0,this._intervalGetVideoFrame=0,this.array_getFrameTimeCost=[],this.array_decodeFrameTimeCost=[],this._indexCurrentDecodingFrame=0,this._arrPolygons=[],this._bPauseScan=!1,this._intervalDetectVideoPause=1e3,this._soundSource="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAABQAAAkAAgICAgICAgICAgICAgICAgICAgKCgoKCgoKCgoKCgoKCgoKCgoKCgwMDAwMDAwMDAwMDAwMDAwMDAwMDg4ODg4ODg4ODg4ODg4ODg4ODg4P//////////////////////////AAAAAExhdmM1OC41NAAAAAAAAAAAAAAAACQEUQAAAAAAAAJAk0uXRQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/+MYxAANQAbGeUEQAAHZYZ3fASqD4P5TKBgocg+Bw/8+CAYBA4XB9/4EBAEP4nB9+UOf/6gfUCAIKyjgQ/Kf//wfswAAAwQA/+MYxAYOqrbdkZGQAMA7DJLCsQxNOij///////////+tv///3RWiZGBEhsf/FO/+LoCSFs1dFVS/g8f/4Mhv0nhqAieHleLy/+MYxAYOOrbMAY2gABf/////////////////usPJ66R0wI4boY9/8jQYg//g2SPx1M0N3Z0kVJLIs///Uw4aMyvHJJYmPBYG/+MYxAgPMALBucAQAoGgaBoFQVBUFQWDv6gZBUFQVBUGgaBr5YSgqCoKhIGg7+IQVBUFQVBoGga//SsFSoKnf/iVTEFNRTMu/+MYxAYAAANIAAAAADEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV",this.beepSound=new lt({src:["data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAABQAAAkAAgICAgICAgICAgICAgICAgICAgKCgoKCgoKCgoKCgoKCgoKCgoKCgwMDAwMDAwMDAwMDAwMDAwMDAwMDg4ODg4ODg4ODg4ODg4ODg4ODg4P//////////////////////////AAAAAExhdmM1OC41NAAAAAAAAAAAAAAAACQEUQAAAAAAAAJAk0uXRQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/+MYxAANQAbGeUEQAAHZYZ3fASqD4P5TKBgocg+Bw/8+CAYBA4XB9/4EBAEP4nB9+UOf/6gfUCAIKyjgQ/Kf//wfswAAAwQA/+MYxAYOqrbdkZGQAMA7DJLCsQxNOij///////////+tv///3RWiZGBEhsf/FO/+LoCSFs1dFVS/g8f/4Mhv0nhqAieHleLy/+MYxAYOOrbMAY2gABf/////////////////usPJ66R0wI4boY9/8jQYg//g2SPx1M0N3Z0kVJLIs///Uw4aMyvHJJYmPBYG/+MYxAgPMALBucAQAoGgaBoFQVBUFQWDv6gZBUFQVBUGgaBr5YSgqCoKhIGg7+IQVBUFQVBoGga//SsFSoKnf/iVTEFNRTMu/+MYxAYAAANIAAAAADEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV"],onplayerror:(o,u)=>{console.warn("Sound '".concat(o,"' playback failure: ").concat(u))}}),this.bPlaySoundOnSuccessfulRead=!1,this.bVibrateOnSuccessfulRead=!1,this.vibrateDuration=300,this.captureAndDecodeInParallel=!0,this._dce=null,this._imgSource=null,this._maxCvsSideLength=wt,this._tempSolutionStatus="closed"}static get version(){return this._version}static get license(){return this._license}static set license(o){((u,_)=>{const v=u;if(!v._pLoad.isEmpty)throw new Error("`license`"+nt);v._license=_})(Y,o)}static get productKeys(){return this._license}static set productKeys(o){Y.license=o}static get handshakeCode(){return this._license}static set handshakeCode(o){Y.license=o}static get organizationID(){return this._license}static set organizationID(o){Y.license=o}static set sessionPassword(o){((u,_)=>{const v=u;if(!v._pLoad.isEmpty)throw new Error("`sessionPassword`"+nt);v._sessionPassword=_})(Y,o)}static get sessionPassword(){return this._sessionPassword}static async detectEnvironment(){return await(async()=>({wasm:fi,worker:gi,getUserMedia:ri,camera:await pi(),browser:Re.browser,version:Re.version,OS:Re.OS}))()}static get engineResourcePath(){return this._engineResourcePath}static set engineResourcePath(o){if(!this._pLoad.isEmpty)throw new Error("`engineResourcePath` is not allowed to change after `createInstance` or `loadWasm` is called.");Y._engineResourcePath=(u=>{if(u==null&&(u="./"),!$e){let _=document.createElement("a");_.href=u,u=_.href}return u.endsWith("/")||(u+="/"),u})(o)}static get licenseServer(){return this._licenseServer}static set licenseServer(o){((u,_)=>{const v=u;if(!v._pLoad.isEmpty)throw new Error("`licenseServer`"+nt);v._licenseServer=bt(_)})(Y,o)}static get deviceFriendlyName(){return this._deviceFriendlyName}static set deviceFriendlyName(o){((u,_)=>{const v=u;if(!v._pLoad.isEmpty)throw new Error("`deviceFriendlyName`"+nt);v._deviceFriendlyName=_||""})(Y,o)}static get _bUseFullFeature(){return this.__bUseFullFeature}static set _bUseFullFeature(o){if(!this._pLoad.isEmpty)throw new Error("`_bUseFullFeature` is not allowed to change after `createInstance` or `loadWasm` is called.");Y.__bUseFullFeature=o}static isImageSource(o){return!(!o||typeof o!="object"||Array.isArray(o))&&"getImage"in o}static isDSImage(o){return!(!o||typeof o!="object"||Array.isArray(o))&&"data"in o&&"width"in o&&"height"in o&&"pixelFormat"in o}static isDCEFrame(o){return!(!o||typeof o!="object"||Array.isArray(o))&&"data"in o&&"region"in o&&"sx"in o&&"sy"in o&&"width"in o&&"height"in o&&"colorMode"in o&&"timeSpent"in o&&"timeStamp"in o&&"isCropped"in o&&"toCanvas"in o&&"_sWidth"in o&&"_sHeight"in o&&"_bUseWebGL"in o}get ifSaveOriginalImageInACanvas(){return this._ifSaveOriginalImageInACanvas}set ifSaveOriginalImageInACanvas(o){this._ifSaveOriginalImageInACanvas=o}getOriginalImageInACanvas(){return!this.oriCanvas&&this.oriCanvasData?this.oriCanvasData.toCanvas():this.oriCanvas}set region(o){this._region=o,this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0}get region(){return this._region}static isWasmLoaded(){return this._pLoad.isFulfilled}isContextDestroyed(){return this.bDestroyed}static get lastErrorCode(){return this._lastErrorCode}static get lastErrorString(){return this._lastErrorString}get lastErrorCode(){return this._lastErrorCode}get lastErrorString(){return this._lastErrorString}static get defaultUIElementURL(){var o;return(o=Y._defaultUIElementURL)===null||o===void 0?void 0:o.replace("@engineResourcePath/",Y.engineResourcePath)}static set defaultUIElementURL(o){Y._defaultUIElementURL=o}static _fireHTTPSWarnning(){Y.onWarning&&location&&location.protocol!=="https:"&&setTimeout(()=>{Y.onWarning&&Y.onWarning({id:2,message:"Not connected via SSL (HTTPS), the SDK may not work correctly."})},0)}get soundSource(){return this._soundSource}set soundSource(o){this._soundSource=o,this.beepSound=new lt({src:[this._soundSource],onplayerror:(u,_)=>{console.warn("Sound '".concat(u,"' playback failure: ").concat(_))}})}get whenToPlaySoundforSuccessfulRead(){return this.bPlaySoundOnSuccessfulRead===!0?"frame":this.bPlaySoundOnSuccessfulRead?this.bPlaySoundOnSuccessfulRead:"never"}set whenToPlaySoundforSuccessfulRead(o){this.bPlaySoundOnSuccessfulRead=o!=="never"&&o}get whenToVibrateforSuccessfulRead(){return this.bVibrateOnSuccessfulRead===!0?"frame":this.bVibrateOnSuccessfulRead?this.bVibrateOnSuccessfulRead:"never"}set whenToVibrateforSuccessfulRead(o){this.bVibrateOnSuccessfulRead=o!=="never"&&o}set dce(o){this._dce=o}get dce(){return!this._dce||this._dce.isDisposed?null:this._dce}set maxCvsSideLength(o){this._maxCvsSideLength=o,this._dceControler&&this._dceControler.setDisiredValue(this,"maxCvsSideLength",o)}get maxCvsSideLength(){return this._maxCvsSideLength}async _registerDCEControler(){if(!this.dce)return;Y._onLog&&Y._onLog("_registerDCEControler()");const o=this.dce;this._dceControler=o._createControler();const u=this._dceControler;u.register(this),u.setDisiredValue(this,"refreshInterval",200),u.setDisiredValue(this,"maxCvsSideLength",this._maxCvsSideLength);try{}catch(C){C.name==="ReferenceError"&&window&&(window.ResizeObserver=void 0)}const _=o.getUIElement(),v=this.dce.constructor;if(v._defaultUIElementURL==="@engineResourcePath/dce.ui.html")try{_?_===u._innerSetUI&&(await o.setUIElement("".concat(v.engineResourcePath,"dce.ui.html")),u._innerSetUI=o.getUIElement()):(await o.setUIElement("".concat(v.engineResourcePath,"dbr.ui.html")),u._innerSetUI=o.getUIElement())}catch(C){await o.setUIElement(v.defaultUIElementURL)}else _||await o.setUIElement(v.defaultUIElementURL);this.callbackCameraChange=()=>{this._drawResults(null),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0},this.callbackResolutionChange=()=>{this._drawResults(null),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0},this.callbackCameraClose=()=>{this.stopScanning(!0),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0,this._bPauseScan=!1},this.callbackSingleFrameAcquired=async C=>{let S=await this._decode_DCEFrame(C,{bCopyData:!1}),x=null;if(S&&S.length){const{sx:L,sy:I,width:E,height:F,_sWidth:M,_sHeight:q}=C;x=S.map(se=>({localizationResult:JSON.parse(JSON.stringify(se.localizationResult))})),Y.recalculateResultLocation(x,L,I,M,q,E,F)}if(this._drawResults(x),await this.clearMapDecodeRecord(),this.onImageRead&&this.dce.isOpen()&&!this._bPauseScan){let L=this._cloneDecodeResults(S);this.onImageRead(L)}if(this.onUniqueRead&&this.dce.isOpen()&&!this._bPauseScan)for(let L of S)this.onUniqueRead(L.barcodeText,this._cloneDecodeResults(L))},o.on("cameraChange",this.callbackCameraChange),o.on("resolutionChange",this.callbackResolutionChange),o.on("cameraClose",this.callbackCameraClose),o.on("singleFrameAcquired",this.callbackSingleFrameAcquired)}_logoutDCEControler(){this.dce&&this._dceControler&&(Y._onLog&&Y._onLog("_logoutDCEControler()"),this._dceControler.logout(this),this.dce.off("cameraChange",this.callbackCameraChange),this.dce.off("resolutionChange",this.callbackResolutionChange),this.dce.off("cameraClose",this.callbackCameraClose),this.dce.off("singleFrameAcquired",this.callbackSingleFrameAcquired),this._dceControler=null,this.dce=null)}async setImageSource(o,u){if(o==null)return this._imgSource=null,this._logoutDCEControler(),void(this._drawingItemNamespace=null);if(o&&o.isCameraEnhancer)this.dce=o,await this._registerDCEControler(),this._imgSource=null;else{if(!Y.isImageSource(o))throw new Error("Invalid value.");this._logoutDCEControler(),this._imgSource=o}u&&u.resultsHighlightBaseShapes&&(this._drawingItemNamespace=u.resultsHighlightBaseShapes)}static async loadWasm(){if(this._pLoad.isEmpty){let{lt:o,l:u,ls:_,sp:v,rmk:C}=(S=>{const x=S;if(x._pLoad.isEmpty){let L,I,E=x._license||"",F=JSON.parse(JSON.stringify(x._licenseServer)),M=x._sessionPassword,q=0;if(E.startsWith("t")||E.startsWith("f"))q=0;else if(E.length===0||E.startsWith("P")||E.startsWith("L")||E.startsWith("Y")||E.startsWith("A"))q=1;else{q=2;const se=E.indexOf(":");if(se!=-1&&(E=E.substring(se+1)),E.startsWith("DLS2")){let K=E.substring(4);try{K=atob(K)}catch(le){throw new Error("Format Error: The license string you specified is invalid, please check to make sure it is correct.")}const J=JSON.parse(K);if(E=J.handshakeCode?J.handshakeCode:J.organizationID?J.organizationID:"",typeof E=="number"&&(E=JSON.stringify(E)),F.length===0){let le=[];J.mainServerURL&&(le[0]=J.mainServerURL),J.standbyServerURL&&(le[1]=J.standbyServerURL),F=bt(le)}!M&&J.sessionPassword&&(M=J.sessionPassword),L=J.remark}(E==="200001"||E.startsWith("200001-"))&&(F&&F.length||(E="")),E||(q=1)}if(q&&(globalThis.crypto||(I="Please upgrade your browser to support online key."),globalThis.crypto.subtle||(I="Require https to use online key in this browser.")),I){if(q!==1)throw new Error(I);q=0,console.warn(I),x._lastErrorCode=-1,x._lastErrorString=I}return q===1&&(E="",console.warn("Applying for a public trial license ...")),{lt:q,l:E,ls:F,sp:M,rmk:L}}throw new Error("Can't preprocess license again"+nt)})(Y);this._pLoad.task=async(S,x)=>{let L=Y.engineResourcePath+Y._workerName;Y.engineResourcePath.startsWith(location.origin)||(L=await fetch(L).then(I=>I.blob()).then(I=>URL.createObjectURL(I))),Y._dbrWorker=new Worker(L),Y._dbrWorker.onerror=I=>{let E=new Error(I.message);x(E)},Y._dbrWorker.onmessage=async I=>{let E=I.data?I.data:I;switch(E.type){case"log":Y._onLog&&Y._onLog(E.message);break;case"load":{E.message&&(E.message=E.message.replace("(https://www.dynamsoft.com/purchase-center/)","(https://www.dynamsoft.com/store/dynamsoft-barcode-reader/#javascript)"));let F,M=!1;o===1&&(M=!0),E.success?(Y._dbrWorker.onerror=null,Y._version=E.version+"(JS "+Y._jsVersion+"."+Y._jsEditVersion+")",Y._onLog&&Y._onLog("load dbr worker success"),E.message&&console.warn(E.message)):(F=new Error(E.message),F.stack=E.stack+"\n"+F.stack,M||E.ltsErrorCode==111&&E.message.toLowerCase().indexOf("trial license")!=-1&&(M=!0)),M&&Y.showDialog(E.success?"warn":"error",E.message),E.success?S():x(F);break}case"task":{let F=E.id,M=E.body;try{Y._taskCallbackMap.get(F)(M),Y._taskCallbackMap.delete(F)}catch(q){throw Y._taskCallbackMap.delete(F),q}break}default:Y._onLog&&Y._onLog(I)}},Y._dbrWorker.postMessage({type:"loadWasm",engineResourcePath:Y.engineResourcePath,bUseFullFeature:Y._bUseFullFeature,bd:Y._bWasmDebug,v:Y._jsVersion,brtk:!!o,bptk:o===1,l:u,dm:location.origin.startsWith("http")?location.origin:"https://localhost",os:Re,fn:Y.deviceFriendlyName,ls:_,sp:v,rmk:C})}}await this._pLoad}static async showDialog(o,u){await(async(_,v,C)=>{if(!_._bNeverShowDialog)try{let S=await fetch(_.engineResourcePath+"dls.license.dialog.html");if(!S.ok)throw Error("Get license dialog fail. Network Error: "+S.statusText);let x=await S.text();if(!x.trim().startsWith("<"))throw Error("Get license dialog fail. Can't get valid HTMLElement.");let L=document.createElement("div");L.innerHTML=x;let I=[];for(let ue=0;ue<L.childElementCount;++ue){let $=L.children[ue];$ instanceof HTMLStyleElement&&(I.push($),document.head.append($))}let E=L.childElementCount==1?L.children[0]:L;E.remove();let F,M,q,se,K,J=[E],le=E.children;for(let ue of le)J.push(ue);for(let ue=0;ue<J.length;++ue)for(let $ of J[ue].children)J.push($);for(let ue of J)if(!F&&ue.classList.contains("dls-license-mask"))F=ue,ue.addEventListener("click",$=>{if(ue==$.target){E.remove();for(let pe of I)pe.remove()}});else if(!M&&ue.classList.contains("dls-license-icon-close"))M=ue,ue.addEventListener("click",()=>{E.remove();for(let $ of I)$.remove()});else if(!q&&ue.classList.contains("dls-license-icon-error"))q=ue,v!="error"&&ue.remove();else if(!se&&ue.classList.contains("dls-license-icon-warn"))se=ue,v!="warn"&&ue.remove();else if(!K&&ue.classList.contains("dls-license-msg-content")){K=ue;let $=C;for(;$;){let pe=$.indexOf("["),_e=$.indexOf("]",pe),Se=$.indexOf("(",_e),be=$.indexOf(")",Se);if(pe==-1||_e==-1||Se==-1||be==-1){ue.appendChild(new Text($));break}pe>0&&ue.appendChild(new Text($.substring(0,pe)));let g=document.createElement("a"),ye=$.substring(pe+1,_e);g.innerText=ye;let oe=$.substring(Se+1,be);g.setAttribute("href",oe),g.setAttribute("target","_blank"),ue.appendChild(g),$=$.substring(be+1)}}document.body.appendChild(E)}catch(S){_._onLog&&_._onLog(S.message||S)}})(this,o,u)}static async createInstanceInWorker(o=!1){return await Y.loadWasm(),await new Promise((u,_)=>{let v=Y._nextTaskID++;Y._taskCallbackMap.set(v,C=>{if(C.success)return u(C.instanceID);{let S=new Error(C.message);return S.stack=C.stack+"\n"+S.stack,_(S)}}),Y._dbrWorker.postMessage({type:"createInstance",id:v,bScanner:o})})}static async createInstance(){let o=new Y;return o._instanceID=await Y.createInstanceInWorker(),Y._fireHTTPSWarnning(),o}async clearMapDecodeRecord(){return await new Promise((o,u)=>{let _=Y._nextTaskID++;Y._taskCallbackMap.set(_,v=>{if(v.success)return o();{let C=new Error(v.message);return C.stack=v.stack+"\n"+C.stack,u(C)}}),Y._dbrWorker.postMessage({type:"clearMapDecodeRecord",id:_,instanceID:this._instanceID})})}async decode(o){Y._onLog&&Y._onLog("decode(source: any)"),Y._onLog&&(this._timeStartDecode=Date.now());{let u={};return!this.region||this.region instanceof Array||(u.region=JSON.parse(JSON.stringify(this.region))),o instanceof Blob?await this._decode_Blob(o,u):o instanceof ArrayBuffer?await this._decode_ArrayBuffer(o,u):o instanceof Uint8Array||o instanceof Uint8ClampedArray?await this._decode_Uint8Array(o,u):o instanceof HTMLImageElement||typeof ImageBitmap<"u"&&o instanceof ImageBitmap?await this._decode_Image(o,u):o instanceof HTMLCanvasElement?await this._decode_Canvas(o,u):o instanceof HTMLVideoElement?await this._decode_Video(o,u):typeof o=="string"?o.substring(0,11)=="data:image/"?await this._decode_Base64(o,u):await this._decode_Url(o,u):Y.isDCEFrame(o)?(u.bCopyData=!0,await this._decode_DCEFrame(o,u)):Y.isDSImage(o)?(u.bCopyData=!0,await this._decode_DSImage(o,u)):await Promise.reject(TypeError("'_decode(source, config)': Type of 'source' should be 'Blob', 'ArrayBuffer', 'Uint8Array', 'HTMLImageElement', 'HTMLCanvasElement', 'HTMLVideoElement', 'String(base64 with image mime)' or 'String(url)'."))}}async decodeBase64String(o){let u={};return!this.region||this.region instanceof Array||(u.region=JSON.parse(JSON.stringify(this.region))),this._decode_Base64(o,u)}async decodeUrl(o){let u={};return!this.region||this.region instanceof Array||(u.region=JSON.parse(JSON.stringify(this.region))),this._decode_Url(o,u)}async _decodeBuffer_Uint8Array(o,u,_,v,C,S){return await new Promise((x,L)=>{let I=Y._nextTaskID++;Y._taskCallbackMap.set(I,E=>{if(E.success){let F,M=Y._onLog?Date.now():0;Y._onLog&&Y._onLog("worker return result: "+M),this._lastInnerDecodeDuration=E.duration;try{F=this._handleRetJsonString(E.decodeReturn)}catch(q){return L(q)}if(Y._onLog){let q=Date.now();Y._onLog("DBR getting message from worker timestamp: "+M),Y._onLog("From DBR staring decoding to entering worker costs: "+(this._timeEnterInnerDBR-this._timeStartDecode)),Y._onLog("From DBR entering worker to returning message from worker costs: "+(M-this._timeEnterInnerDBR)),Y._onLog("Handling results from DBR worker costs: "+(q-M)),Y._onLog("Total decoding image costs: "+(q-this._timeStartDecode))}return x(F)}{let F=new Error(E.message);return F.stack=E.stack+"\n"+F.stack,L(F)}}),this._timeEnterInnerDBR=Date.now(),Y._onLog&&Y._onLog("Sending buffer to worker timestamp:"+this._timeEnterInnerDBR),Y._dbrWorker.postMessage({type:"decodeBuffer",id:I,instanceID:this._instanceID,body:{buffer:o,width:u,height:_,stride:v,format:C,config:S}},[o.buffer]),Y._onLog&&S&&S.timeStamp&&Y._onLog("Delay of decoding image: "+(this._timeEnterInnerDBR-S.timeStamp))})}async _decodeBuffer_Blob(o,u,_,v,C,S){Y._onLog&&Y._onLog("_decodeBuffer_Blob(buffer,width,height,stride,format)");const x=o.arrayBuffer?await o.arrayBuffer():await new Promise((L,I)=>{let E=new FileReader;E.readAsArrayBuffer(o),E.onload=()=>{L(E.result)},E.onerror=()=>{I(E.error)}});return await this._decodeBuffer_Uint8Array(new Uint8Array(x),u,_,v,C,S)}async decodeBuffer(o,u,_,v,C,S){let x;return Y._onLog&&Y._onLog("decodeBuffer(buffer,width,height,stride,format)"),Y._onLog&&(this._timeStartDecode=Date.now()),o instanceof Uint8Array||o instanceof Uint8ClampedArray?x=await this._decodeBuffer_Uint8Array(o,u,_,v,C,S):o instanceof ArrayBuffer?x=await this._decodeBuffer_Uint8Array(new Uint8Array(o),u,_,v,C,S):o instanceof Blob&&(x=await this._decodeBuffer_Blob(o,u,_,v,C,S)),x}async _decodeFileInMemory_Uint8Array(o){return await new Promise((u,_)=>{let v=Y._nextTaskID++;Y._taskCallbackMap.set(v,C=>{if(C.success){let S;this._lastInnerDecodeDuration=C.duration;try{S=this._handleRetJsonString(C.decodeReturn)}catch(x){return _(x)}return u(S)}{let S=new Error(C.message);return S.stack=C.stack+"\n"+S.stack,_(S)}}),Y._dbrWorker.postMessage({type:"decodeFileInMemory",id:v,instanceID:this._instanceID,body:{bytes:o}})})}async getRuntimeSettings(){return await new Promise((o,u)=>{let _=Y._nextTaskID++;Y._taskCallbackMap.set(_,v=>{if(v.success){let C=JSON.parse(v.results);return this.userDefinedRegion!=null&&(C.region=JSON.parse(JSON.stringify(this.userDefinedRegion))),o(C)}{let C=new Error(v.message);return C.stack=v.stack+"\n"+C.stack,u(C)}}),Y._dbrWorker.postMessage({type:"getRuntimeSettings",id:_,instanceID:this._instanceID})})}async updateRuntimeSettings(o){let u;if(typeof o=="string")if(o=="speed"){let _=await this.getRuntimeSettings();await this.resetRuntimeSettings(),u=await this.getRuntimeSettings(),u.barcodeFormatIds=_.barcodeFormatIds,u.barcodeFormatIds_2=_.barcodeFormatIds_2,u.region=_.region,u.deblurLevel=3,u.expectedBarcodesCount=0,u.localizationModes=[2,0,0,0,0,0,0,0]}else if(o=="balance"){let _=await this.getRuntimeSettings();await this.resetRuntimeSettings(),u=await this.getRuntimeSettings(),u.barcodeFormatIds=_.barcodeFormatIds,u.barcodeFormatIds_2=_.barcodeFormatIds_2,u.region=_.region,u.deblurLevel=5,u.expectedBarcodesCount=512,u.localizationModes=[2,16,0,0,0,0,0,0]}else if(o=="coverage"){let _=await this.getRuntimeSettings();await this.resetRuntimeSettings(),u=await this.getRuntimeSettings(),u.barcodeFormatIds=_.barcodeFormatIds,u.barcodeFormatIds_2=_.barcodeFormatIds_2,u.region=_.region}else if(o=="dense"){let _=await this.getRuntimeSettings();await this.resetRuntimeSettings(),this.maxCvsSideLength=4096,u=await this.getRuntimeSettings(),u.barcodeFormatIds=_.barcodeFormatIds,u.barcodeFormatIds_2=_.barcodeFormatIds_2,u.region=_.region,u.deblurLevel=9,u.expectedBarcodesCount=0,u.localizationModes=[2,8,0,0,0,0,0,0]}else if(o=="distance"){let _=await this.getRuntimeSettings();await this.resetRuntimeSettings(),this.maxCvsSideLength=4096,u=await this.getRuntimeSettings(),u.barcodeFormatIds=_.barcodeFormatIds,u.barcodeFormatIds_2=_.barcodeFormatIds_2,u.region=_.region,u.deblurLevel=3,u.expectedBarcodesCount=0,u.localizationModes=[2,8,0,0,0,0,0,0]}else u=JSON.parse(o);else{if(typeof o!="object")throw TypeError("'UpdateRuntimeSettings(settings)': Type of 'settings' should be 'string' or 'PlainObject'.");if(u=JSON.parse(JSON.stringify(o)),u.region instanceof Array){let _=u.region;[_.regionLeft,_.regionTop,_.regionLeft,_.regionBottom,_.regionMeasuredByPercentage].some(v=>v!==void 0)&&(u.region={regionLeft:_.regionLeft||0,regionTop:_.regionTop||0,regionRight:_.regionRight||0,regionBottom:_.regionBottom||0,regionMeasuredByPercentage:_.regionMeasuredByPercentage||0})}}if(!Y._bUseFullFeature){if(u.barcodeFormatIds&~(He.BF_ONED|He.BF_QR_CODE|He.BF_PDF417|He.BF_DATAMATRIX)||u.barcodeFormatIds_2!=0)throw Error("Some of the specified barcode formats are not supported in the compact version. Please try the full-featured version.");if(u.intermediateResultTypes!=0)throw Error("Intermediate results is not supported in the compact version. Please try the full-featured version.")}if(this.bFilterRegionInJs){let _=u.region;if(_ instanceof Array)throw Error("The `region` of type `Array` is only allowed in `BarcodeScanner`.");this.userDefinedRegion=JSON.parse(JSON.stringify(_)),(_.regionLeft||_.regionTop||_.regionRight||_.regionBottom||_.regionMeasuredByPercentage)&&(_.regionLeft||_.regionTop||_.regionRight!=100||_.regionBottom!=100||!_.regionMeasuredByPercentage)?this.region=_:this.region=null,u.region={regionLeft:0,regionTop:0,regionRight:0,regionBottom:0,regionMeasuredByPercentage:0}}else this.userDefinedRegion=null,this.region=null;return await new Promise((_,v)=>{let C=Y._nextTaskID++;Y._taskCallbackMap.set(C,S=>{if(S.success){try{this._handleRetJsonString(S.updateReturn)}catch(x){v(x)}return _()}{let x=new Error(S.message);return x.stack=S.stack+"\n"+x.stack,v(x)}}),Y._dbrWorker.postMessage({type:"updateRuntimeSettings",id:C,instanceID:this._instanceID,body:{settings:JSON.stringify(u)}})})}async resetRuntimeSettings(){return this.userDefinedRegion=null,this.region=null,this.maxCvsSideLength=wt,await new Promise((o,u)=>{let _=Y._nextTaskID++;Y._taskCallbackMap.set(_,v=>{if(v.success)return o();{let C=new Error(v.message);return C.stack=v.stack+"\n"+C.stack,u(C)}}),Y._dbrWorker.postMessage({type:"resetRuntimeSettings",id:_,instanceID:this._instanceID})})}async outputRuntimeSettingsToString(){if(!Y._bUseFullFeature)throw Error("outputRuntimeSettingsToString() is not supported in the compact version. Please try the full-featured version.");return await new Promise((o,u)=>{let _=Y._nextTaskID++;Y._taskCallbackMap.set(_,v=>{if(v.success)return o(v.results);{let C=new Error(v.message);return C.stack=v.stack+"\n"+C.stack,u(C)}}),Y._dbrWorker.postMessage({type:"outputRuntimeSettingsToString",id:_,instanceID:this._instanceID})})}async initRuntimeSettingsWithString(o){if(!Y._bUseFullFeature)throw Error("initRuntimeSettingsWithString() is not supported in the compact version. Please try the full-featured version.");if(typeof o=="string")o=o;else{if(typeof o!="object")throw TypeError("'initRuntimeSettingstWithString(settings)': Type of 'settings' should be 'string' or 'PlainObject'.");o=JSON.stringify(o)}return await new Promise((u,_)=>{let v=Y._nextTaskID++;Y._taskCallbackMap.set(v,C=>{if(C.success){try{this._handleRetJsonString(C.initReturn)}catch(S){_(S)}return u()}{let S=new Error(C.message);return S.stack=C.stack+"\n"+S.stack,_(S)}}),Y._dbrWorker.postMessage({type:"initRuntimeSettingsWithString",id:v,instanceID:this._instanceID,body:{settings:o}})})}async _decode_Blob(o,u){Y._onLog&&Y._onLog("_decode_Blob(blob: Blob)");let _=null,v=null;if(typeof createImageBitmap<"u")try{_=await createImageBitmap(o)}catch(S){}_||(v=await function(S){return new Promise((x,L)=>{let I=URL.createObjectURL(S),E=new Image;E.dbrObjUrl=I,E.src=I,E.onload=()=>{x(E)},E.onerror=F=>{L(new Error("Can't convert blob to image : "+(F instanceof Event?F.type:F)))}})}(o));let C=await this._decode_Image(_||v,u);return _&&_.close(),C}async _decode_ArrayBuffer(o,u){return await this._decode_Blob(new Blob([o]),u)}async _decode_Uint8Array(o,u){return await this._decode_Blob(new Blob([o]),u)}async _decode_Image(o,u){Y._onLog&&Y._onLog("_decode_Image(image: HTMLImageElement|ImageBitmap)"),u=u||{};let _,v,C=o instanceof HTMLImageElement?o.naturalWidth:o.width,S=o instanceof HTMLImageElement?o.naturalHeight:o.height,x=Math.max(C,S);if(x>this._maxCvsSideLength){let I=this._maxCvsSideLength/x;_=Math.round(C*I),v=Math.round(S*I)}else _=C,v=S;this.canvas||(this.canvas=document.createElement("canvas"));const L=this.canvas;return L.width===_&&L.height===v||(L.width=_,L.height=v),L.ctx2d||(L.ctx2d=L.getContext("2d")),L.ctx2d.drawImage(o,0,0,C,S,0,0,_,v),o.dbrObjUrl&&URL.revokeObjectURL(o.dbrObjUrl),await this._decode_Canvas(L,u)}async _decode_Canvas(o,u){if(Y._onLog&&Y._onLog("_decode_Canvas(canvas:HTMLCanvasElement)"),o.crossOrigin&&o.crossOrigin!="anonymous")throw"cors";if(o.width===0||o.height===0)throw Error("The width or height of the 'canvas' is 0.");this.ifSaveOriginalImageInACanvas&&(this.oriCanvas=o,this.oriCanvasData=null);let _=(o.ctx2d||o.getContext("2d")).getImageData(0,0,o.width,o.height).data;return await this._decodeBuffer_Uint8Array(_,o.width,o.height,4*o.width,Ee.IPF_ABGR_8888,u)}async _decode_Video(o,u){if(Y._onLog&&Y._onLog("_decode_Video(video)"),!(o instanceof HTMLVideoElement))throw TypeError("'_decode_Video(video [, config] )': Type of 'video' should be 'HTMLVideoElement'.");if(o.crossOrigin&&o.crossOrigin!="anonymous")throw"cors";u=u||{};let _,v,C=o.videoWidth,S=o.videoHeight,x=Math.max(C,S);if(x>this._maxCvsSideLength){let I=this._maxCvsSideLength/x;_=Math.round(C*I),v=Math.round(S*I)}else _=C,v=S;this.canvas||(this.canvas=document.createElement("canvas"));const L=this.canvas;return L.width===_&&L.height===v||(L.width=_,L.height=v),L.ctx2d||(L.ctx2d=L.getContext("2d")),L.ctx2d.drawImage(o,0,0,C,S,0,0,_,v),await this._decode_Canvas(L,u)}async _decode_DCEFrame(o,u){if(Y._onLog&&Y._onLog("_decode_DCEFrame(dceFrame)"),!Y.isDCEFrame(o))return[];let _=[];this.ifSaveOriginalImageInACanvas&&(this.oriCanvas=null,this.oriCanvasData={width:o.width,height:o.height,colorMode:o.colorMode,data:new Uint8Array(o.data),toCanvas:o.toCanvas});const{width:v,height:C,colorMode:S,timeStamp:x}=o;let L;L=u&&u.bCopyData?new Uint8Array(o.data):o.data;let I=null;if(u?(I=JSON.parse(JSON.stringify(u)),I.timeStamp=x):I={timeStamp:x},S==="grey")_=await this._decodeBuffer_Uint8Array(L,v,C,v,Ee.IPF_GrayScaled,I);else if(S==="rgba")_=await this._decodeBuffer_Uint8Array(L,v,C,4*v,Ee.IPF_ABGR_8888,I);else{if(S!=="bgra")throw new Error("Color mode '".concat(S,"' is not supported to decode."));_=await this._decodeBuffer_Uint8Array(L,v,C,4*v,Ee.IPF_ARGB_8888,I)}return _}async _decode_DSImage(o,u){if(Y._onLog&&Y._onLog("_decode_DSImage(dsImage)"),!Y.isDSImage(o))return null;this.ifSaveOriginalImageInACanvas&&(this.oriCanvas=null,this.oriCanvasData={width:o.width,height:o.height,pixelFormat:o.pixelFormat.toLowerCase(),data:new Uint8Array(o.data),toCanvas:function(){const I=document.createElement("canvas");let E;switch(I.width=this.width,I.height=this.height,this.pixelFormat){case"grey":E=new Uint8ClampedArray(this.width*this.height*4);for(let M=0;M<E.length;M+=4)E[M]=this.data[M/4],E[M+1]=this.data[M/4],E[M+2]=this.data[M/4],E[M+3]=255;break;case"rgb":E=new Uint8ClampedArray(this.width*this.height*4);for(let M=0;M<E.length;M+=4)E[M]=this.data[M],E[M+1]=this.data[M+1],E[M+2]=this.data[M+2],E[M+3]=255;break;case"bgr":E=new Uint8ClampedArray(this.width*this.height*4);for(let M=0;M<E.length;M+=4)E[M]=this.data[M],E[M+1]=this.data[M+1],E[M+2]=this.data[M+2],E[M+3]=255;break;case"rgba":case"bgra":E=new Uint8ClampedArray(this.data);break;default:throw new Error("The content of 2D Canvas is currently limited to the sRGB color space.")}const F=new ImageData(E,this.width,this.height);return I.getContext("2d").putImageData(F,0,0),I}});const{width:_,height:v}=o;let C,S,x,L=o.pixelFormat.toLowerCase();switch(C=u&&u.bCopyData?new Uint8Array(o.data):o.data,L){case"grey":x=Ee.IPF_GrayScaled,S=_;break;case"rgb":x=Ee.IPF_BGR_888,S=3*_;break;case"bgr":x=Ee.IPF_RGB_888,S=3*_;break;case"rgba":x=Ee.IPF_ABGR_8888,S=4*_;break;case"bgra":x=Ee.IPF_ARGB_8888,S=4*_;break;default:throw new Error("The pixel format is not supported to decode.")}return await this._decodeBuffer_Uint8Array(C,_,v,S,x,u)}async _decode_Base64(o,u){if(Y._onLog&&Y._onLog("_decode_Base64(base64Str)"),typeof o!="string")return Promise.reject("'_decode_Base64(base64Str, config)': Type of 'base64Str' should be 'string'.");o.substring(0,11)=="data:image/"&&(o=o.substring(o.indexOf(",")+1));{let _=atob(o),v=_.length,C=new Uint8Array(v);for(;v--;)C[v]=_.charCodeAt(v);return await this._decode_Blob(new Blob([C]),u)}}async _decode_Url(o,u){if(Y._onLog&&Y._onLog("_decode_Url(url)"),typeof o!="string")throw TypeError("'_decode_Url(url, config)': Type of 'url' should be 'string'.");o=o;{let _=await new Promise((v,C)=>{let S=new XMLHttpRequest;S.open("GET",o,!0),S.responseType="blob",S.send(),S.onloadend=async()=>{v(S.response)},S.onerror=()=>{C(new Error("Network Error: "+S.statusText))}});return await this._decode_Blob(_,u)}}async _decode_FilePath(o,u){throw Y._onLog&&Y._onLog("_decode_FilePath(path)"),Error("'_decode_FilePath(path, config)': The method is only supported in node environment.")}static recalculateResultLocation(o,u,_,v,C,S,x){if(o.length>0)for(let L of o){let I=L.localizationResult;I.resultCoordinateType==2&&(I.x1*=.01*S,I.x2*=.01*S,I.x3*=.01*S,I.x4*=.01*S,I.y1*=.01*x,I.y2*=.01*x,I.y3*=.01*x,I.y4*=.01*x);let E=S/v,F=x/C;I.x1=I.x1/E+u,I.x2=I.x2/E+u,I.x3=I.x3/E+u,I.x4=I.x4/E+u,I.y1=I.y1/F+_,I.y2=I.y2/F+_,I.y3=I.y3/F+_,I.y4=I.y4/F+_,I.resultCoordinateType==2&&(I.x1*=100/v,I.x2*=100/v,I.x3*=100/v,I.x4*=100/v,I.y1*=100/C,I.y2*=100/C,I.y3*=100/C,I.y4*=100/C)}}static BarcodeReaderException(o,u){let _,v=dt.DBR_UNKNOWN;return typeof o=="number"?(v=o,_=new Error(u)):_=new Error(o),_.code=v,_}_handleRetJsonString(o){let u=dt;if(o.textResults){for(let _=0;_<o.textResults.length;_++){let v=o.textResults[_];try{let C=v.barcodeText,S="";for(let x=0;x<C.length;x++)S+=String.fromCharCode(C[x]);try{v.barcodeText=decodeURIComponent(escape(S))}catch(x){v.barcodeText=S}}catch(C){v.barcodeText=""}if(v.exception!=null){Y._setWarnnedEx.has(v.exception)||(Y._setWarnnedEx.add(v.exception),console.warn(v.exception));let C={};v.exception.split(";").forEach(S=>{let x=S.indexOf(":");C[S.substring(0,x)]=S.substring(x+1)}),v.exception=C}}return o.decodeRecords?this.decodeRecords=o.decodeRecords:this.decodeRecords={},this._lastErrorCode=o.exception,this._lastErrorString=o.description,o.exception&&!Y._setWarnnedEx.has(o.description)&&(Y._setWarnnedEx.add(o.description),console.warn(o.description)),o.textResults}if(o.exception==u.DBR_SUCCESS)return o.data;throw Y.BarcodeReaderException(o.exception,o.description)}async setModeArgument(o,u,_,v){return await new Promise((C,S)=>{let x=Y._nextTaskID++;Y._taskCallbackMap.set(x,L=>{if(L.success){try{this._handleRetJsonString(L.setReturn)}catch(I){return S(I)}return C()}{let I=new Error(L.message);return I.stack=L.stack+"\n"+I.stack,S(I)}}),Y._dbrWorker.postMessage({type:"setModeArgument",id:x,instanceID:this._instanceID,body:{modeName:o,index:u,argumentName:_,argumentValue:v}})})}async getModeArgument(o,u,_){return await new Promise((v,C)=>{let S=Y._nextTaskID++;Y._taskCallbackMap.set(S,x=>{if(x.success){let L;try{L=this._handleRetJsonString(x.getReturn)}catch(I){return C(I)}return v(L)}{let L=new Error(x.message);return L.stack=x.stack+"\n"+L.stack,C(L)}}),Y._dbrWorker.postMessage({type:"getModeArgument",id:S,instanceID:this._instanceID,body:{modeName:o,index:u,argumentName:_}})})}async getIntermediateResults(){return await new Promise((o,u)=>{let _=Y._nextTaskID++;Y._taskCallbackMap.set(_,v=>{if(v.success)return o(v.results);{let C=new Error(v.message);return C.stack=v.stack+"\n"+C.stack,u(C)}}),Y._dbrWorker.postMessage({type:"getIntermediateResults",id:_,instanceID:this._instanceID})})}async getIntermediateCanvas(){let o=await this.getIntermediateResults(),u=[];for(let _ of o)if(_.dataType==vt.IMRDT_IMAGE)for(let v of _.results){const C=v.bytes;let S;switch(Y._onLog&&Y._onLog(" "+C.length+" "+C.byteLength+" "+v.width+" "+v.height+" "+v.stride+" "+v.format),v.format){case Ee.IPF_ABGR_8888:S=new Uint8ClampedArray(C);break;case Ee.IPF_RGB_888:{const I=C.length/3;S=new Uint8ClampedArray(4*I);for(let E=0;E<I;++E)S[4*E]=C[3*E+2],S[4*E+1]=C[3*E+1],S[4*E+2]=C[3*E],S[4*E+3]=255;break}case Ee.IPF_GrayScaled:{const I=C.length;S=new Uint8ClampedArray(4*I);for(let E=0;E<I;E++)S[4*E]=S[4*E+1]=S[4*E+2]=C[E],S[4*E+3]=255;break}case Ee.IPF_Binary:case Ee.IPF_BinaryInverted:{v.width=8*v.stride,v.height=C.length/v.stride;const I=C.length;S=new Uint8ClampedArray(8*I*4);for(let E=0;E<I;E++){let F=C[E];for(let M=0;M<8;++M)S[4*(8*E+M)]=S[4*(8*E+M)+1]=S[4*(8*E+M)+2]=(128&F)/128*255,S[4*(8*E+M)+3]=255,F<<=1}break}default:console.warn("unknow intermediate image",v)}if(!S)continue;let x=new ImageData(S,v.width,v.height),L=document.createElement("canvas");L.width=v.width,L.height=v.height,L.getContext("2d").putImageData(x,0,0),u.push(L)}return u}async keepAlive(){Y._dbrWorker.postMessage({type:"keepAlive"})}async getScanSettings(){return await new Promise((o,u)=>{let _=Y._nextTaskID++;Y._taskCallbackMap.set(_,v=>{if(v.success){let C=v.results;return C.intervalTime=this.intervalTime,C.whenToPlaySoundforSuccessfulRead=this.whenToPlaySoundforSuccessfulRead,C.soundOnSuccessfullRead=this.soundSource,C.whenToVibrateforSuccessfulRead=this.whenToVibrateforSuccessfulRead,C.vibrateDuration=this.vibrateDuration,C.captureAndDecodeInParallel=this.captureAndDecodeInParallel,o(C)}{let C=new Error(v.message);return C.stack+="\n"+v.stack,u(C)}}),Y._dbrWorker.postMessage({type:"getScanSettings",id:_,instanceID:this._instanceID})})}async updateScanSettings(o){if(!o)return;const u=JSON.parse(JSON.stringify(o));return u.hasOwnProperty("intervalTime")&&(this.intervalTime=Math.max(u.intervalTime,0),delete u.intervalTime),u.hasOwnProperty("whenToPlaySoundforSuccessfulRead")&&(this.whenToPlaySoundforSuccessfulRead=u.whenToPlaySoundforSuccessfulRead,delete u.whenToPlaySoundforSuccessfulRead),u.hasOwnProperty("soundOnSuccessfullRead")&&(this.soundSource=u.soundOnSuccessfullRead,delete u.soundOnSuccessfullRead),u.hasOwnProperty("whenToVibrateforSuccessfulRead")&&(this.whenToVibrateforSuccessfulRead=u.whenToVibrateforSuccessfulRead,delete u.whenToVibrateforSuccessfulRead),u.hasOwnProperty("vibrateDuration")&&(this.vibrateDuration=u.vibrateDuration,delete u.vibrateDuration),u.hasOwnProperty("captureAndDecodeInParallel")&&(this.captureAndDecodeInParallel=u.captureAndDecodeInParallel,delete u.captureAndDecodeInParallel),await new Promise((_,v)=>{let C=Y._nextTaskID++;Y._taskCallbackMap.set(C,S=>{if(S.success)return _();{let x=new Error(S.message);return x.stack+="\n"+S.stack,v(x)}}),Y._dbrWorker.postMessage({type:"updateScanSettings",id:C,instanceID:this._instanceID,body:{settings:u}})})}_cloneDecodeResults(o){if(o instanceof Array){let u=[];for(let _ of o)u.push(this._cloneDecodeResults(_));return u}return JSON.parse(JSON.stringify(o,(v,C)=>v=="oriVideoCanvas"||v=="searchRegionCanvas"?void 0:C))}async _loopReadVideo(){if(this.bDestroyed)return this.dce&&this._dceControler&&this._dceControler.setDisiredAction(this,"stopFetchingLoop"),void this._drawResults(null);if(this.dce&&!this.dce.isOpen())return this._drawResults(null),void await this.clearMapDecodeRecord();if(!this.dce&&!this._imgSource||this._bPauseScan)return Y._onLog&&Y._onLog("Scan is paused, or imageSource is not set. Ask in 1s."),await this.clearMapDecodeRecord(),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),void(this._loopReadVideoTimeoutId=setTimeout(()=>{this._loopReadVideo()},this._intervalDetectVideoPause));Y._onLog&&Y._onLog("======= once read ======="),Y._onLog&&(this._timeStartDecode=Date.now());let o=null,u=null;if(this.dce)o=this._getVideoFrame();else if(this._imgSource&&(u=await this._imgSource.getImage(),!Y.isDSImage(u)))throw new Error("Invalid DSImage.");if(!o&&!u)return Y._onLog&&Y._onLog("Get invalid frame."),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),void(this._loopReadVideoTimeoutId=setTimeout(()=>{this._loopReadVideo()},0));(async()=>{let _=[];if(o){_=await this._decode_DCEFrame(o,{bScanner:!0,bCopyData:!1});let v=null;if(_&&_.length){const{sx:C,sy:S,width:x,height:L,_sWidth:I,_sHeight:E}=o;v=_.map(F=>({localizationResult:JSON.parse(JSON.stringify(F.localizationResult))})),Y.recalculateResultLocation(v,C,S,I,E,x,L)}this._drawResults(v)}else u&&(_=await this._decode_DSImage(u,{bScanner:!0,bCopyData:!1}));return _})().then(_=>{if(Y._onLog&&Y._onLog(_),this.dce&&this.captureAndDecodeInParallel){let v=this.array_decodeFrameTimeCost,C=this.array_getFrameTimeCost;const S=()=>{let x=0;if(C&&C.length){let L=Math.min(...v),I=Math.max(...C);L&&I&&(x=L-I)}else x=0;return x>0?x:0};(()=>{for(;v.length>=5;)v.shift();v.push(this._lastInnerDecodeDuration)})(),this._intervalGetVideoFrame=S()+this.intervalTime}if((this.dce&&this.dce.isOpen()||this._imgSource)&&!this._bPauseScan){if(this.bPlaySoundOnSuccessfulRead&&_.length){let v=!1;if(this.bPlaySoundOnSuccessfulRead===!0||this.bPlaySoundOnSuccessfulRead==="frame")v=!0;else if(this.bPlaySoundOnSuccessfulRead==="unique"){for(let C of _)if(C.resultState==0){v=!0;break}}v&&(this.beepSound.stop(),this.beepSound.play())}if(navigator.vibrate&&this.bVibrateOnSuccessfulRead&&_.length){let v=!1;if(this.bVibrateOnSuccessfulRead===!0||this.bVibrateOnSuccessfulRead==="frame")v=!0;else if(this.bVibrateOnSuccessfulRead==="unique"){for(let C of _)if(C.resultState==0){v=!0;break}}if(v)try{navigator.vibrate(this.vibrateDuration)}catch(C){console.warn("Vibration not allowed. User interaction required: "+(C.message||C))}}if(this.onImageRead){let v=this._cloneDecodeResults(_);v.length===0&&this.onImageRead([]);for(let C of v)C.resultState!=0&&C.resultState!=1||this.onImageRead(v)}if(this.onUniqueRead)for(let v of _)v.resultState==0&&this.onUniqueRead(v.barcodeText,this._cloneDecodeResults(v))}this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this.intervalTime?this._loopReadVideoTimeoutId=setTimeout(()=>{this._loopReadVideo()},this.intervalTime):this._loopReadVideo()}).catch(_=>{this.dce&&this._dceControler&&this._dceControler.setDisiredAction(this,"stopFetchingLoop"),Y._onLog&&Y._onLog(_.message||_),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._loopReadVideoTimeoutId=setTimeout(()=>{this.dce&&(this.dce.startFetchingLoop(),this._dceControler&&this._dceControler.clearUserDisiredAction({user:this,actionName:"stopFetchingLoop"})),this._loopReadVideo()},Math.max(this.intervalTime,1e3)),_.message=="platform error"||console.warn(_.message)})}_getVideoFrame(){if(!this.dce)return null;let o;if(this.captureAndDecodeInParallel){if(Y._onLog&&Y._onLog("Get frame in parallel."),this._dceControler&&this._dceControler.setDisiredValue(this,"loopInterval",this._intervalGetVideoFrame),!this.dce.numberOfFramesInBuffer)return this._dceControler&&this._dceControler.setDisiredValue(this,"loopInterval",0),null;o=this.dce.getFrameFromBuffer(),(_=>{if(!_)return;let v=_.timeSpent,C=this.array_getFrameTimeCost;for(;C.length>=5;)C.shift();C.push(v)})(o)}else Y._onLog&&Y._onLog("Get frame in serial."),this._dceControler&&this._dceControler.setDisiredAction(this,"stopFetchingLoop"),o=this.dce.getFrame();return o}_drawResults(o){if(!this.dce||this._bPauseScan||!this._drawingItemNamespace||!this._drawingItemNamespace.DT_Polygon)return;if(!this._dbrDrawingLayer){if(!this.dce.isOpen())return;this._dbrDrawingLayer=this.dce.getDrawingLayer(3)}const u=this._dbrDrawingLayer;o||(o=[]);let _=this._arrPolygons;for(let v=0;v<o.length;v++){let C,S=o[v].localizationResult;_[v]?(C=_[v],u.hasDrawingItem(C)||u.addDrawingItem(C),C.set("vertices",[{x:S.x1,y:S.y1},{x:S.x2,y:S.y2},{x:S.x3,y:S.y3},{x:S.x4,y:S.y4}])):(C=new this._drawingItemNamespace.DT_Polygon([{x:S.x1,y:S.y1},{x:S.x2,y:S.y2},{x:S.x3,y:S.y3},{x:S.x4,y:S.y4}]),u.addDrawingItem(C),_[v]=C)}for(let v=o.length;v<_.length;v++)u.removeDrawingItem(_[v]);u.renderAll()}async startScanning(o){if(!this.dce&&!this._imgSource)throw new Error("'imageSource' is not set. call 'setImageSource()' before 'startScanning()'.");if(this._tempSolutionStatus!="closed"||(this._tempSolutionStatus="opening",this._tempSolutionStatus!="opening"))return;let u=null;return this.dce&&(this.dce.isOpen()?(o&&this.dce.appendAndShowUI(),u=JSON.parse(JSON.stringify(this.dce.playCallbackInfo))):u=await this.dce.open(o),this._dceControler&&(this._dceControler.clearUserDisiredAction({user:this,actionName:"close"}),this._dceControler.clearUserDisiredValue({property:"ifShowScanRegionLaser"}),this._dceControler.setDisiredValue(this,"ifShowScanRegionLaser",!0),this.dce.ifShowScanRegionLaser&&this.dce.showScanRegionLaser())),this._tempSolutionStatus=="opening"?(this._bPauseScan=!1,this.dce&&this.dce.singleFrameMode||(this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._loopReadVideoTimeoutId=setTimeout(()=>{this.dce&&(this.dce.startFetchingLoop(),this._dceControler&&this._dceControler.clearUserDisiredAction({user:this,actionName:"stopFetchingLoop"})),this._loopReadVideo()},0)),this._tempSolutionStatus="opened",this.keepAlive(),u):void 0}stopScanning(o){this.dce&&(this._drawResults(null),this._dceControler&&(this._dceControler.setDisiredValue(this,"ifShowScanRegionLaser",!1),this.dce.ifShowScanRegionLaser||this.dce.hideScanRegionLaser(),this._dceControler.setDisiredAction(this,"close",[o]))),this._bPauseScan=!0,this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0,this._tempSolutionStatus="closed"}pauseScanning(o){if(o&&o.keepResultsHighlighted||this._drawResults(null),this._bPauseScan=!0,this.dce){if(this.dce.singleFrameMode)throw new Error("'pauseScanning()' is unavailable when property 'singleFrameMode' of the 'CameraEnhancer' instance is true.");this._dceControler&&(this._dceControler.setDisiredValue(this,"ifShowScanRegionLaser",!1),this.dce.ifShowScanRegionLaser||this.dce.hideScanRegionLaser(),this._dceControler.setDisiredAction(this,"stopFetchingLoop"))}}resumeScanning(){if(this._bPauseScan=!1,this.dce){if(this.dce.singleFrameMode)throw new Error("'resumeScanning()' is unavailable when property 'singleFrameMode' of the 'CameraEnhancer' instance is true.");this.dce.startFetchingLoop(),this._dceControler&&(this._dceControler.clearUserDisiredAction({user:this,actionName:"stopFetchingLoop"}),this._dceControler.clearUserDisiredValue({property:"ifShowScanRegionLaser"}),this._dceControler.setDisiredValue(this,"ifShowScanRegionLaser",!0),this.dce.ifShowScanRegionLaser&&this.dce.showScanRegionLaser())}}destroyContext(){if(Y._onLog&&Y._onLog("destroyContext()"),this.bDestroyed)return;this.bDestroyed=!0,(this.dce||this._tempSolutionStatus==="opening")&&this.stopScanning(),this.setImageSource(null);let o=Y._nextTaskID++;Y._taskCallbackMap.set(o,u=>{if(!u.success){let _=new Error(u.message);throw _.stack=u.stack+"\n"+_.stack,_}}),Y._dbrWorker.postMessage({type:"destroyContext",id:o,instanceID:this._instanceID})}}Y._jsVersion="9.2.13",Y._jsEditVersion="20220810",Y._version="loading...(JS ".concat(Y._jsVersion,".").concat(Y._jsEditVersion,")"),Y._license=mi,Y._sessionPassword=vi,Y.browserInfo=Re,Y._workerName="dbr-".concat(Y._jsVersion,".browser.worker.js"),Y._engineResourcePath=_i,Y._licenseServer=[],Y._deviceFriendlyName="",Y._isShowRelDecodeTimeInResults=!1,Y._bWasmDebug=!1,Y._bNeverShowDialog=!1,Y.__bUseFullFeature=!0,Y._nextTaskID=0,Y._taskCallbackMap=new Map,Y._pLoad=new class extends Promise{constructor(f){let o,u;super((_,v)=>{o=_,u=v}),this._s="pending",this.resolve=_=>{this.isPending&&(Ct(_)?this.task=_:(this._s="fulfilled",o(_)))},this.reject=_=>{this.isPending&&(this._s="rejected",u(_))},this.task=f}get status(){return this._s}get isPending(){return this._s==="pending"}get isFulfilled(){return this._s==="fulfilled"}get isRejected(){return this._s==="rejected"}get task(){return this._task}set task(f){let o;this._task=f,Ct(f)?o=f:typeof f=="function"&&(o=new Promise(f)),o&&(async()=>{try{const u=await o;f===this._task&&this.resolve(u)}catch(u){f===this._task&&this.reject(u)}})()}get isEmpty(){return this._task==null}},Y._lastErrorCode=0,Y._lastErrorString="",Y._setWarnnedEx=new Set,Y._defaultUIElementURL="@engineResourcePath/dbr.ui.html";var yi={653:(f,o,u)=>{var _,v,C,S,x,L,I,E,F,M,q,se,K,J,le,ue,$,pe,_e,Se,be,g=g||{version:"5.2.1"};if(o.fabric=g,typeof document<"u"&&typeof window<"u")document instanceof(typeof HTMLDocument<"u"?HTMLDocument:Document)?g.document=document:g.document=document.implementation.createHTMLDocument(""),g.window=window;else{var ye=new(u(192)).JSDOM(decodeURIComponent("%3C!DOCTYPE%20html%3E%3Chtml%3E%3Chead%3E%3C%2Fhead%3E%3Cbody%3E%3C%2Fbody%3E%3C%2Fhtml%3E"),{features:{FetchExternalResources:["img"]},resources:"usable"}).window;g.document=ye.document,g.jsdomImplForWrapper=u(898).implForWrapper,g.nodeCanvas=u(245).Canvas,g.window=ye,DOMParser=g.window.DOMParser}function oe(r,i){var n=r.canvas,a=i.targetCanvas,e=a.getContext("2d");e.translate(0,a.height),e.scale(1,-1);var t=n.height-a.height;e.drawImage(n,0,t,a.width,a.height,0,0,a.width,a.height)}function he(r,i){var n=i.targetCanvas.getContext("2d"),a=i.destinationWidth,e=i.destinationHeight,t=a*e*4,s=new Uint8Array(this.imageBuffer,0,t),c=new Uint8ClampedArray(this.imageBuffer,0,t);r.readPixels(0,0,a,e,r.RGBA,r.UNSIGNED_BYTE,s);var h=new ImageData(c,a,e);n.putImageData(h,0,0)}g.isTouchSupported="ontouchstart"in g.window||"ontouchstart"in g.document||g.window&&g.window.navigator&&g.window.navigator.maxTouchPoints>0,g.isLikelyNode=typeof Buffer<"u"&&typeof window>"u",g.SHARED_ATTRIBUTES=["display","transform","fill","fill-opacity","fill-rule","opacity","stroke","stroke-dasharray","stroke-linecap","stroke-dashoffset","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","vector-effect","instantiated_by_use","clip-path"],g.DPI=96,g.reNum="(?:[-+]?(?:\\d+|\\d*\\.\\d+)(?:[eE][-+]?\\d+)?)",g.commaWsp="(?:\\s+,?\\s*|,\\s*)",g.rePathCommand=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:[eE][-+]?\d+)?)/gi,g.reNonWord=/[ \n\.,;!\?\-]/,g.fontPaths={},g.iMatrix=[1,0,0,1,0,0],g.svgNS="http://www.w3.org/2000/svg",g.perfLimitSizeTotal=2097152,g.maxCacheSideLimit=4096,g.minCacheSideLimit=256,g.charWidthsCache={},g.textureSize=2048,g.disableStyleCopyPaste=!1,g.enableGLFiltering=!0,g.devicePixelRatio=g.window.devicePixelRatio||g.window.webkitDevicePixelRatio||g.window.mozDevicePixelRatio||1,g.browserShadowBlurConstant=1,g.arcToSegmentsCache={},g.boundsOfCurveCache={},g.cachesBoundsOfCurve=!0,g.forceGLPutImageData=!1,g.initFilterBackend=function(){return g.enableGLFiltering&&g.isWebglSupported&&g.isWebglSupported(g.textureSize)?(console.log("max texture size: "+g.maxTextureSize),new g.WebglFilterBackend({tileSize:g.textureSize})):g.Canvas2dFilterBackend?new g.Canvas2dFilterBackend:void 0},typeof document<"u"&&typeof window<"u"&&(window.fabric=g),function(){function r(n,a){if(this.__eventListeners[n]){var e=this.__eventListeners[n];a?e[e.indexOf(a)]=!1:g.util.array.fill(e,!1)}}function i(n,a){var e=(function(){a.apply(this,arguments),this.off(n,e)}).bind(this);this.on(n,e)}g.Observable={fire:function(n,a){if(!this.__eventListeners)return this;var e=this.__eventListeners[n];if(!e)return this;for(var t=0,s=e.length;t<s;t++)e[t]&&e[t].call(this,a||{});return this.__eventListeners[n]=e.filter(function(c){return c!==!1}),this},on:function(n,a){if(this.__eventListeners||(this.__eventListeners={}),arguments.length===1)for(var e in n)this.on(e,n[e]);else this.__eventListeners[n]||(this.__eventListeners[n]=[]),this.__eventListeners[n].push(a);return this},once:function(n,a){if(arguments.length===1)for(var e in n)i.call(this,e,n[e]);else i.call(this,n,a);return this},off:function(n,a){if(!this.__eventListeners)return this;if(arguments.length===0)for(n in this.__eventListeners)r.call(this,n);else if(arguments.length===1&&typeof arguments[0]=="object")for(var e in n)r.call(this,e,n[e]);else r.call(this,n,a);return this}}}(),g.Collection={_objects:[],add:function(){if(this._objects.push.apply(this._objects,arguments),this._onObjectAdded)for(var r=0,i=arguments.length;r<i;r++)this._onObjectAdded(arguments[r]);return this.renderOnAddRemove&&this.requestRenderAll(),this},insertAt:function(r,i,n){var a=this._objects;return n?a[i]=r:a.splice(i,0,r),this._onObjectAdded&&this._onObjectAdded(r),this.renderOnAddRemove&&this.requestRenderAll(),this},remove:function(){for(var r,i=this._objects,n=!1,a=0,e=arguments.length;a<e;a++)(r=i.indexOf(arguments[a]))!==-1&&(n=!0,i.splice(r,1),this._onObjectRemoved&&this._onObjectRemoved(arguments[a]));return this.renderOnAddRemove&&n&&this.requestRenderAll(),this},forEachObject:function(r,i){for(var n=this.getObjects(),a=0,e=n.length;a<e;a++)r.call(i,n[a],a,n);return this},getObjects:function(r){return r===void 0?this._objects.concat():this._objects.filter(function(i){return i.type===r})},item:function(r){return this._objects[r]},isEmpty:function(){return this._objects.length===0},size:function(){return this._objects.length},contains:function(r,i){return this._objects.indexOf(r)>-1||!!i&&this._objects.some(function(n){return typeof n.contains=="function"&&n.contains(r,!0)})},complexity:function(){return this._objects.reduce(function(r,i){return r+(i.complexity?i.complexity():0)},0)}},g.CommonMethods={_setOptions:function(r){for(var i in r)this.set(i,r[i])},_initGradient:function(r,i){!r||!r.colorStops||r instanceof g.Gradient||this.set(i,new g.Gradient(r))},_initPattern:function(r,i,n){!r||!r.source||r instanceof g.Pattern?n&&n():this.set(i,new g.Pattern(r,n))},_setObject:function(r){for(var i in r)this._set(i,r[i])},set:function(r,i){return typeof r=="object"?this._setObject(r):this._set(r,i),this},_set:function(r,i){this[r]=i},toggle:function(r){var i=this.get(r);return typeof i=="boolean"&&this.set(r,!i),this},get:function(r){return this[r]}},_=o,v=Math.sqrt,C=Math.atan2,S=Math.pow,x=Math.PI/180,L=Math.PI/2,g.util={cos:function(r){if(r===0)return 1;switch(r<0&&(r=-r),r/L){case 1:case 3:return 0;case 2:return-1}return Math.cos(r)},sin:function(r){if(r===0)return 0;var i=1;switch(r<0&&(i=-1),r/L){case 1:return i;case 2:return 0;case 3:return-i}return Math.sin(r)},removeFromArray:function(r,i){var n=r.indexOf(i);return n!==-1&&r.splice(n,1),r},getRandomInt:function(r,i){return Math.floor(Math.random()*(i-r+1))+r},degreesToRadians:function(r){return r*x},radiansToDegrees:function(r){return r/x},rotatePoint:function(r,i,n){var a=new g.Point(r.x-i.x,r.y-i.y),e=g.util.rotateVector(a,n);return new g.Point(e.x,e.y).addEquals(i)},rotateVector:function(r,i){var n=g.util.sin(i),a=g.util.cos(i);return{x:r.x*a-r.y*n,y:r.x*n+r.y*a}},createVector:function(r,i){return new g.Point(i.x-r.x,i.y-r.y)},calcAngleBetweenVectors:function(r,i){return Math.acos((r.x*i.x+r.y*i.y)/(Math.hypot(r.x,r.y)*Math.hypot(i.x,i.y)))},getHatVector:function(r){return new g.Point(r.x,r.y).multiply(1/Math.hypot(r.x,r.y))},getBisector:function(r,i,n){var a=g.util.createVector(r,i),e=g.util.createVector(r,n),t=g.util.calcAngleBetweenVectors(a,e),s=t*(g.util.calcAngleBetweenVectors(g.util.rotateVector(a,t),e)===0?1:-1)/2;return{vector:g.util.getHatVector(g.util.rotateVector(a,s)),angle:t}},projectStrokeOnPoints:function(r,i,n){var a=[],e=i.strokeWidth/2,t=i.strokeUniform?new g.Point(1/i.scaleX,1/i.scaleY):new g.Point(1,1),s=function(c){var h=e/Math.hypot(c.x,c.y);return new g.Point(c.x*h*t.x,c.y*h*t.y)};return r.length<=1||r.forEach(function(c,h){var l,d,p=new g.Point(c.x,c.y);h===0?(d=r[h+1],l=n?s(g.util.createVector(d,p)).addEquals(p):r[r.length-1]):h===r.length-1?(l=r[h-1],d=n?s(g.util.createVector(l,p)).addEquals(p):r[0]):(l=r[h-1],d=r[h+1]);var m,b,y=g.util.getBisector(p,l,d),w=y.vector,T=y.angle;if(i.strokeLineJoin==="miter"&&(m=-e/Math.sin(T/2),b=new g.Point(w.x*m*t.x,w.y*m*t.y),Math.hypot(b.x,b.y)/e<=i.strokeMiterLimit))return a.push(p.add(b)),void a.push(p.subtract(b));m=-e*Math.SQRT2,b=new g.Point(w.x*m*t.x,w.y*m*t.y),a.push(p.add(b)),a.push(p.subtract(b))}),a},transformPoint:function(r,i,n){return n?new g.Point(i[0]*r.x+i[2]*r.y,i[1]*r.x+i[3]*r.y):new g.Point(i[0]*r.x+i[2]*r.y+i[4],i[1]*r.x+i[3]*r.y+i[5])},makeBoundingBoxFromPoints:function(r,i){if(i)for(var n=0;n<r.length;n++)r[n]=g.util.transformPoint(r[n],i);var a=[r[0].x,r[1].x,r[2].x,r[3].x],e=g.util.array.min(a),t=g.util.array.max(a)-e,s=[r[0].y,r[1].y,r[2].y,r[3].y],c=g.util.array.min(s);return{left:e,top:c,width:t,height:g.util.array.max(s)-c}},invertTransform:function(r){var i=1/(r[0]*r[3]-r[1]*r[2]),n=[i*r[3],-i*r[1],-i*r[2],i*r[0]],a=g.util.transformPoint({x:r[4],y:r[5]},n,!0);return n[4]=-a.x,n[5]=-a.y,n},toFixed:function(r,i){return parseFloat(Number(r).toFixed(i))},parseUnit:function(r,i){var n=/\D{0,2}$/.exec(r),a=parseFloat(r);switch(i||(i=g.Text.DEFAULT_SVG_FONT_SIZE),n[0]){case"mm":return a*g.DPI/25.4;case"cm":return a*g.DPI/2.54;case"in":return a*g.DPI;case"pt":return a*g.DPI/72;case"pc":return a*g.DPI/72*12;case"em":return a*i;default:return a}},falseFunction:function(){return!1},getKlass:function(r,i){return r=g.util.string.camelize(r.charAt(0).toUpperCase()+r.slice(1)),g.util.resolveNamespace(i)[r]},getSvgAttributes:function(r){var i=["instantiated_by_use","style","id","class"];switch(r){case"linearGradient":i=i.concat(["x1","y1","x2","y2","gradientUnits","gradientTransform"]);break;case"radialGradient":i=i.concat(["gradientUnits","gradientTransform","cx","cy","r","fx","fy","fr"]);break;case"stop":i=i.concat(["offset","stop-color","stop-opacity"])}return i},resolveNamespace:function(r){if(!r)return g;var i,n=r.split("."),a=n.length,e=_||g.window;for(i=0;i<a;++i)e=e[n[i]];return e},loadImage:function(r,i,n,a){if(r){var e=g.util.createImage(),t=function(){i&&i.call(n,e,!1),e=e.onload=e.onerror=null};e.onload=t,e.onerror=function(){g.log("Error loading "+e.src),i&&i.call(n,null,!0),e=e.onload=e.onerror=null},r.indexOf("data")!==0&&a!=null&&(e.crossOrigin=a),r.substring(0,14)==="data:image/svg"&&(e.onload=null,g.util.loadImageInDom(e,t)),e.src=r}else i&&i.call(n,r)},loadImageInDom:function(r,i){var n=g.document.createElement("div");n.style.width=n.style.height="1px",n.style.left=n.style.top="-100%",n.style.position="absolute",n.appendChild(r),g.document.querySelector("body").appendChild(n),r.onload=function(){i(),n.parentNode.removeChild(n),n=null}},enlivenObjects:function(r,i,n,a){var e=[],t=0,s=(r=r||[]).length;function c(){++t===s&&i&&i(e.filter(function(h){return h}))}s?r.forEach(function(h,l){h&&h.type?g.util.getKlass(h.type,n).fromObject(h,function(d,p){p||(e[l]=d),a&&a(h,d,p),c()}):c()}):i&&i(e)},enlivenObjectEnlivables:function(r,i,n){var a=g.Object.ENLIVEN_PROPS.filter(function(e){return!!r[e]});g.util.enlivenObjects(a.map(function(e){return r[e]}),function(e){var t={};a.forEach(function(s,c){t[s]=e[c],i&&(i[s]=e[c])}),n&&n(t)})},enlivenPatterns:function(r,i){function n(){++e===t&&i&&i(a)}var a=[],e=0,t=(r=r||[]).length;t?r.forEach(function(s,c){s&&s.source?new g.Pattern(s,function(h){a[c]=h,n()}):(a[c]=s,n())}):i&&i(a)},groupSVGElements:function(r,i,n){var a;return r&&r.length===1?r[0]:(i&&(i.width&&i.height?i.centerPoint={x:i.width/2,y:i.height/2}:(delete i.width,delete i.height)),a=new g.Group(r,i),n!==void 0&&(a.sourcePath=n),a)},populateWithProperties:function(r,i,n){if(n&&Array.isArray(n))for(var a=0,e=n.length;a<e;a++)n[a]in r&&(i[n[a]]=r[n[a]])},createCanvasElement:function(){return g.document.createElement("canvas")},copyCanvasElement:function(r){var i=g.util.createCanvasElement();return i.width=r.width,i.height=r.height,i.getContext("2d").drawImage(r,0,0),i},toDataURL:function(r,i,n){return r.toDataURL("image/"+i,n)},createImage:function(){return g.document.createElement("img")},multiplyTransformMatrices:function(r,i,n){return[r[0]*i[0]+r[2]*i[1],r[1]*i[0]+r[3]*i[1],r[0]*i[2]+r[2]*i[3],r[1]*i[2]+r[3]*i[3],n?0:r[0]*i[4]+r[2]*i[5]+r[4],n?0:r[1]*i[4]+r[3]*i[5]+r[5]]},qrDecompose:function(r){var i=C(r[1],r[0]),n=S(r[0],2)+S(r[1],2),a=v(n),e=(r[0]*r[3]-r[2]*r[1])/a,t=C(r[0]*r[2]+r[1]*r[3],n);return{angle:i/x,scaleX:a,scaleY:e,skewX:t/x,skewY:0,translateX:r[4],translateY:r[5]}},calcRotateMatrix:function(r){if(!r.angle)return g.iMatrix.concat();var i=g.util.degreesToRadians(r.angle),n=g.util.cos(i),a=g.util.sin(i);return[n,a,-a,n,0,0]},calcDimensionsMatrix:function(r){var i=r.scaleX===void 0?1:r.scaleX,n=r.scaleY===void 0?1:r.scaleY,a=[r.flipX?-i:i,0,0,r.flipY?-n:n,0,0],e=g.util.multiplyTransformMatrices,t=g.util.degreesToRadians;return r.skewX&&(a=e(a,[1,0,Math.tan(t(r.skewX)),1],!0)),r.skewY&&(a=e(a,[1,Math.tan(t(r.skewY)),0,1],!0)),a},composeMatrix:function(r){var i=[1,0,0,1,r.translateX||0,r.translateY||0],n=g.util.multiplyTransformMatrices;return r.angle&&(i=n(i,g.util.calcRotateMatrix(r))),(r.scaleX!==1||r.scaleY!==1||r.skewX||r.skewY||r.flipX||r.flipY)&&(i=n(i,g.util.calcDimensionsMatrix(r))),i},resetObjectTransform:function(r){r.scaleX=1,r.scaleY=1,r.skewX=0,r.skewY=0,r.flipX=!1,r.flipY=!1,r.rotate(0)},saveObjectTransform:function(r){return{scaleX:r.scaleX,scaleY:r.scaleY,skewX:r.skewX,skewY:r.skewY,angle:r.angle,left:r.left,flipX:r.flipX,flipY:r.flipY,top:r.top}},isTransparent:function(r,i,n,a){a>0&&(i>a?i-=a:i=0,n>a?n-=a:n=0);var e,t=!0,s=r.getImageData(i,n,2*a||1,2*a||1),c=s.data.length;for(e=3;e<c&&(t=s.data[e]<=0)!=0;e+=4);return s=null,t},parsePreserveAspectRatioAttribute:function(r){var i,n="meet",a=r.split(" ");return a&&a.length&&((n=a.pop())!=="meet"&&n!=="slice"?(i=n,n="meet"):a.length&&(i=a.pop())),{meetOrSlice:n,alignX:i!=="none"?i.slice(1,4):"none",alignY:i!=="none"?i.slice(5,8):"none"}},clearFabricFontCache:function(r){(r=(r||"").toLowerCase())?g.charWidthsCache[r]&&delete g.charWidthsCache[r]:g.charWidthsCache={}},limitDimsByArea:function(r,i){var n=Math.sqrt(i*r),a=Math.floor(i/n);return{x:Math.floor(n),y:a}},capValue:function(r,i,n){return Math.max(r,Math.min(i,n))},findScaleToFit:function(r,i){return Math.min(i.width/r.width,i.height/r.height)},findScaleToCover:function(r,i){return Math.max(i.width/r.width,i.height/r.height)},matrixToSVG:function(r){return"matrix("+r.map(function(i){return g.util.toFixed(i,g.Object.NUM_FRACTION_DIGITS)}).join(" ")+")"},removeTransformFromObject:function(r,i){var n=g.util.invertTransform(i),a=g.util.multiplyTransformMatrices(n,r.calcOwnMatrix());g.util.applyTransformToObject(r,a)},addTransformToObject:function(r,i){g.util.applyTransformToObject(r,g.util.multiplyTransformMatrices(i,r.calcOwnMatrix()))},applyTransformToObject:function(r,i){var n=g.util.qrDecompose(i),a=new g.Point(n.translateX,n.translateY);r.flipX=!1,r.flipY=!1,r.set("scaleX",n.scaleX),r.set("scaleY",n.scaleY),r.skewX=n.skewX,r.skewY=n.skewY,r.angle=n.angle,r.setPositionByOrigin(a,"center","center")},sizeAfterTransform:function(r,i,n){var a=r/2,e=i/2,t=[{x:-a,y:-e},{x:a,y:-e},{x:-a,y:e},{x:a,y:e}],s=g.util.calcDimensionsMatrix(n),c=g.util.makeBoundingBoxFromPoints(t,s);return{x:c.width,y:c.height}},mergeClipPaths:function(r,i){var n=r,a=i;n.inverted&&!a.inverted&&(n=i,a=r),g.util.applyTransformToObject(a,g.util.multiplyTransformMatrices(g.util.invertTransform(n.calcTransformMatrix()),a.calcTransformMatrix()));var e=n.inverted&&a.inverted;return e&&(n.inverted=a.inverted=!1),new g.Group([n],{clipPath:a,inverted:e})}},function(){var r=Array.prototype.join,i={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},n={m:"l",M:"L"};function a(b,y,w,T,k,P,G,V,N,A,O){var B=g.util.cos(b),W=g.util.sin(b),H=g.util.cos(y),R=g.util.sin(y),D=w*k*H-T*P*R+G,j=T*k*H+w*P*R+V;return["C",A+N*(-w*k*W-T*P*B),O+N*(-T*k*W+w*P*B),D+N*(w*k*R+T*P*H),j+N*(T*k*R-w*P*H),D,j]}function e(b,y,w,T){var k=Math.atan2(y,b),P=Math.atan2(T,w);return P>=k?P-k:2*Math.PI-(k-P)}function t(b,y,w){for(var T=w[1],k=w[2],P=w[3],G=w[4],V=w[5],N=function(B,W,H,R,D,j,X){var U=Math.PI,z=X*U/180,ie=g.util.sin(z),Z=g.util.cos(z),Q=0,te=0,ee=-Z*B*.5-ie*W*.5,re=-Z*W*.5+ie*B*.5,ae=(H=Math.abs(H))*H,ne=(R=Math.abs(R))*R,ge=re*re,me=ee*ee,Te=ae*ne-ae*ge-ne*me,Ie=0;if(Te<0){var je=Math.sqrt(1-Te/(ae*ne));H*=je,R*=je}else Ie=(D===j?-1:1)*Math.sqrt(Te/(ae*ge+ne*me));var ve=Ie*H*re/R,Oe=-Ie*R*ee/H,Ue=Z*ve-ie*Oe+.5*B,Ne=ie*ve+Z*Oe+.5*W,Le=e(1,0,(ee-ve)/H,(re-Oe)/R),Ve=e((ee-ve)/H,(re-Oe)/R,(-ee-ve)/H,(-re-Oe)/R);j===0&&Ve>0?Ve-=2*U:j===1&&Ve<0&&(Ve+=2*U);for(var it=Math.ceil(Math.abs(Ve/U*2)),Xe=[],We=Ve/it,mt=8/3*Math.sin(We/4)*Math.sin(We/4)/Math.sin(We/2),qe=Le+We,Ge=0;Ge<it;Ge++)Xe[Ge]=a(Le,qe,Z,ie,H,R,Ue,Ne,mt,Q,te),Q=Xe[Ge][5],te=Xe[Ge][6],Le=qe,qe+=We;return Xe}(w[6]-b,w[7]-y,T,k,G,V,P),A=0,O=N.length;A<O;A++)N[A][1]+=b,N[A][2]+=y,N[A][3]+=b,N[A][4]+=y,N[A][5]+=b,N[A][6]+=y;return N}function s(b,y,w,T){return Math.sqrt((w-b)*(w-b)+(T-y)*(T-y))}function c(b,y,w,T,k,P,G,V){return function(N){var A,O=(A=N)*A*A,B=function(R){return 3*R*R*(1-R)}(N),W=function(R){return 3*R*(1-R)*(1-R)}(N),H=function(R){return(1-R)*(1-R)*(1-R)}(N);return{x:G*O+k*B+w*W+b*H,y:V*O+P*B+T*W+y*H}}}function h(b,y,w,T,k,P,G,V){return function(N){var A=1-N,O=3*A*A*(w-b)+6*A*N*(k-w)+3*N*N*(G-k),B=3*A*A*(T-y)+6*A*N*(P-T)+3*N*N*(V-P);return Math.atan2(B,O)}}function l(b,y,w,T,k,P){return function(G){var V,N=(V=G)*V,A=function(B){return 2*B*(1-B)}(G),O=function(B){return(1-B)*(1-B)}(G);return{x:k*N+w*A+b*O,y:P*N+T*A+y*O}}}function d(b,y,w,T,k,P){return function(G){var V=1-G,N=2*V*(w-b)+2*G*(k-w),A=2*V*(T-y)+2*G*(P-T);return Math.atan2(A,N)}}function p(b,y,w){var T,k,P={x:y,y:w},G=0;for(k=1;k<=100;k+=1)T=b(k/100),G+=s(P.x,P.y,T.x,T.y),P=T;return G}function m(b){for(var y,w,T,k,P=0,G=b.length,V=0,N=0,A=0,O=0,B=[],W=0;W<G;W++){switch(T={x:V,y:N,command:(y=b[W])[0]},y[0]){case"M":T.length=0,A=V=y[1],O=N=y[2];break;case"L":T.length=s(V,N,y[1],y[2]),V=y[1],N=y[2];break;case"C":w=c(V,N,y[1],y[2],y[3],y[4],y[5],y[6]),k=h(V,N,y[1],y[2],y[3],y[4],y[5],y[6]),T.iterator=w,T.angleFinder=k,T.length=p(w,V,N),V=y[5],N=y[6];break;case"Q":w=l(V,N,y[1],y[2],y[3],y[4]),k=d(V,N,y[1],y[2],y[3],y[4]),T.iterator=w,T.angleFinder=k,T.length=p(w,V,N),V=y[3],N=y[4];break;case"Z":case"z":T.destX=A,T.destY=O,T.length=s(V,N,A,O),V=A,N=O}P+=T.length,B.push(T)}return B.push({length:P,x:V,y:N}),B}g.util.joinPath=function(b){return b.map(function(y){return y.join(" ")}).join(" ")},g.util.parsePath=function(b){var y,w,T,k,P,G=[],V=[],N=g.rePathCommand,A="[-+]?(?:\\d*\\.\\d+|\\d+\\.?)(?:[eE][-+]?\\d+)?\\s*",O="("+A+")"+g.commaWsp,B="([01])"+g.commaWsp+"?",W=new RegExp(O+"?"+O+"?"+O+B+B+O+"?("+A+")","g");if(!b||!b.match)return G;for(var H,R=0,D=(P=b.match(/[mzlhvcsqta][^mzlhvcsqta]*/gi)).length;R<D;R++){k=(y=P[R]).slice(1).trim(),V.length=0;var j=y.charAt(0);if(H=[j],j.toLowerCase()==="a")for(var X;X=W.exec(k);)for(var U=1;U<X.length;U++)V.push(X[U]);else for(;T=N.exec(k);)V.push(T[0]);U=0;for(var z=V.length;U<z;U++)w=parseFloat(V[U]),isNaN(w)||H.push(w);var ie=i[j.toLowerCase()],Z=n[j]||j;if(H.length-1>ie)for(var Q=1,te=H.length;Q<te;Q+=ie)G.push([j].concat(H.slice(Q,Q+ie))),j=Z;else G.push(H)}return G},g.util.makePathSimpler=function(b){var y,w,T,k,P,G,V=0,N=0,A=b.length,O=0,B=0,W=[];for(w=0;w<A;++w){switch(T=!1,(y=b[w].slice(0))[0]){case"l":y[0]="L",y[1]+=V,y[2]+=N;case"L":V=y[1],N=y[2];break;case"h":y[1]+=V;case"H":y[0]="L",y[2]=N,V=y[1];break;case"v":y[1]+=N;case"V":y[0]="L",N=y[1],y[1]=V,y[2]=N;break;case"m":y[0]="M",y[1]+=V,y[2]+=N;case"M":V=y[1],N=y[2],O=y[1],B=y[2];break;case"c":y[0]="C",y[1]+=V,y[2]+=N,y[3]+=V,y[4]+=N,y[5]+=V,y[6]+=N;case"C":P=y[3],G=y[4],V=y[5],N=y[6];break;case"s":y[0]="S",y[1]+=V,y[2]+=N,y[3]+=V,y[4]+=N;case"S":k==="C"?(P=2*V-P,G=2*N-G):(P=V,G=N),V=y[3],N=y[4],y[0]="C",y[5]=y[3],y[6]=y[4],y[3]=y[1],y[4]=y[2],y[1]=P,y[2]=G,P=y[3],G=y[4];break;case"q":y[0]="Q",y[1]+=V,y[2]+=N,y[3]+=V,y[4]+=N;case"Q":P=y[1],G=y[2],V=y[3],N=y[4];break;case"t":y[0]="T",y[1]+=V,y[2]+=N;case"T":k==="Q"?(P=2*V-P,G=2*N-G):(P=V,G=N),y[0]="Q",V=y[1],N=y[2],y[1]=P,y[2]=G,y[3]=V,y[4]=N;break;case"a":y[0]="A",y[6]+=V,y[7]+=N;case"A":T=!0,W=W.concat(t(V,N,y)),V=y[6],N=y[7];break;case"z":case"Z":V=O,N=B}T||W.push(y),k=y[0]}return W},g.util.getSmoothPathFromPoints=function(b,y){var w,T=[],k=new g.Point(b[0].x,b[0].y),P=new g.Point(b[1].x,b[1].y),G=b.length,V=1,N=0,A=G>2;for(y=y||0,A&&(V=b[2].x<P.x?-1:b[2].x===P.x?0:1,N=b[2].y<P.y?-1:b[2].y===P.y?0:1),T.push(["M",k.x-V*y,k.y-N*y]),w=1;w<G;w++){if(!k.eq(P)){var O=k.midPointFrom(P);T.push(["Q",k.x,k.y,O.x,O.y])}k=b[w],w+1<b.length&&(P=b[w+1])}return A&&(V=k.x>b[w-2].x?1:k.x===b[w-2].x?0:-1,N=k.y>b[w-2].y?1:k.y===b[w-2].y?0:-1),T.push(["L",k.x+V*y,k.y+N*y]),T},g.util.getPathSegmentsInfo=m,g.util.getBoundsOfCurve=function(b,y,w,T,k,P,G,V){var N;if(g.cachesBoundsOfCurve&&(N=r.call(arguments),g.boundsOfCurveCache[N]))return g.boundsOfCurveCache[N];var A,O,B,W,H,R,D,j,X=Math.sqrt,U=Math.min,z=Math.max,ie=Math.abs,Z=[],Q=[[],[]];O=6*b-12*w+6*k,A=-3*b+9*w-9*k+3*G,B=3*w-3*b;for(var te=0;te<2;++te)if(te>0&&(O=6*y-12*T+6*P,A=-3*y+9*T-9*P+3*V,B=3*T-3*y),ie(A)<1e-12){if(ie(O)<1e-12)continue;0<(W=-B/O)&&W<1&&Z.push(W)}else(D=O*O-4*B*A)<0||(0<(H=(-O+(j=X(D)))/(2*A))&&H<1&&Z.push(H),0<(R=(-O-j)/(2*A))&&R<1&&Z.push(R));for(var ee,re,ae,ne=Z.length,ge=ne;ne--;)ee=(ae=1-(W=Z[ne]))*ae*ae*b+3*ae*ae*W*w+3*ae*W*W*k+W*W*W*G,Q[0][ne]=ee,re=ae*ae*ae*y+3*ae*ae*W*T+3*ae*W*W*P+W*W*W*V,Q[1][ne]=re;Q[0][ge]=b,Q[1][ge]=y,Q[0][ge+1]=G,Q[1][ge+1]=V;var me=[{x:U.apply(null,Q[0]),y:U.apply(null,Q[1])},{x:z.apply(null,Q[0]),y:z.apply(null,Q[1])}];return g.cachesBoundsOfCurve&&(g.boundsOfCurveCache[N]=me),me},g.util.getPointOnPath=function(b,y,w){w||(w=m(b));for(var T=0;y-w[T].length>0&&T<w.length-2;)y-=w[T].length,T++;var k,P=w[T],G=y/P.length,V=P.command,N=b[T];switch(V){case"M":return{x:P.x,y:P.y,angle:0};case"Z":case"z":return(k=new g.Point(P.x,P.y).lerp(new g.Point(P.destX,P.destY),G)).angle=Math.atan2(P.destY-P.y,P.destX-P.x),k;case"L":return(k=new g.Point(P.x,P.y).lerp(new g.Point(N[1],N[2]),G)).angle=Math.atan2(N[2]-P.y,N[1]-P.x),k;case"C":case"Q":return function(A,O){for(var B,W,H,R=0,D=0,j=A.iterator,X={x:A.x,y:A.y},U=.01,z=A.angleFinder;D<O&&U>1e-4;)B=j(R),H=R,(W=s(X.x,X.y,B.x,B.y))+D>O?(R-=U,U/=2):(X=B,R+=U,D+=W);return B.angle=z(H),B}(P,y)}},g.util.transformPath=function(b,y,w){return w&&(y=g.util.multiplyTransformMatrices(y,[1,0,0,1,-w.x,-w.y])),b.map(function(T){for(var k=T.slice(0),P={},G=1;G<T.length-1;G+=2)P.x=T[G],P.y=T[G+1],P=g.util.transformPoint(P,y),k[G]=P.x,k[G+1]=P.y;return k})}}(),function(){var r=Array.prototype.slice;function i(n,a,e){if(n&&n.length!==0){var t=n.length-1,s=a?n[t][a]:n[t];if(a)for(;t--;)e(n[t][a],s)&&(s=n[t][a]);else for(;t--;)e(n[t],s)&&(s=n[t]);return s}}g.util.array={fill:function(n,a){for(var e=n.length;e--;)n[e]=a;return n},invoke:function(n,a){for(var e=r.call(arguments,2),t=[],s=0,c=n.length;s<c;s++)t[s]=e.length?n[s][a].apply(n[s],e):n[s][a].call(n[s]);return t},min:function(n,a){return i(n,a,function(e,t){return e<t})},max:function(n,a){return i(n,a,function(e,t){return e>=t})}}}(),function(){function r(i,n,a){if(a)if(!g.isLikelyNode&&n instanceof Element)i=n;else if(n instanceof Array){i=[];for(var e=0,t=n.length;e<t;e++)i[e]=r({},n[e],a)}else if(n&&typeof n=="object")for(var s in n)s==="canvas"||s==="group"?i[s]=null:n.hasOwnProperty(s)&&(i[s]=r({},n[s],a));else i=n;else for(var s in n)i[s]=n[s];return i}g.util.object={extend:r,clone:function(i,n){return r({},i,n)}},g.util.object.extend(g.util,g.Observable)}(),function(){function r(i,n){var a=i.charCodeAt(n);if(isNaN(a))return"";if(a<55296||a>57343)return i.charAt(n);if(55296<=a&&a<=56319){if(i.length<=n+1)throw"High surrogate without following low surrogate";var e=i.charCodeAt(n+1);if(56320>e||e>57343)throw"High surrogate without following low surrogate";return i.charAt(n)+i.charAt(n+1)}if(n===0)throw"Low surrogate without preceding high surrogate";var t=i.charCodeAt(n-1);if(55296>t||t>56319)throw"Low surrogate without preceding high surrogate";return!1}g.util.string={camelize:function(i){return i.replace(/-+(.)?/g,function(n,a){return a?a.toUpperCase():""})},capitalize:function(i,n){return i.charAt(0).toUpperCase()+(n?i.slice(1):i.slice(1).toLowerCase())},escapeXml:function(i){return i.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},graphemeSplit:function(i){var n,a=0,e=[];for(a=0;a<i.length;a++)(n=r(i,a))!==!1&&e.push(n);return e}}}(),function(){var r=Array.prototype.slice,i=function(){},n=function(){for(var s in{toString:1})if(s==="toString")return!1;return!0}(),a=function(s,c,h){for(var l in c)l in s.prototype&&typeof s.prototype[l]=="function"&&(c[l]+"").indexOf("callSuper")>-1?s.prototype[l]=function(d){return function(){var p=this.constructor.superclass;this.constructor.superclass=h;var m=c[d].apply(this,arguments);if(this.constructor.superclass=p,d!=="initialize")return m}}(l):s.prototype[l]=c[l],n&&(c.toString!==Object.prototype.toString&&(s.prototype.toString=c.toString),c.valueOf!==Object.prototype.valueOf&&(s.prototype.valueOf=c.valueOf))};function e(){}function t(s){for(var c=null,h=this;h.constructor.superclass;){var l=h.constructor.superclass.prototype[s];if(h[s]!==l){c=l;break}h=h.constructor.superclass.prototype}return c?arguments.length>1?c.apply(this,r.call(arguments,1)):c.call(this):console.log("tried to callSuper "+s+", method not found in prototype chain",this)}g.util.createClass=function(){var s=null,c=r.call(arguments,0);function h(){this.initialize.apply(this,arguments)}typeof c[0]=="function"&&(s=c.shift()),h.superclass=s,h.subclasses=[],s&&(e.prototype=s.prototype,h.prototype=new e,s.subclasses.push(h));for(var l=0,d=c.length;l<d;l++)a(h,c[l],s);return h.prototype.initialize||(h.prototype.initialize=i),h.prototype.constructor=h,h.prototype.callSuper=t,h}}(),I=!!g.document.createElement("div").attachEvent,E=["touchstart","touchmove","touchend"],g.util.addListener=function(r,i,n,a){r&&r.addEventListener(i,n,!I&&a)},g.util.removeListener=function(r,i,n,a){r&&r.removeEventListener(i,n,!I&&a)},g.util.getPointer=function(r){var i=r.target,n=g.util.getScrollLeftTop(i),a=function(e){var t=e.changedTouches;return t&&t[0]?t[0]:e}(r);return{x:a.clientX+n.left,y:a.clientY+n.top}},g.util.isTouchEvent=function(r){return E.indexOf(r.type)>-1||r.pointerType==="touch"},M=typeof(F=g.document.createElement("div")).style.opacity=="string",q=typeof F.style.filter=="string",se=/alpha\s*\(\s*opacity\s*=\s*([^\)]+)\)/,K=function(r){return r},M?K=function(r,i){return r.style.opacity=i,r}:q&&(K=function(r,i){var n=r.style;return r.currentStyle&&!r.currentStyle.hasLayout&&(n.zoom=1),se.test(n.filter)?(i=i>=.9999?"":"alpha(opacity="+100*i+")",n.filter=n.filter.replace(se,i)):n.filter+=" alpha(opacity="+100*i+")",r}),g.util.setStyle=function(r,i){var n=r.style;if(!n)return r;if(typeof i=="string")return r.style.cssText+=";"+i,i.indexOf("opacity")>-1?K(r,i.match(/opacity:\s*(\d?\.?\d*)/)[1]):r;for(var a in i)a==="opacity"?K(r,i[a]):n[a==="float"||a==="cssFloat"?n.styleFloat===void 0?"cssFloat":"styleFloat":a]=i[a];return r},function(){var r,i,n,a,e=Array.prototype.slice,t=function(h){return e.call(h,0)};try{r=t(g.document.childNodes)instanceof Array}catch(h){}function s(h,l){var d=g.document.createElement(h);for(var p in l)p==="class"?d.className=l[p]:p==="for"?d.htmlFor=l[p]:d.setAttribute(p,l[p]);return d}function c(h){for(var l=0,d=0,p=g.document.documentElement,m=g.document.body||{scrollLeft:0,scrollTop:0};h&&(h.parentNode||h.host)&&((h=h.parentNode||h.host)===g.document?(l=m.scrollLeft||p.scrollLeft||0,d=m.scrollTop||p.scrollTop||0):(l+=h.scrollLeft||0,d+=h.scrollTop||0),h.nodeType!==1||h.style.position!=="fixed"););return{left:l,top:d}}r||(t=function(h){for(var l=new Array(h.length),d=h.length;d--;)l[d]=h[d];return l}),i=g.document.defaultView&&g.document.defaultView.getComputedStyle?function(h,l){var d=g.document.defaultView.getComputedStyle(h,null);return d?d[l]:void 0}:function(h,l){var d=h.style[l];return!d&&h.currentStyle&&(d=h.currentStyle[l]),d},n=g.document.documentElement.style,a="userSelect"in n?"userSelect":"MozUserSelect"in n?"MozUserSelect":"WebkitUserSelect"in n?"WebkitUserSelect":"KhtmlUserSelect"in n?"KhtmlUserSelect":"",g.util.makeElementUnselectable=function(h){return h.onselectstart!==void 0&&(h.onselectstart=g.util.falseFunction),a?h.style[a]="none":typeof h.unselectable=="string"&&(h.unselectable="on"),h},g.util.makeElementSelectable=function(h){return h.onselectstart!==void 0&&(h.onselectstart=null),a?h.style[a]="":typeof h.unselectable=="string"&&(h.unselectable=""),h},g.util.setImageSmoothing=function(h,l){h.imageSmoothingEnabled=h.imageSmoothingEnabled||h.webkitImageSmoothingEnabled||h.mozImageSmoothingEnabled||h.msImageSmoothingEnabled||h.oImageSmoothingEnabled,h.imageSmoothingEnabled=l},g.util.getById=function(h){return typeof h=="string"?g.document.getElementById(h):h},g.util.toArray=t,g.util.addClass=function(h,l){h&&(" "+h.className+" ").indexOf(" "+l+" ")===-1&&(h.className+=(h.className?" ":"")+l)},g.util.makeElement=s,g.util.wrapElement=function(h,l,d){return typeof l=="string"&&(l=s(l,d)),h.parentNode&&h.parentNode.replaceChild(l,h),l.appendChild(h),l},g.util.getScrollLeftTop=c,g.util.getElementOffset=function(h){var l,d,p=h&&h.ownerDocument,m={left:0,top:0},b={left:0,top:0},y={borderLeftWidth:"left",borderTopWidth:"top",paddingLeft:"left",paddingTop:"top"};if(!p)return b;for(var w in y)b[y[w]]+=parseInt(i(h,w),10)||0;return l=p.documentElement,h.getBoundingClientRect!==void 0&&(m=h.getBoundingClientRect()),d=c(h),{left:m.left+d.left-(l.clientLeft||0)+b.left,top:m.top+d.top-(l.clientTop||0)+b.top}},g.util.getNodeCanvas=function(h){var l=g.jsdomImplForWrapper(h);return l._canvas||l._image},g.util.cleanUpJsdomNode=function(h){if(g.isLikelyNode){var l=g.jsdomImplForWrapper(h);l&&(l._image=null,l._canvas=null,l._currentSrc=null,l._attributes=null,l._classList=null)}}}(),function(){function r(){}g.util.request=function(i,n){n||(n={});var a=n.method?n.method.toUpperCase():"GET",e=n.onComplete||function(){},t=new g.window.XMLHttpRequest,s=n.body||n.parameters;return t.onreadystatechange=function(){t.readyState===4&&(e(t),t.onreadystatechange=r)},a==="GET"&&(s=null,typeof n.parameters=="string"&&(i=function(c,h){return c+(/\?/.test(c)?"&":"?")+h}(i,n.parameters))),t.open(a,i,!0),a!=="POST"&&a!=="PUT"||t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.send(s),t}}(),g.log=console.log,g.warn=console.warn,function(){var r=g.util.object.extend,i=g.util.object.clone,n=[];function a(){return!1}function e(h,l,d,p){return-d*Math.cos(h/p*(Math.PI/2))+d+l}g.util.object.extend(n,{cancelAll:function(){var h=this.splice(0);return h.forEach(function(l){l.cancel()}),h},cancelByCanvas:function(h){if(!h)return[];var l=this.filter(function(d){return typeof d.target=="object"&&d.target.canvas===h});return l.forEach(function(d){d.cancel()}),l},cancelByTarget:function(h){var l=this.findAnimationsByTarget(h);return l.forEach(function(d){d.cancel()}),l},findAnimationIndex:function(h){return this.indexOf(this.findAnimation(h))},findAnimation:function(h){return this.find(function(l){return l.cancel===h})},findAnimationsByTarget:function(h){return h?this.filter(function(l){return l.target===h}):[]}});var t=g.window.requestAnimationFrame||g.window.webkitRequestAnimationFrame||g.window.mozRequestAnimationFrame||g.window.oRequestAnimationFrame||g.window.msRequestAnimationFrame||function(h){return g.window.setTimeout(h,1e3/60)},s=g.window.cancelAnimationFrame||g.window.clearTimeout;function c(){return t.apply(g.window,arguments)}g.util.animate=function(h){h||(h={});var l,d=!1,p=function(){var m=g.runningAnimations.indexOf(l);return m>-1&&g.runningAnimations.splice(m,1)[0]};return l=r(i(h),{cancel:function(){return d=!0,p()},currentValue:"startValue"in h?h.startValue:0,completionRate:0,durationRate:0}),g.runningAnimations.push(l),c(function(m){var b,y=m||+new Date,w=h.duration||500,T=y+w,k=h.onChange||a,P=h.abort||a,G=h.onComplete||a,V=h.easing||e,N="startValue"in h&&h.startValue.length>0,A="startValue"in h?h.startValue:0,O="endValue"in h?h.endValue:100,B=h.byValue||(N?A.map(function(W,H){return O[H]-A[H]}):O-A);h.onStart&&h.onStart(),function W(H){var R=(b=H||+new Date)>T?w:b-y,D=R/w,j=N?A.map(function(U,z){return V(R,A[z],B[z],w)}):V(R,A,B,w),X=Math.abs(N?(j[0]-A[0])/B[0]:(j-A)/B);if(l.currentValue=N?j.slice():j,l.completionRate=X,l.durationRate=D,!d){if(!P(j,X,D))return b>T?(l.currentValue=N?O.slice():O,l.completionRate=1,l.durationRate=1,k(N?O.slice():O,1,1),G(O,1,1),void p()):(k(j,X,D),void c(W));p()}}(y)}),l.cancel},g.util.requestAnimFrame=c,g.util.cancelAnimFrame=function(){return s.apply(g.window,arguments)},g.runningAnimations=n}(),function(){function r(i,n,a){var e="rgba("+parseInt(i[0]+a*(n[0]-i[0]),10)+","+parseInt(i[1]+a*(n[1]-i[1]),10)+","+parseInt(i[2]+a*(n[2]-i[2]),10);return(e+=","+(i&&n?parseFloat(i[3]+a*(n[3]-i[3])):1))+")"}g.util.animateColor=function(i,n,a,e){var t=new g.Color(i).getSource(),s=new g.Color(n).getSource(),c=e.onComplete,h=e.onChange;return e=e||{},g.util.animate(g.util.object.extend(e,{duration:a||500,startValue:t,endValue:s,byValue:s,easing:function(l,d,p,m){return r(d,p,e.colorEasing?e.colorEasing(l,m):1-Math.cos(l/m*(Math.PI/2)))},onComplete:function(l,d,p){if(c)return c(r(s,s,0),d,p)},onChange:function(l,d,p){if(h){if(Array.isArray(l))return h(r(l,l,0),d,p);h(l,d,p)}}}))}}(),function(){function r(e,t,s,c){return e<Math.abs(t)?(e=t,c=s/4):c=t===0&&e===0?s/(2*Math.PI)*Math.asin(1):s/(2*Math.PI)*Math.asin(t/e),{a:e,c:t,p:s,s:c}}function i(e,t,s){return e.a*Math.pow(2,10*(t-=1))*Math.sin((t*s-e.s)*(2*Math.PI)/e.p)}function n(e,t,s,c){return s-a(c-e,0,s,c)+t}function a(e,t,s,c){return(e/=c)<1/2.75?s*(7.5625*e*e)+t:e<2/2.75?s*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?s*(7.5625*(e-=2.25/2.75)*e+.9375)+t:s*(7.5625*(e-=2.625/2.75)*e+.984375)+t}g.util.ease={easeInQuad:function(e,t,s,c){return s*(e/=c)*e+t},easeOutQuad:function(e,t,s,c){return-s*(e/=c)*(e-2)+t},easeInOutQuad:function(e,t,s,c){return(e/=c/2)<1?s/2*e*e+t:-s/2*(--e*(e-2)-1)+t},easeInCubic:function(e,t,s,c){return s*(e/=c)*e*e+t},easeOutCubic:function(e,t,s,c){return s*((e=e/c-1)*e*e+1)+t},easeInOutCubic:function(e,t,s,c){return(e/=c/2)<1?s/2*e*e*e+t:s/2*((e-=2)*e*e+2)+t},easeInQuart:function(e,t,s,c){return s*(e/=c)*e*e*e+t},easeOutQuart:function(e,t,s,c){return-s*((e=e/c-1)*e*e*e-1)+t},easeInOutQuart:function(e,t,s,c){return(e/=c/2)<1?s/2*e*e*e*e+t:-s/2*((e-=2)*e*e*e-2)+t},easeInQuint:function(e,t,s,c){return s*(e/=c)*e*e*e*e+t},easeOutQuint:function(e,t,s,c){return s*((e=e/c-1)*e*e*e*e+1)+t},easeInOutQuint:function(e,t,s,c){return(e/=c/2)<1?s/2*e*e*e*e*e+t:s/2*((e-=2)*e*e*e*e+2)+t},easeInSine:function(e,t,s,c){return-s*Math.cos(e/c*(Math.PI/2))+s+t},easeOutSine:function(e,t,s,c){return s*Math.sin(e/c*(Math.PI/2))+t},easeInOutSine:function(e,t,s,c){return-s/2*(Math.cos(Math.PI*e/c)-1)+t},easeInExpo:function(e,t,s,c){return e===0?t:s*Math.pow(2,10*(e/c-1))+t},easeOutExpo:function(e,t,s,c){return e===c?t+s:s*(1-Math.pow(2,-10*e/c))+t},easeInOutExpo:function(e,t,s,c){return e===0?t:e===c?t+s:(e/=c/2)<1?s/2*Math.pow(2,10*(e-1))+t:s/2*(2-Math.pow(2,-10*--e))+t},easeInCirc:function(e,t,s,c){return-s*(Math.sqrt(1-(e/=c)*e)-1)+t},easeOutCirc:function(e,t,s,c){return s*Math.sqrt(1-(e=e/c-1)*e)+t},easeInOutCirc:function(e,t,s,c){return(e/=c/2)<1?-s/2*(Math.sqrt(1-e*e)-1)+t:s/2*(Math.sqrt(1-(e-=2)*e)+1)+t},easeInElastic:function(e,t,s,c){var h=0;return e===0?t:(e/=c)==1?t+s:(h||(h=.3*c),-i(r(s,s,h,1.70158),e,c)+t)},easeOutElastic:function(e,t,s,c){var h=0;if(e===0)return t;if((e/=c)==1)return t+s;h||(h=.3*c);var l=r(s,s,h,1.70158);return l.a*Math.pow(2,-10*e)*Math.sin((e*c-l.s)*(2*Math.PI)/l.p)+l.c+t},easeInOutElastic:function(e,t,s,c){var h=0;if(e===0)return t;if((e/=c/2)==2)return t+s;h||(h=c*(.3*1.5));var l=r(s,s,h,1.70158);return e<1?-.5*i(l,e,c)+t:l.a*Math.pow(2,-10*(e-=1))*Math.sin((e*c-l.s)*(2*Math.PI)/l.p)*.5+l.c+t},easeInBack:function(e,t,s,c,h){return h===void 0&&(h=1.70158),s*(e/=c)*e*((h+1)*e-h)+t},easeOutBack:function(e,t,s,c,h){return h===void 0&&(h=1.70158),s*((e=e/c-1)*e*((h+1)*e+h)+1)+t},easeInOutBack:function(e,t,s,c,h){return h===void 0&&(h=1.70158),(e/=c/2)<1?s/2*(e*e*((1+(h*=1.525))*e-h))+t:s/2*((e-=2)*e*((1+(h*=1.525))*e+h)+2)+t},easeInBounce:n,easeOutBounce:a,easeInOutBounce:function(e,t,s,c){return e<c/2?.5*n(2*e,0,s,c)+t:.5*a(2*e-c,0,s,c)+.5*s+t}}}(),function(r){var i=r.fabric||(r.fabric={}),n=i.util.object.extend,a=i.util.object.clone,e=i.util.toFixed,t=i.util.parseUnit,s=i.util.multiplyTransformMatrices,c={cx:"left",x:"left",r:"radius",cy:"top",y:"top",display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-dashoffset":"strokeDashOffset","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule","vector-effect":"strokeUniform","image-rendering":"imageSmoothing"},h={stroke:"strokeOpacity",fill:"fillOpacity"},l="font-size",d="clip-path";function p(A){return A in c?c[A]:A}function m(A,O,B,W){var H,R=Array.isArray(O);if(A!=="fill"&&A!=="stroke"||O!=="none"){if(A==="strokeUniform")return O==="non-scaling-stroke";if(A==="strokeDashArray")O=O==="none"?null:O.replace(/,/g," ").split(/\s+/).map(parseFloat);else if(A==="transformMatrix")O=B&&B.transformMatrix?s(B.transformMatrix,i.parseTransformAttribute(O)):i.parseTransformAttribute(O);else if(A==="visible")O=O!=="none"&&O!=="hidden",B&&B.visible===!1&&(O=!1);else if(A==="opacity")O=parseFloat(O),B&&B.opacity!==void 0&&(O*=B.opacity);else if(A==="textAnchor")O=O==="start"?"left":O==="end"?"right":"center";else if(A==="charSpacing")H=t(O,W)/W*1e3;else if(A==="paintFirst"){var D=O.indexOf("fill"),j=O.indexOf("stroke");O="fill",(D>-1&&j>-1&&j<D||D===-1&&j>-1)&&(O="stroke")}else{if(A==="href"||A==="xlink:href"||A==="font")return O;if(A==="imageSmoothing")return O==="optimizeQuality";H=R?O.map(t):t(O,W)}}else O="";return!R&&isNaN(H)?O:H}function b(A){return new RegExp("^("+A.join("|")+")\\b","i")}function y(A,O){var B,W,H,R,D=[];for(H=0,R=O.length;H<R;H++)B=O[H],W=A.getElementsByTagName(B),D=D.concat(Array.prototype.slice.call(W));return D}function w(A,O){var B,W=!0;return(B=T(A,O.pop()))&&O.length&&(W=function(H,R){for(var D,j=!0;H.parentNode&&H.parentNode.nodeType===1&&R.length;)j&&(D=R.pop()),j=T(H=H.parentNode,D);return R.length===0}(A,O)),B&&W&&O.length===0}function T(A,O){var B,W,H=A.nodeName,R=A.getAttribute("class"),D=A.getAttribute("id");if(B=new RegExp("^"+H,"i"),O=O.replace(B,""),D&&O.length&&(B=new RegExp("#"+D+"(?![a-zA-Z\\-]+)","i"),O=O.replace(B,"")),R&&O.length)for(W=(R=R.split(" ")).length;W--;)B=new RegExp("\\."+R[W]+"(?![a-zA-Z\\-]+)","i"),O=O.replace(B,"");return O.length===0}function k(A,O){var B;if(A.getElementById&&(B=A.getElementById(O)),B)return B;var W,H,R,D=A.getElementsByTagName("*");for(H=0,R=D.length;H<R;H++)if(O===(W=D[H]).getAttribute("id"))return W}i.svgValidTagNamesRegEx=b(["path","circle","polygon","polyline","ellipse","rect","line","image","text"]),i.svgViewBoxElementsRegEx=b(["symbol","image","marker","pattern","view","svg"]),i.svgInvalidAncestorsRegEx=b(["pattern","defs","symbol","metadata","clipPath","mask","desc"]),i.svgValidParentsRegEx=b(["symbol","g","a","svg","clipPath","defs"]),i.cssRules={},i.gradientDefs={},i.clipPaths={},i.parseTransformAttribute=function(){function A(j,X,U){j[U]=Math.tan(i.util.degreesToRadians(X[0]))}var O=i.iMatrix,B=i.reNum,W=i.commaWsp,H="(?:(?:(matrix)\\s*\\(\\s*("+B+")"+W+"("+B+")"+W+"("+B+")"+W+"("+B+")"+W+"("+B+")"+W+"("+B+")\\s*\\))|(?:(translate)\\s*\\(\\s*("+B+")(?:"+W+"("+B+"))?\\s*\\))|(?:(scale)\\s*\\(\\s*("+B+")(?:"+W+"("+B+"))?\\s*\\))|(?:(rotate)\\s*\\(\\s*("+B+")(?:"+W+"("+B+")"+W+"("+B+"))?\\s*\\))|(?:(skewX)\\s*\\(\\s*("+B+")\\s*\\))|(?:(skewY)\\s*\\(\\s*("+B+")\\s*\\)))",R=new RegExp("^\\s*(?:(?:"+H+"(?:"+W+"*"+H+")*)?)\\s*$"),D=new RegExp(H,"g");return function(j){var X=O.concat(),U=[];if(!j||j&&!R.test(j))return X;j.replace(D,function(ie){var Z=new RegExp(H).exec(ie).filter(function(ee){return!!ee}),Q=Z[1],te=Z.slice(2).map(parseFloat);switch(Q){case"translate":(function(ee,re){ee[4]=re[0],re.length===2&&(ee[5]=re[1])})(X,te);break;case"rotate":te[0]=i.util.degreesToRadians(te[0]),function(ee,re){var ae=i.util.cos(re[0]),ne=i.util.sin(re[0]),ge=0,me=0;re.length===3&&(ge=re[1],me=re[2]),ee[0]=ae,ee[1]=ne,ee[2]=-ne,ee[3]=ae,ee[4]=ge-(ae*ge-ne*me),ee[5]=me-(ne*ge+ae*me)}(X,te);break;case"scale":(function(ee,re){var ae=re[0],ne=re.length===2?re[1]:re[0];ee[0]=ae,ee[3]=ne})(X,te);break;case"skewX":A(X,te,2);break;case"skewY":A(X,te,1);break;case"matrix":X=te}U.push(X.concat()),X=O.concat()});for(var z=U[0];U.length>1;)U.shift(),z=i.util.multiplyTransformMatrices(z,U[0]);return z}}();var P=new RegExp("^\\s*("+i.reNum+"+)\\s*,?\\s*("+i.reNum+"+)\\s*,?\\s*("+i.reNum+"+)\\s*,?\\s*("+i.reNum+"+)\\s*$");function G(A){if(!i.svgViewBoxElementsRegEx.test(A.nodeName))return{};var O,B,W,H,R,D,j=A.getAttribute("viewBox"),X=1,U=1,z=A.getAttribute("width"),ie=A.getAttribute("height"),Z=A.getAttribute("x")||0,Q=A.getAttribute("y")||0,te=A.getAttribute("preserveAspectRatio")||"",ee=!j||!(j=j.match(P)),re=!z||!ie||z==="100%"||ie==="100%",ae=ee&&re,ne={},ge="",me=0,Te=0;if(ne.width=0,ne.height=0,ne.toBeParsed=ae,ee&&(Z||Q)&&A.parentNode&&A.parentNode.nodeName!=="#document"&&(ge=" translate("+t(Z)+" "+t(Q)+") ",R=(A.getAttribute("transform")||"")+ge,A.setAttribute("transform",R),A.removeAttribute("x"),A.removeAttribute("y")),ae)return ne;if(ee)return ne.width=t(z),ne.height=t(ie),ne;if(O=-parseFloat(j[1]),B=-parseFloat(j[2]),W=parseFloat(j[3]),H=parseFloat(j[4]),ne.minX=O,ne.minY=B,ne.viewBoxWidth=W,ne.viewBoxHeight=H,re?(ne.width=W,ne.height=H):(ne.width=t(z),ne.height=t(ie),X=ne.width/W,U=ne.height/H),(te=i.util.parsePreserveAspectRatioAttribute(te)).alignX!=="none"&&(te.meetOrSlice==="meet"&&(U=X=X>U?U:X),te.meetOrSlice==="slice"&&(U=X=X>U?X:U),me=ne.width-W*X,Te=ne.height-H*X,te.alignX==="Mid"&&(me/=2),te.alignY==="Mid"&&(Te/=2),te.alignX==="Min"&&(me=0),te.alignY==="Min"&&(Te=0)),X===1&&U===1&&O===0&&B===0&&Z===0&&Q===0)return ne;if((Z||Q)&&A.parentNode.nodeName!=="#document"&&(ge=" translate("+t(Z)+" "+t(Q)+") "),R=ge+" matrix("+X+" 0 0 "+U+" "+(O*X+me)+" "+(B*U+Te)+") ",A.nodeName==="svg"){for(D=A.ownerDocument.createElementNS(i.svgNS,"g");A.firstChild;)D.appendChild(A.firstChild);A.appendChild(D)}else(D=A).removeAttribute("x"),D.removeAttribute("y"),R=D.getAttribute("transform")+R;return D.setAttribute("transform",R),ne}function V(A,O){var B="xlink:href",W=k(A,O.getAttribute(B).slice(1));if(W&&W.getAttribute(B)&&V(A,W),["gradientTransform","x1","x2","y1","y2","gradientUnits","cx","cy","r","fx","fy"].forEach(function(R){W&&!O.hasAttribute(R)&&W.hasAttribute(R)&&O.setAttribute(R,W.getAttribute(R))}),!O.children.length)for(var H=W.cloneNode(!0);H.firstChild;)O.appendChild(H.firstChild);O.removeAttribute(B)}i.parseSVGDocument=function(A,O,B,W){if(A){(function(Z){for(var Q=y(Z,["use","svg:use"]),te=0;Q.length&&te<Q.length;){var ee=Q[te],re=ee.getAttribute("xlink:href")||ee.getAttribute("href");if(re===null)return;var ae,ne,ge,me,Te=re.slice(1),Ie=ee.getAttribute("x")||0,je=ee.getAttribute("y")||0,ve=k(Z,Te).cloneNode(!0),Oe=(ve.getAttribute("transform")||"")+" translate("+Ie+", "+je+")",Ue=Q.length,Ne=i.svgNS;if(G(ve),/^svg$/i.test(ve.nodeName)){var Le=ve.ownerDocument.createElementNS(Ne,"g");for(ne=0,me=(ge=ve.attributes).length;ne<me;ne++)ae=ge.item(ne),Le.setAttributeNS(Ne,ae.nodeName,ae.nodeValue);for(;ve.firstChild;)Le.appendChild(ve.firstChild);ve=Le}for(ne=0,me=(ge=ee.attributes).length;ne<me;ne++)(ae=ge.item(ne)).nodeName!=="x"&&ae.nodeName!=="y"&&ae.nodeName!=="xlink:href"&&ae.nodeName!=="href"&&(ae.nodeName==="transform"?Oe=ae.nodeValue+" "+Oe:ve.setAttribute(ae.nodeName,ae.nodeValue));ve.setAttribute("transform",Oe),ve.setAttribute("instantiated_by_use","1"),ve.removeAttribute("id"),ee.parentNode.replaceChild(ve,ee),Q.length===Ue&&te++}})(A);var H,R,D=i.Object.__uid++,j=G(A),X=i.util.toArray(A.getElementsByTagName("*"));if(j.crossOrigin=W&&W.crossOrigin,j.svgUid=D,X.length===0&&i.isLikelyNode){var U=[];for(H=0,R=(X=A.selectNodes('//*[name(.)!="svg"]')).length;H<R;H++)U[H]=X[H];X=U}var z=X.filter(function(Z){return G(Z),i.svgValidTagNamesRegEx.test(Z.nodeName.replace("svg:",""))&&!function(Q,te){for(;Q&&(Q=Q.parentNode);)if(Q.nodeName&&te.test(Q.nodeName.replace("svg:",""))&&!Q.getAttribute("instantiated_by_use"))return!0;return!1}(Z,i.svgInvalidAncestorsRegEx)});if(!z||z&&!z.length)O&&O([],{});else{var ie={};X.filter(function(Z){return Z.nodeName.replace("svg:","")==="clipPath"}).forEach(function(Z){var Q=Z.getAttribute("id");ie[Q]=i.util.toArray(Z.getElementsByTagName("*")).filter(function(te){return i.svgValidTagNamesRegEx.test(te.nodeName.replace("svg:",""))})}),i.gradientDefs[D]=i.getGradientDefs(A),i.cssRules[D]=i.getCSSRules(A),i.clipPaths[D]=ie,i.parseElements(z,function(Z,Q){O&&(O(Z,j,Q,X),delete i.gradientDefs[D],delete i.cssRules[D],delete i.clipPaths[D])},a(j),B,W)}}};var N=new RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+i.reNum+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+i.reNum+"))?\\s+(.*)");n(i,{parseFontDeclaration:function(A,O){var B=A.match(N);if(B){var W=B[1],H=B[3],R=B[4],D=B[5],j=B[6];W&&(O.fontStyle=W),H&&(O.fontWeight=isNaN(parseFloat(H))?H:parseFloat(H)),R&&(O.fontSize=t(R)),j&&(O.fontFamily=j),D&&(O.lineHeight=D==="normal"?1:D)}},getGradientDefs:function(A){var O,B=y(A,["linearGradient","radialGradient","svg:linearGradient","svg:radialGradient"]),W=0,H={};for(W=B.length;W--;)(O=B[W]).getAttribute("xlink:href")&&V(A,O),H[O.getAttribute("id")]=O;return H},parseAttributes:function(A,O,B){if(A){var W,H,R,D={};B===void 0&&(B=A.getAttribute("svgUid")),A.parentNode&&i.svgValidParentsRegEx.test(A.parentNode.nodeName)&&(D=i.parseAttributes(A.parentNode,O,B));var j=O.reduce(function(te,ee){return(W=A.getAttribute(ee))&&(te[ee]=W),te},{}),X=n(function(te,ee){var re={};for(var ae in i.cssRules[ee])if(w(te,ae.split(" ")))for(var ne in i.cssRules[ee][ae])re[ne]=i.cssRules[ee][ae][ne];return re}(A,B),i.parseStyleAttribute(A));j=n(j,X),X[d]&&A.setAttribute(d,X[d]),H=R=D.fontSize||i.Text.DEFAULT_SVG_FONT_SIZE,j[l]&&(j[l]=H=t(j[l],R));var U,z,ie={};for(var Z in j)z=m(U=p(Z),j[Z],D,H),ie[U]=z;ie&&ie.font&&i.parseFontDeclaration(ie.font,ie);var Q=n(D,ie);return i.svgValidParentsRegEx.test(A.nodeName)?Q:function(te){for(var ee in h)if(te[h[ee]]!==void 0&&te[ee]!==""){if(te[ee]===void 0){if(!i.Object.prototype[ee])continue;te[ee]=i.Object.prototype[ee]}if(te[ee].indexOf("url(")!==0){var re=new i.Color(te[ee]);te[ee]=re.setAlpha(e(re.getAlpha()*te[h[ee]],2)).toRgba()}}return te}(Q)}},parseElements:function(A,O,B,W,H){new i.ElementsParser(A,O,B,W,H).parse()},parseStyleAttribute:function(A){var O={},B=A.getAttribute("style");return B&&(typeof B=="string"?function(W,H){var R,D;W.replace(/;\s*$/,"").split(";").forEach(function(j){var X=j.split(":");R=X[0].trim().toLowerCase(),D=X[1].trim(),H[R]=D})}(B,O):function(W,H){var R,D;for(var j in W)W[j]!==void 0&&(R=j.toLowerCase(),D=W[j],H[R]=D)}(B,O)),O},parsePointsAttribute:function(A){if(!A)return null;var O,B,W=[];for(O=0,B=(A=(A=A.replace(/,/g," ").trim()).split(/\s+/)).length;O<B;O+=2)W.push({x:parseFloat(A[O]),y:parseFloat(A[O+1])});return W},getCSSRules:function(A){var O,B,W=A.getElementsByTagName("style"),H={};for(O=0,B=W.length;O<B;O++){var R=W[O].textContent;(R=R.replace(/\/\*[\s\S]*?\*\//g,"")).trim()!==""&&R.split("}").filter(function(D){return D.trim()}).forEach(function(D){var j=D.split("{"),X={},U=j[1].trim().split(";").filter(function(Q){return Q.trim()});for(O=0,B=U.length;O<B;O++){var z=U[O].split(":"),ie=z[0].trim(),Z=z[1].trim();X[ie]=Z}(D=j[0].trim()).split(",").forEach(function(Q){(Q=Q.replace(/^svg/i,"").trim())!==""&&(H[Q]?i.util.object.extend(H[Q],X):H[Q]=i.util.object.clone(X))})})}return H},loadSVGFromURL:function(A,O,B,W){A=A.replace(/^\n\s*/,"").trim(),new i.util.request(A,{method:"get",onComplete:function(H){var R=H.responseXML;if(!R||!R.documentElement)return O&&O(null),!1;i.parseSVGDocument(R.documentElement,function(D,j,X,U){O&&O(D,j,X,U)},B,W)}})},loadSVGFromString:function(A,O,B,W){var H=new i.window.DOMParser().parseFromString(A.trim(),"text/xml");i.parseSVGDocument(H.documentElement,function(R,D,j,X){O(R,D,j,X)},B,W)}})}(o),g.ElementsParser=function(r,i,n,a,e,t){this.elements=r,this.callback=i,this.options=n,this.reviver=a,this.svgUid=n&&n.svgUid||0,this.parsingOptions=e,this.regexUrl=/^url\(['"]?#([^'"]+)['"]?\)/g,this.doc=t},(J=g.ElementsParser.prototype).parse=function(){this.instances=new Array(this.elements.length),this.numElements=this.elements.length,this.createObjects()},J.createObjects=function(){var r=this;this.elements.forEach(function(i,n){i.setAttribute("svgUid",r.svgUid),r.createObject(i,n)})},J.findTag=function(r){return g[g.util.string.capitalize(r.tagName.replace("svg:",""))]},J.createObject=function(r,i){var n=this.findTag(r);if(n&&n.fromElement)try{n.fromElement(r,this.createCallback(i,r),this.options)}catch(a){g.log(a)}else this.checkIfDone()},J.createCallback=function(r,i){var n=this;return function(a){var e;n.resolveGradient(a,i,"fill"),n.resolveGradient(a,i,"stroke"),a instanceof g.Image&&a._originalElement&&(e=a.parsePreserveAspectRatioAttribute(i)),a._removeTransformMatrix(e),n.resolveClipPath(a,i),n.reviver&&n.reviver(i,a),n.instances[r]=a,n.checkIfDone()}},J.extractPropertyDefinition=function(r,i,n){var a=r[i],e=this.regexUrl;if(e.test(a)){e.lastIndex=0;var t=e.exec(a)[1];return e.lastIndex=0,g[n][this.svgUid][t]}},J.resolveGradient=function(r,i,n){var a=this.extractPropertyDefinition(r,n,"gradientDefs");if(a){var e=i.getAttribute(n+"-opacity"),t=g.Gradient.fromElement(a,r,e,this.options);r.set(n,t)}},J.createClipPathCallback=function(r,i){return function(n){n._removeTransformMatrix(),n.fillRule=n.clipRule,i.push(n)}},J.resolveClipPath=function(r,i){var n,a,e,t,s=this.extractPropertyDefinition(r,"clipPath","clipPaths");if(s){e=[],a=g.util.invertTransform(r.calcTransformMatrix());for(var c=s[0].parentNode,h=i;h.parentNode&&h.getAttribute("clip-path")!==r.clipPath;)h=h.parentNode;h.parentNode.appendChild(c);for(var l=0;l<s.length;l++)n=s[l],this.findTag(n).fromElement(n,this.createClipPathCallback(r,e),this.options);s=e.length===1?e[0]:new g.Group(e),t=g.util.multiplyTransformMatrices(a,s.calcTransformMatrix()),s.clipPath&&this.resolveClipPath(s,h);var d=g.util.qrDecompose(t);s.flipX=!1,s.flipY=!1,s.set("scaleX",d.scaleX),s.set("scaleY",d.scaleY),s.angle=d.angle,s.skewX=d.skewX,s.skewY=0,s.setPositionByOrigin({x:d.translateX,y:d.translateY},"center","center"),r.clipPath=s}else delete r.clipPath},J.checkIfDone=function(){--this.numElements==0&&(this.instances=this.instances.filter(function(r){return r!=null}),this.callback(this.instances,this.elements))},function(r){var i=r.fabric||(r.fabric={});function n(a,e){this.x=a,this.y=e}i.Point?i.warn("fabric.Point is already defined"):(i.Point=n,n.prototype={type:"point",constructor:n,add:function(a){return new n(this.x+a.x,this.y+a.y)},addEquals:function(a){return this.x+=a.x,this.y+=a.y,this},scalarAdd:function(a){return new n(this.x+a,this.y+a)},scalarAddEquals:function(a){return this.x+=a,this.y+=a,this},subtract:function(a){return new n(this.x-a.x,this.y-a.y)},subtractEquals:function(a){return this.x-=a.x,this.y-=a.y,this},scalarSubtract:function(a){return new n(this.x-a,this.y-a)},scalarSubtractEquals:function(a){return this.x-=a,this.y-=a,this},multiply:function(a){return new n(this.x*a,this.y*a)},multiplyEquals:function(a){return this.x*=a,this.y*=a,this},divide:function(a){return new n(this.x/a,this.y/a)},divideEquals:function(a){return this.x/=a,this.y/=a,this},eq:function(a){return this.x===a.x&&this.y===a.y},lt:function(a){return this.x<a.x&&this.y<a.y},lte:function(a){return this.x<=a.x&&this.y<=a.y},gt:function(a){return this.x>a.x&&this.y>a.y},gte:function(a){return this.x>=a.x&&this.y>=a.y},lerp:function(a,e){return e===void 0&&(e=.5),e=Math.max(Math.min(1,e),0),new n(this.x+(a.x-this.x)*e,this.y+(a.y-this.y)*e)},distanceFrom:function(a){var e=this.x-a.x,t=this.y-a.y;return Math.sqrt(e*e+t*t)},midPointFrom:function(a){return this.lerp(a)},min:function(a){return new n(Math.min(this.x,a.x),Math.min(this.y,a.y))},max:function(a){return new n(Math.max(this.x,a.x),Math.max(this.y,a.y))},toString:function(){return this.x+","+this.y},setXY:function(a,e){return this.x=a,this.y=e,this},setX:function(a){return this.x=a,this},setY:function(a){return this.y=a,this},setFromPoint:function(a){return this.x=a.x,this.y=a.y,this},swap:function(a){var e=this.x,t=this.y;this.x=a.x,this.y=a.y,a.x=e,a.y=t},clone:function(){return new n(this.x,this.y)}})}(o),function(r){var i=r.fabric||(r.fabric={});function n(a){this.status=a,this.points=[]}i.Intersection?i.warn("fabric.Intersection is already defined"):(i.Intersection=n,i.Intersection.prototype={constructor:n,appendPoint:function(a){return this.points.push(a),this},appendPoints:function(a){return this.points=this.points.concat(a),this}},i.Intersection.intersectLineLine=function(a,e,t,s){var c,h=(s.x-t.x)*(a.y-t.y)-(s.y-t.y)*(a.x-t.x),l=(e.x-a.x)*(a.y-t.y)-(e.y-a.y)*(a.x-t.x),d=(s.y-t.y)*(e.x-a.x)-(s.x-t.x)*(e.y-a.y);if(d!==0){var p=h/d,m=l/d;0<=p&&p<=1&&0<=m&&m<=1?(c=new n("Intersection")).appendPoint(new i.Point(a.x+p*(e.x-a.x),a.y+p*(e.y-a.y))):c=new n}else c=new n(h===0||l===0?"Coincident":"Parallel");return c},i.Intersection.intersectLinePolygon=function(a,e,t){var s,c,h,l,d=new n,p=t.length;for(l=0;l<p;l++)s=t[l],c=t[(l+1)%p],h=n.intersectLineLine(a,e,s,c),d.appendPoints(h.points);return d.points.length>0&&(d.status="Intersection"),d},i.Intersection.intersectPolygonPolygon=function(a,e){var t,s=new n,c=a.length;for(t=0;t<c;t++){var h=a[t],l=a[(t+1)%c],d=n.intersectLinePolygon(h,l,e);s.appendPoints(d.points)}return s.points.length>0&&(s.status="Intersection"),s},i.Intersection.intersectPolygonRectangle=function(a,e,t){var s=e.min(t),c=e.max(t),h=new i.Point(c.x,s.y),l=new i.Point(s.x,c.y),d=n.intersectLinePolygon(s,h,a),p=n.intersectLinePolygon(h,c,a),m=n.intersectLinePolygon(c,l,a),b=n.intersectLinePolygon(l,s,a),y=new n;return y.appendPoints(d.points),y.appendPoints(p.points),y.appendPoints(m.points),y.appendPoints(b.points),y.points.length>0&&(y.status="Intersection"),y})}(o),function(r){var i=r.fabric||(r.fabric={});function n(e){e?this._tryParsingColor(e):this.setSource([0,0,0,1])}function a(e,t,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?e+6*(t-e)*s:s<.5?t:s<2/3?e+(t-e)*(2/3-s)*6:e}i.Color?i.warn("fabric.Color is already defined."):(i.Color=n,i.Color.prototype={_tryParsingColor:function(e){var t;e in n.colorNameMap&&(e=n.colorNameMap[e]),e==="transparent"&&(t=[255,255,255,0]),t||(t=n.sourceFromHex(e)),t||(t=n.sourceFromRgb(e)),t||(t=n.sourceFromHsl(e)),t||(t=[0,0,0,1]),t&&this.setSource(t)},_rgbToHsl:function(e,t,s){e/=255,t/=255,s/=255;var c,h,l,d=i.util.array.max([e,t,s]),p=i.util.array.min([e,t,s]);if(l=(d+p)/2,d===p)c=h=0;else{var m=d-p;switch(h=l>.5?m/(2-d-p):m/(d+p),d){case e:c=(t-s)/m+(t<s?6:0);break;case t:c=(s-e)/m+2;break;case s:c=(e-t)/m+4}c/=6}return[Math.round(360*c),Math.round(100*h),Math.round(100*l)]},getSource:function(){return this._source},setSource:function(e){this._source=e},toRgb:function(){var e=this.getSource();return"rgb("+e[0]+","+e[1]+","+e[2]+")"},toRgba:function(){var e=this.getSource();return"rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")"},toHsl:function(){var e=this.getSource(),t=this._rgbToHsl(e[0],e[1],e[2]);return"hsl("+t[0]+","+t[1]+"%,"+t[2]+"%)"},toHsla:function(){var e=this.getSource(),t=this._rgbToHsl(e[0],e[1],e[2]);return"hsla("+t[0]+","+t[1]+"%,"+t[2]+"%,"+e[3]+")"},toHex:function(){var e,t,s,c=this.getSource();return e=(e=c[0].toString(16)).length===1?"0"+e:e,t=(t=c[1].toString(16)).length===1?"0"+t:t,s=(s=c[2].toString(16)).length===1?"0"+s:s,e.toUpperCase()+t.toUpperCase()+s.toUpperCase()},toHexa:function(){var e,t=this.getSource();return e=(e=(e=Math.round(255*t[3])).toString(16)).length===1?"0"+e:e,this.toHex()+e.toUpperCase()},getAlpha:function(){return this.getSource()[3]},setAlpha:function(e){var t=this.getSource();return t[3]=e,this.setSource(t),this},toGrayscale:function(){var e=this.getSource(),t=parseInt((.3*e[0]+.59*e[1]+.11*e[2]).toFixed(0),10),s=e[3];return this.setSource([t,t,t,s]),this},toBlackWhite:function(e){var t=this.getSource(),s=(.3*t[0]+.59*t[1]+.11*t[2]).toFixed(0),c=t[3];return e=e||127,s=Number(s)<Number(e)?0:255,this.setSource([s,s,s,c]),this},overlayWith:function(e){e instanceof n||(e=new n(e));var t,s=[],c=this.getAlpha(),h=this.getSource(),l=e.getSource();for(t=0;t<3;t++)s.push(Math.round(.5*h[t]+.5*l[t]));return s[3]=c,this.setSource(s),this}},i.Color.reRGBa=/^rgba?\(\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*(?:\s*,\s*((?:\d*\.?\d+)?)\s*)?\)$/i,i.Color.reHSLa=/^hsla?\(\s*(\d{1,3})\s*,\s*(\d{1,3}\%)\s*,\s*(\d{1,3}\%)\s*(?:\s*,\s*(\d+(?:\.\d+)?)\s*)?\)$/i,i.Color.reHex=/^#?([0-9a-f]{8}|[0-9a-f]{6}|[0-9a-f]{4}|[0-9a-f]{3})$/i,i.Color.colorNameMap={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"},i.Color.fromRgb=function(e){return n.fromSource(n.sourceFromRgb(e))},i.Color.sourceFromRgb=function(e){var t=e.match(n.reRGBa);if(t){var s=parseInt(t[1],10)/(/%$/.test(t[1])?100:1)*(/%$/.test(t[1])?255:1),c=parseInt(t[2],10)/(/%$/.test(t[2])?100:1)*(/%$/.test(t[2])?255:1),h=parseInt(t[3],10)/(/%$/.test(t[3])?100:1)*(/%$/.test(t[3])?255:1);return[parseInt(s,10),parseInt(c,10),parseInt(h,10),t[4]?parseFloat(t[4]):1]}},i.Color.fromRgba=n.fromRgb,i.Color.fromHsl=function(e){return n.fromSource(n.sourceFromHsl(e))},i.Color.sourceFromHsl=function(e){var t=e.match(n.reHSLa);if(t){var s,c,h,l=(parseFloat(t[1])%360+360)%360/360,d=parseFloat(t[2])/(/%$/.test(t[2])?100:1),p=parseFloat(t[3])/(/%$/.test(t[3])?100:1);if(d===0)s=c=h=p;else{var m=p<=.5?p*(d+1):p+d-p*d,b=2*p-m;s=a(b,m,l+1/3),c=a(b,m,l),h=a(b,m,l-1/3)}return[Math.round(255*s),Math.round(255*c),Math.round(255*h),t[4]?parseFloat(t[4]):1]}},i.Color.fromHsla=n.fromHsl,i.Color.fromHex=function(e){return n.fromSource(n.sourceFromHex(e))},i.Color.sourceFromHex=function(e){if(e.match(n.reHex)){var t=e.slice(e.indexOf("#")+1),s=t.length===3||t.length===4,c=t.length===8||t.length===4,h=s?t.charAt(0)+t.charAt(0):t.substring(0,2),l=s?t.charAt(1)+t.charAt(1):t.substring(2,4),d=s?t.charAt(2)+t.charAt(2):t.substring(4,6),p=c?s?t.charAt(3)+t.charAt(3):t.substring(6,8):"FF";return[parseInt(h,16),parseInt(l,16),parseInt(d,16),parseFloat((parseInt(p,16)/255).toFixed(2))]}},i.Color.fromSource=function(e){var t=new n;return t.setSource(e),t})}(o),function(r){var i=r.fabric||(r.fabric={}),n=["e","se","s","sw","w","nw","n","ne","e"],a=["ns","nesw","ew","nwse"],e={},t="left",s="top",c="right",h="bottom",l="center",d={top:h,bottom:s,left:c,right:t,center:l},p=i.util.radiansToDegrees,m=Math.sign||function(R){return(R>0)-(R<0)||+R};function b(R,D){var j=R.angle+p(Math.atan2(D.y,D.x))+360;return Math.round(j%360/45)}function y(R,D){var j=D.transform.target,X=j.canvas,U=i.util.object.clone(D);U.target=j,X&&X.fire("object:"+R,U),j.fire(R,D)}function w(R,D){var j=D.canvas,X=R[j.uniScaleKey];return j.uniformScaling&&!X||!j.uniformScaling&&X}function T(R){return R.originX===l&&R.originY===l}function k(R,D,j){var X=R.lockScalingX,U=R.lockScalingY;return!((!X||!U)&&(D||!X&&!U||!j)&&(!X||D!=="x")&&(!U||D!=="y"))}function P(R,D,j,X){return{e:R,transform:D,pointer:{x:j,y:X}}}function G(R){return function(D,j,X,U){var z=j.target,ie=z.getCenterPoint(),Z=z.translateToOriginPoint(ie,j.originX,j.originY),Q=R(D,j,X,U);return z.setPositionByOrigin(Z,j.originX,j.originY),Q}}function V(R,D){return function(j,X,U,z){var ie=D(j,X,U,z);return ie&&y(R,P(j,X,U,z)),ie}}function N(R,D,j,X,U){var z=R.target,ie=z.controls[R.corner],Z=z.canvas.getZoom(),Q=z.padding/Z,te=z.toLocalPoint(new i.Point(X,U),D,j);return te.x>=Q&&(te.x-=Q),te.x<=-Q&&(te.x+=Q),te.y>=Q&&(te.y-=Q),te.y<=Q&&(te.y+=Q),te.x-=ie.offsetX,te.y-=ie.offsetY,te}function A(R){return R.flipX!==R.flipY}function O(R,D,j,X,U){if(R[D]!==0){var z=U/R._getTransformedDimensions()[X]*R[j];R.set(j,z)}}function B(R,D,j,X){var U,z=D.target,ie=z._getTransformedDimensions(0,z.skewY),Z=N(D,D.originX,D.originY,j,X),Q=Math.abs(2*Z.x)-ie.x,te=z.skewX;Q<2?U=0:(U=p(Math.atan2(Q/z.scaleX,ie.y/z.scaleY)),D.originX===t&&D.originY===h&&(U=-U),D.originX===c&&D.originY===s&&(U=-U),A(z)&&(U=-U));var ee=te!==U;if(ee){var re=z._getTransformedDimensions().y;z.set("skewX",U),O(z,"skewY","scaleY","y",re)}return ee}function W(R,D,j,X){var U,z=D.target,ie=z._getTransformedDimensions(z.skewX,0),Z=N(D,D.originX,D.originY,j,X),Q=Math.abs(2*Z.y)-ie.y,te=z.skewY;Q<2?U=0:(U=p(Math.atan2(Q/z.scaleY,ie.x/z.scaleX)),D.originX===t&&D.originY===h&&(U=-U),D.originX===c&&D.originY===s&&(U=-U),A(z)&&(U=-U));var ee=te!==U;if(ee){var re=z._getTransformedDimensions().x;z.set("skewY",U),O(z,"skewX","scaleX","x",re)}return ee}function H(R,D,j,X,U){U=U||{};var z,ie,Z,Q,te,ee,re=D.target,ae=re.lockScalingX,ne=re.lockScalingY,ge=U.by,me=w(R,re),Te=k(re,ge,me),Ie=D.gestureScale;if(Te)return!1;if(Ie)ie=D.scaleX*Ie,Z=D.scaleY*Ie;else{if(z=N(D,D.originX,D.originY,j,X),te=ge!=="y"?m(z.x):1,ee=ge!=="x"?m(z.y):1,D.signX||(D.signX=te),D.signY||(D.signY=ee),re.lockScalingFlip&&(D.signX!==te||D.signY!==ee))return!1;if(Q=re._getTransformedDimensions(),me&&!ge){var je=Math.abs(z.x)+Math.abs(z.y),ve=D.original,Oe=je/(Math.abs(Q.x*ve.scaleX/re.scaleX)+Math.abs(Q.y*ve.scaleY/re.scaleY));ie=ve.scaleX*Oe,Z=ve.scaleY*Oe}else ie=Math.abs(z.x*re.scaleX/Q.x),Z=Math.abs(z.y*re.scaleY/Q.y);T(D)&&(ie*=2,Z*=2),D.signX!==te&&ge!=="y"&&(D.originX=d[D.originX],ie*=-1,D.signX=te),D.signY!==ee&&ge!=="x"&&(D.originY=d[D.originY],Z*=-1,D.signY=ee)}var Ue=re.scaleX,Ne=re.scaleY;return ge?(ge==="x"&&re.set("scaleX",ie),ge==="y"&&re.set("scaleY",Z)):(!ae&&re.set("scaleX",ie),!ne&&re.set("scaleY",Z)),Ue!==re.scaleX||Ne!==re.scaleY}e.scaleCursorStyleHandler=function(R,D,j){var X=w(R,j),U="";if(D.x!==0&&D.y===0?U="x":D.x===0&&D.y!==0&&(U="y"),k(j,U,X))return"not-allowed";var z=b(j,D);return n[z]+"-resize"},e.skewCursorStyleHandler=function(R,D,j){var X="not-allowed";if(D.x!==0&&j.lockSkewingY||D.y!==0&&j.lockSkewingX)return X;var U=b(j,D)%4;return a[U]+"-resize"},e.scaleSkewCursorStyleHandler=function(R,D,j){return R[j.canvas.altActionKey]?e.skewCursorStyleHandler(R,D,j):e.scaleCursorStyleHandler(R,D,j)},e.rotationWithSnapping=V("rotating",G(function(R,D,j,X){var U=D,z=U.target,ie=z.translateToOriginPoint(z.getCenterPoint(),U.originX,U.originY);if(z.lockRotation)return!1;var Z,Q=Math.atan2(U.ey-ie.y,U.ex-ie.x),te=Math.atan2(X-ie.y,j-ie.x),ee=p(te-Q+U.theta);if(z.snapAngle>0){var re=z.snapAngle,ae=z.snapThreshold||re,ne=Math.ceil(ee/re)*re,ge=Math.floor(ee/re)*re;Math.abs(ee-ge)<ae?ee=ge:Math.abs(ee-ne)<ae&&(ee=ne)}return ee<0&&(ee=360+ee),ee%=360,Z=z.angle!==ee,z.angle=ee,Z})),e.scalingEqually=V("scaling",G(function(R,D,j,X){return H(R,D,j,X)})),e.scalingX=V("scaling",G(function(R,D,j,X){return H(R,D,j,X,{by:"x"})})),e.scalingY=V("scaling",G(function(R,D,j,X){return H(R,D,j,X,{by:"y"})})),e.scalingYOrSkewingX=function(R,D,j,X){return R[D.target.canvas.altActionKey]?e.skewHandlerX(R,D,j,X):e.scalingY(R,D,j,X)},e.scalingXOrSkewingY=function(R,D,j,X){return R[D.target.canvas.altActionKey]?e.skewHandlerY(R,D,j,X):e.scalingX(R,D,j,X)},e.changeWidth=V("resizing",G(function(R,D,j,X){var U=D.target,z=N(D,D.originX,D.originY,j,X),ie=U.strokeWidth/(U.strokeUniform?U.scaleX:1),Z=T(D)?2:1,Q=U.width,te=Math.abs(z.x*Z/U.scaleX)-ie;return U.set("width",Math.max(te,0)),Q!==te})),e.skewHandlerX=function(R,D,j,X){var U,z=D.target,ie=z.skewX,Z=D.originY;return!z.lockSkewingX&&(ie===0?U=N(D,l,l,j,X).x>0?t:c:(ie>0&&(U=Z===s?t:c),ie<0&&(U=Z===s?c:t),A(z)&&(U=U===t?c:t)),D.originX=U,V("skewing",G(B))(R,D,j,X))},e.skewHandlerY=function(R,D,j,X){var U,z=D.target,ie=z.skewY,Z=D.originX;return!z.lockSkewingY&&(ie===0?U=N(D,l,l,j,X).y>0?s:h:(ie>0&&(U=Z===t?s:h),ie<0&&(U=Z===t?h:s),A(z)&&(U=U===s?h:s)),D.originY=U,V("skewing",G(W))(R,D,j,X))},e.dragHandler=function(R,D,j,X){var U=D.target,z=j-D.offsetX,ie=X-D.offsetY,Z=!U.get("lockMovementX")&&U.left!==z,Q=!U.get("lockMovementY")&&U.top!==ie;return Z&&U.set("left",z),Q&&U.set("top",ie),(Z||Q)&&y("moving",P(R,D,j,X)),Z||Q},e.scaleOrSkewActionName=function(R,D,j){var X=R[j.canvas.altActionKey];return D.x===0?X?"skewX":"scaleY":D.y===0?X?"skewY":"scaleX":void 0},e.rotationStyleHandler=function(R,D,j){return j.lockRotation?"not-allowed":D.cursorStyle},e.fireEvent=y,e.wrapWithFixedAnchor=G,e.wrapWithFireEvent=V,e.getLocalPoint=N,i.controlsUtils=e}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.util.degreesToRadians,a=i.controlsUtils;a.renderCircleControl=function(e,t,s,c,h){c=c||{};var l,d=this.sizeX||c.cornerSize||h.cornerSize,p=this.sizeY||c.cornerSize||h.cornerSize,m=c.transparentCorners!==void 0?c.transparentCorners:h.transparentCorners,b=m?"stroke":"fill",y=!m&&(c.cornerStrokeColor||h.cornerStrokeColor),w=t,T=s;e.save(),e.fillStyle=c.cornerColor||h.cornerColor,e.strokeStyle=c.cornerStrokeColor||h.cornerStrokeColor,d>p?(l=d,e.scale(1,p/d),T=s*d/p):p>d?(l=p,e.scale(d/p,1),w=t*p/d):l=d,e.lineWidth=1,e.beginPath(),e.arc(w,T,l/2,0,2*Math.PI,!1),e[b](),y&&e.stroke(),e.restore()},a.renderSquareControl=function(e,t,s,c,h){c=c||{};var l=this.sizeX||c.cornerSize||h.cornerSize,d=this.sizeY||c.cornerSize||h.cornerSize,p=c.transparentCorners!==void 0?c.transparentCorners:h.transparentCorners,m=p?"stroke":"fill",b=!p&&(c.cornerStrokeColor||h.cornerStrokeColor),y=l/2,w=d/2;e.save(),e.fillStyle=c.cornerColor||h.cornerColor,e.strokeStyle=c.cornerStrokeColor||h.cornerStrokeColor,e.lineWidth=1,e.translate(t,s),e.rotate(n(h.angle)),e[m+"Rect"](-y,-w,l,d),b&&e.strokeRect(-y,-w,l,d),e.restore()}}(o),function(r){var i=r.fabric||(r.fabric={});i.Control=function(n){for(var a in n)this[a]=n[a]},i.Control.prototype={visible:!0,actionName:"scale",angle:0,x:0,y:0,offsetX:0,offsetY:0,sizeX:null,sizeY:null,touchSizeX:null,touchSizeY:null,cursorStyle:"crosshair",withConnection:!1,actionHandler:function(){},mouseDownHandler:function(){},mouseUpHandler:function(){},getActionHandler:function(){return this.actionHandler},getMouseDownHandler:function(){return this.mouseDownHandler},getMouseUpHandler:function(){return this.mouseUpHandler},cursorStyleHandler:function(n,a){return a.cursorStyle},getActionName:function(n,a){return a.actionName},getVisibility:function(n,a){var e=n._controlsVisibility;return e&&e[a]!==void 0?e[a]:this.visible},setVisibility:function(n){this.visible=n},positionHandler:function(n,a){return i.util.transformPoint({x:this.x*n.x+this.offsetX,y:this.y*n.y+this.offsetY},a)},calcCornerCoords:function(n,a,e,t,s){var c,h,l,d,p=s?this.touchSizeX:this.sizeX,m=s?this.touchSizeY:this.sizeY;if(p&&m&&p!==m){var b=Math.atan2(m,p),y=Math.sqrt(p*p+m*m)/2,w=b-i.util.degreesToRadians(n),T=Math.PI/2-b-i.util.degreesToRadians(n);c=y*i.util.cos(w),h=y*i.util.sin(w),l=y*i.util.cos(T),d=y*i.util.sin(T)}else y=.7071067812*(p&&m?p:a),w=i.util.degreesToRadians(45-n),c=l=y*i.util.cos(w),h=d=y*i.util.sin(w);return{tl:{x:e-d,y:t-l},tr:{x:e+c,y:t-h},bl:{x:e-c,y:t+h},br:{x:e+d,y:t+l}}},render:function(n,a,e,t,s){((t=t||{}).cornerStyle||s.cornerStyle)==="circle"?i.controlsUtils.renderCircleControl.call(this,n,a,e,t,s):i.controlsUtils.renderSquareControl.call(this,n,a,e,t,s)}}}(o),function(){function r(n,a){var e,t,s,c,h=n.getAttribute("style"),l=n.getAttribute("offset")||0;if(l=(l=parseFloat(l)/(/%$/.test(l)?100:1))<0?0:l>1?1:l,h){var d=h.split(/\s*;\s*/);for(d[d.length-1]===""&&d.pop(),c=d.length;c--;){var p=d[c].split(/\s*:\s*/),m=p[0].trim(),b=p[1].trim();m==="stop-color"?e=b:m==="stop-opacity"&&(s=b)}}return e||(e=n.getAttribute("stop-color")||"rgb(0,0,0)"),s||(s=n.getAttribute("stop-opacity")),t=(e=new g.Color(e)).getAlpha(),s=isNaN(parseFloat(s))?1:parseFloat(s),s*=t*a,{offset:l,color:e.toRgb(),opacity:s}}var i=g.util.object.clone;g.Gradient=g.util.createClass({offsetX:0,offsetY:0,gradientTransform:null,gradientUnits:"pixels",type:"linear",initialize:function(n){n||(n={}),n.coords||(n.coords={});var a,e=this;Object.keys(n).forEach(function(t){e[t]=n[t]}),this.id?this.id+="_"+g.Object.__uid++:this.id=g.Object.__uid++,a={x1:n.coords.x1||0,y1:n.coords.y1||0,x2:n.coords.x2||0,y2:n.coords.y2||0},this.type==="radial"&&(a.r1=n.coords.r1||0,a.r2=n.coords.r2||0),this.coords=a,this.colorStops=n.colorStops.slice()},addColorStop:function(n){for(var a in n){var e=new g.Color(n[a]);this.colorStops.push({offset:parseFloat(a),color:e.toRgb(),opacity:e.getAlpha()})}return this},toObject:function(n){var a={type:this.type,coords:this.coords,colorStops:this.colorStops,offsetX:this.offsetX,offsetY:this.offsetY,gradientUnits:this.gradientUnits,gradientTransform:this.gradientTransform?this.gradientTransform.concat():this.gradientTransform};return g.util.populateWithProperties(this,a,n),a},toSVG:function(n,a){var e,t,s,c,h=i(this.coords,!0),l=(a=a||{},i(this.colorStops,!0)),d=h.r1>h.r2,p=this.gradientTransform?this.gradientTransform.concat():g.iMatrix.concat(),m=-this.offsetX,b=-this.offsetY,y=!!a.additionalTransform,w=this.gradientUnits==="pixels"?"userSpaceOnUse":"objectBoundingBox";if(l.sort(function(G,V){return G.offset-V.offset}),w==="objectBoundingBox"?(m/=n.width,b/=n.height):(m+=n.width/2,b+=n.height/2),n.type==="path"&&this.gradientUnits!=="percentage"&&(m-=n.pathOffset.x,b-=n.pathOffset.y),p[4]-=m,p[5]-=b,c='id="SVGID_'+this.id+'" gradientUnits="'+w+'"',c+=' gradientTransform="'+(y?a.additionalTransform+" ":"")+g.util.matrixToSVG(p)+'" ',this.type==="linear"?s=["<linearGradient ",c,' x1="',h.x1,'" y1="',h.y1,'" x2="',h.x2,'" y2="',h.y2,'">\n']:this.type==="radial"&&(s=["<radialGradient ",c,' cx="',d?h.x1:h.x2,'" cy="',d?h.y1:h.y2,'" r="',d?h.r1:h.r2,'" fx="',d?h.x2:h.x1,'" fy="',d?h.y2:h.y1,'">\n']),this.type==="radial"){if(d)for((l=l.concat()).reverse(),e=0,t=l.length;e<t;e++)l[e].offset=1-l[e].offset;var T=Math.min(h.r1,h.r2);if(T>0){var k=T/Math.max(h.r1,h.r2);for(e=0,t=l.length;e<t;e++)l[e].offset+=k*(1-l[e].offset)}}for(e=0,t=l.length;e<t;e++){var P=l[e];s.push("<stop ",'offset="',100*P.offset+"%",'" style="stop-color:',P.color,P.opacity!==void 0?";stop-opacity: "+P.opacity:";",'"/>\n')}return s.push(this.type==="linear"?"</linearGradient>\n":"</radialGradient>\n"),s.join("")},toLive:function(n){var a,e,t,s=g.util.object.clone(this.coords);if(this.type){for(this.type==="linear"?a=n.createLinearGradient(s.x1,s.y1,s.x2,s.y2):this.type==="radial"&&(a=n.createRadialGradient(s.x1,s.y1,s.r1,s.x2,s.y2,s.r2)),e=0,t=this.colorStops.length;e<t;e++){var c=this.colorStops[e].color,h=this.colorStops[e].opacity,l=this.colorStops[e].offset;h!==void 0&&(c=new g.Color(c).setAlpha(h).toRgba()),a.addColorStop(l,c)}return a}}}),g.util.object.extend(g.Gradient,{fromElement:function(n,a,e,t){var s=parseFloat(e)/(/%$/.test(e)?100:1);s=s<0?0:s>1?1:s,isNaN(s)&&(s=1);var c,h,l,d,p=n.getElementsByTagName("stop"),m=n.getAttribute("gradientUnits")==="userSpaceOnUse"?"pixels":"percentage",b=n.getAttribute("gradientTransform")||"",y=[],w=0,T=0;for(n.nodeName==="linearGradient"||n.nodeName==="LINEARGRADIENT"?(c="linear",h=function(k){return{x1:k.getAttribute("x1")||0,y1:k.getAttribute("y1")||0,x2:k.getAttribute("x2")||"100%",y2:k.getAttribute("y2")||0}}(n)):(c="radial",h=function(k){return{x1:k.getAttribute("fx")||k.getAttribute("cx")||"50%",y1:k.getAttribute("fy")||k.getAttribute("cy")||"50%",r1:0,x2:k.getAttribute("cx")||"50%",y2:k.getAttribute("cy")||"50%",r2:k.getAttribute("r")||"50%"}}(n)),l=p.length;l--;)y.push(r(p[l],s));return d=g.parseTransformAttribute(b),function(k,P,G,V){var N,A;Object.keys(P).forEach(function(O){(N=P[O])==="Infinity"?A=1:N==="-Infinity"?A=0:(A=parseFloat(P[O],10),typeof N=="string"&&/^(\d+\.\d+)%|(\d+)%$/.test(N)&&(A*=.01,V==="pixels"&&(O!=="x1"&&O!=="x2"&&O!=="r2"||(A*=G.viewBoxWidth||G.width),O!=="y1"&&O!=="y2"||(A*=G.viewBoxHeight||G.height)))),P[O]=A})}(0,h,t,m),m==="pixels"&&(w=-a.left,T=-a.top),new g.Gradient({id:n.getAttribute("id"),type:c,coords:h,colorStops:y,gradientUnits:m,gradientTransform:d,offsetX:w,offsetY:T})}})}(),le=g.util.toFixed,g.Pattern=g.util.createClass({repeat:"repeat",offsetX:0,offsetY:0,crossOrigin:"",patternTransform:null,initialize:function(r,i){if(r||(r={}),this.id=g.Object.__uid++,this.setOptions(r),!r.source||r.source&&typeof r.source!="string")i&&i(this);else{var n=this;this.source=g.util.createImage(),g.util.loadImage(r.source,function(a,e){n.source=a,i&&i(n,e)},null,this.crossOrigin)}},toObject:function(r){var i,n,a=g.Object.NUM_FRACTION_DIGITS;return typeof this.source.src=="string"?i=this.source.src:typeof this.source=="object"&&this.source.toDataURL&&(i=this.source.toDataURL()),n={type:"pattern",source:i,repeat:this.repeat,crossOrigin:this.crossOrigin,offsetX:le(this.offsetX,a),offsetY:le(this.offsetY,a),patternTransform:this.patternTransform?this.patternTransform.concat():null},g.util.populateWithProperties(this,n,r),n},toSVG:function(r){var i=typeof this.source=="function"?this.source():this.source,n=i.width/r.width,a=i.height/r.height,e=this.offsetX/r.width,t=this.offsetY/r.height,s="";return this.repeat!=="repeat-x"&&this.repeat!=="no-repeat"||(a=1,t&&(a+=Math.abs(t))),this.repeat!=="repeat-y"&&this.repeat!=="no-repeat"||(n=1,e&&(n+=Math.abs(e))),i.src?s=i.src:i.toDataURL&&(s=i.toDataURL()),'<pattern id="SVGID_'+this.id+'" x="'+e+'" y="'+t+'" width="'+n+'" height="'+a+'">\n<image x="0" y="0" width="'+i.width+'" height="'+i.height+'" xlink:href="'+s+'"></image>\n</pattern>\n'},setOptions:function(r){for(var i in r)this[i]=r[i]},toLive:function(r){var i=this.source;return!i||i.src!==void 0&&(!i.complete||i.naturalWidth===0||i.naturalHeight===0)?"":r.createPattern(i,this.repeat)}}),function(r){var i=r.fabric||(r.fabric={}),n=i.util.toFixed;i.Shadow?i.warn("fabric.Shadow is already defined."):(i.Shadow=i.util.createClass({color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,nonScaling:!1,initialize:function(a){for(var e in typeof a=="string"&&(a=this._parseShadow(a)),a)this[e]=a[e];this.id=i.Object.__uid++},_parseShadow:function(a){var e=a.trim(),t=i.Shadow.reOffsetsAndBlur.exec(e)||[];return{color:(e.replace(i.Shadow.reOffsetsAndBlur,"")||"rgb(0,0,0)").trim(),offsetX:parseFloat(t[1],10)||0,offsetY:parseFloat(t[2],10)||0,blur:parseFloat(t[3],10)||0}},toString:function(){return[this.offsetX,this.offsetY,this.blur,this.color].join("px ")},toSVG:function(a){var e=40,t=40,s=i.Object.NUM_FRACTION_DIGITS,c=i.util.rotateVector({x:this.offsetX,y:this.offsetY},i.util.degreesToRadians(-a.angle)),h=new i.Color(this.color);return a.width&&a.height&&(e=100*n((Math.abs(c.x)+this.blur)/a.width,s)+20,t=100*n((Math.abs(c.y)+this.blur)/a.height,s)+20),a.flipX&&(c.x*=-1),a.flipY&&(c.y*=-1),'<filter id="SVGID_'+this.id+'" y="-'+t+'%" height="'+(100+2*t)+'%" x="-'+e+'%" width="'+(100+2*e)+'%" >\n	<feGaussianBlur in="SourceAlpha" stdDeviation="'+n(this.blur?this.blur/2:0,s)+'"></feGaussianBlur>\n	<feOffset dx="'+n(c.x,s)+'" dy="'+n(c.y,s)+'" result="oBlur" ></feOffset>\n	<feFlood flood-color="'+h.toRgb()+'" flood-opacity="'+h.getAlpha()+'"/>\n	<feComposite in2="oBlur" operator="in" />\n	<feMerge>\n		<feMergeNode></feMergeNode>\n		<feMergeNode in="SourceGraphic"></feMergeNode>\n	</feMerge>\n</filter>\n'},toObject:function(){if(this.includeDefaultValues)return{color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY,affectStroke:this.affectStroke,nonScaling:this.nonScaling};var a={},e=i.Shadow.prototype;return["color","blur","offsetX","offsetY","affectStroke","nonScaling"].forEach(function(t){this[t]!==e[t]&&(a[t]=this[t])},this),a}}),i.Shadow.reOffsetsAndBlur=/(?:\s|^)(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(\d+(?:\.\d*)?(?:px)?)?(?:\s?|$)(?:$|\s)/)}(o),function(){if(g.StaticCanvas)g.warn("fabric.StaticCanvas is already defined.");else{var r=g.util.object.extend,i=g.util.getElementOffset,n=g.util.removeFromArray,a=g.util.toFixed,e=g.util.transformPoint,t=g.util.invertTransform,s=g.util.getNodeCanvas,c=g.util.createCanvasElement,h=new Error("Could not initialize `canvas` element");g.StaticCanvas=g.util.createClass(g.CommonMethods,{initialize:function(l,d){d||(d={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(l,d)},backgroundColor:"",backgroundImage:null,overlayColor:"",overlayImage:null,includeDefaultValues:!0,stateful:!1,renderOnAddRemove:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,imageSmoothingEnabled:!0,viewportTransform:g.iMatrix.concat(),backgroundVpt:!0,overlayVpt:!0,enableRetinaScaling:!0,vptCoords:{},skipOffscreen:!0,clipPath:void 0,_initStatic:function(l,d){var p=this.requestRenderAllBound;this._objects=[],this._createLowerCanvas(l),this._initOptions(d),this.interactive||this._initRetinaScaling(),d.overlayImage&&this.setOverlayImage(d.overlayImage,p),d.backgroundImage&&this.setBackgroundImage(d.backgroundImage,p),d.backgroundColor&&this.setBackgroundColor(d.backgroundColor,p),d.overlayColor&&this.setOverlayColor(d.overlayColor,p),this.calcOffset()},_isRetinaScaling:function(){return g.devicePixelRatio>1&&this.enableRetinaScaling},getRetinaScaling:function(){return this._isRetinaScaling()?Math.max(1,g.devicePixelRatio):1},_initRetinaScaling:function(){if(this._isRetinaScaling()){var l=g.devicePixelRatio;this.__initRetinaScaling(l,this.lowerCanvasEl,this.contextContainer),this.upperCanvasEl&&this.__initRetinaScaling(l,this.upperCanvasEl,this.contextTop)}},__initRetinaScaling:function(l,d,p){d.setAttribute("width",this.width*l),d.setAttribute("height",this.height*l),p.scale(l,l)},calcOffset:function(){return this._offset=i(this.lowerCanvasEl),this},setOverlayImage:function(l,d,p){return this.__setBgOverlayImage("overlayImage",l,d,p)},setBackgroundImage:function(l,d,p){return this.__setBgOverlayImage("backgroundImage",l,d,p)},setOverlayColor:function(l,d){return this.__setBgOverlayColor("overlayColor",l,d)},setBackgroundColor:function(l,d){return this.__setBgOverlayColor("backgroundColor",l,d)},__setBgOverlayImage:function(l,d,p,m){return typeof d=="string"?g.util.loadImage(d,function(b,y){if(b){var w=new g.Image(b,m);this[l]=w,w.canvas=this}p&&p(b,y)},this,m&&m.crossOrigin):(m&&d.setOptions(m),this[l]=d,d&&(d.canvas=this),p&&p(d,!1)),this},__setBgOverlayColor:function(l,d,p){return this[l]=d,this._initGradient(d,l),this._initPattern(d,l,p),this},_createCanvasElement:function(){var l=c();if(!l||(l.style||(l.style={}),l.getContext===void 0))throw h;return l},_initOptions:function(l){var d=this.lowerCanvasEl;this._setOptions(l),this.width=this.width||parseInt(d.width,10)||0,this.height=this.height||parseInt(d.height,10)||0,this.lowerCanvasEl.style&&(d.width=this.width,d.height=this.height,d.style.width=this.width+"px",d.style.height=this.height+"px",this.viewportTransform=this.viewportTransform.slice())},_createLowerCanvas:function(l){l&&l.getContext?this.lowerCanvasEl=l:this.lowerCanvasEl=g.util.getById(l)||this._createCanvasElement(),g.util.addClass(this.lowerCanvasEl,"lower-canvas"),this._originalCanvasStyle=this.lowerCanvasEl.style,this.interactive&&this._applyCanvasStyle(this.lowerCanvasEl),this.contextContainer=this.lowerCanvasEl.getContext("2d")},getWidth:function(){return this.width},getHeight:function(){return this.height},setWidth:function(l,d){return this.setDimensions({width:l},d)},setHeight:function(l,d){return this.setDimensions({height:l},d)},setDimensions:function(l,d){var p;for(var m in d=d||{},l)p=l[m],d.cssOnly||(this._setBackstoreDimension(m,l[m]),p+="px",this.hasLostContext=!0),d.backstoreOnly||this._setCssDimension(m,p);return this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(this.contextTop),this._initRetinaScaling(),this.calcOffset(),d.cssOnly||this.requestRenderAll(),this},_setBackstoreDimension:function(l,d){return this.lowerCanvasEl[l]=d,this.upperCanvasEl&&(this.upperCanvasEl[l]=d),this.cacheCanvasEl&&(this.cacheCanvasEl[l]=d),this[l]=d,this},_setCssDimension:function(l,d){return this.lowerCanvasEl.style[l]=d,this.upperCanvasEl&&(this.upperCanvasEl.style[l]=d),this.wrapperEl&&(this.wrapperEl.style[l]=d),this},getZoom:function(){return this.viewportTransform[0]},setViewportTransform:function(l){var d,p,m,b=this._activeObject,y=this.backgroundImage,w=this.overlayImage;for(this.viewportTransform=l,p=0,m=this._objects.length;p<m;p++)(d=this._objects[p]).group||d.setCoords(!0);return b&&b.setCoords(),y&&y.setCoords(!0),w&&w.setCoords(!0),this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll(),this},zoomToPoint:function(l,d){var p=l,m=this.viewportTransform.slice(0);l=e(l,t(this.viewportTransform)),m[0]=d,m[3]=d;var b=e(l,m);return m[4]+=p.x-b.x,m[5]+=p.y-b.y,this.setViewportTransform(m)},setZoom:function(l){return this.zoomToPoint(new g.Point(0,0),l),this},absolutePan:function(l){var d=this.viewportTransform.slice(0);return d[4]=-l.x,d[5]=-l.y,this.setViewportTransform(d)},relativePan:function(l){return this.absolutePan(new g.Point(-l.x-this.viewportTransform[4],-l.y-this.viewportTransform[5]))},getElement:function(){return this.lowerCanvasEl},_onObjectAdded:function(l){this.stateful&&l.setupState(),l._set("canvas",this),l.setCoords(),this.fire("object:added",{target:l}),l.fire("added")},_onObjectRemoved:function(l){this.fire("object:removed",{target:l}),l.fire("removed"),delete l.canvas},clearContext:function(l){return l.clearRect(0,0,this.width,this.height),this},getContext:function(){return this.contextContainer},clear:function(){return this.remove.apply(this,this.getObjects()),this.backgroundImage=null,this.overlayImage=null,this.backgroundColor="",this.overlayColor="",this._hasITextHandlers&&(this.off("mouse:up",this._mouseUpITextHandler),this._iTextInstances=null,this._hasITextHandlers=!1),this.clearContext(this.contextContainer),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll(),this},renderAll:function(){var l=this.contextContainer;return this.renderCanvas(l,this._objects),this},renderAndReset:function(){this.isRendering=0,this.renderAll()},requestRenderAll:function(){return this.isRendering||(this.isRendering=g.util.requestAnimFrame(this.renderAndResetBound)),this},calcViewportBoundaries:function(){var l={},d=this.width,p=this.height,m=t(this.viewportTransform);return l.tl=e({x:0,y:0},m),l.br=e({x:d,y:p},m),l.tr=new g.Point(l.br.x,l.tl.y),l.bl=new g.Point(l.tl.x,l.br.y),this.vptCoords=l,l},cancelRequestedRender:function(){this.isRendering&&(g.util.cancelAnimFrame(this.isRendering),this.isRendering=0)},renderCanvas:function(l,d){var p=this.viewportTransform,m=this.clipPath;this.cancelRequestedRender(),this.calcViewportBoundaries(),this.clearContext(l),g.util.setImageSmoothing(l,this.imageSmoothingEnabled),this.fire("before:render",{ctx:l}),this._renderBackground(l),l.save(),l.transform(p[0],p[1],p[2],p[3],p[4],p[5]),this._renderObjects(l,d),l.restore(),!this.controlsAboveOverlay&&this.interactive&&this.drawControls(l),m&&(m.canvas=this,m.shouldCache(),m._transformDone=!0,m.renderCache({forClipping:!0}),this.drawClipPathOnCanvas(l)),this._renderOverlay(l),this.controlsAboveOverlay&&this.interactive&&this.drawControls(l),this.fire("after:render",{ctx:l})},drawClipPathOnCanvas:function(l){var d=this.viewportTransform,p=this.clipPath;l.save(),l.transform(d[0],d[1],d[2],d[3],d[4],d[5]),l.globalCompositeOperation="destination-in",p.transform(l),l.scale(1/p.zoomX,1/p.zoomY),l.drawImage(p._cacheCanvas,-p.cacheTranslationX,-p.cacheTranslationY),l.restore()},_renderObjects:function(l,d){var p,m;for(p=0,m=d.length;p<m;++p)d[p]&&d[p].render(l)},_renderBackgroundOrOverlay:function(l,d){var p=this[d+"Color"],m=this[d+"Image"],b=this.viewportTransform,y=this[d+"Vpt"];if(p||m){if(p){l.save(),l.beginPath(),l.moveTo(0,0),l.lineTo(this.width,0),l.lineTo(this.width,this.height),l.lineTo(0,this.height),l.closePath(),l.fillStyle=p.toLive?p.toLive(l,this):p,y&&l.transform(b[0],b[1],b[2],b[3],b[4],b[5]),l.transform(1,0,0,1,p.offsetX||0,p.offsetY||0);var w=p.gradientTransform||p.patternTransform;w&&l.transform(w[0],w[1],w[2],w[3],w[4],w[5]),l.fill(),l.restore()}m&&(l.save(),y&&l.transform(b[0],b[1],b[2],b[3],b[4],b[5]),m.render(l),l.restore())}},_renderBackground:function(l){this._renderBackgroundOrOverlay(l,"background")},_renderOverlay:function(l){this._renderBackgroundOrOverlay(l,"overlay")},getCenter:function(){return{top:this.height/2,left:this.width/2}},getCenterPoint:function(){return new g.Point(this.width/2,this.height/2)},centerObjectH:function(l){return this._centerObject(l,new g.Point(this.getCenterPoint().x,l.getCenterPoint().y))},centerObjectV:function(l){return this._centerObject(l,new g.Point(l.getCenterPoint().x,this.getCenterPoint().y))},centerObject:function(l){var d=this.getCenterPoint();return this._centerObject(l,d)},viewportCenterObject:function(l){var d=this.getVpCenter();return this._centerObject(l,d)},viewportCenterObjectH:function(l){var d=this.getVpCenter();return this._centerObject(l,new g.Point(d.x,l.getCenterPoint().y)),this},viewportCenterObjectV:function(l){var d=this.getVpCenter();return this._centerObject(l,new g.Point(l.getCenterPoint().x,d.y))},getVpCenter:function(){var l=this.getCenterPoint(),d=t(this.viewportTransform);return e(l,d)},_centerObject:function(l,d){return l.setPositionByOrigin(d,"center","center"),l.setCoords(),this.renderOnAddRemove&&this.requestRenderAll(),this},toDatalessJSON:function(l){return this.toDatalessObject(l)},toObject:function(l){return this._toObjectMethod("toObject",l)},toDatalessObject:function(l){return this._toObjectMethod("toDatalessObject",l)},_toObjectMethod:function(l,d){var p=this.clipPath,m={version:g.version,objects:this._toObjects(l,d)};return p&&!p.excludeFromExport&&(m.clipPath=this._toObject(this.clipPath,l,d)),r(m,this.__serializeBgOverlay(l,d)),g.util.populateWithProperties(this,m,d),m},_toObjects:function(l,d){return this._objects.filter(function(p){return!p.excludeFromExport}).map(function(p){return this._toObject(p,l,d)},this)},_toObject:function(l,d,p){var m;this.includeDefaultValues||(m=l.includeDefaultValues,l.includeDefaultValues=!1);var b=l[d](p);return this.includeDefaultValues||(l.includeDefaultValues=m),b},__serializeBgOverlay:function(l,d){var p={},m=this.backgroundImage,b=this.overlayImage,y=this.backgroundColor,w=this.overlayColor;return y&&y.toObject?y.excludeFromExport||(p.background=y.toObject(d)):y&&(p.background=y),w&&w.toObject?w.excludeFromExport||(p.overlay=w.toObject(d)):w&&(p.overlay=w),m&&!m.excludeFromExport&&(p.backgroundImage=this._toObject(m,l,d)),b&&!b.excludeFromExport&&(p.overlayImage=this._toObject(b,l,d)),p},svgViewportTransformation:!0,toSVG:function(l,d){l||(l={}),l.reviver=d;var p=[];return this._setSVGPreamble(p,l),this._setSVGHeader(p,l),this.clipPath&&p.push('<g clip-path="url(#'+this.clipPath.clipPathId+')" >\n'),this._setSVGBgOverlayColor(p,"background"),this._setSVGBgOverlayImage(p,"backgroundImage",d),this._setSVGObjects(p,d),this.clipPath&&p.push("</g>\n"),this._setSVGBgOverlayColor(p,"overlay"),this._setSVGBgOverlayImage(p,"overlayImage",d),p.push("</svg>"),p.join("")},_setSVGPreamble:function(l,d){d.suppressPreamble||l.push('<?xml version="1.0" encoding="',d.encoding||"UTF-8",'" standalone="no" ?>\n','<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" ','"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n')},_setSVGHeader:function(l,d){var p,m=d.width||this.width,b=d.height||this.height,y='viewBox="0 0 '+this.width+" "+this.height+'" ',w=g.Object.NUM_FRACTION_DIGITS;d.viewBox?y='viewBox="'+d.viewBox.x+" "+d.viewBox.y+" "+d.viewBox.width+" "+d.viewBox.height+'" ':this.svgViewportTransformation&&(p=this.viewportTransform,y='viewBox="'+a(-p[4]/p[0],w)+" "+a(-p[5]/p[3],w)+" "+a(this.width/p[0],w)+" "+a(this.height/p[3],w)+'" '),l.push("<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',m,'" ','height="',b,'" ',y,'xml:space="preserve">\n',"<desc>Created with Fabric.js ",g.version,"</desc>\n","<defs>\n",this.createSVGFontFacesMarkup(),this.createSVGRefElementsMarkup(),this.createSVGClipPathMarkup(d),"</defs>\n")},createSVGClipPathMarkup:function(l){var d=this.clipPath;return d?(d.clipPathId="CLIPPATH_"+g.Object.__uid++,'<clipPath id="'+d.clipPathId+'" >\n'+this.clipPath.toClipPathSVG(l.reviver)+"</clipPath>\n"):""},createSVGRefElementsMarkup:function(){var l=this;return["background","overlay"].map(function(d){var p=l[d+"Color"];if(p&&p.toLive){var m=l[d+"Vpt"],b=l.viewportTransform,y={width:l.width/(m?b[0]:1),height:l.height/(m?b[3]:1)};return p.toSVG(y,{additionalTransform:m?g.util.matrixToSVG(b):""})}}).join("")},createSVGFontFacesMarkup:function(){var l,d,p,m,b,y,w,T,k="",P={},G=g.fontPaths,V=[];for(this._objects.forEach(function A(O){V.push(O),O._objects&&O._objects.forEach(A)}),w=0,T=V.length;w<T;w++)if(d=(l=V[w]).fontFamily,l.type.indexOf("text")!==-1&&!P[d]&&G[d]&&(P[d]=!0,l.styles))for(b in p=l.styles)for(y in m=p[b])!P[d=m[y].fontFamily]&&G[d]&&(P[d]=!0);for(var N in P)k+=["		@font-face {\n","			font-family: '",N,"';\n","			src: url('",G[N],"');\n","		}\n"].join("");return k&&(k=['	<style type="text/css">',"<![CDATA[\n",k,"]]>","</style>\n"].join("")),k},_setSVGObjects:function(l,d){var p,m,b,y=this._objects;for(m=0,b=y.length;m<b;m++)(p=y[m]).excludeFromExport||this._setSVGObject(l,p,d)},_setSVGObject:function(l,d,p){l.push(d.toSVG(p))},_setSVGBgOverlayImage:function(l,d,p){this[d]&&!this[d].excludeFromExport&&this[d].toSVG&&l.push(this[d].toSVG(p))},_setSVGBgOverlayColor:function(l,d){var p=this[d+"Color"],m=this.viewportTransform,b=this.width,y=this.height;if(p)if(p.toLive){var w=p.repeat,T=g.util.invertTransform(m),k=this[d+"Vpt"]?g.util.matrixToSVG(T):"";l.push('<rect transform="'+k+" translate(",b/2,",",y/2,')"',' x="',p.offsetX-b/2,'" y="',p.offsetY-y/2,'" ','width="',w==="repeat-y"||w==="no-repeat"?p.source.width:b,'" height="',w==="repeat-x"||w==="no-repeat"?p.source.height:y,'" fill="url(#SVGID_'+p.id+')"',"></rect>\n")}else l.push('<rect x="0" y="0" width="100%" height="100%" ','fill="',p,'"',"></rect>\n")},sendToBack:function(l){if(!l)return this;var d,p,m,b=this._activeObject;if(l===b&&l.type==="activeSelection")for(d=(m=b._objects).length;d--;)p=m[d],n(this._objects,p),this._objects.unshift(p);else n(this._objects,l),this._objects.unshift(l);return this.renderOnAddRemove&&this.requestRenderAll(),this},bringToFront:function(l){if(!l)return this;var d,p,m,b=this._activeObject;if(l===b&&l.type==="activeSelection")for(m=b._objects,d=0;d<m.length;d++)p=m[d],n(this._objects,p),this._objects.push(p);else n(this._objects,l),this._objects.push(l);return this.renderOnAddRemove&&this.requestRenderAll(),this},sendBackwards:function(l,d){if(!l)return this;var p,m,b,y,w,T=this._activeObject,k=0;if(l===T&&l.type==="activeSelection")for(w=T._objects,p=0;p<w.length;p++)m=w[p],(b=this._objects.indexOf(m))>0+k&&(y=b-1,n(this._objects,m),this._objects.splice(y,0,m)),k++;else(b=this._objects.indexOf(l))!==0&&(y=this._findNewLowerIndex(l,b,d),n(this._objects,l),this._objects.splice(y,0,l));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewLowerIndex:function(l,d,p){var m,b;if(p){for(m=d,b=d-1;b>=0;--b)if(l.intersectsWithObject(this._objects[b])||l.isContainedWithinObject(this._objects[b])||this._objects[b].isContainedWithinObject(l)){m=b;break}}else m=d-1;return m},bringForward:function(l,d){if(!l)return this;var p,m,b,y,w,T=this._activeObject,k=0;if(l===T&&l.type==="activeSelection")for(p=(w=T._objects).length;p--;)m=w[p],(b=this._objects.indexOf(m))<this._objects.length-1-k&&(y=b+1,n(this._objects,m),this._objects.splice(y,0,m)),k++;else(b=this._objects.indexOf(l))!==this._objects.length-1&&(y=this._findNewUpperIndex(l,b,d),n(this._objects,l),this._objects.splice(y,0,l));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewUpperIndex:function(l,d,p){var m,b,y;if(p){for(m=d,b=d+1,y=this._objects.length;b<y;++b)if(l.intersectsWithObject(this._objects[b])||l.isContainedWithinObject(this._objects[b])||this._objects[b].isContainedWithinObject(l)){m=b;break}}else m=d+1;return m},moveTo:function(l,d){return n(this._objects,l),this._objects.splice(d,0,l),this.renderOnAddRemove&&this.requestRenderAll()},dispose:function(){return this.isRendering&&(g.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(l){l.dispose&&l.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),g.util.setStyle(this.lowerCanvasEl,this._originalCanvasStyle),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),g.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},toString:function(){return"#<fabric.Canvas ("+this.complexity()+"): { objects: "+this._objects.length+" }>"}}),r(g.StaticCanvas.prototype,g.Observable),r(g.StaticCanvas.prototype,g.Collection),r(g.StaticCanvas.prototype,g.DataURLExporter),r(g.StaticCanvas,{EMPTY_JSON:'{"objects": [], "background": "white"}',supports:function(l){var d=c();if(!d||!d.getContext)return null;var p=d.getContext("2d");return p&&l==="setLineDash"?p.setLineDash!==void 0:null}}),g.StaticCanvas.prototype.toJSON=g.StaticCanvas.prototype.toObject,g.isLikelyNode&&(g.StaticCanvas.prototype.createPNGStream=function(){var l=s(this.lowerCanvasEl);return l&&l.createPNGStream()},g.StaticCanvas.prototype.createJPEGStream=function(l){var d=s(this.lowerCanvasEl);return d&&d.createJPEGStream(l)})}}(),g.BaseBrush=g.util.createClass({color:"rgb(0, 0, 0)",width:1,shadow:null,strokeLineCap:"round",strokeLineJoin:"round",strokeMiterLimit:10,strokeDashArray:null,limitedToCanvasSize:!1,_setBrushStyles:function(r){r.strokeStyle=this.color,r.lineWidth=this.width,r.lineCap=this.strokeLineCap,r.miterLimit=this.strokeMiterLimit,r.lineJoin=this.strokeLineJoin,r.setLineDash(this.strokeDashArray||[])},_saveAndTransform:function(r){var i=this.canvas.viewportTransform;r.save(),r.transform(i[0],i[1],i[2],i[3],i[4],i[5])},_setShadow:function(){if(this.shadow){var r=this.canvas,i=this.shadow,n=r.contextTop,a=r.getZoom();r&&r._isRetinaScaling()&&(a*=g.devicePixelRatio),n.shadowColor=i.color,n.shadowBlur=i.blur*a,n.shadowOffsetX=i.offsetX*a,n.shadowOffsetY=i.offsetY*a}},needsFullRender:function(){return new g.Color(this.color).getAlpha()<1||!!this.shadow},_resetShadow:function(){var r=this.canvas.contextTop;r.shadowColor="",r.shadowBlur=r.shadowOffsetX=r.shadowOffsetY=0},_isOutSideCanvas:function(r){return r.x<0||r.x>this.canvas.getWidth()||r.y<0||r.y>this.canvas.getHeight()}}),g.PencilBrush=g.util.createClass(g.BaseBrush,{decimate:.4,drawStraightLine:!1,straightLineKey:"shiftKey",initialize:function(r){this.canvas=r,this._points=[]},needsFullRender:function(){return this.callSuper("needsFullRender")||this._hasStraightLine},_drawSegment:function(r,i,n){var a=i.midPointFrom(n);return r.quadraticCurveTo(i.x,i.y,a.x,a.y),a},onMouseDown:function(r,i){this.canvas._isMainEvent(i.e)&&(this.drawStraightLine=i.e[this.straightLineKey],this._prepareForDrawing(r),this._captureDrawingPath(r),this._render())},onMouseMove:function(r,i){if(this.canvas._isMainEvent(i.e)&&(this.drawStraightLine=i.e[this.straightLineKey],(this.limitedToCanvasSize!==!0||!this._isOutSideCanvas(r))&&this._captureDrawingPath(r)&&this._points.length>1))if(this.needsFullRender())this.canvas.clearContext(this.canvas.contextTop),this._render();else{var n=this._points,a=n.length,e=this.canvas.contextTop;this._saveAndTransform(e),this.oldEnd&&(e.beginPath(),e.moveTo(this.oldEnd.x,this.oldEnd.y)),this.oldEnd=this._drawSegment(e,n[a-2],n[a-1],!0),e.stroke(),e.restore()}},onMouseUp:function(r){return!this.canvas._isMainEvent(r.e)||(this.drawStraightLine=!1,this.oldEnd=void 0,this._finalizeAndAddPath(),!1)},_prepareForDrawing:function(r){var i=new g.Point(r.x,r.y);this._reset(),this._addPoint(i),this.canvas.contextTop.moveTo(i.x,i.y)},_addPoint:function(r){return!(this._points.length>1&&r.eq(this._points[this._points.length-1])||(this.drawStraightLine&&this._points.length>1&&(this._hasStraightLine=!0,this._points.pop()),this._points.push(r),0))},_reset:function(){this._points=[],this._setBrushStyles(this.canvas.contextTop),this._setShadow(),this._hasStraightLine=!1},_captureDrawingPath:function(r){var i=new g.Point(r.x,r.y);return this._addPoint(i)},_render:function(r){var i,n,a=this._points[0],e=this._points[1];if(r=r||this.canvas.contextTop,this._saveAndTransform(r),r.beginPath(),this._points.length===2&&a.x===e.x&&a.y===e.y){var t=this.width/1e3;a=new g.Point(a.x,a.y),e=new g.Point(e.x,e.y),a.x-=t,e.x+=t}for(r.moveTo(a.x,a.y),i=1,n=this._points.length;i<n;i++)this._drawSegment(r,a,e),a=this._points[i],e=this._points[i+1];r.lineTo(a.x,a.y),r.stroke(),r.restore()},convertPointsToSVGPath:function(r){var i=this.width/1e3;return g.util.getSmoothPathFromPoints(r,i)},_isEmptySVGPath:function(r){return g.util.joinPath(r)==="M 0 0 Q 0 0 0 0 L 0 0"},createPath:function(r){var i=new g.Path(r,{fill:null,stroke:this.color,strokeWidth:this.width,strokeLineCap:this.strokeLineCap,strokeMiterLimit:this.strokeMiterLimit,strokeLineJoin:this.strokeLineJoin,strokeDashArray:this.strokeDashArray});return this.shadow&&(this.shadow.affectStroke=!0,i.shadow=new g.Shadow(this.shadow)),i},decimatePoints:function(r,i){if(r.length<=2)return r;var n,a=this.canvas.getZoom(),e=Math.pow(i/a,2),t=r.length-1,s=r[0],c=[s];for(n=1;n<t-1;n++)Math.pow(s.x-r[n].x,2)+Math.pow(s.y-r[n].y,2)>=e&&(s=r[n],c.push(s));return c.push(r[t]),c},_finalizeAndAddPath:function(){this.canvas.contextTop.closePath(),this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate));var r=this.convertPointsToSVGPath(this._points);if(this._isEmptySVGPath(r))this.canvas.requestRenderAll();else{var i=this.createPath(r);this.canvas.clearContext(this.canvas.contextTop),this.canvas.fire("before:path:created",{path:i}),this.canvas.add(i),this.canvas.requestRenderAll(),i.setCoords(),this._resetShadow(),this.canvas.fire("path:created",{path:i})}}}),g.CircleBrush=g.util.createClass(g.BaseBrush,{width:10,initialize:function(r){this.canvas=r,this.points=[]},drawDot:function(r){var i=this.addPoint(r),n=this.canvas.contextTop;this._saveAndTransform(n),this.dot(n,i),n.restore()},dot:function(r,i){r.fillStyle=i.fill,r.beginPath(),r.arc(i.x,i.y,i.radius,0,2*Math.PI,!1),r.closePath(),r.fill()},onMouseDown:function(r){this.points.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.drawDot(r)},_render:function(){var r,i,n=this.canvas.contextTop,a=this.points;for(this._saveAndTransform(n),r=0,i=a.length;r<i;r++)this.dot(n,a[r]);n.restore()},onMouseMove:function(r){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(r)||(this.needsFullRender()?(this.canvas.clearContext(this.canvas.contextTop),this.addPoint(r),this._render()):this.drawDot(r))},onMouseUp:function(){var r,i,n=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;var a=[];for(r=0,i=this.points.length;r<i;r++){var e=this.points[r],t=new g.Circle({radius:e.radius,left:e.x,top:e.y,originX:"center",originY:"center",fill:e.fill});this.shadow&&(t.shadow=new g.Shadow(this.shadow)),a.push(t)}var s=new g.Group(a);s.canvas=this.canvas,this.canvas.fire("before:path:created",{path:s}),this.canvas.add(s),this.canvas.fire("path:created",{path:s}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=n,this.canvas.requestRenderAll()},addPoint:function(r){var i=new g.Point(r.x,r.y),n=g.util.getRandomInt(Math.max(0,this.width-20),this.width+20)/2,a=new g.Color(this.color).setAlpha(g.util.getRandomInt(0,100)/100).toRgba();return i.radius=n,i.fill=a,this.points.push(i),i}}),g.SprayBrush=g.util.createClass(g.BaseBrush,{width:10,density:20,dotWidth:1,dotWidthVariance:1,randomOpacity:!1,optimizeOverlapping:!0,initialize:function(r){this.canvas=r,this.sprayChunks=[]},onMouseDown:function(r){this.sprayChunks.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.addSprayChunk(r),this.render(this.sprayChunkPoints)},onMouseMove:function(r){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(r)||(this.addSprayChunk(r),this.render(this.sprayChunkPoints))},onMouseUp:function(){var r=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;for(var i=[],n=0,a=this.sprayChunks.length;n<a;n++)for(var e=this.sprayChunks[n],t=0,s=e.length;t<s;t++){var c=new g.Rect({width:e[t].width,height:e[t].width,left:e[t].x+1,top:e[t].y+1,originX:"center",originY:"center",fill:this.color});i.push(c)}this.optimizeOverlapping&&(i=this._getOptimizedRects(i));var h=new g.Group(i);this.shadow&&h.set("shadow",new g.Shadow(this.shadow)),this.canvas.fire("before:path:created",{path:h}),this.canvas.add(h),this.canvas.fire("path:created",{path:h}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=r,this.canvas.requestRenderAll()},_getOptimizedRects:function(r){var i,n,a,e={};for(n=0,a=r.length;n<a;n++)e[i=r[n].left+""+r[n].top]||(e[i]=r[n]);var t=[];for(i in e)t.push(e[i]);return t},render:function(r){var i,n,a=this.canvas.contextTop;for(a.fillStyle=this.color,this._saveAndTransform(a),i=0,n=r.length;i<n;i++){var e=r[i];e.opacity!==void 0&&(a.globalAlpha=e.opacity),a.fillRect(e.x,e.y,e.width,e.width)}a.restore()},_render:function(){var r,i,n=this.canvas.contextTop;for(n.fillStyle=this.color,this._saveAndTransform(n),r=0,i=this.sprayChunks.length;r<i;r++)this.render(this.sprayChunks[r]);n.restore()},addSprayChunk:function(r){this.sprayChunkPoints=[];var i,n,a,e,t=this.width/2;for(e=0;e<this.density;e++){i=g.util.getRandomInt(r.x-t,r.x+t),n=g.util.getRandomInt(r.y-t,r.y+t),a=this.dotWidthVariance?g.util.getRandomInt(Math.max(1,this.dotWidth-this.dotWidthVariance),this.dotWidth+this.dotWidthVariance):this.dotWidth;var s=new g.Point(i,n);s.width=a,this.randomOpacity&&(s.opacity=g.util.getRandomInt(0,100)/100),this.sprayChunkPoints.push(s)}this.sprayChunks.push(this.sprayChunkPoints)}}),g.PatternBrush=g.util.createClass(g.PencilBrush,{getPatternSrc:function(){var r=g.util.createCanvasElement(),i=r.getContext("2d");return r.width=r.height=25,i.fillStyle=this.color,i.beginPath(),i.arc(10,10,10,0,2*Math.PI,!1),i.closePath(),i.fill(),r},getPatternSrcFunction:function(){return String(this.getPatternSrc).replace("this.color",'"'+this.color+'"')},getPattern:function(r){return r.createPattern(this.source||this.getPatternSrc(),"repeat")},_setBrushStyles:function(r){this.callSuper("_setBrushStyles",r),r.strokeStyle=this.getPattern(r)},createPath:function(r){var i=this.callSuper("createPath",r),n=i._getLeftTopCoords().scalarAdd(i.strokeWidth/2);return i.stroke=new g.Pattern({source:this.source||this.getPatternSrcFunction(),offsetX:-n.x,offsetY:-n.y}),i}}),function(){var r=g.util.getPointer,i=g.util.degreesToRadians,n=g.util.isTouchEvent;for(var a in g.Canvas=g.util.createClass(g.StaticCanvas,{initialize:function(e,t){t||(t={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(e,t),this._initInteractive(),this._createCacheCanvas()},uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",interactive:!0,selection:!0,selectionKey:"shiftKey",altSelectionKey:null,selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",notAllowedCursor:"not-allowed",containerClass:"canvas-container",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,isDrawingMode:!1,preserveObjectStacking:!1,snapAngle:0,snapThreshold:null,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,targets:[],enablePointerEvents:!1,_hoveredTarget:null,_hoveredTargets:[],_initInteractive:function(){this._currentTransform=null,this._groupSelector=null,this._initWrapperElement(),this._createUpperCanvas(),this._initEventListeners(),this._initRetinaScaling(),this.freeDrawingBrush=g.PencilBrush&&new g.PencilBrush(this),this.calcOffset()},_chooseObjectsToRender:function(){var e,t,s,c=this.getActiveObjects();if(c.length>0&&!this.preserveObjectStacking){t=[],s=[];for(var h=0,l=this._objects.length;h<l;h++)e=this._objects[h],c.indexOf(e)===-1?t.push(e):s.push(e);c.length>1&&(this._activeObject._objects=s),t.push.apply(t,s)}else t=this._objects;return t},renderAll:function(){!this.contextTopDirty||this._groupSelector||this.isDrawingMode||(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&(this.renderTopLayer(this.contextTop),this.hasLostContext=!1);var e=this.contextContainer;return this.renderCanvas(e,this._chooseObjectsToRender()),this},renderTopLayer:function(e){e.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(e),this.contextTopDirty=!0),e.restore()},renderTop:function(){var e=this.contextTop;return this.clearContext(e),this.renderTopLayer(e),this.fire("after:render"),this},_normalizePointer:function(e,t){var s=e.calcTransformMatrix(),c=g.util.invertTransform(s),h=this.restorePointerVpt(t);return g.util.transformPoint(h,c)},isTargetTransparent:function(e,t,s){if(e.shouldCache()&&e._cacheCanvas&&e!==this._activeObject){var c=this._normalizePointer(e,{x:t,y:s}),h=Math.max(e.cacheTranslationX+c.x*e.zoomX,0),l=Math.max(e.cacheTranslationY+c.y*e.zoomY,0);return g.util.isTransparent(e._cacheContext,Math.round(h),Math.round(l),this.targetFindTolerance)}var d=this.contextCache,p=e.selectionBackgroundColor,m=this.viewportTransform;return e.selectionBackgroundColor="",this.clearContext(d),d.save(),d.transform(m[0],m[1],m[2],m[3],m[4],m[5]),e.render(d),d.restore(),e.selectionBackgroundColor=p,g.util.isTransparent(d,t,s,this.targetFindTolerance)},_isSelectionKeyPressed:function(e){return Array.isArray(this.selectionKey)?!!this.selectionKey.find(function(t){return e[t]===!0}):e[this.selectionKey]},_shouldClearSelection:function(e,t){var s=this.getActiveObjects(),c=this._activeObject;return!t||t&&c&&s.length>1&&s.indexOf(t)===-1&&c!==t&&!this._isSelectionKeyPressed(e)||t&&!t.evented||t&&!t.selectable&&c&&c!==t},_shouldCenterTransform:function(e,t,s){var c;if(e)return t==="scale"||t==="scaleX"||t==="scaleY"||t==="resizing"?c=this.centeredScaling||e.centeredScaling:t==="rotate"&&(c=this.centeredRotation||e.centeredRotation),c?!s:s},_getOriginFromCorner:function(e,t){var s={x:e.originX,y:e.originY};return t==="ml"||t==="tl"||t==="bl"?s.x="right":t!=="mr"&&t!=="tr"&&t!=="br"||(s.x="left"),t==="tl"||t==="mt"||t==="tr"?s.y="bottom":t!=="bl"&&t!=="mb"&&t!=="br"||(s.y="top"),s},_getActionFromCorner:function(e,t,s,c){if(!t||!e)return"drag";var h=c.controls[t];return h.getActionName(s,h,c)},_setupCurrentTransform:function(e,t,s){if(t){var c=this.getPointer(e),h=t.__corner,l=t.controls[h],d=s&&h?l.getActionHandler(e,t,l):g.controlsUtils.dragHandler,p=this._getActionFromCorner(s,h,e,t),m=this._getOriginFromCorner(t,h),b=e[this.centeredKey],y={target:t,action:p,actionHandler:d,corner:h,scaleX:t.scaleX,scaleY:t.scaleY,skewX:t.skewX,skewY:t.skewY,offsetX:c.x-t.left,offsetY:c.y-t.top,originX:m.x,originY:m.y,ex:c.x,ey:c.y,lastX:c.x,lastY:c.y,theta:i(t.angle),width:t.width*t.scaleX,shiftKey:e.shiftKey,altKey:b,original:g.util.saveObjectTransform(t)};this._shouldCenterTransform(t,p,b)&&(y.originX="center",y.originY="center"),y.original.originX=m.x,y.original.originY=m.y,this._currentTransform=y,this._beforeTransform(e)}},setCursor:function(e){this.upperCanvasEl.style.cursor=e},_drawSelection:function(e){var t=this._groupSelector,s=new g.Point(t.ex,t.ey),c=g.util.transformPoint(s,this.viewportTransform),h=new g.Point(t.ex+t.left,t.ey+t.top),l=g.util.transformPoint(h,this.viewportTransform),d=Math.min(c.x,l.x),p=Math.min(c.y,l.y),m=Math.max(c.x,l.x),b=Math.max(c.y,l.y),y=this.selectionLineWidth/2;this.selectionColor&&(e.fillStyle=this.selectionColor,e.fillRect(d,p,m-d,b-p)),this.selectionLineWidth&&this.selectionBorderColor&&(e.lineWidth=this.selectionLineWidth,e.strokeStyle=this.selectionBorderColor,d+=y,p+=y,m-=y,b-=y,g.Object.prototype._setLineDash.call(this,e,this.selectionDashArray),e.strokeRect(d,p,m-d,b-p))},findTarget:function(e,t){if(!this.skipTargetFind){var s,c,h=this.getPointer(e,!0),l=this._activeObject,d=this.getActiveObjects(),p=n(e),m=d.length>1&&!t||d.length===1;if(this.targets=[],m&&l._findTargetCorner(h,p)||d.length>1&&!t&&l===this._searchPossibleTargets([l],h))return l;if(d.length===1&&l===this._searchPossibleTargets([l],h)){if(!this.preserveObjectStacking)return l;s=l,c=this.targets,this.targets=[]}var b=this._searchPossibleTargets(this._objects,h);return e[this.altSelectionKey]&&b&&s&&b!==s&&(b=s,this.targets=c),b}},_checkTarget:function(e,t,s){if(t&&t.visible&&t.evented&&t.containsPoint(e)&&(!this.perPixelTargetFind&&!t.perPixelTargetFind||t.isEditing||!this.isTargetTransparent(t,s.x,s.y)))return!0},_searchPossibleTargets:function(e,t){for(var s,c,h=e.length;h--;){var l=e[h],d=l.group?this._normalizePointer(l.group,t):t;if(this._checkTarget(d,l,t)){(s=e[h]).subTargetCheck&&s instanceof g.Group&&(c=this._searchPossibleTargets(s._objects,t))&&this.targets.push(c);break}}return s},restorePointerVpt:function(e){return g.util.transformPoint(e,g.util.invertTransform(this.viewportTransform))},getPointer:function(e,t){if(this._absolutePointer&&!t)return this._absolutePointer;if(this._pointer&&t)return this._pointer;var s,c=r(e),h=this.upperCanvasEl,l=h.getBoundingClientRect(),d=l.width||0,p=l.height||0;d&&p||("top"in l&&"bottom"in l&&(p=Math.abs(l.top-l.bottom)),"right"in l&&"left"in l&&(d=Math.abs(l.right-l.left))),this.calcOffset(),c.x=c.x-this._offset.left,c.y=c.y-this._offset.top,t||(c=this.restorePointerVpt(c));var m=this.getRetinaScaling();return m!==1&&(c.x/=m,c.y/=m),s=d===0||p===0?{width:1,height:1}:{width:h.width/d,height:h.height/p},{x:c.x*s.width,y:c.y*s.height}},_createUpperCanvas:function(){var e=this.lowerCanvasEl.className.replace(/\s*lower-canvas\s*/,""),t=this.lowerCanvasEl,s=this.upperCanvasEl;s?s.className="":(s=this._createCanvasElement(),this.upperCanvasEl=s),g.util.addClass(s,"upper-canvas "+e),this.wrapperEl.appendChild(s),this._copyCanvasStyle(t,s),this._applyCanvasStyle(s),this.contextTop=s.getContext("2d")},getTopContext:function(){return this.contextTop},_createCacheCanvas:function(){this.cacheCanvasEl=this._createCanvasElement(),this.cacheCanvasEl.setAttribute("width",this.width),this.cacheCanvasEl.setAttribute("height",this.height),this.contextCache=this.cacheCanvasEl.getContext("2d")},_initWrapperElement:function(){this.wrapperEl=g.util.wrapElement(this.lowerCanvasEl,"div",{class:this.containerClass}),g.util.setStyle(this.wrapperEl,{width:this.width+"px",height:this.height+"px",position:"relative"}),g.util.makeElementUnselectable(this.wrapperEl)},_applyCanvasStyle:function(e){var t=this.width||e.width,s=this.height||e.height;g.util.setStyle(e,{position:"absolute",width:t+"px",height:s+"px",left:0,top:0,"touch-action":this.allowTouchScrolling?"manipulation":"none","-ms-touch-action":this.allowTouchScrolling?"manipulation":"none"}),e.width=t,e.height=s,g.util.makeElementUnselectable(e)},_copyCanvasStyle:function(e,t){t.style.cssText=e.style.cssText},getSelectionContext:function(){return this.contextTop},getSelectionElement:function(){return this.upperCanvasEl},getActiveObject:function(){return this._activeObject},getActiveObjects:function(){var e=this._activeObject;return e?e.type==="activeSelection"&&e._objects?e._objects.slice(0):[e]:[]},_onObjectRemoved:function(e){e===this._activeObject&&(this.fire("before:selection:cleared",{target:e}),this._discardActiveObject(),this.fire("selection:cleared",{target:e}),e.fire("deselected")),e===this._hoveredTarget&&(this._hoveredTarget=null,this._hoveredTargets=[]),this.callSuper("_onObjectRemoved",e)},_fireSelectionEvents:function(e,t){var s=!1,c=this.getActiveObjects(),h=[],l=[];e.forEach(function(d){c.indexOf(d)===-1&&(s=!0,d.fire("deselected",{e:t,target:d}),l.push(d))}),c.forEach(function(d){e.indexOf(d)===-1&&(s=!0,d.fire("selected",{e:t,target:d}),h.push(d))}),e.length>0&&c.length>0?s&&this.fire("selection:updated",{e:t,selected:h,deselected:l}):c.length>0?this.fire("selection:created",{e:t,selected:h}):e.length>0&&this.fire("selection:cleared",{e:t,deselected:l})},setActiveObject:function(e,t){var s=this.getActiveObjects();return this._setActiveObject(e,t),this._fireSelectionEvents(s,t),this},_setActiveObject:function(e,t){return this._activeObject!==e&&!!this._discardActiveObject(t,e)&&!e.onSelect({e:t})&&(this._activeObject=e,!0)},_discardActiveObject:function(e,t){var s=this._activeObject;if(s){if(s.onDeselect({e,object:t}))return!1;this._activeObject=null}return!0},discardActiveObject:function(e){var t=this.getActiveObjects(),s=this.getActiveObject();return t.length&&this.fire("before:selection:cleared",{target:s,e}),this._discardActiveObject(e),this._fireSelectionEvents(t,e),this},dispose:function(){var e=this.wrapperEl;return this.removeListeners(),e.removeChild(this.upperCanvasEl),e.removeChild(this.lowerCanvasEl),this.contextCache=null,this.contextTop=null,["upperCanvasEl","cacheCanvasEl"].forEach((function(t){g.util.cleanUpJsdomNode(this[t]),this[t]=void 0}).bind(this)),e.parentNode&&e.parentNode.replaceChild(this.lowerCanvasEl,this.wrapperEl),delete this.wrapperEl,g.StaticCanvas.prototype.dispose.call(this),this},clear:function(){return this.discardActiveObject(),this.clearContext(this.contextTop),this.callSuper("clear")},drawControls:function(e){var t=this._activeObject;t&&t._renderControls(e)},_toObject:function(e,t,s){var c=this._realizeGroupTransformOnObject(e),h=this.callSuper("_toObject",e,t,s);return this._unwindGroupTransformOnObject(e,c),h},_realizeGroupTransformOnObject:function(e){if(e.group&&e.group.type==="activeSelection"&&this._activeObject===e.group){var t={};return["angle","flipX","flipY","left","scaleX","scaleY","skewX","skewY","top"].forEach(function(s){t[s]=e[s]}),g.util.addTransformToObject(e,this._activeObject.calcOwnMatrix()),t}return null},_unwindGroupTransformOnObject:function(e,t){t&&e.set(t)},_setSVGObject:function(e,t,s){var c=this._realizeGroupTransformOnObject(t);this.callSuper("_setSVGObject",e,t,s),this._unwindGroupTransformOnObject(t,c)},setViewportTransform:function(e){this.renderOnAddRemove&&this._activeObject&&this._activeObject.isEditing&&this._activeObject.clearContextTop(),g.StaticCanvas.prototype.setViewportTransform.call(this,e)}}),g.StaticCanvas)a!=="prototype"&&(g.Canvas[a]=g.StaticCanvas[a])}(),function(){var r=g.util.addListener,i=g.util.removeListener,n={passive:!1};function a(e,t){return e.button&&e.button===t-1}g.util.object.extend(g.Canvas.prototype,{mainTouchId:null,_initEventListeners:function(){this.removeListeners(),this._bindEvents(),this.addOrRemove(r,"add")},_getEventPrefix:function(){return this.enablePointerEvents?"pointer":"mouse"},addOrRemove:function(e,t){var s=this.upperCanvasEl,c=this._getEventPrefix();e(g.window,"resize",this._onResize),e(s,c+"down",this._onMouseDown),e(s,c+"move",this._onMouseMove,n),e(s,c+"out",this._onMouseOut),e(s,c+"enter",this._onMouseEnter),e(s,"wheel",this._onMouseWheel),e(s,"contextmenu",this._onContextMenu),e(s,"dblclick",this._onDoubleClick),e(s,"dragover",this._onDragOver),e(s,"dragenter",this._onDragEnter),e(s,"dragleave",this._onDragLeave),e(s,"drop",this._onDrop),this.enablePointerEvents||e(s,"touchstart",this._onTouchStart,n),typeof eventjs<"u"&&t in eventjs&&(eventjs[t](s,"gesture",this._onGesture),eventjs[t](s,"drag",this._onDrag),eventjs[t](s,"orientation",this._onOrientationChange),eventjs[t](s,"shake",this._onShake),eventjs[t](s,"longpress",this._onLongPress))},removeListeners:function(){this.addOrRemove(i,"remove");var e=this._getEventPrefix();i(g.document,e+"up",this._onMouseUp),i(g.document,"touchend",this._onTouchEnd,n),i(g.document,e+"move",this._onMouseMove,n),i(g.document,"touchmove",this._onMouseMove,n)},_bindEvents:function(){this.eventsBound||(this._onMouseDown=this._onMouseDown.bind(this),this._onTouchStart=this._onTouchStart.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._onResize=this._onResize.bind(this),this._onGesture=this._onGesture.bind(this),this._onDrag=this._onDrag.bind(this),this._onShake=this._onShake.bind(this),this._onLongPress=this._onLongPress.bind(this),this._onOrientationChange=this._onOrientationChange.bind(this),this._onMouseWheel=this._onMouseWheel.bind(this),this._onMouseOut=this._onMouseOut.bind(this),this._onMouseEnter=this._onMouseEnter.bind(this),this._onContextMenu=this._onContextMenu.bind(this),this._onDoubleClick=this._onDoubleClick.bind(this),this._onDragOver=this._onDragOver.bind(this),this._onDragEnter=this._simpleEventHandler.bind(this,"dragenter"),this._onDragLeave=this._simpleEventHandler.bind(this,"dragleave"),this._onDrop=this._onDrop.bind(this),this.eventsBound=!0)},_onGesture:function(e,t){this.__onTransformGesture&&this.__onTransformGesture(e,t)},_onDrag:function(e,t){this.__onDrag&&this.__onDrag(e,t)},_onMouseWheel:function(e){this.__onMouseWheel(e)},_onMouseOut:function(e){var t=this._hoveredTarget;this.fire("mouse:out",{target:t,e}),this._hoveredTarget=null,t&&t.fire("mouseout",{e});var s=this;this._hoveredTargets.forEach(function(c){s.fire("mouse:out",{target:t,e}),c&&t.fire("mouseout",{e})}),this._hoveredTargets=[],this._iTextInstances&&this._iTextInstances.forEach(function(c){c.isEditing&&c.hiddenTextarea.focus()})},_onMouseEnter:function(e){this._currentTransform||this.findTarget(e)||(this.fire("mouse:over",{target:null,e}),this._hoveredTarget=null,this._hoveredTargets=[])},_onOrientationChange:function(e,t){this.__onOrientationChange&&this.__onOrientationChange(e,t)},_onShake:function(e,t){this.__onShake&&this.__onShake(e,t)},_onLongPress:function(e,t){this.__onLongPress&&this.__onLongPress(e,t)},_onDragOver:function(e){e.preventDefault();var t=this._simpleEventHandler("dragover",e);this._fireEnterLeaveEvents(t,e)},_onDrop:function(e){return this._simpleEventHandler("drop:before",e),this._simpleEventHandler("drop",e)},_onContextMenu:function(e){return this.stopContextMenu&&(e.stopPropagation(),e.preventDefault()),!1},_onDoubleClick:function(e){this._cacheTransformEventData(e),this._handleEvent(e,"dblclick"),this._resetTransformEventData(e)},getPointerId:function(e){var t=e.changedTouches;return t?t[0]&&t[0].identifier:this.enablePointerEvents?e.pointerId:-1},_isMainEvent:function(e){return e.isPrimary===!0||e.isPrimary!==!1&&(e.type==="touchend"&&e.touches.length===0||!e.changedTouches||e.changedTouches[0].identifier===this.mainTouchId)},_onTouchStart:function(e){e.preventDefault(),this.mainTouchId===null&&(this.mainTouchId=this.getPointerId(e)),this.__onMouseDown(e),this._resetTransformEventData();var t=this.upperCanvasEl,s=this._getEventPrefix();r(g.document,"touchend",this._onTouchEnd,n),r(g.document,"touchmove",this._onMouseMove,n),i(t,s+"down",this._onMouseDown)},_onMouseDown:function(e){this.__onMouseDown(e),this._resetTransformEventData();var t=this.upperCanvasEl,s=this._getEventPrefix();i(t,s+"move",this._onMouseMove,n),r(g.document,s+"up",this._onMouseUp),r(g.document,s+"move",this._onMouseMove,n)},_onTouchEnd:function(e){if(!(e.touches.length>0)){this.__onMouseUp(e),this._resetTransformEventData(),this.mainTouchId=null;var t=this._getEventPrefix();i(g.document,"touchend",this._onTouchEnd,n),i(g.document,"touchmove",this._onMouseMove,n);var s=this;this._willAddMouseDown&&clearTimeout(this._willAddMouseDown),this._willAddMouseDown=setTimeout(function(){r(s.upperCanvasEl,t+"down",s._onMouseDown),s._willAddMouseDown=0},400)}},_onMouseUp:function(e){this.__onMouseUp(e),this._resetTransformEventData();var t=this.upperCanvasEl,s=this._getEventPrefix();this._isMainEvent(e)&&(i(g.document,s+"up",this._onMouseUp),i(g.document,s+"move",this._onMouseMove,n),r(t,s+"move",this._onMouseMove,n))},_onMouseMove:function(e){!this.allowTouchScrolling&&e.preventDefault&&e.preventDefault(),this.__onMouseMove(e)},_onResize:function(){this.calcOffset()},_shouldRender:function(e){var t=this._activeObject;return!!(!!t!=!!e||t&&e&&t!==e)||(t&&t.isEditing,!1)},__onMouseUp:function(e){var t,s=this._currentTransform,c=this._groupSelector,h=!1,l=!c||c.left===0&&c.top===0;if(this._cacheTransformEventData(e),t=this._target,this._handleEvent(e,"up:before"),a(e,3))this.fireRightClick&&this._handleEvent(e,"up",3,l);else{if(a(e,2))return this.fireMiddleClick&&this._handleEvent(e,"up",2,l),void this._resetTransformEventData();if(this.isDrawingMode&&this._isCurrentlyDrawing)this._onMouseUpInDrawingMode(e);else if(this._isMainEvent(e)){if(s&&(this._finalizeCurrentTransform(e),h=s.actionPerformed),!l){var d=t===this._activeObject;this._maybeGroupObjects(e),h||(h=this._shouldRender(t)||!d&&t===this._activeObject)}var p,m;if(t){if(p=t._findTargetCorner(this.getPointer(e,!0),g.util.isTouchEvent(e)),t.selectable&&t!==this._activeObject&&t.activeOn==="up")this.setActiveObject(t,e),h=!0;else{var b=t.controls[p],y=b&&b.getMouseUpHandler(e,t,b);y&&y(e,s,(m=this.getPointer(e)).x,m.y)}t.isMoving=!1}if(s&&(s.target!==t||s.corner!==p)){var w=s.target&&s.target.controls[s.corner],T=w&&w.getMouseUpHandler(e,t,b);m=m||this.getPointer(e),T&&T(e,s,m.x,m.y)}this._setCursorFromEvent(e,t),this._handleEvent(e,"up",1,l),this._groupSelector=null,this._currentTransform=null,t&&(t.__corner=0),h?this.requestRenderAll():l||this.renderTop()}}},_simpleEventHandler:function(e,t){var s=this.findTarget(t),c=this.targets,h={e:t,target:s,subTargets:c};if(this.fire(e,h),s&&s.fire(e,h),!c)return s;for(var l=0;l<c.length;l++)c[l].fire(e,h);return s},_handleEvent:function(e,t,s,c){var h=this._target,l=this.targets||[],d={e,target:h,subTargets:l,button:s||1,isClick:c||!1,pointer:this._pointer,absolutePointer:this._absolutePointer,transform:this._currentTransform};t==="up"&&(d.currentTarget=this.findTarget(e),d.currentSubTargets=this.targets),this.fire("mouse:"+t,d),h&&h.fire("mouse"+t,d);for(var p=0;p<l.length;p++)l[p].fire("mouse"+t,d)},_finalizeCurrentTransform:function(e){var t=this._currentTransform,s=t.target,c={e,target:s,transform:t,action:t.action};s._scaling&&(s._scaling=!1),s.setCoords(),(t.actionPerformed||this.stateful&&s.hasStateChanged())&&this._fire("modified",c)},_onMouseDownInDrawingMode:function(e){this._isCurrentlyDrawing=!0,this.getActiveObject()&&this.discardActiveObject(e).requestRenderAll();var t=this.getPointer(e);this.freeDrawingBrush.onMouseDown(t,{e,pointer:t}),this._handleEvent(e,"down")},_onMouseMoveInDrawingMode:function(e){if(this._isCurrentlyDrawing){var t=this.getPointer(e);this.freeDrawingBrush.onMouseMove(t,{e,pointer:t})}this.setCursor(this.freeDrawingCursor),this._handleEvent(e,"move")},_onMouseUpInDrawingMode:function(e){var t=this.getPointer(e);this._isCurrentlyDrawing=this.freeDrawingBrush.onMouseUp({e,pointer:t}),this._handleEvent(e,"up")},__onMouseDown:function(e){this._cacheTransformEventData(e),this._handleEvent(e,"down:before");var t=this._target;if(a(e,3))this.fireRightClick&&this._handleEvent(e,"down",3);else if(a(e,2))this.fireMiddleClick&&this._handleEvent(e,"down",2);else if(this.isDrawingMode)this._onMouseDownInDrawingMode(e);else if(this._isMainEvent(e)&&!this._currentTransform){var s=this._pointer;this._previousPointer=s;var c=this._shouldRender(t),h=this._shouldGroup(e,t);if(this._shouldClearSelection(e,t)?this.discardActiveObject(e):h&&(this._handleGrouping(e,t),t=this._activeObject),!this.selection||t&&(t.selectable||t.isEditing||t===this._activeObject)||(this._groupSelector={ex:this._absolutePointer.x,ey:this._absolutePointer.y,top:0,left:0}),t){var l=t===this._activeObject;t.selectable&&t.activeOn==="down"&&this.setActiveObject(t,e);var d=t._findTargetCorner(this.getPointer(e,!0),g.util.isTouchEvent(e));if(t.__corner=d,t===this._activeObject&&(d||!h)){this._setupCurrentTransform(e,t,l);var p=t.controls[d],m=(s=this.getPointer(e),p&&p.getMouseDownHandler(e,t,p));m&&m(e,this._currentTransform,s.x,s.y)}}this._handleEvent(e,"down"),(c||h)&&this.requestRenderAll()}},_resetTransformEventData:function(){this._target=null,this._pointer=null,this._absolutePointer=null},_cacheTransformEventData:function(e){this._resetTransformEventData(),this._pointer=this.getPointer(e,!0),this._absolutePointer=this.restorePointerVpt(this._pointer),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(e)||null},_beforeTransform:function(e){var t=this._currentTransform;this.stateful&&t.target.saveState(),this.fire("before:transform",{e,transform:t})},__onMouseMove:function(e){var t,s;if(this._handleEvent(e,"move:before"),this._cacheTransformEventData(e),this.isDrawingMode)this._onMouseMoveInDrawingMode(e);else if(this._isMainEvent(e)){var c=this._groupSelector;c?(s=this._absolutePointer,c.left=s.x-c.ex,c.top=s.y-c.ey,this.renderTop()):this._currentTransform?this._transformObject(e):(t=this.findTarget(e)||null,this._setCursorFromEvent(e,t),this._fireOverOutEvents(t,e)),this._handleEvent(e,"move"),this._resetTransformEventData()}},_fireOverOutEvents:function(e,t){var s=this._hoveredTarget,c=this._hoveredTargets,h=this.targets,l=Math.max(c.length,h.length);this.fireSyntheticInOutEvents(e,t,{oldTarget:s,evtOut:"mouseout",canvasEvtOut:"mouse:out",evtIn:"mouseover",canvasEvtIn:"mouse:over"});for(var d=0;d<l;d++)this.fireSyntheticInOutEvents(h[d],t,{oldTarget:c[d],evtOut:"mouseout",evtIn:"mouseover"});this._hoveredTarget=e,this._hoveredTargets=this.targets.concat()},_fireEnterLeaveEvents:function(e,t){var s=this._draggedoverTarget,c=this._hoveredTargets,h=this.targets,l=Math.max(c.length,h.length);this.fireSyntheticInOutEvents(e,t,{oldTarget:s,evtOut:"dragleave",evtIn:"dragenter"});for(var d=0;d<l;d++)this.fireSyntheticInOutEvents(h[d],t,{oldTarget:c[d],evtOut:"dragleave",evtIn:"dragenter"});this._draggedoverTarget=e},fireSyntheticInOutEvents:function(e,t,s){var c,h,l,d=s.oldTarget,p=d!==e,m=s.canvasEvtIn,b=s.canvasEvtOut;p&&(c={e:t,target:e,previousTarget:d},h={e:t,target:d,nextTarget:e}),l=e&&p,d&&p&&(b&&this.fire(b,h),d.fire(s.evtOut,h)),l&&(m&&this.fire(m,c),e.fire(s.evtIn,c))},__onMouseWheel:function(e){this._cacheTransformEventData(e),this._handleEvent(e,"wheel"),this._resetTransformEventData()},_transformObject:function(e){var t=this.getPointer(e),s=this._currentTransform;s.reset=!1,s.shiftKey=e.shiftKey,s.altKey=e[this.centeredKey],this._performTransformAction(e,s,t),s.actionPerformed&&this.requestRenderAll()},_performTransformAction:function(e,t,s){var c=s.x,h=s.y,l=t.action,d=!1,p=t.actionHandler;p&&(d=p(e,t,c,h)),l==="drag"&&d&&(t.target.isMoving=!0,this.setCursor(t.target.moveCursor||this.moveCursor)),t.actionPerformed=t.actionPerformed||d},_fire:g.controlsUtils.fireEvent,_setCursorFromEvent:function(e,t){if(!t)return this.setCursor(this.defaultCursor),!1;var s=t.hoverCursor||this.hoverCursor,c=this._activeObject&&this._activeObject.type==="activeSelection"?this._activeObject:null,h=(!c||!c.contains(t))&&t._findTargetCorner(this.getPointer(e,!0));h?this.setCursor(this.getCornerCursor(h,t,e)):(t.subTargetCheck&&this.targets.concat().reverse().map(function(l){s=l.hoverCursor||s}),this.setCursor(s))},getCornerCursor:function(e,t,s){var c=t.controls[e];return c.cursorStyleHandler(s,c,t)}})}(),ue=Math.min,$=Math.max,g.util.object.extend(g.Canvas.prototype,{_shouldGroup:function(r,i){var n=this._activeObject;return n&&this._isSelectionKeyPressed(r)&&i&&i.selectable&&this.selection&&(n!==i||n.type==="activeSelection")&&!i.onSelect({e:r})},_handleGrouping:function(r,i){var n=this._activeObject;n.__corner||(i!==n||(i=this.findTarget(r,!0))&&i.selectable)&&(n&&n.type==="activeSelection"?this._updateActiveSelection(i,r):this._createActiveSelection(i,r))},_updateActiveSelection:function(r,i){var n=this._activeObject,a=n._objects.slice(0);n.contains(r)?(n.removeWithUpdate(r),this._hoveredTarget=r,this._hoveredTargets=this.targets.concat(),n.size()===1&&this._setActiveObject(n.item(0),i)):(n.addWithUpdate(r),this._hoveredTarget=n,this._hoveredTargets=this.targets.concat()),this._fireSelectionEvents(a,i)},_createActiveSelection:function(r,i){var n=this.getActiveObjects(),a=this._createGroup(r);this._hoveredTarget=a,this._setActiveObject(a,i),this._fireSelectionEvents(n,i)},_createGroup:function(r){var i=this._objects,n=i.indexOf(this._activeObject)<i.indexOf(r)?[this._activeObject,r]:[r,this._activeObject];return this._activeObject.isEditing&&this._activeObject.exitEditing(),new g.ActiveSelection(n,{canvas:this})},_groupSelectedObjects:function(r){var i,n=this._collectObjects(r);n.length===1?this.setActiveObject(n[0],r):n.length>1&&(i=new g.ActiveSelection(n.reverse(),{canvas:this}),this.setActiveObject(i,r))},_collectObjects:function(r){for(var i,n=[],a=this._groupSelector.ex,e=this._groupSelector.ey,t=a+this._groupSelector.left,s=e+this._groupSelector.top,c=new g.Point(ue(a,t),ue(e,s)),h=new g.Point($(a,t),$(e,s)),l=!this.selectionFullyContained,d=a===t&&e===s,p=this._objects.length;p--&&!((i=this._objects[p])&&i.selectable&&i.visible&&(l&&i.intersectsWithRect(c,h,!0)||i.isContainedWithinRect(c,h,!0)||l&&i.containsPoint(c,null,!0)||l&&i.containsPoint(h,null,!0))&&(n.push(i),d)););return n.length>1&&(n=n.filter(function(m){return!m.onSelect({e:r})})),n},_maybeGroupObjects:function(r){this.selection&&this._groupSelector&&this._groupSelectedObjects(r),this.setCursor(this.defaultCursor),this._groupSelector=null}}),g.util.object.extend(g.StaticCanvas.prototype,{toDataURL:function(r){r||(r={});var i=r.format||"png",n=r.quality||1,a=(r.multiplier||1)*(r.enableRetinaScaling?this.getRetinaScaling():1),e=this.toCanvasElement(a,r);return g.util.toDataURL(e,i,n)},toCanvasElement:function(r,i){r=r||1;var n=((i=i||{}).width||this.width)*r,a=(i.height||this.height)*r,e=this.getZoom(),t=this.width,s=this.height,c=e*r,h=this.viewportTransform,l=(h[4]-(i.left||0))*r,d=(h[5]-(i.top||0))*r,p=this.interactive,m=[c,0,0,c,l,d],b=this.enableRetinaScaling,y=g.util.createCanvasElement(),w=this.contextTop;return y.width=n,y.height=a,this.contextTop=null,this.enableRetinaScaling=!1,this.interactive=!1,this.viewportTransform=m,this.width=n,this.height=a,this.calcViewportBoundaries(),this.renderCanvas(y.getContext("2d"),this._objects),this.viewportTransform=h,this.width=t,this.height=s,this.calcViewportBoundaries(),this.interactive=p,this.enableRetinaScaling=b,this.contextTop=w,y}}),g.util.object.extend(g.StaticCanvas.prototype,{loadFromJSON:function(r,i,n){if(r){var a=typeof r=="string"?JSON.parse(r):g.util.object.clone(r),e=this,t=a.clipPath,s=this.renderOnAddRemove;return this.renderOnAddRemove=!1,delete a.clipPath,this._enlivenObjects(a.objects,function(c){e.clear(),e._setBgOverlay(a,function(){t?e._enlivenObjects([t],function(h){e.clipPath=h[0],e.__setupCanvas.call(e,a,c,s,i)}):e.__setupCanvas.call(e,a,c,s,i)})},n),this}},__setupCanvas:function(r,i,n,a){var e=this;i.forEach(function(t,s){e.insertAt(t,s)}),this.renderOnAddRemove=n,delete r.objects,delete r.backgroundImage,delete r.overlayImage,delete r.background,delete r.overlay,this._setOptions(r),this.renderAll(),a&&a()},_setBgOverlay:function(r,i){var n={backgroundColor:!1,overlayColor:!1,backgroundImage:!1,overlayImage:!1};if(r.backgroundImage||r.overlayImage||r.background||r.overlay){var a=function(){n.backgroundImage&&n.overlayImage&&n.backgroundColor&&n.overlayColor&&i&&i()};this.__setBgOverlay("backgroundImage",r.backgroundImage,n,a),this.__setBgOverlay("overlayImage",r.overlayImage,n,a),this.__setBgOverlay("backgroundColor",r.background,n,a),this.__setBgOverlay("overlayColor",r.overlay,n,a)}else i&&i()},__setBgOverlay:function(r,i,n,a){var e=this;if(!i)return n[r]=!0,void(a&&a());r==="backgroundImage"||r==="overlayImage"?g.util.enlivenObjects([i],function(t){e[r]=t[0],n[r]=!0,a&&a()}):this["set"+g.util.string.capitalize(r,!0)](i,function(){n[r]=!0,a&&a()})},_enlivenObjects:function(r,i,n){r&&r.length!==0?g.util.enlivenObjects(r,function(a){i&&i(a)},null,n):i&&i([])},_toDataURL:function(r,i){this.clone(function(n){i(n.toDataURL(r))})},_toDataURLWithMultiplier:function(r,i,n){this.clone(function(a){n(a.toDataURLWithMultiplier(r,i))})},clone:function(r,i){var n=JSON.stringify(this.toJSON(i));this.cloneWithoutData(function(a){a.loadFromJSON(n,function(){r&&r(a)})})},cloneWithoutData:function(r){var i=g.util.createCanvasElement();i.width=this.width,i.height=this.height;var n=new g.Canvas(i);this.backgroundImage?(n.setBackgroundImage(this.backgroundImage.src,function(){n.renderAll(),r&&r(n)}),n.backgroundImageOpacity=this.backgroundImageOpacity,n.backgroundImageStretch=this.backgroundImageStretch):r&&r(n)}}),function(r){var i=r.fabric||(r.fabric={}),n=i.util.object.extend,a=i.util.object.clone,e=i.util.toFixed,t=i.util.string.capitalize,s=i.util.degreesToRadians,c=!i.isLikelyNode;i.Object||(i.Object=i.util.createClass(i.CommonMethods,{type:"object",originX:"left",originY:"top",top:0,left:0,width:0,height:0,scaleX:1,scaleY:1,flipX:!1,flipY:!1,opacity:1,angle:0,skewX:0,skewY:0,cornerSize:13,touchCornerSize:24,transparentCorners:!0,hoverCursor:null,moveCursor:null,padding:0,borderColor:"rgb(178,204,255)",borderDashArray:null,cornerColor:"rgb(178,204,255)",cornerStrokeColor:null,cornerStyle:"rect",cornerDashArray:null,centeredScaling:!1,centeredRotation:!0,fill:"rgb(0,0,0)",fillRule:"nonzero",globalCompositeOperation:"source-over",backgroundColor:"",selectionBackgroundColor:"",stroke:null,strokeWidth:1,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,shadow:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,minScaleLimit:0,selectable:!0,evented:!0,visible:!0,hasControls:!0,hasBorders:!0,perPixelTargetFind:!1,includeDefaultValues:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,excludeFromExport:!1,objectCaching:c,statefullCache:!1,noScaleCache:!0,strokeUniform:!1,dirty:!0,__corner:0,paintFirst:"fill",activeOn:"down",stateProperties:"top left width height scaleX scaleY flipX flipY originX originY transformMatrix stroke strokeWidth strokeDashArray strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit angle opacity fill globalCompositeOperation shadow visible backgroundColor skewX skewY fillRule paintFirst clipPath strokeUniform".split(" "),cacheProperties:"fill stroke strokeWidth strokeDashArray width height paintFirst strokeUniform strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit backgroundColor clipPath".split(" "),colorProperties:"fill stroke backgroundColor".split(" "),clipPath:void 0,inverted:!1,absolutePositioned:!1,initialize:function(h){h&&this.setOptions(h)},_createCacheCanvas:function(){this._cacheProperties={},this._cacheCanvas=i.util.createCanvasElement(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0},_limitCacheSize:function(h){var l=i.perfLimitSizeTotal,d=h.width,p=h.height,m=i.maxCacheSideLimit,b=i.minCacheSideLimit;if(d<=m&&p<=m&&d*p<=l)return d<b&&(h.width=b),p<b&&(h.height=b),h;var y=d/p,w=i.util.limitDimsByArea(y,l),T=i.util.capValue,k=T(b,w.x,m),P=T(b,w.y,m);return d>k&&(h.zoomX/=d/k,h.width=k,h.capped=!0),p>P&&(h.zoomY/=p/P,h.height=P,h.capped=!0),h},_getCacheCanvasDimensions:function(){var h=this.getTotalObjectScaling(),l=this._getTransformedDimensions(0,0),d=l.x*h.scaleX/this.scaleX,p=l.y*h.scaleY/this.scaleY;return{width:d+2,height:p+2,zoomX:h.scaleX,zoomY:h.scaleY,x:d,y:p}},_updateCacheCanvas:function(){var h=this.canvas;if(this.noScaleCache&&h&&h._currentTransform){var l=h._currentTransform.target,d=h._currentTransform.action;if(this===l&&d.slice&&d.slice(0,5)==="scale")return!1}var p,m,b=this._cacheCanvas,y=this._limitCacheSize(this._getCacheCanvasDimensions()),w=i.minCacheSideLimit,T=y.width,k=y.height,P=y.zoomX,G=y.zoomY,V=T!==this.cacheWidth||k!==this.cacheHeight,N=this.zoomX!==P||this.zoomY!==G,A=V||N,O=0,B=0,W=!1;if(V){var H=this._cacheCanvas.width,R=this._cacheCanvas.height,D=T>H||k>R;W=D||(T<.9*H||k<.9*R)&&H>w&&R>w,D&&!y.capped&&(T>w||k>w)&&(O=.1*T,B=.1*k)}return this instanceof i.Text&&this.path&&(A=!0,W=!0,O+=this.getHeightOfLine(0)*this.zoomX,B+=this.getHeightOfLine(0)*this.zoomY),!!A&&(W?(b.width=Math.ceil(T+O),b.height=Math.ceil(k+B)):(this._cacheContext.setTransform(1,0,0,1,0,0),this._cacheContext.clearRect(0,0,b.width,b.height)),p=y.x/2,m=y.y/2,this.cacheTranslationX=Math.round(b.width/2-p)+p,this.cacheTranslationY=Math.round(b.height/2-m)+m,this.cacheWidth=T,this.cacheHeight=k,this._cacheContext.translate(this.cacheTranslationX,this.cacheTranslationY),this._cacheContext.scale(P,G),this.zoomX=P,this.zoomY=G,!0)},setOptions:function(h){this._setOptions(h),this._initGradient(h.fill,"fill"),this._initGradient(h.stroke,"stroke"),this._initPattern(h.fill,"fill"),this._initPattern(h.stroke,"stroke")},transform:function(h){var l=this.group&&!this.group._transformDone||this.group&&this.canvas&&h===this.canvas.contextTop,d=this.calcTransformMatrix(!l);h.transform(d[0],d[1],d[2],d[3],d[4],d[5])},toObject:function(h){var l=i.Object.NUM_FRACTION_DIGITS,d={type:this.type,version:i.version,originX:this.originX,originY:this.originY,left:e(this.left,l),top:e(this.top,l),width:e(this.width,l),height:e(this.height,l),fill:this.fill&&this.fill.toObject?this.fill.toObject():this.fill,stroke:this.stroke&&this.stroke.toObject?this.stroke.toObject():this.stroke,strokeWidth:e(this.strokeWidth,l),strokeDashArray:this.strokeDashArray?this.strokeDashArray.concat():this.strokeDashArray,strokeLineCap:this.strokeLineCap,strokeDashOffset:this.strokeDashOffset,strokeLineJoin:this.strokeLineJoin,strokeUniform:this.strokeUniform,strokeMiterLimit:e(this.strokeMiterLimit,l),scaleX:e(this.scaleX,l),scaleY:e(this.scaleY,l),angle:e(this.angle,l),flipX:this.flipX,flipY:this.flipY,opacity:e(this.opacity,l),shadow:this.shadow&&this.shadow.toObject?this.shadow.toObject():this.shadow,visible:this.visible,backgroundColor:this.backgroundColor,fillRule:this.fillRule,paintFirst:this.paintFirst,globalCompositeOperation:this.globalCompositeOperation,skewX:e(this.skewX,l),skewY:e(this.skewY,l)};return this.clipPath&&!this.clipPath.excludeFromExport&&(d.clipPath=this.clipPath.toObject(h),d.clipPath.inverted=this.clipPath.inverted,d.clipPath.absolutePositioned=this.clipPath.absolutePositioned),i.util.populateWithProperties(this,d,h),this.includeDefaultValues||(d=this._removeDefaultValues(d)),d},toDatalessObject:function(h){return this.toObject(h)},_removeDefaultValues:function(h){var l=i.util.getKlass(h.type).prototype;return l.stateProperties.forEach(function(d){d!=="left"&&d!=="top"&&(h[d]===l[d]&&delete h[d],Array.isArray(h[d])&&Array.isArray(l[d])&&h[d].length===0&&l[d].length===0&&delete h[d])}),h},toString:function(){return"#<fabric."+t(this.type)+">"},getObjectScaling:function(){if(!this.group)return{scaleX:this.scaleX,scaleY:this.scaleY};var h=i.util.qrDecompose(this.calcTransformMatrix());return{scaleX:Math.abs(h.scaleX),scaleY:Math.abs(h.scaleY)}},getTotalObjectScaling:function(){var h=this.getObjectScaling(),l=h.scaleX,d=h.scaleY;if(this.canvas){var p=this.canvas.getZoom(),m=this.canvas.getRetinaScaling();l*=p*m,d*=p*m}return{scaleX:l,scaleY:d}},getObjectOpacity:function(){var h=this.opacity;return this.group&&(h*=this.group.getObjectOpacity()),h},_set:function(h,l){var d=h==="scaleX"||h==="scaleY",p=this[h]!==l,m=!1;return d&&(l=this._constrainScale(l)),h==="scaleX"&&l<0?(this.flipX=!this.flipX,l*=-1):h==="scaleY"&&l<0?(this.flipY=!this.flipY,l*=-1):h!=="shadow"||!l||l instanceof i.Shadow?h==="dirty"&&this.group&&this.group.set("dirty",l):l=new i.Shadow(l),this[h]=l,p&&(m=this.group&&this.group.isOnACache(),this.cacheProperties.indexOf(h)>-1?(this.dirty=!0,m&&this.group.set("dirty",!0)):m&&this.stateProperties.indexOf(h)>-1&&this.group.set("dirty",!0)),this},setOnGroup:function(){},getViewportTransform:function(){return this.canvas&&this.canvas.viewportTransform?this.canvas.viewportTransform:i.iMatrix.concat()},isNotVisible:function(){return this.opacity===0||!this.width&&!this.height&&this.strokeWidth===0||!this.visible},render:function(h){this.isNotVisible()||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(h.save(),this._setupCompositeOperation(h),this.drawSelectionBackground(h),this.transform(h),this._setOpacity(h),this._setShadow(h,this),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(h)):(this._removeCacheCanvas(),this.dirty=!1,this.drawObject(h),this.objectCaching&&this.statefullCache&&this.saveState({propertySet:"cacheProperties"})),h.restore())},renderCache:function(h){h=h||{},this._cacheCanvas&&this._cacheContext||this._createCacheCanvas(),this.isCacheDirty()&&(this.statefullCache&&this.saveState({propertySet:"cacheProperties"}),this.drawObject(this._cacheContext,h.forClipping),this.dirty=!1)},_removeCacheCanvas:function(){this._cacheCanvas=null,this._cacheContext=null,this.cacheWidth=0,this.cacheHeight=0},hasStroke:function(){return this.stroke&&this.stroke!=="transparent"&&this.strokeWidth!==0},hasFill:function(){return this.fill&&this.fill!=="transparent"},needsItsOwnCache:function(){return!(this.paintFirst!=="stroke"||!this.hasFill()||!this.hasStroke()||typeof this.shadow!="object")||!!this.clipPath},shouldCache:function(){return this.ownCaching=this.needsItsOwnCache()||this.objectCaching&&(!this.group||!this.group.isOnACache()),this.ownCaching},willDrawShadow:function(){return!!this.shadow&&(this.shadow.offsetX!==0||this.shadow.offsetY!==0)},drawClipPathOnCache:function(h,l){if(h.save(),l.inverted?h.globalCompositeOperation="destination-out":h.globalCompositeOperation="destination-in",l.absolutePositioned){var d=i.util.invertTransform(this.calcTransformMatrix());h.transform(d[0],d[1],d[2],d[3],d[4],d[5])}l.transform(h),h.scale(1/l.zoomX,1/l.zoomY),h.drawImage(l._cacheCanvas,-l.cacheTranslationX,-l.cacheTranslationY),h.restore()},drawObject:function(h,l){var d=this.fill,p=this.stroke;l?(this.fill="black",this.stroke="",this._setClippingProperties(h)):this._renderBackground(h),this._render(h),this._drawClipPath(h,this.clipPath),this.fill=d,this.stroke=p},_drawClipPath:function(h,l){l&&(l.canvas=this.canvas,l.shouldCache(),l._transformDone=!0,l.renderCache({forClipping:!0}),this.drawClipPathOnCache(h,l))},drawCacheOnCanvas:function(h){h.scale(1/this.zoomX,1/this.zoomY),h.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)},isCacheDirty:function(h){if(this.isNotVisible())return!1;if(this._cacheCanvas&&this._cacheContext&&!h&&this._updateCacheCanvas())return!0;if(this.dirty||this.clipPath&&this.clipPath.absolutePositioned||this.statefullCache&&this.hasStateChanged("cacheProperties")){if(this._cacheCanvas&&this._cacheContext&&!h){var l=this.cacheWidth/this.zoomX,d=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-l/2,-d/2,l,d)}return!0}return!1},_renderBackground:function(h){if(this.backgroundColor){var l=this._getNonTransformedDimensions();h.fillStyle=this.backgroundColor,h.fillRect(-l.x/2,-l.y/2,l.x,l.y),this._removeShadow(h)}},_setOpacity:function(h){this.group&&!this.group._transformDone?h.globalAlpha=this.getObjectOpacity():h.globalAlpha*=this.opacity},_setStrokeStyles:function(h,l){var d=l.stroke;d&&(h.lineWidth=l.strokeWidth,h.lineCap=l.strokeLineCap,h.lineDashOffset=l.strokeDashOffset,h.lineJoin=l.strokeLineJoin,h.miterLimit=l.strokeMiterLimit,d.toLive?d.gradientUnits==="percentage"||d.gradientTransform||d.patternTransform?this._applyPatternForTransformedGradient(h,d):(h.strokeStyle=d.toLive(h,this),this._applyPatternGradientTransform(h,d)):h.strokeStyle=l.stroke)},_setFillStyles:function(h,l){var d=l.fill;d&&(d.toLive?(h.fillStyle=d.toLive(h,this),this._applyPatternGradientTransform(h,l.fill)):h.fillStyle=d)},_setClippingProperties:function(h){h.globalAlpha=1,h.strokeStyle="transparent",h.fillStyle="#000000"},_setLineDash:function(h,l){l&&l.length!==0&&(1&l.length&&l.push.apply(l,l),h.setLineDash(l))},_renderControls:function(h,l){var d,p,m,b=this.getViewportTransform(),y=this.calcTransformMatrix();p=(l=l||{}).hasBorders!==void 0?l.hasBorders:this.hasBorders,m=l.hasControls!==void 0?l.hasControls:this.hasControls,y=i.util.multiplyTransformMatrices(b,y),d=i.util.qrDecompose(y),h.save(),h.translate(d.translateX,d.translateY),h.lineWidth=1*this.borderScaleFactor,this.group||(h.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),this.flipX&&(d.angle-=180),h.rotate(s(this.group?d.angle:this.angle)),l.forActiveSelection||this.group?p&&this.drawBordersInGroup(h,d,l):p&&this.drawBorders(h,l),m&&this.drawControls(h,l),h.restore()},_setShadow:function(h){if(this.shadow){var l,d=this.shadow,p=this.canvas,m=p&&p.viewportTransform[0]||1,b=p&&p.viewportTransform[3]||1;l=d.nonScaling?{scaleX:1,scaleY:1}:this.getObjectScaling(),p&&p._isRetinaScaling()&&(m*=i.devicePixelRatio,b*=i.devicePixelRatio),h.shadowColor=d.color,h.shadowBlur=d.blur*i.browserShadowBlurConstant*(m+b)*(l.scaleX+l.scaleY)/4,h.shadowOffsetX=d.offsetX*m*l.scaleX,h.shadowOffsetY=d.offsetY*b*l.scaleY}},_removeShadow:function(h){this.shadow&&(h.shadowColor="",h.shadowBlur=h.shadowOffsetX=h.shadowOffsetY=0)},_applyPatternGradientTransform:function(h,l){if(!l||!l.toLive)return{offsetX:0,offsetY:0};var d=l.gradientTransform||l.patternTransform,p=-this.width/2+l.offsetX||0,m=-this.height/2+l.offsetY||0;return l.gradientUnits==="percentage"?h.transform(this.width,0,0,this.height,p,m):h.transform(1,0,0,1,p,m),d&&h.transform(d[0],d[1],d[2],d[3],d[4],d[5]),{offsetX:p,offsetY:m}},_renderPaintInOrder:function(h){this.paintFirst==="stroke"?(this._renderStroke(h),this._renderFill(h)):(this._renderFill(h),this._renderStroke(h))},_render:function(){},_renderFill:function(h){this.fill&&(h.save(),this._setFillStyles(h,this),this.fillRule==="evenodd"?h.fill("evenodd"):h.fill(),h.restore())},_renderStroke:function(h){if(this.stroke&&this.strokeWidth!==0){if(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(h),h.save(),this.strokeUniform&&this.group){var l=this.getObjectScaling();h.scale(1/l.scaleX,1/l.scaleY)}else this.strokeUniform&&h.scale(1/this.scaleX,1/this.scaleY);this._setLineDash(h,this.strokeDashArray),this._setStrokeStyles(h,this),h.stroke(),h.restore()}},_applyPatternForTransformedGradient:function(h,l){var d,p=this._limitCacheSize(this._getCacheCanvasDimensions()),m=i.util.createCanvasElement(),b=this.canvas.getRetinaScaling(),y=p.x/this.scaleX/b,w=p.y/this.scaleY/b;m.width=y,m.height=w,(d=m.getContext("2d")).beginPath(),d.moveTo(0,0),d.lineTo(y,0),d.lineTo(y,w),d.lineTo(0,w),d.closePath(),d.translate(y/2,w/2),d.scale(p.zoomX/this.scaleX/b,p.zoomY/this.scaleY/b),this._applyPatternGradientTransform(d,l),d.fillStyle=l.toLive(h),d.fill(),h.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),h.scale(b*this.scaleX/p.zoomX,b*this.scaleY/p.zoomY),h.strokeStyle=d.createPattern(m,"no-repeat")},_findCenterFromElement:function(){return{x:this.left+this.width/2,y:this.top+this.height/2}},_assignTransformMatrixProps:function(){if(this.transformMatrix){var h=i.util.qrDecompose(this.transformMatrix);this.flipX=!1,this.flipY=!1,this.set("scaleX",h.scaleX),this.set("scaleY",h.scaleY),this.angle=h.angle,this.skewX=h.skewX,this.skewY=0}},_removeTransformMatrix:function(h){var l=this._findCenterFromElement();this.transformMatrix&&(this._assignTransformMatrixProps(),l=i.util.transformPoint(l,this.transformMatrix)),this.transformMatrix=null,h&&(this.scaleX*=h.scaleX,this.scaleY*=h.scaleY,this.cropX=h.cropX,this.cropY=h.cropY,l.x+=h.offsetLeft,l.y+=h.offsetTop,this.width=h.width,this.height=h.height),this.setPositionByOrigin(l,"center","center")},clone:function(h,l){var d=this.toObject(l);this.constructor.fromObject?this.constructor.fromObject(d,h):i.Object._fromObject("Object",d,h)},cloneAsImage:function(h,l){var d=this.toCanvasElement(l);return h&&h(new i.Image(d)),this},toCanvasElement:function(h){h||(h={});var l=i.util,d=l.saveObjectTransform(this),p=this.group,m=this.shadow,b=Math.abs,y=(h.multiplier||1)*(h.enableRetinaScaling?i.devicePixelRatio:1);delete this.group,h.withoutTransform&&l.resetObjectTransform(this),h.withoutShadow&&(this.shadow=null);var w,T,k,P,G=i.util.createCanvasElement(),V=this.getBoundingRect(!0,!0),N=this.shadow,A={x:0,y:0};N&&(T=N.blur,w=N.nonScaling?{scaleX:1,scaleY:1}:this.getObjectScaling(),A.x=2*Math.round(b(N.offsetX)+T)*b(w.scaleX),A.y=2*Math.round(b(N.offsetY)+T)*b(w.scaleY)),k=V.width+A.x,P=V.height+A.y,G.width=Math.ceil(k),G.height=Math.ceil(P);var O=new i.StaticCanvas(G,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1});h.format==="jpeg"&&(O.backgroundColor="#fff"),this.setPositionByOrigin(new i.Point(O.width/2,O.height/2),"center","center");var B=this.canvas;O.add(this);var W=O.toCanvasElement(y||1,h);return this.shadow=m,this.set("canvas",B),p&&(this.group=p),this.set(d).setCoords(),O._objects=[],O.dispose(),O=null,W},toDataURL:function(h){return h||(h={}),i.util.toDataURL(this.toCanvasElement(h),h.format||"png",h.quality||1)},isType:function(h){return arguments.length>1?Array.from(arguments).includes(this.type):this.type===h},complexity:function(){return 1},toJSON:function(h){return this.toObject(h)},rotate:function(h){var l=(this.originX!=="center"||this.originY!=="center")&&this.centeredRotation;return l&&this._setOriginToCenter(),this.set("angle",h),l&&this._resetOrigin(),this},centerH:function(){return this.canvas&&this.canvas.centerObjectH(this),this},viewportCenterH:function(){return this.canvas&&this.canvas.viewportCenterObjectH(this),this},centerV:function(){return this.canvas&&this.canvas.centerObjectV(this),this},viewportCenterV:function(){return this.canvas&&this.canvas.viewportCenterObjectV(this),this},center:function(){return this.canvas&&this.canvas.centerObject(this),this},viewportCenter:function(){return this.canvas&&this.canvas.viewportCenterObject(this),this},getLocalPointer:function(h,l){l=l||this.canvas.getPointer(h);var d=new i.Point(l.x,l.y),p=this._getLeftTopCoords();return this.angle&&(d=i.util.rotatePoint(d,p,s(-this.angle))),{x:d.x-p.x,y:d.y-p.y}},_setupCompositeOperation:function(h){this.globalCompositeOperation&&(h.globalCompositeOperation=this.globalCompositeOperation)},dispose:function(){i.runningAnimations&&i.runningAnimations.cancelByTarget(this)}}),i.util.createAccessors&&i.util.createAccessors(i.Object),n(i.Object.prototype,i.Observable),i.Object.NUM_FRACTION_DIGITS=2,i.Object.ENLIVEN_PROPS=["clipPath"],i.Object._fromObject=function(h,l,d,p){var m=i[h];l=a(l,!0),i.util.enlivenPatterns([l.fill,l.stroke],function(b){b[0]!==void 0&&(l.fill=b[0]),b[1]!==void 0&&(l.stroke=b[1]),i.util.enlivenObjectEnlivables(l,l,function(){var y=p?new m(l[p],l):new m(l);d&&d(y)})})},i.Object.__uid=0)}(o),pe=g.util.degreesToRadians,_e={left:-.5,center:0,right:.5},Se={top:-.5,center:0,bottom:.5},g.util.object.extend(g.Object.prototype,{translateToGivenOrigin:function(r,i,n,a,e){var t,s,c,h=r.x,l=r.y;return typeof i=="string"?i=_e[i]:i-=.5,typeof a=="string"?a=_e[a]:a-=.5,typeof n=="string"?n=Se[n]:n-=.5,typeof e=="string"?e=Se[e]:e-=.5,s=e-n,((t=a-i)||s)&&(c=this._getTransformedDimensions(),h=r.x+t*c.x,l=r.y+s*c.y),new g.Point(h,l)},translateToCenterPoint:function(r,i,n){var a=this.translateToGivenOrigin(r,i,n,"center","center");return this.angle?g.util.rotatePoint(a,r,pe(this.angle)):a},translateToOriginPoint:function(r,i,n){var a=this.translateToGivenOrigin(r,"center","center",i,n);return this.angle?g.util.rotatePoint(a,r,pe(this.angle)):a},getCenterPoint:function(){var r=new g.Point(this.left,this.top);return this.translateToCenterPoint(r,this.originX,this.originY)},getPointByOrigin:function(r,i){var n=this.getCenterPoint();return this.translateToOriginPoint(n,r,i)},toLocalPoint:function(r,i,n){var a,e,t=this.getCenterPoint();return a=i!==void 0&&n!==void 0?this.translateToGivenOrigin(t,"center","center",i,n):new g.Point(this.left,this.top),e=new g.Point(r.x,r.y),this.angle&&(e=g.util.rotatePoint(e,t,-pe(this.angle))),e.subtractEquals(a)},setPositionByOrigin:function(r,i,n){var a=this.translateToCenterPoint(r,i,n),e=this.translateToOriginPoint(a,this.originX,this.originY);this.set("left",e.x),this.set("top",e.y)},adjustPosition:function(r){var i,n,a=pe(this.angle),e=this.getScaledWidth(),t=g.util.cos(a)*e,s=g.util.sin(a)*e;i=typeof this.originX=="string"?_e[this.originX]:this.originX-.5,n=typeof r=="string"?_e[r]:r-.5,this.left+=t*(n-i),this.top+=s*(n-i),this.setCoords(),this.originX=r},_setOriginToCenter:function(){this._originalOriginX=this.originX,this._originalOriginY=this.originY;var r=this.getCenterPoint();this.originX="center",this.originY="center",this.left=r.x,this.top=r.y},_resetOrigin:function(){var r=this.translateToOriginPoint(this.getCenterPoint(),this._originalOriginX,this._originalOriginY);this.originX=this._originalOriginX,this.originY=this._originalOriginY,this.left=r.x,this.top=r.y,this._originalOriginX=null,this._originalOriginY=null},_getLeftTopCoords:function(){return this.translateToOriginPoint(this.getCenterPoint(),"left","top")}}),function(){var r=g.util,i=r.degreesToRadians,n=r.multiplyTransformMatrices,a=r.transformPoint;r.object.extend(g.Object.prototype,{oCoords:null,aCoords:null,lineCoords:null,ownMatrixCache:null,matrixCache:null,controls:{},_getCoords:function(e,t){return t?e?this.calcACoords():this.calcLineCoords():(this.aCoords&&this.lineCoords||this.setCoords(!0),e?this.aCoords:this.lineCoords)},getCoords:function(e,t){return s=this._getCoords(e,t),[new g.Point(s.tl.x,s.tl.y),new g.Point(s.tr.x,s.tr.y),new g.Point(s.br.x,s.br.y),new g.Point(s.bl.x,s.bl.y)];var s},intersectsWithRect:function(e,t,s,c){var h=this.getCoords(s,c);return g.Intersection.intersectPolygonRectangle(h,e,t).status==="Intersection"},intersectsWithObject:function(e,t,s){return g.Intersection.intersectPolygonPolygon(this.getCoords(t,s),e.getCoords(t,s)).status==="Intersection"||e.isContainedWithinObject(this,t,s)||this.isContainedWithinObject(e,t,s)},isContainedWithinObject:function(e,t,s){for(var c=this.getCoords(t,s),h=t?e.aCoords:e.lineCoords,l=0,d=e._getImageLines(h);l<4;l++)if(!e.containsPoint(c[l],d))return!1;return!0},isContainedWithinRect:function(e,t,s,c){var h=this.getBoundingRect(s,c);return h.left>=e.x&&h.left+h.width<=t.x&&h.top>=e.y&&h.top+h.height<=t.y},containsPoint:function(e,t,s,c){var h=this._getCoords(s,c),l=(t=t||this._getImageLines(h),this._findCrossPoints(e,t));return l!==0&&l%2==1},isOnScreen:function(e){if(!this.canvas)return!1;var t=this.canvas.vptCoords.tl,s=this.canvas.vptCoords.br;return!!this.getCoords(!0,e).some(function(c){return c.x<=s.x&&c.x>=t.x&&c.y<=s.y&&c.y>=t.y})||!!this.intersectsWithRect(t,s,!0,e)||this._containsCenterOfCanvas(t,s,e)},_containsCenterOfCanvas:function(e,t,s){var c={x:(e.x+t.x)/2,y:(e.y+t.y)/2};return!!this.containsPoint(c,null,!0,s)},isPartiallyOnScreen:function(e){if(!this.canvas)return!1;var t=this.canvas.vptCoords.tl,s=this.canvas.vptCoords.br;return!!this.intersectsWithRect(t,s,!0,e)||this.getCoords(!0,e).every(function(c){return(c.x>=s.x||c.x<=t.x)&&(c.y>=s.y||c.y<=t.y)})&&this._containsCenterOfCanvas(t,s,e)},_getImageLines:function(e){return{topline:{o:e.tl,d:e.tr},rightline:{o:e.tr,d:e.br},bottomline:{o:e.br,d:e.bl},leftline:{o:e.bl,d:e.tl}}},_findCrossPoints:function(e,t){var s,c,h,l=0;for(var d in t)if(!((h=t[d]).o.y<e.y&&h.d.y<e.y||h.o.y>=e.y&&h.d.y>=e.y||(h.o.x===h.d.x&&h.o.x>=e.x?c=h.o.x:(s=(h.d.y-h.o.y)/(h.d.x-h.o.x),c=-(e.y-0*e.x-(h.o.y-s*h.o.x))/(0-s)),c>=e.x&&(l+=1),l!==2)))break;return l},getBoundingRect:function(e,t){var s=this.getCoords(e,t);return r.makeBoundingBoxFromPoints(s)},getScaledWidth:function(){return this._getTransformedDimensions().x},getScaledHeight:function(){return this._getTransformedDimensions().y},_constrainScale:function(e){return Math.abs(e)<this.minScaleLimit?e<0?-this.minScaleLimit:this.minScaleLimit:e===0?1e-4:e},scale:function(e){return this._set("scaleX",e),this._set("scaleY",e),this.setCoords()},scaleToWidth:function(e,t){var s=this.getBoundingRect(t).width/this.getScaledWidth();return this.scale(e/this.width/s)},scaleToHeight:function(e,t){var s=this.getBoundingRect(t).height/this.getScaledHeight();return this.scale(e/this.height/s)},calcLineCoords:function(){var e=this.getViewportTransform(),t=this.padding,s=i(this.angle),c=r.cos(s)*t,h=r.sin(s)*t,l=c+h,d=c-h,p=this.calcACoords(),m={tl:a(p.tl,e),tr:a(p.tr,e),bl:a(p.bl,e),br:a(p.br,e)};return t&&(m.tl.x-=d,m.tl.y-=l,m.tr.x+=l,m.tr.y-=d,m.bl.x-=l,m.bl.y+=d,m.br.x+=d,m.br.y+=l),m},calcOCoords:function(){var e=this._calcRotateMatrix(),t=this._calcTranslateMatrix(),s=this.getViewportTransform(),c=n(s,t),h=n(c,e),l=(h=n(h,[1/s[0],0,0,1/s[3],0,0]),this._calculateCurrentDimensions()),d={};return this.forEachControl(function(p,m,b){d[m]=p.positionHandler(l,h,b)}),d},calcACoords:function(){var e=this._calcRotateMatrix(),t=this._calcTranslateMatrix(),s=n(t,e),c=this._getTransformedDimensions(),h=c.x/2,l=c.y/2;return{tl:a({x:-h,y:-l},s),tr:a({x:h,y:-l},s),bl:a({x:-h,y:l},s),br:a({x:h,y:l},s)}},setCoords:function(e){return this.aCoords=this.calcACoords(),this.lineCoords=this.group?this.aCoords:this.calcLineCoords(),e||(this.oCoords=this.calcOCoords(),this._setCornerCoords&&this._setCornerCoords()),this},_calcRotateMatrix:function(){return r.calcRotateMatrix(this)},_calcTranslateMatrix:function(){var e=this.getCenterPoint();return[1,0,0,1,e.x,e.y]},transformMatrixKey:function(e){var t="_",s="";return!e&&this.group&&(s=this.group.transformMatrixKey(e)+t),s+this.top+t+this.left+t+this.scaleX+t+this.scaleY+t+this.skewX+t+this.skewY+t+this.angle+t+this.originX+t+this.originY+t+this.width+t+this.height+t+this.strokeWidth+this.flipX+this.flipY},calcTransformMatrix:function(e){var t=this.calcOwnMatrix();if(e||!this.group)return t;var s=this.transformMatrixKey(e),c=this.matrixCache||(this.matrixCache={});return c.key===s?c.value:(this.group&&(t=n(this.group.calcTransformMatrix(!1),t)),c.key=s,c.value=t,t)},calcOwnMatrix:function(){var e=this.transformMatrixKey(!0),t=this.ownMatrixCache||(this.ownMatrixCache={});if(t.key===e)return t.value;var s=this._calcTranslateMatrix(),c={angle:this.angle,translateX:s[4],translateY:s[5],scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,flipX:this.flipX,flipY:this.flipY};return t.key=e,t.value=r.composeMatrix(c),t.value},_getNonTransformedDimensions:function(){var e=this.strokeWidth;return{x:this.width+e,y:this.height+e}},_getTransformedDimensions:function(e,t){e===void 0&&(e=this.skewX),t===void 0&&(t=this.skewY);var s,c,h,l=e===0&&t===0;if(this.strokeUniform?(c=this.width,h=this.height):(c=(s=this._getNonTransformedDimensions()).x,h=s.y),l)return this._finalizeDimensions(c*this.scaleX,h*this.scaleY);var d=r.sizeAfterTransform(c,h,{scaleX:this.scaleX,scaleY:this.scaleY,skewX:e,skewY:t});return this._finalizeDimensions(d.x,d.y)},_finalizeDimensions:function(e,t){return this.strokeUniform?{x:e+this.strokeWidth,y:t+this.strokeWidth}:{x:e,y:t}},_calculateCurrentDimensions:function(){var e=this.getViewportTransform(),t=this._getTransformedDimensions();return a(t,e,!0).scalarAdd(2*this.padding)}})}(),g.util.object.extend(g.Object.prototype,{sendToBack:function(){return this.group?g.StaticCanvas.prototype.sendToBack.call(this.group,this):this.canvas&&this.canvas.sendToBack(this),this},bringToFront:function(){return this.group?g.StaticCanvas.prototype.bringToFront.call(this.group,this):this.canvas&&this.canvas.bringToFront(this),this},sendBackwards:function(r){return this.group?g.StaticCanvas.prototype.sendBackwards.call(this.group,this,r):this.canvas&&this.canvas.sendBackwards(this,r),this},bringForward:function(r){return this.group?g.StaticCanvas.prototype.bringForward.call(this.group,this,r):this.canvas&&this.canvas.bringForward(this,r),this},moveTo:function(r){return this.group&&this.group.type!=="activeSelection"?g.StaticCanvas.prototype.moveTo.call(this.group,this,r):this.canvas&&this.canvas.moveTo(this,r),this}}),function(){function r(n,a){if(a){if(a.toLive)return n+": url(#SVGID_"+a.id+"); ";var e=new g.Color(a),t=n+": "+e.toRgb()+"; ",s=e.getAlpha();return s!==1&&(t+=n+"-opacity: "+s.toString()+"; "),t}return n+": none; "}var i=g.util.toFixed;g.util.object.extend(g.Object.prototype,{getSvgStyles:function(n){var a=this.fillRule?this.fillRule:"nonzero",e=this.strokeWidth?this.strokeWidth:"0",t=this.strokeDashArray?this.strokeDashArray.join(" "):"none",s=this.strokeDashOffset?this.strokeDashOffset:"0",c=this.strokeLineCap?this.strokeLineCap:"butt",h=this.strokeLineJoin?this.strokeLineJoin:"miter",l=this.strokeMiterLimit?this.strokeMiterLimit:"4",d=this.opacity!==void 0?this.opacity:"1",p=this.visible?"":" visibility: hidden;",m=n?"":this.getSvgFilter(),b=r("fill",this.fill);return[r("stroke",this.stroke),"stroke-width: ",e,"; ","stroke-dasharray: ",t,"; ","stroke-linecap: ",c,"; ","stroke-dashoffset: ",s,"; ","stroke-linejoin: ",h,"; ","stroke-miterlimit: ",l,"; ",b,"fill-rule: ",a,"; ","opacity: ",d,";",m,p].join("")},getSvgSpanStyles:function(n,a){var e="; ",t=n.fontFamily?"font-family: "+(n.fontFamily.indexOf("'")===-1&&n.fontFamily.indexOf('"')===-1?"'"+n.fontFamily+"'":n.fontFamily)+e:"",s=n.strokeWidth?"stroke-width: "+n.strokeWidth+e:"",c=n.fontSize?"font-size: "+n.fontSize+"px"+e:"",h=n.fontStyle?"font-style: "+n.fontStyle+e:"",l=n.fontWeight?"font-weight: "+n.fontWeight+e:"",d=n.fill?r("fill",n.fill):"",p=n.stroke?r("stroke",n.stroke):"",m=this.getSvgTextDecoration(n);return m&&(m="text-decoration: "+m+e),[p,s,t,c,h,l,m,d,n.deltaY?"baseline-shift: "+-n.deltaY+"; ":"",a?"white-space: pre; ":""].join("")},getSvgTextDecoration:function(n){return["overline","underline","line-through"].filter(function(a){return n[a.replace("-","")]}).join(" ")},getSvgFilter:function(){return this.shadow?"filter: url(#SVGID_"+this.shadow.id+");":""},getSvgCommons:function(){return[this.id?'id="'+this.id+'" ':"",this.clipPath?'clip-path="url(#'+this.clipPath.clipPathId+')" ':""].join("")},getSvgTransform:function(n,a){var e=n?this.calcTransformMatrix():this.calcOwnMatrix();return'transform="'+g.util.matrixToSVG(e)+(a||"")+'" '},_setSVGBg:function(n){if(this.backgroundColor){var a=g.Object.NUM_FRACTION_DIGITS;n.push("		<rect ",this._getFillAttributes(this.backgroundColor),' x="',i(-this.width/2,a),'" y="',i(-this.height/2,a),'" width="',i(this.width,a),'" height="',i(this.height,a),'"></rect>\n')}},toSVG:function(n){return this._createBaseSVGMarkup(this._toSVG(n),{reviver:n})},toClipPathSVG:function(n){return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(n),{reviver:n})},_createBaseClipPathSVGMarkup:function(n,a){var e=(a=a||{}).reviver,t=a.additionalTransform||"",s=[this.getSvgTransform(!0,t),this.getSvgCommons()].join(""),c=n.indexOf("COMMON_PARTS");return n[c]=s,e?e(n.join("")):n.join("")},_createBaseSVGMarkup:function(n,a){var e,t,s=(a=a||{}).noStyle,c=a.reviver,h=s?"":'style="'+this.getSvgStyles()+'" ',l=a.withShadow?'style="'+this.getSvgFilter()+'" ':"",d=this.clipPath,p=this.strokeUniform?'vector-effect="non-scaling-stroke" ':"",m=d&&d.absolutePositioned,b=this.stroke,y=this.fill,w=this.shadow,T=[],k=n.indexOf("COMMON_PARTS"),P=a.additionalTransform;return d&&(d.clipPathId="CLIPPATH_"+g.Object.__uid++,t='<clipPath id="'+d.clipPathId+'" >\n'+d.toClipPathSVG(c)+"</clipPath>\n"),m&&T.push("<g ",l,this.getSvgCommons()," >\n"),T.push("<g ",this.getSvgTransform(!1),m?"":l+this.getSvgCommons()," >\n"),e=[h,p,s?"":this.addPaintOrder()," ",P?'transform="'+P+'" ':""].join(""),n[k]=e,y&&y.toLive&&T.push(y.toSVG(this)),b&&b.toLive&&T.push(b.toSVG(this)),w&&T.push(w.toSVG(this)),d&&T.push(t),T.push(n.join("")),T.push("</g>\n"),m&&T.push("</g>\n"),c?c(T.join("")):T.join("")},addPaintOrder:function(){return this.paintFirst!=="fill"?' paint-order="'+this.paintFirst+'" ':""}})}(),function(){var r=g.util.object.extend,i="stateProperties";function n(e,t,s){var c={};s.forEach(function(h){c[h]=e[h]}),r(e[t],c,!0)}function a(e,t,s){if(e===t)return!0;if(Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return!1;for(var c=0,h=e.length;c<h;c++)if(!a(e[c],t[c]))return!1;return!0}if(e&&typeof e=="object"){var l,d=Object.keys(e);if(!t||typeof t!="object"||!s&&d.length!==Object.keys(t).length)return!1;for(c=0,h=d.length;c<h;c++)if((l=d[c])!=="canvas"&&l!=="group"&&!a(e[l],t[l]))return!1;return!0}}g.util.object.extend(g.Object.prototype,{hasStateChanged:function(e){var t="_"+(e=e||i);return Object.keys(this[t]).length<this[e].length||!a(this[t],this,!0)},saveState:function(e){var t=e&&e.propertySet||i,s="_"+t;return this[s]?(n(this,s,this[t]),e&&e.stateProperties&&n(this,s,e.stateProperties),this):this.setupState(e)},setupState:function(e){var t=(e=e||{}).propertySet||i;return e.propertySet=t,this["_"+t]={},this.saveState(e),this}})}(),function(){var r=g.util.degreesToRadians;g.util.object.extend(g.Object.prototype,{_findTargetCorner:function(i,n){if(!this.hasControls||this.group||!this.canvas||this.canvas._activeObject!==this)return!1;var a,e,t,s=i.x,c=i.y,h=Object.keys(this.oCoords),l=h.length-1;for(this.__corner=0;l>=0;l--)if(t=h[l],this.isControlVisible(t)&&(e=this._getImageLines(n?this.oCoords[t].touchCorner:this.oCoords[t].corner),(a=this._findCrossPoints({x:s,y:c},e))!==0&&a%2==1))return this.__corner=t,t;return!1},forEachControl:function(i){for(var n in this.controls)i(this.controls[n],n,this)},_setCornerCoords:function(){var i=this.oCoords;for(var n in i){var a=this.controls[n];i[n].corner=a.calcCornerCoords(this.angle,this.cornerSize,i[n].x,i[n].y,!1),i[n].touchCorner=a.calcCornerCoords(this.angle,this.touchCornerSize,i[n].x,i[n].y,!0)}},drawSelectionBackground:function(i){if(!this.selectionBackgroundColor||this.canvas&&!this.canvas.interactive||this.canvas&&this.canvas._activeObject!==this)return this;i.save();var n=this.getCenterPoint(),a=this._calculateCurrentDimensions(),e=this.canvas.viewportTransform;return i.translate(n.x,n.y),i.scale(1/e[0],1/e[3]),i.rotate(r(this.angle)),i.fillStyle=this.selectionBackgroundColor,i.fillRect(-a.x/2,-a.y/2,a.x,a.y),i.restore(),this},drawBorders:function(i,n){n=n||{};var a=this._calculateCurrentDimensions(),e=this.borderScaleFactor,t=a.x+e,s=a.y+e,c=n.hasControls!==void 0?n.hasControls:this.hasControls,h=!1;return i.save(),i.strokeStyle=n.borderColor||this.borderColor,this._setLineDash(i,n.borderDashArray||this.borderDashArray),i.strokeRect(-t/2,-s/2,t,s),c&&(i.beginPath(),this.forEachControl(function(l,d,p){l.withConnection&&l.getVisibility(p,d)&&(h=!0,i.moveTo(l.x*t,l.y*s),i.lineTo(l.x*t+l.offsetX,l.y*s+l.offsetY))}),h&&i.stroke()),i.restore(),this},drawBordersInGroup:function(i,n,a){a=a||{};var e=g.util.sizeAfterTransform(this.width,this.height,n),t=this.strokeWidth,s=this.strokeUniform,c=this.borderScaleFactor,h=e.x+t*(s?this.canvas.getZoom():n.scaleX)+c,l=e.y+t*(s?this.canvas.getZoom():n.scaleY)+c;return i.save(),this._setLineDash(i,a.borderDashArray||this.borderDashArray),i.strokeStyle=a.borderColor||this.borderColor,i.strokeRect(-h/2,-l/2,h,l),i.restore(),this},drawControls:function(i,n){n=n||{},i.save();var a,e,t=this.canvas.getRetinaScaling();return i.setTransform(t,0,0,t,0,0),i.strokeStyle=i.fillStyle=n.cornerColor||this.cornerColor,this.transparentCorners||(i.strokeStyle=n.cornerStrokeColor||this.cornerStrokeColor),this._setLineDash(i,n.cornerDashArray||this.cornerDashArray),this.setCoords(),this.group&&(a=this.group.calcTransformMatrix()),this.forEachControl(function(s,c,h){e=h.oCoords[c],s.getVisibility(h,c)&&(a&&(e=g.util.transformPoint(e,a)),s.render(i,e.x,e.y,n,h))}),i.restore(),this},isControlVisible:function(i){return this.controls[i]&&this.controls[i].getVisibility(this,i)},setControlVisible:function(i,n){return this._controlsVisibility||(this._controlsVisibility={}),this._controlsVisibility[i]=n,this},setControlsVisibility:function(i){for(var n in i||(i={}),i)this.setControlVisible(n,i[n]);return this},onDeselect:function(){},onSelect:function(){}})}(),g.util.object.extend(g.StaticCanvas.prototype,{FX_DURATION:500,fxCenterObjectH:function(r,i){var n=function(){},a=(i=i||{}).onComplete||n,e=i.onChange||n,t=this;return g.util.animate({target:this,startValue:r.left,endValue:this.getCenterPoint().x,duration:this.FX_DURATION,onChange:function(s){r.set("left",s),t.requestRenderAll(),e()},onComplete:function(){r.setCoords(),a()}})},fxCenterObjectV:function(r,i){var n=function(){},a=(i=i||{}).onComplete||n,e=i.onChange||n,t=this;return g.util.animate({target:this,startValue:r.top,endValue:this.getCenterPoint().y,duration:this.FX_DURATION,onChange:function(s){r.set("top",s),t.requestRenderAll(),e()},onComplete:function(){r.setCoords(),a()}})},fxRemove:function(r,i){var n=function(){},a=(i=i||{}).onComplete||n,e=i.onChange||n,t=this;return g.util.animate({target:this,startValue:r.opacity,endValue:0,duration:this.FX_DURATION,onChange:function(s){r.set("opacity",s),t.requestRenderAll(),e()},onComplete:function(){t.remove(r),a()}})}}),g.util.object.extend(g.Object.prototype,{animate:function(){if(arguments[0]&&typeof arguments[0]=="object"){var r,i,n=[],a=[];for(r in arguments[0])n.push(r);for(var e=0,t=n.length;e<t;e++)r=n[e],i=e!==t-1,a.push(this._animate(r,arguments[0][r],arguments[1],i));return a}return this._animate.apply(this,arguments)},_animate:function(r,i,n,a){var e,t=this;i=i.toString(),n=n?g.util.object.clone(n):{},~r.indexOf(".")&&(e=r.split("."));var s=t.colorProperties.indexOf(r)>-1||e&&t.colorProperties.indexOf(e[1])>-1,c=e?this.get(e[0])[e[1]]:this.get(r);"from"in n||(n.from=c),s||(i=~i.indexOf("=")?c+parseFloat(i.replace("=","")):parseFloat(i));var h={target:this,startValue:n.from,endValue:i,byValue:n.by,easing:n.easing,duration:n.duration,abort:n.abort&&function(l,d,p){return n.abort.call(t,l,d,p)},onChange:function(l,d,p){e?t[e[0]][e[1]]=l:t.set(r,l),a||n.onChange&&n.onChange(l,d,p)},onComplete:function(l,d,p){a||(t.setCoords(),n.onComplete&&n.onComplete(l,d,p))}};return s?g.util.animateColor(h.startValue,h.endValue,h.duration,h):g.util.animate(h)}}),function(r){var i=r.fabric||(r.fabric={}),n=i.util.object.extend,a=i.util.object.clone,e={x1:1,x2:1,y1:1,y2:1};function t(s,c){var h=s.origin,l=s.axis1,d=s.axis2,p=s.dimension,m=c.nearest,b=c.center,y=c.farthest;return function(){switch(this.get(h)){case m:return Math.min(this.get(l),this.get(d));case b:return Math.min(this.get(l),this.get(d))+.5*this.get(p);case y:return Math.max(this.get(l),this.get(d))}}}i.Line?i.warn("fabric.Line is already defined"):(i.Line=i.util.createClass(i.Object,{type:"line",x1:0,y1:0,x2:0,y2:0,cacheProperties:i.Object.prototype.cacheProperties.concat("x1","x2","y1","y2"),initialize:function(s,c){s||(s=[0,0,0,0]),this.callSuper("initialize",c),this.set("x1",s[0]),this.set("y1",s[1]),this.set("x2",s[2]),this.set("y2",s[3]),this._setWidthHeight(c)},_setWidthHeight:function(s){s||(s={}),this.width=Math.abs(this.x2-this.x1),this.height=Math.abs(this.y2-this.y1),this.left="left"in s?s.left:this._getLeftToOriginX(),this.top="top"in s?s.top:this._getTopToOriginY()},_set:function(s,c){return this.callSuper("_set",s,c),e[s]!==void 0&&this._setWidthHeight(),this},_getLeftToOriginX:t({origin:"originX",axis1:"x1",axis2:"x2",dimension:"width"},{nearest:"left",center:"center",farthest:"right"}),_getTopToOriginY:t({origin:"originY",axis1:"y1",axis2:"y2",dimension:"height"},{nearest:"top",center:"center",farthest:"bottom"}),_render:function(s){s.beginPath();var c=this.calcLinePoints();s.moveTo(c.x1,c.y1),s.lineTo(c.x2,c.y2),s.lineWidth=this.strokeWidth;var h=s.strokeStyle;s.strokeStyle=this.stroke||s.fillStyle,this.stroke&&this._renderStroke(s),s.strokeStyle=h},_findCenterFromElement:function(){return{x:(this.x1+this.x2)/2,y:(this.y1+this.y2)/2}},toObject:function(s){return n(this.callSuper("toObject",s),this.calcLinePoints())},_getNonTransformedDimensions:function(){var s=this.callSuper("_getNonTransformedDimensions");return this.strokeLineCap==="butt"&&(this.width===0&&(s.y-=this.strokeWidth),this.height===0&&(s.x-=this.strokeWidth)),s},calcLinePoints:function(){var s=this.x1<=this.x2?-1:1,c=this.y1<=this.y2?-1:1,h=s*this.width*.5,l=c*this.height*.5;return{x1:h,x2:s*this.width*-.5,y1:l,y2:c*this.height*-.5}},_toSVG:function(){var s=this.calcLinePoints();return["<line ","COMMON_PARTS",'x1="',s.x1,'" y1="',s.y1,'" x2="',s.x2,'" y2="',s.y2,'" />\n']}}),i.Line.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("x1 y1 x2 y2".split(" ")),i.Line.fromElement=function(s,c,h){h=h||{};var l=i.parseAttributes(s,i.Line.ATTRIBUTE_NAMES),d=[l.x1||0,l.y1||0,l.x2||0,l.y2||0];c(new i.Line(d,n(l,h)))},i.Line.fromObject=function(s,c){var h=a(s,!0);h.points=[s.x1,s.y1,s.x2,s.y2],i.Object._fromObject("Line",h,function(l){delete l.points,c&&c(l)},"points")})}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.util.degreesToRadians;i.Circle?i.warn("fabric.Circle is already defined."):(i.Circle=i.util.createClass(i.Object,{type:"circle",radius:0,startAngle:0,endAngle:360,cacheProperties:i.Object.prototype.cacheProperties.concat("radius","startAngle","endAngle"),_set:function(a,e){return this.callSuper("_set",a,e),a==="radius"&&this.setRadius(e),this},toObject:function(a){return this.callSuper("toObject",["radius","startAngle","endAngle"].concat(a))},_toSVG:function(){var a,e=(this.endAngle-this.startAngle)%360;if(e===0)a=["<circle ","COMMON_PARTS",'cx="0" cy="0" ','r="',this.radius,'" />\n'];else{var t=n(this.startAngle),s=n(this.endAngle),c=this.radius;a=['<path d="M '+i.util.cos(t)*c+" "+i.util.sin(t)*c," A "+c+" "+c," 0 ",+(e>180?"1":"0")+" 1"," "+i.util.cos(s)*c+" "+i.util.sin(s)*c,'" ',"COMMON_PARTS"," />\n"]}return a},_render:function(a){a.beginPath(),a.arc(0,0,this.radius,n(this.startAngle),n(this.endAngle),!1),this._renderPaintInOrder(a)},getRadiusX:function(){return this.get("radius")*this.get("scaleX")},getRadiusY:function(){return this.get("radius")*this.get("scaleY")},setRadius:function(a){return this.radius=a,this.set("width",2*a).set("height",2*a)}}),i.Circle.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("cx cy r".split(" ")),i.Circle.fromElement=function(a,e){var t,s=i.parseAttributes(a,i.Circle.ATTRIBUTE_NAMES);if(!("radius"in(t=s)&&t.radius>=0))throw new Error("value of `r` attribute is required and can not be negative");s.left=(s.left||0)-s.radius,s.top=(s.top||0)-s.radius,e(new i.Circle(s))},i.Circle.fromObject=function(a,e){i.Object._fromObject("Circle",a,e)})}(o),function(r){var i=r.fabric||(r.fabric={});i.Triangle?i.warn("fabric.Triangle is already defined"):(i.Triangle=i.util.createClass(i.Object,{type:"triangle",width:100,height:100,_render:function(n){var a=this.width/2,e=this.height/2;n.beginPath(),n.moveTo(-a,e),n.lineTo(0,-e),n.lineTo(a,e),n.closePath(),this._renderPaintInOrder(n)},_toSVG:function(){var n=this.width/2,a=this.height/2;return["<polygon ","COMMON_PARTS",'points="',[-n+" "+a,"0 "+-a,n+" "+a].join(","),'" />']}}),i.Triangle.fromObject=function(n,a){return i.Object._fromObject("Triangle",n,a)})}(o),function(r){var i=r.fabric||(r.fabric={}),n=2*Math.PI;i.Ellipse?i.warn("fabric.Ellipse is already defined."):(i.Ellipse=i.util.createClass(i.Object,{type:"ellipse",rx:0,ry:0,cacheProperties:i.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(a){this.callSuper("initialize",a),this.set("rx",a&&a.rx||0),this.set("ry",a&&a.ry||0)},_set:function(a,e){switch(this.callSuper("_set",a,e),a){case"rx":this.rx=e,this.set("width",2*e);break;case"ry":this.ry=e,this.set("height",2*e)}return this},getRx:function(){return this.get("rx")*this.get("scaleX")},getRy:function(){return this.get("ry")*this.get("scaleY")},toObject:function(a){return this.callSuper("toObject",["rx","ry"].concat(a))},_toSVG:function(){return["<ellipse ","COMMON_PARTS",'cx="0" cy="0" ','rx="',this.rx,'" ry="',this.ry,'" />\n']},_render:function(a){a.beginPath(),a.save(),a.transform(1,0,0,this.ry/this.rx,0,0),a.arc(0,0,this.rx,0,n,!1),a.restore(),this._renderPaintInOrder(a)}}),i.Ellipse.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("cx cy rx ry".split(" ")),i.Ellipse.fromElement=function(a,e){var t=i.parseAttributes(a,i.Ellipse.ATTRIBUTE_NAMES);t.left=(t.left||0)-t.rx,t.top=(t.top||0)-t.ry,e(new i.Ellipse(t))},i.Ellipse.fromObject=function(a,e){i.Object._fromObject("Ellipse",a,e)})}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.util.object.extend;i.Rect?i.warn("fabric.Rect is already defined"):(i.Rect=i.util.createClass(i.Object,{stateProperties:i.Object.prototype.stateProperties.concat("rx","ry"),type:"rect",rx:0,ry:0,cacheProperties:i.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(a){this.callSuper("initialize",a),this._initRxRy()},_initRxRy:function(){this.rx&&!this.ry?this.ry=this.rx:this.ry&&!this.rx&&(this.rx=this.ry)},_render:function(a){var e=this.rx?Math.min(this.rx,this.width/2):0,t=this.ry?Math.min(this.ry,this.height/2):0,s=this.width,c=this.height,h=-this.width/2,l=-this.height/2,d=e!==0||t!==0,p=.4477152502;a.beginPath(),a.moveTo(h+e,l),a.lineTo(h+s-e,l),d&&a.bezierCurveTo(h+s-p*e,l,h+s,l+p*t,h+s,l+t),a.lineTo(h+s,l+c-t),d&&a.bezierCurveTo(h+s,l+c-p*t,h+s-p*e,l+c,h+s-e,l+c),a.lineTo(h+e,l+c),d&&a.bezierCurveTo(h+p*e,l+c,h,l+c-p*t,h,l+c-t),a.lineTo(h,l+t),d&&a.bezierCurveTo(h,l+p*t,h+p*e,l,h+e,l),a.closePath(),this._renderPaintInOrder(a)},toObject:function(a){return this.callSuper("toObject",["rx","ry"].concat(a))},_toSVG:function(){return["<rect ","COMMON_PARTS",'x="',-this.width/2,'" y="',-this.height/2,'" rx="',this.rx,'" ry="',this.ry,'" width="',this.width,'" height="',this.height,'" />\n']}}),i.Rect.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("x y rx ry width height".split(" ")),i.Rect.fromElement=function(a,e,t){if(!a)return e(null);t=t||{};var s=i.parseAttributes(a,i.Rect.ATTRIBUTE_NAMES);s.left=s.left||0,s.top=s.top||0,s.height=s.height||0,s.width=s.width||0;var c=new i.Rect(n(t?i.util.object.clone(t):{},s));c.visible=c.visible&&c.width>0&&c.height>0,e(c)},i.Rect.fromObject=function(a,e){return i.Object._fromObject("Rect",a,e)})}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.util.object.extend,a=i.util.array.min,e=i.util.array.max,t=i.util.toFixed,s=i.util.projectStrokeOnPoints;i.Polyline?i.warn("fabric.Polyline is already defined"):(i.Polyline=i.util.createClass(i.Object,{type:"polyline",points:null,exactBoundingBox:!1,cacheProperties:i.Object.prototype.cacheProperties.concat("points"),initialize:function(c,h){h=h||{},this.points=c||[],this.callSuper("initialize",h),this._setPositionDimensions(h)},_projectStrokeOnPoints:function(){return s(this.points,this,!0)},_setPositionDimensions:function(c){var h,l=this._calcDimensions(c),d=this.exactBoundingBox?this.strokeWidth:0;this.width=l.width-d,this.height=l.height-d,c.fromSVG||(h=this.translateToGivenOrigin({x:l.left-this.strokeWidth/2+d/2,y:l.top-this.strokeWidth/2+d/2},"left","top",this.originX,this.originY)),c.left===void 0&&(this.left=c.fromSVG?l.left:h.x),c.top===void 0&&(this.top=c.fromSVG?l.top:h.y),this.pathOffset={x:l.left+this.width/2+d/2,y:l.top+this.height/2+d/2}},_calcDimensions:function(){var c=this.exactBoundingBox?this._projectStrokeOnPoints():this.points,h=a(c,"x")||0,l=a(c,"y")||0;return{left:h,top:l,width:(e(c,"x")||0)-h,height:(e(c,"y")||0)-l}},toObject:function(c){return n(this.callSuper("toObject",c),{points:this.points.concat()})},_toSVG:function(){for(var c=[],h=this.pathOffset.x,l=this.pathOffset.y,d=i.Object.NUM_FRACTION_DIGITS,p=0,m=this.points.length;p<m;p++)c.push(t(this.points[p].x-h,d),",",t(this.points[p].y-l,d)," ");return["<"+this.type+" ","COMMON_PARTS",'points="',c.join(""),'" />\n']},commonRender:function(c){var h,l=this.points.length,d=this.pathOffset.x,p=this.pathOffset.y;if(!l||isNaN(this.points[l-1].y))return!1;c.beginPath(),c.moveTo(this.points[0].x-d,this.points[0].y-p);for(var m=0;m<l;m++)h=this.points[m],c.lineTo(h.x-d,h.y-p);return!0},_render:function(c){this.commonRender(c)&&this._renderPaintInOrder(c)},complexity:function(){return this.get("points").length}}),i.Polyline.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat(),i.Polyline.fromElementGenerator=function(c){return function(h,l,d){if(!h)return l(null);d||(d={});var p=i.parsePointsAttribute(h.getAttribute("points")),m=i.parseAttributes(h,i[c].ATTRIBUTE_NAMES);m.fromSVG=!0,l(new i[c](p,n(m,d)))}},i.Polyline.fromElement=i.Polyline.fromElementGenerator("Polyline"),i.Polyline.fromObject=function(c,h){return i.Object._fromObject("Polyline",c,h,"points")})}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.util.projectStrokeOnPoints;i.Polygon?i.warn("fabric.Polygon is already defined"):(i.Polygon=i.util.createClass(i.Polyline,{type:"polygon",_projectStrokeOnPoints:function(){return n(this.points,this)},_render:function(a){this.commonRender(a)&&(a.closePath(),this._renderPaintInOrder(a))}}),i.Polygon.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat(),i.Polygon.fromElement=i.Polyline.fromElementGenerator("Polygon"),i.Polygon.fromObject=function(a,e){i.Object._fromObject("Polygon",a,e,"points")})}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.util.array.min,a=i.util.array.max,e=i.util.object.extend,t=i.util.object.clone,s=i.util.toFixed;i.Path?i.warn("fabric.Path is already defined"):(i.Path=i.util.createClass(i.Object,{type:"path",path:null,cacheProperties:i.Object.prototype.cacheProperties.concat("path","fillRule"),stateProperties:i.Object.prototype.stateProperties.concat("path"),initialize:function(c,h){delete(h=t(h||{})).path,this.callSuper("initialize",h),this._setPath(c||[],h)},_setPath:function(c,h){this.path=i.util.makePathSimpler(Array.isArray(c)?c:i.util.parsePath(c)),i.Polyline.prototype._setPositionDimensions.call(this,h||{})},_renderPathCommands:function(c){var h,l=0,d=0,p=0,m=0,b=0,y=0,w=-this.pathOffset.x,T=-this.pathOffset.y;c.beginPath();for(var k=0,P=this.path.length;k<P;++k)switch((h=this.path[k])[0]){case"L":p=h[1],m=h[2],c.lineTo(p+w,m+T);break;case"M":l=p=h[1],d=m=h[2],c.moveTo(p+w,m+T);break;case"C":p=h[5],m=h[6],b=h[3],y=h[4],c.bezierCurveTo(h[1]+w,h[2]+T,b+w,y+T,p+w,m+T);break;case"Q":c.quadraticCurveTo(h[1]+w,h[2]+T,h[3]+w,h[4]+T),p=h[3],m=h[4],b=h[1],y=h[2];break;case"z":case"Z":p=l,m=d,c.closePath()}},_render:function(c){this._renderPathCommands(c),this._renderPaintInOrder(c)},toString:function(){return"#<fabric.Path ("+this.complexity()+'): { "top": '+this.top+', "left": '+this.left+" }>"},toObject:function(c){return e(this.callSuper("toObject",c),{path:this.path.map(function(h){return h.slice()})})},toDatalessObject:function(c){var h=this.toObject(["sourcePath"].concat(c));return h.sourcePath&&delete h.path,h},_toSVG:function(){return["<path ","COMMON_PARTS",'d="',i.util.joinPath(this.path),'" stroke-linecap="round" ',"/>\n"]},_getOffsetTransform:function(){var c=i.Object.NUM_FRACTION_DIGITS;return" translate("+s(-this.pathOffset.x,c)+", "+s(-this.pathOffset.y,c)+")"},toClipPathSVG:function(c){var h=this._getOffsetTransform();return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(),{reviver:c,additionalTransform:h})},toSVG:function(c){var h=this._getOffsetTransform();return this._createBaseSVGMarkup(this._toSVG(),{reviver:c,additionalTransform:h})},complexity:function(){return this.path.length},_calcDimensions:function(){for(var c,h,l=[],d=[],p=0,m=0,b=0,y=0,w=0,T=this.path.length;w<T;++w){switch((c=this.path[w])[0]){case"L":b=c[1],y=c[2],h=[];break;case"M":p=b=c[1],m=y=c[2],h=[];break;case"C":h=i.util.getBoundsOfCurve(b,y,c[1],c[2],c[3],c[4],c[5],c[6]),b=c[5],y=c[6];break;case"Q":h=i.util.getBoundsOfCurve(b,y,c[1],c[2],c[1],c[2],c[3],c[4]),b=c[3],y=c[4];break;case"z":case"Z":b=p,y=m}h.forEach(function(G){l.push(G.x),d.push(G.y)}),l.push(b),d.push(y)}var k=n(l)||0,P=n(d)||0;return{left:k,top:P,width:(a(l)||0)-k,height:(a(d)||0)-P}}}),i.Path.fromObject=function(c,h){if(typeof c.sourcePath=="string"){var l=c.sourcePath;i.loadSVGFromURL(l,function(d){var p=d[0];p.setOptions(c),h&&h(p)})}else i.Object._fromObject("Path",c,h,"path")},i.Path.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat(["d"]),i.Path.fromElement=function(c,h,l){var d=i.parseAttributes(c,i.Path.ATTRIBUTE_NAMES);d.fromSVG=!0,h(new i.Path(d.d,e(d,l)))})}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.util.array.min,a=i.util.array.max;i.Group||(i.Group=i.util.createClass(i.Object,i.Collection,{type:"group",strokeWidth:0,subTargetCheck:!1,cacheProperties:[],useSetOnGroup:!1,initialize:function(e,t,s){t=t||{},this._objects=[],s&&this.callSuper("initialize",t),this._objects=e||[];for(var c=this._objects.length;c--;)this._objects[c].group=this;if(s)this._updateObjectsACoords();else{var h=t&&t.centerPoint;t.originX!==void 0&&(this.originX=t.originX),t.originY!==void 0&&(this.originY=t.originY),h||this._calcBounds(),this._updateObjectsCoords(h),delete t.centerPoint,this.callSuper("initialize",t)}this.setCoords()},_updateObjectsACoords:function(){for(var e=this._objects.length;e--;)this._objects[e].setCoords(!0)},_updateObjectsCoords:function(e){e=e||this.getCenterPoint();for(var t=this._objects.length;t--;)this._updateObjectCoords(this._objects[t],e)},_updateObjectCoords:function(e,t){var s=e.left,c=e.top;e.set({left:s-t.x,top:c-t.y}),e.group=this,e.setCoords(!0)},toString:function(){return"#<fabric.Group: ("+this.complexity()+")>"},addWithUpdate:function(e){var t=!!this.group;return this._restoreObjectsState(),i.util.resetObjectTransform(this),e&&(t&&i.util.removeTransformFromObject(e,this.group.calcTransformMatrix()),this._objects.push(e),e.group=this,e._set("canvas",this.canvas)),this._calcBounds(),this._updateObjectsCoords(),this.dirty=!0,t?this.group.addWithUpdate():this.setCoords(),this},removeWithUpdate:function(e){return this._restoreObjectsState(),i.util.resetObjectTransform(this),this.remove(e),this._calcBounds(),this._updateObjectsCoords(),this.setCoords(),this.dirty=!0,this},_onObjectAdded:function(e){this.dirty=!0,e.group=this,e._set("canvas",this.canvas)},_onObjectRemoved:function(e){this.dirty=!0,delete e.group},_set:function(e,t){var s=this._objects.length;if(this.useSetOnGroup)for(;s--;)this._objects[s].setOnGroup(e,t);if(e==="canvas")for(;s--;)this._objects[s]._set(e,t);i.Object.prototype._set.call(this,e,t)},toObject:function(e){var t=this.includeDefaultValues,s=this._objects.filter(function(h){return!h.excludeFromExport}).map(function(h){var l=h.includeDefaultValues;h.includeDefaultValues=t;var d=h.toObject(e);return h.includeDefaultValues=l,d}),c=i.Object.prototype.toObject.call(this,e);return c.objects=s,c},toDatalessObject:function(e){var t,s=this.sourcePath;if(s)t=s;else{var c=this.includeDefaultValues;t=this._objects.map(function(l){var d=l.includeDefaultValues;l.includeDefaultValues=c;var p=l.toDatalessObject(e);return l.includeDefaultValues=d,p})}var h=i.Object.prototype.toDatalessObject.call(this,e);return h.objects=t,h},render:function(e){this._transformDone=!0,this.callSuper("render",e),this._transformDone=!1},shouldCache:function(){var e=i.Object.prototype.shouldCache.call(this);if(e){for(var t=0,s=this._objects.length;t<s;t++)if(this._objects[t].willDrawShadow())return this.ownCaching=!1,!1}return e},willDrawShadow:function(){if(i.Object.prototype.willDrawShadow.call(this))return!0;for(var e=0,t=this._objects.length;e<t;e++)if(this._objects[e].willDrawShadow())return!0;return!1},isOnACache:function(){return this.ownCaching||this.group&&this.group.isOnACache()},drawObject:function(e){for(var t=0,s=this._objects.length;t<s;t++)this._objects[t].render(e);this._drawClipPath(e,this.clipPath)},isCacheDirty:function(e){if(this.callSuper("isCacheDirty",e))return!0;if(!this.statefullCache)return!1;for(var t=0,s=this._objects.length;t<s;t++)if(this._objects[t].isCacheDirty(!0)){if(this._cacheCanvas){var c=this.cacheWidth/this.zoomX,h=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-c/2,-h/2,c,h)}return!0}return!1},_restoreObjectsState:function(){var e=this.calcOwnMatrix();return this._objects.forEach(function(t){i.util.addTransformToObject(t,e),delete t.group,t.setCoords()}),this},destroy:function(){return this._objects.forEach(function(e){e.set("dirty",!0)}),this._restoreObjectsState()},dispose:function(){this.callSuper("dispose"),this.forEachObject(function(e){e.dispose&&e.dispose()}),this._objects=[]},toActiveSelection:function(){if(this.canvas){var e=this._objects,t=this.canvas;this._objects=[];var s=this.toObject();delete s.objects;var c=new i.ActiveSelection([]);return c.set(s),c.type="activeSelection",t.remove(this),e.forEach(function(h){h.group=c,h.dirty=!0,t.add(h)}),c.canvas=t,c._objects=e,t._activeObject=c,c.setCoords(),c}},ungroupOnCanvas:function(){return this._restoreObjectsState()},setObjectsCoords:function(){return this.forEachObject(function(e){e.setCoords(!0)}),this},_calcBounds:function(e){for(var t,s,c,h,l=[],d=[],p=["tr","br","bl","tl"],m=0,b=this._objects.length,y=p.length;m<b;++m){for(c=(t=this._objects[m]).calcACoords(),h=0;h<y;h++)s=p[h],l.push(c[s].x),d.push(c[s].y);t.aCoords=c}this._getBounds(l,d,e)},_getBounds:function(e,t,s){var c=new i.Point(n(e),n(t)),h=new i.Point(a(e),a(t)),l=c.y||0,d=c.x||0,p=h.x-c.x||0,m=h.y-c.y||0;this.width=p,this.height=m,s||this.setPositionByOrigin({x:d,y:l},"left","top")},_toSVG:function(e){for(var t=["<g ","COMMON_PARTS"," >\n"],s=0,c=this._objects.length;s<c;s++)t.push("		",this._objects[s].toSVG(e));return t.push("</g>\n"),t},getSvgStyles:function(){var e=this.opacity!==void 0&&this.opacity!==1?"opacity: "+this.opacity+";":"",t=this.visible?"":" visibility: hidden;";return[e,this.getSvgFilter(),t].join("")},toClipPathSVG:function(e){for(var t=[],s=0,c=this._objects.length;s<c;s++)t.push("	",this._objects[s].toClipPathSVG(e));return this._createBaseClipPathSVGMarkup(t,{reviver:e})}}),i.Group.fromObject=function(e,t){var s=e.objects,c=i.util.object.clone(e,!0);delete c.objects,typeof s!="string"?i.util.enlivenObjects(s,function(h){var l=i.util.object.clone(e,!0);delete l.objects,i.util.enlivenObjectEnlivables(e,l,function(){t&&t(new i.Group(h,l,!0))})}):i.loadSVGFromURL(s,function(h){var l=i.util.groupSVGElements(h,e,s);l.set(c),t&&t(l)})})}(o),function(r){var i=r.fabric||(r.fabric={});i.ActiveSelection||(i.ActiveSelection=i.util.createClass(i.Group,{type:"activeSelection",initialize:function(n,a){a=a||{},this._objects=n||[];for(var e=this._objects.length;e--;)this._objects[e].group=this;a.originX&&(this.originX=a.originX),a.originY&&(this.originY=a.originY),this._calcBounds(),this._updateObjectsCoords(),i.Object.prototype.initialize.call(this,a),this.setCoords()},toGroup:function(){var n=this._objects.concat();this._objects=[];var a=i.Object.prototype.toObject.call(this),e=new i.Group([]);if(delete a.type,e.set(a),n.forEach(function(s){s.canvas.remove(s),s.group=e}),e._objects=n,!this.canvas)return e;var t=this.canvas;return t.add(e),t._activeObject=e,e.setCoords(),e},onDeselect:function(){return this.destroy(),!1},toString:function(){return"#<fabric.ActiveSelection: ("+this.complexity()+")>"},shouldCache:function(){return!1},isOnACache:function(){return!1},_renderControls:function(n,a,e){n.save(),n.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1,this.callSuper("_renderControls",n,a),(e=e||{}).hasControls===void 0&&(e.hasControls=!1),e.forActiveSelection=!0;for(var t=0,s=this._objects.length;t<s;t++)this._objects[t]._renderControls(n,e);n.restore()}}),i.ActiveSelection.fromObject=function(n,a){i.util.enlivenObjects(n.objects,function(e){delete n.objects,a&&a(new i.ActiveSelection(e,n,!0))})})}(o),function(r){var i=g.util.object.extend;r.fabric||(r.fabric={}),r.fabric.Image?g.warn("fabric.Image is already defined."):(g.Image=g.util.createClass(g.Object,{type:"image",strokeWidth:0,srcFromAttribute:!1,_lastScaleX:1,_lastScaleY:1,_filterScalingX:1,_filterScalingY:1,minimumScaleTrigger:.5,stateProperties:g.Object.prototype.stateProperties.concat("cropX","cropY"),cacheProperties:g.Object.prototype.cacheProperties.concat("cropX","cropY"),cacheKey:"",cropX:0,cropY:0,imageSmoothing:!0,initialize:function(n,a){a||(a={}),this.filters=[],this.cacheKey="texture"+g.Object.__uid++,this.callSuper("initialize",a),this._initElement(n,a)},getElement:function(){return this._element||{}},setElement:function(n,a){return this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._element=n,this._originalElement=n,this._initConfig(a),this.filters.length!==0&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters(),this},removeTexture:function(n){var a=g.filterBackend;a&&a.evictCachesForKey&&a.evictCachesForKey(n)},dispose:function(){this.callSuper("dispose"),this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._cacheContext=void 0,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach((function(n){g.util.cleanUpJsdomNode(this[n]),this[n]=void 0}).bind(this))},getCrossOrigin:function(){return this._originalElement&&(this._originalElement.crossOrigin||null)},getOriginalSize:function(){var n=this.getElement();return{width:n.naturalWidth||n.width,height:n.naturalHeight||n.height}},_stroke:function(n){if(this.stroke&&this.strokeWidth!==0){var a=this.width/2,e=this.height/2;n.beginPath(),n.moveTo(-a,-e),n.lineTo(a,-e),n.lineTo(a,e),n.lineTo(-a,e),n.lineTo(-a,-e),n.closePath()}},toObject:function(n){var a=[];this.filters.forEach(function(t){t&&a.push(t.toObject())});var e=i(this.callSuper("toObject",["cropX","cropY"].concat(n)),{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:a});return this.resizeFilter&&(e.resizeFilter=this.resizeFilter.toObject()),e},hasCrop:function(){return this.cropX||this.cropY||this.width<this._element.width||this.height<this._element.height},_toSVG:function(){var n,a=[],e=[],t=this._element,s=-this.width/2,c=-this.height/2,h="",l="";if(!t)return[];if(this.hasCrop()){var d=g.Object.__uid++;a.push('<clipPath id="imageCrop_'+d+'">\n','	<rect x="'+s+'" y="'+c+'" width="'+this.width+'" height="'+this.height+'" />\n',"</clipPath>\n"),h=' clip-path="url(#imageCrop_'+d+')" '}if(this.imageSmoothing||(l='" image-rendering="optimizeSpeed'),e.push("	<image ","COMMON_PARTS",'xlink:href="',this.getSvgSrc(!0),'" x="',s-this.cropX,'" y="',c-this.cropY,'" width="',t.width||t.naturalWidth,'" height="',t.height||t.height,l,'"',h,"></image>\n"),this.stroke||this.strokeDashArray){var p=this.fill;this.fill=null,n=["	<rect ",'x="',s,'" y="',c,'" width="',this.width,'" height="',this.height,'" style="',this.getSvgStyles(),'"/>\n'],this.fill=p}return this.paintFirst!=="fill"?a.concat(n,e):a.concat(e,n)},getSrc:function(n){var a=n?this._element:this._originalElement;return a?a.toDataURL?a.toDataURL():this.srcFromAttribute?a.getAttribute("src"):a.src:this.src||""},setSrc:function(n,a,e){return g.util.loadImage(n,function(t,s){this.setElement(t,e),this._setWidthHeight(),a&&a(this,s)},this,e&&e.crossOrigin),this},toString:function(){return'#<fabric.Image: { src: "'+this.getSrc()+'" }>'},applyResizeFilters:function(){var n=this.resizeFilter,a=this.minimumScaleTrigger,e=this.getTotalObjectScaling(),t=e.scaleX,s=e.scaleY,c=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!n||t>a&&s>a)return this._element=c,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=t,void(this._lastScaleY=s);g.filterBackend||(g.filterBackend=g.initFilterBackend());var h=g.util.createCanvasElement(),l=this._filteredEl?this.cacheKey+"_filtered":this.cacheKey,d=c.width,p=c.height;h.width=d,h.height=p,this._element=h,this._lastScaleX=n.scaleX=t,this._lastScaleY=n.scaleY=s,g.filterBackend.applyFilters([n],c,d,p,this._element,l),this._filterScalingX=h.width/this._originalElement.width,this._filterScalingY=h.height/this._originalElement.height},applyFilters:function(n){if(n=(n=n||this.filters||[]).filter(function(c){return c&&!c.isNeutralState()}),this.set("dirty",!0),this.removeTexture(this.cacheKey+"_filtered"),n.length===0)return this._element=this._originalElement,this._filteredEl=null,this._filterScalingX=1,this._filterScalingY=1,this;var a=this._originalElement,e=a.naturalWidth||a.width,t=a.naturalHeight||a.height;if(this._element===this._originalElement){var s=g.util.createCanvasElement();s.width=e,s.height=t,this._element=s,this._filteredEl=s}else this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,e,t),this._lastScaleX=1,this._lastScaleY=1;return g.filterBackend||(g.filterBackend=g.initFilterBackend()),g.filterBackend.applyFilters(n,this._originalElement,e,t,this._element,this.cacheKey),this._originalElement.width===this._element.width&&this._originalElement.height===this._element.height||(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height),this},_render:function(n){g.util.setImageSmoothing(n,this.imageSmoothing),this.isMoving!==!0&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(n),this._renderPaintInOrder(n)},drawCacheOnCanvas:function(n){g.util.setImageSmoothing(n,this.imageSmoothing),g.Object.prototype.drawCacheOnCanvas.call(this,n)},shouldCache:function(){return this.needsItsOwnCache()},_renderFill:function(n){var a=this._element;if(a){var e=this._filterScalingX,t=this._filterScalingY,s=this.width,c=this.height,h=Math.min,l=Math.max,d=l(this.cropX,0),p=l(this.cropY,0),m=a.naturalWidth||a.width,b=a.naturalHeight||a.height,y=d*e,w=p*t,T=h(s*e,m-y),k=h(c*t,b-w),P=-s/2,G=-c/2,V=h(s,m/e-d),N=h(c,b/t-p);a&&n.drawImage(a,y,w,T,k,P,G,V,N)}},_needsResize:function(){var n=this.getTotalObjectScaling();return n.scaleX!==this._lastScaleX||n.scaleY!==this._lastScaleY},_resetWidthHeight:function(){this.set(this.getOriginalSize())},_initElement:function(n,a){this.setElement(g.util.getById(n),a),g.util.addClass(this.getElement(),g.Image.CSS_CANVAS)},_initConfig:function(n){n||(n={}),this.setOptions(n),this._setWidthHeight(n)},_initFilters:function(n,a){n&&n.length?g.util.enlivenObjects(n,function(e){a&&a(e)},"fabric.Image.filters"):a&&a()},_setWidthHeight:function(n){n||(n={});var a=this.getElement();this.width=n.width||a.naturalWidth||a.width||0,this.height=n.height||a.naturalHeight||a.height||0},parsePreserveAspectRatioAttribute:function(){var n,a=g.util.parsePreserveAspectRatioAttribute(this.preserveAspectRatio||""),e=this._element.width,t=this._element.height,s=1,c=1,h=0,l=0,d=0,p=0,m=this.width,b=this.height,y={width:m,height:b};return!a||a.alignX==="none"&&a.alignY==="none"?(s=m/e,c=b/t):(a.meetOrSlice==="meet"&&(n=(m-e*(s=c=g.util.findScaleToFit(this._element,y)))/2,a.alignX==="Min"&&(h=-n),a.alignX==="Max"&&(h=n),n=(b-t*c)/2,a.alignY==="Min"&&(l=-n),a.alignY==="Max"&&(l=n)),a.meetOrSlice==="slice"&&(n=e-m/(s=c=g.util.findScaleToCover(this._element,y)),a.alignX==="Mid"&&(d=n/2),a.alignX==="Max"&&(d=n),n=t-b/c,a.alignY==="Mid"&&(p=n/2),a.alignY==="Max"&&(p=n),e=m/s,t=b/c)),{width:e,height:t,scaleX:s,scaleY:c,offsetLeft:h,offsetTop:l,cropX:d,cropY:p}}}),g.Image.CSS_CANVAS="canvas-img",g.Image.prototype.getSvgSrc=g.Image.prototype.getSrc,g.Image.fromObject=function(n,a){var e=g.util.object.clone(n);g.util.loadImage(e.src,function(t,s){s?a&&a(null,!0):g.Image.prototype._initFilters.call(e,e.filters,function(c){e.filters=c||[],g.Image.prototype._initFilters.call(e,[e.resizeFilter],function(h){e.resizeFilter=h[0],g.util.enlivenObjectEnlivables(e,e,function(){var l=new g.Image(t,e);a(l,!1)})})})},null,e.crossOrigin)},g.Image.fromURL=function(n,a,e){g.util.loadImage(n,function(t,s){a&&a(new g.Image(t,e),s)},null,e&&e.crossOrigin)},g.Image.ATTRIBUTE_NAMES=g.SHARED_ATTRIBUTES.concat("x y width height preserveAspectRatio xlink:href crossOrigin image-rendering".split(" ")),g.Image.fromElement=function(n,a,e){var t=g.parseAttributes(n,g.Image.ATTRIBUTE_NAMES);g.Image.fromURL(t["xlink:href"],a,i(e?g.util.object.clone(e):{},t))})}(o),g.util.object.extend(g.Object.prototype,{_getAngleValueForStraighten:function(){var r=this.angle%360;return r>0?90*Math.round((r-1)/90):90*Math.round(r/90)},straighten:function(){return this.rotate(this._getAngleValueForStraighten())},fxStraighten:function(r){var i=function(){},n=(r=r||{}).onComplete||i,a=r.onChange||i,e=this;return g.util.animate({target:this,startValue:this.get("angle"),endValue:this._getAngleValueForStraighten(),duration:this.FX_DURATION,onChange:function(t){e.rotate(t),a()},onComplete:function(){e.setCoords(),n()}})}}),g.util.object.extend(g.StaticCanvas.prototype,{straightenObject:function(r){return r.straighten(),this.requestRenderAll(),this},fxStraightenObject:function(r){return r.fxStraighten({onChange:this.requestRenderAllBound})}}),function(){function r(n,a){var e="precision "+a+" float;\nvoid main(){}",t=n.createShader(n.FRAGMENT_SHADER);return n.shaderSource(t,e),n.compileShader(t),!!n.getShaderParameter(t,n.COMPILE_STATUS)}function i(n){n&&n.tileSize&&(this.tileSize=n.tileSize),this.setupGLContext(this.tileSize,this.tileSize),this.captureGPUInfo()}g.isWebglSupported=function(n){if(g.isLikelyNode)return!1;n=n||g.WebglFilterBackend.prototype.tileSize;var a=document.createElement("canvas"),e=a.getContext("webgl")||a.getContext("experimental-webgl"),t=!1;if(e){g.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),t=g.maxTextureSize>=n;for(var s=["highp","mediump","lowp"],c=0;c<3;c++)if(r(e,s[c])){g.webGlPrecision=s[c];break}}return this.isSupported=t,t},g.WebglFilterBackend=i,i.prototype={tileSize:2048,resources:{},setupGLContext:function(n,a){this.dispose(),this.createWebGLCanvas(n,a),this.aPosition=new Float32Array([0,0,0,1,1,0,1,1]),this.chooseFastestCopyGLTo2DMethod(n,a)},chooseFastestCopyGLTo2DMethod:function(n,a){var e,t=window.performance!==void 0;try{new ImageData(1,1),e=!0}catch(b){e=!1}var s=typeof ArrayBuffer<"u",c=typeof Uint8ClampedArray<"u";if(t&&e&&s&&c){var h=g.util.createCanvasElement(),l=new ArrayBuffer(n*a*4);if(g.forceGLPutImageData)return this.imageBuffer=l,void(this.copyGLTo2D=he);var d,p,m={imageBuffer:l,destinationWidth:n,destinationHeight:a,targetCanvas:h};h.width=n,h.height=a,d=window.performance.now(),oe.call(m,this.gl,m),p=window.performance.now()-d,d=window.performance.now(),he.call(m,this.gl,m),p>window.performance.now()-d?(this.imageBuffer=l,this.copyGLTo2D=he):this.copyGLTo2D=oe}},createWebGLCanvas:function(n,a){var e=g.util.createCanvasElement();e.width=n,e.height=a;var t={alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1},s=e.getContext("webgl",t);s||(s=e.getContext("experimental-webgl",t)),s&&(s.clearColor(0,0,0,0),this.canvas=e,this.gl=s)},applyFilters:function(n,a,e,t,s,c){var h,l=this.gl;c&&(h=this.getCachedTexture(c,a));var d={originalWidth:a.width||a.originalWidth,originalHeight:a.height||a.originalHeight,sourceWidth:e,sourceHeight:t,destinationWidth:e,destinationHeight:t,context:l,sourceTexture:this.createTexture(l,e,t,!h&&a),targetTexture:this.createTexture(l,e,t),originalTexture:h||this.createTexture(l,e,t,!h&&a),passes:n.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:s},p=l.createFramebuffer();return l.bindFramebuffer(l.FRAMEBUFFER,p),n.forEach(function(m){m&&m.applyTo(d)}),function(m){var b=m.targetCanvas,y=b.width,w=b.height,T=m.destinationWidth,k=m.destinationHeight;y===T&&w===k||(b.width=T,b.height=k)}(d),this.copyGLTo2D(l,d),l.bindTexture(l.TEXTURE_2D,null),l.deleteTexture(d.sourceTexture),l.deleteTexture(d.targetTexture),l.deleteFramebuffer(p),s.getContext("2d").setTransform(1,0,0,1,0,0),d},dispose:function(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()},clearWebGLCaches:function(){this.programCache={},this.textureCache={}},createTexture:function(n,a,e,t){var s=n.createTexture();return n.bindTexture(n.TEXTURE_2D,s),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),t?n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t):n.texImage2D(n.TEXTURE_2D,0,n.RGBA,a,e,0,n.RGBA,n.UNSIGNED_BYTE,null),s},getCachedTexture:function(n,a){if(this.textureCache[n])return this.textureCache[n];var e=this.createTexture(this.gl,a.width,a.height,a);return this.textureCache[n]=e,e},evictCachesForKey:function(n){this.textureCache[n]&&(this.gl.deleteTexture(this.textureCache[n]),delete this.textureCache[n])},copyGLTo2D:oe,captureGPUInfo:function(){if(this.gpuInfo)return this.gpuInfo;var n=this.gl,a={renderer:"",vendor:""};if(!n)return a;var e=n.getExtension("WEBGL_debug_renderer_info");if(e){var t=n.getParameter(e.UNMASKED_RENDERER_WEBGL),s=n.getParameter(e.UNMASKED_VENDOR_WEBGL);t&&(a.renderer=t.toLowerCase()),s&&(a.vendor=s.toLowerCase())}return this.gpuInfo=a,a}}}(),function(){var r=function(){};function i(){}g.Canvas2dFilterBackend=i,i.prototype={evictCachesForKey:r,dispose:r,clearWebGLCaches:r,resources:{},applyFilters:function(n,a,e,t,s){var c=s.getContext("2d");c.drawImage(a,0,0,e,t);var h={sourceWidth:e,sourceHeight:t,imageData:c.getImageData(0,0,e,t),originalEl:a,originalImageData:c.getImageData(0,0,e,t),canvasEl:s,ctx:c,filterBackend:this};return n.forEach(function(l){l.applyTo(h)}),h.imageData.width===e&&h.imageData.height===t||(s.width=h.imageData.width,s.height=h.imageData.height),c.putImageData(h.imageData,0,0),h}}}(),g.Image=g.Image||{},g.Image.filters=g.Image.filters||{},g.Image.filters.BaseFilter=g.util.createClass({type:"BaseFilter",vertexSource:"attribute vec2 aPosition;\nvarying vec2 vTexCoord;\nvoid main() {\nvTexCoord = aPosition;\ngl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);\n}",fragmentSource:"precision highp float;\nvarying vec2 vTexCoord;\nuniform sampler2D uTexture;\nvoid main() {\ngl_FragColor = texture2D(uTexture, vTexCoord);\n}",initialize:function(r){r&&this.setOptions(r)},setOptions:function(r){for(var i in r)this[i]=r[i]},createProgram:function(r,i,n){i=i||this.fragmentSource,n=n||this.vertexSource,g.webGlPrecision!=="highp"&&(i=i.replace(/precision highp float/g,"precision "+g.webGlPrecision+" float"));var a=r.createShader(r.VERTEX_SHADER);if(r.shaderSource(a,n),r.compileShader(a),!r.getShaderParameter(a,r.COMPILE_STATUS))throw new Error("Vertex shader compile error for "+this.type+": "+r.getShaderInfoLog(a));var e=r.createShader(r.FRAGMENT_SHADER);if(r.shaderSource(e,i),r.compileShader(e),!r.getShaderParameter(e,r.COMPILE_STATUS))throw new Error("Fragment shader compile error for "+this.type+": "+r.getShaderInfoLog(e));var t=r.createProgram();if(r.attachShader(t,a),r.attachShader(t,e),r.linkProgram(t),!r.getProgramParameter(t,r.LINK_STATUS))throw new Error('Shader link error for "${this.type}" '+r.getProgramInfoLog(t));var s=this.getAttributeLocations(r,t),c=this.getUniformLocations(r,t)||{};return c.uStepW=r.getUniformLocation(t,"uStepW"),c.uStepH=r.getUniformLocation(t,"uStepH"),{program:t,attributeLocations:s,uniformLocations:c}},getAttributeLocations:function(r,i){return{aPosition:r.getAttribLocation(i,"aPosition")}},getUniformLocations:function(){return{}},sendAttributeData:function(r,i,n){var a=i.aPosition,e=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,e),r.enableVertexAttribArray(a),r.vertexAttribPointer(a,2,r.FLOAT,!1,0,0),r.bufferData(r.ARRAY_BUFFER,n,r.STATIC_DRAW)},_setupFrameBuffer:function(r){var i,n,a=r.context;r.passes>1?(i=r.destinationWidth,n=r.destinationHeight,r.sourceWidth===i&&r.sourceHeight===n||(a.deleteTexture(r.targetTexture),r.targetTexture=r.filterBackend.createTexture(a,i,n)),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,r.targetTexture,0)):(a.bindFramebuffer(a.FRAMEBUFFER,null),a.finish())},_swapTextures:function(r){r.passes--,r.pass++;var i=r.targetTexture;r.targetTexture=r.sourceTexture,r.sourceTexture=i},isNeutralState:function(){var r=this.mainParameter,i=g.Image.filters[this.type].prototype;if(r){if(Array.isArray(i[r])){for(var n=i[r].length;n--;)if(this[r][n]!==i[r][n])return!1;return!0}return i[r]===this[r]}return!1},applyTo:function(r){r.webgl?(this._setupFrameBuffer(r),this.applyToWebGL(r),this._swapTextures(r)):this.applyTo2d(r)},retrieveShader:function(r){return r.programCache.hasOwnProperty(this.type)||(r.programCache[this.type]=this.createProgram(r.context)),r.programCache[this.type]},applyToWebGL:function(r){var i=r.context,n=this.retrieveShader(r);r.pass===0&&r.originalTexture?i.bindTexture(i.TEXTURE_2D,r.originalTexture):i.bindTexture(i.TEXTURE_2D,r.sourceTexture),i.useProgram(n.program),this.sendAttributeData(i,n.attributeLocations,r.aPosition),i.uniform1f(n.uniformLocations.uStepW,1/r.sourceWidth),i.uniform1f(n.uniformLocations.uStepH,1/r.sourceHeight),this.sendUniformData(i,n.uniformLocations),i.viewport(0,0,r.destinationWidth,r.destinationHeight),i.drawArrays(i.TRIANGLE_STRIP,0,4)},bindAdditionalTexture:function(r,i,n){r.activeTexture(n),r.bindTexture(r.TEXTURE_2D,i),r.activeTexture(r.TEXTURE0)},unbindAdditionalTexture:function(r,i){r.activeTexture(i),r.bindTexture(r.TEXTURE_2D,null),r.activeTexture(r.TEXTURE0)},getMainParameter:function(){return this[this.mainParameter]},setMainParameter:function(r){this[this.mainParameter]=r},sendUniformData:function(){},createHelpLayer:function(r){if(!r.helpLayer){var i=document.createElement("canvas");i.width=r.sourceWidth,i.height=r.sourceHeight,r.helpLayer=i}},toObject:function(){var r={type:this.type},i=this.mainParameter;return i&&(r[i]=this[i]),r},toJSON:function(){return this.toObject()}}),g.Image.filters.BaseFilter.fromObject=function(r,i){var n=new g.Image.filters[r.type](r);return i&&i(n),n},function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.ColorMatrix=a(n.BaseFilter,{type:"ColorMatrix",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nvarying vec2 vTexCoord;\nuniform mat4 uColorMatrix;\nuniform vec4 uConstants;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor *= uColorMatrix;\ncolor += uConstants;\ngl_FragColor = color;\n}",matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],mainParameter:"matrix",colorsOnly:!0,initialize:function(e){this.callSuper("initialize",e),this.matrix=this.matrix.slice(0)},applyTo2d:function(e){var t,s,c,h,l,d=e.imageData.data,p=d.length,m=this.matrix,b=this.colorsOnly;for(l=0;l<p;l+=4)t=d[l],s=d[l+1],c=d[l+2],b?(d[l]=t*m[0]+s*m[1]+c*m[2]+255*m[4],d[l+1]=t*m[5]+s*m[6]+c*m[7]+255*m[9],d[l+2]=t*m[10]+s*m[11]+c*m[12]+255*m[14]):(h=d[l+3],d[l]=t*m[0]+s*m[1]+c*m[2]+h*m[3]+255*m[4],d[l+1]=t*m[5]+s*m[6]+c*m[7]+h*m[8]+255*m[9],d[l+2]=t*m[10]+s*m[11]+c*m[12]+h*m[13]+255*m[14],d[l+3]=t*m[15]+s*m[16]+c*m[17]+h*m[18]+255*m[19])},getUniformLocations:function(e,t){return{uColorMatrix:e.getUniformLocation(t,"uColorMatrix"),uConstants:e.getUniformLocation(t,"uConstants")}},sendUniformData:function(e,t){var s=this.matrix,c=[s[0],s[1],s[2],s[3],s[5],s[6],s[7],s[8],s[10],s[11],s[12],s[13],s[15],s[16],s[17],s[18]],h=[s[4],s[9],s[14],s[19]];e.uniformMatrix4fv(t.uColorMatrix,!1,c),e.uniform4fv(t.uConstants,h)}}),i.Image.filters.ColorMatrix.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.Brightness=a(n.BaseFilter,{type:"Brightness",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uBrightness;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor.rgb += uBrightness;\ngl_FragColor = color;\n}",brightness:0,mainParameter:"brightness",applyTo2d:function(e){if(this.brightness!==0){var t,s=e.imageData.data,c=s.length,h=Math.round(255*this.brightness);for(t=0;t<c;t+=4)s[t]=s[t]+h,s[t+1]=s[t+1]+h,s[t+2]=s[t+2]+h}},getUniformLocations:function(e,t){return{uBrightness:e.getUniformLocation(t,"uBrightness")}},sendUniformData:function(e,t){e.uniform1f(t.uBrightness,this.brightness)}}),i.Image.filters.Brightness.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.util.object.extend,a=i.Image.filters,e=i.util.createClass;a.Convolute=e(a.BaseFilter,{type:"Convolute",opaque:!1,matrix:[0,0,0,0,1,0,0,0,0],fragmentSource:{Convolute_3_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[9];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 3.0; h+=1.0) {\nfor (float w = 0.0; w < 3.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_3_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[9];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 3.0; h+=1.0) {\nfor (float w = 0.0; w < 3.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_5_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[25];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 5.0; h+=1.0) {\nfor (float w = 0.0; w < 5.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_5_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[25];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 5.0; h+=1.0) {\nfor (float w = 0.0; w < 5.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_7_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[49];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 7.0; h+=1.0) {\nfor (float w = 0.0; w < 7.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_7_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[49];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 7.0; h+=1.0) {\nfor (float w = 0.0; w < 7.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_9_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[81];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 9.0; h+=1.0) {\nfor (float w = 0.0; w < 9.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_9_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[81];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 9.0; h+=1.0) {\nfor (float w = 0.0; w < 9.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}"},retrieveShader:function(t){var s=Math.sqrt(this.matrix.length),c=this.type+"_"+s+"_"+(this.opaque?1:0),h=this.fragmentSource[c];return t.programCache.hasOwnProperty(c)||(t.programCache[c]=this.createProgram(t.context,h)),t.programCache[c]},applyTo2d:function(t){var s,c,h,l,d,p,m,b,y,w,T,k,P,G=t.imageData,V=G.data,N=this.matrix,A=Math.round(Math.sqrt(N.length)),O=Math.floor(A/2),B=G.width,W=G.height,H=t.ctx.createImageData(B,W),R=H.data,D=this.opaque?1:0;for(T=0;T<W;T++)for(w=0;w<B;w++){for(d=4*(T*B+w),s=0,c=0,h=0,l=0,P=0;P<A;P++)for(k=0;k<A;k++)p=w+k-O,(m=T+P-O)<0||m>=W||p<0||p>=B||(b=4*(m*B+p),y=N[P*A+k],s+=V[b]*y,c+=V[b+1]*y,h+=V[b+2]*y,D||(l+=V[b+3]*y));R[d]=s,R[d+1]=c,R[d+2]=h,R[d+3]=D?V[d+3]:l}t.imageData=H},getUniformLocations:function(t,s){return{uMatrix:t.getUniformLocation(s,"uMatrix"),uOpaque:t.getUniformLocation(s,"uOpaque"),uHalfSize:t.getUniformLocation(s,"uHalfSize"),uSize:t.getUniformLocation(s,"uSize")}},sendUniformData:function(t,s){t.uniform1fv(s.uMatrix,this.matrix)},toObject:function(){return n(this.callSuper("toObject"),{opaque:this.opaque,matrix:this.matrix})}}),i.Image.filters.Convolute.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.Grayscale=a(n.BaseFilter,{type:"Grayscale",fragmentSource:{average:"precision highp float;\nuniform sampler2D uTexture;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat average = (color.r + color.b + color.g) / 3.0;\ngl_FragColor = vec4(average, average, average, color.a);\n}",lightness:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uMode;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 col = texture2D(uTexture, vTexCoord);\nfloat average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;\ngl_FragColor = vec4(average, average, average, col.a);\n}",luminosity:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uMode;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 col = texture2D(uTexture, vTexCoord);\nfloat average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;\ngl_FragColor = vec4(average, average, average, col.a);\n}"},mode:"average",mainParameter:"mode",applyTo2d:function(e){var t,s,c=e.imageData.data,h=c.length,l=this.mode;for(t=0;t<h;t+=4)l==="average"?s=(c[t]+c[t+1]+c[t+2])/3:l==="lightness"?s=(Math.min(c[t],c[t+1],c[t+2])+Math.max(c[t],c[t+1],c[t+2]))/2:l==="luminosity"&&(s=.21*c[t]+.72*c[t+1]+.07*c[t+2]),c[t]=s,c[t+1]=s,c[t+2]=s},retrieveShader:function(e){var t=this.type+"_"+this.mode;if(!e.programCache.hasOwnProperty(t)){var s=this.fragmentSource[this.mode];e.programCache[t]=this.createProgram(e.context,s)}return e.programCache[t]},getUniformLocations:function(e,t){return{uMode:e.getUniformLocation(t,"uMode")}},sendUniformData:function(e,t){e.uniform1i(t.uMode,1)},isNeutralState:function(){return!1}}),i.Image.filters.Grayscale.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.Invert=a(n.BaseFilter,{type:"Invert",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uInvert;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nif (uInvert == 1) {\ngl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);\n} else {\ngl_FragColor = color;\n}\n}",invert:!0,mainParameter:"invert",applyTo2d:function(e){var t,s=e.imageData.data,c=s.length;for(t=0;t<c;t+=4)s[t]=255-s[t],s[t+1]=255-s[t+1],s[t+2]=255-s[t+2]},isNeutralState:function(){return!this.invert},getUniformLocations:function(e,t){return{uInvert:e.getUniformLocation(t,"uInvert")}},sendUniformData:function(e,t){e.uniform1i(t.uInvert,this.invert)}}),i.Image.filters.Invert.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.util.object.extend,a=i.Image.filters,e=i.util.createClass;a.Noise=e(a.BaseFilter,{type:"Noise",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uStepH;\nuniform float uNoise;\nuniform float uSeed;\nvarying vec2 vTexCoord;\nfloat rand(vec2 co, float seed, float vScale) {\nreturn fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);\n}\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;\ngl_FragColor = color;\n}",mainParameter:"noise",noise:0,applyTo2d:function(t){if(this.noise!==0){var s,c,h=t.imageData.data,l=h.length,d=this.noise;for(s=0,l=h.length;s<l;s+=4)c=(.5-Math.random())*d,h[s]+=c,h[s+1]+=c,h[s+2]+=c}},getUniformLocations:function(t,s){return{uNoise:t.getUniformLocation(s,"uNoise"),uSeed:t.getUniformLocation(s,"uSeed")}},sendUniformData:function(t,s){t.uniform1f(s.uNoise,this.noise/255),t.uniform1f(s.uSeed,Math.random())},toObject:function(){return n(this.callSuper("toObject"),{noise:this.noise})}}),i.Image.filters.Noise.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.Pixelate=a(n.BaseFilter,{type:"Pixelate",blocksize:4,mainParameter:"blocksize",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uBlocksize;\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nfloat blockW = uBlocksize * uStepW;\nfloat blockH = uBlocksize * uStepW;\nint posX = int(vTexCoord.x / blockW);\nint posY = int(vTexCoord.y / blockH);\nfloat fposX = float(posX);\nfloat fposY = float(posY);\nvec2 squareCoords = vec2(fposX * blockW, fposY * blockH);\nvec4 color = texture2D(uTexture, squareCoords);\ngl_FragColor = color;\n}",applyTo2d:function(e){var t,s,c,h,l,d,p,m,b,y,w,T=e.imageData,k=T.data,P=T.height,G=T.width;for(s=0;s<P;s+=this.blocksize)for(c=0;c<G;c+=this.blocksize)for(h=k[t=4*s*G+4*c],l=k[t+1],d=k[t+2],p=k[t+3],y=Math.min(s+this.blocksize,P),w=Math.min(c+this.blocksize,G),m=s;m<y;m++)for(b=c;b<w;b++)k[t=4*m*G+4*b]=h,k[t+1]=l,k[t+2]=d,k[t+3]=p},isNeutralState:function(){return this.blocksize===1},getUniformLocations:function(e,t){return{uBlocksize:e.getUniformLocation(t,"uBlocksize"),uStepW:e.getUniformLocation(t,"uStepW"),uStepH:e.getUniformLocation(t,"uStepH")}},sendUniformData:function(e,t){e.uniform1f(t.uBlocksize,this.blocksize)}}),i.Image.filters.Pixelate.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.util.object.extend,a=i.Image.filters,e=i.util.createClass;a.RemoveColor=e(a.BaseFilter,{type:"RemoveColor",color:"#FFFFFF",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec4 uLow;\nuniform vec4 uHigh;\nvarying vec2 vTexCoord;\nvoid main() {\ngl_FragColor = texture2D(uTexture, vTexCoord);\nif(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {\ngl_FragColor.a = 0.0;\n}\n}",distance:.02,useAlpha:!1,applyTo2d:function(t){var s,c,h,l,d=t.imageData.data,p=255*this.distance,m=new i.Color(this.color).getSource(),b=[m[0]-p,m[1]-p,m[2]-p],y=[m[0]+p,m[1]+p,m[2]+p];for(s=0;s<d.length;s+=4)c=d[s],h=d[s+1],l=d[s+2],c>b[0]&&h>b[1]&&l>b[2]&&c<y[0]&&h<y[1]&&l<y[2]&&(d[s+3]=0)},getUniformLocations:function(t,s){return{uLow:t.getUniformLocation(s,"uLow"),uHigh:t.getUniformLocation(s,"uHigh")}},sendUniformData:function(t,s){var c=new i.Color(this.color).getSource(),h=parseFloat(this.distance),l=[0+c[0]/255-h,0+c[1]/255-h,0+c[2]/255-h,1],d=[c[0]/255+h,c[1]/255+h,c[2]/255+h,1];t.uniform4fv(s.uLow,l),t.uniform4fv(s.uHigh,d)},toObject:function(){return n(this.callSuper("toObject"),{color:this.color,distance:this.distance})}}),i.Image.filters.RemoveColor.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass,e={Brownie:[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0],Vintage:[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0],Kodachrome:[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0],Technicolor:[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0],Polaroid:[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0],Sepia:[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0],BlackWhite:[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]};for(var t in e)n[t]=a(n.ColorMatrix,{type:t,matrix:e[t],mainParameter:!1,colorsOnly:!0}),i.Image.filters[t].fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric,n=i.Image.filters,a=i.util.createClass;n.BlendColor=a(n.BaseFilter,{type:"BlendColor",color:"#F95C63",mode:"multiply",alpha:1,fragmentSource:{multiply:"gl_FragColor.rgb *= uColor.rgb;\n",screen:"gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);\n",add:"gl_FragColor.rgb += uColor.rgb;\n",diff:"gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);\n",subtract:"gl_FragColor.rgb -= uColor.rgb;\n",lighten:"gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);\n",darken:"gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);\n",exclusion:"gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);\n",overlay:"if (uColor.r < 0.5) {\ngl_FragColor.r *= 2.0 * uColor.r;\n} else {\ngl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);\n}\nif (uColor.g < 0.5) {\ngl_FragColor.g *= 2.0 * uColor.g;\n} else {\ngl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);\n}\nif (uColor.b < 0.5) {\ngl_FragColor.b *= 2.0 * uColor.b;\n} else {\ngl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);\n}\n",tint:"gl_FragColor.rgb *= (1.0 - uColor.a);\ngl_FragColor.rgb += uColor.rgb;\n"},buildSource:function(e){return"precision highp float;\nuniform sampler2D uTexture;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ngl_FragColor = color;\nif (color.a > 0.0) {\n"+this.fragmentSource[e]+"}\n}"},retrieveShader:function(e){var t,s=this.type+"_"+this.mode;return e.programCache.hasOwnProperty(s)||(t=this.buildSource(this.mode),e.programCache[s]=this.createProgram(e.context,t)),e.programCache[s]},applyTo2d:function(e){var t,s,c,h,l,d,p,m=e.imageData.data,b=m.length,y=1-this.alpha;t=(p=new i.Color(this.color).getSource())[0]*this.alpha,s=p[1]*this.alpha,c=p[2]*this.alpha;for(var w=0;w<b;w+=4)switch(h=m[w],l=m[w+1],d=m[w+2],this.mode){case"multiply":m[w]=h*t/255,m[w+1]=l*s/255,m[w+2]=d*c/255;break;case"screen":m[w]=255-(255-h)*(255-t)/255,m[w+1]=255-(255-l)*(255-s)/255,m[w+2]=255-(255-d)*(255-c)/255;break;case"add":m[w]=h+t,m[w+1]=l+s,m[w+2]=d+c;break;case"diff":case"difference":m[w]=Math.abs(h-t),m[w+1]=Math.abs(l-s),m[w+2]=Math.abs(d-c);break;case"subtract":m[w]=h-t,m[w+1]=l-s,m[w+2]=d-c;break;case"darken":m[w]=Math.min(h,t),m[w+1]=Math.min(l,s),m[w+2]=Math.min(d,c);break;case"lighten":m[w]=Math.max(h,t),m[w+1]=Math.max(l,s),m[w+2]=Math.max(d,c);break;case"overlay":m[w]=t<128?2*h*t/255:255-2*(255-h)*(255-t)/255,m[w+1]=s<128?2*l*s/255:255-2*(255-l)*(255-s)/255,m[w+2]=c<128?2*d*c/255:255-2*(255-d)*(255-c)/255;break;case"exclusion":m[w]=t+h-2*t*h/255,m[w+1]=s+l-2*s*l/255,m[w+2]=c+d-2*c*d/255;break;case"tint":m[w]=t+h*y,m[w+1]=s+l*y,m[w+2]=c+d*y}},getUniformLocations:function(e,t){return{uColor:e.getUniformLocation(t,"uColor")}},sendUniformData:function(e,t){var s=new i.Color(this.color).getSource();s[0]=this.alpha*s[0]/255,s[1]=this.alpha*s[1]/255,s[2]=this.alpha*s[2]/255,s[3]=this.alpha,e.uniform4fv(t.uColor,s)},toObject:function(){return{type:this.type,color:this.color,mode:this.mode,alpha:this.alpha}}}),i.Image.filters.BlendColor.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric,n=i.Image.filters,a=i.util.createClass;n.BlendImage=a(n.BaseFilter,{type:"BlendImage",image:null,mode:"multiply",alpha:1,vertexSource:"attribute vec2 aPosition;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nuniform mat3 uTransformMatrix;\nvoid main() {\nvTexCoord = aPosition;\nvTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;\ngl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);\n}",fragmentSource:{multiply:"precision highp float;\nuniform sampler2D uTexture;\nuniform sampler2D uImage;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec4 color2 = texture2D(uImage, vTexCoord2);\ncolor.rgba *= color2.rgba;\ngl_FragColor = color;\n}",mask:"precision highp float;\nuniform sampler2D uTexture;\nuniform sampler2D uImage;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec4 color2 = texture2D(uImage, vTexCoord2);\ncolor.a = color2.a;\ngl_FragColor = color;\n}"},retrieveShader:function(e){var t=this.type+"_"+this.mode,s=this.fragmentSource[this.mode];return e.programCache.hasOwnProperty(t)||(e.programCache[t]=this.createProgram(e.context,s)),e.programCache[t]},applyToWebGL:function(e){var t=e.context,s=this.createTexture(e.filterBackend,this.image);this.bindAdditionalTexture(t,s,t.TEXTURE1),this.callSuper("applyToWebGL",e),this.unbindAdditionalTexture(t,t.TEXTURE1)},createTexture:function(e,t){return e.getCachedTexture(t.cacheKey,t._element)},calculateMatrix:function(){var e=this.image,t=e._element.width,s=e._element.height;return[1/e.scaleX,0,0,0,1/e.scaleY,0,-e.left/t,-e.top/s,1]},applyTo2d:function(e){var t,s,c,h,l,d,p,m,b,y,w,T=e.imageData,k=e.filterBackend.resources,P=T.data,G=P.length,V=T.width,N=T.height,A=this.image;k.blendImage||(k.blendImage=i.util.createCanvasElement()),y=(b=k.blendImage).getContext("2d"),b.width!==V||b.height!==N?(b.width=V,b.height=N):y.clearRect(0,0,V,N),y.setTransform(A.scaleX,0,0,A.scaleY,A.left,A.top),y.drawImage(A._element,0,0,V,N),w=y.getImageData(0,0,V,N).data;for(var O=0;O<G;O+=4)switch(l=P[O],d=P[O+1],p=P[O+2],m=P[O+3],t=w[O],s=w[O+1],c=w[O+2],h=w[O+3],this.mode){case"multiply":P[O]=l*t/255,P[O+1]=d*s/255,P[O+2]=p*c/255,P[O+3]=m*h/255;break;case"mask":P[O+3]=h}},getUniformLocations:function(e,t){return{uTransformMatrix:e.getUniformLocation(t,"uTransformMatrix"),uImage:e.getUniformLocation(t,"uImage")}},sendUniformData:function(e,t){var s=this.calculateMatrix();e.uniform1i(t.uImage,1),e.uniformMatrix3fv(t.uTransformMatrix,!1,s)},toObject:function(){return{type:this.type,image:this.image&&this.image.toObject(),mode:this.mode,alpha:this.alpha}}}),i.Image.filters.BlendImage.fromObject=function(e,t){i.Image.fromObject(e.image,function(s){var c=i.util.object.clone(e);c.image=s,t(new i.Image.filters.BlendImage(c))})}}(o),function(r){var i=r.fabric||(r.fabric={}),n=Math.pow,a=Math.floor,e=Math.sqrt,t=Math.abs,s=Math.round,c=Math.sin,h=Math.ceil,l=i.Image.filters,d=i.util.createClass;l.Resize=d(l.BaseFilter,{type:"Resize",resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3,getUniformLocations:function(p,m){return{uDelta:p.getUniformLocation(m,"uDelta"),uTaps:p.getUniformLocation(m,"uTaps")}},sendUniformData:function(p,m){p.uniform2fv(m.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),p.uniform1fv(m.uTaps,this.taps)},retrieveShader:function(p){var m=this.getFilterWindow(),b=this.type+"_"+m;if(!p.programCache.hasOwnProperty(b)){var y=this.generateShader(m);p.programCache[b]=this.createProgram(p.context,y)}return p.programCache[b]},getFilterWindow:function(){var p=this.tempScale;return Math.ceil(this.lanczosLobes/p)},getTaps:function(){for(var p=this.lanczosCreate(this.lanczosLobes),m=this.tempScale,b=this.getFilterWindow(),y=new Array(b),w=1;w<=b;w++)y[w-1]=p(w*m);return y},generateShader:function(p){for(var m=new Array(p),b=this.fragmentSourceTOP,y=1;y<=p;y++)m[y-1]=y+".0 * uDelta";return b+="uniform float uTaps["+p+"];\n",b+="void main() {\n",b+="  vec4 color = texture2D(uTexture, vTexCoord);\n",b+="  float sum = 1.0;\n",m.forEach(function(w,T){b+="  color += texture2D(uTexture, vTexCoord + "+w+") * uTaps["+T+"];\n",b+="  color += texture2D(uTexture, vTexCoord - "+w+") * uTaps["+T+"];\n",b+="  sum += 2.0 * uTaps["+T+"];\n"}),b+="  gl_FragColor = color / sum;\n",b+="}"},fragmentSourceTOP:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec2 uDelta;\nvarying vec2 vTexCoord;\n",applyTo:function(p){p.webgl?(p.passes++,this.width=p.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=p.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),p.destinationWidth=this.dW,this._setupFrameBuffer(p),this.applyToWebGL(p),this._swapTextures(p),p.sourceWidth=p.destinationWidth,this.height=p.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),p.destinationHeight=this.dH,this._setupFrameBuffer(p),this.applyToWebGL(p),this._swapTextures(p),p.sourceHeight=p.destinationHeight):this.applyTo2d(p)},isNeutralState:function(){return this.scaleX===1&&this.scaleY===1},lanczosCreate:function(p){return function(m){if(m>=p||m<=-p)return 0;if(m<11920929e-14&&m>-11920929e-14)return 1;var b=(m*=Math.PI)/p;return c(m)/m*c(b)/b}},applyTo2d:function(p){var m=p.imageData,b=this.scaleX,y=this.scaleY;this.rcpScaleX=1/b,this.rcpScaleY=1/y;var w,T=m.width,k=m.height,P=s(T*b),G=s(k*y);this.resizeType==="sliceHack"?w=this.sliceByTwo(p,T,k,P,G):this.resizeType==="hermite"?w=this.hermiteFastResize(p,T,k,P,G):this.resizeType==="bilinear"?w=this.bilinearFiltering(p,T,k,P,G):this.resizeType==="lanczos"&&(w=this.lanczosResize(p,T,k,P,G)),p.imageData=w},sliceByTwo:function(p,m,b,y,w){var T,k,P=p.imageData,G=.5,V=!1,N=!1,A=m*G,O=b*G,B=i.filterBackend.resources,W=0,H=0,R=m,D=0;for(B.sliceByTwo||(B.sliceByTwo=document.createElement("canvas")),((T=B.sliceByTwo).width<1.5*m||T.height<b)&&(T.width=1.5*m,T.height=b),(k=T.getContext("2d")).clearRect(0,0,1.5*m,b),k.putImageData(P,0,0),y=a(y),w=a(w);!V||!N;)m=A,b=O,y<a(A*G)?A=a(A*G):(A=y,V=!0),w<a(O*G)?O=a(O*G):(O=w,N=!0),k.drawImage(T,W,H,m,b,R,D,A,O),W=R,H=D,D+=O;return k.getImageData(W,H,y,w)},lanczosResize:function(p,m,b,y,w){var T=p.imageData.data,k=p.ctx.createImageData(y,w),P=k.data,G=this.lanczosCreate(this.lanczosLobes),V=this.rcpScaleX,N=this.rcpScaleY,A=2/this.rcpScaleX,O=2/this.rcpScaleY,B=h(V*this.lanczosLobes/2),W=h(N*this.lanczosLobes/2),H={},R={},D={};return function j(X){var U,z,ie,Z,Q,te,ee,re,ae,ne,ge;for(R.x=(X+.5)*V,D.x=a(R.x),U=0;U<w;U++){for(R.y=(U+.5)*N,D.y=a(R.y),Q=0,te=0,ee=0,re=0,ae=0,z=D.x-B;z<=D.x+B;z++)if(!(z<0||z>=m)){ne=a(1e3*t(z-R.x)),H[ne]||(H[ne]={});for(var me=D.y-W;me<=D.y+W;me++)me<0||me>=b||(ge=a(1e3*t(me-R.y)),H[ne][ge]||(H[ne][ge]=G(e(n(ne*A,2)+n(ge*O,2))/1e3)),(ie=H[ne][ge])>0&&(Q+=ie,te+=ie*T[Z=4*(me*m+z)],ee+=ie*T[Z+1],re+=ie*T[Z+2],ae+=ie*T[Z+3]))}P[Z=4*(U*y+X)]=te/Q,P[Z+1]=ee/Q,P[Z+2]=re/Q,P[Z+3]=ae/Q}return++X<y?j(X):k}(0)},bilinearFiltering:function(p,m,b,y,w){var T,k,P,G,V,N,A,O,B,W=0,H=this.rcpScaleX,R=this.rcpScaleY,D=4*(m-1),j=p.imageData.data,X=p.ctx.createImageData(y,w),U=X.data;for(P=0;P<w;P++)for(G=0;G<y;G++)for(V=H*G-(T=a(H*G)),N=R*P-(k=a(R*P)),B=4*(k*m+T),A=0;A<4;A++)O=j[B+A]*(1-V)*(1-N)+j[B+4+A]*V*(1-N)+j[B+D+A]*N*(1-V)+j[B+D+4+A]*V*N,U[W++]=O;return X},hermiteFastResize:function(p,m,b,y,w){for(var T=this.rcpScaleX,k=this.rcpScaleY,P=h(T/2),G=h(k/2),V=p.imageData.data,N=p.ctx.createImageData(y,w),A=N.data,O=0;O<w;O++)for(var B=0;B<y;B++){for(var W=4*(B+O*y),H=0,R=0,D=0,j=0,X=0,U=0,z=0,ie=(O+.5)*k,Z=a(O*k);Z<(O+1)*k;Z++)for(var Q=t(ie-(Z+.5))/G,te=(B+.5)*T,ee=Q*Q,re=a(B*T);re<(B+1)*T;re++){var ae=t(te-(re+.5))/P,ne=e(ee+ae*ae);ne>1&&ne<-1||(H=2*ne*ne*ne-3*ne*ne+1)>0&&(z+=H*V[3+(ae=4*(re+Z*m))],D+=H,V[ae+3]<255&&(H=H*V[ae+3]/250),j+=H*V[ae],X+=H*V[ae+1],U+=H*V[ae+2],R+=H)}A[W]=j/R,A[W+1]=X/R,A[W+2]=U/R,A[W+3]=z/D}return N},toObject:function(){return{type:this.type,scaleX:this.scaleX,scaleY:this.scaleY,resizeType:this.resizeType,lanczosLobes:this.lanczosLobes}}}),i.Image.filters.Resize.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.Contrast=a(n.BaseFilter,{type:"Contrast",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uContrast;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));\ncolor.rgb = contrastF * (color.rgb - 0.5) + 0.5;\ngl_FragColor = color;\n}",contrast:0,mainParameter:"contrast",applyTo2d:function(e){if(this.contrast!==0){var t,s=e.imageData.data,c=s.length,h=Math.floor(255*this.contrast),l=259*(h+255)/(255*(259-h));for(t=0;t<c;t+=4)s[t]=l*(s[t]-128)+128,s[t+1]=l*(s[t+1]-128)+128,s[t+2]=l*(s[t+2]-128)+128}},getUniformLocations:function(e,t){return{uContrast:e.getUniformLocation(t,"uContrast")}},sendUniformData:function(e,t){e.uniform1f(t.uContrast,this.contrast)}}),i.Image.filters.Contrast.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.Saturation=a(n.BaseFilter,{type:"Saturation",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uSaturation;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat rgMax = max(color.r, color.g);\nfloat rgbMax = max(rgMax, color.b);\ncolor.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;\ncolor.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;\ncolor.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;\ngl_FragColor = color;\n}",saturation:0,mainParameter:"saturation",applyTo2d:function(e){if(this.saturation!==0){var t,s,c=e.imageData.data,h=c.length,l=-this.saturation;for(t=0;t<h;t+=4)s=Math.max(c[t],c[t+1],c[t+2]),c[t]+=s!==c[t]?(s-c[t])*l:0,c[t+1]+=s!==c[t+1]?(s-c[t+1])*l:0,c[t+2]+=s!==c[t+2]?(s-c[t+2])*l:0}},getUniformLocations:function(e,t){return{uSaturation:e.getUniformLocation(t,"uSaturation")}},sendUniformData:function(e,t){e.uniform1f(t.uSaturation,-this.saturation)}}),i.Image.filters.Saturation.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.Vibrance=a(n.BaseFilter,{type:"Vibrance",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uVibrance;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat max = max(color.r, max(color.g, color.b));\nfloat avg = (color.r + color.g + color.b) / 3.0;\nfloat amt = (abs(max - avg) * 2.0) * uVibrance;\ncolor.r += max != color.r ? (max - color.r) * amt : 0.00;\ncolor.g += max != color.g ? (max - color.g) * amt : 0.00;\ncolor.b += max != color.b ? (max - color.b) * amt : 0.00;\ngl_FragColor = color;\n}",vibrance:0,mainParameter:"vibrance",applyTo2d:function(e){if(this.vibrance!==0){var t,s,c,h,l=e.imageData.data,d=l.length,p=-this.vibrance;for(t=0;t<d;t+=4)s=Math.max(l[t],l[t+1],l[t+2]),c=(l[t]+l[t+1]+l[t+2])/3,h=2*Math.abs(s-c)/255*p,l[t]+=s!==l[t]?(s-l[t])*h:0,l[t+1]+=s!==l[t+1]?(s-l[t+1])*h:0,l[t+2]+=s!==l[t+2]?(s-l[t+2])*h:0}},getUniformLocations:function(e,t){return{uVibrance:e.getUniformLocation(t,"uVibrance")}},sendUniformData:function(e,t){e.uniform1f(t.uVibrance,-this.vibrance)}}),i.Image.filters.Vibrance.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.Blur=a(n.BaseFilter,{type:"Blur",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec2 uDelta;\nvarying vec2 vTexCoord;\nconst float nSamples = 15.0;\nvec3 v3offset = vec3(12.9898, 78.233, 151.7182);\nfloat random(vec3 scale) {\nreturn fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);\n}\nvoid main() {\nvec4 color = vec4(0.0);\nfloat total = 0.0;\nfloat offset = random(v3offset);\nfor (float t = -nSamples; t <= nSamples; t++) {\nfloat percent = (t + offset - 0.5) / nSamples;\nfloat weight = 1.0 - abs(percent);\ncolor += texture2D(uTexture, vTexCoord + uDelta * percent) * weight;\ntotal += weight;\n}\ngl_FragColor = color / total;\n}",blur:0,mainParameter:"blur",applyTo:function(e){e.webgl?(this.aspectRatio=e.sourceWidth/e.sourceHeight,e.passes++,this._setupFrameBuffer(e),this.horizontal=!0,this.applyToWebGL(e),this._swapTextures(e),this._setupFrameBuffer(e),this.horizontal=!1,this.applyToWebGL(e),this._swapTextures(e)):this.applyTo2d(e)},applyTo2d:function(e){e.imageData=this.simpleBlur(e)},simpleBlur:function(e){var t,s,c=e.filterBackend.resources,h=e.imageData.width,l=e.imageData.height;c.blurLayer1||(c.blurLayer1=i.util.createCanvasElement(),c.blurLayer2=i.util.createCanvasElement()),t=c.blurLayer1,s=c.blurLayer2,t.width===h&&t.height===l||(s.width=t.width=h,s.height=t.height=l);var d,p,m,b,y=t.getContext("2d"),w=s.getContext("2d"),T=.06*this.blur*.5;for(y.putImageData(e.imageData,0,0),w.clearRect(0,0,h,l),b=-15;b<=15;b++)m=T*(p=b/15)*h+(d=(Math.random()-.5)/4),w.globalAlpha=1-Math.abs(p),w.drawImage(t,m,d),y.drawImage(s,0,0),w.globalAlpha=1,w.clearRect(0,0,s.width,s.height);for(b=-15;b<=15;b++)m=T*(p=b/15)*l+(d=(Math.random()-.5)/4),w.globalAlpha=1-Math.abs(p),w.drawImage(t,d,m),y.drawImage(s,0,0),w.globalAlpha=1,w.clearRect(0,0,s.width,s.height);e.ctx.drawImage(t,0,0);var k=e.ctx.getImageData(0,0,t.width,t.height);return y.globalAlpha=1,y.clearRect(0,0,t.width,t.height),k},getUniformLocations:function(e,t){return{delta:e.getUniformLocation(t,"uDelta")}},sendUniformData:function(e,t){var s=this.chooseRightDelta();e.uniform2fv(t.delta,s)},chooseRightDelta:function(){var e,t=1,s=[0,0];return this.horizontal?this.aspectRatio>1&&(t=1/this.aspectRatio):this.aspectRatio<1&&(t=this.aspectRatio),e=t*this.blur*.12,this.horizontal?s[0]=e:s[1]=e,s}}),n.Blur.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.Gamma=a(n.BaseFilter,{type:"Gamma",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec3 uGamma;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec3 correction = (1.0 / uGamma);\ncolor.r = pow(color.r, correction.r);\ncolor.g = pow(color.g, correction.g);\ncolor.b = pow(color.b, correction.b);\ngl_FragColor = color;\ngl_FragColor.rgb *= color.a;\n}",gamma:[1,1,1],mainParameter:"gamma",initialize:function(e){this.gamma=[1,1,1],n.BaseFilter.prototype.initialize.call(this,e)},applyTo2d:function(e){var t,s=e.imageData.data,c=this.gamma,h=s.length,l=1/c[0],d=1/c[1],p=1/c[2];for(this.rVals||(this.rVals=new Uint8Array(256),this.gVals=new Uint8Array(256),this.bVals=new Uint8Array(256)),t=0,h=256;t<h;t++)this.rVals[t]=255*Math.pow(t/255,l),this.gVals[t]=255*Math.pow(t/255,d),this.bVals[t]=255*Math.pow(t/255,p);for(t=0,h=s.length;t<h;t+=4)s[t]=this.rVals[s[t]],s[t+1]=this.gVals[s[t+1]],s[t+2]=this.bVals[s[t+2]]},getUniformLocations:function(e,t){return{uGamma:e.getUniformLocation(t,"uGamma")}},sendUniformData:function(e,t){e.uniform3fv(t.uGamma,this.gamma)}}),i.Image.filters.Gamma.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.Composed=a(n.BaseFilter,{type:"Composed",subFilters:[],initialize:function(e){this.callSuper("initialize",e),this.subFilters=this.subFilters.slice(0)},applyTo:function(e){e.passes+=this.subFilters.length-1,this.subFilters.forEach(function(t){t.applyTo(e)})},toObject:function(){return i.util.object.extend(this.callSuper("toObject"),{subFilters:this.subFilters.map(function(e){return e.toObject()})})},isNeutralState:function(){return!this.subFilters.some(function(e){return!e.isNeutralState()})}}),i.Image.filters.Composed.fromObject=function(e,t){var s=(e.subFilters||[]).map(function(h){return new i.Image.filters[h.type](h)}),c=new i.Image.filters.Composed({subFilters:s});return t&&t(c),c}}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.HueRotation=a(n.ColorMatrix,{type:"HueRotation",rotation:0,mainParameter:"rotation",calculateMatrix:function(){var e=this.rotation*Math.PI,t=i.util.cos(e),s=i.util.sin(e),c=1/3,h=Math.sqrt(c)*s,l=1-t;this.matrix=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],this.matrix[0]=t+l/3,this.matrix[1]=c*l-h,this.matrix[2]=c*l+h,this.matrix[5]=c*l+h,this.matrix[6]=t+c*l,this.matrix[7]=c*l-h,this.matrix[10]=c*l-h,this.matrix[11]=c*l+h,this.matrix[12]=t+c*l},isNeutralState:function(e){return this.calculateMatrix(),n.BaseFilter.prototype.isNeutralState.call(this,e)},applyTo:function(e){this.calculateMatrix(),n.BaseFilter.prototype.applyTo.call(this,e)}}),i.Image.filters.HueRotation.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.util.object.clone;if(i.Text)i.warn("fabric.Text is already defined");else{var a="fontFamily fontWeight fontSize text underline overline linethrough textAlign fontStyle lineHeight textBackgroundColor charSpacing styles direction path pathStartOffset pathSide pathAlign".split(" ");i.Text=i.util.createClass(i.Object,{_dimensionAffectingProps:["fontSize","fontWeight","fontFamily","fontStyle","lineHeight","text","charSpacing","textAlign","styles","path","pathStartOffset","pathSide","pathAlign"],_reNewline:/\r?\n/,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,type:"text",fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:"left",fontStyle:"normal",lineHeight:1.16,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},textBackgroundColor:"",stateProperties:i.Object.prototype.stateProperties.concat(a),cacheProperties:i.Object.prototype.cacheProperties.concat(a),stroke:null,shadow:null,path:null,pathStartOffset:0,pathSide:"left",pathAlign:"baseline",_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.315,overline:-.88},_fontSizeMult:1.13,charSpacing:0,styles:null,_measuringContext:null,deltaY:0,direction:"ltr",_styleProperties:["stroke","strokeWidth","fill","fontFamily","fontSize","fontWeight","fontStyle","underline","overline","linethrough","deltaY","textBackgroundColor"],__charBounds:[],CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,initialize:function(e,t){this.styles=t&&t.styles||{},this.text=e,this.__skipDimension=!0,this.callSuper("initialize",t),this.path&&this.setPathInfo(),this.__skipDimension=!1,this.initDimensions(),this.setCoords(),this.setupState({propertySet:"_dimensionAffectingProps"})},setPathInfo:function(){var e=this.path;e&&(e.segmentsInfo=i.util.getPathSegmentsInfo(e.path))},getMeasuringContext:function(){return i._measuringContext||(i._measuringContext=this.canvas&&this.canvas.contextCache||i.util.createCanvasElement().getContext("2d")),i._measuringContext},_splitText:function(){var e=this._splitTextIntoLines(this.text);return this.textLines=e.lines,this._textLines=e.graphemeLines,this._unwrappedTextLines=e._unwrappedLines,this._text=e.graphemeText,e},initDimensions:function(){this.__skipDimension||(this._splitText(),this._clearCache(),this.path?(this.width=this.path.width,this.height=this.path.height):(this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,this.height=this.calcTextHeight()),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.saveState({propertySet:"_dimensionAffectingProps"}))},enlargeSpaces:function(){for(var e,t,s,c,h,l,d,p=0,m=this._textLines.length;p<m;p++)if((this.textAlign==="justify"||p!==m-1&&!this.isEndOfWrapping(p))&&(c=0,h=this._textLines[p],(t=this.getLineWidth(p))<this.width&&(d=this.textLines[p].match(this._reSpacesAndTabs)))){s=d.length,e=(this.width-t)/s;for(var b=0,y=h.length;b<=y;b++)l=this.__charBounds[p][b],this._reSpaceAndTab.test(h[b])?(l.width+=e,l.kernedWidth+=e,l.left+=c,c+=e):l.left+=c}},isEndOfWrapping:function(e){return e===this._textLines.length-1},missingNewlineOffset:function(){return 1},toString:function(){return"#<fabric.Text ("+this.complexity()+'): { "text": "'+this.text+'", "fontFamily": "'+this.fontFamily+'" }>'},_getCacheCanvasDimensions:function(){var e=this.callSuper("_getCacheCanvasDimensions"),t=this.fontSize;return e.width+=t*e.zoomX,e.height+=t*e.zoomY,e},_render:function(e){var t=this.path;t&&!t.isNotVisible()&&t._render(e),this._setTextStyles(e),this._renderTextLinesBackground(e),this._renderTextDecoration(e,"underline"),this._renderText(e),this._renderTextDecoration(e,"overline"),this._renderTextDecoration(e,"linethrough")},_renderText:function(e){this.paintFirst==="stroke"?(this._renderTextStroke(e),this._renderTextFill(e)):(this._renderTextFill(e),this._renderTextStroke(e))},_setTextStyles:function(e,t,s){if(e.textBaseline="alphabetical",this.path)switch(this.pathAlign){case"center":e.textBaseline="middle";break;case"ascender":e.textBaseline="top";break;case"descender":e.textBaseline="bottom"}e.font=this._getFontDeclaration(t,s)},calcTextWidth:function(){for(var e=this.getLineWidth(0),t=1,s=this._textLines.length;t<s;t++){var c=this.getLineWidth(t);c>e&&(e=c)}return e},_renderTextLine:function(e,t,s,c,h,l){this._renderChars(e,t,s,c,h,l)},_renderTextLinesBackground:function(e){if(this.textBackgroundColor||this.styleHas("textBackgroundColor")){for(var t,s,c,h,l,d,p,m=e.fillStyle,b=this._getLeftOffset(),y=this._getTopOffset(),w=0,T=0,k=this.path,P=0,G=this._textLines.length;P<G;P++)if(t=this.getHeightOfLine(P),this.textBackgroundColor||this.styleHas("textBackgroundColor",P)){c=this._textLines[P],s=this._getLineLeftOffset(P),T=0,w=0,h=this.getValueOfPropertyAt(P,0,"textBackgroundColor");for(var V=0,N=c.length;V<N;V++)l=this.__charBounds[P][V],d=this.getValueOfPropertyAt(P,V,"textBackgroundColor"),k?(e.save(),e.translate(l.renderLeft,l.renderTop),e.rotate(l.angle),e.fillStyle=d,d&&e.fillRect(-l.width/2,-t/this.lineHeight*(1-this._fontSizeFraction),l.width,t/this.lineHeight),e.restore()):d!==h?(p=b+s+w,this.direction==="rtl"&&(p=this.width-p-T),e.fillStyle=h,h&&e.fillRect(p,y,T,t/this.lineHeight),w=l.left,T=l.width,h=d):T+=l.kernedWidth;d&&!k&&(p=b+s+w,this.direction==="rtl"&&(p=this.width-p-T),e.fillStyle=d,e.fillRect(p,y,T,t/this.lineHeight)),y+=t}else y+=t;e.fillStyle=m,this._removeShadow(e)}},getFontCache:function(e){var t=e.fontFamily.toLowerCase();i.charWidthsCache[t]||(i.charWidthsCache[t]={});var s=i.charWidthsCache[t],c=e.fontStyle.toLowerCase()+"_"+(e.fontWeight+"").toLowerCase();return s[c]||(s[c]={}),s[c]},_measureChar:function(e,t,s,c){var h,l,d,p,m=this.getFontCache(t),b=s+e,y=this._getFontDeclaration(t)===this._getFontDeclaration(c),w=t.fontSize/this.CACHE_FONT_SIZE;if(s&&m[s]!==void 0&&(d=m[s]),m[e]!==void 0&&(p=h=m[e]),y&&m[b]!==void 0&&(p=(l=m[b])-d),h===void 0||d===void 0||l===void 0){var T=this.getMeasuringContext();this._setTextStyles(T,t,!0)}return h===void 0&&(p=h=T.measureText(e).width,m[e]=h),d===void 0&&y&&s&&(d=T.measureText(s).width,m[s]=d),y&&l===void 0&&(l=T.measureText(b).width,m[b]=l,p=l-d),{width:h*w,kernedWidth:p*w}},getHeightOfChar:function(e,t){return this.getValueOfPropertyAt(e,t,"fontSize")},measureLine:function(e){var t=this._measureLine(e);return this.charSpacing!==0&&(t.width-=this._getWidthOfCharSpacing()),t.width<0&&(t.width=0),t},_measureLine:function(e){var t,s,c,h,l,d,p=0,m=this._textLines[e],b=new Array(m.length),y=0,w=this.path,T=this.pathSide==="right";for(this.__charBounds[e]=b,t=0;t<m.length;t++)s=m[t],h=this._getGraphemeBox(s,e,t,c),b[t]=h,p+=h.kernedWidth,c=s;if(b[t]={left:h?h.left+h.width:0,width:0,kernedWidth:0,height:this.fontSize},w){switch(d=w.segmentsInfo[w.segmentsInfo.length-1].length,(l=i.util.getPointOnPath(w.path,0,w.segmentsInfo)).x+=w.pathOffset.x,l.y+=w.pathOffset.y,this.textAlign){case"left":y=T?d-p:0;break;case"center":y=(d-p)/2;break;case"right":y=T?0:d-p}for(y+=this.pathStartOffset*(T?-1:1),t=T?m.length-1:0;T?t>=0:t<m.length;T?t--:t++)h=b[t],y>d?y%=d:y<0&&(y+=d),this._setGraphemeOnPath(y,h,l),y+=h.kernedWidth}return{width:p,numOfSpaces:0}},_setGraphemeOnPath:function(e,t,s){var c=e+t.kernedWidth/2,h=this.path,l=i.util.getPointOnPath(h.path,c,h.segmentsInfo);t.renderLeft=l.x-s.x,t.renderTop=l.y-s.y,t.angle=l.angle+(this.pathSide==="right"?Math.PI:0)},_getGraphemeBox:function(e,t,s,c,h){var l,d=this.getCompleteStyleDeclaration(t,s),p=c?this.getCompleteStyleDeclaration(t,s-1):{},m=this._measureChar(e,d,c,p),b=m.kernedWidth,y=m.width;this.charSpacing!==0&&(y+=l=this._getWidthOfCharSpacing(),b+=l);var w={width:y,left:0,height:d.fontSize,kernedWidth:b,deltaY:d.deltaY};if(s>0&&!h){var T=this.__charBounds[t][s-1];w.left=T.left+T.width+m.kernedWidth-m.width}return w},getHeightOfLine:function(e){if(this.__lineHeights[e])return this.__lineHeights[e];for(var t=this._textLines[e],s=this.getHeightOfChar(e,0),c=1,h=t.length;c<h;c++)s=Math.max(this.getHeightOfChar(e,c),s);return this.__lineHeights[e]=s*this.lineHeight*this._fontSizeMult},calcTextHeight:function(){for(var e,t=0,s=0,c=this._textLines.length;s<c;s++)e=this.getHeightOfLine(s),t+=s===c-1?e/this.lineHeight:e;return t},_getLeftOffset:function(){return this.direction==="ltr"?-this.width/2:this.width/2},_getTopOffset:function(){return-this.height/2},_renderTextCommon:function(e,t){e.save();for(var s=0,c=this._getLeftOffset(),h=this._getTopOffset(),l=0,d=this._textLines.length;l<d;l++){var p=this.getHeightOfLine(l),m=p/this.lineHeight,b=this._getLineLeftOffset(l);this._renderTextLine(t,e,this._textLines[l],c+b,h+s+m,l),s+=p}e.restore()},_renderTextFill:function(e){(this.fill||this.styleHas("fill"))&&this._renderTextCommon(e,"fillText")},_renderTextStroke:function(e){(this.stroke&&this.strokeWidth!==0||!this.isEmptyStyles())&&(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(e),e.save(),this._setLineDash(e,this.strokeDashArray),e.beginPath(),this._renderTextCommon(e,"strokeText"),e.closePath(),e.restore())},_renderChars:function(e,t,s,c,h,l){var d,p,m,b,y,w=this.getHeightOfLine(l),T=this.textAlign.indexOf("justify")!==-1,k="",P=0,G=this.path,V=!T&&this.charSpacing===0&&this.isEmptyStyles(l)&&!G,N=this.direction==="ltr",A=this.direction==="ltr"?1:-1,O=t.canvas.getAttribute("dir");if(t.save(),O!==this.direction&&(t.canvas.setAttribute("dir",N?"ltr":"rtl"),t.direction=N?"ltr":"rtl",t.textAlign=N?"left":"right"),h-=w*this._fontSizeFraction/this.lineHeight,V)return this._renderChar(e,t,l,0,s.join(""),c,h,w),void t.restore();for(var B=0,W=s.length-1;B<=W;B++)b=B===W||this.charSpacing||G,k+=s[B],m=this.__charBounds[l][B],P===0?(c+=A*(m.kernedWidth-m.width),P+=m.width):P+=m.kernedWidth,T&&!b&&this._reSpaceAndTab.test(s[B])&&(b=!0),b||(d=d||this.getCompleteStyleDeclaration(l,B),p=this.getCompleteStyleDeclaration(l,B+1),b=this._hasStyleChanged(d,p)),b&&(G?(t.save(),t.translate(m.renderLeft,m.renderTop),t.rotate(m.angle),this._renderChar(e,t,l,B,k,-P/2,0,w),t.restore()):(y=c,this._renderChar(e,t,l,B,k,y,h,w)),k="",d=p,c+=A*P,P=0);t.restore()},_applyPatternGradientTransformText:function(e){var t,s=i.util.createCanvasElement(),c=this.width+this.strokeWidth,h=this.height+this.strokeWidth;return s.width=c,s.height=h,(t=s.getContext("2d")).beginPath(),t.moveTo(0,0),t.lineTo(c,0),t.lineTo(c,h),t.lineTo(0,h),t.closePath(),t.translate(c/2,h/2),t.fillStyle=e.toLive(t),this._applyPatternGradientTransform(t,e),t.fill(),t.createPattern(s,"no-repeat")},handleFiller:function(e,t,s){var c,h;return s.toLive?s.gradientUnits==="percentage"||s.gradientTransform||s.patternTransform?(c=-this.width/2,h=-this.height/2,e.translate(c,h),e[t]=this._applyPatternGradientTransformText(s),{offsetX:c,offsetY:h}):(e[t]=s.toLive(e,this),this._applyPatternGradientTransform(e,s)):(e[t]=s,{offsetX:0,offsetY:0})},_setStrokeStyles:function(e,t){return e.lineWidth=t.strokeWidth,e.lineCap=this.strokeLineCap,e.lineDashOffset=this.strokeDashOffset,e.lineJoin=this.strokeLineJoin,e.miterLimit=this.strokeMiterLimit,this.handleFiller(e,"strokeStyle",t.stroke)},_setFillStyles:function(e,t){return this.handleFiller(e,"fillStyle",t.fill)},_renderChar:function(e,t,s,c,h,l,d){var p,m,b=this._getStyleDeclaration(s,c),y=this.getCompleteStyleDeclaration(s,c),w=e==="fillText"&&y.fill,T=e==="strokeText"&&y.stroke&&y.strokeWidth;(T||w)&&(t.save(),w&&(p=this._setFillStyles(t,y)),T&&(m=this._setStrokeStyles(t,y)),t.font=this._getFontDeclaration(y),b&&b.textBackgroundColor&&this._removeShadow(t),b&&b.deltaY&&(d+=b.deltaY),w&&t.fillText(h,l-p.offsetX,d-p.offsetY),T&&t.strokeText(h,l-m.offsetX,d-m.offsetY),t.restore())},setSuperscript:function(e,t){return this._setScript(e,t,this.superscript)},setSubscript:function(e,t){return this._setScript(e,t,this.subscript)},_setScript:function(e,t,s){var c=this.get2DCursorLocation(e,!0),h=this.getValueOfPropertyAt(c.lineIndex,c.charIndex,"fontSize"),l=this.getValueOfPropertyAt(c.lineIndex,c.charIndex,"deltaY"),d={fontSize:h*s.size,deltaY:l+h*s.baseline};return this.setSelectionStyles(d,e,t),this},_hasStyleChanged:function(e,t){return e.fill!==t.fill||e.stroke!==t.stroke||e.strokeWidth!==t.strokeWidth||e.fontSize!==t.fontSize||e.fontFamily!==t.fontFamily||e.fontWeight!==t.fontWeight||e.fontStyle!==t.fontStyle||e.deltaY!==t.deltaY},_hasStyleChangedForSvg:function(e,t){return this._hasStyleChanged(e,t)||e.overline!==t.overline||e.underline!==t.underline||e.linethrough!==t.linethrough},_getLineLeftOffset:function(e){var t=this.getLineWidth(e),s=this.width-t,c=this.textAlign,h=this.direction,l=0,d=this.isEndOfWrapping(e);return c==="justify"||c==="justify-center"&&!d||c==="justify-right"&&!d||c==="justify-left"&&!d?0:(c==="center"&&(l=s/2),c==="right"&&(l=s),c==="justify-center"&&(l=s/2),c==="justify-right"&&(l=s),h==="rtl"&&(l-=s),l)},_clearCache:function(){this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]},_shouldClearDimensionCache:function(){var e=this._forceClearCache;return e||(e=this.hasStateChanged("_dimensionAffectingProps")),e&&(this.dirty=!0,this._forceClearCache=!1),e},getLineWidth:function(e){if(this.__lineWidths[e]!==void 0)return this.__lineWidths[e];var t=this.measureLine(e).width;return this.__lineWidths[e]=t,t},_getWidthOfCharSpacing:function(){return this.charSpacing!==0?this.fontSize*this.charSpacing/1e3:0},getValueOfPropertyAt:function(e,t,s){var c=this._getStyleDeclaration(e,t);return c&&c[s]!==void 0?c[s]:this[s]},_renderTextDecoration:function(e,t){if(this[t]||this.styleHas(t)){for(var s,c,h,l,d,p,m,b,y,w,T,k,P,G,V,N,A=this._getLeftOffset(),O=this._getTopOffset(),B=this.path,W=this._getWidthOfCharSpacing(),H=this.offsets[t],R=0,D=this._textLines.length;R<D;R++)if(s=this.getHeightOfLine(R),this[t]||this.styleHas(t,R)){m=this._textLines[R],G=s/this.lineHeight,l=this._getLineLeftOffset(R),w=0,T=0,b=this.getValueOfPropertyAt(R,0,t),N=this.getValueOfPropertyAt(R,0,"fill"),y=O+G*(1-this._fontSizeFraction),c=this.getHeightOfChar(R,0),d=this.getValueOfPropertyAt(R,0,"deltaY");for(var j=0,X=m.length;j<X;j++)if(k=this.__charBounds[R][j],P=this.getValueOfPropertyAt(R,j,t),V=this.getValueOfPropertyAt(R,j,"fill"),h=this.getHeightOfChar(R,j),p=this.getValueOfPropertyAt(R,j,"deltaY"),B&&P&&V)e.save(),e.fillStyle=N,e.translate(k.renderLeft,k.renderTop),e.rotate(k.angle),e.fillRect(-k.kernedWidth/2,H*h+p,k.kernedWidth,this.fontSize/15),e.restore();else if((P!==b||V!==N||h!==c||p!==d)&&T>0){var U=A+l+w;this.direction==="rtl"&&(U=this.width-U-T),b&&N&&(e.fillStyle=N,e.fillRect(U,y+H*c+d,T,this.fontSize/15)),w=k.left,T=k.width,b=P,N=V,c=h,d=p}else T+=k.kernedWidth;U=A+l+w,this.direction==="rtl"&&(U=this.width-U-T),e.fillStyle=V,P&&V&&e.fillRect(U,y+H*c+d,T-W,this.fontSize/15),O+=s}else O+=s;this._removeShadow(e)}},_getFontDeclaration:function(e,t){var s=e||this,c=this.fontFamily,h=i.Text.genericFonts.indexOf(c.toLowerCase())>-1,l=c===void 0||c.indexOf("'")>-1||c.indexOf(",")>-1||c.indexOf('"')>-1||h?s.fontFamily:'"'+s.fontFamily+'"';return[i.isLikelyNode?s.fontWeight:s.fontStyle,i.isLikelyNode?s.fontStyle:s.fontWeight,t?this.CACHE_FONT_SIZE+"px":s.fontSize+"px",l].join(" ")},render:function(e){this.visible&&(this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(this._shouldClearDimensionCache()&&this.initDimensions(),this.callSuper("render",e)))},_splitTextIntoLines:function(e){for(var t=e.split(this._reNewline),s=new Array(t.length),c=["\n"],h=[],l=0;l<t.length;l++)s[l]=i.util.string.graphemeSplit(t[l]),h=h.concat(s[l],c);return h.pop(),{_unwrappedLines:s,lines:t,graphemeText:h,graphemeLines:s}},toObject:function(e){var t=a.concat(e),s=this.callSuper("toObject",t);return s.styles=n(this.styles,!0),s.path&&(s.path=this.path.toObject()),s},set:function(e,t){this.callSuper("set",e,t);var s=!1,c=!1;if(typeof e=="object")for(var h in e)h==="path"&&this.setPathInfo(),s=s||this._dimensionAffectingProps.indexOf(h)!==-1,c=c||h==="path";else s=this._dimensionAffectingProps.indexOf(e)!==-1,c=e==="path";return c&&this.setPathInfo(),s&&(this.initDimensions(),this.setCoords()),this},complexity:function(){return 1}}),i.Text.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("x y dx dy font-family font-style font-weight font-size letter-spacing text-decoration text-anchor".split(" ")),i.Text.DEFAULT_SVG_FONT_SIZE=16,i.Text.fromElement=function(e,t,s){if(!e)return t(null);var c=i.parseAttributes(e,i.Text.ATTRIBUTE_NAMES),h=c.textAnchor||"left";if((s=i.util.object.extend(s?n(s):{},c)).top=s.top||0,s.left=s.left||0,c.textDecoration){var l=c.textDecoration;l.indexOf("underline")!==-1&&(s.underline=!0),l.indexOf("overline")!==-1&&(s.overline=!0),l.indexOf("line-through")!==-1&&(s.linethrough=!0),delete s.textDecoration}"dx"in c&&(s.left+=c.dx),"dy"in c&&(s.top+=c.dy),"fontSize"in s||(s.fontSize=i.Text.DEFAULT_SVG_FONT_SIZE);var d="";"textContent"in e?d=e.textContent:"firstChild"in e&&e.firstChild!==null&&"data"in e.firstChild&&e.firstChild.data!==null&&(d=e.firstChild.data),d=d.replace(/^\s+|\s+$|\n+/g,"").replace(/\s+/g," ");var p=s.strokeWidth;s.strokeWidth=0;var m=new i.Text(d,s),b=m.getScaledHeight()/m.height,y=((m.height+m.strokeWidth)*m.lineHeight-m.height)*b,w=m.getScaledHeight()+y,T=0;h==="center"&&(T=m.getScaledWidth()/2),h==="right"&&(T=m.getScaledWidth()),m.set({left:m.left-T,top:m.top-(w-m.fontSize*(.07+m._fontSizeFraction))/m.lineHeight,strokeWidth:p!==void 0?p:1}),t(m)},i.Text.fromObject=function(e,t){var s=n(e),c=e.path;return delete s.path,i.Object._fromObject("Text",s,function(h){c?i.Object._fromObject("Path",c,function(l){h.set("path",l),t(h)},"path"):t(h)},"text")},i.Text.genericFonts=["sans-serif","serif","cursive","fantasy","monospace"],i.util.createAccessors&&i.util.createAccessors(i.Text)}}(o),g.util.object.extend(g.Text.prototype,{isEmptyStyles:function(r){if(!this.styles||r!==void 0&&!this.styles[r])return!0;var i=r===void 0?this.styles:{line:this.styles[r]};for(var n in i)for(var a in i[n])for(var e in i[n][a])return!1;return!0},styleHas:function(r,i){if(!this.styles||!r||r===""||i!==void 0&&!this.styles[i])return!1;var n=i===void 0?this.styles:{0:this.styles[i]};for(var a in n)for(var e in n[a])if(n[a][e][r]!==void 0)return!0;return!1},cleanStyle:function(r){if(!this.styles||!r||r==="")return!1;var i,n,a=this.styles,e=0,t=!0,s=0;for(var c in a){for(var h in i=0,a[c]){var l;e++,(l=a[c][h]).hasOwnProperty(r)?(n?l[r]!==n&&(t=!1):n=l[r],l[r]===this[r]&&delete l[r]):t=!1,Object.keys(l).length!==0?i++:delete a[c][h]}i===0&&delete a[c]}for(var d=0;d<this._textLines.length;d++)s+=this._textLines[d].length;t&&e===s&&(this[r]=n,this.removeStyle(r))},removeStyle:function(r){if(this.styles&&r&&r!==""){var i,n,a,e=this.styles;for(n in e){for(a in i=e[n])delete i[a][r],Object.keys(i[a]).length===0&&delete i[a];Object.keys(i).length===0&&delete e[n]}}},_extendStyles:function(r,i){var n=this.get2DCursorLocation(r);this._getLineStyle(n.lineIndex)||this._setLineStyle(n.lineIndex),this._getStyleDeclaration(n.lineIndex,n.charIndex)||this._setStyleDeclaration(n.lineIndex,n.charIndex,{}),g.util.object.extend(this._getStyleDeclaration(n.lineIndex,n.charIndex),i)},get2DCursorLocation:function(r,i){r===void 0&&(r=this.selectionStart);for(var n=i?this._unwrappedTextLines:this._textLines,a=n.length,e=0;e<a;e++){if(r<=n[e].length)return{lineIndex:e,charIndex:r};r-=n[e].length+this.missingNewlineOffset(e)}return{lineIndex:e-1,charIndex:n[e-1].length<r?n[e-1].length:r}},getSelectionStyles:function(r,i,n){r===void 0&&(r=this.selectionStart||0),i===void 0&&(i=this.selectionEnd||r);for(var a=[],e=r;e<i;e++)a.push(this.getStyleAtPosition(e,n));return a},getStyleAtPosition:function(r,i){var n=this.get2DCursorLocation(r);return(i?this.getCompleteStyleDeclaration(n.lineIndex,n.charIndex):this._getStyleDeclaration(n.lineIndex,n.charIndex))||{}},setSelectionStyles:function(r,i,n){i===void 0&&(i=this.selectionStart||0),n===void 0&&(n=this.selectionEnd||i);for(var a=i;a<n;a++)this._extendStyles(a,r);return this._forceClearCache=!0,this},_getStyleDeclaration:function(r,i){var n=this.styles&&this.styles[r];return n?n[i]:null},getCompleteStyleDeclaration:function(r,i){for(var n,a=this._getStyleDeclaration(r,i)||{},e={},t=0;t<this._styleProperties.length;t++)e[n=this._styleProperties[t]]=a[n]===void 0?this[n]:a[n];return e},_setStyleDeclaration:function(r,i,n){this.styles[r][i]=n},_deleteStyleDeclaration:function(r,i){delete this.styles[r][i]},_getLineStyle:function(r){return!!this.styles[r]},_setLineStyle:function(r){this.styles[r]={}},_deleteLineStyle:function(r){delete this.styles[r]}}),function(){function r(i){i.textDecoration&&(i.textDecoration.indexOf("underline")>-1&&(i.underline=!0),i.textDecoration.indexOf("line-through")>-1&&(i.linethrough=!0),i.textDecoration.indexOf("overline")>-1&&(i.overline=!0),delete i.textDecoration)}g.IText=g.util.createClass(g.Text,g.Observable,{type:"i-text",selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"",cursorDelay:1e3,cursorDuration:600,caching:!0,hiddenTextareaContainer:null,_reSpace:/\s|\n/,_currentCursorOpacity:0,_selectionDirection:null,_abortCursorAnimation:!1,__widthOfSpace:[],inCompositionMode:!1,initialize:function(i,n){this.callSuper("initialize",i,n),this.initBehavior()},setSelectionStart:function(i){i=Math.max(i,0),this._updateAndFire("selectionStart",i)},setSelectionEnd:function(i){i=Math.min(i,this.text.length),this._updateAndFire("selectionEnd",i)},_updateAndFire:function(i,n){this[i]!==n&&(this._fireSelectionChanged(),this[i]=n),this._updateTextarea()},_fireSelectionChanged:function(){this.fire("selection:changed"),this.canvas&&this.canvas.fire("text:selection:changed",{target:this})},initDimensions:function(){this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this.callSuper("initDimensions")},render:function(i){this.clearContextTop(),this.callSuper("render",i),this.cursorOffsetCache={},this.renderCursorOrSelection()},_render:function(i){this.callSuper("_render",i)},clearContextTop:function(i){if(this.isEditing&&this.canvas&&this.canvas.contextTop){var n=this.canvas.contextTop,a=this.canvas.viewportTransform;n.save(),n.transform(a[0],a[1],a[2],a[3],a[4],a[5]),this.transform(n),this._clearTextArea(n),i||n.restore()}},renderCursorOrSelection:function(){if(this.isEditing&&this.canvas&&this.canvas.contextTop){var i=this._getCursorBoundaries(),n=this.canvas.contextTop;this.clearContextTop(!0),this.selectionStart===this.selectionEnd?this.renderCursor(i,n):this.renderSelection(i,n),n.restore()}},_clearTextArea:function(i){var n=this.width+4,a=this.height+4;i.clearRect(-n/2,-a/2,n,a)},_getCursorBoundaries:function(i){i===void 0&&(i=this.selectionStart);var n=this._getLeftOffset(),a=this._getTopOffset(),e=this._getCursorBoundariesOffsets(i);return{left:n,top:a,leftOffset:e.left,topOffset:e.top}},_getCursorBoundariesOffsets:function(i){if(this.cursorOffsetCache&&"top"in this.cursorOffsetCache)return this.cursorOffsetCache;var n,a,e,t,s=0,c=0,h=this.get2DCursorLocation(i);e=h.charIndex,a=h.lineIndex;for(var l=0;l<a;l++)s+=this.getHeightOfLine(l);n=this._getLineLeftOffset(a);var d=this.__charBounds[a][e];return d&&(c=d.left),this.charSpacing!==0&&e===this._textLines[a].length&&(c-=this._getWidthOfCharSpacing()),t={top:s,left:n+(c>0?c:0)},this.direction==="rtl"&&(t.left*=-1),this.cursorOffsetCache=t,this.cursorOffsetCache},renderCursor:function(i,n){var a=this.get2DCursorLocation(),e=a.lineIndex,t=a.charIndex>0?a.charIndex-1:0,s=this.getValueOfPropertyAt(e,t,"fontSize"),c=this.scaleX*this.canvas.getZoom(),h=this.cursorWidth/c,l=i.topOffset,d=this.getValueOfPropertyAt(e,t,"deltaY");l+=(1-this._fontSizeFraction)*this.getHeightOfLine(e)/this.lineHeight-s*(1-this._fontSizeFraction),this.inCompositionMode&&this.renderSelection(i,n),n.fillStyle=this.cursorColor||this.getValueOfPropertyAt(e,t,"fill"),n.globalAlpha=this.__isMousedown?1:this._currentCursorOpacity,n.fillRect(i.left+i.leftOffset-h/2,l+i.top+d,h,s)},renderSelection:function(i,n){for(var a=this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,e=this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd,t=this.textAlign.indexOf("justify")!==-1,s=this.get2DCursorLocation(a),c=this.get2DCursorLocation(e),h=s.lineIndex,l=c.lineIndex,d=s.charIndex<0?0:s.charIndex,p=c.charIndex<0?0:c.charIndex,m=h;m<=l;m++){var b,y=this._getLineLeftOffset(m)||0,w=this.getHeightOfLine(m),T=0,k=0;if(m===h&&(T=this.__charBounds[h][d].left),m>=h&&m<l)k=t&&!this.isEndOfWrapping(m)?this.width:this.getLineWidth(m)||5;else if(m===l)if(p===0)k=this.__charBounds[l][p].left;else{var P=this._getWidthOfCharSpacing();k=this.__charBounds[l][p-1].left+this.__charBounds[l][p-1].width-P}b=w,(this.lineHeight<1||m===l&&this.lineHeight>1)&&(w/=this.lineHeight);var G=i.left+y+T,V=k-T,N=w,A=0;this.inCompositionMode?(n.fillStyle=this.compositionColor||"black",N=1,A=w):n.fillStyle=this.selectionColor,this.direction==="rtl"&&(G=this.width-G-V),n.fillRect(G,i.top+i.topOffset+A,V,N),i.topOffset+=b}},getCurrentCharFontSize:function(){var i=this._getCurrentCharIndex();return this.getValueOfPropertyAt(i.l,i.c,"fontSize")},getCurrentCharColor:function(){var i=this._getCurrentCharIndex();return this.getValueOfPropertyAt(i.l,i.c,"fill")},_getCurrentCharIndex:function(){var i=this.get2DCursorLocation(this.selectionStart,!0),n=i.charIndex>0?i.charIndex-1:0;return{l:i.lineIndex,c:n}}}),g.IText.fromObject=function(i,n){if(r(i),i.styles)for(var a in i.styles)for(var e in i.styles[a])r(i.styles[a][e]);g.Object._fromObject("IText",i,n,"text")}}(),be=g.util.object.clone,g.util.object.extend(g.IText.prototype,{initBehavior:function(){this.initAddedHandler(),this.initRemovedHandler(),this.initCursorSelectionHandlers(),this.initDoubleClickSimulation(),this.mouseMoveHandler=this.mouseMoveHandler.bind(this)},onDeselect:function(){this.isEditing&&this.exitEditing(),this.selected=!1},initAddedHandler:function(){var r=this;this.on("added",function(){var i=r.canvas;i&&(i._hasITextHandlers||(i._hasITextHandlers=!0,r._initCanvasHandlers(i)),i._iTextInstances=i._iTextInstances||[],i._iTextInstances.push(r))})},initRemovedHandler:function(){var r=this;this.on("removed",function(){var i=r.canvas;i&&(i._iTextInstances=i._iTextInstances||[],g.util.removeFromArray(i._iTextInstances,r),i._iTextInstances.length===0&&(i._hasITextHandlers=!1,r._removeCanvasHandlers(i)))})},_initCanvasHandlers:function(r){r._mouseUpITextHandler=function(){r._iTextInstances&&r._iTextInstances.forEach(function(i){i.__isMousedown=!1})},r.on("mouse:up",r._mouseUpITextHandler)},_removeCanvasHandlers:function(r){r.off("mouse:up",r._mouseUpITextHandler)},_tick:function(){this._currentTickState=this._animateCursor(this,1,this.cursorDuration,"_onTickComplete")},_animateCursor:function(r,i,n,a){var e;return e={isAborted:!1,abort:function(){this.isAborted=!0}},r.animate("_currentCursorOpacity",i,{duration:n,onComplete:function(){e.isAborted||r[a]()},onChange:function(){r.canvas&&r.selectionStart===r.selectionEnd&&r.renderCursorOrSelection()},abort:function(){return e.isAborted}}),e},_onTickComplete:function(){var r=this;this._cursorTimeout1&&clearTimeout(this._cursorTimeout1),this._cursorTimeout1=setTimeout(function(){r._currentTickCompleteState=r._animateCursor(r,0,this.cursorDuration/2,"_tick")},100)},initDelayedCursor:function(r){var i=this,n=r?0:this.cursorDelay;this.abortCursorAnimation(),this._currentCursorOpacity=1,this._cursorTimeout2=setTimeout(function(){i._tick()},n)},abortCursorAnimation:function(){var r=this._currentTickState||this._currentTickCompleteState,i=this.canvas;this._currentTickState&&this._currentTickState.abort(),this._currentTickCompleteState&&this._currentTickCompleteState.abort(),clearTimeout(this._cursorTimeout1),clearTimeout(this._cursorTimeout2),this._currentCursorOpacity=0,r&&i&&i.clearContext(i.contextTop||i.contextContainer)},selectAll:function(){return this.selectionStart=0,this.selectionEnd=this._text.length,this._fireSelectionChanged(),this._updateTextarea(),this},getSelectedText:function(){return this._text.slice(this.selectionStart,this.selectionEnd).join("")},findWordBoundaryLeft:function(r){var i=0,n=r-1;if(this._reSpace.test(this._text[n]))for(;this._reSpace.test(this._text[n]);)i++,n--;for(;/\S/.test(this._text[n])&&n>-1;)i++,n--;return r-i},findWordBoundaryRight:function(r){var i=0,n=r;if(this._reSpace.test(this._text[n]))for(;this._reSpace.test(this._text[n]);)i++,n++;for(;/\S/.test(this._text[n])&&n<this._text.length;)i++,n++;return r+i},findLineBoundaryLeft:function(r){for(var i=0,n=r-1;!/\n/.test(this._text[n])&&n>-1;)i++,n--;return r-i},findLineBoundaryRight:function(r){for(var i=0,n=r;!/\n/.test(this._text[n])&&n<this._text.length;)i++,n++;return r+i},searchWordBoundary:function(r,i){for(var n=this._text,a=this._reSpace.test(n[r])?r-1:r,e=n[a],t=g.reNonWord;!t.test(e)&&a>0&&a<n.length;)e=n[a+=i];return t.test(e)&&(a+=i===1?0:1),a},selectWord:function(r){r=r||this.selectionStart;var i=this.searchWordBoundary(r,-1),n=this.searchWordBoundary(r,1);this.selectionStart=i,this.selectionEnd=n,this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()},selectLine:function(r){r=r||this.selectionStart;var i=this.findLineBoundaryLeft(r),n=this.findLineBoundaryRight(r);return this.selectionStart=i,this.selectionEnd=n,this._fireSelectionChanged(),this._updateTextarea(),this},enterEditing:function(r){if(!this.isEditing&&this.editable)return this.canvas&&(this.canvas.calcOffset(),this.exitEditingOnOthers(this.canvas)),this.isEditing=!0,this.initHiddenTextarea(r),this.hiddenTextarea.focus(),this.hiddenTextarea.value=this.text,this._updateTextarea(),this._saveEditingProps(),this._setEditingProps(),this._textBeforeEdit=this.text,this._tick(),this.fire("editing:entered"),this._fireSelectionChanged(),this.canvas?(this.canvas.fire("text:editing:entered",{target:this}),this.initMouseMoveHandler(),this.canvas.requestRenderAll(),this):this},exitEditingOnOthers:function(r){r._iTextInstances&&r._iTextInstances.forEach(function(i){i.selected=!1,i.isEditing&&i.exitEditing()})},initMouseMoveHandler:function(){this.canvas.on("mouse:move",this.mouseMoveHandler)},mouseMoveHandler:function(r){if(this.__isMousedown&&this.isEditing){var i=this.getSelectionStartFromPointer(r.e),n=this.selectionStart,a=this.selectionEnd;(i===this.__selectionStartOnMouseDown&&n!==a||n!==i&&a!==i)&&(i>this.__selectionStartOnMouseDown?(this.selectionStart=this.__selectionStartOnMouseDown,this.selectionEnd=i):(this.selectionStart=i,this.selectionEnd=this.__selectionStartOnMouseDown),this.selectionStart===n&&this.selectionEnd===a||(this.restartCursorIfNeeded(),this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()))}},_setEditingProps:function(){this.hoverCursor="text",this.canvas&&(this.canvas.defaultCursor=this.canvas.moveCursor="text"),this.borderColor=this.editingBorderColor,this.hasControls=this.selectable=!1,this.lockMovementX=this.lockMovementY=!0},fromStringToGraphemeSelection:function(r,i,n){var a=n.slice(0,r),e=g.util.string.graphemeSplit(a).length;if(r===i)return{selectionStart:e,selectionEnd:e};var t=n.slice(r,i);return{selectionStart:e,selectionEnd:e+g.util.string.graphemeSplit(t).length}},fromGraphemeToStringSelection:function(r,i,n){var a=n.slice(0,r).join("").length;return r===i?{selectionStart:a,selectionEnd:a}:{selectionStart:a,selectionEnd:a+n.slice(r,i).join("").length}},_updateTextarea:function(){if(this.cursorOffsetCache={},this.hiddenTextarea){if(!this.inCompositionMode){var r=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text);this.hiddenTextarea.selectionStart=r.selectionStart,this.hiddenTextarea.selectionEnd=r.selectionEnd}this.updateTextareaPosition()}},updateFromTextArea:function(){if(this.hiddenTextarea){this.cursorOffsetCache={},this.text=this.hiddenTextarea.value,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords());var r=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value);this.selectionEnd=this.selectionStart=r.selectionEnd,this.inCompositionMode||(this.selectionStart=r.selectionStart),this.updateTextareaPosition()}},updateTextareaPosition:function(){if(this.selectionStart===this.selectionEnd){var r=this._calcTextareaPosition();this.hiddenTextarea.style.left=r.left,this.hiddenTextarea.style.top=r.top}},_calcTextareaPosition:function(){if(!this.canvas)return{x:1,y:1};var r=this.inCompositionMode?this.compositionStart:this.selectionStart,i=this._getCursorBoundaries(r),n=this.get2DCursorLocation(r),a=n.lineIndex,e=n.charIndex,t=this.getValueOfPropertyAt(a,e,"fontSize")*this.lineHeight,s=i.leftOffset,c=this.calcTransformMatrix(),h={x:i.left+s,y:i.top+i.topOffset+t},l=this.canvas.getRetinaScaling(),d=this.canvas.upperCanvasEl,p=d.width/l,m=d.height/l,b=p-t,y=m-t,w=d.clientWidth/p,T=d.clientHeight/m;return h=g.util.transformPoint(h,c),(h=g.util.transformPoint(h,this.canvas.viewportTransform)).x*=w,h.y*=T,h.x<0&&(h.x=0),h.x>b&&(h.x=b),h.y<0&&(h.y=0),h.y>y&&(h.y=y),h.x+=this.canvas._offset.left,h.y+=this.canvas._offset.top,{left:h.x+"px",top:h.y+"px",fontSize:t+"px",charHeight:t}},_saveEditingProps:function(){this._savedProps={hasControls:this.hasControls,borderColor:this.borderColor,lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,hoverCursor:this.hoverCursor,selectable:this.selectable,defaultCursor:this.canvas&&this.canvas.defaultCursor,moveCursor:this.canvas&&this.canvas.moveCursor}},_restoreEditingProps:function(){this._savedProps&&(this.hoverCursor=this._savedProps.hoverCursor,this.hasControls=this._savedProps.hasControls,this.borderColor=this._savedProps.borderColor,this.selectable=this._savedProps.selectable,this.lockMovementX=this._savedProps.lockMovementX,this.lockMovementY=this._savedProps.lockMovementY,this.canvas&&(this.canvas.defaultCursor=this._savedProps.defaultCursor,this.canvas.moveCursor=this._savedProps.moveCursor))},exitEditing:function(){var r=this._textBeforeEdit!==this.text,i=this.hiddenTextarea;return this.selected=!1,this.isEditing=!1,this.selectionEnd=this.selectionStart,i&&(i.blur&&i.blur(),i.parentNode&&i.parentNode.removeChild(i)),this.hiddenTextarea=null,this.abortCursorAnimation(),this._restoreEditingProps(),this._currentCursorOpacity=0,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this.fire("editing:exited"),r&&this.fire("modified"),this.canvas&&(this.canvas.off("mouse:move",this.mouseMoveHandler),this.canvas.fire("text:editing:exited",{target:this}),r&&this.canvas.fire("object:modified",{target:this})),this},_removeExtraneousStyles:function(){for(var r in this.styles)this._textLines[r]||delete this.styles[r]},removeStyleFromTo:function(r,i){var n,a,e=this.get2DCursorLocation(r,!0),t=this.get2DCursorLocation(i,!0),s=e.lineIndex,c=e.charIndex,h=t.lineIndex,l=t.charIndex;if(s!==h){if(this.styles[s])for(n=c;n<this._unwrappedTextLines[s].length;n++)delete this.styles[s][n];if(this.styles[h])for(n=l;n<this._unwrappedTextLines[h].length;n++)(a=this.styles[h][n])&&(this.styles[s]||(this.styles[s]={}),this.styles[s][c+n-l]=a);for(n=s+1;n<=h;n++)delete this.styles[n];this.shiftLineStyles(h,s-h)}else if(this.styles[s]){a=this.styles[s];var d,p,m=l-c;for(n=c;n<l;n++)delete a[n];for(p in this.styles[s])(d=parseInt(p,10))>=l&&(a[d-m]=a[p],delete a[p])}},shiftLineStyles:function(r,i){var n=be(this.styles);for(var a in this.styles){var e=parseInt(a,10);e>r&&(this.styles[e+i]=n[e],n[e-i]||delete this.styles[e])}},restartCursorIfNeeded:function(){this._currentTickState&&!this._currentTickState.isAborted&&this._currentTickCompleteState&&!this._currentTickCompleteState.isAborted||this.initDelayedCursor()},insertNewlineStyleObject:function(r,i,n,a){var e,t={},s=!1,c=this._unwrappedTextLines[r].length===i;for(var h in n||(n=1),this.shiftLineStyles(r,n),this.styles[r]&&(e=this.styles[r][i===0?i:i-1]),this.styles[r]){var l=parseInt(h,10);l>=i&&(s=!0,t[l-i]=this.styles[r][h],c&&i===0||delete this.styles[r][h])}var d=!1;for(s&&!c&&(this.styles[r+n]=t,d=!0),d&&n--;n>0;)a&&a[n-1]?this.styles[r+n]={0:be(a[n-1])}:e?this.styles[r+n]={0:be(e)}:delete this.styles[r+n],n--;this._forceClearCache=!0},insertCharStyleObject:function(r,i,n,a){this.styles||(this.styles={});var e=this.styles[r],t=e?be(e):{};for(var s in n||(n=1),t){var c=parseInt(s,10);c>=i&&(e[c+n]=t[c],t[c-n]||delete e[c])}if(this._forceClearCache=!0,a)for(;n--;)Object.keys(a[n]).length&&(this.styles[r]||(this.styles[r]={}),this.styles[r][i+n]=be(a[n]));else if(e)for(var h=e[i?i-1:1];h&&n--;)this.styles[r][i+n]=be(h)},insertNewStyleBlock:function(r,i,n){for(var a=this.get2DCursorLocation(i,!0),e=[0],t=0,s=0;s<r.length;s++)r[s]==="\n"?e[++t]=0:e[t]++;for(e[0]>0&&(this.insertCharStyleObject(a.lineIndex,a.charIndex,e[0],n),n=n&&n.slice(e[0]+1)),t&&this.insertNewlineStyleObject(a.lineIndex,a.charIndex+e[0],t),s=1;s<t;s++)e[s]>0?this.insertCharStyleObject(a.lineIndex+s,0,e[s],n):n&&this.styles[a.lineIndex+s]&&n[0]&&(this.styles[a.lineIndex+s][0]=n[0]),n=n&&n.slice(e[s]+1);e[s]>0&&this.insertCharStyleObject(a.lineIndex+s,0,e[s],n)},setSelectionStartEndWithShift:function(r,i,n){n<=r?(i===r?this._selectionDirection="left":this._selectionDirection==="right"&&(this._selectionDirection="left",this.selectionEnd=r),this.selectionStart=n):n>r&&n<i?this._selectionDirection==="right"?this.selectionEnd=n:this.selectionStart=n:(i===r?this._selectionDirection="right":this._selectionDirection==="left"&&(this._selectionDirection="right",this.selectionStart=i),this.selectionEnd=n)},setSelectionInBoundaries:function(){var r=this.text.length;this.selectionStart>r?this.selectionStart=r:this.selectionStart<0&&(this.selectionStart=0),this.selectionEnd>r?this.selectionEnd=r:this.selectionEnd<0&&(this.selectionEnd=0)}}),g.util.object.extend(g.IText.prototype,{initDoubleClickSimulation:function(){this.__lastClickTime=+new Date,this.__lastLastClickTime=+new Date,this.__lastPointer={},this.on("mousedown",this.onMouseDown)},onMouseDown:function(r){if(this.canvas){this.__newClickTime=+new Date;var i=r.pointer;this.isTripleClick(i)&&(this.fire("tripleclick",r),this._stopEvent(r.e)),this.__lastLastClickTime=this.__lastClickTime,this.__lastClickTime=this.__newClickTime,this.__lastPointer=i,this.__lastIsEditing=this.isEditing,this.__lastSelected=this.selected}},isTripleClick:function(r){return this.__newClickTime-this.__lastClickTime<500&&this.__lastClickTime-this.__lastLastClickTime<500&&this.__lastPointer.x===r.x&&this.__lastPointer.y===r.y},_stopEvent:function(r){r.preventDefault&&r.preventDefault(),r.stopPropagation&&r.stopPropagation()},initCursorSelectionHandlers:function(){this.initMousedownHandler(),this.initMouseupHandler(),this.initClicks()},doubleClickHandler:function(r){this.isEditing&&this.selectWord(this.getSelectionStartFromPointer(r.e))},tripleClickHandler:function(r){this.isEditing&&this.selectLine(this.getSelectionStartFromPointer(r.e))},initClicks:function(){this.on("mousedblclick",this.doubleClickHandler),this.on("tripleclick",this.tripleClickHandler)},_mouseDownHandler:function(r){!this.canvas||!this.editable||r.e.button&&r.e.button!==1||(this.__isMousedown=!0,this.selected&&(this.inCompositionMode=!1,this.setCursorByClick(r.e)),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection()))},_mouseDownHandlerBefore:function(r){!this.canvas||!this.editable||r.e.button&&r.e.button!==1||(this.selected=this===this.canvas._activeObject)},initMousedownHandler:function(){this.on("mousedown",this._mouseDownHandler),this.on("mousedown:before",this._mouseDownHandlerBefore)},initMouseupHandler:function(){this.on("mouseup",this.mouseUpHandler)},mouseUpHandler:function(r){if(this.__isMousedown=!1,!(!this.editable||this.group||r.transform&&r.transform.actionPerformed||r.e.button&&r.e.button!==1)){if(this.canvas){var i=this.canvas._activeObject;if(i&&i!==this)return}this.__lastSelected&&!this.__corner?(this.selected=!1,this.__lastSelected=!1,this.enterEditing(r.e),this.selectionStart===this.selectionEnd?this.initDelayedCursor(!0):this.renderCursorOrSelection()):this.selected=!0}},setCursorByClick:function(r){var i=this.getSelectionStartFromPointer(r),n=this.selectionStart,a=this.selectionEnd;r.shiftKey?this.setSelectionStartEndWithShift(n,a,i):(this.selectionStart=i,this.selectionEnd=i),this.isEditing&&(this._fireSelectionChanged(),this._updateTextarea())},getSelectionStartFromPointer:function(r){for(var i,n=this.getLocalPointer(r),a=0,e=0,t=0,s=0,c=0,h=0,l=this._textLines.length;h<l&&t<=n.y;h++)t+=this.getHeightOfLine(h)*this.scaleY,c=h,h>0&&(s+=this._textLines[h-1].length+this.missingNewlineOffset(h-1));e=this._getLineLeftOffset(c)*this.scaleX,i=this._textLines[c],this.direction==="rtl"&&(n.x=this.width*this.scaleX-n.x+e);for(var d=0,p=i.length;d<p&&(a=e,(e+=this.__charBounds[c][d].kernedWidth*this.scaleX)<=n.x);d++)s++;return this._getNewSelectionStartFromOffset(n,a,e,s,p)},_getNewSelectionStartFromOffset:function(r,i,n,a,e){var t=r.x-i,s=n-r.x,c=a+(s>t||s<0?0:1);return this.flipX&&(c=e-c),c>this._text.length&&(c=this._text.length),c}}),g.util.object.extend(g.IText.prototype,{initHiddenTextarea:function(){this.hiddenTextarea=g.document.createElement("textarea"),this.hiddenTextarea.setAttribute("autocapitalize","off"),this.hiddenTextarea.setAttribute("autocorrect","off"),this.hiddenTextarea.setAttribute("autocomplete","off"),this.hiddenTextarea.setAttribute("spellcheck","false"),this.hiddenTextarea.setAttribute("data-fabric-hiddentextarea",""),this.hiddenTextarea.setAttribute("wrap","off");var r=this._calcTextareaPosition();this.hiddenTextarea.style.cssText="position: absolute; top: "+r.top+"; left: "+r.left+"; z-index: -999; opacity: 0; width: 1px; height: 1px; font-size: 1px; paddingtop: "+r.fontSize+";",this.hiddenTextareaContainer?this.hiddenTextareaContainer.appendChild(this.hiddenTextarea):g.document.body.appendChild(this.hiddenTextarea),g.util.addListener(this.hiddenTextarea,"keydown",this.onKeyDown.bind(this)),g.util.addListener(this.hiddenTextarea,"keyup",this.onKeyUp.bind(this)),g.util.addListener(this.hiddenTextarea,"input",this.onInput.bind(this)),g.util.addListener(this.hiddenTextarea,"copy",this.copy.bind(this)),g.util.addListener(this.hiddenTextarea,"cut",this.copy.bind(this)),g.util.addListener(this.hiddenTextarea,"paste",this.paste.bind(this)),g.util.addListener(this.hiddenTextarea,"compositionstart",this.onCompositionStart.bind(this)),g.util.addListener(this.hiddenTextarea,"compositionupdate",this.onCompositionUpdate.bind(this)),g.util.addListener(this.hiddenTextarea,"compositionend",this.onCompositionEnd.bind(this)),!this._clickHandlerInitialized&&this.canvas&&(g.util.addListener(this.canvas.upperCanvasEl,"click",this.onClick.bind(this)),this._clickHandlerInitialized=!0)},keysMap:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorRight",36:"moveCursorLeft",37:"moveCursorLeft",38:"moveCursorUp",39:"moveCursorRight",40:"moveCursorDown"},keysMapRtl:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorLeft",36:"moveCursorRight",37:"moveCursorRight",38:"moveCursorUp",39:"moveCursorLeft",40:"moveCursorDown"},ctrlKeysMapUp:{67:"copy",88:"cut"},ctrlKeysMapDown:{65:"selectAll"},onClick:function(){this.hiddenTextarea&&this.hiddenTextarea.focus()},onKeyDown:function(r){if(this.isEditing){var i=this.direction==="rtl"?this.keysMapRtl:this.keysMap;if(r.keyCode in i)this[i[r.keyCode]](r);else{if(!(r.keyCode in this.ctrlKeysMapDown)||!r.ctrlKey&&!r.metaKey)return;this[this.ctrlKeysMapDown[r.keyCode]](r)}r.stopImmediatePropagation(),r.preventDefault(),r.keyCode>=33&&r.keyCode<=40?(this.inCompositionMode=!1,this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}},onKeyUp:function(r){!this.isEditing||this._copyDone||this.inCompositionMode?this._copyDone=!1:r.keyCode in this.ctrlKeysMapUp&&(r.ctrlKey||r.metaKey)&&(this[this.ctrlKeysMapUp[r.keyCode]](r),r.stopImmediatePropagation(),r.preventDefault(),this.canvas&&this.canvas.requestRenderAll())},onInput:function(r){var i=this.fromPaste;if(this.fromPaste=!1,r&&r.stopPropagation(),this.isEditing){var n,a,e,t,s,c=this._splitTextIntoLines(this.hiddenTextarea.value).graphemeText,h=this._text.length,l=c.length,d=l-h,p=this.selectionStart,m=this.selectionEnd,b=p!==m;if(this.hiddenTextarea.value==="")return this.styles={},this.updateFromTextArea(),this.fire("changed"),void(this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll()));var y=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value),w=p>y.selectionStart;b?(n=this._text.slice(p,m),d+=m-p):l<h&&(n=w?this._text.slice(m+d,m):this._text.slice(p,p-d)),a=c.slice(y.selectionEnd-d,y.selectionEnd),n&&n.length&&(a.length&&(e=this.getSelectionStyles(p,p+1,!1),e=a.map(function(){return e[0]})),b?(t=p,s=m):w?(t=m-n.length,s=m):(t=m,s=m+n.length),this.removeStyleFromTo(t,s)),a.length&&(i&&a.join("")===g.copiedText&&!g.disableStyleCopyPaste&&(e=g.copiedTextStyle),this.insertNewStyleBlock(a,p,e)),this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())}},onCompositionStart:function(){this.inCompositionMode=!0},onCompositionEnd:function(){this.inCompositionMode=!1},onCompositionUpdate:function(r){this.compositionStart=r.target.selectionStart,this.compositionEnd=r.target.selectionEnd,this.updateTextareaPosition()},copy:function(){this.selectionStart!==this.selectionEnd&&(g.copiedText=this.getSelectedText(),g.disableStyleCopyPaste?g.copiedTextStyle=null:g.copiedTextStyle=this.getSelectionStyles(this.selectionStart,this.selectionEnd,!0),this._copyDone=!0)},paste:function(){this.fromPaste=!0},_getClipboardData:function(r){return r&&r.clipboardData||g.window.clipboardData},_getWidthBeforeCursor:function(r,i){var n,a=this._getLineLeftOffset(r);return i>0&&(a+=(n=this.__charBounds[r][i-1]).left+n.width),a},getDownCursorOffset:function(r,i){var n=this._getSelectionForOffset(r,i),a=this.get2DCursorLocation(n),e=a.lineIndex;if(e===this._textLines.length-1||r.metaKey||r.keyCode===34)return this._text.length-n;var t=a.charIndex,s=this._getWidthBeforeCursor(e,t),c=this._getIndexOnLine(e+1,s);return this._textLines[e].slice(t).length+c+1+this.missingNewlineOffset(e)},_getSelectionForOffset:function(r,i){return r.shiftKey&&this.selectionStart!==this.selectionEnd&&i?this.selectionEnd:this.selectionStart},getUpCursorOffset:function(r,i){var n=this._getSelectionForOffset(r,i),a=this.get2DCursorLocation(n),e=a.lineIndex;if(e===0||r.metaKey||r.keyCode===33)return-n;var t=a.charIndex,s=this._getWidthBeforeCursor(e,t),c=this._getIndexOnLine(e-1,s),h=this._textLines[e].slice(0,t),l=this.missingNewlineOffset(e-1);return-this._textLines[e-1].length+c-h.length+(1-l)},_getIndexOnLine:function(r,i){for(var n,a,e=this._textLines[r],t=this._getLineLeftOffset(r),s=0,c=0,h=e.length;c<h;c++)if((t+=n=this.__charBounds[r][c].width)>i){a=!0;var l=t-n,d=t,p=Math.abs(l-i);s=Math.abs(d-i)<p?c:c-1;break}return a||(s=e.length-1),s},moveCursorDown:function(r){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",r)},moveCursorUp:function(r){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorUpOrDown("Up",r)},_moveCursorUpOrDown:function(r,i){var n=this["get"+r+"CursorOffset"](i,this._selectionDirection==="right");i.shiftKey?this.moveCursorWithShift(n):this.moveCursorWithoutShift(n),n!==0&&(this.setSelectionInBoundaries(),this.abortCursorAnimation(),this._currentCursorOpacity=1,this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorWithShift:function(r){var i=this._selectionDirection==="left"?this.selectionStart+r:this.selectionEnd+r;return this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,i),r!==0},moveCursorWithoutShift:function(r){return r<0?(this.selectionStart+=r,this.selectionEnd=this.selectionStart):(this.selectionEnd+=r,this.selectionStart=this.selectionEnd),r!==0},moveCursorLeft:function(r){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorLeftOrRight("Left",r)},_move:function(r,i,n){var a;if(r.altKey)a=this["findWordBoundary"+n](this[i]);else{if(!r.metaKey&&r.keyCode!==35&&r.keyCode!==36)return this[i]+=n==="Left"?-1:1,!0;a=this["findLineBoundary"+n](this[i])}if(typeof a!==void 0&&this[i]!==a)return this[i]=a,!0},_moveLeft:function(r,i){return this._move(r,i,"Left")},_moveRight:function(r,i){return this._move(r,i,"Right")},moveCursorLeftWithoutShift:function(r){var i=!0;return this._selectionDirection="left",this.selectionEnd===this.selectionStart&&this.selectionStart!==0&&(i=this._moveLeft(r,"selectionStart")),this.selectionEnd=this.selectionStart,i},moveCursorLeftWithShift:function(r){return this._selectionDirection==="right"&&this.selectionStart!==this.selectionEnd?this._moveLeft(r,"selectionEnd"):this.selectionStart!==0?(this._selectionDirection="left",this._moveLeft(r,"selectionStart")):void 0},moveCursorRight:function(r){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorLeftOrRight("Right",r)},_moveCursorLeftOrRight:function(r,i){var n="moveCursor"+r+"With";this._currentCursorOpacity=1,i.shiftKey?n+="Shift":n+="outShift",this[n](i)&&(this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorRightWithShift:function(r){return this._selectionDirection==="left"&&this.selectionStart!==this.selectionEnd?this._moveRight(r,"selectionStart"):this.selectionEnd!==this._text.length?(this._selectionDirection="right",this._moveRight(r,"selectionEnd")):void 0},moveCursorRightWithoutShift:function(r){var i=!0;return this._selectionDirection="right",this.selectionStart===this.selectionEnd?(i=this._moveRight(r,"selectionStart"),this.selectionEnd=this.selectionStart):this.selectionStart=this.selectionEnd,i},removeChars:function(r,i){i===void 0&&(i=r+1),this.removeStyleFromTo(r,i),this._text.splice(r,i-r),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()},insertChars:function(r,i,n,a){a===void 0&&(a=n),a>n&&this.removeStyleFromTo(n,a);var e=g.util.string.graphemeSplit(r);this.insertNewStyleBlock(e,n,i),this._text=[].concat(this._text.slice(0,n),e,this._text.slice(a)),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()}}),function(){var r=g.util.toFixed,i=/  +/g;g.util.object.extend(g.Text.prototype,{_toSVG:function(){var n=this._getSVGLeftTopOffsets(),a=this._getSVGTextAndBg(n.textTop,n.textLeft);return this._wrapSVGTextAndBg(a)},toSVG:function(n){return this._createBaseSVGMarkup(this._toSVG(),{reviver:n,noStyle:!0,withShadow:!0})},_getSVGLeftTopOffsets:function(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}},_wrapSVGTextAndBg:function(n){var a=this.getSvgTextDecoration(this);return[n.textBgRects.join(""),'		<text xml:space="preserve" ',this.fontFamily?'font-family="'+this.fontFamily.replace(/"/g,"'")+'" ':"",this.fontSize?'font-size="'+this.fontSize+'" ':"",this.fontStyle?'font-style="'+this.fontStyle+'" ':"",this.fontWeight?'font-weight="'+this.fontWeight+'" ':"",a?'text-decoration="'+a+'" ':"",'style="',this.getSvgStyles(!0),'"',this.addPaintOrder()," >",n.textSpans.join(""),"</text>\n"]},_getSVGTextAndBg:function(n,a){var e,t=[],s=[],c=n;this._setSVGBg(s);for(var h=0,l=this._textLines.length;h<l;h++)e=this._getLineLeftOffset(h),(this.textBackgroundColor||this.styleHas("textBackgroundColor",h))&&this._setSVGTextLineBg(s,h,a+e,c),this._setSVGTextLineText(t,h,a+e,c),c+=this.getHeightOfLine(h);return{textSpans:t,textBgRects:s}},_createTextCharSpan:function(n,a,e,t){var s=n!==n.trim()||n.match(i),c=this.getSvgSpanStyles(a,s),h=c?'style="'+c+'"':"",l=a.deltaY,d="",p=g.Object.NUM_FRACTION_DIGITS;return l&&(d=' dy="'+r(l,p)+'" '),['<tspan x="',r(e,p),'" y="',r(t,p),'" ',d,h,">",g.util.string.escapeXml(n),"</tspan>"].join("")},_setSVGTextLineText:function(n,a,e,t){var s,c,h,l,d,p=this.getHeightOfLine(a),m=this.textAlign.indexOf("justify")!==-1,b="",y=0,w=this._textLines[a];t+=p*(1-this._fontSizeFraction)/this.lineHeight;for(var T=0,k=w.length-1;T<=k;T++)d=T===k||this.charSpacing,b+=w[T],h=this.__charBounds[a][T],y===0?(e+=h.kernedWidth-h.width,y+=h.width):y+=h.kernedWidth,m&&!d&&this._reSpaceAndTab.test(w[T])&&(d=!0),d||(s=s||this.getCompleteStyleDeclaration(a,T),c=this.getCompleteStyleDeclaration(a,T+1),d=this._hasStyleChangedForSvg(s,c)),d&&(l=this._getStyleDeclaration(a,T)||{},n.push(this._createTextCharSpan(b,l,e,t)),b="",s=c,e+=y,y=0)},_pushTextBgRect:function(n,a,e,t,s,c){var h=g.Object.NUM_FRACTION_DIGITS;n.push("		<rect ",this._getFillAttributes(a),' x="',r(e,h),'" y="',r(t,h),'" width="',r(s,h),'" height="',r(c,h),'"></rect>\n')},_setSVGTextLineBg:function(n,a,e,t){for(var s,c,h=this._textLines[a],l=this.getHeightOfLine(a)/this.lineHeight,d=0,p=0,m=this.getValueOfPropertyAt(a,0,"textBackgroundColor"),b=0,y=h.length;b<y;b++)s=this.__charBounds[a][b],(c=this.getValueOfPropertyAt(a,b,"textBackgroundColor"))!==m?(m&&this._pushTextBgRect(n,m,e+p,t,d,l),p=s.left,d=s.width,m=c):d+=s.kernedWidth;c&&this._pushTextBgRect(n,c,e+p,t,d,l)},_getFillAttributes:function(n){var a=n&&typeof n=="string"?new g.Color(n):"";return a&&a.getSource()&&a.getAlpha()!==1?'opacity="'+a.getAlpha()+'" fill="'+a.setAlpha(1).toRgb()+'"':'fill="'+n+'"'},_getSVGLineTopOffset:function(n){for(var a,e=0,t=0;t<n;t++)e+=this.getHeightOfLine(t);return a=this.getHeightOfLine(t),{lineTop:e,offset:(this._fontSizeMult-this._fontSizeFraction)*a/(this.lineHeight*this._fontSizeMult)}},getSvgStyles:function(n){return g.Object.prototype.getSvgStyles.call(this,n)+" white-space: pre;"}})}(),function(r){var i=r.fabric||(r.fabric={});i.Textbox=i.util.createClass(i.IText,i.Observable,{type:"textbox",minWidth:20,dynamicMinWidth:2,__cachedLines:null,lockScalingFlip:!0,noScaleCache:!1,_dimensionAffectingProps:i.Text.prototype._dimensionAffectingProps.concat("width"),_wordJoiners:/[ \t\r]/,splitByGrapheme:!1,initDimensions:function(){this.__skipDimension||(this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.height=this.calcTextHeight(),this.saveState({propertySet:"_dimensionAffectingProps"}))},_generateStyleMap:function(n){for(var a=0,e=0,t=0,s={},c=0;c<n.graphemeLines.length;c++)n.graphemeText[t]==="\n"&&c>0?(e=0,t++,a++):!this.splitByGrapheme&&this._reSpaceAndTab.test(n.graphemeText[t])&&c>0&&(e++,t++),s[c]={line:a,offset:e},t+=n.graphemeLines[c].length,e+=n.graphemeLines[c].length;return s},styleHas:function(n,a){if(this._styleMap&&!this.isWrapping){var e=this._styleMap[a];e&&(a=e.line)}return i.Text.prototype.styleHas.call(this,n,a)},isEmptyStyles:function(n){if(!this.styles)return!0;var a,e,t=0,s=!1,c=this._styleMap[n],h=this._styleMap[n+1];for(var l in c&&(n=c.line,t=c.offset),h&&(s=h.line===n,a=h.offset),e=n===void 0?this.styles:{line:this.styles[n]})for(var d in e[l])if(d>=t&&(!s||d<a))for(var p in e[l][d])return!1;return!0},_getStyleDeclaration:function(n,a){if(this._styleMap&&!this.isWrapping){var e=this._styleMap[n];if(!e)return null;n=e.line,a=e.offset+a}return this.callSuper("_getStyleDeclaration",n,a)},_setStyleDeclaration:function(n,a,e){var t=this._styleMap[n];n=t.line,a=t.offset+a,this.styles[n][a]=e},_deleteStyleDeclaration:function(n,a){var e=this._styleMap[n];n=e.line,a=e.offset+a,delete this.styles[n][a]},_getLineStyle:function(n){var a=this._styleMap[n];return!!this.styles[a.line]},_setLineStyle:function(n){var a=this._styleMap[n];this.styles[a.line]={}},_wrapText:function(n,a){var e,t=[];for(this.isWrapping=!0,e=0;e<n.length;e++)t=t.concat(this._wrapLine(n[e],e,a));return this.isWrapping=!1,t},_measureWord:function(n,a,e){var t,s=0;e=e||0;for(var c=0,h=n.length;c<h;c++)s+=this._getGraphemeBox(n[c],a,c+e,t,!0).kernedWidth,t=n[c];return s},_wrapLine:function(n,a,e,t){var s=0,c=this.splitByGrapheme,h=[],l=[],d=c?i.util.string.graphemeSplit(n):n.split(this._wordJoiners),p="",m=0,b=c?"":" ",y=0,w=0,T=0,k=!0,P=this._getWidthOfCharSpacing();t=t||0,d.length===0&&d.push([]),e-=t;for(var G=0;G<d.length;G++)p=c?d[G]:i.util.string.graphemeSplit(d[G]),y=this._measureWord(p,a,m),m+=p.length,(s+=w+y-P)>e&&!k?(h.push(l),l=[],s=y,k=!0):s+=P,k||c||l.push(b),l=l.concat(p),w=c?0:this._measureWord([b],a,m),m++,k=!1,y>T&&(T=y);return G&&h.push(l),T+t>this.dynamicMinWidth&&(this.dynamicMinWidth=T-P+t),h},isEndOfWrapping:function(n){return!this._styleMap[n+1]||this._styleMap[n+1].line!==this._styleMap[n].line},missingNewlineOffset:function(n){return this.splitByGrapheme?this.isEndOfWrapping(n)?1:0:1},_splitTextIntoLines:function(n){for(var a=i.Text.prototype._splitTextIntoLines.call(this,n),e=this._wrapText(a.lines,this.width),t=new Array(e.length),s=0;s<e.length;s++)t[s]=e[s].join("");return a.lines=t,a.graphemeLines=e,a},getMinWidth:function(){return Math.max(this.minWidth,this.dynamicMinWidth)},_removeExtraneousStyles:function(){var n={};for(var a in this._styleMap)this._textLines[a]&&(n[this._styleMap[a].line]=1);for(var a in this.styles)n[a]||delete this.styles[a]},toObject:function(n){return this.callSuper("toObject",["minWidth","splitByGrapheme"].concat(n))}}),i.Textbox.fromObject=function(n,a){return i.Object._fromObject("Textbox",n,a,"text")}}(o),function(){var r=g.controlsUtils,i=r.scaleSkewCursorStyleHandler,n=r.scaleCursorStyleHandler,a=r.scalingEqually,e=r.scalingYOrSkewingX,t=r.scalingXOrSkewingY,s=r.scaleOrSkewActionName,c=g.Object.prototype.controls;if(c.ml=new g.Control({x:-.5,y:0,cursorStyleHandler:i,actionHandler:t,getActionName:s}),c.mr=new g.Control({x:.5,y:0,cursorStyleHandler:i,actionHandler:t,getActionName:s}),c.mb=new g.Control({x:0,y:.5,cursorStyleHandler:i,actionHandler:e,getActionName:s}),c.mt=new g.Control({x:0,y:-.5,cursorStyleHandler:i,actionHandler:e,getActionName:s}),c.tl=new g.Control({x:-.5,y:-.5,cursorStyleHandler:n,actionHandler:a}),c.tr=new g.Control({x:.5,y:-.5,cursorStyleHandler:n,actionHandler:a}),c.bl=new g.Control({x:-.5,y:.5,cursorStyleHandler:n,actionHandler:a}),c.br=new g.Control({x:.5,y:.5,cursorStyleHandler:n,actionHandler:a}),c.mtr=new g.Control({x:0,y:-.5,actionHandler:r.rotationWithSnapping,cursorStyleHandler:r.rotationStyleHandler,offsetY:-40,withConnection:!0,actionName:"rotate"}),g.Textbox){var h=g.Textbox.prototype.controls={};h.mtr=c.mtr,h.tr=c.tr,h.br=c.br,h.tl=c.tl,h.bl=c.bl,h.mt=c.mt,h.mb=c.mb,h.mr=new g.Control({x:.5,y:0,actionHandler:r.changeWidth,cursorStyleHandler:i,actionName:"resizing"}),h.ml=new g.Control({x:-.5,y:0,actionHandler:r.changeWidth,cursorStyleHandler:i,actionName:"resizing"})}}()},192:()=>{},898:()=>{},245:()=>{}},xt={};function Je(f){var o=xt[f];if(o!==void 0)return o.exports;var u=xt[f]={exports:{}};return yi[f](u,u.exports,Je),u.exports}Je.d=(f,o)=>{for(var u in o)Je.o(o,u)&&!Je.o(f,u)&&Object.defineProperty(f,u,{enumerable:!0,get:o[u]})},Je.o=(f,o)=>Object.prototype.hasOwnProperty.call(f,o);var ni={};(()=>{let f;Je.d(ni,{R:()=>f}),f=typeof document<"u"&&typeof window<"u"?Je(653).fabric:{version:"5.2.1"}})();var xe=ni.R;/*!
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Camera Enhancer JS Edition
 * @website https://www.dynamsoft.com
 * @copyright Copyright 2022, Dynamsoft Corporation
 * @author Dynamsoft
 * @version 3.0.1 (js 20220803)
 * @fileoverview Dynamsoft JavaScript Library for Camera Enhancer
 * More info on DCE JS: https://www.dynamsoft.com/camera-enhancer/docs/programming/javascript/?ver=latest
 */function Ce(f,o,u,_){return new(u||(u=Promise))(function(v,C){function S(I){try{L(_.next(I))}catch(E){C(E)}}function x(I){try{L(_.throw(I))}catch(E){C(E)}}function L(I){var E;I.done?v(I.value):(E=I.value,E instanceof u?E:new u(function(F){F(E)})).then(S,x)}L((_=_.apply(f,o||[])).next())})}const pt=typeof self>"u";let et,Fe,ot,ft,Ae;if(typeof navigator<"u"&&(et=navigator,Fe=et.userAgent,ot=et.platform,ft=et.mediaDevices),!pt){const f={init:function(){this.browser=this.searchString(this.dataBrowser)||"unknownBrowser",this.version=this.searchVersion(Fe)||this.searchVersion(et.appVersion)||0,this.OS=this.searchString(this.dataOS)||"unknownOS",this.OS=="Linux"&&Fe.indexOf("Windows NT")!=-1&&(this.OS="HarmonyOS")},searchString:function(o){for(let u=0;u<o.length;u++){let _=o[u].string,v=o[u].prop;if(this.versionSearchString=o[u].versionSearch||o[u].identity,_){if(_.indexOf(o[u].subString)!=-1)return o[u].identity}else if(v)return o[u].identity}},searchVersion:function(o){let u=o.indexOf(this.versionSearchString);if(u!=-1)return parseFloat(o.substring(u+this.versionSearchString.length+1))},dataBrowser:[{string:Fe,subString:"Edge",identity:"Edge"},{string:Fe,subString:"OPR",identity:"OPR"},{string:Fe,subString:"Chrome",identity:"Chrome"},{string:et.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{string:Fe,subString:"Firefox",identity:"Firefox"},{string:Fe,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"}],dataOS:[{string:Fe,subString:"HarmonyOS",identity:"HarmonyOS"},{string:Fe,subString:"Android",identity:"Android"},{string:Fe,subString:"iPhone",identity:"iPhone"},{string:ot,subString:"Win",identity:"Windows"},{string:ot,subString:"Mac",identity:"Mac"},{string:ot,subString:"Linux",identity:"Linux"}]};f.init(),Ae={browser:f.browser,version:f.version,OS:f.OS}}pt&&(Ae={browser:"ssr",version:0,OS:"ssr"});const Si=typeof WebAssembly<"u"&&Fe&&!(/Safari/.test(Fe)&&!/Chrome/.test(Fe)&&/\(.+\s11_2_([2-6]).*\)/.test(Fe)),bi=!(typeof Worker>"u"),si=!(!ft||!ft.getUserMedia),Ci=async()=>{let f=!1;if(si)try{(await ft.getUserMedia({video:!0})).getTracks().forEach(o=>{o.stop()}),f=!0}catch(o){}return f};Ae.browser==="Chrome"&&Ae.version>66||Ae.browser==="Safari"&&Ae.version>13||Ae.browser==="OPR"&&Ae.version>43||Ae.browser==="Edge"&&Ae.version;const wi=(()=>{if(!pt&&document.currentScript){let f=document.currentScript.src,o=f.indexOf("?");if(o!=-1)f=f.substring(0,o);else{let u=f.indexOf("#");u!=-1&&(f=f.substring(0,u))}return f.substring(0,f.lastIndexOf("/")+1)}return"./"})();class Me{constructor(o,u){this._zIndex=null,this._drawingLayer=null,this._drawingLayerId=null,this._mapStyle=new Map,this.mapEvents=new Map([["select",[]],["deselect",[]]]),this.isDrawingItem=!0,this._setFabricObject(o),this._mediaType=o.type,this.styleSelector="default",this.styleId=u;for(let _ of Me.arrStyleSelectors)this._mapStyle.set(_,null)}get mediaType(){return this._mediaType}get drawingLayerId(){return this._drawingLayerId}_setFabricObject(o){this._fabricObject=o;const u=this.mapEvents;this._fabricObject.onSelect=()=>{this.styleSelector="selected";const _=this.mapEvents.get("select");for(let v of _)v&&v.apply(this)},this._fabricObject.onDeselect=()=>{this.styleSelector="default";const _=u.get("deselect");for(let v of _)v&&v.apply(this)},o.getDrawingItem=()=>this}_getFabricObject(){return this._fabricObject}on(o,u,_){const v=this.mapEvents.get(o);v.includes(u)||v.push(u)}off(o,u){const _=this.mapEvents.get(o),v=_.indexOf(u);v!==-1&&_.splice(v,1)}_setEditable(o){const u=this._fabricObject;o?(u.selectable=!0,u.evented=!0,u.hasControls=!0):(u.selectable=!1,u.evented=!1,u.hasControls=!1)}_extendSet(o,u){return!1}_extendGet(o){}set(o,u){this._extendSet(o,u)||(o==="x"?this._fabricObject.set("left",u):o==="y"?this._fabricObject.set("top",u):this._fabricObject.set(o,u)),["vertices","left","top","width","height","scaleX","scaleY","skewX","skewY","padding","angle","strokeWidth"].includes(o)&&this._fabricObject.setCoords()}get(o){let u=this._extendGet(o);return u===void 0&&(u=o==="x"?this._fabricObject.get("left"):o==="y"?this._fabricObject.get("top"):this._fabricObject.get(o)),u}}function Tt(f,o,u){let _=u.points[this.pointIndex].x-u.pathOffset.x,v=u.points[this.pointIndex].y-u.pathOffset.y;return xe.util.transformPoint({x:_,y:v},xe.util.multiplyTransformMatrices(u.canvas.viewportTransform,u.calcTransformMatrix()))}function oi(f){let o=new xe.Point(f.strokeUniform?1/f.scaleX:1,f.strokeUniform?1/f.scaleY:1).multiply(f.strokeWidth);return new xe.Point(f.width+o.x,f.height+o.y)}function Ot(f,o,u,_){let v=o.target,C=v.controls[v.__corner],S=v.toLocalPoint(new xe.Point(u,_),"center","center"),x=oi(v),L=v._getTransformedDimensions(0,0),I={x:S.x*x.x/L.x+v.pathOffset.x,y:S.y*x.y/L.y+v.pathOffset.y};return v.points[C.pointIndex]=I,!0}function Et(f,o){return function(u,_,v,C){let S=_.target,x=xe.util.transformPoint({x:S.points[f].x-S.pathOffset.x,y:S.points[f].y-S.pathOffset.y},S.calcTransformMatrix()),L=o(u,_,v,C);S._setPositionDimensions({});let I=oi(S),E=(S.points[f].x-S.pathOffset.x)/I.x,F=(S.points[f].y-S.pathOffset.y)/I.y;return S.setPositionByOrigin(x,E+.5,F+.5),L}}Me.arrMediaTypes=["rect","arc","polygon","image","text","line","path"],Me.arrStyleSelectors=["default","selected"],typeof document<"u"&&typeof window<"u"&&(xe.StaticCanvas.prototype.dispose=function(){return this.isRendering&&(xe.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(f){f.dispose&&f.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),xe.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},xe.Object.prototype.transparentCorners=!1,xe.Object.prototype.cornerSize=20,xe.Object.prototype.touchCornerSize=100,xe.Object.prototype.cornerColor="rgb(254,142,20)",xe.Object.prototype.cornerStyle="circle",xe.Object.prototype.strokeUniform=!0,xe.Object.prototype.hasBorders=!1,xe.ActiveSelection.prototype.onDeselect=function(){return this.getObjects().forEach(f=>{setTimeout(f.onDeselect,0)}),this.destroy(),!1},xe.Canvas.prototype.containerClass="",xe.Canvas.prototype.getPointer=function(f,o){if(this._absolutePointer&&!o)return this._absolutePointer;if(this._pointer&&o)return this._pointer;var u,_=this.upperCanvasEl,v=xe.util.getPointer(f,_),C=_.getBoundingClientRect(),S=C.width||0,x=C.height||0;S&&x||("top"in C&&"bottom"in C&&(x=Math.abs(C.top-C.bottom)),"right"in C&&"left"in C&&(S=Math.abs(C.right-C.left))),this.calcOffset(),v.x=v.x-this._offset.left,v.y=v.y-this._offset.top,o||(v=this.restorePointerVpt(v));var L=this.getRetinaScaling();if(L!==1&&(v.x/=L,v.y/=L),S!==0&&x!==0){var I=window.getComputedStyle(_).objectFit,E=_.width,F=_.height,M=S,q=x;u={width:E/M,height:F/q};var se,K,J=E/F,le=M/q;return I==="contain"?J>le?(se=M,K=M/J,{x:v.x*u.width,y:(v.y-(q-K)/2)*u.width}):(se=q*J,K=q,{x:(v.x-(M-se)/2)*u.height,y:v.y*u.height}):I==="cover"?J>le?{x:(E-u.height*M)/2+v.x*u.height,y:v.y*u.height}:{x:v.x*u.width,y:(F-u.width*q)/2+v.y*u.width}:{x:v.x*u.width,y:v.y*u.height}}return u={width:1,height:1},{x:v.x*u.width,y:v.y*u.height}});class xi{constructor(o,u,_,v){let C,S;switch(this.mapMediaType_Style=new Map,this.mode="viewer",this.onSelectionChange=null,this._arrDrwaingItem=[],this._arrFabricObject=[],this._visible=!0,o.hasOwnProperty("getFabricCanvas")?this.fabricCanvas=o.getFabricCanvas():(this.fabricCanvas=new xe.Canvas(o,v),this.fabricCanvas.setDimensions({width:"100%",height:"100%"},{cssOnly:!0}),this.fabricCanvas.lowerCanvasEl.className="",this.fabricCanvas.upperCanvasEl.className="",this.fabricCanvas.on("selection:created",function(x){const L=x.selected,I=[];for(let E of L){const F=E.getDrawingItem()._drawingLayer;F&&!I.includes(F)&&I.push(F)}for(let E of I){const F=[];for(let M of L){const q=M.getDrawingItem();q._drawingLayer===E&&F.push(q)}setTimeout(()=>{E.onSelectionChange&&E.onSelectionChange(F,[])},0)}}),this.fabricCanvas.on("before:selection:cleared",function(x){const L=this.getActiveObjects(),I=[];for(let E of L){const F=E.getDrawingItem()._drawingLayer;F&&!I.includes(F)&&I.push(F)}for(let E of I){const F=[];for(let M of L){const q=M.getDrawingItem();q._drawingLayer===E&&F.push(q)}setTimeout(()=>{const M=[];for(let q of F)E.hasDrawingItem(q)&&M.push(q);M.length>0&&E.onSelectionChange&&E.onSelectionChange([],M)},0)}}),this.fabricCanvas.on("selection:updated",function(x){const L=x.selected,I=x.deselected,E=[];for(let F of L){const M=F.getDrawingItem()._drawingLayer;M&&!E.includes(M)&&E.push(M)}for(let F of I){const M=F.getDrawingItem()._drawingLayer;M&&!E.includes(M)&&E.push(M)}for(let F of E){const M=[],q=[];for(let se of L){const K=se.getDrawingItem();K._drawingLayer===F&&M.push(K)}for(let se of I){const K=se.getDrawingItem();K._drawingLayer===F&&q.push(K)}setTimeout(()=>{F.onSelectionChange&&F.onSelectionChange(M,q)},0)}}),this.fabricCanvas.wrapperEl.style.position="absolute",o.getFabricCanvas=()=>this.fabricCanvas),this.id=u,this._mapDrawingStyles=_,u){case 1:C=_.get(1),S=_.get(5);break;case 2:C=_.get(2),S=_.get(6);break;case 3:C=_.get(3),S=_.get(7);break;default:C=_.get(4),S=_.get(8)}for(let x of Me.arrMediaTypes)this.mapMediaType_Style.set(x,{default:C,selected:S})}getId(){return this.id}_getDrawingStyle(o,u){if(typeof o!="number")throw new Error("Invalid style id.");const _=this._mapDrawingStyles.get(o);return _?u?JSON.parse(JSON.stringify(_)):_:null}setVisible(o){if(o){for(let u of this._arrFabricObject)u.visible=!0;this._visible=!0}else{for(let u of this._arrFabricObject)u.visible=!1;this._visible=!1}this.fabricCanvas.renderAll()}isVisible(){return this._visible}_getItemCurrentStyleId(o){return o.styleId?o.styleId:this.mapMediaType_Style.get(o._mediaType)[o.styleSelector].styleId}_getItemCurrentStyle(o){return o.styleId?this._getDrawingStyle(o.styleId):o._mapStyle.get(o.styleSelector)||null}_changeMediaTypeCurStyleInStyleSelector(o,u,_,v){let C;switch(o){case"rect":C=this.fabricCanvas.getObjects("rect");break;case"arc":C=this.fabricCanvas.getObjects("circle");break;case"polygon":C=this.fabricCanvas.getObjects("polygon");break;case"image":C=this.fabricCanvas.getObjects("image");break;case"text":C=this.fabricCanvas.getObjects("text");break;case"line":C=this.fabricCanvas.getObjects("line");break;case"path":C=this.fabricCanvas.getObjects("path")}for(let S of C){if(!this._arrFabricObject.includes(S))continue;const x=S.getDrawingItem();x.styleSelector===u&&this._changeItemStyle(x,_,!0)}v||this.fabricCanvas.renderAll()}_changeItemStyle(o,u,_){if(!o||!u)return;const v=o._getFabricObject();typeof o.styleId=="number"&&(u=this._getDrawingStyle(o.styleId)),v.strokeWidth=u.lineWidth,u.paintMode==="fill"?(v.fill=u.fillStyle,v.stroke=u.fillStyle):u.paintMode==="stroke"?(v.fill="transparent",v.stroke=u.strokeStyle):u.paintMode==="strokeAndFill"&&(v.fill=u.fillStyle,v.stroke=u.strokeStyle),v.fontFamily&&(v.fontFamily=u.fontFamily),v.fontSize&&(v.fontSize=u.fontSize),v.group||(v.dirty=!0),_||this.fabricCanvas.renderAll()}_updateGroupItem(o,u,_){if(!o||!u)return;const v=o.getChildItems();if(_==="add"){if(v.includes(u))return;const C=u._getFabricObject();if(this.fabricCanvas.getObjects().includes(C)){if(!this._arrFabricObject.includes(C))throw new Error("Existed in other drawing layers.");u._zIndex=null}else{let S;if(u.styleId)S=this._getDrawingStyle(u.styleId);else{S=this.mapMediaType_Style.get(u._mediaType)[o.styleSelector];const x=()=>{this._changeItemStyle(u,this.mapMediaType_Style.get(u._mediaType).selected,!0)},L=()=>{this._changeItemStyle(u,this.mapMediaType_Style.get(u._mediaType).default,!0)};u.on("select",x),u.on("deselect",L),u._funcChangeStyleToSelected=x,u._funcChangeStyleToDefault=L}u._drawingLayer=this,u._drawingLayerId=this.id,this._changeItemStyle(u,S,!0)}o._fabricObject.addWithUpdate(u._getFabricObject())}else{if(_!=="remove"||!v.includes(u))return;u._zIndex=null,u._drawingLayer=null,u._drawingLayerId=null,u.off("select",u._funcChangeStyleToSelected),u.off("deselect",u._funcChangeStyleToDefault),u._funcChangeStyleToSelected=null,u._funcChangeStyleToDefault=null,o._fabricObject.removeWithUpdate(u._getFabricObject())}this.fabricCanvas.renderAll()}_addDrawingItem(o,u){let _=o._getFabricObject();const v=this.fabricCanvas.getObjects();let C,S;if(v.includes(_)){if(this._arrFabricObject.includes(_))return;throw new Error("Existed in other drawing layers.")}if(o._mediaType==="group"){C=o.getChildItems();for(let I of C)if(I._drawingLayer&&I._drawingLayer!==this)throw new Error("The childItems of DT_Group have existed in other drawing layers.")}if(u&&typeof u=="object"&&!Array.isArray(u))for(let I in u)_.set(I,u[I]);if(C){for(let I of C){if(I.styleId)S=this._getDrawingStyle(I.styleId);else{const E=this.mapMediaType_Style.get(I._mediaType);for(let q of Me.arrStyleSelectors)I._mapStyle.set(q,E[q]);S=E.default;const F=()=>{this._changeItemStyle(I,this.mapMediaType_Style.get(I._mediaType).selected,!0)},M=()=>{this._changeItemStyle(I,this.mapMediaType_Style.get(I._mediaType).default,!0)};I.on("select",F),I.on("deselect",M),I._funcChangeStyleToSelected=F,I._funcChangeStyleToDefault=M}I._drawingLayer=this,I._drawingLayerId=this.id,this._changeItemStyle(I,S,!0)}_.dirty=!0,this.fabricCanvas.renderAll()}else{if(o.styleId)S=this._getDrawingStyle(o.styleId);else{const I=this.mapMediaType_Style.get(o._mediaType);for(let M of Me.arrStyleSelectors)o._mapStyle.set(M,I[M]);S=I.default;const E=()=>{this._changeItemStyle(o,this.mapMediaType_Style.get(o._mediaType).selected)},F=()=>{this._changeItemStyle(o,this.mapMediaType_Style.get(o._mediaType).default)};o.on("select",E),o.on("deselect",F),o._funcChangeStyleToSelected=E,o._funcChangeStyleToDefault=F}this._changeItemStyle(o,S)}o._zIndex=this.id,o._drawingLayer=this,o._drawingLayerId=this.id;const x=this._arrFabricObject.length;let L=v.length;if(x)L=v.indexOf(this._arrFabricObject[x-1])+1;else for(let I=0;I<v.length;I++)if(o._zIndex<v[I].getDrawingItem()._zIndex){L=I;break}this._arrDrwaingItem.push(o),this._arrFabricObject.push(_),this._visible?_.visible=!0:_.visible=!1,this.fabricCanvas.insertAt(_,L,!1)}addDrawingItem(o){if(!o||!o.isDrawingItem)throw TypeError("Illegal drawing item.");if(this.mode==="viewer")o._setEditable(!1);else{if(this.mode!=="editor")throw new Error("Illegal 'mode'.");o._setEditable(!0)}this._addDrawingItem(o)}addDrawingItems(o){for(let u of o)this.addDrawingItem(u)}removeDrawingItem(o){if(!o||!o.isDrawingItem)throw TypeError("Illegal drawing item.");if(!this.hasDrawingItem(o))return;if(o._zIndex=null,o._drawingLayer=null,o._drawingLayerId=null,o._mediaType==="group"){const _=o.getChildItems();for(let v of _)v._zIndex=null,v._drawingLayer=null,v._drawingLayerId=null,v.off("select",v._funcChangeStyleToSelected),v.off("deselect",v._funcChangeStyleToDefault),v._funcChangeStyleToSelected=null,v._funcChangeStyleToDefault=null,v._mapStyle.clear()}else o.off("select",o._funcChangeStyleToSelected),o.off("deselect",o._funcChangeStyleToDefault),o._funcChangeStyleToSelected=null,o._funcChangeStyleToDefault=null,o._mapStyle.clear();o.styleSelector==="selected"&&(this.fabricCanvas._activeObject=null,o.styleSelector="default");const u=o._getFabricObject();this.fabricCanvas.remove(u),this._arrDrwaingItem.splice(this._arrDrwaingItem.indexOf(o),1),this._arrFabricObject.splice(this._arrFabricObject.indexOf(u),1)}removeDrawingItems(o){for(let u of o)this.removeDrawingItem(u)}setDrawingItems(o){this.clearDrawingItems(),this.addDrawingItems(o)}getDrawingItems(){return this._arrDrwaingItem}getSelectedDrawingItems(){const o=this.fabricCanvas.getActiveObjects(),u=[];for(let _ of o)this._arrFabricObject.includes(_)&&u.push(_.getDrawingItem());return u}hasDrawingItem(o){if(!o||!o.isDrawingItem)throw TypeError("Illegal drawing item.");return this._arrDrwaingItem.includes(o)}clearDrawingItems(){this.removeDrawingItems(Array.from(this._arrDrwaingItem))}setDrawingStyle(o,u,_){let v,C;if(u=u?u.toLocaleLowerCase():"all",_=_?_.toLocaleLowerCase():"all",v=typeof o=="number"?this._getDrawingStyle(o):o,u==="all"){const S=this.mapMediaType_Style.keys();for(let x of S)if(C=this.mapMediaType_Style.get(x),_==="all")for(let L of Me.arrStyleSelectors){this._changeMediaTypeCurStyleInStyleSelector(x,L,v,!0),C[L]=v;for(let I of this._arrDrwaingItem)typeof I.styleId!="number"&&I._mapStyle.set(L,v)}else{this._changeMediaTypeCurStyleInStyleSelector(x,_,v,!0),C[_]=v;for(let L of this._arrDrwaingItem)typeof L.styleId!="number"&&L._mapStyle.set(_,v)}this.fabricCanvas.renderAll()}else if(C=this.mapMediaType_Style.get(u),_==="all")for(let S of Me.arrStyleSelectors){this._changeMediaTypeCurStyleInStyleSelector(u,S,v,!0),C[S]=v;for(let x of this._arrDrwaingItem)typeof x.styleId!="number"&&x._mediaType===u&&x._mapStyle.set(S,v)}else{this._changeMediaTypeCurStyleInStyleSelector(u,_,v,!0),C[_]=v;for(let S of this._arrDrwaingItem)typeof S.styleId!="number"&&S._mediaType===u&&S._mapStyle.set(_,v)}}setMode(o){if((o=o.toLocaleLowerCase())==="viewer"){for(let u of this._arrDrwaingItem)u._setEditable(!1);this.fabricCanvas.discardActiveObject(),this.fabricCanvas.renderAll(),this.mode="viewer"}else{if(o!=="editor")throw new RangeError("Invalid value.");for(let u of this._arrDrwaingItem)u._setEditable(!0);this.mode="editor"}this._manager._switchPointerEvent()}getMode(){return this.mode}_setDimensions(o,u){this.fabricCanvas.setDimensions(o,u)}_setObjectFit(o){if(o=o.toLowerCase(),!["contain","cover"].includes(o))throw new Error("Unsupported value '".concat(o,"'."));this.fabricCanvas.lowerCanvasEl.style.objectFit=o,this.fabricCanvas.upperCanvasEl.style.objectFit=o}_getObjectFit(){return this.fabricCanvas.lowerCanvasEl.style.objectFit}renderAll(){for(let o of this._arrDrwaingItem){const u=this._getItemCurrentStyle(o);this._changeItemStyle(o,u,!0)}this.fabricCanvas.renderAll()}dispose(){this.clearDrawingItems(),this._manager._arrDrawingLayer.length===1&&(this.fabricCanvas.wrapperEl.style.pointerEvents="none",this.fabricCanvas.dispose(),this._arrDrwaingItem.length=0,this._arrFabricObject.length=0)}}class Ti{constructor(){this._arrDrawingLayer=[],this._mapDrawingStyles=new Map([[1,{id:1,lineWidth:2,fillStyle:"rgba(73, 173, 245, 0.3)",strokeStyle:"rgba(73, 173, 245, 1)",paintMode:"stroke",fontFamily:"sans-serif",fontSize:10}],[2,{id:2,lineWidth:2,fillStyle:"rgba(73, 245, 73, 0.3)",strokeStyle:"rgba(73, 245, 73, 0.9)",paintMode:"strokeAndFill",fontFamily:"sans-serif",fontSize:10}],[3,{id:3,lineWidth:2,fillStyle:"rgba(254, 180, 32, 0.3)",strokeStyle:"rgba(254, 180, 32, 0.9)",paintMode:"strokeAndFill",fontFamily:"sans-serif",fontSize:10}],[4,{id:4,lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"stroke",fontFamily:"sans-serif",fontSize:10}],[5,{id:5,lineWidth:2,fillStyle:"rgba(73, 173, 245, 0.3)",strokeStyle:"rgba(73, 173, 245, 1)",paintMode:"strokeAndFill",fontFamily:"sans-serif",fontSize:10}],[6,{id:6,lineWidth:2,fillStyle:"rgba(73, 245, 73, 0.3)",strokeStyle:"rgba(73, 245, 73, 0.9)",paintMode:"strokeAndFill",fontFamily:"sans-serif",fontSize:10}],[7,{id:7,lineWidth:2,fillStyle:"rgba(254, 180, 32, 0.3)",strokeStyle:"rgba(254, 180, 32, 1)",paintMode:"strokeAndFill",fontFamily:"sans-serif",fontSize:10}],[8,{id:8,lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"strokeAndFill",fontFamily:"sans-serif",fontSize:10}]]),this._defaultStyleTemplate={lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"stroke",fontFamily:"sans-serif",fontSize:10}}createDrawingStyle(o){let u;if(o.hasOwnProperty("id")){if(this._mapDrawingStyles.has(o.id))throw new Error("Existing drawing style id.");u=o.id}else{let v=100;for(;this._mapDrawingStyles.has(v);)v++;u=v}const _=JSON.parse(JSON.stringify(o));_.id=u;for(let v in this._defaultStyleTemplate)_.hasOwnProperty(v)||(_[v]=this._defaultStyleTemplate[v]);return this._mapDrawingStyles.set(u,_),_.id}_getDrawingStyle(o,u){if(typeof o!="number")throw new Error("Invalid style id.");const _=this._mapDrawingStyles.get(o);return _?u?JSON.parse(JSON.stringify(_)):_:null}getDrawingStyle(o){return this._getDrawingStyle(o,!0)}getDrawingStyles(){return JSON.parse(JSON.stringify(Array.from(this._mapDrawingStyles.values())))}_updateDrawingStyle(o,u){const _=this._mapDrawingStyles.get(o);if(_)for(let v in u)_.hasOwnProperty(v)&&(_[v]=u[v])}updateDrawingStyle(o,u){this._updateDrawingStyle(o,u);for(let _ of this._arrDrawingLayer)_.renderAll()}createDrawingLayer(o,u){const _=C=>{for(let S of this._arrDrawingLayer)if(S.getId()===C)return!0;return!1};if(u===void 0){for(let C=100;;C++)if(!_(C)){u=C;break}}else if(_(u))throw new Error("Existed drawing layer id.");const v=new xi(o,u,this._mapDrawingStyles,{enableRetinaScaling:!1});return v._manager=this,this._arrDrawingLayer.push(v),this._switchPointerEvent(),v}deleteDrwaingLayer(o){const u=this.getDrawingLayer(o);if(!u)return;const _=this._arrDrawingLayer;u.dispose(),_.splice(_.indexOf(u),1),this._switchPointerEvent()}clearDrawingLayers(){for(let o of this._arrDrawingLayer)o.dispose();this._arrDrawingLayer.length=0}getDrawingLayer(o){for(let u of this._arrDrawingLayer)if(u.getId()===o)return u;return null}getDrawingLayers(){return Array.from(this._arrDrawingLayer)}getSelectedDrawingItems(){if(!this._arrDrawingLayer.length)return;const o=this._arrDrawingLayer[0].fabricCanvas.getActiveObjects(),u=[];for(let _ of o)u.push(_.getDrawingItem());return u}setDimensions(o,u){this._arrDrawingLayer.length&&this._arrDrawingLayer[0]._setDimensions(o,u)}setObjectFit(o){for(let u of this._arrDrawingLayer)u&&u._setObjectFit(o)}getObjectFit(){return this._arrDrawingLayer.length?this._arrDrawingLayer[0]._getObjectFit():null}setVisible(o){this._arrDrawingLayer.length&&(this._arrDrawingLayer[0].fabricCanvas.wrapperEl.style.display=o?"block":"none")}_switchPointerEvent(){if(!this._arrDrawingLayer.length)return;let o=!1;for(let u of this._arrDrawingLayer)u.getMode()==="editor"&&(o=!0);this._arrDrawingLayer[0].fabricCanvas.wrapperEl.style.pointerEvents=o?"":"none"}}class Oi{constructor(o){this._controlTarget=null,this._arrUsers=[],this._mapAction_UserArgs=new Map,this._mapProperty_UserValue=new Map,this._mapAction_Callbacks=new Map,this._controlTarget=o}setControlTarget(o){this._controlTarget=o}getControlTarget(){return this._controlTarget}register(o){this._arrUsers.includes(o)||this._arrUsers.push(o)}logout(o){const u=this._arrUsers.indexOf(o);u!==-1&&(this.clearUserDisiredAction({user:o}),this.clearUserDisiredValue({user:o}),this._arrUsers.splice(u,1))}getRegisteredUsers(){return this._arrUsers}ifUserExisted(o){return this._arrUsers.includes(o)}setDisiredValue(o,u,_,v){if(!this._arrUsers.includes(o))throw new Error("Unregistered user.");v&&(this._controlTarget[u]=_),this._mapProperty_UserValue.get(u)?this._mapProperty_UserValue.get(u).set(o,_):this._mapProperty_UserValue.set(u,new Map([[o,_]]))}clearUserDisiredValue(o){if(o&&(o.user||o.property)){if(o.property&&o.user){const u=this._mapProperty_UserValue.get(o.property);if(!u)return;u.delete(o.user)}else if(o.property)this._mapProperty_UserValue.delete(o.property);else if(o.user)for(let u of this._mapProperty_UserValue.values())u.delete(o.user)}else this._mapProperty_UserValue=new Map}getValue(o){if(!this._controlTarget)throw new Error("Control target is not set.");return this._controlTarget[o]}getPropertyDisiredValue(o){if(this._mapProperty_UserValue.get(o)){const u=[],_=this._mapProperty_UserValue.get(o);for(let v of _.values())u.push(v);return u}return null}setDisiredAction(o,u,_,v){if(!this._arrUsers.includes(o))throw new Error("Unregistered user.");return _||(_=[]),v?this._controlTarget[u](..._):(this._mapAction_UserArgs.get(u)?this._mapAction_UserArgs.get(u).set(o,_):this._mapAction_UserArgs.set(u,new Map([[o,_]])),this._render(u))}clearUserDisiredAction(o){if(o&&(o.user||o.actionName)){if(o.actionName&&o.user){const u=this._mapAction_UserArgs.get(o.actionName);if(!u)return;u.delete(o.user)}else if(o.actionName)this._mapAction_UserArgs.delete(o.actionName);else if(o.user)for(let u of this._mapAction_UserArgs.values())u.delete(o.user);this.render()}else this._mapAction_UserArgs=new Map}addCallback(o,u){const _=this._mapAction_Callbacks.get(o);_?_.push(u):this._mapAction_Callbacks.set(o,[u])}removeCallback(o,u){const _=this._mapAction_Callbacks.get(o);if(!_)return;const v=_.indexOf(u);v!==-1&&_.splice(v,1)}clearCallback(o){o?this._mapAction_Callbacks.delete(o):this._mapAction_Callbacks.clear()}_fireCallback(o){const u=this._mapAction_Callbacks.get(o);if(u)for(let _ of u){if(!_)return;setTimeout(_.bind(this._controlTarget),0)}}_render(o){const u=this._mapAction_UserArgs.get(o);if(!u)throw new Error("Unrecorded action.");if(u.size===this._arrUsers.length){let _=[];for(let v of u.values())v.length>0&&(_=v);if(this._controlTarget[o]){const v=this._controlTarget[o](..._);return this._mapAction_UserArgs.delete(o),this._fireCallback(o),v}}}render(o){if(o)return this._render(o);for(let u of this._mapAction_UserArgs.keys())this._render(u)}}class fe{constructor(){this._maxCvsSideLength=void 0,this._defaultMaxCvsSideLength=null,this._predefinedResolutions=[{width:160,height:120},{width:320,height:240},{width:480,height:360},{width:640,height:480},{width:800,height:600},{width:960,height:720},{width:1280,height:720},{width:1920,height:1080},{width:2560,height:1440},{width:3840,height:2160}],this._mapCameraResolutions=new Map,this._bWebGLSupported=!0,this.extraBindings=[],this._singleFrameMode=!(navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia),this._cvsSingleFrameMode=null,this._cvsOriginalImage=null,this._imgWidth=0,this._imgHeight=0,this._singleFrameModeIpt=null,this._clickIptSingleFrameMode=()=>{if(this.singleFrameMode){if(!this._singleFrameModeIpt){const o=document.createElement("input");this._singleFrameModeIpt=o,o.setAttribute("type","file"),o.setAttribute("accept",".jpg,.jpeg,.icon,.gif,.svg,.webp,.png,.bmp"),o.setAttribute("capture",""),o.addEventListener("change",()=>Ce(this,void 0,void 0,function*(){const u=o.files[0];o.value="";const _=yield(I=>Ce(this,void 0,void 0,function*(){let E=null,F=null;if(typeof createImageBitmap<"u")try{if(E=yield createImageBitmap(I),E)return E}catch(q){}var M;return E||(F=yield(M=I,new Promise((q,se)=>{let K=URL.createObjectURL(M),J=new Image;J.dbrObjUrl=K,J.src=K,J.onload=()=>{q(J)},J.onerror=le=>{se(new Error("Can't convert blob to image : "+(le instanceof Event?le.type:le)))}}))),F}))(u),v=_ instanceof HTMLImageElement?_.naturalWidth:_.width,C=_ instanceof HTMLImageElement?_.naturalHeight:_.height;this._imgWidth=v,this._imgHeight=C;const S=I=>{const E=Date.now();if(v===0||C===0)return null;const F=this._scanRegion,M=this.getFrameSize(v,C,F,this.maxCvsSideLength);if(!M)return null;let q,se;q=v!==M.sWidth||C!==M.sHeight,se=M.sWidth!==M.dWidth||M.sHeight!==M.dHeight;const K=(()=>!(!this._bWebGLSupported||se))(),J={data:null,region:F?JSON.parse(JSON.stringify(F)):null,sx:M.sx,sy:M.sy,width:M.dWidth,height:M.dHeight,colorMode:null,timeSpent:null,timeStamp:null,isCropped:q,toCanvas:this._toCanvas,_sWidth:M.sWidth,_sHeight:M.sHeight,_bUseWebGL:null};let le;try{le=this._getImageData(I,v,C,M,null,{targetColorMode:this.frameColorMode,bUseWebGL:K})}catch($){if($.name!=="WebGLError")throw $;le=this._getImageData(I,v,C,M,null,{targetColorMode:this.frameColorMode,bUseWebGL:!1})}if(!le)return null;const ue=Date.now();return fe._onLog&&fe._onLog("DCE: _getVideoFrame(region?) END: "+ue),J.data=le.data,J.colorMode=le.colorMode,J._bUseWebGL=le._bUseWebGL,J.timeSpent=ue-E,J.timeStamp=ue,J};(I=>{let E=this._cvsSingleFrameMode;if(!E){if(E=document.createElement("canvas"),E.style.pointerEvents="none",!this._video)throw new Error("'video' is null.");this._video.after(E),E.style.position="absolute",E.style.width="100%",E.style.height="100%",E.style.left="0",E.style.top="0",E.style.objectFit="contain",this._cvsSingleFrameMode=E}E.width==v&&E.height==C||(E.width=v,E.height=C);const F=E.getContext("2d");F.clearRect(0,0,E.width,E.height),F.drawImage(I,0,0)})(_),this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let I of this._arrScanRegionOverlays)I&&this._updateScanRegionOverlay(I);let x;this._updateDrawingLayersSize();try{x=S(_)}catch(I){throw I}const L=this.mapCameraEvents.get("singleFrameAcquired");for(let I of L)if(I)try{const E={data:new Uint8Array(x.data),region:JSON.parse(JSON.stringify(x.region)),sx:x.sx,sy:x.sy,width:x.width,height:x.height,colorMode:x.colorMode,timeSpent:x.timeSpent,timeStamp:x.timeStamp,isCropped:x.isCropped,toCanvas:x.toCanvas,_sWidth:x._sWidth,_sHeight:x._sHeight,_bUseWebGL:x._bUseWebGL};yield I.apply(this,[E])}catch(E){console.error(E)}})),o.style.position="fixed",o.style.left="-1px",o.style.top="-1px",o.style.width="1px",o.style.height="1px",o.style.backgroundColor="transparent",o.style.color="transparent",document.body.appendChild(o)}this._singleFrameModeIpt.click()}},this.styleEls=[],this._frameColorMode=void 0,this._defaultFrameColorMode="RGBA",this.currentFSColorMode="rgba",this.ifReuseArrayBufferView=!1,this.maxVideoCvsLength=3,this._reusedCvs=null,this._reusedWebGLCvs=null,this._reusedWebGLCtx=null,this._reusedDataContainer=null,this._webGLTexture=null,this._webGLProgramInfo=null,this._webGLBuffers=null,this._recordedStates={},this._toCanvas=function(){const o=document.createElement("canvas");let u;if(o.width=this.width,o.height=this.height,this.colorMode==="grey"){u=new Uint8ClampedArray(this.width*this.height*4);for(let v=0;v<u.length;v+=4)u[v]=this.data[v/4],u[v+1]=this.data[v/4],u[v+2]=this.data[v/4],u[v+3]=255}else u=new Uint8ClampedArray(this.data);const _=new ImageData(u,this.width,this.height);return o.getContext("2d").putImageData(_,0,0),o},this._onCameraSelChange=()=>Ce(this,void 0,void 0,function*(){yield this.selectCamera(this._selCam.value),this._bOpen||this.stop()}),this._onResolutionSelChange=()=>Ce(this,void 0,void 0,function*(){let o,u;if(this._selRsl&&this._selRsl.selectedIndex!=-1){let _=this._selRsl.options[this._selRsl.selectedIndex];o=_.getAttribute("data-width"),u=_.getAttribute("data-height")}yield this.setResolution(o,u),this._bOpen||this.stop()}),this._onCloseBtnClick=()=>{this.close(!0)},this._bOpen=!1,this.isCameraEnhancer=!0,this.isDisposed=!1,this.videoSrc=null,this.videoSettings={video:{width:{ideal:1280},height:{ideal:720},facingMode:{ideal:"environment"}}},this.iPlayRound=0,this.promisePlay=null,this._ifSaveLastUsedCamera=!1,this.ifSkipCameraInspection=!1,this._allCameras=[],this._currentCamera=null,this._videoTrack=null,this._lastDeviceId=void 0,this._vc_bPlayingVideoBeforeHide=!1,this._ev_documentHideEvent=()=>{document.visibilityState==="visible"?this._vc_bPlayingVideoBeforeHide&&(Ae.browser=="Firefox"?this.play():this._video.play(),this._vc_bPlayingVideoBeforeHide=!1):this._video&&!this._video.paused&&(this._vc_bPlayingVideoBeforeHide=!0,this._video.pause())},this._divVideoContainer=null,this._video=null,this.videoFit="contain",this._cvsScanRegion=null,this._divScanArea=null,this._divScanLight=null,this._bgLoading=null,this._selCam=null,this._bgCamera=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this._selMinLtr=null,this._optGotMinLtr=null,this.regionMaskFillStyle="rgba(0,0,0,0.5)",this.regionMaskStrokeStyle="rgb(254,142,20)",this.regionMaskLineWidth=2,this._bShowScanRegionMask=!0,this._bShowScanRegionLaser=void 0,this._defaultBShowScanRegionLaser=!1,this._scanRegion=null,this._arrScanRegionOverlays=[],this._layerBaseCvs=null,this._cvsViewDecorator=null,this._decoratorType=[],this._decoratorArea=null,this._viewDecoratorInfo={rectangle:{lineWidth:4,strokeStyle:"rgb(254,142,20)",fillStyle:"transparent",maskFillStyle:"transparent"},focus:{lineWidth:4,strokeStyle:"rgb(254,142,20)",fillStyle:"transparent",maskFillStyle:"transparent"},crossline:{lineWidth:2,strokeStyle:"rgb(254,142,20)"},crosshair:{lineWidth:4,strokeStyle:"rgb(254,142,20)"}},this._croppingRegions=void 0,this._defaultCroppingRegions=[null],this.bIncreaseRegionIndexAuto=!0,this._croppingRegionIndex=0,this._loopInterval=void 0,this._defaultLoopInterval=0,this._maxNumberOfFramesInBuffer=void 0,this._defaultMaxNumberOfFramesInBuffer=1,this._frameQueue=[],this._bFetchingLoopStarted=!1,this._refreshInterval=void 0,this._defaultRefreshInterval=-1,this._updateLayersTimeout=100,this._updateLayers=()=>{this._resizeTimeoutId&&clearTimeout(this._resizeTimeoutId),this._resizeTimeoutId=setTimeout(()=>{if(!this.isDisposed){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let o of this._arrScanRegionOverlays)o&&this._updateScanRegionOverlay(o);this._updateDrawingLayersSize()}},this._updateLayersTimeout)},this.mapCameraEvents=new Map([["cameraOpen",[]],["cameraClose",[]],["cameraChange",[]],["resolutionChange",[]],["played",[]],["singleFrameAcquired",[]],["frameAddedToBuffer",[]]]),this._controler=null}static getVersion(){return this._version}static detectEnvironment(){return Ce(this,void 0,void 0,function*(){return yield(async()=>({wasm:Si,worker:bi,getUserMedia:si,camera:await Ci(),browser:Ae.browser,version:Ae.version,OS:Ae.OS}))()})}static set engineResourcePath(o){if(this._hasEngineResourceLoaded)throw new Error("`engineResourcePath` is not allowed to change after `createInstance` is called.");fe._engineResourcePath=(u=>{if(u==null&&(u="./"),!pt){let _=document.createElement("a");_.href=u,u=_.href}return u.endsWith("/")||(u+="/"),u})(o)}static get engineResourcePath(){return this._engineResourcePath}static isStorageAvailable(o){let u;try{u=window[o];const _="__storage_test__";return u.setItem(_,_),u.removeItem(_),!0}catch(_){return _ instanceof DOMException&&(_.code===22||_.code===1014||_.name==="QuotaExceededError"||_.name==="NS_ERROR_DOM_QUOTA_REACHED")&&u&&u.length!==0}}static isDCEFrame(o){return!(!o||typeof o!="object"||Array.isArray(o))&&"data"in o&&"region"in o&&"sx"in o&&"sy"in o&&"width"in o&&"height"in o&&"colorMode"in o&&"timeSpent"in o&&"timeStamp"in o&&"isCropped"in o&&"toCanvas"in o&&"_sWidth"in o&&"_sHeight"in o&&"_bUseWebGL"in o}set maxCvsSideLength(o){if(o<=0)throw new Error("Invalid value.");this._maxCvsSideLength=o}get maxCvsSideLength(){if(this._maxCvsSideLength!==void 0)return this._maxCvsSideLength;if(this._controler){const o=this._controler.getPropertyDisiredValue("maxCvsSideLength");if(o&&o.length===1)return o[0]}return this._defaultMaxCvsSideLength}static set defaultUIElementURL(o){fe._defaultUIElementURL=o}static get defaultUIElementURL(){var o;return(o=fe._defaultUIElementURL)===null||o===void 0?void 0:o.replace("@engineResourcePath/",fe.engineResourcePath)}getUIElement(){return this.UIElement}setUIElement(o){return Ce(this,void 0,void 0,function*(){if(this._bOpen)throw new Error("It is not allowed to change the UIElement when the camera is open.");if(typeof o=="string"||o instanceof String){if(!o.trim().startsWith("<")){let _=yield fetch(o);if(!_.ok)throw Error("setUIElement(elementOrUrl): Network Error: "+_.statusText);o=yield _.text()}if(!o.trim().startsWith("<"))throw Error("setUIElement(elementOrUrl): Can't get valid HTMLElement.");let u=document.createElement("div");u.innerHTML=o;for(let _=0;_<u.childElementCount;++_){let v=u.children[_];v instanceof HTMLStyleElement&&(this.styleEls.push(v),document.head.append(v))}(o=u.childElementCount==1?u.children[0]:u).remove()}this.UIElement=o,this._uiOriginalState={display:o&&o.style.display,inDom:document.body.contains(o)}})}appendAndShowUI(){this.UIElement&&(this.UIElement.parentNode||(this.UIElement.style.position="fixed",this.UIElement.style.left="0",this.UIElement.style.top="0",document.body.append(this.UIElement)),this.UIElement.style.display=="none"&&(this.UIElement.style.display=""))}hideUI(){this.UIElement&&(this.UIElement.style.display="none")}get singleFrameMode(){return this._singleFrameMode}set singleFrameMode(o){if(this._bOpen)throw new Error("It is not allowed to change `singleFrameMode` when the camera is open.");this._singleFrameMode=o}set frameColorMode(o){this._frameColorMode=o}get frameColorMode(){if(this._frameColorMode!==void 0)return this._frameColorMode;if(this._controler){const o=this._controler.getPropertyDisiredValue("frameColorMode");if(o&&o.length===1)return o[0]}return this._defaultFrameColorMode}set bOpen(o){if(this._bOpen=o,o){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let u of this._arrScanRegionOverlays)u&&this._updateScanRegionOverlay(u);this._updateDrawingLayersSize(),this.ifShowScanRegionMask?this.showScanRegionMask():this.hideScanRegionMask(),this.ifShowScanRegionLaser?this.showScanRegionLaser():this.hideScanRegionLaser(),this.showViewDecorator(),this.showScanRegionOverlays(),this._drawingLayersManager.setVisible(!0)}}set ifSaveLastUsedCamera(o){o?fe.isStorageAvailable("localStorage")?this._ifSaveLastUsedCamera=!0:(this._ifSaveLastUsedCamera=!1,console.warn("Local storage is unavailable")):this._ifSaveLastUsedCamera=!1}get ifSaveLastUsedCamera(){return this._ifSaveLastUsedCamera}get video(){return this._video}setVideoFit(o){if(o=o.toLowerCase(),!["contain","cover"].includes(o))throw new Error("Unsupported value '".concat(o,"'."));if(this.videoFit=o,this._video&&(this._video.style.objectFit=o,!this.singleFrameMode)){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let u of this._arrScanRegionOverlays)u&&this._updateScanRegionOverlay(u);this._drawingLayersManager.setObjectFit(o)}}getVideoFit(){return this.videoFit}set ifShowScanRegionMask(o){this._bShowScanRegionMask=o,o?this.showScanRegionMask():this.hideScanRegionMask()}get ifShowScanRegionMask(){return this._bShowScanRegionMask}showScanRegionMask(){this._cvsScanRegion&&(this._cvsScanRegion.style.display=="none"&&(this._cvsScanRegion.style.display=""),this._recordedStates.maskShow=!0)}hideScanRegionMask(){this._cvsScanRegion&&(this._cvsScanRegion.style.display="none",this._recordedStates.maskShow=!1)}set ifShowScanRegionLaser(o){this._bShowScanRegionLaser=o,o?this.showScanRegionLaser():this.hideScanRegionLaser()}get ifShowScanRegionLaser(){if(this._bShowScanRegionLaser!==void 0)return this._bShowScanRegionLaser;if(this._controler){const o=this._controler.getPropertyDisiredValue("ifShowScanRegionLaser");if(o&&o.length){let u=0;for(let _ of o)_||u++;return u!==this._controler.getRegisteredUsers().length}}return this._defaultBShowScanRegionLaser}showScanRegionLaser(){this._divScanLight&&(this._divScanLight.style.display=="none"&&(this._divScanLight.style.display="block"),this._recordedStates.laserShow=!0)}hideScanRegionLaser(){this._divScanLight&&(this._divScanLight.style.display="none",this._recordedStates.laserShow=!1)}_checkValidRegion(o){return!(o!==null&&(!o||!(o.hasOwnProperty("regionLeft")&&o.hasOwnProperty("regionTop")&&o.hasOwnProperty("regionRight")&&o.hasOwnProperty("regionBottom")&&o.hasOwnProperty("regionMeasuredByPercentage"))||o.regionLeft<0||o.regionTop<0||o.regionRight<0||o.regionBottom<0||o.regionMeasuredByPercentage&&(o.regionLeft>100||o.regionTop>100||o.regionRight>100||o.regionBottom>100)))}set scanRegion(o){if(!this._checkValidRegion(o))throw new Error("Invalid region.");this._scanRegion=JSON.parse(JSON.stringify(o)),this._updateScanRegionCanvas(),this._updateScanAreaDiv();for(let u of this._arrScanRegionOverlays)u&&this._updateScanRegionOverlay(u)}setScanRegion(o){this.scanRegion=o}getScanRegion(){return JSON.parse(JSON.stringify(this._scanRegion))}_calculateCvsSize(){if(!this._bOpen)return null;let o,u,_;if(this.singleFrameMode)o=this._imgWidth,u=this._imgHeight,_="contain";else{if(!this._video)return null;o=this._video.videoWidth,u=this._video.videoHeight,_=this.getVideoFit()}return{width:o,height:u,objectFit:_}}addScanRegionOverlayCanvas(){this._assertOpen();const o=document.createElement("canvas");if(this._updateScanRegionOverlay(o),!this._scanRegionOverlayContainer){const u=document.createElement("div");if(this._scanRegionOverlayContainer=u,u.style.position="absolute",u.style.left="0",u.style.top="0",u.style.width="100%",u.style.height="100%",u.style.overflow="hidden",u.style.pointerEvents="none",this._layerBaseCvs)this._layerBaseCvs.parentElement.after(u);else if(this._cvsScanRegion)this._cvsScanRegion.before(u);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(u);else{if(!this._video)throw new Error("'video' is null.");this._video.after(u)}this._recordedStates.overlayShow=!0}return this._scanRegionOverlayContainer.append(o),this._arrScanRegionOverlays.push(o),o}removeScanRegionOverlayCanvas(o){const u=this._arrScanRegionOverlays.indexOf(o);u!==-1&&(o.remove(),this._arrScanRegionOverlays.splice(u,1))}_updateScanRegionOverlay(o){if(!o)return;const u=this._calculateCvsSize();if(!u)return;const{width:_,height:v,objectFit:C}=u;if(_<=0||v<=0)return o.width=0,void(o.height=0);const S=this._getRegionInPixels(_,v,this._scanRegion),x=this.getFrameSize(_,v,this._scanRegion,this.maxCvsSideLength),L=x.dWidth,I=x.dHeight;o.width==L&&o.height==I||(o.width=L,o.height=I);const E=window.getComputedStyle(this._video),F=parseFloat(E.width),M=parseFloat(E.height),q=F/M,se=_/v;let K,J,le,ue,$=1;C==="contain"?(q<se?($=F/_,K=0,J=(M-v*$)/2):($=M/v,K=(F-_*$)/2,J=0),K+=S.regionLeft*$,J+=S.regionTop*$,le=(S.regionRight-S.regionLeft)*$,ue=(S.regionBottom-S.regionTop)*$):C==="cover"?(se>q?($=M/v,K=S.regionLeft*$-(_*$-F)/2,J=S.regionTop*$):($=F/_,K=S.regionLeft*$,J=S.regionTop*$-(v*$-M)/2),le=(S.regionRight-S.regionLeft)*$,ue=(S.regionBottom-S.regionTop)*$):(K=0,J=0,le=0,ue=0),o.style.position="absolute",o.style.left=K+"px",o.style.top=J+"px",o.style.width=le+"px",o.style.height=ue+"px"}showScanRegionOverlays(){this._scanRegionOverlayContainer&&(this._scanRegionOverlayContainer.style.display=="none"&&(this._scanRegionOverlayContainer.style.display=""),this._recordedStates.overlayShow=!0)}hideScanRegionOverlays(){this._scanRegionOverlayContainer&&(this._scanRegionOverlayContainer.style.display="none",this._recordedStates.overlayShow=!1)}setViewDecorator(o,u){if(!o)return void(this._cvsViewDecorator&&(this._cvsViewDecorator.remove(),this._cvsViewDecorator=null));this._assertOpen();let _=[];if(typeof o=="string"?_.push(o):Array.isArray(o)&&(_=JSON.parse(JSON.stringify(o))),!this._cvsViewDecorator){if(this._cvsViewDecorator=document.createElement("canvas"),this._cvsViewDecorator.style.pointerEvents="none",this._cvsScanRegion)this._cvsScanRegion.after(this._cvsViewDecorator);else if(this._scanRegionOverlayContainer)this._scanRegionOverlayContainer.after(this._cvsViewDecorator);else if(this._layerBaseCvs)this._layerBaseCvs.parentElement.after(this._cvsViewDecorator);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(this._cvsViewDecorator);else{if(!this._video)throw new Error("'video' is null.");this._video.after(this._cvsViewDecorator)}this._recordedStates.decoratorShow=!0}this._decoratorArea=JSON.parse(JSON.stringify(u)),this._decoratorType.length=0;const v=["rectangle","focus"],C=["crossline","crosshair"];let S=!1,x=!1;for(let L of _)L=L.toLowerCase(),v.includes(L)&&!S&&(S=!0,this._decoratorType.push(L)),C.includes(L)&&!x&&(x=!0,!this._decoratorType.includes(L)&&this._decoratorType.push(L));this._updateViewDecorator()}getViewDecorator(){return{type:JSON.parse(JSON.stringify(this._decoratorType)),area:JSON.parse(JSON.stringify(this._decoratorArea)),canvas:this._cvsViewDecorator}}showViewDecorator(){this._cvsViewDecorator&&(this._cvsViewDecorator.style.display=="none"&&(this._cvsViewDecorator.style.display=""),this._recordedStates.decoratorShow=!0)}hideViewDecorator(){this._cvsViewDecorator&&(this._cvsViewDecorator.style.display="none",this._recordedStates.decoratorShow=!1)}setViewDecoratorLineWidth(o,u){if(typeof o!="string")throw new Error("The 'type' should be a string.");if(o=o.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(o))throw new Error("The type of '".concat(o,"' doesn't exist."));if(!this._viewDecoratorInfo[o].hasOwnProperty("lineWidth"))throw new Error("It is not allowed to change the property 'lineWidth' when the decorator type is '".concat(o,"'."));this._viewDecoratorInfo[o].lineWidth=u,this._updateViewDecorator()}setViewDecoratorStrokeStyle(o,u){if(typeof o!="string")throw new Error("The 'type' should be a string.");if(o=o.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(o))throw new Error("The type of '".concat(o,"' doesn't exist."));if(!this._viewDecoratorInfo[o].hasOwnProperty("strokeStyle"))throw new Error("It is not allowed to change the property 'strokeStyle' when the decorator type is '".concat(o,"'."));this._viewDecoratorInfo[o].strokeStyle=u,this._updateViewDecorator()}setViewDecoratorFillStyle(o,u){if(typeof o!="string")throw new Error("The 'type' should be a string.");if(o=o.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(o))throw new Error("The type of '".concat(o,"' doesn't exist."));if(!this._viewDecoratorInfo[o].hasOwnProperty("fillStyle"))throw new Error("It is not allowed to change the property 'fillStyle' when the decorator type is '".concat(o,"'."));this._viewDecoratorInfo[o].fillStyle=u,this._updateViewDecorator()}setViewDecoratorMaskFillStyle(o,u){if(typeof o!="string")throw new Error("The 'type' should be a string.");if(o=o.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(o))throw new Error("The type of '".concat(o,"' doesn't exist."));if(!this._viewDecoratorInfo[o].hasOwnProperty("maskFillStyle"))throw new Error("It is not allowed to change the property 'maskFillStyle' when the decorator type is '".concat(o,"'."));this._viewDecoratorInfo[o].maskFillStyle=u,this._updateViewDecorator()}_updateViewDecorator(){if(!this._bOpen||!this._cvsViewDecorator||!this._decoratorArea)return;let o;if(this.singleFrameMode)o="contain";else{if(!this._video)return;o=this.getVideoFit()}const u=this._cvsViewDecorator;u.style.position="absolute",u.style.width="100%",u.style.height="100%",u.style.left="0",u.style.top="0",u.style.objectFit=o;const _=this.getVisibleRegion(!0),v=_.regionRight-_.regionLeft,C=_.regionBottom-_.regionTop;if(u.width==v&&u.height==C||(u.width=v,u.height=C),v<=0||C<=0)return;const S=u.getContext("2d");S.clearRect(0,0,u.width,u.height);const x=this._decoratorArea.x/100*v,L=this._decoratorArea.y/100*C,I=this._decoratorArea.width/100*v,E=this._decoratorArea.height/100*C;for(let F of this._decoratorType){if(F==="rectangle"){S.fillStyle=this._viewDecoratorInfo.rectangle.maskFillStyle,S.fillRect(0,0,u.width,u.height),S.clearRect(Math.round(x),Math.round(L),Math.round(I),Math.round(E)),S.fillStyle=this._viewDecoratorInfo.rectangle.fillStyle,S.fillRect(Math.round(x),Math.round(L),Math.round(I),Math.round(E)),S.lineWidth=this._viewDecoratorInfo.rectangle.lineWidth,S.strokeStyle=this._viewDecoratorInfo.rectangle.strokeStyle;const M=S.lineWidth/2;S.strokeRect(Math.round(x-M),Math.round(L-M),Math.round(I+S.lineWidth),Math.round(E+S.lineWidth))}if(F==="focus"){S.fillStyle=this._viewDecoratorInfo.focus.maskFillStyle,S.fillRect(0,0,u.width,u.height),S.clearRect(Math.round(x),Math.round(L),Math.round(I),Math.round(E)),S.fillStyle=this._viewDecoratorInfo.focus.fillStyle,S.fillRect(Math.round(x),Math.round(L),Math.round(I),Math.round(E)),S.lineWidth=this._viewDecoratorInfo.focus.lineWidth,S.strokeStyle=this._viewDecoratorInfo.focus.strokeStyle;const M=S.lineWidth/2,q=[0,.25,.75,1],se=[0,.25,.75,1];S.beginPath();for(let K=0;K<q.length;K++)if(K==0||K==3)for(let J=0;J<se.length;J+=2)S.moveTo(Math.round(x+q[K]*I),Math.round(L+se[J]*E)),S.lineTo(Math.round(x+q[K]*I),Math.round(L+se[J+1]*E));for(let K=0;K<se.length;K++)if(K==0||K==3)for(let J=0;J<q.length;J+=2)S.moveTo(Math.round(x+q[J]*I-M),Math.round(L+se[K]*E)),S.lineTo(Math.round(x+q[J+1]*I+M),Math.round(L+se[K]*E));S.stroke()}if(F==="crossline"&&(S.beginPath(),S.lineWidth=this._viewDecoratorInfo.crossline.lineWidth,S.strokeStyle=this._viewDecoratorInfo.crossline.strokeStyle,S.moveTo(Math.round(x),Math.round(L+E/2)),S.lineTo(Math.round(x+I),Math.round(L+E/2)),S.moveTo(Math.round(x+I/2),Math.round(L)),S.lineTo(Math.round(x+I/2),Math.round(L+E)),S.stroke()),F==="crosshair"){S.beginPath();const M=.05*Math.min(I,E);S.lineWidth=this._viewDecoratorInfo.crosshair.lineWidth,S.strokeStyle=this._viewDecoratorInfo.crosshair.strokeStyle,S.moveTo(Math.round(x+(I-M)/2),Math.round(L+E/2)),S.lineTo(Math.round(x+(I+M)/2),Math.round(L+E/2)),S.moveTo(Math.round(x+I/2),Math.round(L+(E-M)/2)),S.lineTo(Math.round(x+I/2),Math.round(L+(E+M)/2)),S.stroke()}}}getVisibleRegion(o){this._assertOpen();const u=this._calculateCvsSize();if(!u)return null;const{width:_,height:v,objectFit:C}=u;let S=(()=>{const x=parseFloat(window.getComputedStyle(this._video).width),L=parseFloat(window.getComputedStyle(this._video).height);let I,E={regionBottom:v,regionRight:_,regionLeft:0,regionTop:0,regionMeasuredByPercentage:!1};return C==="cover"?x/L<_/v?(I=L/v,E.regionLeft=Math.floor((_-x/I)/2),E.regionRight=Math.ceil(_-E.regionLeft),E.regionTop=0,E.regionBottom=v):(I=x/_,E.regionTop=Math.floor((v-L/I)/2),E.regionBottom=Math.ceil(v-E.regionTop),E.regionLeft=0,E.regionRight=_):C==="none"&&(x<_&&L<v?(E.regionLeft=Math.floor((_-x)/2),E.regionRight=Math.ceil(_-E.regionLeft),E.regionTop=Math.floor((v-L)/2),E.regionBottom=Math.ceil(v-E.regionTop)):x<_?(E.regionLeft=Math.floor((_-x)/2),E.regionRight=Math.ceil(_-E.regionLeft),E.regionTop=0,E.regionBottom=v):L<v&&(E.regionTop=Math.floor((v-L)/2),E.regionBottom=Math.ceil(v-E.regionTop),E.regionLeft=0,E.regionRight=_)),E})();return o?S.regionMeasuredByPercentage=!1:(S.regionBottom=Math.ceil(S.regionBottom/v*100),S.regionRight=Math.ceil(S.regionRight/_*100),S.regionLeft=Math.floor(S.regionLeft/_*100),S.regionTop=Math.floor(S.regionTop/v*100),S.regionMeasuredByPercentage=!0),S}setScanRegionMaskStyle(o){o&&(o.fillStyle&&(this.regionMaskFillStyle=o.fillStyle),o.strokeStyle&&(this.regionMaskStrokeStyle=o.strokeStyle),o.lineWidth&&(this.regionMaskLineWidth=o.lineWidth),this._updateScanRegionCanvas())}_getRegionInPixels(o,u,_){if(!(o<=0||u<=0))return _?_.regionMeasuredByPercentage?{regionLeft:Math.round(_.regionLeft/100*o),regionTop:Math.round(_.regionTop/100*u),regionRight:Math.round(_.regionRight/100*o),regionBottom:Math.round(_.regionBottom/100*u),regionMeasuredByPercentage:!1}:JSON.parse(JSON.stringify(_)):{regionLeft:0,regionTop:0,regionRight:o,regionBottom:u,regionMeasuredByPercentage:!1}}_updateScanRegionCanvas(){if(!this._bOpen)return;const o=this._calculateCvsSize();if(!o)return;const{width:u,height:_,objectFit:v}=o;if(u<=0||_<=0)return void(this._cvsScanRegion&&(this._cvsScanRegion.width=0,this._cvsScanRegion.height=0));const C=this._getRegionInPixels(u,_,this._scanRegion);this._cvsScanRegion||(this._cvsScanRegion=document.createElement("canvas"),this._cvsScanRegion.style.pointerEvents="none",this._scanRegionOverlayContainer?this._scanRegionOverlayContainer.after(this._cvsScanRegion):this._layerBaseCvs?this._layerBaseCvs.parentElement.after(this._cvsScanRegion):this._cvsSingleFrameMode?this._cvsSingleFrameMode.after(this._cvsScanRegion):this._video.after(this._cvsScanRegion),this._recordedStates.maskShow=!0);const S=this._cvsScanRegion;S.style.position="absolute",S.style.width="100%",S.style.height="100%",S.style.left="0",S.style.top="0",S.style.objectFit=v,S.width==u&&S.height==_||(S.width=u,S.height=_);const x=S.getContext("2d");if(x.clearRect(0,0,S.width,S.height),C.regionLeft!=0||C.regionRight!=u||C.regionTop!=0||C.regionBottom!=_){const L=C.regionLeft,I=C.regionTop,E=C.regionRight-C.regionLeft,F=C.regionBottom-C.regionTop;x.fillStyle=this.regionMaskFillStyle,x.fillRect(0,0,S.width,S.height),x.clearRect(Math.round(L),Math.round(I),Math.round(E),Math.round(F)),x.strokeStyle=this.regionMaskStrokeStyle,x.lineWidth=this.regionMaskLineWidth;const M=x.lineWidth/2;x.strokeRect(Math.round(L-M),Math.round(I-M),Math.round(E+x.lineWidth),Math.round(F+x.lineWidth))}}_updateScanAreaDiv(){if(!this._bOpen)return;const o=this._calculateCvsSize();if(!o)return;const{width:u,height:_,objectFit:v}=o;if(!this._divScanArea)return;if(u<=0||_<=0)return this._divScanArea.style.width="0",void(this._divScanArea.style.height="0");const C=this._getRegionInPixels(u,_,this._scanRegion),S=window.getComputedStyle(this._video),x=parseFloat(S.width),L=parseFloat(S.height),I=x/L,E=u/_;let F,M,q,se,K=1;if(v==="contain")I<E?(K=x/u,F=0,M=(L-_*K)/2):(K=L/_,F=(x-u*K)/2,M=0),F+=C.regionLeft*K,M+=C.regionTop*K,q=(C.regionRight-C.regionLeft)*K,se=(C.regionBottom-C.regionTop)*K;else if(v==="cover")if(I<E){K=L/_,F=C.regionLeft*K-(u*K-x)/2,F=Math.max(F,0),F=Math.min(F,parseFloat(S.width)),M=C.regionTop*K;let J=C.regionRight*K-(u*K-x)/2;J=Math.max(J,0),J=Math.min(J,parseFloat(S.width)),q=J-F,se=(C.regionBottom-C.regionTop)*K}else{K=x/u,F=C.regionLeft*K,M=C.regionTop*K-(_*K-L)/2,M=Math.max(M,0),M=Math.min(M,parseFloat(S.height));let J=C.regionBottom*K-(_*K-L)/2;J=Math.max(J,0),J=Math.min(J,parseFloat(S.height)),q=(C.regionRight-C.regionLeft)*K,se=J-M}else F=0,M=0,q=0,se=0;this._divScanArea.style.left=F+"px",this._divScanArea.style.top=M+"px",this._divScanArea.style.width=q+"px",this._divScanArea.style.height=se+"px"}set croppingRegions(o){this._croppingRegions=o,this._bFetchingLoopStarted&&(this.bIncreaseRegionIndexAuto&&(this._croppingRegionIndex=0),this._fetchingLoop(!1))}get croppingRegions(){if(this._croppingRegions!==void 0)return this._croppingRegions;if(this._controler){const o=this._controler.getPropertyDisiredValue("croppingRegions");if(o&&o.length===1)return o[0]}return this._defaultCroppingRegions}set croppingRegionIndex(o){o<0?(this.bIncreaseRegionIndexAuto=!0,this._croppingRegionIndex=0):(this.bIncreaseRegionIndexAuto=!1,this._croppingRegionIndex=o)}get croppingRegionIndex(){return this._croppingRegionIndex}set loopInterval(o){if(o<0)throw new Error("'Invalid value.");this._loopInterval=o,this._bFetchingLoopStarted&&this._fetchingLoop(!1)}get loopInterval(){if(this._loopInterval!==void 0)return this._loopInterval;if(this._controler){const o=this._controler.getPropertyDisiredValue("loopInterval");if(o&&o.length===1)return o[0]}return this._defaultLoopInterval}set maxNumberOfFramesInBuffer(o){if(o<=0)throw new Error("Invalid value.");for(this._maxNumberOfFramesInBuffer=o;this._frameQueue&&this._frameQueue.length>this.maxNumberOfFramesInBuffer;)this._frameQueue.shift()}get maxNumberOfFramesInBuffer(){if(this._maxNumberOfFramesInBuffer!==void 0)return this._maxNumberOfFramesInBuffer;if(this._controler){const o=this._controler.getPropertyDisiredValue("maxNumberOfFramesInBuffer");if(o&&o.length===1)return o[0]}return this._defaultMaxNumberOfFramesInBuffer}get numberOfFramesInBuffer(){return this._frameQueue.length}set refreshInterval(o){this._refreshInterval=o}get refreshInterval(){if(this._refreshInterval!==void 0)return this._refreshInterval;if(this._controler){const o=this._controler.getPropertyDisiredValue("refreshInterval");if(o&&o.length===1)return o[0]}return this._defaultRefreshInterval}static createInstance(o){return Ce(this,void 0,void 0,function*(){let u=new fe;(typeof o=="string"||o instanceof String)&&(o=JSON.parse(o));for(let _ in o)u[_]=o[_];return this._hasEngineResourceLoaded=!0,fe.onWarning&&(location&&location.protocol==="file:"?setTimeout(()=>{fe.onWarning&&fe.onWarning({id:1,message:"Not using HTTP protocol, the SDK may not work correctly."})},0):location&&location.protocol!=="https:"&&setTimeout(()=>{fe.onWarning&&fe.onWarning({id:2,message:"Not connected via SSL (HTTPS), the SDK may not work correctly."})},0)),u._drawingLayersManager=new Ti,u})}play(o,u,_,v){return Ce(this,void 0,void 0,function*(){if(this._video&&this.videoSrc){yield new Promise((M,q)=>{this._video.onloadedmetadata=()=>Ce(this,void 0,void 0,function*(){this._video&&(this._video.onloadedmetadata=null,yield this._video.play(),M())}),typeof this.videoSrc=="string"||this.videoSrc instanceof String?this._video.src=this.videoSrc:this._video.srcObject=this.videoSrc,setTimeout(()=>q(new Error("Failed to play video. Timeout.")),4e3)});const E={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};this.playCallbackInfo=JSON.parse(JSON.stringify(E));const F=this.mapCameraEvents.get("played");for(let M of F){if(!M)continue;const q=JSON.parse(JSON.stringify(E));setTimeout(()=>M.apply(this,[q]),0)}return this._recordedStates.videoPlaying=!0,E}if(this.singleFrameMode)return v&&v.notTriggerSingleFrameClick||this._clickIptSingleFrameMode(),this.playCallbackInfo={width:0,height:0,deviceId:null},JSON.parse(JSON.stringify(this.playCallbackInfo));if(!this._video)return this.playCallbackInfo=null,null;const C=++this.iPlayRound;let S=null,x=0,L=0;if(this._currentCamera&&(S=this._currentCamera.deviceId),this._video&&(x=this._video.videoWidth,L=this._video.videoHeight),this.promisePlay&&(yield this.promisePlay,C<this.iPlayRound))return this.playCallbackInfo={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId},JSON.parse(JSON.stringify(this.playCallbackInfo));this.promisePlay=(()=>Ce(this,void 0,void 0,function*(){var E;try{let _e=function(he){return Ce(this,void 0,void 0,function*(){for(let r of ue){F(),r&&(yield new Promise(i=>setTimeout(i,r))),F();{const i=he.video.deviceId;pe=i?i.exact||i.ideal||i:null}try{fe._onLog&&fe._onLog("DCE: ask "+JSON.stringify(he)),J=yield navigator.mediaDevices.getUserMedia(he),F();break}catch(i){$=i,fe._onLog&&fe._onLog("DCE: "+i.message||i)}}})};this._video&&this._video.srcObject&&this.stop(),fe._onLog&&fe._onLog("DCE: ======before video========");const F=()=>{if(!this._video)throw J&&J.getTracks().forEach(he=>{he.stop()}),this._videoTrack=null,this._currentCamera=null,new Error("'video' is null.")},M=this.getVideoSettings();let q;typeof M.video=="boolean"&&(M.video={});const se=["rear","back","rck","arrire","trasera","trs","traseira","posteriore","","","","","","","","","","arka","achterzijde","","baksidan","bagside","sau","bak","tylny","takakamera","belakang","","","spate","hts","zadn","darrere","zadn","","stranja","belakang",""],K=()=>{for(let he of this._allCameras){let r=he.label.toLowerCase();if(r&&se.some(i=>r.indexOf(i)!=-1)&&/\b0(\b)?/.test(r)){delete M.video.facingMode,M.video.deviceId={ideal:he.deviceId};break}}M.video.deviceId||["Android","HarmonyOS"].indexOf(Ae.OS)==-1||(delete M.video.facingMode,M.video.deviceId={ideal:this._allCameras[this._allCameras.length-1].deviceId})};if(o)delete M.video.facingMode,M.video.deviceId={exact:o};else if(!M.video.deviceId){if(this._lastDeviceId)delete M.video.facingMode,M.video.deviceId={exact:this._lastDeviceId};else if(this.ifSaveLastUsedCamera&&fe.isStorageAvailable&&window.localStorage.getItem("dce_last_camera_id")){delete M.video.facingMode,M.video.deviceId={exact:window.localStorage.getItem("dce_last_camera_id")};const he=JSON.parse(window.localStorage.getItem("dce_last_apply_width")),r=JSON.parse(window.localStorage.getItem("dce_last_apply_height"));he&&r&&(M.video.width=he,M.video.height=r)}else if(!this.ifSkipCameraInspection){if(M.video.facingMode){if(Ae.OS!=="iPhone"&&Ae.OS!=="Mac"&&(yield this.getAllCameras(!0)),!this._video)return null;let he=M.video.facingMode;he instanceof Array&&he.length&&(he=he[0]),he=he.exact||he.ideal||he,he==="environment"&&(q=!!M.video.facingMode,K())}}}let J;u&&(M.video.width={ideal:u}),_&&(M.video.height={ideal:_}),fe._onLog&&fe._onLog("DCE: ======try getUserMedia========");let le,ue=[0,500],$=null,pe=null;if(yield _e(M),J||(fe._onLog&&fe._onLog("DCE: ======try getUserMedia again========"),le=JSON.parse(JSON.stringify(M)),typeof le.video=="object"&&(Ae.OS=="iPhone"?(u>=1280||_>=1280?le.video.width=1280:u>=640||_>=640?le.video.width=640:(u<640||_<640)&&(le.video.width=320),delete le.video.height):q&&!M.video.deviceId?(delete le.video.facingMode,this._allCameras.length&&(le.video.deviceId={ideal:this._allCameras[this._allCameras.length-1].deviceId})):le.video=!0),fe._onLog&&fe._onLog("DCE: "+le),yield _e(le)),J||(ue=[1e3,2e3],yield _e(M)),J||(yield _e(le)),!J)throw $;const Se=()=>{const he=J.getVideoTracks();let r,i;if(he.length&&(r=this._videoTrack=he[0]),this._video&&r){const n=r.getSettings();if(n){for(let a of this._allCameras)if(n.deviceId===a.deviceId){a._checked=!0,a.label=r.label,i=a;break}}if(!i&&pe){for(let a of this._allCameras)if(pe==a.deviceId){r.label&&(a._checked=!0,a.label=r.label),i=a;break}}}this._currentCamera=i};if(yield this.getAllCameras(!0),F(),q){Se(),K();let he=M.video.deviceId;he&&(he=he.exact||he.ideal||he);let r=(E=this._currentCamera)===null||E===void 0?void 0:E.deviceId;!he||r&&he==r||(J.getTracks().forEach(i=>{i.stop()}),ue=[0,500,1e3,2e3],yield _e(M))}F(),yield(()=>Ce(this,void 0,void 0,function*(){fe._onLog&&fe._onLog("======play video========"),yield new Promise((he,r)=>{F(),this._video.onloadedmetadata=()=>Ce(this,void 0,void 0,function*(){F(),this._video.onloadedmetadata=null,yield this._video.play(),he()}),this._video.srcObject=J,setTimeout(()=>r(new Error("Failed to play video. Timeout.")),4e3)})}))(),F(),fe._onLog&&fe._onLog("DCE: ======played video========"),this._bgLoading&&(this._bgLoading.style.animationPlayState="paused");const g=this._video.videoWidth+"x"+this._video.videoHeight;this._optGotRsl&&(this._optGotRsl.setAttribute("data-width",this._video.videoWidth),this._optGotRsl.setAttribute("data-height",this._video.videoHeight),this._optGotRsl.innerText=g,this._selRsl&&this._optGotRsl.parentNode==this._selRsl&&(this._selRsl.value="got")),fe._onLog&&fe._onLog("DCE: got "+g),Se(),F(),this._renderSelCameraInfo();const ye={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};ye.deviceId&&(this._lastDeviceId=ye.deviceId,this.ifSaveLastUsedCamera&&fe.isStorageAvailable&&(window.localStorage.setItem("dce_last_camera_id",this._lastDeviceId),M.video.width&&M.video.height&&(window.localStorage.setItem("dce_last_apply_width",JSON.stringify(M.video.width)),window.localStorage.setItem("dce_last_apply_height",JSON.stringify(M.video.height)))));const oe=this.mapCameraEvents.get("played");for(let he of oe){if(!he)continue;const r=JSON.parse(JSON.stringify(ye));setTimeout(()=>he.apply(this,[r]),0)}if(S&&S!=ye.deviceId){const he=this.mapCameraEvents.get("cameraChange");for(let r of he){if(!r)continue;const i=JSON.parse(JSON.stringify(ye));setTimeout(()=>r.apply(this,[i]),0)}}if(x&&L&&(x!=ye.width||L!=ye.height)){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let r of this._arrScanRegionOverlays)r&&this._updateScanRegionOverlay(r);this._cvsOriginalImage||this._updateDrawingLayersSize();const he=this.mapCameraEvents.get("resolutionChange");for(let r of he){if(!r)continue;const i=JSON.parse(JSON.stringify(ye));setTimeout(()=>r.apply(this,[i]),0)}}return this.promisePlay=null,ye}catch(F){throw this.promisePlay=null,this._bgLoading&&(this._bgLoading.style.display="none"),F.name==="NotFoundError"&&(DOMException?F=new DOMException("No camera available, please use a device with an accessible camera.",F.name):(F=new Error("No camera available, please use a device with an accessible camera.")).name="NotFoundError"),F}}))();const I=yield this.promisePlay;return this.playCallbackInfo=JSON.parse(JSON.stringify(I)),this._recordedStates.videoPlaying=!0,I})}resume(){return Ce(this,void 0,void 0,function*(){this._assertOpen(),yield this.play(),this.ifShowScanRegionLaser&&this.showScanRegionLaser()})}pause(){this._assertOpen(),this._video&&(this._video.pause(),this._recordedStates.videoPlaying=!1),this.ifShowScanRegionLaser&&this.hideScanRegionLaser()}_bindUI(){if(!this.UIElement)throw new Error("Need to define `UIElement` before opening.");const o=[this.UIElement];for(let u=0;u<o.length;++u)for(let _ of o[u].children)o.push(_);for(let u of o){if(!this._video&&u.classList.contains("dce-video-container")){this._divVideoContainer=u;const _=document.createElement("video");_.style.position="absolute",_.style.left="0",_.style.top="0",_.style.width="100%",_.style.height="100%",_.style.objectFit=this.getVideoFit(),_.setAttribute("playsinline","true"),_.setAttribute("muted","true"),u.prepend(_),this._video=_}else!this._divScanArea&&u.classList.contains("dce-scanarea")?this._divScanArea=u:!this._divScanLight&&u.classList.contains("dce-scanlight")?this._divScanLight=u:!this._bgLoading&&u.classList.contains("dce-bg-loading")?this._bgLoading=u:!this._bgCamera&&u.classList.contains("dce-bg-camera")?this._bgCamera=u:!this._selCam&&u.classList.contains("dce-sel-camera")?this._selCam=u:!this._selRsl&&u.classList.contains("dce-sel-resolution")?(this._selRsl=u,this.videoSrc||this.singleFrameMode||this._selRsl.options.length||(this._selRsl.innerHTML=[this._optGotRsl?"":'<option class="dce-opt-gotResolution" value="got"></option>','<option data-width="3840" data-height="2160">3840x2160</option>','<option data-width="1920" data-height="1080">1920x1080</option>','<option data-width="1280" data-height="720">1280x720</option>'].join(""),this._optGotRsl=this._optGotRsl||this._selRsl.options[0])):!this._optGotRsl&&u.classList.contains("dce-opt-gotResolution")?this._optGotRsl=u:!this._btnClose&&u.classList.contains("dce-btn-close")?this._btnClose=u:!this._selMinLtr&&u.classList.contains("dlr-sel-minletter")?(this._selMinLtr=u,this._selMinLtr.options.length||(this._selMinLtr.innerHTML=[this._optGotMinLtr?"":'<option class="dlr-opt-gotMinLtr" value="got"></option>','<option value="0" selected>any letter</option>','<option value="3">3+ letters</option>','<option value="5">5+ letters</option>','<option value="8">8+ letters</option>','<option value="12">12+ letters</option>','<option value="17">17+ letters</option>','<option value="30">30+ letters</option>','<option value="50">50+ letters</option>','<option value="80">80+ letters</option>','<option value="120">120+ letters</option>'].join(""),this._optGotMinLtr=this._optGotMinLtr||this._selMinLtr.options[0])):!this._optGotMinLtr&&u.classList.contains("dlr-opt-gotMinLtr")&&(this._optGotMinLtr=u);if(this.extraBindings&&this.extraBindings.length)for(let _ of this.extraBindings)try{_(u)}catch(v){}}if(!this._video)throw this._unbindUI(),Error("Can not find the video container element with class 'dce-video-container'");this.singleFrameMode?(this._video&&(this._video.addEventListener("click",this._clickIptSingleFrameMode),this._video.style.cursor="pointer",this._video.setAttribute("title","Take a photo")),this._selCam&&(this._selCam.style.display="none"),this._selRsl&&(this._selRsl.style.display="none"),this._selMinLtr&&(this._selMinLtr.style.display="none"),this._bgCamera&&(this._bgCamera.style.display="block")):(this._selCam&&(this._selCam.style.display="block",this._selCam.addEventListener("change",this._onCameraSelChange)),this._selRsl&&(this._selRsl.style.display="block",this._selRsl.addEventListener("change",this._onResolutionSelChange)),this._selMinLtr&&(this._selMinLtr.style.display="block"),this._bgLoading&&(this._bgLoading.style.display="block")),this._btnClose&&this._btnClose.addEventListener("click",this._onCloseBtnClick),document.addEventListener("visibilitychange",this._ev_documentHideEvent),window.ResizeObserver?(this._resizeObserver||(this._resizeObserver=new ResizeObserver(u=>{for(let _ of u)_.target===this._divVideoContainer&&this._updateLayers()})),this._divVideoContainer&&this._resizeObserver.observe(this._divVideoContainer)):window.addEventListener("resize",this._updateLayers)}_unbindUI(){this.singleFrameMode?(this._video&&(this._video.removeEventListener("click",this._clickIptSingleFrameMode),this._video.style.cursor="",this._video.removeAttribute("title")),this._bgCamera&&(this._bgCamera.style.display="none")):this._bgLoading&&(this._bgLoading.style.display="none"),this._selCam&&this._selCam.removeEventListener("change",this._onCameraSelChange),this._selRsl&&this._selRsl.removeEventListener("change",this._onResolutionSelChange),this._btnClose&&this._btnClose.removeEventListener("click",this._onCloseBtnClick),this.hideScanRegionLaser(),this.hideViewDecorator(),this.hideScanRegionOverlays(),this._drawingLayersManager.setVisible(!1),this._hideOriginalImageCvs(),this._video&&(this._video.onloadedmetadata=null,this._video.remove()),this._divVideoContainer=null,this._video=null,this._selCam=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this._selMinLtr=null,this._optGotMinLtr=null,this._divScanArea=null,this._divScanLight=null,this._cvsScanRegion&&(this._cvsScanRegion.remove(),this._cvsScanRegion=null),this._singleFrameModeIpt&&(this._singleFrameModeIpt.remove(),this._singleFrameModeIpt=null),this._cvsSingleFrameMode&&(this._cvsSingleFrameMode.remove(),this._cvsSingleFrameMode=null),document.removeEventListener("visibilitychange",this._ev_documentHideEvent),window.ResizeObserver?this._resizeObserver&&this._resizeObserver.disconnect():window.removeEventListener("resize",this._updateLayers)}_assertOpen(){if(!this._bOpen)throw Error("The camera is not open.")}open(o){return Ce(this,void 0,void 0,function*(){this.UIElement||(yield this.setUIElement(fe.defaultUIElementURL)),this._bindUI(),o&&this.appendAndShowUI();let u=yield this.play();this.bOpen=!0;const _=this.mapCameraEvents.get("cameraOpen");for(let v of _){if(!v)continue;const C=JSON.parse(JSON.stringify(u));setTimeout(()=>v.apply(this,[C]),0)}return u})}close(o){if(!this._video)return;this.stop(),this._hideOriginalImage(!1),this._unbindUI(),o&&this.hideUI(),this.stopFetchingLoop(),this.bOpen=!1;const u=this.mapCameraEvents.get("cameraClose");for(let _ of u){if(!_)continue;const v={width:0,height:0,deviceId:null};setTimeout(()=>_.apply(this,[v]),0)}}stop(){this._video&&this._video.srcObject&&(fe._onLog&&fe._onLog("DCE: ======stop video========"),this._video.srcObject.getTracks().forEach(o=>{o.stop()}),this._video.srcObject=null,this._videoTrack=null,this._currentCamera=null),this._video&&this.videoSrc&&(fe._onLog&&fe._onLog("DCE: ======stop existing video========"),this._video.pause(),this._video.currentTime=0),this._bgLoading&&(this._bgLoading.style.animationPlayState=""),this._frameQueue.length=0,this._reusedCvs&&this._reusedCvs.ctx2d&&this._reusedCvs.ctx2d.clearRect(0,0,this._reusedCvs.width,this._reusedCvs.height),this.forceLoseContext()}getAllCameras(o){return Ce(this,void 0,void 0,function*(){let u=yield navigator.mediaDevices.enumerateDevices();if(!o&&u&&u.length&&!u[0].deviceId){let C=yield navigator.mediaDevices.getUserMedia({video:!0});u=yield navigator.mediaDevices.enumerateDevices(),C.getTracks().forEach(S=>{S.stop()}),C=null}const _=[],v=[];if(this._allCameras)for(let C of this._allCameras)C._checked&&v.push(C);for(let C=0;C<u.length;C++){let S,x=u[C];if(x.kind=="videoinput"){for(let L of v)x.deviceId==L.deviceId&&(S=L);S||(S={},S.deviceId=x.deviceId,S.label=x.label?x.label:"camera "+C),_.push(S)}}return this._allCameras=_,fe._onLog&&fe._onLog("DCE: "+JSON.stringify(this._allCameras)),Promise.resolve(_)})}_renderSelCameraInfo(){if(this._selCam&&(this._selCam.innerHTML=""),this._selCam){let o;for(let u of this._allCameras){let _=document.createElement("option");_.value=u.deviceId,_.innerText=u.label,this._selCam.append(_),u.deviceId&&this._currentCamera&&this._currentCamera.deviceId==u.deviceId&&(o=_)}this._selCam.value=o?o.value:""}}getSelectedCamera(){if(!this._bOpen){let o="";const u=this.videoSettings.video.deviceId;u&&(o=u.exact||u.ideal||u);for(let _ of this._allCameras)if(_.deviceId===o)return JSON.parse(JSON.stringify(_));return{deviceId:o,label:"",_checked:!1}}return this._currentCamera}selectCamera(o){return Ce(this,void 0,void 0,function*(){let u="";return o&&(u=o.deviceId||o),this.videoSettings.video.deviceId={exact:u},this._bOpen?yield this.play(o.deviceId||o):null})}getResolution(){if(this._bOpen)return[this._video.videoWidth,this._video.videoHeight];{let o=0,u=0;const _=this.videoSettings.video.width,v=this.videoSettings.video.height;return _&&(o=_.exact||_.ideal||_),v&&(u=v.exact||v.ideal||v),[o,u]}}setResolution(o,u){return Ce(this,void 0,void 0,function*(){let _,v;return o instanceof Array?(_=o[0],v=o[1]):(_=o,v=u),this.videoSettings.video.width={ideal:_},this.videoSettings.video.height={ideal:v},this._bOpen?yield this.play(null,_,v):null})}getResolutions(o){return Ce(this,void 0,void 0,function*(){let u="";const _=(C,S)=>{const x=this._mapCameraResolutions.get(C);if(!x||!x.length)return!1;for(let L of x)if(L[0]===S.width&&L[1]===S.height)return!0;return!1},v=(C,S,x)=>Ce(this,void 0,void 0,function*(){const L={video:{deviceId:{exact:C},width:{ideal:S},height:{ideal:x}}};let I=null;try{I=yield navigator.mediaDevices.getUserMedia(L)}catch(M){return null}if(!I)return null;const E=I.getVideoTracks();let F=null;try{const M=E[0].getSettings();F={width:M.width,height:M.height}}catch(M){const q=document.createElement("video");q.srcObject=I,F={width:q.videoWidth,height:q.videoHeight},q.srcObject=null}return E.forEach(M=>{M.stop()}),F});if(!this._bOpen){const C=this.videoSettings.video.deviceId;if(!C||(u=C.hasOwnProperty("exact")?this.videoSettings.video.deviceId.exact:C.hasOwnProperty("ideal")?this.videoSettings.video.deviceId.ideal:this.videoSettings.video.deviceId,!u))return null;let S=this._mapCameraResolutions.get(u);if(S&&!o)return this._mapCameraResolutions.get(u);this._mapCameraResolutions.set(u,[]),S=this._mapCameraResolutions.get(u);for(let x of this._predefinedResolutions){const L=yield v(u,x.width,x.height);L&&!_(u,L)&&S.push([L.width,L.height])}return S}if(this._currentCamera){u=this._currentCamera.deviceId;let C=this._mapCameraResolutions.get(u);if(C&&!o)return this._mapCameraResolutions.get(u);this._mapCameraResolutions.set(u,[]),C=this._mapCameraResolutions.get(u);const S=this.getConstraints();for(let x of this._predefinedResolutions){yield this._videoTrack.applyConstraints({width:{ideal:x.width},height:{ideal:x.height}});const L=this._videoTrack.getSettings(),I={width:L.width,height:L.height};_(u,I)||C.push([I.width,I.height])}return yield this._videoTrack.applyConstraints(S),C}return null})}on(o,u){if(!this.mapCameraEvents.has(o))throw new Error("Event '".concat(o,"' is not exists."));const _=this.mapCameraEvents.get(o);_.includes(u)||_.push(u)}off(o,u){if(!this.mapCameraEvents.has(o))throw new Error("Event '".concat(o,"' is not exists."));const _=this.mapCameraEvents.get(o),v=_.indexOf(u);v!==-1&&_.splice(v,1)}offAll(o){if(o){if(typeof o=="string"){const u=this.mapCameraEvents.get(o);u&&(u.length=0)}}else for(let u of this.mapCameraEvents.values())u&&(u.length=0)}getVideoSettings(){return JSON.parse(JSON.stringify(this.videoSettings))}updateVideoSettings(o){return this.videoSettings=JSON.parse(JSON.stringify(o)),this._lastDeviceId=null,this._bOpen?this.play():Promise.resolve()}isOpen(){return this._bOpen}getCapabilities(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getCapabilities()' is unavailable in singleFrameMode.");return this._videoTrack&&this._videoTrack.getCapabilities?this._videoTrack.getCapabilities():{}}getCameraSettings(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getCameraSettings()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings():null}getConstraints(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getConstraints()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getConstraints():null}applyConstraints(o){return Ce(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'applyConstraints()' is unavailable in singleFrameMode.");if(!this._videoTrack)throw new Error('"_videoTrack" is null.');if(!this._videoTrack.applyConstraints)throw Error("Not supported.");return yield this._videoTrack.applyConstraints(o)})}turnOnTorch(){return Ce(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'turnOnTorch()' is unavailable in singleFrameMode.");if(this.getCapabilities().torch)return yield this._videoTrack.applyConstraints({advanced:[{torch:!0}]});throw Error("Not supported.")})}turnOffTorch(){return Ce(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'turnOffTorch()' is unavailable in singleFrameMode.");if(this.getCapabilities().torch)return yield this._videoTrack.applyConstraints({advanced:[{torch:!1}]});throw Error("Not supported.")})}setColorTemperature(o){return Ce(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setColorTemperature()' is unavailable in singleFrameMode.");let u=this.getCapabilities().colorTemperature;if(!u)throw Error("Not supported.");return o<u.min?o=u.min:o>u.max&&(o=u.max),yield this._videoTrack.applyConstraints({advanced:[{colorTemperature:o}]})})}setExposureCompensation(o){return Ce(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setExposureCompensation()' is unavailable in singleFrameMode.");let u=this.getCapabilities().exposureCompensation;if(!u)throw Error("Not supported.");return o<u.min?o=u.min:o>u.max&&(o=u.max),yield this._videoTrack.applyConstraints({advanced:[{exposureCompensation:o}]})})}setZoom(o){return Ce(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setZoom()' is unavailable in singleFrameMode.");let u=this.getCapabilities().zoom;if(!u)throw Error("Not supported.");return o<u.min?o=u.min:o>u.max&&(o=u.max),yield this._videoTrack.applyConstraints({advanced:[{zoom:o}]})})}setFrameRate(o){return Ce(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setFrameRate()' is unavailable in singleFrameMode.");let u=this.getCapabilities().frameRate;if(!u)throw Error("Not supported.");return o<u.min?o=u.min:o>u.max&&(o=u.max),yield this._videoTrack.applyConstraints({width:{ideal:Math.max(this._video.videoWidth,this._video.videoHeight)},frameRate:o})})}getFrameRate(){return this.getCameraSettings().frameRate}setFocus(o,u){return Ce(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setFocus()' is unavailable in singleFrameMode.");const _=this.getCapabilities().focusMode,v=this.getCapabilities().focusDistance;if(!_||!_.includes(o)||!v)throw Error("Not supported.");return u?(u<v.min?u=v.min:u>v.max&&(u=v.max),yield this._videoTrack.applyConstraints({advanced:[{focusMode:o,focusDistance:u}]})):yield this._videoTrack.applyConstraints({advanced:[{focusMode:o}]})})}getFocus(){const o=this.getCameraSettings().focusMode;return o==="continuous"?{mode:o}:{mode:o,distance:this.getCameraSettings().focusDistance}}getFrameSize(o,u,_,v){if(!o||!u)return null;let C,S,x,L,I=o,E=u;const F={regionLeft:0,regionTop:0,regionRight:I,regionBottom:E,regionMeasuredByPercentage:!1};_?(_.regionMeasuredByPercentage?(F.regionLeft=_.regionLeft*I/100,F.regionTop=_.regionTop*E/100,F.regionRight=_.regionRight*I/100,F.regionBottom=_.regionBottom*E/100):(F.regionLeft=_.regionLeft,F.regionTop=_.regionTop,F.regionRight=_.regionRight,F.regionBottom=_.regionBottom),C=F.regionLeft,S=F.regionTop,I=Math.round(F.regionRight-F.regionLeft),E=Math.round(F.regionBottom-F.regionTop)):(C=0,S=0);const M=Math.max(I,E);if(v&&v>0&&M>v){const q=v/M;I>E?(x=v,L=Math.round(E*q)):(x=Math.round(I*q),L=v)}else x=I,L=E;return x<=0||L<=0?null:{sx:C,sy:S,sWidth:I,sHeight:E,dWidth:x,dHeight:L}}getFrame(){if(this.singleFrameMode)throw Error("'getFrame()' is unavailable in singleFrameMode.");if(this._assertOpen(),this.singleFrameMode)throw new Error("'getFrame()' is unavailable in singleFrameMode.");return this._getVideoFrame(this._scanRegion)}getImage(){const o=this.getFrame();return o.pixelFormat=o.colorMode,Object.assign(Object.assign({},o),{pixelFormat:o.colorMode})}_getVideoFrame(o,u){if(this.isDisposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(this._assertOpen(),this.singleFrameMode)throw new Error("'_getVideoFrame()' is unavailable in singleFrameMode.");const _=Date.now();fe._onLog&&fe._onLog("DCE: _getVideoFrame() START: "+_);const v=this._video.videoWidth,C=this._video.videoHeight;if(v===0||C===0)return null;const S=this.getFrameSize(v,C,o,this.maxCvsSideLength);if(!S)return null;let x,L;x=v!==S.sWidth||C!==S.sHeight,L=S.sWidth!==S.dWidth||S.sHeight!==S.dHeight;const I=(()=>!(!this._bWebGLSupported||L))(),E={data:null,region:o?JSON.parse(JSON.stringify(o)):null,sx:S.sx,sy:S.sy,width:S.dWidth,height:S.dHeight,colorMode:null,timeSpent:null,timeStamp:null,isCropped:x,toCanvas:this._toCanvas,_sWidth:S.sWidth,_sHeight:S.sHeight,_bUseWebGL:null};let F;try{F=this._getImageData(this._video,v,C,S,u,{targetColorMode:this.frameColorMode,bUseWebGL:I})}catch(q){if(q.name!=="WebGLError")throw q;fe._onLog&&fe._onLog("DCE: get WebGLError, try again in canvas."),F=this._getImageData(this._video,v,C,S,u,{targetColorMode:this.frameColorMode,bUseWebGL:!1})}if(!F)return null;const M=Date.now();return fe._onLog&&fe._onLog("DCE: _getVideoFrame() END: "+M),E.data=F.data,E.colorMode=F.colorMode,E._bUseWebGL=F._bUseWebGL,E.timeSpent=M-_,E.timeStamp=M,E}_getImageData(o,u,_,v,C,S){if(this.isDisposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(!u||!_)return null;fe._onLog&&fe._onLog("DCE: _getImageData(), START: "+Date.now());const{sx:x,sy:L,sWidth:I,sHeight:E,dWidth:F,dHeight:M}=v;let q;if(q=S&&S.targetColorMode?S.targetColorMode.toLowerCase():"rgba",S&&S.bUseWebGL){fe._onLog&&fe._onLog("DCE:  _getImageData() in WebGL."),this._reusedWebGLCvs||(this._reusedWebGLCvs=document.createElement("canvas"));const se=this._reusedWebGLCvs;se.width==u&&se.height==_||(se.width=u,se.height=_,this._reusedWebGLCtx&&this._reusedWebGLCtx.viewport(0,0,u,_));const K=this._reusedWebGLCtx||se.getContext("webgl",{antialias:!1})||se.getContext("experimental-webgl",{antialias:!1});if(!K){fe._onLog&&fe._onLog("DCE: WebGL unavailable."),this._reusedWebGLCtx=null,this._bWebGLSupported=!1;const $=new Error("WebGL error: unable to initialize WebGL. Your browser or machine may not support it.");throw $.name="WebGLError",$}if(K.enable(K.SCISSOR_TEST),K.scissor(x,L,F,M),!this._reusedWebGLCtx||q!==this.currentFSColorMode){this._reusedWebGLCtx=K;const $=oe=>{const he=oe.createBuffer();oe.bindBuffer(oe.ARRAY_BUFFER,he),oe.bufferData(oe.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,1,1,-1,1]),oe.STATIC_DRAW);const r=oe.createBuffer();return oe.bindBuffer(oe.ELEMENT_ARRAY_BUFFER,r),oe.bufferData(oe.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,0,2,3]),oe.STATIC_DRAW),{position:he,indices:r}},pe=oe=>{const he=oe.createTexture();return oe.bindTexture(oe.TEXTURE_2D,he),oe.texParameteri(oe.TEXTURE_2D,oe.TEXTURE_MAG_FILTER,oe.LINEAR),oe.texParameteri(oe.TEXTURE_2D,oe.TEXTURE_MIN_FILTER,oe.LINEAR),oe.texParameteri(oe.TEXTURE_2D,oe.TEXTURE_WRAP_S,oe.CLAMP_TO_EDGE),oe.texParameteri(oe.TEXTURE_2D,oe.TEXTURE_WRAP_T,oe.CLAMP_TO_EDGE),he},_e=(oe,he,r)=>{const i=Se(oe,oe.VERTEX_SHADER,he),n=Se(oe,oe.FRAGMENT_SHADER,r),a=oe.createProgram();return oe.attachShader(a,i),oe.attachShader(a,n),oe.linkProgram(a),oe.getProgramParameter(a,oe.LINK_STATUS)?a:(alert("Unable to initialize the shader program: "+oe.getProgramInfoLog(a)),null)},Se=(oe,he,r)=>{const i=oe.createShader(he);return oe.shaderSource(i,r),oe.compileShader(i),oe.getShaderParameter(i,oe.COMPILE_STATUS)?i:(alert("An error occurred compiling the shaders: "+oe.getShaderInfoLog(i)),oe.deleteShader(i),null)},be="\n                  attribute mediump vec2 aVertexPosition;\n                  varying mediump vec2 vDirection;\n          \n                  void main( void )\n                  {\n                      gl_Position = vec4(aVertexPosition, 1.0, 1.0) * 2.0;\n                      vDirection = aVertexPosition;\n                  }\n                ";let g;g=["rgba","rbga","grba","gbra","brga","bgra"].includes(q)?q.slice(0,3):"rgb";const ye=_e(K,be,"\n                    precision mediump float;\n\n                    varying mediump vec2 vDirection;\n                    uniform sampler2D uSampler;\n                    uniform lowp float uColorFactor;\n            \n                    void main(void)\n                    {\n                        vec4 sample = texture2D(uSampler, vec2(vDirection.x * 0.5 + 0.5, vDirection.y * 0.5 + 0.5));\n                        lowp float grey = 0.21 * sample.r + 0.71 * sample.g + 0.07 * sample.b;\n                        gl_FragColor = vec4(sample.".concat(g," * (1.0 - uColorFactor) + (grey * uColorFactor), sample.a);\n                    }\n                "));this._webGLProgramInfo={program:ye,attribLocations:{vertexPosition:K.getAttribLocation(ye,"aVertexPosition")},uniformLocations:{uSampler:K.getUniformLocation(ye,"uSampler"),uColorFactor:K.getUniformLocation(ye,"uColorFactor")}},this._webGLBuffers=$(K),this._webGLTexture=pe(K),this.currentFSColorMode=q}const J=($,pe,_e)=>{const Se=$.RGBA,be=$.RGBA,g=$.UNSIGNED_BYTE;$.bindTexture($.TEXTURE_2D,pe),$.texImage2D($.TEXTURE_2D,0,Se,be,g,_e)},le=($,pe,_e,Se)=>{$.clearColor(0,0,0,1),$.clearDepth(1),$.enable($.DEPTH_TEST),$.depthFunc($.LEQUAL),$.clear($.COLOR_BUFFER_BIT|$.DEPTH_BUFFER_BIT),$.bindBuffer($.ELEMENT_ARRAY_BUFFER,_e.indices),$.useProgram(pe.program);{const ye=$.FLOAT,oe=!1,he=0,r=0;$.bindBuffer($.ARRAY_BUFFER,_e.position),$.vertexAttribPointer(pe.attribLocations.vertexPosition,2,ye,oe,he,r),$.enableVertexAttribArray(pe.attribLocations.vertexPosition)}$.activeTexture($.TEXTURE0),$.bindTexture($.TEXTURE_2D,Se),$.uniform1i(pe.uniformLocations.uSampler,0),$.uniform1f(pe.uniformLocations.uColorFactor,q==="grey"||q==="grey32"?1:0);const be=$.UNSIGNED_SHORT;$.drawElements($.TRIANGLES,6,be,0)};let ue;if(J(K,this._webGLTexture,o),le(K,this._webGLProgramInfo,this._webGLBuffers,this._webGLTexture),C){if(C.length<F*M*4)return null;ue=C}else this.ifReuseArrayBufferView||q==="grey"?(this._reusedDataContainer&&this._reusedDataContainer.length===F*M*4||(this._reusedDataContainer=new Uint8Array(F*M*4)),ue=this._reusedDataContainer):ue=new Uint8Array(F*M*4);if(K.readPixels(x,L,F,M,K.RGBA,K.UNSIGNED_BYTE,ue),K.disable(K.SCISSOR_TEST),ue[3]!==255){fe._onLog&&fe._onLog("DCE: WebGL drawing incorrect."),this.forceLoseContext(),this._bWebGLSupported=!1;const $=new Error("WebGL error: incorrect WebGL drawing.");throw $.name="WebGLError",$}if(q==="grey"){let $=fe._onLog?Date.now():0;if(ue=new Uint8Array(new Uint32Array(ue.buffer)),C){if(C.length<ue.length)return null;C.set(ue)}fe._onLog&&fe._onLog("DCE: Extract grey cost: "+(Date.now()-$))}return fe._onLog&&fe._onLog("DCE: _getImageData() in WebGL, END: "+Date.now()),{data:ue,colorMode:q,_bUseWebGL:!0}}{fe._onLog&&fe._onLog("DCE:  _getImageData() in canvas."),this._reusedCvs||(this._reusedCvs=document.createElement("canvas"));const se=this._reusedCvs;se.width===F&&se.height===M||(se.width=F,se.height=M),se.ctx2d||(se.ctx2d=se.getContext("2d"));const K=se.ctx2d;K.drawImage(o,x,L,I,E,0,0,F,M);let J=K.getImageData(0,0,se.width,se.height).data;if(["rbga","grba","gbra","brga","bgra"].includes(q)){const le=q.indexOf("r"),ue=q.indexOf("g"),$=q.indexOf("b");let pe=0;le===1||le===2?pe=le:ue===2&&(pe=ue);for(let _e=0;_e<J.length;_e+=4){let Se;pe&&(Se=J[_e+pe]),J[_e+le]=J[_e],J[_e+ue]=pe===1?Se:J[_e+1],J[_e+$]=pe===2?Se:J[_e+2]}}else if(q==="grey"||q==="grey32")for(let le=0;le<J.length;le+=4){const ue=.21*J[le]+.71*J[le+1]+.07*J[le+2];J[le]=ue,J[le+1]=ue,J[le+2]=ue}if(J=q==="grey"?new Uint8Array(new Uint32Array(J.buffer)):new Uint8Array(J.buffer),C){if(C.length<J.length)return null;C.set(J)}return fe._onLog&&fe._onLog("DCE: _getImageData() in canvas, END: "+Date.now()),{data:J,colorMode:q,_bUseWebGL:!1}}}getCurrentRegion(){let o=null;if(this._scanRegion)o=this._scanRegion;else if(this.croppingRegions){if(this._croppingRegionIndex>=this.croppingRegions.length||this._croppingRegionIndex<0)throw new Error("The 'croppingRegionIndex' is out of bounds.");o=this.croppingRegions[this._croppingRegionIndex],this.bIncreaseRegionIndexAuto&&++this._croppingRegionIndex>=this.croppingRegions.length&&(this._croppingRegionIndex=0)}return o}_fetchingLoop(o){if(this.isDisposed)return;if(!this._bOpen||!this.isFetchingLoopStarted())return void this.stopFetchingLoop();const u=()=>{fe._onLog&&fe._onLog("DCE: start fetching a frame: "+Date.now());const v=this.getCurrentRegion();let C=this._getVideoFrame(v);if(!C)return void(fe._onLog&&fe._onLog("DCE: get a invalid frame, abandon it: "+Date.now()));for(;this._frameQueue&&this._frameQueue.length>=this.maxNumberOfFramesInBuffer;)this._frameQueue.shift();this._frameQueue.push(C),fe._onLog&&fe._onLog("DCE: finish fetching a frame: "+Date.now());const S=this.mapCameraEvents.get("frameAddedToBuffer");for(let x of S)x&&setTimeout(x.bind(this),0)},_=()=>{this.isDisposed||(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this.refreshInterval<=0||(this._frameLoopTimeoutId2=setTimeout(()=>{this.isDisposed||(this._bOpen&&this.isFetchingLoopStarted()?(fe._onLog&&fe._onLog("DCE: second timeout executes: "+Date.now()),u(),_()):this.stopFetchingLoop())},this.refreshInterval)))};o&&(this._frameQueue.length<this.maxNumberOfFramesInBuffer?(u(),this.refreshInterval>0&&_()):this.refreshInterval>0?(u(),_()):this.refreshInterval===0?u():this.refreshInterval),this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId),this._frameLoopTimeoutId=setTimeout(()=>{this.isDisposed||this._fetchingLoop(!0)},this.loopInterval)}startFetchingLoop(){if(this.isDisposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(this._assertOpen(),this.singleFrameMode)throw Error("'startFetchingLoop()' is unavailable in singleFrameMode.");this.isFetchingLoopStarted()||(this._bFetchingLoopStarted=!0,this._recordedStates.fetchingLoopStart=!0,fe._onLog&&fe._onLog("start fetching loop: "+Date.now()),this._fetchingLoop(!0))}isFetchingLoopStarted(){return this._bFetchingLoopStarted}stopFetchingLoop(){this._bFetchingLoopStarted&&(fe._onLog&&fe._onLog("stop fetching loop: "+Date.now()),this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId),this._frameQueue.length=0,this._bFetchingLoopStarted=!1,this._recordedStates.fetchingLoopStart=!1)}getFrameFromBuffer(o){return this._frameQueue&&this._frameQueue.length?o?o<this._frameQueue.length?(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this._frameQueue.splice(o,1)[0]):void 0:(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this._frameQueue.shift()):null}forceLoseContext(){if(!this._reusedWebGLCtx)return;const o=this._reusedWebGLCtx;o&&!o.isContextLost()&&o.getExtension("WEBGL_lose_context")&&o.getExtension("WEBGL_lose_context").loseContext(),this._webGLTexture=null,this._webGLProgramInfo=null,this._webGLBuffers=null,this._reusedWebGLCtx=null,this._reusedWebGLCvs=null}_createDrawingLayerBaseCvs(){this._assertOpen();const o=this._calculateCvsSize();if(!o)throw new Error("Camera is not open.");const{width:u,height:_,objectFit:v}=o;if(u<=0||_<=0)throw new Error("Invalid dimension of video or image.");const C=document.createElement("canvas");if(C.width==u&&C.height==_||(C.width=u,C.height=_),C.style.objectFit=v,this._scanRegionOverlayContainer)this._scanRegionOverlayContainer.before(C);else if(this._cvsScanRegion)this._cvsScanRegion.before(C);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(C);else{if(!this._video)throw new Error("'_video' is lost.");this._video.after(C)}return C}_updateDrawingLayersSize(o){let u;if(u=o&&o.width&&o.height&&o.objectFit?{width:o.width,height:o.height,objectFit:o.objectFit}:this._calculateCvsSize(),!u)return;const{width:_,height:v,objectFit:C}=u;this._drawingLayersManager.setDimensions({width:_,height:v},{backstoreOnly:!0}),this._drawingLayersManager.setObjectFit(C)}_createDrawingLayer(o){this._layerBaseCvs||(this._layerBaseCvs=this._createDrawingLayerBaseCvs());const u=this._layerBaseCvs;return this._drawingLayersManager.createDrawingLayer(u,o)}createDrawingLayer(){return this._createDrawingLayer()}getDrawingLayer(o){return this._drawingLayersManager.getDrawingLayer(o)||([1,2,3].includes(o)?this._createDrawingLayer(o):null)}getDrawingLayers(){return this._drawingLayersManager.getDrawingLayers()}getSelectedDrawingItems(){return this._drawingLayersManager.getSelectedDrawingItems()}createDrawingStyle(o){return this._drawingLayersManager.createDrawingStyle(o)}getDrawingStyle(o){return this._drawingLayersManager.getDrawingStyle(o)}getDrawingStyles(){return this._drawingLayersManager.getDrawingStyles()}updateDrawingStyle(o,u){return this._drawingLayersManager.updateDrawingStyle(o,u)}clearDrawingLayers(){this._drawingLayersManager.clearDrawingLayers(),this._layerBaseCvs&&(this._layerBaseCvs.remove(),this._layerBaseCvs=null)}_createControler(){if(this._controler||(this._controler=new Oi(this)),this._controler)return this._controler}_destroyControler(){this._controler=null}setOriginalImage(o,u,_){if(!o||!u||!_)throw new Error("Invalid arguments");this._originalImageData={imageData:o,width:u,height:_};let v=this._cvsOriginalImage;v||(v=document.createElement("canvas"),v.style.position="absolute",v.style.width="100%",v.style.height="100%",v.style.left="0",v.style.top="0",v.style.backgroundColor="white",v.style.objectFit="contain",this._cvsOriginalImage=v),v.width===u&&v.height===_||(v.width=u,v.height=_);const C=v.getContext("2d");C.clearRect(0,0,v.width,v.height),o instanceof Uint8Array||o instanceof Uint8ClampedArray?(o instanceof Uint8Array&&(o=new Uint8ClampedArray(o)),C.putImageData(new ImageData(o,u,_),0,0)):o instanceof HTMLCanvasElement&&C.drawImage(o,0,0),document.body.contains(v)&&v.style.display===""&&this._updateDrawingLayersSize({width:u,height:_,objectFit:"contain"})}getOriginalImage(){return this._originalImageData?Object.assign({},this._originalImageData):null}deleteOriginalImage(){return Ce(this,void 0,void 0,function*(){yield this.hideOriginalImage(),this._cvsOriginalImage&&(this._cvsOriginalImage.remove(),this._cvsOriginalImage=null),this._originalImageData=null})}_showOriginalImageCvs(){this._cvsOriginalImage&&this._cvsOriginalImage.style.display=="none"&&(this._cvsOriginalImage.style.display="")}_hideOriginalImageCvs(){this._cvsOriginalImage&&(this._cvsOriginalImage.style.display="none")}showOriginalImage(){if(!this._originalImageData)throw new Error("No original image is set.");const o=this._cvsOriginalImage;if(o.style.display===""&&document.body.contains(o))return;const{width:u,height:_}=this._originalImageData;if(this._updateDrawingLayersSize({width:u,height:_,objectFit:"contain"}),this._bOpen&&(this._video&&!this._video.paused&&this._video.pause(),this._bFetchingLoopStarted&&(this.stopFetchingLoop(),this._recordedStates.fetchingLoopStart=!0),this.ifShowScanRegionMask&&this._cvsScanRegion&&(this._cvsScanRegion.style.display="none"),this.ifShowScanRegionLaser&&this._divScanLight&&(this._divScanLight.style.display="none"),this._cvsViewDecorator&&(this._cvsViewDecorator.style.display="none"),this._scanRegionOverlayContainer&&(this._scanRegionOverlayContainer.style.display="none"),this._selCam&&(this._selCam.parentElement.style.display="none")),!document.body.contains(o))if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(o);else{if(!this._video)throw new Error("'video' is null.");this._video.after(o)}this._showOriginalImageCvs()}_hideOriginalImage(o){return Ce(this,void 0,void 0,function*(){this._originalImageData&&this._cvsOriginalImage&&this._cvsOriginalImage.style.display!=="none"&&(this._updateDrawingLayersSize(),this._bOpen&&o&&(this._video&&this._recordedStates.videoPlaying&&(yield this.play(null,null,null,{notTriggerSingleFrameClick:!0})),this._recordedStates.fetchingLoopStart&&!this.singleFrameMode&&this.startFetchingLoop(),this.ifShowScanRegionMask&&this._cvsScanRegion&&this._recordedStates.maskShow&&this.showScanRegionMask(),this.ifShowScanRegionLaser&&this._divScanLight&&this._recordedStates.laserShow&&this.showScanRegionLaser(),this._cvsViewDecorator&&this._recordedStates.decoratorShow&&this.showViewDecorator(),this._scanRegionOverlayContainer&&this._recordedStates.overlayShow&&this.showScanRegionOverlays()),this._selCam&&(this._selCam.parentElement.style.display=""),this._hideOriginalImageCvs())})}hideOriginalImage(){return Ce(this,void 0,void 0,function*(){return this._hideOriginalImage(!0)})}dispose(o){this.UIElement&&(this._uiOriginalState&&this._uiOriginalState.inDom?this.UIElement.style.display=this._uiOriginalState.display:this.UIElement.style.display="none"),this.clearDrawingLayers(),this.close(),this.forceLoseContext(),this.setViewDecorator(null,null),this._scanRegionOverlayContainer&&this._scanRegionOverlayContainer.remove(),this._arrScanRegionOverlays.length=0,o&&this.UIElement&&this.UIElement.remove(),this.__proto__=null;for(let u in this)delete this[u];Object.defineProperty(this,"isCameraEnhancer",{value:!0}),Object.defineProperty(this,"isDisposed",{value:!0})}}fe._jsVersion="3.0.1",fe._jsEditVersion="20220803",fe._version="JS "+fe._jsVersion+"."+fe._jsEditVersion,fe.browserInfo=Ae,fe._hasEngineResourceLoaded=!1,fe._engineResourcePath=wi,fe._defaultUIElementURL="@engineResourcePath/dce.ui.html";const Ei={DT_Arc:class extends Me{constructor(f,o,u,_,v,C){super(new xe.Circle({left:f,top:o,radius:u,startAngle:_,endAngle:v}),C),this._mediaType="arc"}},DT_Polygon:class extends Me{constructor(f,o){super(new xe.Polygon(f,{objectCaching:!1}),o);const u=this._fabricObject;let _=u.points.length-1;u.controls=u.points.reduce(function(v,C,S){return v["p"+S]=new xe.Control({positionHandler:Tt,actionHandler:Et(S>0?S-1:_,Ot),actionName:"modifyPolygon",pointIndex:S}),v},{})}_extendSet(f,o){if(f==="vertices"){const u=this._fabricObject;u.points=o;const _=u.points.length-1;return u.controls=u.points.reduce(function(v,C,S){return v["p"+S]=new xe.Control({positionHandler:Tt,actionHandler:Et(S>0?S-1:_,Ot),actionName:"modifyPolygon",pointIndex:S}),v},{}),u._setPositionDimensions({}),!0}}_extendGet(f){if(f==="vertices"){const o=[],u=this._fabricObject;if(u.selectable)for(let _ in u.oCoords)o.push({x:u.oCoords[_].x,y:u.oCoords[_].y});else for(let _ in u.getCoords())o.push({x:u.getCoords()[_].x,y:u.getCoords()[_].y});return o}}},DT_Rect:class extends Me{constructor(f,o,u,_,v){super(new xe.Rect({left:f,top:o,width:u,height:_}),v)}},DT_Image:class extends Me{constructor(f,o,u,_){super(new xe.Image(f,{left:o,top:u}),_),this.image=f}_extendSet(f,o){if(f==="image"){if(o instanceof HTMLImageElement)return this._fabricObject.setElement(o),this.image=o,!0;if(o instanceof HTMLCanvasElement){const u=new Image;return u.src=o.toDataURL(),this._fabricObject.setElement(u),this.image=o,!0}throw new Error("Unsupported value.")}}_extendGet(f){if(f==="image")return this.image}},DT_Text:class extends Me{constructor(f,o,u,_){super(new xe.IText(f,{left:o,top:u}),_),this._mediaType="text"}},DT_Line:class extends Me{constructor(f,o,u){super(new xe.Line([f.x,f.y,o.x,o.y]),u)}_extendSet(f,o){return f==="startPoint"?(this._fabricObject.set("x1",o.x),this._fabricObject.set("y1",o.y),!0):f==="endPoint"?(this._fabricObject.set("x2",o.x),this._fabricObject.set("y2",o.y),!0):void 0}_extendGet(f){return f==="startPoint"?{x:this._fabricObject.get("x1"),y:this._fabricObject.get("y1")}:f==="endPoint"?{x:this._fabricObject.get("x2"),y:this._fabricObject.get("y2")}:void 0}},DT_Group:class extends Me{constructor(f){super(new xe.Group(f.map(u=>u._getFabricObject())));const o=this.mapEvents;this._fabricObject.onSelect=()=>{this.styleSelector="selected";const u=this.mapEvents.get("select");for(let v of u)v&&v.apply(this);const _=this._fabricObject._objects;for(let v of _)setTimeout(()=>{v.onSelect&&v.onSelect()},0);setTimeout(()=>{this._fabricObject&&this._fabricObject.canvas&&(this._fabricObject.dirty=!0,this._fabricObject.canvas.renderAll())},0)},this._fabricObject.onDeselect=()=>{this.styleSelector="default";const u=o.get("deselect");for(let v of u)v&&v.apply(this);const _=this._fabricObject._objects;for(let v of _)setTimeout(()=>{v.onDeselect&&v.onDeselect()},0);setTimeout(()=>{this._fabricObject&&this._fabricObject.canvas&&(this._fabricObject.dirty=!0,this._fabricObject.canvas.renderAll())},0)}}getChildItems(){return this._fabricObject._objects.map(f=>f.getDrawingItem())}addChildItem(f){if(!f||!f.isDrawingItem)throw TypeError("Illegal drawing item.");this._drawingLayer?this._drawingLayer._updateGroupItem(this,f,"add"):this._fabricObject.addWithUpdate(f._getFabricObject())}removeChildItem(f){f&&f.isDrawingItem&&(this._drawingLayer?this._drawingLayer._updateGroupItem(this,f,"remove"):this._fabricObject.removeWithUpdate(f._getFabricObject()))}}};class Ye extends Y{constructor(){super(),this._barcodeFillStyle="rgba(254,180,32,0.3)",this._barcodeStrokeStyle="rgba(254,180,32,0.9)",this._barcodeLineWidth=1,this.bFilterRegionInJs=!0,this._onCameraSelChange=()=>{},this._onResolutionSelChange=()=>{},this._onCloseBtnClick=()=>{},this._onPlayed=null}static get version(){return this._version+"(DCE ".concat(fe.getVersion(),")")}static _fireHTTPSWarnning(){Ye.onWarning&&location&&location.protocol!=="https:"&&setTimeout(()=>{Ye.onWarning&&Ye.onWarning({id:2,message:"Not connected via SSL (HTTPS), the SDK may not work correctly."})},0)}_fireResolutionWarning(){if(!this.singleFrameMode&&this.onWarning){const o=this.dce.getConstraints();o&&o.width<1280&&o.height<720&&setTimeout(()=>{this.onWarning&&this.onWarning({id:3,message:"Camera resolution too low, please use a higher resolution (720P or better)."})},0)}}getUIElement(){return this.dce.getUIElement()}async setUIElement(o){await this.dce.setUIElement(o)}get singleFrameMode(){return this.dce.singleFrameMode}set singleFrameMode(o){this.dce.singleFrameMode=o,o&&(this.dce.ifShowScanRegionLaser=!1,(async()=>{let u=await this.getScanSettings();u.oneDTrustFrameCount=1,await this.updateScanSettings(u)})())}get onUnduplicatedRead(){return this.onUniqueRead}set onUnduplicatedRead(o){this.onUniqueRead=o}get video(){return this.dce&&this.dce.video}set videoSrc(o){this.dce&&(this.dce.videoSrc=o)}get videoSrc(){return this.dce&&this.dce.videoSrc}_assertOpen(){if(!this.dce.isOpen())throw Error("The scanner is not open.")}set barcodeFillStyle(o){this._barcodeFillStyle=o,this.dce&&this.dce.updateDrawingStyle(3,{fillStyle:o})}get barcodeFillStyle(){return this._barcodeFillStyle}set barcodeStrokeStyle(o){this._barcodeStrokeStyle=o,this.dce&&this.dce.updateDrawingStyle(3,{strokeStyle:o})}get barcodeStrokeStyle(){return this._barcodeStrokeStyle}set barcodeLineWidth(o){this._barcodeLineWidth=o,this.dce&&this.dce.updateDrawingStyle(3,{lineWidth:o})}get barcodeLineWidth(){return this._barcodeLineWidth}set regionMaskFillStyle(o){this.dce.setScanRegionMaskStyle({fillStyle:o})}get regionMaskFillStyle(){return this.dce.regionMaskFillStyle}set regionMaskStrokeStyle(o){this.dce.setScanRegionMaskStyle({strokeStyle:o})}get regionMaskStrokeStyle(){return this.dce.regionMaskStrokeStyle}set regionMaskLineWidth(o){this.dce.setScanRegionMaskStyle({lineWidth:o})}get regionMaskLineWidth(){return this.dce.regionMaskLineWidth}set region(o){this._region=o,this.dce&&(o?o instanceof Array||this.dce.setScanRegion(o):this.dce.setScanRegion(null)),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0}get region(){return this._region}set ifSaveOriginalImageInACanvas(o){this._ifSaveOriginalImageInACanvas=o,this.dce.frameColorMode=o?"rgba":"grey"}get ifSaveOriginalImageInACanvas(){return this._ifSaveOriginalImageInACanvas}async createDCEInstance(){this.dce||(Y._onLog&&Y._onLog("createDCEInstance()"),fe.defaultUIElementURL=null,this.dce=await fe.createInstance(),this.dce.refreshInterval=200,this.dce.frameColorMode="grey",this.dce.maxCvsSideLength=this.maxCvsSideLength,this._drawingItemNamespace=Ei,Y.browserInfo.OS!=="iPhone"&&Y.browserInfo.OS!=="Android"&&Y.browserInfo.OS!=="HarmonyOS"&&this.dce.setResolution(1920,1080),this.barcodeLineWidth=this._barcodeLineWidth,this.dce.on("cameraChange",()=>{this._drawResults(null),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0}),this.dce.on("resolutionChange",()=>{this._drawResults(null),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0}),this.dce.on("cameraClose",()=>{this._drawResults(null),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0,this._bPauseScan=!1}),this.dce.on("singleFrameAcquired",async o=>{if(!o||!o.data)return;let u;this.ifSaveOriginalImageInACanvas&&(this.oriCanvas=null,this.oriCanvasData={width:o.width,height:o.height,colorMode:o.colorMode,data:new Uint8Array(o.data),toCanvas:o.toCanvas});const{data:_,sx:v,sy:C,width:S,height:x,colorMode:L,timeStamp:I,_sWidth:E,_sHeight:F}=o,M={timeStamp:I};if(L==="grey")u=await this._decodeBuffer_Uint8Array(_,S,x,S,Ee.IPF_GrayScaled,M);else if(L==="rgba")u=await this._decodeBuffer_Uint8Array(_,S,x,4*S,Ee.IPF_ABGR_8888,M);else{if(L!=="bgra")throw new Error("Color mode '".concat(L,"' is not supported."));u=await this._decodeBuffer_Uint8Array(_,S,x,4*S,Ee.IPF_ARGB_8888,M)}if(await this.clearMapDecodeRecord(),Y.recalculateResultLocation(u,v,C,E,F,S,x),this._drawResults(u),this.onFrameRead&&this.isOpen()&&!this._bPauseScan){let q=this._cloneDecodeResults(u);this.onFrameRead(q)}if(this.onUniqueRead&&this.isOpen()&&!this._bPauseScan)for(let q of u)this.onUniqueRead(q.barcodeText,this._cloneDecodeResults(q))}))}set maxCvsSideLength(o){this._maxCvsSideLength=o,this.dce.maxCvsSideLength=o}get maxCvsSideLength(){return this._maxCvsSideLength}static async createInstance(o){let u=new Ye;u._instanceID=await Ye.createInstanceInWorker(!0),await u.createDCEInstance(),typeof o=="string"&&(o=JSON.parse(o));for(let _ in o)u[_]=o[_];return await u.dce.setUIElement(Ye.defaultUIElementURL),u.singleFrameMode&&console.warn("The `navigator.mediaDevices.getUserMedia` is unavailable. automatically change to `singleFrameMode`."),Ye._fireHTTPSWarnning(),u.singleFrameMode||await u.updateRuntimeSettings("single"),u}async decodeCurrentFrame(o){this._assertOpen();let u=null;o&&o.region&&(u=o.region);const _=this.dce._getVideoFrame(u);return this._decode_DCEFrame(_)}async updateRuntimeSettings(o){let u;if(typeof o=="string")if(o=="speed"){let _=await this.getRuntimeSettings();await this.resetRuntimeSettings(),u=await this.getRuntimeSettings(),u.barcodeFormatIds=_.barcodeFormatIds,u.barcodeFormatIds_2=_.barcodeFormatIds_2,_.region&&(u.region=_.region),u.expectedBarcodesCount=0,u.localizationModes=[2,0,0,0,0,0,0,0],u.barcodeZoneMinDistanceToImageBorders=9}else if(o=="balance"){let _=await this.getRuntimeSettings();await this.resetRuntimeSettings(),u=await this.getRuntimeSettings(),u.barcodeFormatIds=_.barcodeFormatIds,u.barcodeFormatIds_2=_.barcodeFormatIds_2,_.region&&(u.region=_.region),u.expectedBarcodesCount=512,u.deblurLevel=3,u.localizationModes=[2,16,0,0,0,0,0,0],u.barcodeZoneMinDistanceToImageBorders=9,u.timeout=1e5}else if(o=="coverage"){let _=await this.getRuntimeSettings();await this.resetRuntimeSettings(),u=await this.getRuntimeSettings(),u.barcodeFormatIds=_.barcodeFormatIds,u.barcodeFormatIds_2=_.barcodeFormatIds_2,_.region&&(u.region=_.region),u.expectedBarcodesCount=512,u.deblurLevel=5,u.scaleDownThreshold=1e5,u.localizationModes=[2,16,4,8,0,0,0,0],u.barcodeZoneMinDistanceToImageBorders=9,u.timeout=1e5}else if(o=="single"){let _=await this.getRuntimeSettings();await this.resetRuntimeSettings(),u=await this.getRuntimeSettings(),u.barcodeFormatIds=_.barcodeFormatIds,u.barcodeFormatIds_2=_.barcodeFormatIds_2,_.region&&(u.region=_.region)}else if(o=="dense"){let _=await this.getRuntimeSettings();await this.resetRuntimeSettings(),this.maxCvsSideLength=4096,u=await this.getRuntimeSettings(),u.barcodeFormatIds=_.barcodeFormatIds,u.barcodeFormatIds_2=_.barcodeFormatIds_2,_.region&&(u.region=_.region),u.expectedBarcodesCount=0,u.deblurLevel=7,u.scaleDownThreshold=1e5,u.localizationModes=[2,8,0,0,0,0,0,0],u.minResultConfidence=0,u.barcodeZoneMinDistanceToImageBorders=9,u.timeout=1e5}else if(o=="distance"){let _=await this.getRuntimeSettings();await this.resetRuntimeSettings(),this.maxCvsSideLength=4096,u=await this.getRuntimeSettings(),u.barcodeFormatIds=_.barcodeFormatIds,u.barcodeFormatIds_2=_.barcodeFormatIds_2,_.region&&(u.region=_.region),u.expectedBarcodesCount=0,u.scaleDownThreshold=1e5,u.localizationModes=[2,8,0,0,0,0,0,0],u.barcodeZoneMinDistanceToImageBorders=9,u.timeout=1e5}else u=JSON.parse(o);else{if(typeof o!="object")throw TypeError("'UpdateRuntimeSettings(settings)': Type of 'settings' should be 'string' or 'PlainObject'.");if(u=JSON.parse(JSON.stringify(o)),u.region instanceof Array){let _=o.region;[_.regionLeft,_.regionTop,_.regionLeft,_.regionBottom,_.regionMeasuredByPercentage].some(v=>v!==void 0)&&(u.region={regionLeft:_.regionLeft||0,regionTop:_.regionTop||0,regionRight:_.regionRight||0,regionBottom:_.regionBottom||0,regionMeasuredByPercentage:_.regionMeasuredByPercentage||0})}}if(!Y._bUseFullFeature){if(u.barcodeFormatIds&~(He.BF_ONED|He.BF_QR_CODE|He.BF_PDF417|He.BF_DATAMATRIX)||u.barcodeFormatIds_2!=0)throw Error("Some of the specified barcode formats are not supported in the compact version. Please try the full-featured version.");if(u.intermediateResultTypes!=0)throw Error("Intermediate results is not supported in the compact version. Please try the full-featured version.")}{let _=u.region;if(this.bFilterRegionInJs?this.userDefinedRegion=JSON.parse(JSON.stringify(_)):this.userDefinedRegion=null,_ instanceof Array)if(_.length){for(let v=0;v<_.length;++v){let C=_[v];C&&((C.regionLeft||C.regionTop||C.regionRight||C.regionBottom||C.regionMeasuredByPercentage)&&(C.regionLeft||C.regionTop||C.regionRight!=100||C.regionBottom!=100||!C.regionMeasuredByPercentage)||(_[v]=null))}this.region=_}else this.region=null;else _&&(_.regionLeft||_.regionTop||_.regionRight||_.regionBottom||_.regionMeasuredByPercentage)&&(_.regionLeft||_.regionTop||_.regionRight!=100||_.regionBottom!=100||!_.regionMeasuredByPercentage)?this.region=_:this.region=null;this.bFilterRegionInJs&&(u.region={regionLeft:0,regionTop:0,regionRight:0,regionBottom:0,regionMeasuredByPercentage:0})}await new Promise((_,v)=>{let C=Y._nextTaskID++;Y._taskCallbackMap.set(C,S=>{if(S.success){try{this._handleRetJsonString(S.updateReturn)}catch(x){v(x)}return _()}{let x=new Error(S.message);return x.stack=S.stack+"\n"+x.stack,v(x)}}),Y._dbrWorker.postMessage({type:"updateRuntimeSettings",id:C,instanceID:this._instanceID,body:{settings:JSON.stringify(u)}})}),typeof o=="string"&&["speed","balance","coverage","dense","distance"].includes(o)&&(await this.setModeArgument("BinarizationModes",0,"EnableFillBinaryVacancy","1"),await this.setModeArgument("BinarizationModes",0,"BlockSizeX","0"),await this.setModeArgument("BinarizationModes",0,"BlockSizeY","0"))}_bindUI(){if(!this.getUIElement())throw new Error("Need to define `UIElement` before opening.");if(this.dce._bindUI(),!this.dce.video)throw this._unbindUI(),Error("Can not find the video container element with class 'dce-video-container'")}_unbindUI(){this.dce._unbindUI()}set onPlayed(o){this.dce.off("played",this._onPlayed),this._onPlayed=o,this.dce.on("played",this._onPlayed)}get onPlayed(){return this._onPlayed}async getAllCameras(){return this.dce.getAllCameras()}async getCurrentCamera(){return this.dce.getSelectedCamera()}async setCurrentCamera(o){const u=await this.dce.selectCamera(o);return this._fireResolutionWarning(),u}getResolution(){return this.dce.getResolution()}async setResolution(o,u){const _=await this.dce.setResolution(o,u);return this._fireResolutionWarning(),_}getVideoSettings(){return this.dce.getVideoSettings()}updateVideoSettings(o){return this.dce.updateVideoSettings(o)}isOpen(){return this.dce&&this.dce.isOpen()}setVideoFit(o){return this.dce&&this.dce.setVideoFit(o)}set ifShowScanRegionMask(o){this.dce&&(this.dce.ifShowScanRegionMask=o)}get ifShowScanRegionMask(){return this.dce&&this.dce.ifShowScanRegionMask}set ifSaveLastUsedCamera(o){this.dce&&(this.dce.ifSaveLastUsedCamera=o)}get ifSaveLastUsedCamera(){return this.dce&&this.dce.ifSaveLastUsedCamera}set ifSkipCameraInspection(o){this.dce&&(this.dce.ifSkipCameraInspection=o)}get ifSkipCameraInspection(){return this.dce&&this.dce.ifSkipCameraInspection}stop(){this._drawResults(null),this.dce.stop(),this.dce.ifShowScanRegionLaser=!1,this.dce.hideViewDecorator(),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0}pause(){this.dce.pause()}async play(o,u,_){this.dce.ifShowScanRegionLaser=!0;const v=await this.dce.play(o,u,_);return this._fireResolutionWarning(),v}pauseScan(o){this._assertOpen(),o&&o.keepResultsHighlighted||this._drawResults(null),this._bPauseScan=!0,this.dce.ifShowScanRegionLaser=!1,this.dce.stopFetchingLoop()}resumeScan(){this._assertOpen(),this._bPauseScan=!1,this.dce.ifShowScanRegionLaser=!0}getCapabilities(){return this.dce.getCapabilities()}getCameraSettings(){return this.dce.getCameraSettings()}getConstraints(){return this.dce.getConstraints()}async applyConstraints(o){return this.dce.applyConstraints(o)}async turnOnTorch(){return this.dce.turnOnTorch()}async turnOffTorch(){return this.dce.turnOffTorch()}async setColorTemperature(o){return this.dce.setColorTemperature(o)}async setExposureCompensation(o){return this.dce.setExposureCompensation(o)}async setZoom(o){return this.dce.setZoom(o)}async setFrameRate(o){return this.dce.setFrameRate(o)}getFrameRate(){return this.dce.getFrameRate()}async setFocus(o,u){return this.dce.setFocus(o,u)}getFocus(){return this.dce.getFocus()}async _loopReadVideo(){if(this.bDestroyed)return this.dce&&this.dce.stopFetchingLoop(),void this._drawResults(null);if(!this.isOpen())return this._drawResults(null),void await this.clearMapDecodeRecord();if(!this.dce.video||this.dce.video.paused||this._bPauseScan)return Y._onLog&&Y._onLog("Video or scan is paused. Ask in 1s."),await this.clearMapDecodeRecord(),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),void(this._loopReadVideoTimeoutId=setTimeout(()=>{this._loopReadVideo()},this._intervalDetectVideoPause));Y._onLog&&Y._onLog("======= once read ======="),Y._onLog&&(this._timeStartDecode=Date.now());const o=this._getVideoFrame();if(!o)return Y._onLog&&Y._onLog("Get invalid frame."),this._drawResults(null),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),void(this._loopReadVideoTimeoutId=setTimeout(()=>{this._loopReadVideo()},0));(async()=>{o._bUseWebGL||o.colorMode!=="grey"||(this.dce.frameColorMode="rgba");let u=[];this.ifSaveOriginalImageInACanvas&&(this.oriCanvas=null,this.oriCanvasData={width:o.width,height:o.height,colorMode:o.colorMode,data:new Uint8Array(o.data),toCanvas:o.toCanvas});const{data:_,sx:v,sy:C,width:S,height:x,colorMode:L,timeStamp:I,_sWidth:E,_sHeight:F}=o,M={timeStamp:I};if(L==="grey")u=await this._decodeBuffer_Uint8Array(_,S,x,S,Ee.IPF_GrayScaled,M);else if(L==="rgba")u=await this._decodeBuffer_Uint8Array(_,S,x,4*S,Ee.IPF_ABGR_8888,M);else{if(L!=="bgra")throw new Error("Color mode '".concat(L,"' is not supported."));u=await this._decodeBuffer_Uint8Array(_,S,x,4*S,Ee.IPF_ARGB_8888,M)}return Y.recalculateResultLocation(u,v,C,E,F,S,x),this._drawResults(u),u})().then(u=>{if(Y._onLog&&Y._onLog(u),this.captureAndDecodeInParallel){let _=this.array_decodeFrameTimeCost,v=this.array_getFrameTimeCost,C=this._indexCurrentDecodingFrame;const S=()=>{let x=0;if(this.region instanceof Array){let L=0,I=0;L=C+1>=this.region.length?0:C+1,I=L+1>=this.region.length?0:L+1,x=_[L]&&_[L].length&&v[I]&&v[I].length?Math.min(..._[L])-Math.max(...v[I]):0}else if(v&&v.length){let L=Math.min(..._),I=Math.max(...v);L&&I&&(x=L-I)}else x=0;return x>0?x:0};(()=>{if(this.region instanceof Array){for(_[C]&&_[C]instanceof Array||(_[C]=[]);_[C].length>=5;)_[C].shift();_[C].push(this._lastInnerDecodeDuration)}else{for(;_.length>=5;)_.shift();_.push(this._lastInnerDecodeDuration)}})(),this._intervalGetVideoFrame=S()+this.intervalTime,Y._onLog&&Y._onLog("Next fetching frame loop interval: "+this._intervalGetVideoFrame)}if(this.isOpen()&&this.dce.video&&!this.dce.video.paused&&!this._bPauseScan){if(this.bPlaySoundOnSuccessfulRead&&u.length){let _=!1;if(this.bPlaySoundOnSuccessfulRead===!0||this.bPlaySoundOnSuccessfulRead==="frame")_=!0;else if(this.bPlaySoundOnSuccessfulRead==="unique"){for(let v of u)if(v.resultState==0){_=!0;break}}_&&(this.beepSound.stop(),this.beepSound.play())}if(navigator.vibrate&&this.bVibrateOnSuccessfulRead&&u.length){let _=!1;if(this.bVibrateOnSuccessfulRead===!0||this.bVibrateOnSuccessfulRead==="frame")_=!0;else if(this.bVibrateOnSuccessfulRead==="unique"){for(let v of u)if(v.resultState==0){_=!0;break}}if(_)try{navigator.vibrate(this.vibrateDuration)}catch(v){console.warn("Vibration not allowed. User interaction required: "+(v.message||v))}}if(this.onFrameRead){let _=this._cloneDecodeResults(u);_.length===0&&this.onFrameRead([]);for(let v of _)v.resultState!=0&&v.resultState!=1||this.onFrameRead(_)}if(this.onUniqueRead)for(let _ of u)_.resultState==0&&this.onUniqueRead(_.barcodeText,this._cloneDecodeResults(_))}this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this.intervalTime?this._loopReadVideoTimeoutId=setTimeout(()=>{this._loopReadVideo()},this.intervalTime):this._loopReadVideo()}).catch(u=>{this.dce.stopFetchingLoop(),Y._onLog&&Y._onLog(u.message||u),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._loopReadVideoTimeoutId=setTimeout(()=>{this._loopReadVideo()},Math.max(this.intervalTime,1e3)),u.message=="platform error"||console.warn(u.message)})}_getVideoFrame(){if(!this.dce)return null;let o;if(this.captureAndDecodeInParallel){Y._onLog&&Y._onLog("Get frame in parallel.");let u=this.dce.isFetchingLoopStarted();if(this.dce.loopInterval=this._intervalGetVideoFrame,u||this.dce.startFetchingLoop(),!this.dce.numberOfFramesInBuffer)return this.dce.loopInterval=0,null;o=this.dce.getFrameFromBuffer(),(v=>{if(!v)return;let C=v.timeSpent,S=this.array_getFrameTimeCost;for(;S.length>=5;)S.shift();S.push(C)})(o)}else Y._onLog&&Y._onLog("Get frame in serial."),this.dce.stopFetchingLoop(),o=this.dce.getFrame();return o}async open(){this._bindUI();const o=await this.dce.open();return this._bPauseScan=!1,this.singleFrameMode||(this.dce&&(this.dce.ifShowScanRegionLaser=!0),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._loopReadVideoTimeoutId=setTimeout(()=>{this._loopReadVideo()},0)),this._fireResolutionWarning(),this.keepAlive(),o}async openVideo(){this._bindUI(),this.dce.ifShowScanRegionLaser=!1;const o=await this.dce.open();return this._bPauseScan=!0,this.singleFrameMode||(this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._loopReadVideoTimeoutId=setTimeout(()=>{this._loopReadVideo()},0)),this._fireResolutionWarning(),this.keepAlive(),o}close(){this.dce.close(),this._bPauseScan=!0,this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId)}async show(){this._bindUI();const o=await this.dce.open(!0);return this._bPauseScan=!1,this.singleFrameMode||(this.dce&&(this.dce.ifShowScanRegionLaser=!0),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._loopReadVideoTimeoutId=setTimeout(()=>{this._loopReadVideo()},0)),this._fireResolutionWarning(),this.keepAlive(),o}async showVideo(){this._bindUI(),this.dce.ifShowScanRegionLaser=!1;const o=await this.dce.open(!0);return this._bPauseScan=!0,this.singleFrameMode||(this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._loopReadVideoTimeoutId=setTimeout(()=>{this._loopReadVideo()},0)),this._fireResolutionWarning(),this.keepAlive(),o}hide(){this.dce.close(!0),this._bPauseScan=!0,this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId)}destroyContext(){this.close(),this.bDestroyed||super.destroyContext()}}var It,At,Dt,Rt,Mt,Lt,kt,Pt,Ft,Bt,jt,Nt,Vt,Ut,Wt,Gt,Ht,Xt,Yt,zt,qt,Jt,Kt,Qt,$t,Zt,ei;(function(f){f[f.BICM_DARK_ON_LIGHT=1]="BICM_DARK_ON_LIGHT",f[f.BICM_LIGHT_ON_DARK=2]="BICM_LIGHT_ON_DARK",f[f.BICM_DARK_ON_DARK=4]="BICM_DARK_ON_DARK",f[f.BICM_LIGHT_ON_LIGHT=8]="BICM_LIGHT_ON_LIGHT",f[f.BICM_DARK_LIGHT_MIXED=16]="BICM_DARK_LIGHT_MIXED",f[f.BICM_DARK_ON_LIGHT_DARK_SURROUNDING=32]="BICM_DARK_ON_LIGHT_DARK_SURROUNDING",f[f.BICM_SKIP=0]="BICM_SKIP",f[f.BICM_REV=2147483648]="BICM_REV"})(It||(It={})),function(f){f[f.BCM_AUTO=1]="BCM_AUTO",f[f.BCM_GENERAL=2]="BCM_GENERAL",f[f.BCM_SKIP=0]="BCM_SKIP",f[f.BCM_REV=2147483648]="BCM_REV"}(At||(At={})),function(f){f[f.BF2_NULL=0]="BF2_NULL",f[f.BF2_POSTALCODE=32505856]="BF2_POSTALCODE",f[f.BF2_NONSTANDARD_BARCODE=1]="BF2_NONSTANDARD_BARCODE",f[f.BF2_USPSINTELLIGENTMAIL=1048576]="BF2_USPSINTELLIGENTMAIL",f[f.BF2_POSTNET=2097152]="BF2_POSTNET",f[f.BF2_PLANET=4194304]="BF2_PLANET",f[f.BF2_AUSTRALIANPOST=8388608]="BF2_AUSTRALIANPOST",f[f.BF2_RM4SCC=16777216]="BF2_RM4SCC",f[f.BF2_DOTCODE=2]="BF2_DOTCODE",f[f.BF2_PHARMACODE_ONE_TRACK=4]="BF2_PHARMACODE_ONE_TRACK",f[f.BF2_PHARMACODE_TWO_TRACK=8]="BF2_PHARMACODE_TWO_TRACK",f[f.BF2_PHARMACODE=12]="BF2_PHARMACODE"}(Dt||(Dt={})),function(f){f[f.BM_AUTO=1]="BM_AUTO",f[f.BM_LOCAL_BLOCK=2]="BM_LOCAL_BLOCK",f[f.BM_SKIP=0]="BM_SKIP",f[f.BM_THRESHOLD=4]="BM_THRESHOLD",f[f.BM_REV=2147483648]="BM_REV"}(Rt||(Rt={})),function(f){f[f.ECCM_CONTRAST=1]="ECCM_CONTRAST"}(Mt||(Mt={})),function(f){f[f.CFM_GENERAL=1]="CFM_GENERAL"}(Lt||(Lt={})),function(f){f[f.CCM_AUTO=1]="CCM_AUTO",f[f.CCM_GENERAL_HSV=2]="CCM_GENERAL_HSV",f[f.CCM_SKIP=0]="CCM_SKIP",f[f.CCM_REV=2147483648]="CCM_REV"}(kt||(kt={})),function(f){f[f.CICM_GENERAL=1]="CICM_GENERAL",f[f.CICM_SKIP=0]="CICM_SKIP",f[f.CICM_REV=2147483648]="CICM_REV"}(Pt||(Pt={})),function(f){f[f.CM_IGNORE=1]="CM_IGNORE",f[f.CM_OVERWRITE=2]="CM_OVERWRITE"}(Ft||(Ft={})),function(f){f[f.DM_SKIP=0]="DM_SKIP",f[f.DM_DIRECT_BINARIZATION=1]="DM_DIRECT_BINARIZATION",f[f.DM_THRESHOLD_BINARIZATION=2]="DM_THRESHOLD_BINARIZATION",f[f.DM_GRAY_EQUALIZATION=4]="DM_GRAY_EQUALIZATION",f[f.DM_SMOOTHING=8]="DM_SMOOTHING",f[f.DM_MORPHING=16]="DM_MORPHING",f[f.DM_DEEP_ANALYSIS=32]="DM_DEEP_ANALYSIS",f[f.DM_SHARPENING=64]="DM_SHARPENING",f[f.DM_BASED_ON_LOC_BIN=128]="DM_BASED_ON_LOC_BIN",f[f.DM_SHARPENING_SMOOTHING=256]="DM_SHARPENING_SMOOTHING"}(Bt||(Bt={})),function(f){f[f.DRM_AUTO=1]="DRM_AUTO",f[f.DRM_GENERAL=2]="DRM_GENERAL",f[f.DRM_BROAD_WARP=4]="DRM_BROAD_WARP",f[f.DRM_LOCAL_REFERENCE=8]="DRM_LOCAL_REFERENCE",f[f.DRM_DEWRINKLE=16]="DRM_DEWRINKLE",f[f.DRM_SKIP=0]="DRM_SKIP",f[f.DRM_REV=2147483648]="DRM_REV"}(jt||(jt={})),function(f){f[f.DPMCRM_AUTO=1]="DPMCRM_AUTO",f[f.DPMCRM_GENERAL=2]="DPMCRM_GENERAL",f[f.DPMCRM_SKIP=0]="DPMCRM_SKIP",f[f.DPMCRM_REV=2147483648]="DPMCRM_REV"}(Nt||(Nt={})),function(f){f[f.GTM_INVERTED=1]="GTM_INVERTED",f[f.GTM_ORIGINAL=2]="GTM_ORIGINAL",f[f.GTM_SKIP=0]="GTM_SKIP",f[f.GTM_REV=2147483648]="GTM_REV"}(Vt||(Vt={})),function(f){f[f.IPM_AUTO=1]="IPM_AUTO",f[f.IPM_GENERAL=2]="IPM_GENERAL",f[f.IPM_GRAY_EQUALIZE=4]="IPM_GRAY_EQUALIZE",f[f.IPM_GRAY_SMOOTH=8]="IPM_GRAY_SMOOTH",f[f.IPM_SHARPEN_SMOOTH=16]="IPM_SHARPEN_SMOOTH",f[f.IPM_MORPHOLOGY=32]="IPM_MORPHOLOGY",f[f.IPM_SKIP=0]="IPM_SKIP",f[f.IPM_REV=2147483648]="IPM_REV"}(Ut||(Ut={})),function(f){f[f.IRSM_MEMORY=1]="IRSM_MEMORY",f[f.IRSM_FILESYSTEM=2]="IRSM_FILESYSTEM",f[f.IRSM_BOTH=4]="IRSM_BOTH"}(Wt||(Wt={})),function(f){f[f.IRT_NO_RESULT=0]="IRT_NO_RESULT",f[f.IRT_ORIGINAL_IMAGE=1]="IRT_ORIGINAL_IMAGE",f[f.IRT_COLOUR_CLUSTERED_IMAGE=2]="IRT_COLOUR_CLUSTERED_IMAGE",f[f.IRT_COLOUR_CONVERTED_GRAYSCALE_IMAGE=4]="IRT_COLOUR_CONVERTED_GRAYSCALE_IMAGE",f[f.IRT_TRANSFORMED_GRAYSCALE_IMAGE=8]="IRT_TRANSFORMED_GRAYSCALE_IMAGE",f[f.IRT_PREDETECTED_REGION=16]="IRT_PREDETECTED_REGION",f[f.IRT_PREPROCESSED_IMAGE=32]="IRT_PREPROCESSED_IMAGE",f[f.IRT_BINARIZED_IMAGE=64]="IRT_BINARIZED_IMAGE",f[f.IRT_TEXT_ZONE=128]="IRT_TEXT_ZONE",f[f.IRT_CONTOUR=256]="IRT_CONTOUR",f[f.IRT_LINE_SEGMENT=512]="IRT_LINE_SEGMENT",f[f.IRT_FORM=1024]="IRT_FORM",f[f.IRT_SEGMENTATION_BLOCK=2048]="IRT_SEGMENTATION_BLOCK",f[f.IRT_TYPED_BARCODE_ZONE=4096]="IRT_TYPED_BARCODE_ZONE",f[f.IRT_PREDETECTED_QUADRILATERAL=8192]="IRT_PREDETECTED_QUADRILATERAL"}(Gt||(Gt={})),function(f){f[f.LM_SKIP=0]="LM_SKIP",f[f.LM_AUTO=1]="LM_AUTO",f[f.LM_CONNECTED_BLOCKS=2]="LM_CONNECTED_BLOCKS",f[f.LM_LINES=8]="LM_LINES",f[f.LM_STATISTICS=4]="LM_STATISTICS",f[f.LM_SCAN_DIRECTLY=16]="LM_SCAN_DIRECTLY",f[f.LM_STATISTICS_MARKS=32]="LM_STATISTICS_MARKS",f[f.LM_STATISTICS_POSTAL_CODE=64]="LM_STATISTICS_POSTAL_CODE",f[f.LM_CENTRE=128]="LM_CENTRE",f[f.LM_ONED_FAST_SCAN=256]="LM_ONED_FAST_SCAN",f[f.LM_REV=2147483648]="LM_REV"}(Ht||(Ht={})),function(f){f[f.PDFRM_RASTER=1]="PDFRM_RASTER",f[f.PDFRM_AUTO=2]="PDFRM_AUTO",f[f.PDFRM_VECTOR=4]="PDFRM_VECTOR",f[f.PDFRM_REV=2147483648]="PDFRM_REV"}(Xt||(Xt={})),function(f){f[f.QRECL_ERROR_CORRECTION_H=0]="QRECL_ERROR_CORRECTION_H",f[f.QRECL_ERROR_CORRECTION_L=1]="QRECL_ERROR_CORRECTION_L",f[f.QRECL_ERROR_CORRECTION_M=2]="QRECL_ERROR_CORRECTION_M",f[f.QRECL_ERROR_CORRECTION_Q=3]="QRECL_ERROR_CORRECTION_Q"}(Yt||(Yt={})),function(f){f[f.RPM_AUTO=1]="RPM_AUTO",f[f.RPM_GENERAL=2]="RPM_GENERAL",f[f.RPM_GENERAL_RGB_CONTRAST=4]="RPM_GENERAL_RGB_CONTRAST",f[f.RPM_GENERAL_GRAY_CONTRAST=8]="RPM_GENERAL_GRAY_CONTRAST",f[f.RPM_GENERAL_HSV_CONTRAST=16]="RPM_GENERAL_HSV_CONTRAST",f[f.RPM_SKIP=0]="RPM_SKIP",f[f.RPM_REV=2147483648]="RPM_REV"}(zt||(zt={})),function(f){f[f.RCT_PIXEL=1]="RCT_PIXEL",f[f.RCT_PERCENTAGE=2]="RCT_PERCENTAGE"}(qt||(qt={})),function(f){f[f.RT_STANDARD_TEXT=0]="RT_STANDARD_TEXT",f[f.RT_RAW_TEXT=1]="RT_RAW_TEXT",f[f.RT_CANDIDATE_TEXT=2]="RT_CANDIDATE_TEXT",f[f.RT_PARTIAL_TEXT=3]="RT_PARTIAL_TEXT"}(Jt||(Jt={})),function(f){f[f.SUM_AUTO=1]="SUM_AUTO",f[f.SUM_LINEAR_INTERPOLATION=2]="SUM_LINEAR_INTERPOLATION",f[f.SUM_NEAREST_NEIGHBOUR_INTERPOLATION=4]="SUM_NEAREST_NEIGHBOUR_INTERPOLATION",f[f.SUM_SKIP=0]="SUM_SKIP",f[f.SUM_REV=2147483648]="SUM_REV"}(Kt||(Kt={})),function(f){f[f.TP_REGION_PREDETECTED=1]="TP_REGION_PREDETECTED",f[f.TP_IMAGE_PREPROCESSED=2]="TP_IMAGE_PREPROCESSED",f[f.TP_IMAGE_BINARIZED=4]="TP_IMAGE_BINARIZED",f[f.TP_BARCODE_LOCALIZED=8]="TP_BARCODE_LOCALIZED",f[f.TP_BARCODE_TYPE_DETERMINED=16]="TP_BARCODE_TYPE_DETERMINED",f[f.TP_BARCODE_RECOGNIZED=32]="TP_BARCODE_RECOGNIZED"}(Qt||(Qt={})),function(f){f[f.TFM_AUTO=1]="TFM_AUTO",f[f.TFM_GENERAL_CONTOUR=2]="TFM_GENERAL_CONTOUR",f[f.TFM_SKIP=0]="TFM_SKIP",f[f.TFM_REV=2147483648]="TFM_REV"}($t||($t={})),function(f){f[f.TROM_CONFIDENCE=1]="TROM_CONFIDENCE",f[f.TROM_POSITION=2]="TROM_POSITION",f[f.TROM_FORMAT=4]="TROM_FORMAT",f[f.TROM_SKIP=0]="TROM_SKIP",f[f.TROM_REV=2147483648]="TROM_REV"}(Zt||(Zt={})),function(f){f[f.TDM_AUTO=1]="TDM_AUTO",f[f.TDM_GENERAL_WIDTH_CONCENTRATION=2]="TDM_GENERAL_WIDTH_CONCENTRATION",f[f.TDM_SKIP=0]="TDM_SKIP",f[f.TDM_REV=2147483648]="TDM_REV"}(ei||(ei={}));/*! For license information please see fabric.js.LICENSE.txt */var Ii={653:(f,o,u)=>{var _,v,C,S,x,L,I,E,F,M,q,se,K,J,le,ue,$,pe,_e,Se,be,g=g||{version:"5.2.1"};if(o.fabric=g,typeof document<"u"&&typeof window<"u")document instanceof(typeof HTMLDocument<"u"?HTMLDocument:Document)?g.document=document:g.document=document.implementation.createHTMLDocument(""),g.window=window;else{var ye=new(u(192)).JSDOM(decodeURIComponent("%3C!DOCTYPE%20html%3E%3Chtml%3E%3Chead%3E%3C%2Fhead%3E%3Cbody%3E%3C%2Fbody%3E%3C%2Fhtml%3E"),{features:{FetchExternalResources:["img"]},resources:"usable"}).window;g.document=ye.document,g.jsdomImplForWrapper=u(898).implForWrapper,g.nodeCanvas=u(245).Canvas,g.window=ye,DOMParser=g.window.DOMParser}function oe(r,i){var n=r.canvas,a=i.targetCanvas,e=a.getContext("2d");e.translate(0,a.height),e.scale(1,-1);var t=n.height-a.height;e.drawImage(n,0,t,a.width,a.height,0,0,a.width,a.height)}function he(r,i){var n=i.targetCanvas.getContext("2d"),a=i.destinationWidth,e=i.destinationHeight,t=a*e*4,s=new Uint8Array(this.imageBuffer,0,t),c=new Uint8ClampedArray(this.imageBuffer,0,t);r.readPixels(0,0,a,e,r.RGBA,r.UNSIGNED_BYTE,s);var h=new ImageData(c,a,e);n.putImageData(h,0,0)}g.isTouchSupported="ontouchstart"in g.window||"ontouchstart"in g.document||g.window&&g.window.navigator&&g.window.navigator.maxTouchPoints>0,g.isLikelyNode=typeof Buffer<"u"&&typeof window>"u",g.SHARED_ATTRIBUTES=["display","transform","fill","fill-opacity","fill-rule","opacity","stroke","stroke-dasharray","stroke-linecap","stroke-dashoffset","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","vector-effect","instantiated_by_use","clip-path"],g.DPI=96,g.reNum="(?:[-+]?(?:\\d+|\\d*\\.\\d+)(?:[eE][-+]?\\d+)?)",g.commaWsp="(?:\\s+,?\\s*|,\\s*)",g.rePathCommand=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:[eE][-+]?\d+)?)/gi,g.reNonWord=/[ \n\.,;!\?\-]/,g.fontPaths={},g.iMatrix=[1,0,0,1,0,0],g.svgNS="http://www.w3.org/2000/svg",g.perfLimitSizeTotal=2097152,g.maxCacheSideLimit=4096,g.minCacheSideLimit=256,g.charWidthsCache={},g.textureSize=2048,g.disableStyleCopyPaste=!1,g.enableGLFiltering=!0,g.devicePixelRatio=g.window.devicePixelRatio||g.window.webkitDevicePixelRatio||g.window.mozDevicePixelRatio||1,g.browserShadowBlurConstant=1,g.arcToSegmentsCache={},g.boundsOfCurveCache={},g.cachesBoundsOfCurve=!0,g.forceGLPutImageData=!1,g.initFilterBackend=function(){return g.enableGLFiltering&&g.isWebglSupported&&g.isWebglSupported(g.textureSize)?(console.log("max texture size: "+g.maxTextureSize),new g.WebglFilterBackend({tileSize:g.textureSize})):g.Canvas2dFilterBackend?new g.Canvas2dFilterBackend:void 0},typeof document<"u"&&typeof window<"u"&&(window.fabric=g),function(){function r(n,a){if(this.__eventListeners[n]){var e=this.__eventListeners[n];a?e[e.indexOf(a)]=!1:g.util.array.fill(e,!1)}}function i(n,a){var e=(function(){a.apply(this,arguments),this.off(n,e)}).bind(this);this.on(n,e)}g.Observable={fire:function(n,a){if(!this.__eventListeners)return this;var e=this.__eventListeners[n];if(!e)return this;for(var t=0,s=e.length;t<s;t++)e[t]&&e[t].call(this,a||{});return this.__eventListeners[n]=e.filter(function(c){return c!==!1}),this},on:function(n,a){if(this.__eventListeners||(this.__eventListeners={}),arguments.length===1)for(var e in n)this.on(e,n[e]);else this.__eventListeners[n]||(this.__eventListeners[n]=[]),this.__eventListeners[n].push(a);return this},once:function(n,a){if(arguments.length===1)for(var e in n)i.call(this,e,n[e]);else i.call(this,n,a);return this},off:function(n,a){if(!this.__eventListeners)return this;if(arguments.length===0)for(n in this.__eventListeners)r.call(this,n);else if(arguments.length===1&&typeof arguments[0]=="object")for(var e in n)r.call(this,e,n[e]);else r.call(this,n,a);return this}}}(),g.Collection={_objects:[],add:function(){if(this._objects.push.apply(this._objects,arguments),this._onObjectAdded)for(var r=0,i=arguments.length;r<i;r++)this._onObjectAdded(arguments[r]);return this.renderOnAddRemove&&this.requestRenderAll(),this},insertAt:function(r,i,n){var a=this._objects;return n?a[i]=r:a.splice(i,0,r),this._onObjectAdded&&this._onObjectAdded(r),this.renderOnAddRemove&&this.requestRenderAll(),this},remove:function(){for(var r,i=this._objects,n=!1,a=0,e=arguments.length;a<e;a++)(r=i.indexOf(arguments[a]))!==-1&&(n=!0,i.splice(r,1),this._onObjectRemoved&&this._onObjectRemoved(arguments[a]));return this.renderOnAddRemove&&n&&this.requestRenderAll(),this},forEachObject:function(r,i){for(var n=this.getObjects(),a=0,e=n.length;a<e;a++)r.call(i,n[a],a,n);return this},getObjects:function(r){return r===void 0?this._objects.concat():this._objects.filter(function(i){return i.type===r})},item:function(r){return this._objects[r]},isEmpty:function(){return this._objects.length===0},size:function(){return this._objects.length},contains:function(r,i){return this._objects.indexOf(r)>-1||!!i&&this._objects.some(function(n){return typeof n.contains=="function"&&n.contains(r,!0)})},complexity:function(){return this._objects.reduce(function(r,i){return r+(i.complexity?i.complexity():0)},0)}},g.CommonMethods={_setOptions:function(r){for(var i in r)this.set(i,r[i])},_initGradient:function(r,i){!r||!r.colorStops||r instanceof g.Gradient||this.set(i,new g.Gradient(r))},_initPattern:function(r,i,n){!r||!r.source||r instanceof g.Pattern?n&&n():this.set(i,new g.Pattern(r,n))},_setObject:function(r){for(var i in r)this._set(i,r[i])},set:function(r,i){return typeof r=="object"?this._setObject(r):this._set(r,i),this},_set:function(r,i){this[r]=i},toggle:function(r){var i=this.get(r);return typeof i=="boolean"&&this.set(r,!i),this},get:function(r){return this[r]}},_=o,v=Math.sqrt,C=Math.atan2,S=Math.pow,x=Math.PI/180,L=Math.PI/2,g.util={cos:function(r){if(r===0)return 1;switch(r<0&&(r=-r),r/L){case 1:case 3:return 0;case 2:return-1}return Math.cos(r)},sin:function(r){if(r===0)return 0;var i=1;switch(r<0&&(i=-1),r/L){case 1:return i;case 2:return 0;case 3:return-i}return Math.sin(r)},removeFromArray:function(r,i){var n=r.indexOf(i);return n!==-1&&r.splice(n,1),r},getRandomInt:function(r,i){return Math.floor(Math.random()*(i-r+1))+r},degreesToRadians:function(r){return r*x},radiansToDegrees:function(r){return r/x},rotatePoint:function(r,i,n){var a=new g.Point(r.x-i.x,r.y-i.y),e=g.util.rotateVector(a,n);return new g.Point(e.x,e.y).addEquals(i)},rotateVector:function(r,i){var n=g.util.sin(i),a=g.util.cos(i);return{x:r.x*a-r.y*n,y:r.x*n+r.y*a}},createVector:function(r,i){return new g.Point(i.x-r.x,i.y-r.y)},calcAngleBetweenVectors:function(r,i){return Math.acos((r.x*i.x+r.y*i.y)/(Math.hypot(r.x,r.y)*Math.hypot(i.x,i.y)))},getHatVector:function(r){return new g.Point(r.x,r.y).multiply(1/Math.hypot(r.x,r.y))},getBisector:function(r,i,n){var a=g.util.createVector(r,i),e=g.util.createVector(r,n),t=g.util.calcAngleBetweenVectors(a,e),s=t*(g.util.calcAngleBetweenVectors(g.util.rotateVector(a,t),e)===0?1:-1)/2;return{vector:g.util.getHatVector(g.util.rotateVector(a,s)),angle:t}},projectStrokeOnPoints:function(r,i,n){var a=[],e=i.strokeWidth/2,t=i.strokeUniform?new g.Point(1/i.scaleX,1/i.scaleY):new g.Point(1,1),s=function(c){var h=e/Math.hypot(c.x,c.y);return new g.Point(c.x*h*t.x,c.y*h*t.y)};return r.length<=1||r.forEach(function(c,h){var l,d,p=new g.Point(c.x,c.y);h===0?(d=r[h+1],l=n?s(g.util.createVector(d,p)).addEquals(p):r[r.length-1]):h===r.length-1?(l=r[h-1],d=n?s(g.util.createVector(l,p)).addEquals(p):r[0]):(l=r[h-1],d=r[h+1]);var m,b,y=g.util.getBisector(p,l,d),w=y.vector,T=y.angle;if(i.strokeLineJoin==="miter"&&(m=-e/Math.sin(T/2),b=new g.Point(w.x*m*t.x,w.y*m*t.y),Math.hypot(b.x,b.y)/e<=i.strokeMiterLimit))return a.push(p.add(b)),void a.push(p.subtract(b));m=-e*Math.SQRT2,b=new g.Point(w.x*m*t.x,w.y*m*t.y),a.push(p.add(b)),a.push(p.subtract(b))}),a},transformPoint:function(r,i,n){return n?new g.Point(i[0]*r.x+i[2]*r.y,i[1]*r.x+i[3]*r.y):new g.Point(i[0]*r.x+i[2]*r.y+i[4],i[1]*r.x+i[3]*r.y+i[5])},makeBoundingBoxFromPoints:function(r,i){if(i)for(var n=0;n<r.length;n++)r[n]=g.util.transformPoint(r[n],i);var a=[r[0].x,r[1].x,r[2].x,r[3].x],e=g.util.array.min(a),t=g.util.array.max(a)-e,s=[r[0].y,r[1].y,r[2].y,r[3].y],c=g.util.array.min(s);return{left:e,top:c,width:t,height:g.util.array.max(s)-c}},invertTransform:function(r){var i=1/(r[0]*r[3]-r[1]*r[2]),n=[i*r[3],-i*r[1],-i*r[2],i*r[0]],a=g.util.transformPoint({x:r[4],y:r[5]},n,!0);return n[4]=-a.x,n[5]=-a.y,n},toFixed:function(r,i){return parseFloat(Number(r).toFixed(i))},parseUnit:function(r,i){var n=/\D{0,2}$/.exec(r),a=parseFloat(r);switch(i||(i=g.Text.DEFAULT_SVG_FONT_SIZE),n[0]){case"mm":return a*g.DPI/25.4;case"cm":return a*g.DPI/2.54;case"in":return a*g.DPI;case"pt":return a*g.DPI/72;case"pc":return a*g.DPI/72*12;case"em":return a*i;default:return a}},falseFunction:function(){return!1},getKlass:function(r,i){return r=g.util.string.camelize(r.charAt(0).toUpperCase()+r.slice(1)),g.util.resolveNamespace(i)[r]},getSvgAttributes:function(r){var i=["instantiated_by_use","style","id","class"];switch(r){case"linearGradient":i=i.concat(["x1","y1","x2","y2","gradientUnits","gradientTransform"]);break;case"radialGradient":i=i.concat(["gradientUnits","gradientTransform","cx","cy","r","fx","fy","fr"]);break;case"stop":i=i.concat(["offset","stop-color","stop-opacity"])}return i},resolveNamespace:function(r){if(!r)return g;var i,n=r.split("."),a=n.length,e=_||g.window;for(i=0;i<a;++i)e=e[n[i]];return e},loadImage:function(r,i,n,a){if(r){var e=g.util.createImage(),t=function(){i&&i.call(n,e,!1),e=e.onload=e.onerror=null};e.onload=t,e.onerror=function(){g.log("Error loading "+e.src),i&&i.call(n,null,!0),e=e.onload=e.onerror=null},r.indexOf("data")!==0&&a!=null&&(e.crossOrigin=a),r.substring(0,14)==="data:image/svg"&&(e.onload=null,g.util.loadImageInDom(e,t)),e.src=r}else i&&i.call(n,r)},loadImageInDom:function(r,i){var n=g.document.createElement("div");n.style.width=n.style.height="1px",n.style.left=n.style.top="-100%",n.style.position="absolute",n.appendChild(r),g.document.querySelector("body").appendChild(n),r.onload=function(){i(),n.parentNode.removeChild(n),n=null}},enlivenObjects:function(r,i,n,a){var e=[],t=0,s=(r=r||[]).length;function c(){++t===s&&i&&i(e.filter(function(h){return h}))}s?r.forEach(function(h,l){h&&h.type?g.util.getKlass(h.type,n).fromObject(h,function(d,p){p||(e[l]=d),a&&a(h,d,p),c()}):c()}):i&&i(e)},enlivenObjectEnlivables:function(r,i,n){var a=g.Object.ENLIVEN_PROPS.filter(function(e){return!!r[e]});g.util.enlivenObjects(a.map(function(e){return r[e]}),function(e){var t={};a.forEach(function(s,c){t[s]=e[c],i&&(i[s]=e[c])}),n&&n(t)})},enlivenPatterns:function(r,i){function n(){++e===t&&i&&i(a)}var a=[],e=0,t=(r=r||[]).length;t?r.forEach(function(s,c){s&&s.source?new g.Pattern(s,function(h){a[c]=h,n()}):(a[c]=s,n())}):i&&i(a)},groupSVGElements:function(r,i,n){var a;return r&&r.length===1?r[0]:(i&&(i.width&&i.height?i.centerPoint={x:i.width/2,y:i.height/2}:(delete i.width,delete i.height)),a=new g.Group(r,i),n!==void 0&&(a.sourcePath=n),a)},populateWithProperties:function(r,i,n){if(n&&Array.isArray(n))for(var a=0,e=n.length;a<e;a++)n[a]in r&&(i[n[a]]=r[n[a]])},createCanvasElement:function(){return g.document.createElement("canvas")},copyCanvasElement:function(r){var i=g.util.createCanvasElement();return i.width=r.width,i.height=r.height,i.getContext("2d").drawImage(r,0,0),i},toDataURL:function(r,i,n){return r.toDataURL("image/"+i,n)},createImage:function(){return g.document.createElement("img")},multiplyTransformMatrices:function(r,i,n){return[r[0]*i[0]+r[2]*i[1],r[1]*i[0]+r[3]*i[1],r[0]*i[2]+r[2]*i[3],r[1]*i[2]+r[3]*i[3],n?0:r[0]*i[4]+r[2]*i[5]+r[4],n?0:r[1]*i[4]+r[3]*i[5]+r[5]]},qrDecompose:function(r){var i=C(r[1],r[0]),n=S(r[0],2)+S(r[1],2),a=v(n),e=(r[0]*r[3]-r[2]*r[1])/a,t=C(r[0]*r[2]+r[1]*r[3],n);return{angle:i/x,scaleX:a,scaleY:e,skewX:t/x,skewY:0,translateX:r[4],translateY:r[5]}},calcRotateMatrix:function(r){if(!r.angle)return g.iMatrix.concat();var i=g.util.degreesToRadians(r.angle),n=g.util.cos(i),a=g.util.sin(i);return[n,a,-a,n,0,0]},calcDimensionsMatrix:function(r){var i=r.scaleX===void 0?1:r.scaleX,n=r.scaleY===void 0?1:r.scaleY,a=[r.flipX?-i:i,0,0,r.flipY?-n:n,0,0],e=g.util.multiplyTransformMatrices,t=g.util.degreesToRadians;return r.skewX&&(a=e(a,[1,0,Math.tan(t(r.skewX)),1],!0)),r.skewY&&(a=e(a,[1,Math.tan(t(r.skewY)),0,1],!0)),a},composeMatrix:function(r){var i=[1,0,0,1,r.translateX||0,r.translateY||0],n=g.util.multiplyTransformMatrices;return r.angle&&(i=n(i,g.util.calcRotateMatrix(r))),(r.scaleX!==1||r.scaleY!==1||r.skewX||r.skewY||r.flipX||r.flipY)&&(i=n(i,g.util.calcDimensionsMatrix(r))),i},resetObjectTransform:function(r){r.scaleX=1,r.scaleY=1,r.skewX=0,r.skewY=0,r.flipX=!1,r.flipY=!1,r.rotate(0)},saveObjectTransform:function(r){return{scaleX:r.scaleX,scaleY:r.scaleY,skewX:r.skewX,skewY:r.skewY,angle:r.angle,left:r.left,flipX:r.flipX,flipY:r.flipY,top:r.top}},isTransparent:function(r,i,n,a){a>0&&(i>a?i-=a:i=0,n>a?n-=a:n=0);var e,t=!0,s=r.getImageData(i,n,2*a||1,2*a||1),c=s.data.length;for(e=3;e<c&&(t=s.data[e]<=0)!=0;e+=4);return s=null,t},parsePreserveAspectRatioAttribute:function(r){var i,n="meet",a=r.split(" ");return a&&a.length&&((n=a.pop())!=="meet"&&n!=="slice"?(i=n,n="meet"):a.length&&(i=a.pop())),{meetOrSlice:n,alignX:i!=="none"?i.slice(1,4):"none",alignY:i!=="none"?i.slice(5,8):"none"}},clearFabricFontCache:function(r){(r=(r||"").toLowerCase())?g.charWidthsCache[r]&&delete g.charWidthsCache[r]:g.charWidthsCache={}},limitDimsByArea:function(r,i){var n=Math.sqrt(i*r),a=Math.floor(i/n);return{x:Math.floor(n),y:a}},capValue:function(r,i,n){return Math.max(r,Math.min(i,n))},findScaleToFit:function(r,i){return Math.min(i.width/r.width,i.height/r.height)},findScaleToCover:function(r,i){return Math.max(i.width/r.width,i.height/r.height)},matrixToSVG:function(r){return"matrix("+r.map(function(i){return g.util.toFixed(i,g.Object.NUM_FRACTION_DIGITS)}).join(" ")+")"},removeTransformFromObject:function(r,i){var n=g.util.invertTransform(i),a=g.util.multiplyTransformMatrices(n,r.calcOwnMatrix());g.util.applyTransformToObject(r,a)},addTransformToObject:function(r,i){g.util.applyTransformToObject(r,g.util.multiplyTransformMatrices(i,r.calcOwnMatrix()))},applyTransformToObject:function(r,i){var n=g.util.qrDecompose(i),a=new g.Point(n.translateX,n.translateY);r.flipX=!1,r.flipY=!1,r.set("scaleX",n.scaleX),r.set("scaleY",n.scaleY),r.skewX=n.skewX,r.skewY=n.skewY,r.angle=n.angle,r.setPositionByOrigin(a,"center","center")},sizeAfterTransform:function(r,i,n){var a=r/2,e=i/2,t=[{x:-a,y:-e},{x:a,y:-e},{x:-a,y:e},{x:a,y:e}],s=g.util.calcDimensionsMatrix(n),c=g.util.makeBoundingBoxFromPoints(t,s);return{x:c.width,y:c.height}},mergeClipPaths:function(r,i){var n=r,a=i;n.inverted&&!a.inverted&&(n=i,a=r),g.util.applyTransformToObject(a,g.util.multiplyTransformMatrices(g.util.invertTransform(n.calcTransformMatrix()),a.calcTransformMatrix()));var e=n.inverted&&a.inverted;return e&&(n.inverted=a.inverted=!1),new g.Group([n],{clipPath:a,inverted:e})}},function(){var r=Array.prototype.join,i={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},n={m:"l",M:"L"};function a(b,y,w,T,k,P,G,V,N,A,O){var B=g.util.cos(b),W=g.util.sin(b),H=g.util.cos(y),R=g.util.sin(y),D=w*k*H-T*P*R+G,j=T*k*H+w*P*R+V;return["C",A+N*(-w*k*W-T*P*B),O+N*(-T*k*W+w*P*B),D+N*(w*k*R+T*P*H),j+N*(T*k*R-w*P*H),D,j]}function e(b,y,w,T){var k=Math.atan2(y,b),P=Math.atan2(T,w);return P>=k?P-k:2*Math.PI-(k-P)}function t(b,y,w){for(var T=w[1],k=w[2],P=w[3],G=w[4],V=w[5],N=function(B,W,H,R,D,j,X){var U=Math.PI,z=X*U/180,ie=g.util.sin(z),Z=g.util.cos(z),Q=0,te=0,ee=-Z*B*.5-ie*W*.5,re=-Z*W*.5+ie*B*.5,ae=(H=Math.abs(H))*H,ne=(R=Math.abs(R))*R,ge=re*re,me=ee*ee,Te=ae*ne-ae*ge-ne*me,Ie=0;if(Te<0){var je=Math.sqrt(1-Te/(ae*ne));H*=je,R*=je}else Ie=(D===j?-1:1)*Math.sqrt(Te/(ae*ge+ne*me));var ve=Ie*H*re/R,Oe=-Ie*R*ee/H,Ue=Z*ve-ie*Oe+.5*B,Ne=ie*ve+Z*Oe+.5*W,Le=e(1,0,(ee-ve)/H,(re-Oe)/R),Ve=e((ee-ve)/H,(re-Oe)/R,(-ee-ve)/H,(-re-Oe)/R);j===0&&Ve>0?Ve-=2*U:j===1&&Ve<0&&(Ve+=2*U);for(var it=Math.ceil(Math.abs(Ve/U*2)),Xe=[],We=Ve/it,mt=8/3*Math.sin(We/4)*Math.sin(We/4)/Math.sin(We/2),qe=Le+We,Ge=0;Ge<it;Ge++)Xe[Ge]=a(Le,qe,Z,ie,H,R,Ue,Ne,mt,Q,te),Q=Xe[Ge][5],te=Xe[Ge][6],Le=qe,qe+=We;return Xe}(w[6]-b,w[7]-y,T,k,G,V,P),A=0,O=N.length;A<O;A++)N[A][1]+=b,N[A][2]+=y,N[A][3]+=b,N[A][4]+=y,N[A][5]+=b,N[A][6]+=y;return N}function s(b,y,w,T){return Math.sqrt((w-b)*(w-b)+(T-y)*(T-y))}function c(b,y,w,T,k,P,G,V){return function(N){var A,O=(A=N)*A*A,B=function(R){return 3*R*R*(1-R)}(N),W=function(R){return 3*R*(1-R)*(1-R)}(N),H=function(R){return(1-R)*(1-R)*(1-R)}(N);return{x:G*O+k*B+w*W+b*H,y:V*O+P*B+T*W+y*H}}}function h(b,y,w,T,k,P,G,V){return function(N){var A=1-N,O=3*A*A*(w-b)+6*A*N*(k-w)+3*N*N*(G-k),B=3*A*A*(T-y)+6*A*N*(P-T)+3*N*N*(V-P);return Math.atan2(B,O)}}function l(b,y,w,T,k,P){return function(G){var V,N=(V=G)*V,A=function(B){return 2*B*(1-B)}(G),O=function(B){return(1-B)*(1-B)}(G);return{x:k*N+w*A+b*O,y:P*N+T*A+y*O}}}function d(b,y,w,T,k,P){return function(G){var V=1-G,N=2*V*(w-b)+2*G*(k-w),A=2*V*(T-y)+2*G*(P-T);return Math.atan2(A,N)}}function p(b,y,w){var T,k,P={x:y,y:w},G=0;for(k=1;k<=100;k+=1)T=b(k/100),G+=s(P.x,P.y,T.x,T.y),P=T;return G}function m(b){for(var y,w,T,k,P=0,G=b.length,V=0,N=0,A=0,O=0,B=[],W=0;W<G;W++){switch(T={x:V,y:N,command:(y=b[W])[0]},y[0]){case"M":T.length=0,A=V=y[1],O=N=y[2];break;case"L":T.length=s(V,N,y[1],y[2]),V=y[1],N=y[2];break;case"C":w=c(V,N,y[1],y[2],y[3],y[4],y[5],y[6]),k=h(V,N,y[1],y[2],y[3],y[4],y[5],y[6]),T.iterator=w,T.angleFinder=k,T.length=p(w,V,N),V=y[5],N=y[6];break;case"Q":w=l(V,N,y[1],y[2],y[3],y[4]),k=d(V,N,y[1],y[2],y[3],y[4]),T.iterator=w,T.angleFinder=k,T.length=p(w,V,N),V=y[3],N=y[4];break;case"Z":case"z":T.destX=A,T.destY=O,T.length=s(V,N,A,O),V=A,N=O}P+=T.length,B.push(T)}return B.push({length:P,x:V,y:N}),B}g.util.joinPath=function(b){return b.map(function(y){return y.join(" ")}).join(" ")},g.util.parsePath=function(b){var y,w,T,k,P,G=[],V=[],N=g.rePathCommand,A="[-+]?(?:\\d*\\.\\d+|\\d+\\.?)(?:[eE][-+]?\\d+)?\\s*",O="("+A+")"+g.commaWsp,B="([01])"+g.commaWsp+"?",W=new RegExp(O+"?"+O+"?"+O+B+B+O+"?("+A+")","g");if(!b||!b.match)return G;for(var H,R=0,D=(P=b.match(/[mzlhvcsqta][^mzlhvcsqta]*/gi)).length;R<D;R++){k=(y=P[R]).slice(1).trim(),V.length=0;var j=y.charAt(0);if(H=[j],j.toLowerCase()==="a")for(var X;X=W.exec(k);)for(var U=1;U<X.length;U++)V.push(X[U]);else for(;T=N.exec(k);)V.push(T[0]);U=0;for(var z=V.length;U<z;U++)w=parseFloat(V[U]),isNaN(w)||H.push(w);var ie=i[j.toLowerCase()],Z=n[j]||j;if(H.length-1>ie)for(var Q=1,te=H.length;Q<te;Q+=ie)G.push([j].concat(H.slice(Q,Q+ie))),j=Z;else G.push(H)}return G},g.util.makePathSimpler=function(b){var y,w,T,k,P,G,V=0,N=0,A=b.length,O=0,B=0,W=[];for(w=0;w<A;++w){switch(T=!1,(y=b[w].slice(0))[0]){case"l":y[0]="L",y[1]+=V,y[2]+=N;case"L":V=y[1],N=y[2];break;case"h":y[1]+=V;case"H":y[0]="L",y[2]=N,V=y[1];break;case"v":y[1]+=N;case"V":y[0]="L",N=y[1],y[1]=V,y[2]=N;break;case"m":y[0]="M",y[1]+=V,y[2]+=N;case"M":V=y[1],N=y[2],O=y[1],B=y[2];break;case"c":y[0]="C",y[1]+=V,y[2]+=N,y[3]+=V,y[4]+=N,y[5]+=V,y[6]+=N;case"C":P=y[3],G=y[4],V=y[5],N=y[6];break;case"s":y[0]="S",y[1]+=V,y[2]+=N,y[3]+=V,y[4]+=N;case"S":k==="C"?(P=2*V-P,G=2*N-G):(P=V,G=N),V=y[3],N=y[4],y[0]="C",y[5]=y[3],y[6]=y[4],y[3]=y[1],y[4]=y[2],y[1]=P,y[2]=G,P=y[3],G=y[4];break;case"q":y[0]="Q",y[1]+=V,y[2]+=N,y[3]+=V,y[4]+=N;case"Q":P=y[1],G=y[2],V=y[3],N=y[4];break;case"t":y[0]="T",y[1]+=V,y[2]+=N;case"T":k==="Q"?(P=2*V-P,G=2*N-G):(P=V,G=N),y[0]="Q",V=y[1],N=y[2],y[1]=P,y[2]=G,y[3]=V,y[4]=N;break;case"a":y[0]="A",y[6]+=V,y[7]+=N;case"A":T=!0,W=W.concat(t(V,N,y)),V=y[6],N=y[7];break;case"z":case"Z":V=O,N=B}T||W.push(y),k=y[0]}return W},g.util.getSmoothPathFromPoints=function(b,y){var w,T=[],k=new g.Point(b[0].x,b[0].y),P=new g.Point(b[1].x,b[1].y),G=b.length,V=1,N=0,A=G>2;for(y=y||0,A&&(V=b[2].x<P.x?-1:b[2].x===P.x?0:1,N=b[2].y<P.y?-1:b[2].y===P.y?0:1),T.push(["M",k.x-V*y,k.y-N*y]),w=1;w<G;w++){if(!k.eq(P)){var O=k.midPointFrom(P);T.push(["Q",k.x,k.y,O.x,O.y])}k=b[w],w+1<b.length&&(P=b[w+1])}return A&&(V=k.x>b[w-2].x?1:k.x===b[w-2].x?0:-1,N=k.y>b[w-2].y?1:k.y===b[w-2].y?0:-1),T.push(["L",k.x+V*y,k.y+N*y]),T},g.util.getPathSegmentsInfo=m,g.util.getBoundsOfCurve=function(b,y,w,T,k,P,G,V){var N;if(g.cachesBoundsOfCurve&&(N=r.call(arguments),g.boundsOfCurveCache[N]))return g.boundsOfCurveCache[N];var A,O,B,W,H,R,D,j,X=Math.sqrt,U=Math.min,z=Math.max,ie=Math.abs,Z=[],Q=[[],[]];O=6*b-12*w+6*k,A=-3*b+9*w-9*k+3*G,B=3*w-3*b;for(var te=0;te<2;++te)if(te>0&&(O=6*y-12*T+6*P,A=-3*y+9*T-9*P+3*V,B=3*T-3*y),ie(A)<1e-12){if(ie(O)<1e-12)continue;0<(W=-B/O)&&W<1&&Z.push(W)}else(D=O*O-4*B*A)<0||(0<(H=(-O+(j=X(D)))/(2*A))&&H<1&&Z.push(H),0<(R=(-O-j)/(2*A))&&R<1&&Z.push(R));for(var ee,re,ae,ne=Z.length,ge=ne;ne--;)ee=(ae=1-(W=Z[ne]))*ae*ae*b+3*ae*ae*W*w+3*ae*W*W*k+W*W*W*G,Q[0][ne]=ee,re=ae*ae*ae*y+3*ae*ae*W*T+3*ae*W*W*P+W*W*W*V,Q[1][ne]=re;Q[0][ge]=b,Q[1][ge]=y,Q[0][ge+1]=G,Q[1][ge+1]=V;var me=[{x:U.apply(null,Q[0]),y:U.apply(null,Q[1])},{x:z.apply(null,Q[0]),y:z.apply(null,Q[1])}];return g.cachesBoundsOfCurve&&(g.boundsOfCurveCache[N]=me),me},g.util.getPointOnPath=function(b,y,w){w||(w=m(b));for(var T=0;y-w[T].length>0&&T<w.length-2;)y-=w[T].length,T++;var k,P=w[T],G=y/P.length,V=P.command,N=b[T];switch(V){case"M":return{x:P.x,y:P.y,angle:0};case"Z":case"z":return(k=new g.Point(P.x,P.y).lerp(new g.Point(P.destX,P.destY),G)).angle=Math.atan2(P.destY-P.y,P.destX-P.x),k;case"L":return(k=new g.Point(P.x,P.y).lerp(new g.Point(N[1],N[2]),G)).angle=Math.atan2(N[2]-P.y,N[1]-P.x),k;case"C":case"Q":return function(A,O){for(var B,W,H,R=0,D=0,j=A.iterator,X={x:A.x,y:A.y},U=.01,z=A.angleFinder;D<O&&U>1e-4;)B=j(R),H=R,(W=s(X.x,X.y,B.x,B.y))+D>O?(R-=U,U/=2):(X=B,R+=U,D+=W);return B.angle=z(H),B}(P,y)}},g.util.transformPath=function(b,y,w){return w&&(y=g.util.multiplyTransformMatrices(y,[1,0,0,1,-w.x,-w.y])),b.map(function(T){for(var k=T.slice(0),P={},G=1;G<T.length-1;G+=2)P.x=T[G],P.y=T[G+1],P=g.util.transformPoint(P,y),k[G]=P.x,k[G+1]=P.y;return k})}}(),function(){var r=Array.prototype.slice;function i(n,a,e){if(n&&n.length!==0){var t=n.length-1,s=a?n[t][a]:n[t];if(a)for(;t--;)e(n[t][a],s)&&(s=n[t][a]);else for(;t--;)e(n[t],s)&&(s=n[t]);return s}}g.util.array={fill:function(n,a){for(var e=n.length;e--;)n[e]=a;return n},invoke:function(n,a){for(var e=r.call(arguments,2),t=[],s=0,c=n.length;s<c;s++)t[s]=e.length?n[s][a].apply(n[s],e):n[s][a].call(n[s]);return t},min:function(n,a){return i(n,a,function(e,t){return e<t})},max:function(n,a){return i(n,a,function(e,t){return e>=t})}}}(),function(){function r(i,n,a){if(a)if(!g.isLikelyNode&&n instanceof Element)i=n;else if(n instanceof Array){i=[];for(var e=0,t=n.length;e<t;e++)i[e]=r({},n[e],a)}else if(n&&typeof n=="object")for(var s in n)s==="canvas"||s==="group"?i[s]=null:n.hasOwnProperty(s)&&(i[s]=r({},n[s],a));else i=n;else for(var s in n)i[s]=n[s];return i}g.util.object={extend:r,clone:function(i,n){return r({},i,n)}},g.util.object.extend(g.util,g.Observable)}(),function(){function r(i,n){var a=i.charCodeAt(n);if(isNaN(a))return"";if(a<55296||a>57343)return i.charAt(n);if(55296<=a&&a<=56319){if(i.length<=n+1)throw"High surrogate without following low surrogate";var e=i.charCodeAt(n+1);if(56320>e||e>57343)throw"High surrogate without following low surrogate";return i.charAt(n)+i.charAt(n+1)}if(n===0)throw"Low surrogate without preceding high surrogate";var t=i.charCodeAt(n-1);if(55296>t||t>56319)throw"Low surrogate without preceding high surrogate";return!1}g.util.string={camelize:function(i){return i.replace(/-+(.)?/g,function(n,a){return a?a.toUpperCase():""})},capitalize:function(i,n){return i.charAt(0).toUpperCase()+(n?i.slice(1):i.slice(1).toLowerCase())},escapeXml:function(i){return i.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},graphemeSplit:function(i){var n,a=0,e=[];for(a=0;a<i.length;a++)(n=r(i,a))!==!1&&e.push(n);return e}}}(),function(){var r=Array.prototype.slice,i=function(){},n=function(){for(var s in{toString:1})if(s==="toString")return!1;return!0}(),a=function(s,c,h){for(var l in c)l in s.prototype&&typeof s.prototype[l]=="function"&&(c[l]+"").indexOf("callSuper")>-1?s.prototype[l]=function(d){return function(){var p=this.constructor.superclass;this.constructor.superclass=h;var m=c[d].apply(this,arguments);if(this.constructor.superclass=p,d!=="initialize")return m}}(l):s.prototype[l]=c[l],n&&(c.toString!==Object.prototype.toString&&(s.prototype.toString=c.toString),c.valueOf!==Object.prototype.valueOf&&(s.prototype.valueOf=c.valueOf))};function e(){}function t(s){for(var c=null,h=this;h.constructor.superclass;){var l=h.constructor.superclass.prototype[s];if(h[s]!==l){c=l;break}h=h.constructor.superclass.prototype}return c?arguments.length>1?c.apply(this,r.call(arguments,1)):c.call(this):console.log("tried to callSuper "+s+", method not found in prototype chain",this)}g.util.createClass=function(){var s=null,c=r.call(arguments,0);function h(){this.initialize.apply(this,arguments)}typeof c[0]=="function"&&(s=c.shift()),h.superclass=s,h.subclasses=[],s&&(e.prototype=s.prototype,h.prototype=new e,s.subclasses.push(h));for(var l=0,d=c.length;l<d;l++)a(h,c[l],s);return h.prototype.initialize||(h.prototype.initialize=i),h.prototype.constructor=h,h.prototype.callSuper=t,h}}(),I=!!g.document.createElement("div").attachEvent,E=["touchstart","touchmove","touchend"],g.util.addListener=function(r,i,n,a){r&&r.addEventListener(i,n,!I&&a)},g.util.removeListener=function(r,i,n,a){r&&r.removeEventListener(i,n,!I&&a)},g.util.getPointer=function(r){var i=r.target,n=g.util.getScrollLeftTop(i),a=function(e){var t=e.changedTouches;return t&&t[0]?t[0]:e}(r);return{x:a.clientX+n.left,y:a.clientY+n.top}},g.util.isTouchEvent=function(r){return E.indexOf(r.type)>-1||r.pointerType==="touch"},M=typeof(F=g.document.createElement("div")).style.opacity=="string",q=typeof F.style.filter=="string",se=/alpha\s*\(\s*opacity\s*=\s*([^\)]+)\)/,K=function(r){return r},M?K=function(r,i){return r.style.opacity=i,r}:q&&(K=function(r,i){var n=r.style;return r.currentStyle&&!r.currentStyle.hasLayout&&(n.zoom=1),se.test(n.filter)?(i=i>=.9999?"":"alpha(opacity="+100*i+")",n.filter=n.filter.replace(se,i)):n.filter+=" alpha(opacity="+100*i+")",r}),g.util.setStyle=function(r,i){var n=r.style;if(!n)return r;if(typeof i=="string")return r.style.cssText+=";"+i,i.indexOf("opacity")>-1?K(r,i.match(/opacity:\s*(\d?\.?\d*)/)[1]):r;for(var a in i)a==="opacity"?K(r,i[a]):n[a==="float"||a==="cssFloat"?n.styleFloat===void 0?"cssFloat":"styleFloat":a]=i[a];return r},function(){var r,i,n,a,e=Array.prototype.slice,t=function(h){return e.call(h,0)};try{r=t(g.document.childNodes)instanceof Array}catch(h){}function s(h,l){var d=g.document.createElement(h);for(var p in l)p==="class"?d.className=l[p]:p==="for"?d.htmlFor=l[p]:d.setAttribute(p,l[p]);return d}function c(h){for(var l=0,d=0,p=g.document.documentElement,m=g.document.body||{scrollLeft:0,scrollTop:0};h&&(h.parentNode||h.host)&&((h=h.parentNode||h.host)===g.document?(l=m.scrollLeft||p.scrollLeft||0,d=m.scrollTop||p.scrollTop||0):(l+=h.scrollLeft||0,d+=h.scrollTop||0),h.nodeType!==1||h.style.position!=="fixed"););return{left:l,top:d}}r||(t=function(h){for(var l=new Array(h.length),d=h.length;d--;)l[d]=h[d];return l}),i=g.document.defaultView&&g.document.defaultView.getComputedStyle?function(h,l){var d=g.document.defaultView.getComputedStyle(h,null);return d?d[l]:void 0}:function(h,l){var d=h.style[l];return!d&&h.currentStyle&&(d=h.currentStyle[l]),d},n=g.document.documentElement.style,a="userSelect"in n?"userSelect":"MozUserSelect"in n?"MozUserSelect":"WebkitUserSelect"in n?"WebkitUserSelect":"KhtmlUserSelect"in n?"KhtmlUserSelect":"",g.util.makeElementUnselectable=function(h){return h.onselectstart!==void 0&&(h.onselectstart=g.util.falseFunction),a?h.style[a]="none":typeof h.unselectable=="string"&&(h.unselectable="on"),h},g.util.makeElementSelectable=function(h){return h.onselectstart!==void 0&&(h.onselectstart=null),a?h.style[a]="":typeof h.unselectable=="string"&&(h.unselectable=""),h},g.util.setImageSmoothing=function(h,l){h.imageSmoothingEnabled=h.imageSmoothingEnabled||h.webkitImageSmoothingEnabled||h.mozImageSmoothingEnabled||h.msImageSmoothingEnabled||h.oImageSmoothingEnabled,h.imageSmoothingEnabled=l},g.util.getById=function(h){return typeof h=="string"?g.document.getElementById(h):h},g.util.toArray=t,g.util.addClass=function(h,l){h&&(" "+h.className+" ").indexOf(" "+l+" ")===-1&&(h.className+=(h.className?" ":"")+l)},g.util.makeElement=s,g.util.wrapElement=function(h,l,d){return typeof l=="string"&&(l=s(l,d)),h.parentNode&&h.parentNode.replaceChild(l,h),l.appendChild(h),l},g.util.getScrollLeftTop=c,g.util.getElementOffset=function(h){var l,d,p=h&&h.ownerDocument,m={left:0,top:0},b={left:0,top:0},y={borderLeftWidth:"left",borderTopWidth:"top",paddingLeft:"left",paddingTop:"top"};if(!p)return b;for(var w in y)b[y[w]]+=parseInt(i(h,w),10)||0;return l=p.documentElement,h.getBoundingClientRect!==void 0&&(m=h.getBoundingClientRect()),d=c(h),{left:m.left+d.left-(l.clientLeft||0)+b.left,top:m.top+d.top-(l.clientTop||0)+b.top}},g.util.getNodeCanvas=function(h){var l=g.jsdomImplForWrapper(h);return l._canvas||l._image},g.util.cleanUpJsdomNode=function(h){if(g.isLikelyNode){var l=g.jsdomImplForWrapper(h);l&&(l._image=null,l._canvas=null,l._currentSrc=null,l._attributes=null,l._classList=null)}}}(),function(){function r(){}g.util.request=function(i,n){n||(n={});var a=n.method?n.method.toUpperCase():"GET",e=n.onComplete||function(){},t=new g.window.XMLHttpRequest,s=n.body||n.parameters;return t.onreadystatechange=function(){t.readyState===4&&(e(t),t.onreadystatechange=r)},a==="GET"&&(s=null,typeof n.parameters=="string"&&(i=function(c,h){return c+(/\?/.test(c)?"&":"?")+h}(i,n.parameters))),t.open(a,i,!0),a!=="POST"&&a!=="PUT"||t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.send(s),t}}(),g.log=console.log,g.warn=console.warn,function(){var r=g.util.object.extend,i=g.util.object.clone,n=[];function a(){return!1}function e(h,l,d,p){return-d*Math.cos(h/p*(Math.PI/2))+d+l}g.util.object.extend(n,{cancelAll:function(){var h=this.splice(0);return h.forEach(function(l){l.cancel()}),h},cancelByCanvas:function(h){if(!h)return[];var l=this.filter(function(d){return typeof d.target=="object"&&d.target.canvas===h});return l.forEach(function(d){d.cancel()}),l},cancelByTarget:function(h){var l=this.findAnimationsByTarget(h);return l.forEach(function(d){d.cancel()}),l},findAnimationIndex:function(h){return this.indexOf(this.findAnimation(h))},findAnimation:function(h){return this.find(function(l){return l.cancel===h})},findAnimationsByTarget:function(h){return h?this.filter(function(l){return l.target===h}):[]}});var t=g.window.requestAnimationFrame||g.window.webkitRequestAnimationFrame||g.window.mozRequestAnimationFrame||g.window.oRequestAnimationFrame||g.window.msRequestAnimationFrame||function(h){return g.window.setTimeout(h,1e3/60)},s=g.window.cancelAnimationFrame||g.window.clearTimeout;function c(){return t.apply(g.window,arguments)}g.util.animate=function(h){h||(h={});var l,d=!1,p=function(){var m=g.runningAnimations.indexOf(l);return m>-1&&g.runningAnimations.splice(m,1)[0]};return l=r(i(h),{cancel:function(){return d=!0,p()},currentValue:"startValue"in h?h.startValue:0,completionRate:0,durationRate:0}),g.runningAnimations.push(l),c(function(m){var b,y=m||+new Date,w=h.duration||500,T=y+w,k=h.onChange||a,P=h.abort||a,G=h.onComplete||a,V=h.easing||e,N="startValue"in h&&h.startValue.length>0,A="startValue"in h?h.startValue:0,O="endValue"in h?h.endValue:100,B=h.byValue||(N?A.map(function(W,H){return O[H]-A[H]}):O-A);h.onStart&&h.onStart(),function W(H){var R=(b=H||+new Date)>T?w:b-y,D=R/w,j=N?A.map(function(U,z){return V(R,A[z],B[z],w)}):V(R,A,B,w),X=Math.abs(N?(j[0]-A[0])/B[0]:(j-A)/B);if(l.currentValue=N?j.slice():j,l.completionRate=X,l.durationRate=D,!d){if(!P(j,X,D))return b>T?(l.currentValue=N?O.slice():O,l.completionRate=1,l.durationRate=1,k(N?O.slice():O,1,1),G(O,1,1),void p()):(k(j,X,D),void c(W));p()}}(y)}),l.cancel},g.util.requestAnimFrame=c,g.util.cancelAnimFrame=function(){return s.apply(g.window,arguments)},g.runningAnimations=n}(),function(){function r(i,n,a){var e="rgba("+parseInt(i[0]+a*(n[0]-i[0]),10)+","+parseInt(i[1]+a*(n[1]-i[1]),10)+","+parseInt(i[2]+a*(n[2]-i[2]),10);return(e+=","+(i&&n?parseFloat(i[3]+a*(n[3]-i[3])):1))+")"}g.util.animateColor=function(i,n,a,e){var t=new g.Color(i).getSource(),s=new g.Color(n).getSource(),c=e.onComplete,h=e.onChange;return e=e||{},g.util.animate(g.util.object.extend(e,{duration:a||500,startValue:t,endValue:s,byValue:s,easing:function(l,d,p,m){return r(d,p,e.colorEasing?e.colorEasing(l,m):1-Math.cos(l/m*(Math.PI/2)))},onComplete:function(l,d,p){if(c)return c(r(s,s,0),d,p)},onChange:function(l,d,p){if(h){if(Array.isArray(l))return h(r(l,l,0),d,p);h(l,d,p)}}}))}}(),function(){function r(e,t,s,c){return e<Math.abs(t)?(e=t,c=s/4):c=t===0&&e===0?s/(2*Math.PI)*Math.asin(1):s/(2*Math.PI)*Math.asin(t/e),{a:e,c:t,p:s,s:c}}function i(e,t,s){return e.a*Math.pow(2,10*(t-=1))*Math.sin((t*s-e.s)*(2*Math.PI)/e.p)}function n(e,t,s,c){return s-a(c-e,0,s,c)+t}function a(e,t,s,c){return(e/=c)<1/2.75?s*(7.5625*e*e)+t:e<2/2.75?s*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?s*(7.5625*(e-=2.25/2.75)*e+.9375)+t:s*(7.5625*(e-=2.625/2.75)*e+.984375)+t}g.util.ease={easeInQuad:function(e,t,s,c){return s*(e/=c)*e+t},easeOutQuad:function(e,t,s,c){return-s*(e/=c)*(e-2)+t},easeInOutQuad:function(e,t,s,c){return(e/=c/2)<1?s/2*e*e+t:-s/2*(--e*(e-2)-1)+t},easeInCubic:function(e,t,s,c){return s*(e/=c)*e*e+t},easeOutCubic:function(e,t,s,c){return s*((e=e/c-1)*e*e+1)+t},easeInOutCubic:function(e,t,s,c){return(e/=c/2)<1?s/2*e*e*e+t:s/2*((e-=2)*e*e+2)+t},easeInQuart:function(e,t,s,c){return s*(e/=c)*e*e*e+t},easeOutQuart:function(e,t,s,c){return-s*((e=e/c-1)*e*e*e-1)+t},easeInOutQuart:function(e,t,s,c){return(e/=c/2)<1?s/2*e*e*e*e+t:-s/2*((e-=2)*e*e*e-2)+t},easeInQuint:function(e,t,s,c){return s*(e/=c)*e*e*e*e+t},easeOutQuint:function(e,t,s,c){return s*((e=e/c-1)*e*e*e*e+1)+t},easeInOutQuint:function(e,t,s,c){return(e/=c/2)<1?s/2*e*e*e*e*e+t:s/2*((e-=2)*e*e*e*e+2)+t},easeInSine:function(e,t,s,c){return-s*Math.cos(e/c*(Math.PI/2))+s+t},easeOutSine:function(e,t,s,c){return s*Math.sin(e/c*(Math.PI/2))+t},easeInOutSine:function(e,t,s,c){return-s/2*(Math.cos(Math.PI*e/c)-1)+t},easeInExpo:function(e,t,s,c){return e===0?t:s*Math.pow(2,10*(e/c-1))+t},easeOutExpo:function(e,t,s,c){return e===c?t+s:s*(1-Math.pow(2,-10*e/c))+t},easeInOutExpo:function(e,t,s,c){return e===0?t:e===c?t+s:(e/=c/2)<1?s/2*Math.pow(2,10*(e-1))+t:s/2*(2-Math.pow(2,-10*--e))+t},easeInCirc:function(e,t,s,c){return-s*(Math.sqrt(1-(e/=c)*e)-1)+t},easeOutCirc:function(e,t,s,c){return s*Math.sqrt(1-(e=e/c-1)*e)+t},easeInOutCirc:function(e,t,s,c){return(e/=c/2)<1?-s/2*(Math.sqrt(1-e*e)-1)+t:s/2*(Math.sqrt(1-(e-=2)*e)+1)+t},easeInElastic:function(e,t,s,c){var h=0;return e===0?t:(e/=c)==1?t+s:(h||(h=.3*c),-i(r(s,s,h,1.70158),e,c)+t)},easeOutElastic:function(e,t,s,c){var h=0;if(e===0)return t;if((e/=c)==1)return t+s;h||(h=.3*c);var l=r(s,s,h,1.70158);return l.a*Math.pow(2,-10*e)*Math.sin((e*c-l.s)*(2*Math.PI)/l.p)+l.c+t},easeInOutElastic:function(e,t,s,c){var h=0;if(e===0)return t;if((e/=c/2)==2)return t+s;h||(h=c*(.3*1.5));var l=r(s,s,h,1.70158);return e<1?-.5*i(l,e,c)+t:l.a*Math.pow(2,-10*(e-=1))*Math.sin((e*c-l.s)*(2*Math.PI)/l.p)*.5+l.c+t},easeInBack:function(e,t,s,c,h){return h===void 0&&(h=1.70158),s*(e/=c)*e*((h+1)*e-h)+t},easeOutBack:function(e,t,s,c,h){return h===void 0&&(h=1.70158),s*((e=e/c-1)*e*((h+1)*e+h)+1)+t},easeInOutBack:function(e,t,s,c,h){return h===void 0&&(h=1.70158),(e/=c/2)<1?s/2*(e*e*((1+(h*=1.525))*e-h))+t:s/2*((e-=2)*e*((1+(h*=1.525))*e+h)+2)+t},easeInBounce:n,easeOutBounce:a,easeInOutBounce:function(e,t,s,c){return e<c/2?.5*n(2*e,0,s,c)+t:.5*a(2*e-c,0,s,c)+.5*s+t}}}(),function(r){var i=r.fabric||(r.fabric={}),n=i.util.object.extend,a=i.util.object.clone,e=i.util.toFixed,t=i.util.parseUnit,s=i.util.multiplyTransformMatrices,c={cx:"left",x:"left",r:"radius",cy:"top",y:"top",display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-dashoffset":"strokeDashOffset","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule","vector-effect":"strokeUniform","image-rendering":"imageSmoothing"},h={stroke:"strokeOpacity",fill:"fillOpacity"},l="font-size",d="clip-path";function p(A){return A in c?c[A]:A}function m(A,O,B,W){var H,R=Array.isArray(O);if(A!=="fill"&&A!=="stroke"||O!=="none"){if(A==="strokeUniform")return O==="non-scaling-stroke";if(A==="strokeDashArray")O=O==="none"?null:O.replace(/,/g," ").split(/\s+/).map(parseFloat);else if(A==="transformMatrix")O=B&&B.transformMatrix?s(B.transformMatrix,i.parseTransformAttribute(O)):i.parseTransformAttribute(O);else if(A==="visible")O=O!=="none"&&O!=="hidden",B&&B.visible===!1&&(O=!1);else if(A==="opacity")O=parseFloat(O),B&&B.opacity!==void 0&&(O*=B.opacity);else if(A==="textAnchor")O=O==="start"?"left":O==="end"?"right":"center";else if(A==="charSpacing")H=t(O,W)/W*1e3;else if(A==="paintFirst"){var D=O.indexOf("fill"),j=O.indexOf("stroke");O="fill",(D>-1&&j>-1&&j<D||D===-1&&j>-1)&&(O="stroke")}else{if(A==="href"||A==="xlink:href"||A==="font")return O;if(A==="imageSmoothing")return O==="optimizeQuality";H=R?O.map(t):t(O,W)}}else O="";return!R&&isNaN(H)?O:H}function b(A){return new RegExp("^("+A.join("|")+")\\b","i")}function y(A,O){var B,W,H,R,D=[];for(H=0,R=O.length;H<R;H++)B=O[H],W=A.getElementsByTagName(B),D=D.concat(Array.prototype.slice.call(W));return D}function w(A,O){var B,W=!0;return(B=T(A,O.pop()))&&O.length&&(W=function(H,R){for(var D,j=!0;H.parentNode&&H.parentNode.nodeType===1&&R.length;)j&&(D=R.pop()),j=T(H=H.parentNode,D);return R.length===0}(A,O)),B&&W&&O.length===0}function T(A,O){var B,W,H=A.nodeName,R=A.getAttribute("class"),D=A.getAttribute("id");if(B=new RegExp("^"+H,"i"),O=O.replace(B,""),D&&O.length&&(B=new RegExp("#"+D+"(?![a-zA-Z\\-]+)","i"),O=O.replace(B,"")),R&&O.length)for(W=(R=R.split(" ")).length;W--;)B=new RegExp("\\."+R[W]+"(?![a-zA-Z\\-]+)","i"),O=O.replace(B,"");return O.length===0}function k(A,O){var B;if(A.getElementById&&(B=A.getElementById(O)),B)return B;var W,H,R,D=A.getElementsByTagName("*");for(H=0,R=D.length;H<R;H++)if(O===(W=D[H]).getAttribute("id"))return W}i.svgValidTagNamesRegEx=b(["path","circle","polygon","polyline","ellipse","rect","line","image","text"]),i.svgViewBoxElementsRegEx=b(["symbol","image","marker","pattern","view","svg"]),i.svgInvalidAncestorsRegEx=b(["pattern","defs","symbol","metadata","clipPath","mask","desc"]),i.svgValidParentsRegEx=b(["symbol","g","a","svg","clipPath","defs"]),i.cssRules={},i.gradientDefs={},i.clipPaths={},i.parseTransformAttribute=function(){function A(j,X,U){j[U]=Math.tan(i.util.degreesToRadians(X[0]))}var O=i.iMatrix,B=i.reNum,W=i.commaWsp,H="(?:(?:(matrix)\\s*\\(\\s*("+B+")"+W+"("+B+")"+W+"("+B+")"+W+"("+B+")"+W+"("+B+")"+W+"("+B+")\\s*\\))|(?:(translate)\\s*\\(\\s*("+B+")(?:"+W+"("+B+"))?\\s*\\))|(?:(scale)\\s*\\(\\s*("+B+")(?:"+W+"("+B+"))?\\s*\\))|(?:(rotate)\\s*\\(\\s*("+B+")(?:"+W+"("+B+")"+W+"("+B+"))?\\s*\\))|(?:(skewX)\\s*\\(\\s*("+B+")\\s*\\))|(?:(skewY)\\s*\\(\\s*("+B+")\\s*\\)))",R=new RegExp("^\\s*(?:(?:"+H+"(?:"+W+"*"+H+")*)?)\\s*$"),D=new RegExp(H,"g");return function(j){var X=O.concat(),U=[];if(!j||j&&!R.test(j))return X;j.replace(D,function(ie){var Z=new RegExp(H).exec(ie).filter(function(ee){return!!ee}),Q=Z[1],te=Z.slice(2).map(parseFloat);switch(Q){case"translate":(function(ee,re){ee[4]=re[0],re.length===2&&(ee[5]=re[1])})(X,te);break;case"rotate":te[0]=i.util.degreesToRadians(te[0]),function(ee,re){var ae=i.util.cos(re[0]),ne=i.util.sin(re[0]),ge=0,me=0;re.length===3&&(ge=re[1],me=re[2]),ee[0]=ae,ee[1]=ne,ee[2]=-ne,ee[3]=ae,ee[4]=ge-(ae*ge-ne*me),ee[5]=me-(ne*ge+ae*me)}(X,te);break;case"scale":(function(ee,re){var ae=re[0],ne=re.length===2?re[1]:re[0];ee[0]=ae,ee[3]=ne})(X,te);break;case"skewX":A(X,te,2);break;case"skewY":A(X,te,1);break;case"matrix":X=te}U.push(X.concat()),X=O.concat()});for(var z=U[0];U.length>1;)U.shift(),z=i.util.multiplyTransformMatrices(z,U[0]);return z}}();var P=new RegExp("^\\s*("+i.reNum+"+)\\s*,?\\s*("+i.reNum+"+)\\s*,?\\s*("+i.reNum+"+)\\s*,?\\s*("+i.reNum+"+)\\s*$");function G(A){if(!i.svgViewBoxElementsRegEx.test(A.nodeName))return{};var O,B,W,H,R,D,j=A.getAttribute("viewBox"),X=1,U=1,z=A.getAttribute("width"),ie=A.getAttribute("height"),Z=A.getAttribute("x")||0,Q=A.getAttribute("y")||0,te=A.getAttribute("preserveAspectRatio")||"",ee=!j||!(j=j.match(P)),re=!z||!ie||z==="100%"||ie==="100%",ae=ee&&re,ne={},ge="",me=0,Te=0;if(ne.width=0,ne.height=0,ne.toBeParsed=ae,ee&&(Z||Q)&&A.parentNode&&A.parentNode.nodeName!=="#document"&&(ge=" translate("+t(Z)+" "+t(Q)+") ",R=(A.getAttribute("transform")||"")+ge,A.setAttribute("transform",R),A.removeAttribute("x"),A.removeAttribute("y")),ae)return ne;if(ee)return ne.width=t(z),ne.height=t(ie),ne;if(O=-parseFloat(j[1]),B=-parseFloat(j[2]),W=parseFloat(j[3]),H=parseFloat(j[4]),ne.minX=O,ne.minY=B,ne.viewBoxWidth=W,ne.viewBoxHeight=H,re?(ne.width=W,ne.height=H):(ne.width=t(z),ne.height=t(ie),X=ne.width/W,U=ne.height/H),(te=i.util.parsePreserveAspectRatioAttribute(te)).alignX!=="none"&&(te.meetOrSlice==="meet"&&(U=X=X>U?U:X),te.meetOrSlice==="slice"&&(U=X=X>U?X:U),me=ne.width-W*X,Te=ne.height-H*X,te.alignX==="Mid"&&(me/=2),te.alignY==="Mid"&&(Te/=2),te.alignX==="Min"&&(me=0),te.alignY==="Min"&&(Te=0)),X===1&&U===1&&O===0&&B===0&&Z===0&&Q===0)return ne;if((Z||Q)&&A.parentNode.nodeName!=="#document"&&(ge=" translate("+t(Z)+" "+t(Q)+") "),R=ge+" matrix("+X+" 0 0 "+U+" "+(O*X+me)+" "+(B*U+Te)+") ",A.nodeName==="svg"){for(D=A.ownerDocument.createElementNS(i.svgNS,"g");A.firstChild;)D.appendChild(A.firstChild);A.appendChild(D)}else(D=A).removeAttribute("x"),D.removeAttribute("y"),R=D.getAttribute("transform")+R;return D.setAttribute("transform",R),ne}function V(A,O){var B="xlink:href",W=k(A,O.getAttribute(B).slice(1));if(W&&W.getAttribute(B)&&V(A,W),["gradientTransform","x1","x2","y1","y2","gradientUnits","cx","cy","r","fx","fy"].forEach(function(R){W&&!O.hasAttribute(R)&&W.hasAttribute(R)&&O.setAttribute(R,W.getAttribute(R))}),!O.children.length)for(var H=W.cloneNode(!0);H.firstChild;)O.appendChild(H.firstChild);O.removeAttribute(B)}i.parseSVGDocument=function(A,O,B,W){if(A){(function(Z){for(var Q=y(Z,["use","svg:use"]),te=0;Q.length&&te<Q.length;){var ee=Q[te],re=ee.getAttribute("xlink:href")||ee.getAttribute("href");if(re===null)return;var ae,ne,ge,me,Te=re.slice(1),Ie=ee.getAttribute("x")||0,je=ee.getAttribute("y")||0,ve=k(Z,Te).cloneNode(!0),Oe=(ve.getAttribute("transform")||"")+" translate("+Ie+", "+je+")",Ue=Q.length,Ne=i.svgNS;if(G(ve),/^svg$/i.test(ve.nodeName)){var Le=ve.ownerDocument.createElementNS(Ne,"g");for(ne=0,me=(ge=ve.attributes).length;ne<me;ne++)ae=ge.item(ne),Le.setAttributeNS(Ne,ae.nodeName,ae.nodeValue);for(;ve.firstChild;)Le.appendChild(ve.firstChild);ve=Le}for(ne=0,me=(ge=ee.attributes).length;ne<me;ne++)(ae=ge.item(ne)).nodeName!=="x"&&ae.nodeName!=="y"&&ae.nodeName!=="xlink:href"&&ae.nodeName!=="href"&&(ae.nodeName==="transform"?Oe=ae.nodeValue+" "+Oe:ve.setAttribute(ae.nodeName,ae.nodeValue));ve.setAttribute("transform",Oe),ve.setAttribute("instantiated_by_use","1"),ve.removeAttribute("id"),ee.parentNode.replaceChild(ve,ee),Q.length===Ue&&te++}})(A);var H,R,D=i.Object.__uid++,j=G(A),X=i.util.toArray(A.getElementsByTagName("*"));if(j.crossOrigin=W&&W.crossOrigin,j.svgUid=D,X.length===0&&i.isLikelyNode){var U=[];for(H=0,R=(X=A.selectNodes('//*[name(.)!="svg"]')).length;H<R;H++)U[H]=X[H];X=U}var z=X.filter(function(Z){return G(Z),i.svgValidTagNamesRegEx.test(Z.nodeName.replace("svg:",""))&&!function(Q,te){for(;Q&&(Q=Q.parentNode);)if(Q.nodeName&&te.test(Q.nodeName.replace("svg:",""))&&!Q.getAttribute("instantiated_by_use"))return!0;return!1}(Z,i.svgInvalidAncestorsRegEx)});if(!z||z&&!z.length)O&&O([],{});else{var ie={};X.filter(function(Z){return Z.nodeName.replace("svg:","")==="clipPath"}).forEach(function(Z){var Q=Z.getAttribute("id");ie[Q]=i.util.toArray(Z.getElementsByTagName("*")).filter(function(te){return i.svgValidTagNamesRegEx.test(te.nodeName.replace("svg:",""))})}),i.gradientDefs[D]=i.getGradientDefs(A),i.cssRules[D]=i.getCSSRules(A),i.clipPaths[D]=ie,i.parseElements(z,function(Z,Q){O&&(O(Z,j,Q,X),delete i.gradientDefs[D],delete i.cssRules[D],delete i.clipPaths[D])},a(j),B,W)}}};var N=new RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+i.reNum+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+i.reNum+"))?\\s+(.*)");n(i,{parseFontDeclaration:function(A,O){var B=A.match(N);if(B){var W=B[1],H=B[3],R=B[4],D=B[5],j=B[6];W&&(O.fontStyle=W),H&&(O.fontWeight=isNaN(parseFloat(H))?H:parseFloat(H)),R&&(O.fontSize=t(R)),j&&(O.fontFamily=j),D&&(O.lineHeight=D==="normal"?1:D)}},getGradientDefs:function(A){var O,B=y(A,["linearGradient","radialGradient","svg:linearGradient","svg:radialGradient"]),W=0,H={};for(W=B.length;W--;)(O=B[W]).getAttribute("xlink:href")&&V(A,O),H[O.getAttribute("id")]=O;return H},parseAttributes:function(A,O,B){if(A){var W,H,R,D={};B===void 0&&(B=A.getAttribute("svgUid")),A.parentNode&&i.svgValidParentsRegEx.test(A.parentNode.nodeName)&&(D=i.parseAttributes(A.parentNode,O,B));var j=O.reduce(function(te,ee){return(W=A.getAttribute(ee))&&(te[ee]=W),te},{}),X=n(function(te,ee){var re={};for(var ae in i.cssRules[ee])if(w(te,ae.split(" ")))for(var ne in i.cssRules[ee][ae])re[ne]=i.cssRules[ee][ae][ne];return re}(A,B),i.parseStyleAttribute(A));j=n(j,X),X[d]&&A.setAttribute(d,X[d]),H=R=D.fontSize||i.Text.DEFAULT_SVG_FONT_SIZE,j[l]&&(j[l]=H=t(j[l],R));var U,z,ie={};for(var Z in j)z=m(U=p(Z),j[Z],D,H),ie[U]=z;ie&&ie.font&&i.parseFontDeclaration(ie.font,ie);var Q=n(D,ie);return i.svgValidParentsRegEx.test(A.nodeName)?Q:function(te){for(var ee in h)if(te[h[ee]]!==void 0&&te[ee]!==""){if(te[ee]===void 0){if(!i.Object.prototype[ee])continue;te[ee]=i.Object.prototype[ee]}if(te[ee].indexOf("url(")!==0){var re=new i.Color(te[ee]);te[ee]=re.setAlpha(e(re.getAlpha()*te[h[ee]],2)).toRgba()}}return te}(Q)}},parseElements:function(A,O,B,W,H){new i.ElementsParser(A,O,B,W,H).parse()},parseStyleAttribute:function(A){var O={},B=A.getAttribute("style");return B&&(typeof B=="string"?function(W,H){var R,D;W.replace(/;\s*$/,"").split(";").forEach(function(j){var X=j.split(":");R=X[0].trim().toLowerCase(),D=X[1].trim(),H[R]=D})}(B,O):function(W,H){var R,D;for(var j in W)W[j]!==void 0&&(R=j.toLowerCase(),D=W[j],H[R]=D)}(B,O)),O},parsePointsAttribute:function(A){if(!A)return null;var O,B,W=[];for(O=0,B=(A=(A=A.replace(/,/g," ").trim()).split(/\s+/)).length;O<B;O+=2)W.push({x:parseFloat(A[O]),y:parseFloat(A[O+1])});return W},getCSSRules:function(A){var O,B,W=A.getElementsByTagName("style"),H={};for(O=0,B=W.length;O<B;O++){var R=W[O].textContent;(R=R.replace(/\/\*[\s\S]*?\*\//g,"")).trim()!==""&&R.split("}").filter(function(D){return D.trim()}).forEach(function(D){var j=D.split("{"),X={},U=j[1].trim().split(";").filter(function(Q){return Q.trim()});for(O=0,B=U.length;O<B;O++){var z=U[O].split(":"),ie=z[0].trim(),Z=z[1].trim();X[ie]=Z}(D=j[0].trim()).split(",").forEach(function(Q){(Q=Q.replace(/^svg/i,"").trim())!==""&&(H[Q]?i.util.object.extend(H[Q],X):H[Q]=i.util.object.clone(X))})})}return H},loadSVGFromURL:function(A,O,B,W){A=A.replace(/^\n\s*/,"").trim(),new i.util.request(A,{method:"get",onComplete:function(H){var R=H.responseXML;if(!R||!R.documentElement)return O&&O(null),!1;i.parseSVGDocument(R.documentElement,function(D,j,X,U){O&&O(D,j,X,U)},B,W)}})},loadSVGFromString:function(A,O,B,W){var H=new i.window.DOMParser().parseFromString(A.trim(),"text/xml");i.parseSVGDocument(H.documentElement,function(R,D,j,X){O(R,D,j,X)},B,W)}})}(o),g.ElementsParser=function(r,i,n,a,e,t){this.elements=r,this.callback=i,this.options=n,this.reviver=a,this.svgUid=n&&n.svgUid||0,this.parsingOptions=e,this.regexUrl=/^url\(['"]?#([^'"]+)['"]?\)/g,this.doc=t},(J=g.ElementsParser.prototype).parse=function(){this.instances=new Array(this.elements.length),this.numElements=this.elements.length,this.createObjects()},J.createObjects=function(){var r=this;this.elements.forEach(function(i,n){i.setAttribute("svgUid",r.svgUid),r.createObject(i,n)})},J.findTag=function(r){return g[g.util.string.capitalize(r.tagName.replace("svg:",""))]},J.createObject=function(r,i){var n=this.findTag(r);if(n&&n.fromElement)try{n.fromElement(r,this.createCallback(i,r),this.options)}catch(a){g.log(a)}else this.checkIfDone()},J.createCallback=function(r,i){var n=this;return function(a){var e;n.resolveGradient(a,i,"fill"),n.resolveGradient(a,i,"stroke"),a instanceof g.Image&&a._originalElement&&(e=a.parsePreserveAspectRatioAttribute(i)),a._removeTransformMatrix(e),n.resolveClipPath(a,i),n.reviver&&n.reviver(i,a),n.instances[r]=a,n.checkIfDone()}},J.extractPropertyDefinition=function(r,i,n){var a=r[i],e=this.regexUrl;if(e.test(a)){e.lastIndex=0;var t=e.exec(a)[1];return e.lastIndex=0,g[n][this.svgUid][t]}},J.resolveGradient=function(r,i,n){var a=this.extractPropertyDefinition(r,n,"gradientDefs");if(a){var e=i.getAttribute(n+"-opacity"),t=g.Gradient.fromElement(a,r,e,this.options);r.set(n,t)}},J.createClipPathCallback=function(r,i){return function(n){n._removeTransformMatrix(),n.fillRule=n.clipRule,i.push(n)}},J.resolveClipPath=function(r,i){var n,a,e,t,s=this.extractPropertyDefinition(r,"clipPath","clipPaths");if(s){e=[],a=g.util.invertTransform(r.calcTransformMatrix());for(var c=s[0].parentNode,h=i;h.parentNode&&h.getAttribute("clip-path")!==r.clipPath;)h=h.parentNode;h.parentNode.appendChild(c);for(var l=0;l<s.length;l++)n=s[l],this.findTag(n).fromElement(n,this.createClipPathCallback(r,e),this.options);s=e.length===1?e[0]:new g.Group(e),t=g.util.multiplyTransformMatrices(a,s.calcTransformMatrix()),s.clipPath&&this.resolveClipPath(s,h);var d=g.util.qrDecompose(t);s.flipX=!1,s.flipY=!1,s.set("scaleX",d.scaleX),s.set("scaleY",d.scaleY),s.angle=d.angle,s.skewX=d.skewX,s.skewY=0,s.setPositionByOrigin({x:d.translateX,y:d.translateY},"center","center"),r.clipPath=s}else delete r.clipPath},J.checkIfDone=function(){--this.numElements==0&&(this.instances=this.instances.filter(function(r){return r!=null}),this.callback(this.instances,this.elements))},function(r){var i=r.fabric||(r.fabric={});function n(a,e){this.x=a,this.y=e}i.Point?i.warn("fabric.Point is already defined"):(i.Point=n,n.prototype={type:"point",constructor:n,add:function(a){return new n(this.x+a.x,this.y+a.y)},addEquals:function(a){return this.x+=a.x,this.y+=a.y,this},scalarAdd:function(a){return new n(this.x+a,this.y+a)},scalarAddEquals:function(a){return this.x+=a,this.y+=a,this},subtract:function(a){return new n(this.x-a.x,this.y-a.y)},subtractEquals:function(a){return this.x-=a.x,this.y-=a.y,this},scalarSubtract:function(a){return new n(this.x-a,this.y-a)},scalarSubtractEquals:function(a){return this.x-=a,this.y-=a,this},multiply:function(a){return new n(this.x*a,this.y*a)},multiplyEquals:function(a){return this.x*=a,this.y*=a,this},divide:function(a){return new n(this.x/a,this.y/a)},divideEquals:function(a){return this.x/=a,this.y/=a,this},eq:function(a){return this.x===a.x&&this.y===a.y},lt:function(a){return this.x<a.x&&this.y<a.y},lte:function(a){return this.x<=a.x&&this.y<=a.y},gt:function(a){return this.x>a.x&&this.y>a.y},gte:function(a){return this.x>=a.x&&this.y>=a.y},lerp:function(a,e){return e===void 0&&(e=.5),e=Math.max(Math.min(1,e),0),new n(this.x+(a.x-this.x)*e,this.y+(a.y-this.y)*e)},distanceFrom:function(a){var e=this.x-a.x,t=this.y-a.y;return Math.sqrt(e*e+t*t)},midPointFrom:function(a){return this.lerp(a)},min:function(a){return new n(Math.min(this.x,a.x),Math.min(this.y,a.y))},max:function(a){return new n(Math.max(this.x,a.x),Math.max(this.y,a.y))},toString:function(){return this.x+","+this.y},setXY:function(a,e){return this.x=a,this.y=e,this},setX:function(a){return this.x=a,this},setY:function(a){return this.y=a,this},setFromPoint:function(a){return this.x=a.x,this.y=a.y,this},swap:function(a){var e=this.x,t=this.y;this.x=a.x,this.y=a.y,a.x=e,a.y=t},clone:function(){return new n(this.x,this.y)}})}(o),function(r){var i=r.fabric||(r.fabric={});function n(a){this.status=a,this.points=[]}i.Intersection?i.warn("fabric.Intersection is already defined"):(i.Intersection=n,i.Intersection.prototype={constructor:n,appendPoint:function(a){return this.points.push(a),this},appendPoints:function(a){return this.points=this.points.concat(a),this}},i.Intersection.intersectLineLine=function(a,e,t,s){var c,h=(s.x-t.x)*(a.y-t.y)-(s.y-t.y)*(a.x-t.x),l=(e.x-a.x)*(a.y-t.y)-(e.y-a.y)*(a.x-t.x),d=(s.y-t.y)*(e.x-a.x)-(s.x-t.x)*(e.y-a.y);if(d!==0){var p=h/d,m=l/d;0<=p&&p<=1&&0<=m&&m<=1?(c=new n("Intersection")).appendPoint(new i.Point(a.x+p*(e.x-a.x),a.y+p*(e.y-a.y))):c=new n}else c=new n(h===0||l===0?"Coincident":"Parallel");return c},i.Intersection.intersectLinePolygon=function(a,e,t){var s,c,h,l,d=new n,p=t.length;for(l=0;l<p;l++)s=t[l],c=t[(l+1)%p],h=n.intersectLineLine(a,e,s,c),d.appendPoints(h.points);return d.points.length>0&&(d.status="Intersection"),d},i.Intersection.intersectPolygonPolygon=function(a,e){var t,s=new n,c=a.length;for(t=0;t<c;t++){var h=a[t],l=a[(t+1)%c],d=n.intersectLinePolygon(h,l,e);s.appendPoints(d.points)}return s.points.length>0&&(s.status="Intersection"),s},i.Intersection.intersectPolygonRectangle=function(a,e,t){var s=e.min(t),c=e.max(t),h=new i.Point(c.x,s.y),l=new i.Point(s.x,c.y),d=n.intersectLinePolygon(s,h,a),p=n.intersectLinePolygon(h,c,a),m=n.intersectLinePolygon(c,l,a),b=n.intersectLinePolygon(l,s,a),y=new n;return y.appendPoints(d.points),y.appendPoints(p.points),y.appendPoints(m.points),y.appendPoints(b.points),y.points.length>0&&(y.status="Intersection"),y})}(o),function(r){var i=r.fabric||(r.fabric={});function n(e){e?this._tryParsingColor(e):this.setSource([0,0,0,1])}function a(e,t,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?e+6*(t-e)*s:s<.5?t:s<2/3?e+(t-e)*(2/3-s)*6:e}i.Color?i.warn("fabric.Color is already defined."):(i.Color=n,i.Color.prototype={_tryParsingColor:function(e){var t;e in n.colorNameMap&&(e=n.colorNameMap[e]),e==="transparent"&&(t=[255,255,255,0]),t||(t=n.sourceFromHex(e)),t||(t=n.sourceFromRgb(e)),t||(t=n.sourceFromHsl(e)),t||(t=[0,0,0,1]),t&&this.setSource(t)},_rgbToHsl:function(e,t,s){e/=255,t/=255,s/=255;var c,h,l,d=i.util.array.max([e,t,s]),p=i.util.array.min([e,t,s]);if(l=(d+p)/2,d===p)c=h=0;else{var m=d-p;switch(h=l>.5?m/(2-d-p):m/(d+p),d){case e:c=(t-s)/m+(t<s?6:0);break;case t:c=(s-e)/m+2;break;case s:c=(e-t)/m+4}c/=6}return[Math.round(360*c),Math.round(100*h),Math.round(100*l)]},getSource:function(){return this._source},setSource:function(e){this._source=e},toRgb:function(){var e=this.getSource();return"rgb("+e[0]+","+e[1]+","+e[2]+")"},toRgba:function(){var e=this.getSource();return"rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")"},toHsl:function(){var e=this.getSource(),t=this._rgbToHsl(e[0],e[1],e[2]);return"hsl("+t[0]+","+t[1]+"%,"+t[2]+"%)"},toHsla:function(){var e=this.getSource(),t=this._rgbToHsl(e[0],e[1],e[2]);return"hsla("+t[0]+","+t[1]+"%,"+t[2]+"%,"+e[3]+")"},toHex:function(){var e,t,s,c=this.getSource();return e=(e=c[0].toString(16)).length===1?"0"+e:e,t=(t=c[1].toString(16)).length===1?"0"+t:t,s=(s=c[2].toString(16)).length===1?"0"+s:s,e.toUpperCase()+t.toUpperCase()+s.toUpperCase()},toHexa:function(){var e,t=this.getSource();return e=(e=(e=Math.round(255*t[3])).toString(16)).length===1?"0"+e:e,this.toHex()+e.toUpperCase()},getAlpha:function(){return this.getSource()[3]},setAlpha:function(e){var t=this.getSource();return t[3]=e,this.setSource(t),this},toGrayscale:function(){var e=this.getSource(),t=parseInt((.3*e[0]+.59*e[1]+.11*e[2]).toFixed(0),10),s=e[3];return this.setSource([t,t,t,s]),this},toBlackWhite:function(e){var t=this.getSource(),s=(.3*t[0]+.59*t[1]+.11*t[2]).toFixed(0),c=t[3];return e=e||127,s=Number(s)<Number(e)?0:255,this.setSource([s,s,s,c]),this},overlayWith:function(e){e instanceof n||(e=new n(e));var t,s=[],c=this.getAlpha(),h=this.getSource(),l=e.getSource();for(t=0;t<3;t++)s.push(Math.round(.5*h[t]+.5*l[t]));return s[3]=c,this.setSource(s),this}},i.Color.reRGBa=/^rgba?\(\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*(?:\s*,\s*((?:\d*\.?\d+)?)\s*)?\)$/i,i.Color.reHSLa=/^hsla?\(\s*(\d{1,3})\s*,\s*(\d{1,3}\%)\s*,\s*(\d{1,3}\%)\s*(?:\s*,\s*(\d+(?:\.\d+)?)\s*)?\)$/i,i.Color.reHex=/^#?([0-9a-f]{8}|[0-9a-f]{6}|[0-9a-f]{4}|[0-9a-f]{3})$/i,i.Color.colorNameMap={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"},i.Color.fromRgb=function(e){return n.fromSource(n.sourceFromRgb(e))},i.Color.sourceFromRgb=function(e){var t=e.match(n.reRGBa);if(t){var s=parseInt(t[1],10)/(/%$/.test(t[1])?100:1)*(/%$/.test(t[1])?255:1),c=parseInt(t[2],10)/(/%$/.test(t[2])?100:1)*(/%$/.test(t[2])?255:1),h=parseInt(t[3],10)/(/%$/.test(t[3])?100:1)*(/%$/.test(t[3])?255:1);return[parseInt(s,10),parseInt(c,10),parseInt(h,10),t[4]?parseFloat(t[4]):1]}},i.Color.fromRgba=n.fromRgb,i.Color.fromHsl=function(e){return n.fromSource(n.sourceFromHsl(e))},i.Color.sourceFromHsl=function(e){var t=e.match(n.reHSLa);if(t){var s,c,h,l=(parseFloat(t[1])%360+360)%360/360,d=parseFloat(t[2])/(/%$/.test(t[2])?100:1),p=parseFloat(t[3])/(/%$/.test(t[3])?100:1);if(d===0)s=c=h=p;else{var m=p<=.5?p*(d+1):p+d-p*d,b=2*p-m;s=a(b,m,l+1/3),c=a(b,m,l),h=a(b,m,l-1/3)}return[Math.round(255*s),Math.round(255*c),Math.round(255*h),t[4]?parseFloat(t[4]):1]}},i.Color.fromHsla=n.fromHsl,i.Color.fromHex=function(e){return n.fromSource(n.sourceFromHex(e))},i.Color.sourceFromHex=function(e){if(e.match(n.reHex)){var t=e.slice(e.indexOf("#")+1),s=t.length===3||t.length===4,c=t.length===8||t.length===4,h=s?t.charAt(0)+t.charAt(0):t.substring(0,2),l=s?t.charAt(1)+t.charAt(1):t.substring(2,4),d=s?t.charAt(2)+t.charAt(2):t.substring(4,6),p=c?s?t.charAt(3)+t.charAt(3):t.substring(6,8):"FF";return[parseInt(h,16),parseInt(l,16),parseInt(d,16),parseFloat((parseInt(p,16)/255).toFixed(2))]}},i.Color.fromSource=function(e){var t=new n;return t.setSource(e),t})}(o),function(r){var i=r.fabric||(r.fabric={}),n=["e","se","s","sw","w","nw","n","ne","e"],a=["ns","nesw","ew","nwse"],e={},t="left",s="top",c="right",h="bottom",l="center",d={top:h,bottom:s,left:c,right:t,center:l},p=i.util.radiansToDegrees,m=Math.sign||function(R){return(R>0)-(R<0)||+R};function b(R,D){var j=R.angle+p(Math.atan2(D.y,D.x))+360;return Math.round(j%360/45)}function y(R,D){var j=D.transform.target,X=j.canvas,U=i.util.object.clone(D);U.target=j,X&&X.fire("object:"+R,U),j.fire(R,D)}function w(R,D){var j=D.canvas,X=R[j.uniScaleKey];return j.uniformScaling&&!X||!j.uniformScaling&&X}function T(R){return R.originX===l&&R.originY===l}function k(R,D,j){var X=R.lockScalingX,U=R.lockScalingY;return!((!X||!U)&&(D||!X&&!U||!j)&&(!X||D!=="x")&&(!U||D!=="y"))}function P(R,D,j,X){return{e:R,transform:D,pointer:{x:j,y:X}}}function G(R){return function(D,j,X,U){var z=j.target,ie=z.getCenterPoint(),Z=z.translateToOriginPoint(ie,j.originX,j.originY),Q=R(D,j,X,U);return z.setPositionByOrigin(Z,j.originX,j.originY),Q}}function V(R,D){return function(j,X,U,z){var ie=D(j,X,U,z);return ie&&y(R,P(j,X,U,z)),ie}}function N(R,D,j,X,U){var z=R.target,ie=z.controls[R.corner],Z=z.canvas.getZoom(),Q=z.padding/Z,te=z.toLocalPoint(new i.Point(X,U),D,j);return te.x>=Q&&(te.x-=Q),te.x<=-Q&&(te.x+=Q),te.y>=Q&&(te.y-=Q),te.y<=Q&&(te.y+=Q),te.x-=ie.offsetX,te.y-=ie.offsetY,te}function A(R){return R.flipX!==R.flipY}function O(R,D,j,X,U){if(R[D]!==0){var z=U/R._getTransformedDimensions()[X]*R[j];R.set(j,z)}}function B(R,D,j,X){var U,z=D.target,ie=z._getTransformedDimensions(0,z.skewY),Z=N(D,D.originX,D.originY,j,X),Q=Math.abs(2*Z.x)-ie.x,te=z.skewX;Q<2?U=0:(U=p(Math.atan2(Q/z.scaleX,ie.y/z.scaleY)),D.originX===t&&D.originY===h&&(U=-U),D.originX===c&&D.originY===s&&(U=-U),A(z)&&(U=-U));var ee=te!==U;if(ee){var re=z._getTransformedDimensions().y;z.set("skewX",U),O(z,"skewY","scaleY","y",re)}return ee}function W(R,D,j,X){var U,z=D.target,ie=z._getTransformedDimensions(z.skewX,0),Z=N(D,D.originX,D.originY,j,X),Q=Math.abs(2*Z.y)-ie.y,te=z.skewY;Q<2?U=0:(U=p(Math.atan2(Q/z.scaleY,ie.x/z.scaleX)),D.originX===t&&D.originY===h&&(U=-U),D.originX===c&&D.originY===s&&(U=-U),A(z)&&(U=-U));var ee=te!==U;if(ee){var re=z._getTransformedDimensions().x;z.set("skewY",U),O(z,"skewX","scaleX","x",re)}return ee}function H(R,D,j,X,U){U=U||{};var z,ie,Z,Q,te,ee,re=D.target,ae=re.lockScalingX,ne=re.lockScalingY,ge=U.by,me=w(R,re),Te=k(re,ge,me),Ie=D.gestureScale;if(Te)return!1;if(Ie)ie=D.scaleX*Ie,Z=D.scaleY*Ie;else{if(z=N(D,D.originX,D.originY,j,X),te=ge!=="y"?m(z.x):1,ee=ge!=="x"?m(z.y):1,D.signX||(D.signX=te),D.signY||(D.signY=ee),re.lockScalingFlip&&(D.signX!==te||D.signY!==ee))return!1;if(Q=re._getTransformedDimensions(),me&&!ge){var je=Math.abs(z.x)+Math.abs(z.y),ve=D.original,Oe=je/(Math.abs(Q.x*ve.scaleX/re.scaleX)+Math.abs(Q.y*ve.scaleY/re.scaleY));ie=ve.scaleX*Oe,Z=ve.scaleY*Oe}else ie=Math.abs(z.x*re.scaleX/Q.x),Z=Math.abs(z.y*re.scaleY/Q.y);T(D)&&(ie*=2,Z*=2),D.signX!==te&&ge!=="y"&&(D.originX=d[D.originX],ie*=-1,D.signX=te),D.signY!==ee&&ge!=="x"&&(D.originY=d[D.originY],Z*=-1,D.signY=ee)}var Ue=re.scaleX,Ne=re.scaleY;return ge?(ge==="x"&&re.set("scaleX",ie),ge==="y"&&re.set("scaleY",Z)):(!ae&&re.set("scaleX",ie),!ne&&re.set("scaleY",Z)),Ue!==re.scaleX||Ne!==re.scaleY}e.scaleCursorStyleHandler=function(R,D,j){var X=w(R,j),U="";if(D.x!==0&&D.y===0?U="x":D.x===0&&D.y!==0&&(U="y"),k(j,U,X))return"not-allowed";var z=b(j,D);return n[z]+"-resize"},e.skewCursorStyleHandler=function(R,D,j){var X="not-allowed";if(D.x!==0&&j.lockSkewingY||D.y!==0&&j.lockSkewingX)return X;var U=b(j,D)%4;return a[U]+"-resize"},e.scaleSkewCursorStyleHandler=function(R,D,j){return R[j.canvas.altActionKey]?e.skewCursorStyleHandler(R,D,j):e.scaleCursorStyleHandler(R,D,j)},e.rotationWithSnapping=V("rotating",G(function(R,D,j,X){var U=D,z=U.target,ie=z.translateToOriginPoint(z.getCenterPoint(),U.originX,U.originY);if(z.lockRotation)return!1;var Z,Q=Math.atan2(U.ey-ie.y,U.ex-ie.x),te=Math.atan2(X-ie.y,j-ie.x),ee=p(te-Q+U.theta);if(z.snapAngle>0){var re=z.snapAngle,ae=z.snapThreshold||re,ne=Math.ceil(ee/re)*re,ge=Math.floor(ee/re)*re;Math.abs(ee-ge)<ae?ee=ge:Math.abs(ee-ne)<ae&&(ee=ne)}return ee<0&&(ee=360+ee),ee%=360,Z=z.angle!==ee,z.angle=ee,Z})),e.scalingEqually=V("scaling",G(function(R,D,j,X){return H(R,D,j,X)})),e.scalingX=V("scaling",G(function(R,D,j,X){return H(R,D,j,X,{by:"x"})})),e.scalingY=V("scaling",G(function(R,D,j,X){return H(R,D,j,X,{by:"y"})})),e.scalingYOrSkewingX=function(R,D,j,X){return R[D.target.canvas.altActionKey]?e.skewHandlerX(R,D,j,X):e.scalingY(R,D,j,X)},e.scalingXOrSkewingY=function(R,D,j,X){return R[D.target.canvas.altActionKey]?e.skewHandlerY(R,D,j,X):e.scalingX(R,D,j,X)},e.changeWidth=V("resizing",G(function(R,D,j,X){var U=D.target,z=N(D,D.originX,D.originY,j,X),ie=U.strokeWidth/(U.strokeUniform?U.scaleX:1),Z=T(D)?2:1,Q=U.width,te=Math.abs(z.x*Z/U.scaleX)-ie;return U.set("width",Math.max(te,0)),Q!==te})),e.skewHandlerX=function(R,D,j,X){var U,z=D.target,ie=z.skewX,Z=D.originY;return!z.lockSkewingX&&(ie===0?U=N(D,l,l,j,X).x>0?t:c:(ie>0&&(U=Z===s?t:c),ie<0&&(U=Z===s?c:t),A(z)&&(U=U===t?c:t)),D.originX=U,V("skewing",G(B))(R,D,j,X))},e.skewHandlerY=function(R,D,j,X){var U,z=D.target,ie=z.skewY,Z=D.originX;return!z.lockSkewingY&&(ie===0?U=N(D,l,l,j,X).y>0?s:h:(ie>0&&(U=Z===t?s:h),ie<0&&(U=Z===t?h:s),A(z)&&(U=U===s?h:s)),D.originY=U,V("skewing",G(W))(R,D,j,X))},e.dragHandler=function(R,D,j,X){var U=D.target,z=j-D.offsetX,ie=X-D.offsetY,Z=!U.get("lockMovementX")&&U.left!==z,Q=!U.get("lockMovementY")&&U.top!==ie;return Z&&U.set("left",z),Q&&U.set("top",ie),(Z||Q)&&y("moving",P(R,D,j,X)),Z||Q},e.scaleOrSkewActionName=function(R,D,j){var X=R[j.canvas.altActionKey];return D.x===0?X?"skewX":"scaleY":D.y===0?X?"skewY":"scaleX":void 0},e.rotationStyleHandler=function(R,D,j){return j.lockRotation?"not-allowed":D.cursorStyle},e.fireEvent=y,e.wrapWithFixedAnchor=G,e.wrapWithFireEvent=V,e.getLocalPoint=N,i.controlsUtils=e}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.util.degreesToRadians,a=i.controlsUtils;a.renderCircleControl=function(e,t,s,c,h){c=c||{};var l,d=this.sizeX||c.cornerSize||h.cornerSize,p=this.sizeY||c.cornerSize||h.cornerSize,m=c.transparentCorners!==void 0?c.transparentCorners:h.transparentCorners,b=m?"stroke":"fill",y=!m&&(c.cornerStrokeColor||h.cornerStrokeColor),w=t,T=s;e.save(),e.fillStyle=c.cornerColor||h.cornerColor,e.strokeStyle=c.cornerStrokeColor||h.cornerStrokeColor,d>p?(l=d,e.scale(1,p/d),T=s*d/p):p>d?(l=p,e.scale(d/p,1),w=t*p/d):l=d,e.lineWidth=1,e.beginPath(),e.arc(w,T,l/2,0,2*Math.PI,!1),e[b](),y&&e.stroke(),e.restore()},a.renderSquareControl=function(e,t,s,c,h){c=c||{};var l=this.sizeX||c.cornerSize||h.cornerSize,d=this.sizeY||c.cornerSize||h.cornerSize,p=c.transparentCorners!==void 0?c.transparentCorners:h.transparentCorners,m=p?"stroke":"fill",b=!p&&(c.cornerStrokeColor||h.cornerStrokeColor),y=l/2,w=d/2;e.save(),e.fillStyle=c.cornerColor||h.cornerColor,e.strokeStyle=c.cornerStrokeColor||h.cornerStrokeColor,e.lineWidth=1,e.translate(t,s),e.rotate(n(h.angle)),e[m+"Rect"](-y,-w,l,d),b&&e.strokeRect(-y,-w,l,d),e.restore()}}(o),function(r){var i=r.fabric||(r.fabric={});i.Control=function(n){for(var a in n)this[a]=n[a]},i.Control.prototype={visible:!0,actionName:"scale",angle:0,x:0,y:0,offsetX:0,offsetY:0,sizeX:null,sizeY:null,touchSizeX:null,touchSizeY:null,cursorStyle:"crosshair",withConnection:!1,actionHandler:function(){},mouseDownHandler:function(){},mouseUpHandler:function(){},getActionHandler:function(){return this.actionHandler},getMouseDownHandler:function(){return this.mouseDownHandler},getMouseUpHandler:function(){return this.mouseUpHandler},cursorStyleHandler:function(n,a){return a.cursorStyle},getActionName:function(n,a){return a.actionName},getVisibility:function(n,a){var e=n._controlsVisibility;return e&&e[a]!==void 0?e[a]:this.visible},setVisibility:function(n){this.visible=n},positionHandler:function(n,a){return i.util.transformPoint({x:this.x*n.x+this.offsetX,y:this.y*n.y+this.offsetY},a)},calcCornerCoords:function(n,a,e,t,s){var c,h,l,d,p=s?this.touchSizeX:this.sizeX,m=s?this.touchSizeY:this.sizeY;if(p&&m&&p!==m){var b=Math.atan2(m,p),y=Math.sqrt(p*p+m*m)/2,w=b-i.util.degreesToRadians(n),T=Math.PI/2-b-i.util.degreesToRadians(n);c=y*i.util.cos(w),h=y*i.util.sin(w),l=y*i.util.cos(T),d=y*i.util.sin(T)}else y=.7071067812*(p&&m?p:a),w=i.util.degreesToRadians(45-n),c=l=y*i.util.cos(w),h=d=y*i.util.sin(w);return{tl:{x:e-d,y:t-l},tr:{x:e+c,y:t-h},bl:{x:e-c,y:t+h},br:{x:e+d,y:t+l}}},render:function(n,a,e,t,s){((t=t||{}).cornerStyle||s.cornerStyle)==="circle"?i.controlsUtils.renderCircleControl.call(this,n,a,e,t,s):i.controlsUtils.renderSquareControl.call(this,n,a,e,t,s)}}}(o),function(){function r(n,a){var e,t,s,c,h=n.getAttribute("style"),l=n.getAttribute("offset")||0;if(l=(l=parseFloat(l)/(/%$/.test(l)?100:1))<0?0:l>1?1:l,h){var d=h.split(/\s*;\s*/);for(d[d.length-1]===""&&d.pop(),c=d.length;c--;){var p=d[c].split(/\s*:\s*/),m=p[0].trim(),b=p[1].trim();m==="stop-color"?e=b:m==="stop-opacity"&&(s=b)}}return e||(e=n.getAttribute("stop-color")||"rgb(0,0,0)"),s||(s=n.getAttribute("stop-opacity")),t=(e=new g.Color(e)).getAlpha(),s=isNaN(parseFloat(s))?1:parseFloat(s),s*=t*a,{offset:l,color:e.toRgb(),opacity:s}}var i=g.util.object.clone;g.Gradient=g.util.createClass({offsetX:0,offsetY:0,gradientTransform:null,gradientUnits:"pixels",type:"linear",initialize:function(n){n||(n={}),n.coords||(n.coords={});var a,e=this;Object.keys(n).forEach(function(t){e[t]=n[t]}),this.id?this.id+="_"+g.Object.__uid++:this.id=g.Object.__uid++,a={x1:n.coords.x1||0,y1:n.coords.y1||0,x2:n.coords.x2||0,y2:n.coords.y2||0},this.type==="radial"&&(a.r1=n.coords.r1||0,a.r2=n.coords.r2||0),this.coords=a,this.colorStops=n.colorStops.slice()},addColorStop:function(n){for(var a in n){var e=new g.Color(n[a]);this.colorStops.push({offset:parseFloat(a),color:e.toRgb(),opacity:e.getAlpha()})}return this},toObject:function(n){var a={type:this.type,coords:this.coords,colorStops:this.colorStops,offsetX:this.offsetX,offsetY:this.offsetY,gradientUnits:this.gradientUnits,gradientTransform:this.gradientTransform?this.gradientTransform.concat():this.gradientTransform};return g.util.populateWithProperties(this,a,n),a},toSVG:function(n,a){var e,t,s,c,h=i(this.coords,!0),l=(a=a||{},i(this.colorStops,!0)),d=h.r1>h.r2,p=this.gradientTransform?this.gradientTransform.concat():g.iMatrix.concat(),m=-this.offsetX,b=-this.offsetY,y=!!a.additionalTransform,w=this.gradientUnits==="pixels"?"userSpaceOnUse":"objectBoundingBox";if(l.sort(function(G,V){return G.offset-V.offset}),w==="objectBoundingBox"?(m/=n.width,b/=n.height):(m+=n.width/2,b+=n.height/2),n.type==="path"&&this.gradientUnits!=="percentage"&&(m-=n.pathOffset.x,b-=n.pathOffset.y),p[4]-=m,p[5]-=b,c='id="SVGID_'+this.id+'" gradientUnits="'+w+'"',c+=' gradientTransform="'+(y?a.additionalTransform+" ":"")+g.util.matrixToSVG(p)+'" ',this.type==="linear"?s=["<linearGradient ",c,' x1="',h.x1,'" y1="',h.y1,'" x2="',h.x2,'" y2="',h.y2,'">\n']:this.type==="radial"&&(s=["<radialGradient ",c,' cx="',d?h.x1:h.x2,'" cy="',d?h.y1:h.y2,'" r="',d?h.r1:h.r2,'" fx="',d?h.x2:h.x1,'" fy="',d?h.y2:h.y1,'">\n']),this.type==="radial"){if(d)for((l=l.concat()).reverse(),e=0,t=l.length;e<t;e++)l[e].offset=1-l[e].offset;var T=Math.min(h.r1,h.r2);if(T>0){var k=T/Math.max(h.r1,h.r2);for(e=0,t=l.length;e<t;e++)l[e].offset+=k*(1-l[e].offset)}}for(e=0,t=l.length;e<t;e++){var P=l[e];s.push("<stop ",'offset="',100*P.offset+"%",'" style="stop-color:',P.color,P.opacity!==void 0?";stop-opacity: "+P.opacity:";",'"/>\n')}return s.push(this.type==="linear"?"</linearGradient>\n":"</radialGradient>\n"),s.join("")},toLive:function(n){var a,e,t,s=g.util.object.clone(this.coords);if(this.type){for(this.type==="linear"?a=n.createLinearGradient(s.x1,s.y1,s.x2,s.y2):this.type==="radial"&&(a=n.createRadialGradient(s.x1,s.y1,s.r1,s.x2,s.y2,s.r2)),e=0,t=this.colorStops.length;e<t;e++){var c=this.colorStops[e].color,h=this.colorStops[e].opacity,l=this.colorStops[e].offset;h!==void 0&&(c=new g.Color(c).setAlpha(h).toRgba()),a.addColorStop(l,c)}return a}}}),g.util.object.extend(g.Gradient,{fromElement:function(n,a,e,t){var s=parseFloat(e)/(/%$/.test(e)?100:1);s=s<0?0:s>1?1:s,isNaN(s)&&(s=1);var c,h,l,d,p=n.getElementsByTagName("stop"),m=n.getAttribute("gradientUnits")==="userSpaceOnUse"?"pixels":"percentage",b=n.getAttribute("gradientTransform")||"",y=[],w=0,T=0;for(n.nodeName==="linearGradient"||n.nodeName==="LINEARGRADIENT"?(c="linear",h=function(k){return{x1:k.getAttribute("x1")||0,y1:k.getAttribute("y1")||0,x2:k.getAttribute("x2")||"100%",y2:k.getAttribute("y2")||0}}(n)):(c="radial",h=function(k){return{x1:k.getAttribute("fx")||k.getAttribute("cx")||"50%",y1:k.getAttribute("fy")||k.getAttribute("cy")||"50%",r1:0,x2:k.getAttribute("cx")||"50%",y2:k.getAttribute("cy")||"50%",r2:k.getAttribute("r")||"50%"}}(n)),l=p.length;l--;)y.push(r(p[l],s));return d=g.parseTransformAttribute(b),function(k,P,G,V){var N,A;Object.keys(P).forEach(function(O){(N=P[O])==="Infinity"?A=1:N==="-Infinity"?A=0:(A=parseFloat(P[O],10),typeof N=="string"&&/^(\d+\.\d+)%|(\d+)%$/.test(N)&&(A*=.01,V==="pixels"&&(O!=="x1"&&O!=="x2"&&O!=="r2"||(A*=G.viewBoxWidth||G.width),O!=="y1"&&O!=="y2"||(A*=G.viewBoxHeight||G.height)))),P[O]=A})}(0,h,t,m),m==="pixels"&&(w=-a.left,T=-a.top),new g.Gradient({id:n.getAttribute("id"),type:c,coords:h,colorStops:y,gradientUnits:m,gradientTransform:d,offsetX:w,offsetY:T})}})}(),le=g.util.toFixed,g.Pattern=g.util.createClass({repeat:"repeat",offsetX:0,offsetY:0,crossOrigin:"",patternTransform:null,initialize:function(r,i){if(r||(r={}),this.id=g.Object.__uid++,this.setOptions(r),!r.source||r.source&&typeof r.source!="string")i&&i(this);else{var n=this;this.source=g.util.createImage(),g.util.loadImage(r.source,function(a,e){n.source=a,i&&i(n,e)},null,this.crossOrigin)}},toObject:function(r){var i,n,a=g.Object.NUM_FRACTION_DIGITS;return typeof this.source.src=="string"?i=this.source.src:typeof this.source=="object"&&this.source.toDataURL&&(i=this.source.toDataURL()),n={type:"pattern",source:i,repeat:this.repeat,crossOrigin:this.crossOrigin,offsetX:le(this.offsetX,a),offsetY:le(this.offsetY,a),patternTransform:this.patternTransform?this.patternTransform.concat():null},g.util.populateWithProperties(this,n,r),n},toSVG:function(r){var i=typeof this.source=="function"?this.source():this.source,n=i.width/r.width,a=i.height/r.height,e=this.offsetX/r.width,t=this.offsetY/r.height,s="";return this.repeat!=="repeat-x"&&this.repeat!=="no-repeat"||(a=1,t&&(a+=Math.abs(t))),this.repeat!=="repeat-y"&&this.repeat!=="no-repeat"||(n=1,e&&(n+=Math.abs(e))),i.src?s=i.src:i.toDataURL&&(s=i.toDataURL()),'<pattern id="SVGID_'+this.id+'" x="'+e+'" y="'+t+'" width="'+n+'" height="'+a+'">\n<image x="0" y="0" width="'+i.width+'" height="'+i.height+'" xlink:href="'+s+'"></image>\n</pattern>\n'},setOptions:function(r){for(var i in r)this[i]=r[i]},toLive:function(r){var i=this.source;return!i||i.src!==void 0&&(!i.complete||i.naturalWidth===0||i.naturalHeight===0)?"":r.createPattern(i,this.repeat)}}),function(r){var i=r.fabric||(r.fabric={}),n=i.util.toFixed;i.Shadow?i.warn("fabric.Shadow is already defined."):(i.Shadow=i.util.createClass({color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,nonScaling:!1,initialize:function(a){for(var e in typeof a=="string"&&(a=this._parseShadow(a)),a)this[e]=a[e];this.id=i.Object.__uid++},_parseShadow:function(a){var e=a.trim(),t=i.Shadow.reOffsetsAndBlur.exec(e)||[];return{color:(e.replace(i.Shadow.reOffsetsAndBlur,"")||"rgb(0,0,0)").trim(),offsetX:parseFloat(t[1],10)||0,offsetY:parseFloat(t[2],10)||0,blur:parseFloat(t[3],10)||0}},toString:function(){return[this.offsetX,this.offsetY,this.blur,this.color].join("px ")},toSVG:function(a){var e=40,t=40,s=i.Object.NUM_FRACTION_DIGITS,c=i.util.rotateVector({x:this.offsetX,y:this.offsetY},i.util.degreesToRadians(-a.angle)),h=new i.Color(this.color);return a.width&&a.height&&(e=100*n((Math.abs(c.x)+this.blur)/a.width,s)+20,t=100*n((Math.abs(c.y)+this.blur)/a.height,s)+20),a.flipX&&(c.x*=-1),a.flipY&&(c.y*=-1),'<filter id="SVGID_'+this.id+'" y="-'+t+'%" height="'+(100+2*t)+'%" x="-'+e+'%" width="'+(100+2*e)+'%" >\n	<feGaussianBlur in="SourceAlpha" stdDeviation="'+n(this.blur?this.blur/2:0,s)+'"></feGaussianBlur>\n	<feOffset dx="'+n(c.x,s)+'" dy="'+n(c.y,s)+'" result="oBlur" ></feOffset>\n	<feFlood flood-color="'+h.toRgb()+'" flood-opacity="'+h.getAlpha()+'"/>\n	<feComposite in2="oBlur" operator="in" />\n	<feMerge>\n		<feMergeNode></feMergeNode>\n		<feMergeNode in="SourceGraphic"></feMergeNode>\n	</feMerge>\n</filter>\n'},toObject:function(){if(this.includeDefaultValues)return{color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY,affectStroke:this.affectStroke,nonScaling:this.nonScaling};var a={},e=i.Shadow.prototype;return["color","blur","offsetX","offsetY","affectStroke","nonScaling"].forEach(function(t){this[t]!==e[t]&&(a[t]=this[t])},this),a}}),i.Shadow.reOffsetsAndBlur=/(?:\s|^)(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(\d+(?:\.\d*)?(?:px)?)?(?:\s?|$)(?:$|\s)/)}(o),function(){if(g.StaticCanvas)g.warn("fabric.StaticCanvas is already defined.");else{var r=g.util.object.extend,i=g.util.getElementOffset,n=g.util.removeFromArray,a=g.util.toFixed,e=g.util.transformPoint,t=g.util.invertTransform,s=g.util.getNodeCanvas,c=g.util.createCanvasElement,h=new Error("Could not initialize `canvas` element");g.StaticCanvas=g.util.createClass(g.CommonMethods,{initialize:function(l,d){d||(d={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(l,d)},backgroundColor:"",backgroundImage:null,overlayColor:"",overlayImage:null,includeDefaultValues:!0,stateful:!1,renderOnAddRemove:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,imageSmoothingEnabled:!0,viewportTransform:g.iMatrix.concat(),backgroundVpt:!0,overlayVpt:!0,enableRetinaScaling:!0,vptCoords:{},skipOffscreen:!0,clipPath:void 0,_initStatic:function(l,d){var p=this.requestRenderAllBound;this._objects=[],this._createLowerCanvas(l),this._initOptions(d),this.interactive||this._initRetinaScaling(),d.overlayImage&&this.setOverlayImage(d.overlayImage,p),d.backgroundImage&&this.setBackgroundImage(d.backgroundImage,p),d.backgroundColor&&this.setBackgroundColor(d.backgroundColor,p),d.overlayColor&&this.setOverlayColor(d.overlayColor,p),this.calcOffset()},_isRetinaScaling:function(){return g.devicePixelRatio>1&&this.enableRetinaScaling},getRetinaScaling:function(){return this._isRetinaScaling()?Math.max(1,g.devicePixelRatio):1},_initRetinaScaling:function(){if(this._isRetinaScaling()){var l=g.devicePixelRatio;this.__initRetinaScaling(l,this.lowerCanvasEl,this.contextContainer),this.upperCanvasEl&&this.__initRetinaScaling(l,this.upperCanvasEl,this.contextTop)}},__initRetinaScaling:function(l,d,p){d.setAttribute("width",this.width*l),d.setAttribute("height",this.height*l),p.scale(l,l)},calcOffset:function(){return this._offset=i(this.lowerCanvasEl),this},setOverlayImage:function(l,d,p){return this.__setBgOverlayImage("overlayImage",l,d,p)},setBackgroundImage:function(l,d,p){return this.__setBgOverlayImage("backgroundImage",l,d,p)},setOverlayColor:function(l,d){return this.__setBgOverlayColor("overlayColor",l,d)},setBackgroundColor:function(l,d){return this.__setBgOverlayColor("backgroundColor",l,d)},__setBgOverlayImage:function(l,d,p,m){return typeof d=="string"?g.util.loadImage(d,function(b,y){if(b){var w=new g.Image(b,m);this[l]=w,w.canvas=this}p&&p(b,y)},this,m&&m.crossOrigin):(m&&d.setOptions(m),this[l]=d,d&&(d.canvas=this),p&&p(d,!1)),this},__setBgOverlayColor:function(l,d,p){return this[l]=d,this._initGradient(d,l),this._initPattern(d,l,p),this},_createCanvasElement:function(){var l=c();if(!l||(l.style||(l.style={}),l.getContext===void 0))throw h;return l},_initOptions:function(l){var d=this.lowerCanvasEl;this._setOptions(l),this.width=this.width||parseInt(d.width,10)||0,this.height=this.height||parseInt(d.height,10)||0,this.lowerCanvasEl.style&&(d.width=this.width,d.height=this.height,d.style.width=this.width+"px",d.style.height=this.height+"px",this.viewportTransform=this.viewportTransform.slice())},_createLowerCanvas:function(l){l&&l.getContext?this.lowerCanvasEl=l:this.lowerCanvasEl=g.util.getById(l)||this._createCanvasElement(),g.util.addClass(this.lowerCanvasEl,"lower-canvas"),this._originalCanvasStyle=this.lowerCanvasEl.style,this.interactive&&this._applyCanvasStyle(this.lowerCanvasEl),this.contextContainer=this.lowerCanvasEl.getContext("2d")},getWidth:function(){return this.width},getHeight:function(){return this.height},setWidth:function(l,d){return this.setDimensions({width:l},d)},setHeight:function(l,d){return this.setDimensions({height:l},d)},setDimensions:function(l,d){var p;for(var m in d=d||{},l)p=l[m],d.cssOnly||(this._setBackstoreDimension(m,l[m]),p+="px",this.hasLostContext=!0),d.backstoreOnly||this._setCssDimension(m,p);return this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(this.contextTop),this._initRetinaScaling(),this.calcOffset(),d.cssOnly||this.requestRenderAll(),this},_setBackstoreDimension:function(l,d){return this.lowerCanvasEl[l]=d,this.upperCanvasEl&&(this.upperCanvasEl[l]=d),this.cacheCanvasEl&&(this.cacheCanvasEl[l]=d),this[l]=d,this},_setCssDimension:function(l,d){return this.lowerCanvasEl.style[l]=d,this.upperCanvasEl&&(this.upperCanvasEl.style[l]=d),this.wrapperEl&&(this.wrapperEl.style[l]=d),this},getZoom:function(){return this.viewportTransform[0]},setViewportTransform:function(l){var d,p,m,b=this._activeObject,y=this.backgroundImage,w=this.overlayImage;for(this.viewportTransform=l,p=0,m=this._objects.length;p<m;p++)(d=this._objects[p]).group||d.setCoords(!0);return b&&b.setCoords(),y&&y.setCoords(!0),w&&w.setCoords(!0),this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll(),this},zoomToPoint:function(l,d){var p=l,m=this.viewportTransform.slice(0);l=e(l,t(this.viewportTransform)),m[0]=d,m[3]=d;var b=e(l,m);return m[4]+=p.x-b.x,m[5]+=p.y-b.y,this.setViewportTransform(m)},setZoom:function(l){return this.zoomToPoint(new g.Point(0,0),l),this},absolutePan:function(l){var d=this.viewportTransform.slice(0);return d[4]=-l.x,d[5]=-l.y,this.setViewportTransform(d)},relativePan:function(l){return this.absolutePan(new g.Point(-l.x-this.viewportTransform[4],-l.y-this.viewportTransform[5]))},getElement:function(){return this.lowerCanvasEl},_onObjectAdded:function(l){this.stateful&&l.setupState(),l._set("canvas",this),l.setCoords(),this.fire("object:added",{target:l}),l.fire("added")},_onObjectRemoved:function(l){this.fire("object:removed",{target:l}),l.fire("removed"),delete l.canvas},clearContext:function(l){return l.clearRect(0,0,this.width,this.height),this},getContext:function(){return this.contextContainer},clear:function(){return this.remove.apply(this,this.getObjects()),this.backgroundImage=null,this.overlayImage=null,this.backgroundColor="",this.overlayColor="",this._hasITextHandlers&&(this.off("mouse:up",this._mouseUpITextHandler),this._iTextInstances=null,this._hasITextHandlers=!1),this.clearContext(this.contextContainer),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll(),this},renderAll:function(){var l=this.contextContainer;return this.renderCanvas(l,this._objects),this},renderAndReset:function(){this.isRendering=0,this.renderAll()},requestRenderAll:function(){return this.isRendering||(this.isRendering=g.util.requestAnimFrame(this.renderAndResetBound)),this},calcViewportBoundaries:function(){var l={},d=this.width,p=this.height,m=t(this.viewportTransform);return l.tl=e({x:0,y:0},m),l.br=e({x:d,y:p},m),l.tr=new g.Point(l.br.x,l.tl.y),l.bl=new g.Point(l.tl.x,l.br.y),this.vptCoords=l,l},cancelRequestedRender:function(){this.isRendering&&(g.util.cancelAnimFrame(this.isRendering),this.isRendering=0)},renderCanvas:function(l,d){var p=this.viewportTransform,m=this.clipPath;this.cancelRequestedRender(),this.calcViewportBoundaries(),this.clearContext(l),g.util.setImageSmoothing(l,this.imageSmoothingEnabled),this.fire("before:render",{ctx:l}),this._renderBackground(l),l.save(),l.transform(p[0],p[1],p[2],p[3],p[4],p[5]),this._renderObjects(l,d),l.restore(),!this.controlsAboveOverlay&&this.interactive&&this.drawControls(l),m&&(m.canvas=this,m.shouldCache(),m._transformDone=!0,m.renderCache({forClipping:!0}),this.drawClipPathOnCanvas(l)),this._renderOverlay(l),this.controlsAboveOverlay&&this.interactive&&this.drawControls(l),this.fire("after:render",{ctx:l})},drawClipPathOnCanvas:function(l){var d=this.viewportTransform,p=this.clipPath;l.save(),l.transform(d[0],d[1],d[2],d[3],d[4],d[5]),l.globalCompositeOperation="destination-in",p.transform(l),l.scale(1/p.zoomX,1/p.zoomY),l.drawImage(p._cacheCanvas,-p.cacheTranslationX,-p.cacheTranslationY),l.restore()},_renderObjects:function(l,d){var p,m;for(p=0,m=d.length;p<m;++p)d[p]&&d[p].render(l)},_renderBackgroundOrOverlay:function(l,d){var p=this[d+"Color"],m=this[d+"Image"],b=this.viewportTransform,y=this[d+"Vpt"];if(p||m){if(p){l.save(),l.beginPath(),l.moveTo(0,0),l.lineTo(this.width,0),l.lineTo(this.width,this.height),l.lineTo(0,this.height),l.closePath(),l.fillStyle=p.toLive?p.toLive(l,this):p,y&&l.transform(b[0],b[1],b[2],b[3],b[4],b[5]),l.transform(1,0,0,1,p.offsetX||0,p.offsetY||0);var w=p.gradientTransform||p.patternTransform;w&&l.transform(w[0],w[1],w[2],w[3],w[4],w[5]),l.fill(),l.restore()}m&&(l.save(),y&&l.transform(b[0],b[1],b[2],b[3],b[4],b[5]),m.render(l),l.restore())}},_renderBackground:function(l){this._renderBackgroundOrOverlay(l,"background")},_renderOverlay:function(l){this._renderBackgroundOrOverlay(l,"overlay")},getCenter:function(){return{top:this.height/2,left:this.width/2}},getCenterPoint:function(){return new g.Point(this.width/2,this.height/2)},centerObjectH:function(l){return this._centerObject(l,new g.Point(this.getCenterPoint().x,l.getCenterPoint().y))},centerObjectV:function(l){return this._centerObject(l,new g.Point(l.getCenterPoint().x,this.getCenterPoint().y))},centerObject:function(l){var d=this.getCenterPoint();return this._centerObject(l,d)},viewportCenterObject:function(l){var d=this.getVpCenter();return this._centerObject(l,d)},viewportCenterObjectH:function(l){var d=this.getVpCenter();return this._centerObject(l,new g.Point(d.x,l.getCenterPoint().y)),this},viewportCenterObjectV:function(l){var d=this.getVpCenter();return this._centerObject(l,new g.Point(l.getCenterPoint().x,d.y))},getVpCenter:function(){var l=this.getCenterPoint(),d=t(this.viewportTransform);return e(l,d)},_centerObject:function(l,d){return l.setPositionByOrigin(d,"center","center"),l.setCoords(),this.renderOnAddRemove&&this.requestRenderAll(),this},toDatalessJSON:function(l){return this.toDatalessObject(l)},toObject:function(l){return this._toObjectMethod("toObject",l)},toDatalessObject:function(l){return this._toObjectMethod("toDatalessObject",l)},_toObjectMethod:function(l,d){var p=this.clipPath,m={version:g.version,objects:this._toObjects(l,d)};return p&&!p.excludeFromExport&&(m.clipPath=this._toObject(this.clipPath,l,d)),r(m,this.__serializeBgOverlay(l,d)),g.util.populateWithProperties(this,m,d),m},_toObjects:function(l,d){return this._objects.filter(function(p){return!p.excludeFromExport}).map(function(p){return this._toObject(p,l,d)},this)},_toObject:function(l,d,p){var m;this.includeDefaultValues||(m=l.includeDefaultValues,l.includeDefaultValues=!1);var b=l[d](p);return this.includeDefaultValues||(l.includeDefaultValues=m),b},__serializeBgOverlay:function(l,d){var p={},m=this.backgroundImage,b=this.overlayImage,y=this.backgroundColor,w=this.overlayColor;return y&&y.toObject?y.excludeFromExport||(p.background=y.toObject(d)):y&&(p.background=y),w&&w.toObject?w.excludeFromExport||(p.overlay=w.toObject(d)):w&&(p.overlay=w),m&&!m.excludeFromExport&&(p.backgroundImage=this._toObject(m,l,d)),b&&!b.excludeFromExport&&(p.overlayImage=this._toObject(b,l,d)),p},svgViewportTransformation:!0,toSVG:function(l,d){l||(l={}),l.reviver=d;var p=[];return this._setSVGPreamble(p,l),this._setSVGHeader(p,l),this.clipPath&&p.push('<g clip-path="url(#'+this.clipPath.clipPathId+')" >\n'),this._setSVGBgOverlayColor(p,"background"),this._setSVGBgOverlayImage(p,"backgroundImage",d),this._setSVGObjects(p,d),this.clipPath&&p.push("</g>\n"),this._setSVGBgOverlayColor(p,"overlay"),this._setSVGBgOverlayImage(p,"overlayImage",d),p.push("</svg>"),p.join("")},_setSVGPreamble:function(l,d){d.suppressPreamble||l.push('<?xml version="1.0" encoding="',d.encoding||"UTF-8",'" standalone="no" ?>\n','<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" ','"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n')},_setSVGHeader:function(l,d){var p,m=d.width||this.width,b=d.height||this.height,y='viewBox="0 0 '+this.width+" "+this.height+'" ',w=g.Object.NUM_FRACTION_DIGITS;d.viewBox?y='viewBox="'+d.viewBox.x+" "+d.viewBox.y+" "+d.viewBox.width+" "+d.viewBox.height+'" ':this.svgViewportTransformation&&(p=this.viewportTransform,y='viewBox="'+a(-p[4]/p[0],w)+" "+a(-p[5]/p[3],w)+" "+a(this.width/p[0],w)+" "+a(this.height/p[3],w)+'" '),l.push("<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',m,'" ','height="',b,'" ',y,'xml:space="preserve">\n',"<desc>Created with Fabric.js ",g.version,"</desc>\n","<defs>\n",this.createSVGFontFacesMarkup(),this.createSVGRefElementsMarkup(),this.createSVGClipPathMarkup(d),"</defs>\n")},createSVGClipPathMarkup:function(l){var d=this.clipPath;return d?(d.clipPathId="CLIPPATH_"+g.Object.__uid++,'<clipPath id="'+d.clipPathId+'" >\n'+this.clipPath.toClipPathSVG(l.reviver)+"</clipPath>\n"):""},createSVGRefElementsMarkup:function(){var l=this;return["background","overlay"].map(function(d){var p=l[d+"Color"];if(p&&p.toLive){var m=l[d+"Vpt"],b=l.viewportTransform,y={width:l.width/(m?b[0]:1),height:l.height/(m?b[3]:1)};return p.toSVG(y,{additionalTransform:m?g.util.matrixToSVG(b):""})}}).join("")},createSVGFontFacesMarkup:function(){var l,d,p,m,b,y,w,T,k="",P={},G=g.fontPaths,V=[];for(this._objects.forEach(function A(O){V.push(O),O._objects&&O._objects.forEach(A)}),w=0,T=V.length;w<T;w++)if(d=(l=V[w]).fontFamily,l.type.indexOf("text")!==-1&&!P[d]&&G[d]&&(P[d]=!0,l.styles))for(b in p=l.styles)for(y in m=p[b])!P[d=m[y].fontFamily]&&G[d]&&(P[d]=!0);for(var N in P)k+=["		@font-face {\n","			font-family: '",N,"';\n","			src: url('",G[N],"');\n","		}\n"].join("");return k&&(k=['	<style type="text/css">',"<![CDATA[\n",k,"]]>","</style>\n"].join("")),k},_setSVGObjects:function(l,d){var p,m,b,y=this._objects;for(m=0,b=y.length;m<b;m++)(p=y[m]).excludeFromExport||this._setSVGObject(l,p,d)},_setSVGObject:function(l,d,p){l.push(d.toSVG(p))},_setSVGBgOverlayImage:function(l,d,p){this[d]&&!this[d].excludeFromExport&&this[d].toSVG&&l.push(this[d].toSVG(p))},_setSVGBgOverlayColor:function(l,d){var p=this[d+"Color"],m=this.viewportTransform,b=this.width,y=this.height;if(p)if(p.toLive){var w=p.repeat,T=g.util.invertTransform(m),k=this[d+"Vpt"]?g.util.matrixToSVG(T):"";l.push('<rect transform="'+k+" translate(",b/2,",",y/2,')"',' x="',p.offsetX-b/2,'" y="',p.offsetY-y/2,'" ','width="',w==="repeat-y"||w==="no-repeat"?p.source.width:b,'" height="',w==="repeat-x"||w==="no-repeat"?p.source.height:y,'" fill="url(#SVGID_'+p.id+')"',"></rect>\n")}else l.push('<rect x="0" y="0" width="100%" height="100%" ','fill="',p,'"',"></rect>\n")},sendToBack:function(l){if(!l)return this;var d,p,m,b=this._activeObject;if(l===b&&l.type==="activeSelection")for(d=(m=b._objects).length;d--;)p=m[d],n(this._objects,p),this._objects.unshift(p);else n(this._objects,l),this._objects.unshift(l);return this.renderOnAddRemove&&this.requestRenderAll(),this},bringToFront:function(l){if(!l)return this;var d,p,m,b=this._activeObject;if(l===b&&l.type==="activeSelection")for(m=b._objects,d=0;d<m.length;d++)p=m[d],n(this._objects,p),this._objects.push(p);else n(this._objects,l),this._objects.push(l);return this.renderOnAddRemove&&this.requestRenderAll(),this},sendBackwards:function(l,d){if(!l)return this;var p,m,b,y,w,T=this._activeObject,k=0;if(l===T&&l.type==="activeSelection")for(w=T._objects,p=0;p<w.length;p++)m=w[p],(b=this._objects.indexOf(m))>0+k&&(y=b-1,n(this._objects,m),this._objects.splice(y,0,m)),k++;else(b=this._objects.indexOf(l))!==0&&(y=this._findNewLowerIndex(l,b,d),n(this._objects,l),this._objects.splice(y,0,l));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewLowerIndex:function(l,d,p){var m,b;if(p){for(m=d,b=d-1;b>=0;--b)if(l.intersectsWithObject(this._objects[b])||l.isContainedWithinObject(this._objects[b])||this._objects[b].isContainedWithinObject(l)){m=b;break}}else m=d-1;return m},bringForward:function(l,d){if(!l)return this;var p,m,b,y,w,T=this._activeObject,k=0;if(l===T&&l.type==="activeSelection")for(p=(w=T._objects).length;p--;)m=w[p],(b=this._objects.indexOf(m))<this._objects.length-1-k&&(y=b+1,n(this._objects,m),this._objects.splice(y,0,m)),k++;else(b=this._objects.indexOf(l))!==this._objects.length-1&&(y=this._findNewUpperIndex(l,b,d),n(this._objects,l),this._objects.splice(y,0,l));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewUpperIndex:function(l,d,p){var m,b,y;if(p){for(m=d,b=d+1,y=this._objects.length;b<y;++b)if(l.intersectsWithObject(this._objects[b])||l.isContainedWithinObject(this._objects[b])||this._objects[b].isContainedWithinObject(l)){m=b;break}}else m=d+1;return m},moveTo:function(l,d){return n(this._objects,l),this._objects.splice(d,0,l),this.renderOnAddRemove&&this.requestRenderAll()},dispose:function(){return this.isRendering&&(g.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(l){l.dispose&&l.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),g.util.setStyle(this.lowerCanvasEl,this._originalCanvasStyle),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),g.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},toString:function(){return"#<fabric.Canvas ("+this.complexity()+"): { objects: "+this._objects.length+" }>"}}),r(g.StaticCanvas.prototype,g.Observable),r(g.StaticCanvas.prototype,g.Collection),r(g.StaticCanvas.prototype,g.DataURLExporter),r(g.StaticCanvas,{EMPTY_JSON:'{"objects": [], "background": "white"}',supports:function(l){var d=c();if(!d||!d.getContext)return null;var p=d.getContext("2d");return p&&l==="setLineDash"?p.setLineDash!==void 0:null}}),g.StaticCanvas.prototype.toJSON=g.StaticCanvas.prototype.toObject,g.isLikelyNode&&(g.StaticCanvas.prototype.createPNGStream=function(){var l=s(this.lowerCanvasEl);return l&&l.createPNGStream()},g.StaticCanvas.prototype.createJPEGStream=function(l){var d=s(this.lowerCanvasEl);return d&&d.createJPEGStream(l)})}}(),g.BaseBrush=g.util.createClass({color:"rgb(0, 0, 0)",width:1,shadow:null,strokeLineCap:"round",strokeLineJoin:"round",strokeMiterLimit:10,strokeDashArray:null,limitedToCanvasSize:!1,_setBrushStyles:function(r){r.strokeStyle=this.color,r.lineWidth=this.width,r.lineCap=this.strokeLineCap,r.miterLimit=this.strokeMiterLimit,r.lineJoin=this.strokeLineJoin,r.setLineDash(this.strokeDashArray||[])},_saveAndTransform:function(r){var i=this.canvas.viewportTransform;r.save(),r.transform(i[0],i[1],i[2],i[3],i[4],i[5])},_setShadow:function(){if(this.shadow){var r=this.canvas,i=this.shadow,n=r.contextTop,a=r.getZoom();r&&r._isRetinaScaling()&&(a*=g.devicePixelRatio),n.shadowColor=i.color,n.shadowBlur=i.blur*a,n.shadowOffsetX=i.offsetX*a,n.shadowOffsetY=i.offsetY*a}},needsFullRender:function(){return new g.Color(this.color).getAlpha()<1||!!this.shadow},_resetShadow:function(){var r=this.canvas.contextTop;r.shadowColor="",r.shadowBlur=r.shadowOffsetX=r.shadowOffsetY=0},_isOutSideCanvas:function(r){return r.x<0||r.x>this.canvas.getWidth()||r.y<0||r.y>this.canvas.getHeight()}}),g.PencilBrush=g.util.createClass(g.BaseBrush,{decimate:.4,drawStraightLine:!1,straightLineKey:"shiftKey",initialize:function(r){this.canvas=r,this._points=[]},needsFullRender:function(){return this.callSuper("needsFullRender")||this._hasStraightLine},_drawSegment:function(r,i,n){var a=i.midPointFrom(n);return r.quadraticCurveTo(i.x,i.y,a.x,a.y),a},onMouseDown:function(r,i){this.canvas._isMainEvent(i.e)&&(this.drawStraightLine=i.e[this.straightLineKey],this._prepareForDrawing(r),this._captureDrawingPath(r),this._render())},onMouseMove:function(r,i){if(this.canvas._isMainEvent(i.e)&&(this.drawStraightLine=i.e[this.straightLineKey],(this.limitedToCanvasSize!==!0||!this._isOutSideCanvas(r))&&this._captureDrawingPath(r)&&this._points.length>1))if(this.needsFullRender())this.canvas.clearContext(this.canvas.contextTop),this._render();else{var n=this._points,a=n.length,e=this.canvas.contextTop;this._saveAndTransform(e),this.oldEnd&&(e.beginPath(),e.moveTo(this.oldEnd.x,this.oldEnd.y)),this.oldEnd=this._drawSegment(e,n[a-2],n[a-1],!0),e.stroke(),e.restore()}},onMouseUp:function(r){return!this.canvas._isMainEvent(r.e)||(this.drawStraightLine=!1,this.oldEnd=void 0,this._finalizeAndAddPath(),!1)},_prepareForDrawing:function(r){var i=new g.Point(r.x,r.y);this._reset(),this._addPoint(i),this.canvas.contextTop.moveTo(i.x,i.y)},_addPoint:function(r){return!(this._points.length>1&&r.eq(this._points[this._points.length-1])||(this.drawStraightLine&&this._points.length>1&&(this._hasStraightLine=!0,this._points.pop()),this._points.push(r),0))},_reset:function(){this._points=[],this._setBrushStyles(this.canvas.contextTop),this._setShadow(),this._hasStraightLine=!1},_captureDrawingPath:function(r){var i=new g.Point(r.x,r.y);return this._addPoint(i)},_render:function(r){var i,n,a=this._points[0],e=this._points[1];if(r=r||this.canvas.contextTop,this._saveAndTransform(r),r.beginPath(),this._points.length===2&&a.x===e.x&&a.y===e.y){var t=this.width/1e3;a=new g.Point(a.x,a.y),e=new g.Point(e.x,e.y),a.x-=t,e.x+=t}for(r.moveTo(a.x,a.y),i=1,n=this._points.length;i<n;i++)this._drawSegment(r,a,e),a=this._points[i],e=this._points[i+1];r.lineTo(a.x,a.y),r.stroke(),r.restore()},convertPointsToSVGPath:function(r){var i=this.width/1e3;return g.util.getSmoothPathFromPoints(r,i)},_isEmptySVGPath:function(r){return g.util.joinPath(r)==="M 0 0 Q 0 0 0 0 L 0 0"},createPath:function(r){var i=new g.Path(r,{fill:null,stroke:this.color,strokeWidth:this.width,strokeLineCap:this.strokeLineCap,strokeMiterLimit:this.strokeMiterLimit,strokeLineJoin:this.strokeLineJoin,strokeDashArray:this.strokeDashArray});return this.shadow&&(this.shadow.affectStroke=!0,i.shadow=new g.Shadow(this.shadow)),i},decimatePoints:function(r,i){if(r.length<=2)return r;var n,a=this.canvas.getZoom(),e=Math.pow(i/a,2),t=r.length-1,s=r[0],c=[s];for(n=1;n<t-1;n++)Math.pow(s.x-r[n].x,2)+Math.pow(s.y-r[n].y,2)>=e&&(s=r[n],c.push(s));return c.push(r[t]),c},_finalizeAndAddPath:function(){this.canvas.contextTop.closePath(),this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate));var r=this.convertPointsToSVGPath(this._points);if(this._isEmptySVGPath(r))this.canvas.requestRenderAll();else{var i=this.createPath(r);this.canvas.clearContext(this.canvas.contextTop),this.canvas.fire("before:path:created",{path:i}),this.canvas.add(i),this.canvas.requestRenderAll(),i.setCoords(),this._resetShadow(),this.canvas.fire("path:created",{path:i})}}}),g.CircleBrush=g.util.createClass(g.BaseBrush,{width:10,initialize:function(r){this.canvas=r,this.points=[]},drawDot:function(r){var i=this.addPoint(r),n=this.canvas.contextTop;this._saveAndTransform(n),this.dot(n,i),n.restore()},dot:function(r,i){r.fillStyle=i.fill,r.beginPath(),r.arc(i.x,i.y,i.radius,0,2*Math.PI,!1),r.closePath(),r.fill()},onMouseDown:function(r){this.points.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.drawDot(r)},_render:function(){var r,i,n=this.canvas.contextTop,a=this.points;for(this._saveAndTransform(n),r=0,i=a.length;r<i;r++)this.dot(n,a[r]);n.restore()},onMouseMove:function(r){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(r)||(this.needsFullRender()?(this.canvas.clearContext(this.canvas.contextTop),this.addPoint(r),this._render()):this.drawDot(r))},onMouseUp:function(){var r,i,n=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;var a=[];for(r=0,i=this.points.length;r<i;r++){var e=this.points[r],t=new g.Circle({radius:e.radius,left:e.x,top:e.y,originX:"center",originY:"center",fill:e.fill});this.shadow&&(t.shadow=new g.Shadow(this.shadow)),a.push(t)}var s=new g.Group(a);s.canvas=this.canvas,this.canvas.fire("before:path:created",{path:s}),this.canvas.add(s),this.canvas.fire("path:created",{path:s}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=n,this.canvas.requestRenderAll()},addPoint:function(r){var i=new g.Point(r.x,r.y),n=g.util.getRandomInt(Math.max(0,this.width-20),this.width+20)/2,a=new g.Color(this.color).setAlpha(g.util.getRandomInt(0,100)/100).toRgba();return i.radius=n,i.fill=a,this.points.push(i),i}}),g.SprayBrush=g.util.createClass(g.BaseBrush,{width:10,density:20,dotWidth:1,dotWidthVariance:1,randomOpacity:!1,optimizeOverlapping:!0,initialize:function(r){this.canvas=r,this.sprayChunks=[]},onMouseDown:function(r){this.sprayChunks.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.addSprayChunk(r),this.render(this.sprayChunkPoints)},onMouseMove:function(r){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(r)||(this.addSprayChunk(r),this.render(this.sprayChunkPoints))},onMouseUp:function(){var r=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;for(var i=[],n=0,a=this.sprayChunks.length;n<a;n++)for(var e=this.sprayChunks[n],t=0,s=e.length;t<s;t++){var c=new g.Rect({width:e[t].width,height:e[t].width,left:e[t].x+1,top:e[t].y+1,originX:"center",originY:"center",fill:this.color});i.push(c)}this.optimizeOverlapping&&(i=this._getOptimizedRects(i));var h=new g.Group(i);this.shadow&&h.set("shadow",new g.Shadow(this.shadow)),this.canvas.fire("before:path:created",{path:h}),this.canvas.add(h),this.canvas.fire("path:created",{path:h}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=r,this.canvas.requestRenderAll()},_getOptimizedRects:function(r){var i,n,a,e={};for(n=0,a=r.length;n<a;n++)e[i=r[n].left+""+r[n].top]||(e[i]=r[n]);var t=[];for(i in e)t.push(e[i]);return t},render:function(r){var i,n,a=this.canvas.contextTop;for(a.fillStyle=this.color,this._saveAndTransform(a),i=0,n=r.length;i<n;i++){var e=r[i];e.opacity!==void 0&&(a.globalAlpha=e.opacity),a.fillRect(e.x,e.y,e.width,e.width)}a.restore()},_render:function(){var r,i,n=this.canvas.contextTop;for(n.fillStyle=this.color,this._saveAndTransform(n),r=0,i=this.sprayChunks.length;r<i;r++)this.render(this.sprayChunks[r]);n.restore()},addSprayChunk:function(r){this.sprayChunkPoints=[];var i,n,a,e,t=this.width/2;for(e=0;e<this.density;e++){i=g.util.getRandomInt(r.x-t,r.x+t),n=g.util.getRandomInt(r.y-t,r.y+t),a=this.dotWidthVariance?g.util.getRandomInt(Math.max(1,this.dotWidth-this.dotWidthVariance),this.dotWidth+this.dotWidthVariance):this.dotWidth;var s=new g.Point(i,n);s.width=a,this.randomOpacity&&(s.opacity=g.util.getRandomInt(0,100)/100),this.sprayChunkPoints.push(s)}this.sprayChunks.push(this.sprayChunkPoints)}}),g.PatternBrush=g.util.createClass(g.PencilBrush,{getPatternSrc:function(){var r=g.util.createCanvasElement(),i=r.getContext("2d");return r.width=r.height=25,i.fillStyle=this.color,i.beginPath(),i.arc(10,10,10,0,2*Math.PI,!1),i.closePath(),i.fill(),r},getPatternSrcFunction:function(){return String(this.getPatternSrc).replace("this.color",'"'+this.color+'"')},getPattern:function(r){return r.createPattern(this.source||this.getPatternSrc(),"repeat")},_setBrushStyles:function(r){this.callSuper("_setBrushStyles",r),r.strokeStyle=this.getPattern(r)},createPath:function(r){var i=this.callSuper("createPath",r),n=i._getLeftTopCoords().scalarAdd(i.strokeWidth/2);return i.stroke=new g.Pattern({source:this.source||this.getPatternSrcFunction(),offsetX:-n.x,offsetY:-n.y}),i}}),function(){var r=g.util.getPointer,i=g.util.degreesToRadians,n=g.util.isTouchEvent;for(var a in g.Canvas=g.util.createClass(g.StaticCanvas,{initialize:function(e,t){t||(t={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(e,t),this._initInteractive(),this._createCacheCanvas()},uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",interactive:!0,selection:!0,selectionKey:"shiftKey",altSelectionKey:null,selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",notAllowedCursor:"not-allowed",containerClass:"canvas-container",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,isDrawingMode:!1,preserveObjectStacking:!1,snapAngle:0,snapThreshold:null,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,targets:[],enablePointerEvents:!1,_hoveredTarget:null,_hoveredTargets:[],_initInteractive:function(){this._currentTransform=null,this._groupSelector=null,this._initWrapperElement(),this._createUpperCanvas(),this._initEventListeners(),this._initRetinaScaling(),this.freeDrawingBrush=g.PencilBrush&&new g.PencilBrush(this),this.calcOffset()},_chooseObjectsToRender:function(){var e,t,s,c=this.getActiveObjects();if(c.length>0&&!this.preserveObjectStacking){t=[],s=[];for(var h=0,l=this._objects.length;h<l;h++)e=this._objects[h],c.indexOf(e)===-1?t.push(e):s.push(e);c.length>1&&(this._activeObject._objects=s),t.push.apply(t,s)}else t=this._objects;return t},renderAll:function(){!this.contextTopDirty||this._groupSelector||this.isDrawingMode||(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&(this.renderTopLayer(this.contextTop),this.hasLostContext=!1);var e=this.contextContainer;return this.renderCanvas(e,this._chooseObjectsToRender()),this},renderTopLayer:function(e){e.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(e),this.contextTopDirty=!0),e.restore()},renderTop:function(){var e=this.contextTop;return this.clearContext(e),this.renderTopLayer(e),this.fire("after:render"),this},_normalizePointer:function(e,t){var s=e.calcTransformMatrix(),c=g.util.invertTransform(s),h=this.restorePointerVpt(t);return g.util.transformPoint(h,c)},isTargetTransparent:function(e,t,s){if(e.shouldCache()&&e._cacheCanvas&&e!==this._activeObject){var c=this._normalizePointer(e,{x:t,y:s}),h=Math.max(e.cacheTranslationX+c.x*e.zoomX,0),l=Math.max(e.cacheTranslationY+c.y*e.zoomY,0);return g.util.isTransparent(e._cacheContext,Math.round(h),Math.round(l),this.targetFindTolerance)}var d=this.contextCache,p=e.selectionBackgroundColor,m=this.viewportTransform;return e.selectionBackgroundColor="",this.clearContext(d),d.save(),d.transform(m[0],m[1],m[2],m[3],m[4],m[5]),e.render(d),d.restore(),e.selectionBackgroundColor=p,g.util.isTransparent(d,t,s,this.targetFindTolerance)},_isSelectionKeyPressed:function(e){return Array.isArray(this.selectionKey)?!!this.selectionKey.find(function(t){return e[t]===!0}):e[this.selectionKey]},_shouldClearSelection:function(e,t){var s=this.getActiveObjects(),c=this._activeObject;return!t||t&&c&&s.length>1&&s.indexOf(t)===-1&&c!==t&&!this._isSelectionKeyPressed(e)||t&&!t.evented||t&&!t.selectable&&c&&c!==t},_shouldCenterTransform:function(e,t,s){var c;if(e)return t==="scale"||t==="scaleX"||t==="scaleY"||t==="resizing"?c=this.centeredScaling||e.centeredScaling:t==="rotate"&&(c=this.centeredRotation||e.centeredRotation),c?!s:s},_getOriginFromCorner:function(e,t){var s={x:e.originX,y:e.originY};return t==="ml"||t==="tl"||t==="bl"?s.x="right":t!=="mr"&&t!=="tr"&&t!=="br"||(s.x="left"),t==="tl"||t==="mt"||t==="tr"?s.y="bottom":t!=="bl"&&t!=="mb"&&t!=="br"||(s.y="top"),s},_getActionFromCorner:function(e,t,s,c){if(!t||!e)return"drag";var h=c.controls[t];return h.getActionName(s,h,c)},_setupCurrentTransform:function(e,t,s){if(t){var c=this.getPointer(e),h=t.__corner,l=t.controls[h],d=s&&h?l.getActionHandler(e,t,l):g.controlsUtils.dragHandler,p=this._getActionFromCorner(s,h,e,t),m=this._getOriginFromCorner(t,h),b=e[this.centeredKey],y={target:t,action:p,actionHandler:d,corner:h,scaleX:t.scaleX,scaleY:t.scaleY,skewX:t.skewX,skewY:t.skewY,offsetX:c.x-t.left,offsetY:c.y-t.top,originX:m.x,originY:m.y,ex:c.x,ey:c.y,lastX:c.x,lastY:c.y,theta:i(t.angle),width:t.width*t.scaleX,shiftKey:e.shiftKey,altKey:b,original:g.util.saveObjectTransform(t)};this._shouldCenterTransform(t,p,b)&&(y.originX="center",y.originY="center"),y.original.originX=m.x,y.original.originY=m.y,this._currentTransform=y,this._beforeTransform(e)}},setCursor:function(e){this.upperCanvasEl.style.cursor=e},_drawSelection:function(e){var t=this._groupSelector,s=new g.Point(t.ex,t.ey),c=g.util.transformPoint(s,this.viewportTransform),h=new g.Point(t.ex+t.left,t.ey+t.top),l=g.util.transformPoint(h,this.viewportTransform),d=Math.min(c.x,l.x),p=Math.min(c.y,l.y),m=Math.max(c.x,l.x),b=Math.max(c.y,l.y),y=this.selectionLineWidth/2;this.selectionColor&&(e.fillStyle=this.selectionColor,e.fillRect(d,p,m-d,b-p)),this.selectionLineWidth&&this.selectionBorderColor&&(e.lineWidth=this.selectionLineWidth,e.strokeStyle=this.selectionBorderColor,d+=y,p+=y,m-=y,b-=y,g.Object.prototype._setLineDash.call(this,e,this.selectionDashArray),e.strokeRect(d,p,m-d,b-p))},findTarget:function(e,t){if(!this.skipTargetFind){var s,c,h=this.getPointer(e,!0),l=this._activeObject,d=this.getActiveObjects(),p=n(e),m=d.length>1&&!t||d.length===1;if(this.targets=[],m&&l._findTargetCorner(h,p)||d.length>1&&!t&&l===this._searchPossibleTargets([l],h))return l;if(d.length===1&&l===this._searchPossibleTargets([l],h)){if(!this.preserveObjectStacking)return l;s=l,c=this.targets,this.targets=[]}var b=this._searchPossibleTargets(this._objects,h);return e[this.altSelectionKey]&&b&&s&&b!==s&&(b=s,this.targets=c),b}},_checkTarget:function(e,t,s){if(t&&t.visible&&t.evented&&t.containsPoint(e)&&(!this.perPixelTargetFind&&!t.perPixelTargetFind||t.isEditing||!this.isTargetTransparent(t,s.x,s.y)))return!0},_searchPossibleTargets:function(e,t){for(var s,c,h=e.length;h--;){var l=e[h],d=l.group?this._normalizePointer(l.group,t):t;if(this._checkTarget(d,l,t)){(s=e[h]).subTargetCheck&&s instanceof g.Group&&(c=this._searchPossibleTargets(s._objects,t))&&this.targets.push(c);break}}return s},restorePointerVpt:function(e){return g.util.transformPoint(e,g.util.invertTransform(this.viewportTransform))},getPointer:function(e,t){if(this._absolutePointer&&!t)return this._absolutePointer;if(this._pointer&&t)return this._pointer;var s,c=r(e),h=this.upperCanvasEl,l=h.getBoundingClientRect(),d=l.width||0,p=l.height||0;d&&p||("top"in l&&"bottom"in l&&(p=Math.abs(l.top-l.bottom)),"right"in l&&"left"in l&&(d=Math.abs(l.right-l.left))),this.calcOffset(),c.x=c.x-this._offset.left,c.y=c.y-this._offset.top,t||(c=this.restorePointerVpt(c));var m=this.getRetinaScaling();return m!==1&&(c.x/=m,c.y/=m),s=d===0||p===0?{width:1,height:1}:{width:h.width/d,height:h.height/p},{x:c.x*s.width,y:c.y*s.height}},_createUpperCanvas:function(){var e=this.lowerCanvasEl.className.replace(/\s*lower-canvas\s*/,""),t=this.lowerCanvasEl,s=this.upperCanvasEl;s?s.className="":(s=this._createCanvasElement(),this.upperCanvasEl=s),g.util.addClass(s,"upper-canvas "+e),this.wrapperEl.appendChild(s),this._copyCanvasStyle(t,s),this._applyCanvasStyle(s),this.contextTop=s.getContext("2d")},getTopContext:function(){return this.contextTop},_createCacheCanvas:function(){this.cacheCanvasEl=this._createCanvasElement(),this.cacheCanvasEl.setAttribute("width",this.width),this.cacheCanvasEl.setAttribute("height",this.height),this.contextCache=this.cacheCanvasEl.getContext("2d")},_initWrapperElement:function(){this.wrapperEl=g.util.wrapElement(this.lowerCanvasEl,"div",{class:this.containerClass}),g.util.setStyle(this.wrapperEl,{width:this.width+"px",height:this.height+"px",position:"relative"}),g.util.makeElementUnselectable(this.wrapperEl)},_applyCanvasStyle:function(e){var t=this.width||e.width,s=this.height||e.height;g.util.setStyle(e,{position:"absolute",width:t+"px",height:s+"px",left:0,top:0,"touch-action":this.allowTouchScrolling?"manipulation":"none","-ms-touch-action":this.allowTouchScrolling?"manipulation":"none"}),e.width=t,e.height=s,g.util.makeElementUnselectable(e)},_copyCanvasStyle:function(e,t){t.style.cssText=e.style.cssText},getSelectionContext:function(){return this.contextTop},getSelectionElement:function(){return this.upperCanvasEl},getActiveObject:function(){return this._activeObject},getActiveObjects:function(){var e=this._activeObject;return e?e.type==="activeSelection"&&e._objects?e._objects.slice(0):[e]:[]},_onObjectRemoved:function(e){e===this._activeObject&&(this.fire("before:selection:cleared",{target:e}),this._discardActiveObject(),this.fire("selection:cleared",{target:e}),e.fire("deselected")),e===this._hoveredTarget&&(this._hoveredTarget=null,this._hoveredTargets=[]),this.callSuper("_onObjectRemoved",e)},_fireSelectionEvents:function(e,t){var s=!1,c=this.getActiveObjects(),h=[],l=[];e.forEach(function(d){c.indexOf(d)===-1&&(s=!0,d.fire("deselected",{e:t,target:d}),l.push(d))}),c.forEach(function(d){e.indexOf(d)===-1&&(s=!0,d.fire("selected",{e:t,target:d}),h.push(d))}),e.length>0&&c.length>0?s&&this.fire("selection:updated",{e:t,selected:h,deselected:l}):c.length>0?this.fire("selection:created",{e:t,selected:h}):e.length>0&&this.fire("selection:cleared",{e:t,deselected:l})},setActiveObject:function(e,t){var s=this.getActiveObjects();return this._setActiveObject(e,t),this._fireSelectionEvents(s,t),this},_setActiveObject:function(e,t){return this._activeObject!==e&&!!this._discardActiveObject(t,e)&&!e.onSelect({e:t})&&(this._activeObject=e,!0)},_discardActiveObject:function(e,t){var s=this._activeObject;if(s){if(s.onDeselect({e,object:t}))return!1;this._activeObject=null}return!0},discardActiveObject:function(e){var t=this.getActiveObjects(),s=this.getActiveObject();return t.length&&this.fire("before:selection:cleared",{target:s,e}),this._discardActiveObject(e),this._fireSelectionEvents(t,e),this},dispose:function(){var e=this.wrapperEl;return this.removeListeners(),e.removeChild(this.upperCanvasEl),e.removeChild(this.lowerCanvasEl),this.contextCache=null,this.contextTop=null,["upperCanvasEl","cacheCanvasEl"].forEach((function(t){g.util.cleanUpJsdomNode(this[t]),this[t]=void 0}).bind(this)),e.parentNode&&e.parentNode.replaceChild(this.lowerCanvasEl,this.wrapperEl),delete this.wrapperEl,g.StaticCanvas.prototype.dispose.call(this),this},clear:function(){return this.discardActiveObject(),this.clearContext(this.contextTop),this.callSuper("clear")},drawControls:function(e){var t=this._activeObject;t&&t._renderControls(e)},_toObject:function(e,t,s){var c=this._realizeGroupTransformOnObject(e),h=this.callSuper("_toObject",e,t,s);return this._unwindGroupTransformOnObject(e,c),h},_realizeGroupTransformOnObject:function(e){if(e.group&&e.group.type==="activeSelection"&&this._activeObject===e.group){var t={};return["angle","flipX","flipY","left","scaleX","scaleY","skewX","skewY","top"].forEach(function(s){t[s]=e[s]}),g.util.addTransformToObject(e,this._activeObject.calcOwnMatrix()),t}return null},_unwindGroupTransformOnObject:function(e,t){t&&e.set(t)},_setSVGObject:function(e,t,s){var c=this._realizeGroupTransformOnObject(t);this.callSuper("_setSVGObject",e,t,s),this._unwindGroupTransformOnObject(t,c)},setViewportTransform:function(e){this.renderOnAddRemove&&this._activeObject&&this._activeObject.isEditing&&this._activeObject.clearContextTop(),g.StaticCanvas.prototype.setViewportTransform.call(this,e)}}),g.StaticCanvas)a!=="prototype"&&(g.Canvas[a]=g.StaticCanvas[a])}(),function(){var r=g.util.addListener,i=g.util.removeListener,n={passive:!1};function a(e,t){return e.button&&e.button===t-1}g.util.object.extend(g.Canvas.prototype,{mainTouchId:null,_initEventListeners:function(){this.removeListeners(),this._bindEvents(),this.addOrRemove(r,"add")},_getEventPrefix:function(){return this.enablePointerEvents?"pointer":"mouse"},addOrRemove:function(e,t){var s=this.upperCanvasEl,c=this._getEventPrefix();e(g.window,"resize",this._onResize),e(s,c+"down",this._onMouseDown),e(s,c+"move",this._onMouseMove,n),e(s,c+"out",this._onMouseOut),e(s,c+"enter",this._onMouseEnter),e(s,"wheel",this._onMouseWheel),e(s,"contextmenu",this._onContextMenu),e(s,"dblclick",this._onDoubleClick),e(s,"dragover",this._onDragOver),e(s,"dragenter",this._onDragEnter),e(s,"dragleave",this._onDragLeave),e(s,"drop",this._onDrop),this.enablePointerEvents||e(s,"touchstart",this._onTouchStart,n),typeof eventjs<"u"&&t in eventjs&&(eventjs[t](s,"gesture",this._onGesture),eventjs[t](s,"drag",this._onDrag),eventjs[t](s,"orientation",this._onOrientationChange),eventjs[t](s,"shake",this._onShake),eventjs[t](s,"longpress",this._onLongPress))},removeListeners:function(){this.addOrRemove(i,"remove");var e=this._getEventPrefix();i(g.document,e+"up",this._onMouseUp),i(g.document,"touchend",this._onTouchEnd,n),i(g.document,e+"move",this._onMouseMove,n),i(g.document,"touchmove",this._onMouseMove,n)},_bindEvents:function(){this.eventsBound||(this._onMouseDown=this._onMouseDown.bind(this),this._onTouchStart=this._onTouchStart.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._onResize=this._onResize.bind(this),this._onGesture=this._onGesture.bind(this),this._onDrag=this._onDrag.bind(this),this._onShake=this._onShake.bind(this),this._onLongPress=this._onLongPress.bind(this),this._onOrientationChange=this._onOrientationChange.bind(this),this._onMouseWheel=this._onMouseWheel.bind(this),this._onMouseOut=this._onMouseOut.bind(this),this._onMouseEnter=this._onMouseEnter.bind(this),this._onContextMenu=this._onContextMenu.bind(this),this._onDoubleClick=this._onDoubleClick.bind(this),this._onDragOver=this._onDragOver.bind(this),this._onDragEnter=this._simpleEventHandler.bind(this,"dragenter"),this._onDragLeave=this._simpleEventHandler.bind(this,"dragleave"),this._onDrop=this._onDrop.bind(this),this.eventsBound=!0)},_onGesture:function(e,t){this.__onTransformGesture&&this.__onTransformGesture(e,t)},_onDrag:function(e,t){this.__onDrag&&this.__onDrag(e,t)},_onMouseWheel:function(e){this.__onMouseWheel(e)},_onMouseOut:function(e){var t=this._hoveredTarget;this.fire("mouse:out",{target:t,e}),this._hoveredTarget=null,t&&t.fire("mouseout",{e});var s=this;this._hoveredTargets.forEach(function(c){s.fire("mouse:out",{target:t,e}),c&&t.fire("mouseout",{e})}),this._hoveredTargets=[],this._iTextInstances&&this._iTextInstances.forEach(function(c){c.isEditing&&c.hiddenTextarea.focus()})},_onMouseEnter:function(e){this._currentTransform||this.findTarget(e)||(this.fire("mouse:over",{target:null,e}),this._hoveredTarget=null,this._hoveredTargets=[])},_onOrientationChange:function(e,t){this.__onOrientationChange&&this.__onOrientationChange(e,t)},_onShake:function(e,t){this.__onShake&&this.__onShake(e,t)},_onLongPress:function(e,t){this.__onLongPress&&this.__onLongPress(e,t)},_onDragOver:function(e){e.preventDefault();var t=this._simpleEventHandler("dragover",e);this._fireEnterLeaveEvents(t,e)},_onDrop:function(e){return this._simpleEventHandler("drop:before",e),this._simpleEventHandler("drop",e)},_onContextMenu:function(e){return this.stopContextMenu&&(e.stopPropagation(),e.preventDefault()),!1},_onDoubleClick:function(e){this._cacheTransformEventData(e),this._handleEvent(e,"dblclick"),this._resetTransformEventData(e)},getPointerId:function(e){var t=e.changedTouches;return t?t[0]&&t[0].identifier:this.enablePointerEvents?e.pointerId:-1},_isMainEvent:function(e){return e.isPrimary===!0||e.isPrimary!==!1&&(e.type==="touchend"&&e.touches.length===0||!e.changedTouches||e.changedTouches[0].identifier===this.mainTouchId)},_onTouchStart:function(e){e.preventDefault(),this.mainTouchId===null&&(this.mainTouchId=this.getPointerId(e)),this.__onMouseDown(e),this._resetTransformEventData();var t=this.upperCanvasEl,s=this._getEventPrefix();r(g.document,"touchend",this._onTouchEnd,n),r(g.document,"touchmove",this._onMouseMove,n),i(t,s+"down",this._onMouseDown)},_onMouseDown:function(e){this.__onMouseDown(e),this._resetTransformEventData();var t=this.upperCanvasEl,s=this._getEventPrefix();i(t,s+"move",this._onMouseMove,n),r(g.document,s+"up",this._onMouseUp),r(g.document,s+"move",this._onMouseMove,n)},_onTouchEnd:function(e){if(!(e.touches.length>0)){this.__onMouseUp(e),this._resetTransformEventData(),this.mainTouchId=null;var t=this._getEventPrefix();i(g.document,"touchend",this._onTouchEnd,n),i(g.document,"touchmove",this._onMouseMove,n);var s=this;this._willAddMouseDown&&clearTimeout(this._willAddMouseDown),this._willAddMouseDown=setTimeout(function(){r(s.upperCanvasEl,t+"down",s._onMouseDown),s._willAddMouseDown=0},400)}},_onMouseUp:function(e){this.__onMouseUp(e),this._resetTransformEventData();var t=this.upperCanvasEl,s=this._getEventPrefix();this._isMainEvent(e)&&(i(g.document,s+"up",this._onMouseUp),i(g.document,s+"move",this._onMouseMove,n),r(t,s+"move",this._onMouseMove,n))},_onMouseMove:function(e){!this.allowTouchScrolling&&e.preventDefault&&e.preventDefault(),this.__onMouseMove(e)},_onResize:function(){this.calcOffset()},_shouldRender:function(e){var t=this._activeObject;return!!(!!t!=!!e||t&&e&&t!==e)||(t&&t.isEditing,!1)},__onMouseUp:function(e){var t,s=this._currentTransform,c=this._groupSelector,h=!1,l=!c||c.left===0&&c.top===0;if(this._cacheTransformEventData(e),t=this._target,this._handleEvent(e,"up:before"),a(e,3))this.fireRightClick&&this._handleEvent(e,"up",3,l);else{if(a(e,2))return this.fireMiddleClick&&this._handleEvent(e,"up",2,l),void this._resetTransformEventData();if(this.isDrawingMode&&this._isCurrentlyDrawing)this._onMouseUpInDrawingMode(e);else if(this._isMainEvent(e)){if(s&&(this._finalizeCurrentTransform(e),h=s.actionPerformed),!l){var d=t===this._activeObject;this._maybeGroupObjects(e),h||(h=this._shouldRender(t)||!d&&t===this._activeObject)}var p,m;if(t){if(p=t._findTargetCorner(this.getPointer(e,!0),g.util.isTouchEvent(e)),t.selectable&&t!==this._activeObject&&t.activeOn==="up")this.setActiveObject(t,e),h=!0;else{var b=t.controls[p],y=b&&b.getMouseUpHandler(e,t,b);y&&y(e,s,(m=this.getPointer(e)).x,m.y)}t.isMoving=!1}if(s&&(s.target!==t||s.corner!==p)){var w=s.target&&s.target.controls[s.corner],T=w&&w.getMouseUpHandler(e,t,b);m=m||this.getPointer(e),T&&T(e,s,m.x,m.y)}this._setCursorFromEvent(e,t),this._handleEvent(e,"up",1,l),this._groupSelector=null,this._currentTransform=null,t&&(t.__corner=0),h?this.requestRenderAll():l||this.renderTop()}}},_simpleEventHandler:function(e,t){var s=this.findTarget(t),c=this.targets,h={e:t,target:s,subTargets:c};if(this.fire(e,h),s&&s.fire(e,h),!c)return s;for(var l=0;l<c.length;l++)c[l].fire(e,h);return s},_handleEvent:function(e,t,s,c){var h=this._target,l=this.targets||[],d={e,target:h,subTargets:l,button:s||1,isClick:c||!1,pointer:this._pointer,absolutePointer:this._absolutePointer,transform:this._currentTransform};t==="up"&&(d.currentTarget=this.findTarget(e),d.currentSubTargets=this.targets),this.fire("mouse:"+t,d),h&&h.fire("mouse"+t,d);for(var p=0;p<l.length;p++)l[p].fire("mouse"+t,d)},_finalizeCurrentTransform:function(e){var t=this._currentTransform,s=t.target,c={e,target:s,transform:t,action:t.action};s._scaling&&(s._scaling=!1),s.setCoords(),(t.actionPerformed||this.stateful&&s.hasStateChanged())&&this._fire("modified",c)},_onMouseDownInDrawingMode:function(e){this._isCurrentlyDrawing=!0,this.getActiveObject()&&this.discardActiveObject(e).requestRenderAll();var t=this.getPointer(e);this.freeDrawingBrush.onMouseDown(t,{e,pointer:t}),this._handleEvent(e,"down")},_onMouseMoveInDrawingMode:function(e){if(this._isCurrentlyDrawing){var t=this.getPointer(e);this.freeDrawingBrush.onMouseMove(t,{e,pointer:t})}this.setCursor(this.freeDrawingCursor),this._handleEvent(e,"move")},_onMouseUpInDrawingMode:function(e){var t=this.getPointer(e);this._isCurrentlyDrawing=this.freeDrawingBrush.onMouseUp({e,pointer:t}),this._handleEvent(e,"up")},__onMouseDown:function(e){this._cacheTransformEventData(e),this._handleEvent(e,"down:before");var t=this._target;if(a(e,3))this.fireRightClick&&this._handleEvent(e,"down",3);else if(a(e,2))this.fireMiddleClick&&this._handleEvent(e,"down",2);else if(this.isDrawingMode)this._onMouseDownInDrawingMode(e);else if(this._isMainEvent(e)&&!this._currentTransform){var s=this._pointer;this._previousPointer=s;var c=this._shouldRender(t),h=this._shouldGroup(e,t);if(this._shouldClearSelection(e,t)?this.discardActiveObject(e):h&&(this._handleGrouping(e,t),t=this._activeObject),!this.selection||t&&(t.selectable||t.isEditing||t===this._activeObject)||(this._groupSelector={ex:this._absolutePointer.x,ey:this._absolutePointer.y,top:0,left:0}),t){var l=t===this._activeObject;t.selectable&&t.activeOn==="down"&&this.setActiveObject(t,e);var d=t._findTargetCorner(this.getPointer(e,!0),g.util.isTouchEvent(e));if(t.__corner=d,t===this._activeObject&&(d||!h)){this._setupCurrentTransform(e,t,l);var p=t.controls[d],m=(s=this.getPointer(e),p&&p.getMouseDownHandler(e,t,p));m&&m(e,this._currentTransform,s.x,s.y)}}this._handleEvent(e,"down"),(c||h)&&this.requestRenderAll()}},_resetTransformEventData:function(){this._target=null,this._pointer=null,this._absolutePointer=null},_cacheTransformEventData:function(e){this._resetTransformEventData(),this._pointer=this.getPointer(e,!0),this._absolutePointer=this.restorePointerVpt(this._pointer),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(e)||null},_beforeTransform:function(e){var t=this._currentTransform;this.stateful&&t.target.saveState(),this.fire("before:transform",{e,transform:t})},__onMouseMove:function(e){var t,s;if(this._handleEvent(e,"move:before"),this._cacheTransformEventData(e),this.isDrawingMode)this._onMouseMoveInDrawingMode(e);else if(this._isMainEvent(e)){var c=this._groupSelector;c?(s=this._absolutePointer,c.left=s.x-c.ex,c.top=s.y-c.ey,this.renderTop()):this._currentTransform?this._transformObject(e):(t=this.findTarget(e)||null,this._setCursorFromEvent(e,t),this._fireOverOutEvents(t,e)),this._handleEvent(e,"move"),this._resetTransformEventData()}},_fireOverOutEvents:function(e,t){var s=this._hoveredTarget,c=this._hoveredTargets,h=this.targets,l=Math.max(c.length,h.length);this.fireSyntheticInOutEvents(e,t,{oldTarget:s,evtOut:"mouseout",canvasEvtOut:"mouse:out",evtIn:"mouseover",canvasEvtIn:"mouse:over"});for(var d=0;d<l;d++)this.fireSyntheticInOutEvents(h[d],t,{oldTarget:c[d],evtOut:"mouseout",evtIn:"mouseover"});this._hoveredTarget=e,this._hoveredTargets=this.targets.concat()},_fireEnterLeaveEvents:function(e,t){var s=this._draggedoverTarget,c=this._hoveredTargets,h=this.targets,l=Math.max(c.length,h.length);this.fireSyntheticInOutEvents(e,t,{oldTarget:s,evtOut:"dragleave",evtIn:"dragenter"});for(var d=0;d<l;d++)this.fireSyntheticInOutEvents(h[d],t,{oldTarget:c[d],evtOut:"dragleave",evtIn:"dragenter"});this._draggedoverTarget=e},fireSyntheticInOutEvents:function(e,t,s){var c,h,l,d=s.oldTarget,p=d!==e,m=s.canvasEvtIn,b=s.canvasEvtOut;p&&(c={e:t,target:e,previousTarget:d},h={e:t,target:d,nextTarget:e}),l=e&&p,d&&p&&(b&&this.fire(b,h),d.fire(s.evtOut,h)),l&&(m&&this.fire(m,c),e.fire(s.evtIn,c))},__onMouseWheel:function(e){this._cacheTransformEventData(e),this._handleEvent(e,"wheel"),this._resetTransformEventData()},_transformObject:function(e){var t=this.getPointer(e),s=this._currentTransform;s.reset=!1,s.shiftKey=e.shiftKey,s.altKey=e[this.centeredKey],this._performTransformAction(e,s,t),s.actionPerformed&&this.requestRenderAll()},_performTransformAction:function(e,t,s){var c=s.x,h=s.y,l=t.action,d=!1,p=t.actionHandler;p&&(d=p(e,t,c,h)),l==="drag"&&d&&(t.target.isMoving=!0,this.setCursor(t.target.moveCursor||this.moveCursor)),t.actionPerformed=t.actionPerformed||d},_fire:g.controlsUtils.fireEvent,_setCursorFromEvent:function(e,t){if(!t)return this.setCursor(this.defaultCursor),!1;var s=t.hoverCursor||this.hoverCursor,c=this._activeObject&&this._activeObject.type==="activeSelection"?this._activeObject:null,h=(!c||!c.contains(t))&&t._findTargetCorner(this.getPointer(e,!0));h?this.setCursor(this.getCornerCursor(h,t,e)):(t.subTargetCheck&&this.targets.concat().reverse().map(function(l){s=l.hoverCursor||s}),this.setCursor(s))},getCornerCursor:function(e,t,s){var c=t.controls[e];return c.cursorStyleHandler(s,c,t)}})}(),ue=Math.min,$=Math.max,g.util.object.extend(g.Canvas.prototype,{_shouldGroup:function(r,i){var n=this._activeObject;return n&&this._isSelectionKeyPressed(r)&&i&&i.selectable&&this.selection&&(n!==i||n.type==="activeSelection")&&!i.onSelect({e:r})},_handleGrouping:function(r,i){var n=this._activeObject;n.__corner||(i!==n||(i=this.findTarget(r,!0))&&i.selectable)&&(n&&n.type==="activeSelection"?this._updateActiveSelection(i,r):this._createActiveSelection(i,r))},_updateActiveSelection:function(r,i){var n=this._activeObject,a=n._objects.slice(0);n.contains(r)?(n.removeWithUpdate(r),this._hoveredTarget=r,this._hoveredTargets=this.targets.concat(),n.size()===1&&this._setActiveObject(n.item(0),i)):(n.addWithUpdate(r),this._hoveredTarget=n,this._hoveredTargets=this.targets.concat()),this._fireSelectionEvents(a,i)},_createActiveSelection:function(r,i){var n=this.getActiveObjects(),a=this._createGroup(r);this._hoveredTarget=a,this._setActiveObject(a,i),this._fireSelectionEvents(n,i)},_createGroup:function(r){var i=this._objects,n=i.indexOf(this._activeObject)<i.indexOf(r)?[this._activeObject,r]:[r,this._activeObject];return this._activeObject.isEditing&&this._activeObject.exitEditing(),new g.ActiveSelection(n,{canvas:this})},_groupSelectedObjects:function(r){var i,n=this._collectObjects(r);n.length===1?this.setActiveObject(n[0],r):n.length>1&&(i=new g.ActiveSelection(n.reverse(),{canvas:this}),this.setActiveObject(i,r))},_collectObjects:function(r){for(var i,n=[],a=this._groupSelector.ex,e=this._groupSelector.ey,t=a+this._groupSelector.left,s=e+this._groupSelector.top,c=new g.Point(ue(a,t),ue(e,s)),h=new g.Point($(a,t),$(e,s)),l=!this.selectionFullyContained,d=a===t&&e===s,p=this._objects.length;p--&&!((i=this._objects[p])&&i.selectable&&i.visible&&(l&&i.intersectsWithRect(c,h,!0)||i.isContainedWithinRect(c,h,!0)||l&&i.containsPoint(c,null,!0)||l&&i.containsPoint(h,null,!0))&&(n.push(i),d)););return n.length>1&&(n=n.filter(function(m){return!m.onSelect({e:r})})),n},_maybeGroupObjects:function(r){this.selection&&this._groupSelector&&this._groupSelectedObjects(r),this.setCursor(this.defaultCursor),this._groupSelector=null}}),g.util.object.extend(g.StaticCanvas.prototype,{toDataURL:function(r){r||(r={});var i=r.format||"png",n=r.quality||1,a=(r.multiplier||1)*(r.enableRetinaScaling?this.getRetinaScaling():1),e=this.toCanvasElement(a,r);return g.util.toDataURL(e,i,n)},toCanvasElement:function(r,i){r=r||1;var n=((i=i||{}).width||this.width)*r,a=(i.height||this.height)*r,e=this.getZoom(),t=this.width,s=this.height,c=e*r,h=this.viewportTransform,l=(h[4]-(i.left||0))*r,d=(h[5]-(i.top||0))*r,p=this.interactive,m=[c,0,0,c,l,d],b=this.enableRetinaScaling,y=g.util.createCanvasElement(),w=this.contextTop;return y.width=n,y.height=a,this.contextTop=null,this.enableRetinaScaling=!1,this.interactive=!1,this.viewportTransform=m,this.width=n,this.height=a,this.calcViewportBoundaries(),this.renderCanvas(y.getContext("2d"),this._objects),this.viewportTransform=h,this.width=t,this.height=s,this.calcViewportBoundaries(),this.interactive=p,this.enableRetinaScaling=b,this.contextTop=w,y}}),g.util.object.extend(g.StaticCanvas.prototype,{loadFromJSON:function(r,i,n){if(r){var a=typeof r=="string"?JSON.parse(r):g.util.object.clone(r),e=this,t=a.clipPath,s=this.renderOnAddRemove;return this.renderOnAddRemove=!1,delete a.clipPath,this._enlivenObjects(a.objects,function(c){e.clear(),e._setBgOverlay(a,function(){t?e._enlivenObjects([t],function(h){e.clipPath=h[0],e.__setupCanvas.call(e,a,c,s,i)}):e.__setupCanvas.call(e,a,c,s,i)})},n),this}},__setupCanvas:function(r,i,n,a){var e=this;i.forEach(function(t,s){e.insertAt(t,s)}),this.renderOnAddRemove=n,delete r.objects,delete r.backgroundImage,delete r.overlayImage,delete r.background,delete r.overlay,this._setOptions(r),this.renderAll(),a&&a()},_setBgOverlay:function(r,i){var n={backgroundColor:!1,overlayColor:!1,backgroundImage:!1,overlayImage:!1};if(r.backgroundImage||r.overlayImage||r.background||r.overlay){var a=function(){n.backgroundImage&&n.overlayImage&&n.backgroundColor&&n.overlayColor&&i&&i()};this.__setBgOverlay("backgroundImage",r.backgroundImage,n,a),this.__setBgOverlay("overlayImage",r.overlayImage,n,a),this.__setBgOverlay("backgroundColor",r.background,n,a),this.__setBgOverlay("overlayColor",r.overlay,n,a)}else i&&i()},__setBgOverlay:function(r,i,n,a){var e=this;if(!i)return n[r]=!0,void(a&&a());r==="backgroundImage"||r==="overlayImage"?g.util.enlivenObjects([i],function(t){e[r]=t[0],n[r]=!0,a&&a()}):this["set"+g.util.string.capitalize(r,!0)](i,function(){n[r]=!0,a&&a()})},_enlivenObjects:function(r,i,n){r&&r.length!==0?g.util.enlivenObjects(r,function(a){i&&i(a)},null,n):i&&i([])},_toDataURL:function(r,i){this.clone(function(n){i(n.toDataURL(r))})},_toDataURLWithMultiplier:function(r,i,n){this.clone(function(a){n(a.toDataURLWithMultiplier(r,i))})},clone:function(r,i){var n=JSON.stringify(this.toJSON(i));this.cloneWithoutData(function(a){a.loadFromJSON(n,function(){r&&r(a)})})},cloneWithoutData:function(r){var i=g.util.createCanvasElement();i.width=this.width,i.height=this.height;var n=new g.Canvas(i);this.backgroundImage?(n.setBackgroundImage(this.backgroundImage.src,function(){n.renderAll(),r&&r(n)}),n.backgroundImageOpacity=this.backgroundImageOpacity,n.backgroundImageStretch=this.backgroundImageStretch):r&&r(n)}}),function(r){var i=r.fabric||(r.fabric={}),n=i.util.object.extend,a=i.util.object.clone,e=i.util.toFixed,t=i.util.string.capitalize,s=i.util.degreesToRadians,c=!i.isLikelyNode;i.Object||(i.Object=i.util.createClass(i.CommonMethods,{type:"object",originX:"left",originY:"top",top:0,left:0,width:0,height:0,scaleX:1,scaleY:1,flipX:!1,flipY:!1,opacity:1,angle:0,skewX:0,skewY:0,cornerSize:13,touchCornerSize:24,transparentCorners:!0,hoverCursor:null,moveCursor:null,padding:0,borderColor:"rgb(178,204,255)",borderDashArray:null,cornerColor:"rgb(178,204,255)",cornerStrokeColor:null,cornerStyle:"rect",cornerDashArray:null,centeredScaling:!1,centeredRotation:!0,fill:"rgb(0,0,0)",fillRule:"nonzero",globalCompositeOperation:"source-over",backgroundColor:"",selectionBackgroundColor:"",stroke:null,strokeWidth:1,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,shadow:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,minScaleLimit:0,selectable:!0,evented:!0,visible:!0,hasControls:!0,hasBorders:!0,perPixelTargetFind:!1,includeDefaultValues:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,excludeFromExport:!1,objectCaching:c,statefullCache:!1,noScaleCache:!0,strokeUniform:!1,dirty:!0,__corner:0,paintFirst:"fill",activeOn:"down",stateProperties:"top left width height scaleX scaleY flipX flipY originX originY transformMatrix stroke strokeWidth strokeDashArray strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit angle opacity fill globalCompositeOperation shadow visible backgroundColor skewX skewY fillRule paintFirst clipPath strokeUniform".split(" "),cacheProperties:"fill stroke strokeWidth strokeDashArray width height paintFirst strokeUniform strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit backgroundColor clipPath".split(" "),colorProperties:"fill stroke backgroundColor".split(" "),clipPath:void 0,inverted:!1,absolutePositioned:!1,initialize:function(h){h&&this.setOptions(h)},_createCacheCanvas:function(){this._cacheProperties={},this._cacheCanvas=i.util.createCanvasElement(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0},_limitCacheSize:function(h){var l=i.perfLimitSizeTotal,d=h.width,p=h.height,m=i.maxCacheSideLimit,b=i.minCacheSideLimit;if(d<=m&&p<=m&&d*p<=l)return d<b&&(h.width=b),p<b&&(h.height=b),h;var y=d/p,w=i.util.limitDimsByArea(y,l),T=i.util.capValue,k=T(b,w.x,m),P=T(b,w.y,m);return d>k&&(h.zoomX/=d/k,h.width=k,h.capped=!0),p>P&&(h.zoomY/=p/P,h.height=P,h.capped=!0),h},_getCacheCanvasDimensions:function(){var h=this.getTotalObjectScaling(),l=this._getTransformedDimensions(0,0),d=l.x*h.scaleX/this.scaleX,p=l.y*h.scaleY/this.scaleY;return{width:d+2,height:p+2,zoomX:h.scaleX,zoomY:h.scaleY,x:d,y:p}},_updateCacheCanvas:function(){var h=this.canvas;if(this.noScaleCache&&h&&h._currentTransform){var l=h._currentTransform.target,d=h._currentTransform.action;if(this===l&&d.slice&&d.slice(0,5)==="scale")return!1}var p,m,b=this._cacheCanvas,y=this._limitCacheSize(this._getCacheCanvasDimensions()),w=i.minCacheSideLimit,T=y.width,k=y.height,P=y.zoomX,G=y.zoomY,V=T!==this.cacheWidth||k!==this.cacheHeight,N=this.zoomX!==P||this.zoomY!==G,A=V||N,O=0,B=0,W=!1;if(V){var H=this._cacheCanvas.width,R=this._cacheCanvas.height,D=T>H||k>R;W=D||(T<.9*H||k<.9*R)&&H>w&&R>w,D&&!y.capped&&(T>w||k>w)&&(O=.1*T,B=.1*k)}return this instanceof i.Text&&this.path&&(A=!0,W=!0,O+=this.getHeightOfLine(0)*this.zoomX,B+=this.getHeightOfLine(0)*this.zoomY),!!A&&(W?(b.width=Math.ceil(T+O),b.height=Math.ceil(k+B)):(this._cacheContext.setTransform(1,0,0,1,0,0),this._cacheContext.clearRect(0,0,b.width,b.height)),p=y.x/2,m=y.y/2,this.cacheTranslationX=Math.round(b.width/2-p)+p,this.cacheTranslationY=Math.round(b.height/2-m)+m,this.cacheWidth=T,this.cacheHeight=k,this._cacheContext.translate(this.cacheTranslationX,this.cacheTranslationY),this._cacheContext.scale(P,G),this.zoomX=P,this.zoomY=G,!0)},setOptions:function(h){this._setOptions(h),this._initGradient(h.fill,"fill"),this._initGradient(h.stroke,"stroke"),this._initPattern(h.fill,"fill"),this._initPattern(h.stroke,"stroke")},transform:function(h){var l=this.group&&!this.group._transformDone||this.group&&this.canvas&&h===this.canvas.contextTop,d=this.calcTransformMatrix(!l);h.transform(d[0],d[1],d[2],d[3],d[4],d[5])},toObject:function(h){var l=i.Object.NUM_FRACTION_DIGITS,d={type:this.type,version:i.version,originX:this.originX,originY:this.originY,left:e(this.left,l),top:e(this.top,l),width:e(this.width,l),height:e(this.height,l),fill:this.fill&&this.fill.toObject?this.fill.toObject():this.fill,stroke:this.stroke&&this.stroke.toObject?this.stroke.toObject():this.stroke,strokeWidth:e(this.strokeWidth,l),strokeDashArray:this.strokeDashArray?this.strokeDashArray.concat():this.strokeDashArray,strokeLineCap:this.strokeLineCap,strokeDashOffset:this.strokeDashOffset,strokeLineJoin:this.strokeLineJoin,strokeUniform:this.strokeUniform,strokeMiterLimit:e(this.strokeMiterLimit,l),scaleX:e(this.scaleX,l),scaleY:e(this.scaleY,l),angle:e(this.angle,l),flipX:this.flipX,flipY:this.flipY,opacity:e(this.opacity,l),shadow:this.shadow&&this.shadow.toObject?this.shadow.toObject():this.shadow,visible:this.visible,backgroundColor:this.backgroundColor,fillRule:this.fillRule,paintFirst:this.paintFirst,globalCompositeOperation:this.globalCompositeOperation,skewX:e(this.skewX,l),skewY:e(this.skewY,l)};return this.clipPath&&!this.clipPath.excludeFromExport&&(d.clipPath=this.clipPath.toObject(h),d.clipPath.inverted=this.clipPath.inverted,d.clipPath.absolutePositioned=this.clipPath.absolutePositioned),i.util.populateWithProperties(this,d,h),this.includeDefaultValues||(d=this._removeDefaultValues(d)),d},toDatalessObject:function(h){return this.toObject(h)},_removeDefaultValues:function(h){var l=i.util.getKlass(h.type).prototype;return l.stateProperties.forEach(function(d){d!=="left"&&d!=="top"&&(h[d]===l[d]&&delete h[d],Array.isArray(h[d])&&Array.isArray(l[d])&&h[d].length===0&&l[d].length===0&&delete h[d])}),h},toString:function(){return"#<fabric."+t(this.type)+">"},getObjectScaling:function(){if(!this.group)return{scaleX:this.scaleX,scaleY:this.scaleY};var h=i.util.qrDecompose(this.calcTransformMatrix());return{scaleX:Math.abs(h.scaleX),scaleY:Math.abs(h.scaleY)}},getTotalObjectScaling:function(){var h=this.getObjectScaling(),l=h.scaleX,d=h.scaleY;if(this.canvas){var p=this.canvas.getZoom(),m=this.canvas.getRetinaScaling();l*=p*m,d*=p*m}return{scaleX:l,scaleY:d}},getObjectOpacity:function(){var h=this.opacity;return this.group&&(h*=this.group.getObjectOpacity()),h},_set:function(h,l){var d=h==="scaleX"||h==="scaleY",p=this[h]!==l,m=!1;return d&&(l=this._constrainScale(l)),h==="scaleX"&&l<0?(this.flipX=!this.flipX,l*=-1):h==="scaleY"&&l<0?(this.flipY=!this.flipY,l*=-1):h!=="shadow"||!l||l instanceof i.Shadow?h==="dirty"&&this.group&&this.group.set("dirty",l):l=new i.Shadow(l),this[h]=l,p&&(m=this.group&&this.group.isOnACache(),this.cacheProperties.indexOf(h)>-1?(this.dirty=!0,m&&this.group.set("dirty",!0)):m&&this.stateProperties.indexOf(h)>-1&&this.group.set("dirty",!0)),this},setOnGroup:function(){},getViewportTransform:function(){return this.canvas&&this.canvas.viewportTransform?this.canvas.viewportTransform:i.iMatrix.concat()},isNotVisible:function(){return this.opacity===0||!this.width&&!this.height&&this.strokeWidth===0||!this.visible},render:function(h){this.isNotVisible()||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(h.save(),this._setupCompositeOperation(h),this.drawSelectionBackground(h),this.transform(h),this._setOpacity(h),this._setShadow(h,this),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(h)):(this._removeCacheCanvas(),this.dirty=!1,this.drawObject(h),this.objectCaching&&this.statefullCache&&this.saveState({propertySet:"cacheProperties"})),h.restore())},renderCache:function(h){h=h||{},this._cacheCanvas&&this._cacheContext||this._createCacheCanvas(),this.isCacheDirty()&&(this.statefullCache&&this.saveState({propertySet:"cacheProperties"}),this.drawObject(this._cacheContext,h.forClipping),this.dirty=!1)},_removeCacheCanvas:function(){this._cacheCanvas=null,this._cacheContext=null,this.cacheWidth=0,this.cacheHeight=0},hasStroke:function(){return this.stroke&&this.stroke!=="transparent"&&this.strokeWidth!==0},hasFill:function(){return this.fill&&this.fill!=="transparent"},needsItsOwnCache:function(){return!(this.paintFirst!=="stroke"||!this.hasFill()||!this.hasStroke()||typeof this.shadow!="object")||!!this.clipPath},shouldCache:function(){return this.ownCaching=this.needsItsOwnCache()||this.objectCaching&&(!this.group||!this.group.isOnACache()),this.ownCaching},willDrawShadow:function(){return!!this.shadow&&(this.shadow.offsetX!==0||this.shadow.offsetY!==0)},drawClipPathOnCache:function(h,l){if(h.save(),l.inverted?h.globalCompositeOperation="destination-out":h.globalCompositeOperation="destination-in",l.absolutePositioned){var d=i.util.invertTransform(this.calcTransformMatrix());h.transform(d[0],d[1],d[2],d[3],d[4],d[5])}l.transform(h),h.scale(1/l.zoomX,1/l.zoomY),h.drawImage(l._cacheCanvas,-l.cacheTranslationX,-l.cacheTranslationY),h.restore()},drawObject:function(h,l){var d=this.fill,p=this.stroke;l?(this.fill="black",this.stroke="",this._setClippingProperties(h)):this._renderBackground(h),this._render(h),this._drawClipPath(h,this.clipPath),this.fill=d,this.stroke=p},_drawClipPath:function(h,l){l&&(l.canvas=this.canvas,l.shouldCache(),l._transformDone=!0,l.renderCache({forClipping:!0}),this.drawClipPathOnCache(h,l))},drawCacheOnCanvas:function(h){h.scale(1/this.zoomX,1/this.zoomY),h.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)},isCacheDirty:function(h){if(this.isNotVisible())return!1;if(this._cacheCanvas&&this._cacheContext&&!h&&this._updateCacheCanvas())return!0;if(this.dirty||this.clipPath&&this.clipPath.absolutePositioned||this.statefullCache&&this.hasStateChanged("cacheProperties")){if(this._cacheCanvas&&this._cacheContext&&!h){var l=this.cacheWidth/this.zoomX,d=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-l/2,-d/2,l,d)}return!0}return!1},_renderBackground:function(h){if(this.backgroundColor){var l=this._getNonTransformedDimensions();h.fillStyle=this.backgroundColor,h.fillRect(-l.x/2,-l.y/2,l.x,l.y),this._removeShadow(h)}},_setOpacity:function(h){this.group&&!this.group._transformDone?h.globalAlpha=this.getObjectOpacity():h.globalAlpha*=this.opacity},_setStrokeStyles:function(h,l){var d=l.stroke;d&&(h.lineWidth=l.strokeWidth,h.lineCap=l.strokeLineCap,h.lineDashOffset=l.strokeDashOffset,h.lineJoin=l.strokeLineJoin,h.miterLimit=l.strokeMiterLimit,d.toLive?d.gradientUnits==="percentage"||d.gradientTransform||d.patternTransform?this._applyPatternForTransformedGradient(h,d):(h.strokeStyle=d.toLive(h,this),this._applyPatternGradientTransform(h,d)):h.strokeStyle=l.stroke)},_setFillStyles:function(h,l){var d=l.fill;d&&(d.toLive?(h.fillStyle=d.toLive(h,this),this._applyPatternGradientTransform(h,l.fill)):h.fillStyle=d)},_setClippingProperties:function(h){h.globalAlpha=1,h.strokeStyle="transparent",h.fillStyle="#000000"},_setLineDash:function(h,l){l&&l.length!==0&&(1&l.length&&l.push.apply(l,l),h.setLineDash(l))},_renderControls:function(h,l){var d,p,m,b=this.getViewportTransform(),y=this.calcTransformMatrix();p=(l=l||{}).hasBorders!==void 0?l.hasBorders:this.hasBorders,m=l.hasControls!==void 0?l.hasControls:this.hasControls,y=i.util.multiplyTransformMatrices(b,y),d=i.util.qrDecompose(y),h.save(),h.translate(d.translateX,d.translateY),h.lineWidth=1*this.borderScaleFactor,this.group||(h.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),this.flipX&&(d.angle-=180),h.rotate(s(this.group?d.angle:this.angle)),l.forActiveSelection||this.group?p&&this.drawBordersInGroup(h,d,l):p&&this.drawBorders(h,l),m&&this.drawControls(h,l),h.restore()},_setShadow:function(h){if(this.shadow){var l,d=this.shadow,p=this.canvas,m=p&&p.viewportTransform[0]||1,b=p&&p.viewportTransform[3]||1;l=d.nonScaling?{scaleX:1,scaleY:1}:this.getObjectScaling(),p&&p._isRetinaScaling()&&(m*=i.devicePixelRatio,b*=i.devicePixelRatio),h.shadowColor=d.color,h.shadowBlur=d.blur*i.browserShadowBlurConstant*(m+b)*(l.scaleX+l.scaleY)/4,h.shadowOffsetX=d.offsetX*m*l.scaleX,h.shadowOffsetY=d.offsetY*b*l.scaleY}},_removeShadow:function(h){this.shadow&&(h.shadowColor="",h.shadowBlur=h.shadowOffsetX=h.shadowOffsetY=0)},_applyPatternGradientTransform:function(h,l){if(!l||!l.toLive)return{offsetX:0,offsetY:0};var d=l.gradientTransform||l.patternTransform,p=-this.width/2+l.offsetX||0,m=-this.height/2+l.offsetY||0;return l.gradientUnits==="percentage"?h.transform(this.width,0,0,this.height,p,m):h.transform(1,0,0,1,p,m),d&&h.transform(d[0],d[1],d[2],d[3],d[4],d[5]),{offsetX:p,offsetY:m}},_renderPaintInOrder:function(h){this.paintFirst==="stroke"?(this._renderStroke(h),this._renderFill(h)):(this._renderFill(h),this._renderStroke(h))},_render:function(){},_renderFill:function(h){this.fill&&(h.save(),this._setFillStyles(h,this),this.fillRule==="evenodd"?h.fill("evenodd"):h.fill(),h.restore())},_renderStroke:function(h){if(this.stroke&&this.strokeWidth!==0){if(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(h),h.save(),this.strokeUniform&&this.group){var l=this.getObjectScaling();h.scale(1/l.scaleX,1/l.scaleY)}else this.strokeUniform&&h.scale(1/this.scaleX,1/this.scaleY);this._setLineDash(h,this.strokeDashArray),this._setStrokeStyles(h,this),h.stroke(),h.restore()}},_applyPatternForTransformedGradient:function(h,l){var d,p=this._limitCacheSize(this._getCacheCanvasDimensions()),m=i.util.createCanvasElement(),b=this.canvas.getRetinaScaling(),y=p.x/this.scaleX/b,w=p.y/this.scaleY/b;m.width=y,m.height=w,(d=m.getContext("2d")).beginPath(),d.moveTo(0,0),d.lineTo(y,0),d.lineTo(y,w),d.lineTo(0,w),d.closePath(),d.translate(y/2,w/2),d.scale(p.zoomX/this.scaleX/b,p.zoomY/this.scaleY/b),this._applyPatternGradientTransform(d,l),d.fillStyle=l.toLive(h),d.fill(),h.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),h.scale(b*this.scaleX/p.zoomX,b*this.scaleY/p.zoomY),h.strokeStyle=d.createPattern(m,"no-repeat")},_findCenterFromElement:function(){return{x:this.left+this.width/2,y:this.top+this.height/2}},_assignTransformMatrixProps:function(){if(this.transformMatrix){var h=i.util.qrDecompose(this.transformMatrix);this.flipX=!1,this.flipY=!1,this.set("scaleX",h.scaleX),this.set("scaleY",h.scaleY),this.angle=h.angle,this.skewX=h.skewX,this.skewY=0}},_removeTransformMatrix:function(h){var l=this._findCenterFromElement();this.transformMatrix&&(this._assignTransformMatrixProps(),l=i.util.transformPoint(l,this.transformMatrix)),this.transformMatrix=null,h&&(this.scaleX*=h.scaleX,this.scaleY*=h.scaleY,this.cropX=h.cropX,this.cropY=h.cropY,l.x+=h.offsetLeft,l.y+=h.offsetTop,this.width=h.width,this.height=h.height),this.setPositionByOrigin(l,"center","center")},clone:function(h,l){var d=this.toObject(l);this.constructor.fromObject?this.constructor.fromObject(d,h):i.Object._fromObject("Object",d,h)},cloneAsImage:function(h,l){var d=this.toCanvasElement(l);return h&&h(new i.Image(d)),this},toCanvasElement:function(h){h||(h={});var l=i.util,d=l.saveObjectTransform(this),p=this.group,m=this.shadow,b=Math.abs,y=(h.multiplier||1)*(h.enableRetinaScaling?i.devicePixelRatio:1);delete this.group,h.withoutTransform&&l.resetObjectTransform(this),h.withoutShadow&&(this.shadow=null);var w,T,k,P,G=i.util.createCanvasElement(),V=this.getBoundingRect(!0,!0),N=this.shadow,A={x:0,y:0};N&&(T=N.blur,w=N.nonScaling?{scaleX:1,scaleY:1}:this.getObjectScaling(),A.x=2*Math.round(b(N.offsetX)+T)*b(w.scaleX),A.y=2*Math.round(b(N.offsetY)+T)*b(w.scaleY)),k=V.width+A.x,P=V.height+A.y,G.width=Math.ceil(k),G.height=Math.ceil(P);var O=new i.StaticCanvas(G,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1});h.format==="jpeg"&&(O.backgroundColor="#fff"),this.setPositionByOrigin(new i.Point(O.width/2,O.height/2),"center","center");var B=this.canvas;O.add(this);var W=O.toCanvasElement(y||1,h);return this.shadow=m,this.set("canvas",B),p&&(this.group=p),this.set(d).setCoords(),O._objects=[],O.dispose(),O=null,W},toDataURL:function(h){return h||(h={}),i.util.toDataURL(this.toCanvasElement(h),h.format||"png",h.quality||1)},isType:function(h){return arguments.length>1?Array.from(arguments).includes(this.type):this.type===h},complexity:function(){return 1},toJSON:function(h){return this.toObject(h)},rotate:function(h){var l=(this.originX!=="center"||this.originY!=="center")&&this.centeredRotation;return l&&this._setOriginToCenter(),this.set("angle",h),l&&this._resetOrigin(),this},centerH:function(){return this.canvas&&this.canvas.centerObjectH(this),this},viewportCenterH:function(){return this.canvas&&this.canvas.viewportCenterObjectH(this),this},centerV:function(){return this.canvas&&this.canvas.centerObjectV(this),this},viewportCenterV:function(){return this.canvas&&this.canvas.viewportCenterObjectV(this),this},center:function(){return this.canvas&&this.canvas.centerObject(this),this},viewportCenter:function(){return this.canvas&&this.canvas.viewportCenterObject(this),this},getLocalPointer:function(h,l){l=l||this.canvas.getPointer(h);var d=new i.Point(l.x,l.y),p=this._getLeftTopCoords();return this.angle&&(d=i.util.rotatePoint(d,p,s(-this.angle))),{x:d.x-p.x,y:d.y-p.y}},_setupCompositeOperation:function(h){this.globalCompositeOperation&&(h.globalCompositeOperation=this.globalCompositeOperation)},dispose:function(){i.runningAnimations&&i.runningAnimations.cancelByTarget(this)}}),i.util.createAccessors&&i.util.createAccessors(i.Object),n(i.Object.prototype,i.Observable),i.Object.NUM_FRACTION_DIGITS=2,i.Object.ENLIVEN_PROPS=["clipPath"],i.Object._fromObject=function(h,l,d,p){var m=i[h];l=a(l,!0),i.util.enlivenPatterns([l.fill,l.stroke],function(b){b[0]!==void 0&&(l.fill=b[0]),b[1]!==void 0&&(l.stroke=b[1]),i.util.enlivenObjectEnlivables(l,l,function(){var y=p?new m(l[p],l):new m(l);d&&d(y)})})},i.Object.__uid=0)}(o),pe=g.util.degreesToRadians,_e={left:-.5,center:0,right:.5},Se={top:-.5,center:0,bottom:.5},g.util.object.extend(g.Object.prototype,{translateToGivenOrigin:function(r,i,n,a,e){var t,s,c,h=r.x,l=r.y;return typeof i=="string"?i=_e[i]:i-=.5,typeof a=="string"?a=_e[a]:a-=.5,typeof n=="string"?n=Se[n]:n-=.5,typeof e=="string"?e=Se[e]:e-=.5,s=e-n,((t=a-i)||s)&&(c=this._getTransformedDimensions(),h=r.x+t*c.x,l=r.y+s*c.y),new g.Point(h,l)},translateToCenterPoint:function(r,i,n){var a=this.translateToGivenOrigin(r,i,n,"center","center");return this.angle?g.util.rotatePoint(a,r,pe(this.angle)):a},translateToOriginPoint:function(r,i,n){var a=this.translateToGivenOrigin(r,"center","center",i,n);return this.angle?g.util.rotatePoint(a,r,pe(this.angle)):a},getCenterPoint:function(){var r=new g.Point(this.left,this.top);return this.translateToCenterPoint(r,this.originX,this.originY)},getPointByOrigin:function(r,i){var n=this.getCenterPoint();return this.translateToOriginPoint(n,r,i)},toLocalPoint:function(r,i,n){var a,e,t=this.getCenterPoint();return a=i!==void 0&&n!==void 0?this.translateToGivenOrigin(t,"center","center",i,n):new g.Point(this.left,this.top),e=new g.Point(r.x,r.y),this.angle&&(e=g.util.rotatePoint(e,t,-pe(this.angle))),e.subtractEquals(a)},setPositionByOrigin:function(r,i,n){var a=this.translateToCenterPoint(r,i,n),e=this.translateToOriginPoint(a,this.originX,this.originY);this.set("left",e.x),this.set("top",e.y)},adjustPosition:function(r){var i,n,a=pe(this.angle),e=this.getScaledWidth(),t=g.util.cos(a)*e,s=g.util.sin(a)*e;i=typeof this.originX=="string"?_e[this.originX]:this.originX-.5,n=typeof r=="string"?_e[r]:r-.5,this.left+=t*(n-i),this.top+=s*(n-i),this.setCoords(),this.originX=r},_setOriginToCenter:function(){this._originalOriginX=this.originX,this._originalOriginY=this.originY;var r=this.getCenterPoint();this.originX="center",this.originY="center",this.left=r.x,this.top=r.y},_resetOrigin:function(){var r=this.translateToOriginPoint(this.getCenterPoint(),this._originalOriginX,this._originalOriginY);this.originX=this._originalOriginX,this.originY=this._originalOriginY,this.left=r.x,this.top=r.y,this._originalOriginX=null,this._originalOriginY=null},_getLeftTopCoords:function(){return this.translateToOriginPoint(this.getCenterPoint(),"left","top")}}),function(){var r=g.util,i=r.degreesToRadians,n=r.multiplyTransformMatrices,a=r.transformPoint;r.object.extend(g.Object.prototype,{oCoords:null,aCoords:null,lineCoords:null,ownMatrixCache:null,matrixCache:null,controls:{},_getCoords:function(e,t){return t?e?this.calcACoords():this.calcLineCoords():(this.aCoords&&this.lineCoords||this.setCoords(!0),e?this.aCoords:this.lineCoords)},getCoords:function(e,t){return s=this._getCoords(e,t),[new g.Point(s.tl.x,s.tl.y),new g.Point(s.tr.x,s.tr.y),new g.Point(s.br.x,s.br.y),new g.Point(s.bl.x,s.bl.y)];var s},intersectsWithRect:function(e,t,s,c){var h=this.getCoords(s,c);return g.Intersection.intersectPolygonRectangle(h,e,t).status==="Intersection"},intersectsWithObject:function(e,t,s){return g.Intersection.intersectPolygonPolygon(this.getCoords(t,s),e.getCoords(t,s)).status==="Intersection"||e.isContainedWithinObject(this,t,s)||this.isContainedWithinObject(e,t,s)},isContainedWithinObject:function(e,t,s){for(var c=this.getCoords(t,s),h=t?e.aCoords:e.lineCoords,l=0,d=e._getImageLines(h);l<4;l++)if(!e.containsPoint(c[l],d))return!1;return!0},isContainedWithinRect:function(e,t,s,c){var h=this.getBoundingRect(s,c);return h.left>=e.x&&h.left+h.width<=t.x&&h.top>=e.y&&h.top+h.height<=t.y},containsPoint:function(e,t,s,c){var h=this._getCoords(s,c),l=(t=t||this._getImageLines(h),this._findCrossPoints(e,t));return l!==0&&l%2==1},isOnScreen:function(e){if(!this.canvas)return!1;var t=this.canvas.vptCoords.tl,s=this.canvas.vptCoords.br;return!!this.getCoords(!0,e).some(function(c){return c.x<=s.x&&c.x>=t.x&&c.y<=s.y&&c.y>=t.y})||!!this.intersectsWithRect(t,s,!0,e)||this._containsCenterOfCanvas(t,s,e)},_containsCenterOfCanvas:function(e,t,s){var c={x:(e.x+t.x)/2,y:(e.y+t.y)/2};return!!this.containsPoint(c,null,!0,s)},isPartiallyOnScreen:function(e){if(!this.canvas)return!1;var t=this.canvas.vptCoords.tl,s=this.canvas.vptCoords.br;return!!this.intersectsWithRect(t,s,!0,e)||this.getCoords(!0,e).every(function(c){return(c.x>=s.x||c.x<=t.x)&&(c.y>=s.y||c.y<=t.y)})&&this._containsCenterOfCanvas(t,s,e)},_getImageLines:function(e){return{topline:{o:e.tl,d:e.tr},rightline:{o:e.tr,d:e.br},bottomline:{o:e.br,d:e.bl},leftline:{o:e.bl,d:e.tl}}},_findCrossPoints:function(e,t){var s,c,h,l=0;for(var d in t)if(!((h=t[d]).o.y<e.y&&h.d.y<e.y||h.o.y>=e.y&&h.d.y>=e.y||(h.o.x===h.d.x&&h.o.x>=e.x?c=h.o.x:(s=(h.d.y-h.o.y)/(h.d.x-h.o.x),c=-(e.y-0*e.x-(h.o.y-s*h.o.x))/(0-s)),c>=e.x&&(l+=1),l!==2)))break;return l},getBoundingRect:function(e,t){var s=this.getCoords(e,t);return r.makeBoundingBoxFromPoints(s)},getScaledWidth:function(){return this._getTransformedDimensions().x},getScaledHeight:function(){return this._getTransformedDimensions().y},_constrainScale:function(e){return Math.abs(e)<this.minScaleLimit?e<0?-this.minScaleLimit:this.minScaleLimit:e===0?1e-4:e},scale:function(e){return this._set("scaleX",e),this._set("scaleY",e),this.setCoords()},scaleToWidth:function(e,t){var s=this.getBoundingRect(t).width/this.getScaledWidth();return this.scale(e/this.width/s)},scaleToHeight:function(e,t){var s=this.getBoundingRect(t).height/this.getScaledHeight();return this.scale(e/this.height/s)},calcLineCoords:function(){var e=this.getViewportTransform(),t=this.padding,s=i(this.angle),c=r.cos(s)*t,h=r.sin(s)*t,l=c+h,d=c-h,p=this.calcACoords(),m={tl:a(p.tl,e),tr:a(p.tr,e),bl:a(p.bl,e),br:a(p.br,e)};return t&&(m.tl.x-=d,m.tl.y-=l,m.tr.x+=l,m.tr.y-=d,m.bl.x-=l,m.bl.y+=d,m.br.x+=d,m.br.y+=l),m},calcOCoords:function(){var e=this._calcRotateMatrix(),t=this._calcTranslateMatrix(),s=this.getViewportTransform(),c=n(s,t),h=n(c,e),l=(h=n(h,[1/s[0],0,0,1/s[3],0,0]),this._calculateCurrentDimensions()),d={};return this.forEachControl(function(p,m,b){d[m]=p.positionHandler(l,h,b)}),d},calcACoords:function(){var e=this._calcRotateMatrix(),t=this._calcTranslateMatrix(),s=n(t,e),c=this._getTransformedDimensions(),h=c.x/2,l=c.y/2;return{tl:a({x:-h,y:-l},s),tr:a({x:h,y:-l},s),bl:a({x:-h,y:l},s),br:a({x:h,y:l},s)}},setCoords:function(e){return this.aCoords=this.calcACoords(),this.lineCoords=this.group?this.aCoords:this.calcLineCoords(),e||(this.oCoords=this.calcOCoords(),this._setCornerCoords&&this._setCornerCoords()),this},_calcRotateMatrix:function(){return r.calcRotateMatrix(this)},_calcTranslateMatrix:function(){var e=this.getCenterPoint();return[1,0,0,1,e.x,e.y]},transformMatrixKey:function(e){var t="_",s="";return!e&&this.group&&(s=this.group.transformMatrixKey(e)+t),s+this.top+t+this.left+t+this.scaleX+t+this.scaleY+t+this.skewX+t+this.skewY+t+this.angle+t+this.originX+t+this.originY+t+this.width+t+this.height+t+this.strokeWidth+this.flipX+this.flipY},calcTransformMatrix:function(e){var t=this.calcOwnMatrix();if(e||!this.group)return t;var s=this.transformMatrixKey(e),c=this.matrixCache||(this.matrixCache={});return c.key===s?c.value:(this.group&&(t=n(this.group.calcTransformMatrix(!1),t)),c.key=s,c.value=t,t)},calcOwnMatrix:function(){var e=this.transformMatrixKey(!0),t=this.ownMatrixCache||(this.ownMatrixCache={});if(t.key===e)return t.value;var s=this._calcTranslateMatrix(),c={angle:this.angle,translateX:s[4],translateY:s[5],scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,flipX:this.flipX,flipY:this.flipY};return t.key=e,t.value=r.composeMatrix(c),t.value},_getNonTransformedDimensions:function(){var e=this.strokeWidth;return{x:this.width+e,y:this.height+e}},_getTransformedDimensions:function(e,t){e===void 0&&(e=this.skewX),t===void 0&&(t=this.skewY);var s,c,h,l=e===0&&t===0;if(this.strokeUniform?(c=this.width,h=this.height):(c=(s=this._getNonTransformedDimensions()).x,h=s.y),l)return this._finalizeDimensions(c*this.scaleX,h*this.scaleY);var d=r.sizeAfterTransform(c,h,{scaleX:this.scaleX,scaleY:this.scaleY,skewX:e,skewY:t});return this._finalizeDimensions(d.x,d.y)},_finalizeDimensions:function(e,t){return this.strokeUniform?{x:e+this.strokeWidth,y:t+this.strokeWidth}:{x:e,y:t}},_calculateCurrentDimensions:function(){var e=this.getViewportTransform(),t=this._getTransformedDimensions();return a(t,e,!0).scalarAdd(2*this.padding)}})}(),g.util.object.extend(g.Object.prototype,{sendToBack:function(){return this.group?g.StaticCanvas.prototype.sendToBack.call(this.group,this):this.canvas&&this.canvas.sendToBack(this),this},bringToFront:function(){return this.group?g.StaticCanvas.prototype.bringToFront.call(this.group,this):this.canvas&&this.canvas.bringToFront(this),this},sendBackwards:function(r){return this.group?g.StaticCanvas.prototype.sendBackwards.call(this.group,this,r):this.canvas&&this.canvas.sendBackwards(this,r),this},bringForward:function(r){return this.group?g.StaticCanvas.prototype.bringForward.call(this.group,this,r):this.canvas&&this.canvas.bringForward(this,r),this},moveTo:function(r){return this.group&&this.group.type!=="activeSelection"?g.StaticCanvas.prototype.moveTo.call(this.group,this,r):this.canvas&&this.canvas.moveTo(this,r),this}}),function(){function r(n,a){if(a){if(a.toLive)return n+": url(#SVGID_"+a.id+"); ";var e=new g.Color(a),t=n+": "+e.toRgb()+"; ",s=e.getAlpha();return s!==1&&(t+=n+"-opacity: "+s.toString()+"; "),t}return n+": none; "}var i=g.util.toFixed;g.util.object.extend(g.Object.prototype,{getSvgStyles:function(n){var a=this.fillRule?this.fillRule:"nonzero",e=this.strokeWidth?this.strokeWidth:"0",t=this.strokeDashArray?this.strokeDashArray.join(" "):"none",s=this.strokeDashOffset?this.strokeDashOffset:"0",c=this.strokeLineCap?this.strokeLineCap:"butt",h=this.strokeLineJoin?this.strokeLineJoin:"miter",l=this.strokeMiterLimit?this.strokeMiterLimit:"4",d=this.opacity!==void 0?this.opacity:"1",p=this.visible?"":" visibility: hidden;",m=n?"":this.getSvgFilter(),b=r("fill",this.fill);return[r("stroke",this.stroke),"stroke-width: ",e,"; ","stroke-dasharray: ",t,"; ","stroke-linecap: ",c,"; ","stroke-dashoffset: ",s,"; ","stroke-linejoin: ",h,"; ","stroke-miterlimit: ",l,"; ",b,"fill-rule: ",a,"; ","opacity: ",d,";",m,p].join("")},getSvgSpanStyles:function(n,a){var e="; ",t=n.fontFamily?"font-family: "+(n.fontFamily.indexOf("'")===-1&&n.fontFamily.indexOf('"')===-1?"'"+n.fontFamily+"'":n.fontFamily)+e:"",s=n.strokeWidth?"stroke-width: "+n.strokeWidth+e:"",c=n.fontSize?"font-size: "+n.fontSize+"px"+e:"",h=n.fontStyle?"font-style: "+n.fontStyle+e:"",l=n.fontWeight?"font-weight: "+n.fontWeight+e:"",d=n.fill?r("fill",n.fill):"",p=n.stroke?r("stroke",n.stroke):"",m=this.getSvgTextDecoration(n);return m&&(m="text-decoration: "+m+e),[p,s,t,c,h,l,m,d,n.deltaY?"baseline-shift: "+-n.deltaY+"; ":"",a?"white-space: pre; ":""].join("")},getSvgTextDecoration:function(n){return["overline","underline","line-through"].filter(function(a){return n[a.replace("-","")]}).join(" ")},getSvgFilter:function(){return this.shadow?"filter: url(#SVGID_"+this.shadow.id+");":""},getSvgCommons:function(){return[this.id?'id="'+this.id+'" ':"",this.clipPath?'clip-path="url(#'+this.clipPath.clipPathId+')" ':""].join("")},getSvgTransform:function(n,a){var e=n?this.calcTransformMatrix():this.calcOwnMatrix();return'transform="'+g.util.matrixToSVG(e)+(a||"")+'" '},_setSVGBg:function(n){if(this.backgroundColor){var a=g.Object.NUM_FRACTION_DIGITS;n.push("		<rect ",this._getFillAttributes(this.backgroundColor),' x="',i(-this.width/2,a),'" y="',i(-this.height/2,a),'" width="',i(this.width,a),'" height="',i(this.height,a),'"></rect>\n')}},toSVG:function(n){return this._createBaseSVGMarkup(this._toSVG(n),{reviver:n})},toClipPathSVG:function(n){return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(n),{reviver:n})},_createBaseClipPathSVGMarkup:function(n,a){var e=(a=a||{}).reviver,t=a.additionalTransform||"",s=[this.getSvgTransform(!0,t),this.getSvgCommons()].join(""),c=n.indexOf("COMMON_PARTS");return n[c]=s,e?e(n.join("")):n.join("")},_createBaseSVGMarkup:function(n,a){var e,t,s=(a=a||{}).noStyle,c=a.reviver,h=s?"":'style="'+this.getSvgStyles()+'" ',l=a.withShadow?'style="'+this.getSvgFilter()+'" ':"",d=this.clipPath,p=this.strokeUniform?'vector-effect="non-scaling-stroke" ':"",m=d&&d.absolutePositioned,b=this.stroke,y=this.fill,w=this.shadow,T=[],k=n.indexOf("COMMON_PARTS"),P=a.additionalTransform;return d&&(d.clipPathId="CLIPPATH_"+g.Object.__uid++,t='<clipPath id="'+d.clipPathId+'" >\n'+d.toClipPathSVG(c)+"</clipPath>\n"),m&&T.push("<g ",l,this.getSvgCommons()," >\n"),T.push("<g ",this.getSvgTransform(!1),m?"":l+this.getSvgCommons()," >\n"),e=[h,p,s?"":this.addPaintOrder()," ",P?'transform="'+P+'" ':""].join(""),n[k]=e,y&&y.toLive&&T.push(y.toSVG(this)),b&&b.toLive&&T.push(b.toSVG(this)),w&&T.push(w.toSVG(this)),d&&T.push(t),T.push(n.join("")),T.push("</g>\n"),m&&T.push("</g>\n"),c?c(T.join("")):T.join("")},addPaintOrder:function(){return this.paintFirst!=="fill"?' paint-order="'+this.paintFirst+'" ':""}})}(),function(){var r=g.util.object.extend,i="stateProperties";function n(e,t,s){var c={};s.forEach(function(h){c[h]=e[h]}),r(e[t],c,!0)}function a(e,t,s){if(e===t)return!0;if(Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return!1;for(var c=0,h=e.length;c<h;c++)if(!a(e[c],t[c]))return!1;return!0}if(e&&typeof e=="object"){var l,d=Object.keys(e);if(!t||typeof t!="object"||!s&&d.length!==Object.keys(t).length)return!1;for(c=0,h=d.length;c<h;c++)if((l=d[c])!=="canvas"&&l!=="group"&&!a(e[l],t[l]))return!1;return!0}}g.util.object.extend(g.Object.prototype,{hasStateChanged:function(e){var t="_"+(e=e||i);return Object.keys(this[t]).length<this[e].length||!a(this[t],this,!0)},saveState:function(e){var t=e&&e.propertySet||i,s="_"+t;return this[s]?(n(this,s,this[t]),e&&e.stateProperties&&n(this,s,e.stateProperties),this):this.setupState(e)},setupState:function(e){var t=(e=e||{}).propertySet||i;return e.propertySet=t,this["_"+t]={},this.saveState(e),this}})}(),function(){var r=g.util.degreesToRadians;g.util.object.extend(g.Object.prototype,{_findTargetCorner:function(i,n){if(!this.hasControls||this.group||!this.canvas||this.canvas._activeObject!==this)return!1;var a,e,t,s=i.x,c=i.y,h=Object.keys(this.oCoords),l=h.length-1;for(this.__corner=0;l>=0;l--)if(t=h[l],this.isControlVisible(t)&&(e=this._getImageLines(n?this.oCoords[t].touchCorner:this.oCoords[t].corner),(a=this._findCrossPoints({x:s,y:c},e))!==0&&a%2==1))return this.__corner=t,t;return!1},forEachControl:function(i){for(var n in this.controls)i(this.controls[n],n,this)},_setCornerCoords:function(){var i=this.oCoords;for(var n in i){var a=this.controls[n];i[n].corner=a.calcCornerCoords(this.angle,this.cornerSize,i[n].x,i[n].y,!1),i[n].touchCorner=a.calcCornerCoords(this.angle,this.touchCornerSize,i[n].x,i[n].y,!0)}},drawSelectionBackground:function(i){if(!this.selectionBackgroundColor||this.canvas&&!this.canvas.interactive||this.canvas&&this.canvas._activeObject!==this)return this;i.save();var n=this.getCenterPoint(),a=this._calculateCurrentDimensions(),e=this.canvas.viewportTransform;return i.translate(n.x,n.y),i.scale(1/e[0],1/e[3]),i.rotate(r(this.angle)),i.fillStyle=this.selectionBackgroundColor,i.fillRect(-a.x/2,-a.y/2,a.x,a.y),i.restore(),this},drawBorders:function(i,n){n=n||{};var a=this._calculateCurrentDimensions(),e=this.borderScaleFactor,t=a.x+e,s=a.y+e,c=n.hasControls!==void 0?n.hasControls:this.hasControls,h=!1;return i.save(),i.strokeStyle=n.borderColor||this.borderColor,this._setLineDash(i,n.borderDashArray||this.borderDashArray),i.strokeRect(-t/2,-s/2,t,s),c&&(i.beginPath(),this.forEachControl(function(l,d,p){l.withConnection&&l.getVisibility(p,d)&&(h=!0,i.moveTo(l.x*t,l.y*s),i.lineTo(l.x*t+l.offsetX,l.y*s+l.offsetY))}),h&&i.stroke()),i.restore(),this},drawBordersInGroup:function(i,n,a){a=a||{};var e=g.util.sizeAfterTransform(this.width,this.height,n),t=this.strokeWidth,s=this.strokeUniform,c=this.borderScaleFactor,h=e.x+t*(s?this.canvas.getZoom():n.scaleX)+c,l=e.y+t*(s?this.canvas.getZoom():n.scaleY)+c;return i.save(),this._setLineDash(i,a.borderDashArray||this.borderDashArray),i.strokeStyle=a.borderColor||this.borderColor,i.strokeRect(-h/2,-l/2,h,l),i.restore(),this},drawControls:function(i,n){n=n||{},i.save();var a,e,t=this.canvas.getRetinaScaling();return i.setTransform(t,0,0,t,0,0),i.strokeStyle=i.fillStyle=n.cornerColor||this.cornerColor,this.transparentCorners||(i.strokeStyle=n.cornerStrokeColor||this.cornerStrokeColor),this._setLineDash(i,n.cornerDashArray||this.cornerDashArray),this.setCoords(),this.group&&(a=this.group.calcTransformMatrix()),this.forEachControl(function(s,c,h){e=h.oCoords[c],s.getVisibility(h,c)&&(a&&(e=g.util.transformPoint(e,a)),s.render(i,e.x,e.y,n,h))}),i.restore(),this},isControlVisible:function(i){return this.controls[i]&&this.controls[i].getVisibility(this,i)},setControlVisible:function(i,n){return this._controlsVisibility||(this._controlsVisibility={}),this._controlsVisibility[i]=n,this},setControlsVisibility:function(i){for(var n in i||(i={}),i)this.setControlVisible(n,i[n]);return this},onDeselect:function(){},onSelect:function(){}})}(),g.util.object.extend(g.StaticCanvas.prototype,{FX_DURATION:500,fxCenterObjectH:function(r,i){var n=function(){},a=(i=i||{}).onComplete||n,e=i.onChange||n,t=this;return g.util.animate({target:this,startValue:r.left,endValue:this.getCenterPoint().x,duration:this.FX_DURATION,onChange:function(s){r.set("left",s),t.requestRenderAll(),e()},onComplete:function(){r.setCoords(),a()}})},fxCenterObjectV:function(r,i){var n=function(){},a=(i=i||{}).onComplete||n,e=i.onChange||n,t=this;return g.util.animate({target:this,startValue:r.top,endValue:this.getCenterPoint().y,duration:this.FX_DURATION,onChange:function(s){r.set("top",s),t.requestRenderAll(),e()},onComplete:function(){r.setCoords(),a()}})},fxRemove:function(r,i){var n=function(){},a=(i=i||{}).onComplete||n,e=i.onChange||n,t=this;return g.util.animate({target:this,startValue:r.opacity,endValue:0,duration:this.FX_DURATION,onChange:function(s){r.set("opacity",s),t.requestRenderAll(),e()},onComplete:function(){t.remove(r),a()}})}}),g.util.object.extend(g.Object.prototype,{animate:function(){if(arguments[0]&&typeof arguments[0]=="object"){var r,i,n=[],a=[];for(r in arguments[0])n.push(r);for(var e=0,t=n.length;e<t;e++)r=n[e],i=e!==t-1,a.push(this._animate(r,arguments[0][r],arguments[1],i));return a}return this._animate.apply(this,arguments)},_animate:function(r,i,n,a){var e,t=this;i=i.toString(),n=n?g.util.object.clone(n):{},~r.indexOf(".")&&(e=r.split("."));var s=t.colorProperties.indexOf(r)>-1||e&&t.colorProperties.indexOf(e[1])>-1,c=e?this.get(e[0])[e[1]]:this.get(r);"from"in n||(n.from=c),s||(i=~i.indexOf("=")?c+parseFloat(i.replace("=","")):parseFloat(i));var h={target:this,startValue:n.from,endValue:i,byValue:n.by,easing:n.easing,duration:n.duration,abort:n.abort&&function(l,d,p){return n.abort.call(t,l,d,p)},onChange:function(l,d,p){e?t[e[0]][e[1]]=l:t.set(r,l),a||n.onChange&&n.onChange(l,d,p)},onComplete:function(l,d,p){a||(t.setCoords(),n.onComplete&&n.onComplete(l,d,p))}};return s?g.util.animateColor(h.startValue,h.endValue,h.duration,h):g.util.animate(h)}}),function(r){var i=r.fabric||(r.fabric={}),n=i.util.object.extend,a=i.util.object.clone,e={x1:1,x2:1,y1:1,y2:1};function t(s,c){var h=s.origin,l=s.axis1,d=s.axis2,p=s.dimension,m=c.nearest,b=c.center,y=c.farthest;return function(){switch(this.get(h)){case m:return Math.min(this.get(l),this.get(d));case b:return Math.min(this.get(l),this.get(d))+.5*this.get(p);case y:return Math.max(this.get(l),this.get(d))}}}i.Line?i.warn("fabric.Line is already defined"):(i.Line=i.util.createClass(i.Object,{type:"line",x1:0,y1:0,x2:0,y2:0,cacheProperties:i.Object.prototype.cacheProperties.concat("x1","x2","y1","y2"),initialize:function(s,c){s||(s=[0,0,0,0]),this.callSuper("initialize",c),this.set("x1",s[0]),this.set("y1",s[1]),this.set("x2",s[2]),this.set("y2",s[3]),this._setWidthHeight(c)},_setWidthHeight:function(s){s||(s={}),this.width=Math.abs(this.x2-this.x1),this.height=Math.abs(this.y2-this.y1),this.left="left"in s?s.left:this._getLeftToOriginX(),this.top="top"in s?s.top:this._getTopToOriginY()},_set:function(s,c){return this.callSuper("_set",s,c),e[s]!==void 0&&this._setWidthHeight(),this},_getLeftToOriginX:t({origin:"originX",axis1:"x1",axis2:"x2",dimension:"width"},{nearest:"left",center:"center",farthest:"right"}),_getTopToOriginY:t({origin:"originY",axis1:"y1",axis2:"y2",dimension:"height"},{nearest:"top",center:"center",farthest:"bottom"}),_render:function(s){s.beginPath();var c=this.calcLinePoints();s.moveTo(c.x1,c.y1),s.lineTo(c.x2,c.y2),s.lineWidth=this.strokeWidth;var h=s.strokeStyle;s.strokeStyle=this.stroke||s.fillStyle,this.stroke&&this._renderStroke(s),s.strokeStyle=h},_findCenterFromElement:function(){return{x:(this.x1+this.x2)/2,y:(this.y1+this.y2)/2}},toObject:function(s){return n(this.callSuper("toObject",s),this.calcLinePoints())},_getNonTransformedDimensions:function(){var s=this.callSuper("_getNonTransformedDimensions");return this.strokeLineCap==="butt"&&(this.width===0&&(s.y-=this.strokeWidth),this.height===0&&(s.x-=this.strokeWidth)),s},calcLinePoints:function(){var s=this.x1<=this.x2?-1:1,c=this.y1<=this.y2?-1:1,h=s*this.width*.5,l=c*this.height*.5;return{x1:h,x2:s*this.width*-.5,y1:l,y2:c*this.height*-.5}},_toSVG:function(){var s=this.calcLinePoints();return["<line ","COMMON_PARTS",'x1="',s.x1,'" y1="',s.y1,'" x2="',s.x2,'" y2="',s.y2,'" />\n']}}),i.Line.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("x1 y1 x2 y2".split(" ")),i.Line.fromElement=function(s,c,h){h=h||{};var l=i.parseAttributes(s,i.Line.ATTRIBUTE_NAMES),d=[l.x1||0,l.y1||0,l.x2||0,l.y2||0];c(new i.Line(d,n(l,h)))},i.Line.fromObject=function(s,c){var h=a(s,!0);h.points=[s.x1,s.y1,s.x2,s.y2],i.Object._fromObject("Line",h,function(l){delete l.points,c&&c(l)},"points")})}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.util.degreesToRadians;i.Circle?i.warn("fabric.Circle is already defined."):(i.Circle=i.util.createClass(i.Object,{type:"circle",radius:0,startAngle:0,endAngle:360,cacheProperties:i.Object.prototype.cacheProperties.concat("radius","startAngle","endAngle"),_set:function(a,e){return this.callSuper("_set",a,e),a==="radius"&&this.setRadius(e),this},toObject:function(a){return this.callSuper("toObject",["radius","startAngle","endAngle"].concat(a))},_toSVG:function(){var a,e=(this.endAngle-this.startAngle)%360;if(e===0)a=["<circle ","COMMON_PARTS",'cx="0" cy="0" ','r="',this.radius,'" />\n'];else{var t=n(this.startAngle),s=n(this.endAngle),c=this.radius;a=['<path d="M '+i.util.cos(t)*c+" "+i.util.sin(t)*c," A "+c+" "+c," 0 ",+(e>180?"1":"0")+" 1"," "+i.util.cos(s)*c+" "+i.util.sin(s)*c,'" ',"COMMON_PARTS"," />\n"]}return a},_render:function(a){a.beginPath(),a.arc(0,0,this.radius,n(this.startAngle),n(this.endAngle),!1),this._renderPaintInOrder(a)},getRadiusX:function(){return this.get("radius")*this.get("scaleX")},getRadiusY:function(){return this.get("radius")*this.get("scaleY")},setRadius:function(a){return this.radius=a,this.set("width",2*a).set("height",2*a)}}),i.Circle.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("cx cy r".split(" ")),i.Circle.fromElement=function(a,e){var t,s=i.parseAttributes(a,i.Circle.ATTRIBUTE_NAMES);if(!("radius"in(t=s)&&t.radius>=0))throw new Error("value of `r` attribute is required and can not be negative");s.left=(s.left||0)-s.radius,s.top=(s.top||0)-s.radius,e(new i.Circle(s))},i.Circle.fromObject=function(a,e){i.Object._fromObject("Circle",a,e)})}(o),function(r){var i=r.fabric||(r.fabric={});i.Triangle?i.warn("fabric.Triangle is already defined"):(i.Triangle=i.util.createClass(i.Object,{type:"triangle",width:100,height:100,_render:function(n){var a=this.width/2,e=this.height/2;n.beginPath(),n.moveTo(-a,e),n.lineTo(0,-e),n.lineTo(a,e),n.closePath(),this._renderPaintInOrder(n)},_toSVG:function(){var n=this.width/2,a=this.height/2;return["<polygon ","COMMON_PARTS",'points="',[-n+" "+a,"0 "+-a,n+" "+a].join(","),'" />']}}),i.Triangle.fromObject=function(n,a){return i.Object._fromObject("Triangle",n,a)})}(o),function(r){var i=r.fabric||(r.fabric={}),n=2*Math.PI;i.Ellipse?i.warn("fabric.Ellipse is already defined."):(i.Ellipse=i.util.createClass(i.Object,{type:"ellipse",rx:0,ry:0,cacheProperties:i.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(a){this.callSuper("initialize",a),this.set("rx",a&&a.rx||0),this.set("ry",a&&a.ry||0)},_set:function(a,e){switch(this.callSuper("_set",a,e),a){case"rx":this.rx=e,this.set("width",2*e);break;case"ry":this.ry=e,this.set("height",2*e)}return this},getRx:function(){return this.get("rx")*this.get("scaleX")},getRy:function(){return this.get("ry")*this.get("scaleY")},toObject:function(a){return this.callSuper("toObject",["rx","ry"].concat(a))},_toSVG:function(){return["<ellipse ","COMMON_PARTS",'cx="0" cy="0" ','rx="',this.rx,'" ry="',this.ry,'" />\n']},_render:function(a){a.beginPath(),a.save(),a.transform(1,0,0,this.ry/this.rx,0,0),a.arc(0,0,this.rx,0,n,!1),a.restore(),this._renderPaintInOrder(a)}}),i.Ellipse.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("cx cy rx ry".split(" ")),i.Ellipse.fromElement=function(a,e){var t=i.parseAttributes(a,i.Ellipse.ATTRIBUTE_NAMES);t.left=(t.left||0)-t.rx,t.top=(t.top||0)-t.ry,e(new i.Ellipse(t))},i.Ellipse.fromObject=function(a,e){i.Object._fromObject("Ellipse",a,e)})}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.util.object.extend;i.Rect?i.warn("fabric.Rect is already defined"):(i.Rect=i.util.createClass(i.Object,{stateProperties:i.Object.prototype.stateProperties.concat("rx","ry"),type:"rect",rx:0,ry:0,cacheProperties:i.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(a){this.callSuper("initialize",a),this._initRxRy()},_initRxRy:function(){this.rx&&!this.ry?this.ry=this.rx:this.ry&&!this.rx&&(this.rx=this.ry)},_render:function(a){var e=this.rx?Math.min(this.rx,this.width/2):0,t=this.ry?Math.min(this.ry,this.height/2):0,s=this.width,c=this.height,h=-this.width/2,l=-this.height/2,d=e!==0||t!==0,p=.4477152502;a.beginPath(),a.moveTo(h+e,l),a.lineTo(h+s-e,l),d&&a.bezierCurveTo(h+s-p*e,l,h+s,l+p*t,h+s,l+t),a.lineTo(h+s,l+c-t),d&&a.bezierCurveTo(h+s,l+c-p*t,h+s-p*e,l+c,h+s-e,l+c),a.lineTo(h+e,l+c),d&&a.bezierCurveTo(h+p*e,l+c,h,l+c-p*t,h,l+c-t),a.lineTo(h,l+t),d&&a.bezierCurveTo(h,l+p*t,h+p*e,l,h+e,l),a.closePath(),this._renderPaintInOrder(a)},toObject:function(a){return this.callSuper("toObject",["rx","ry"].concat(a))},_toSVG:function(){return["<rect ","COMMON_PARTS",'x="',-this.width/2,'" y="',-this.height/2,'" rx="',this.rx,'" ry="',this.ry,'" width="',this.width,'" height="',this.height,'" />\n']}}),i.Rect.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("x y rx ry width height".split(" ")),i.Rect.fromElement=function(a,e,t){if(!a)return e(null);t=t||{};var s=i.parseAttributes(a,i.Rect.ATTRIBUTE_NAMES);s.left=s.left||0,s.top=s.top||0,s.height=s.height||0,s.width=s.width||0;var c=new i.Rect(n(t?i.util.object.clone(t):{},s));c.visible=c.visible&&c.width>0&&c.height>0,e(c)},i.Rect.fromObject=function(a,e){return i.Object._fromObject("Rect",a,e)})}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.util.object.extend,a=i.util.array.min,e=i.util.array.max,t=i.util.toFixed,s=i.util.projectStrokeOnPoints;i.Polyline?i.warn("fabric.Polyline is already defined"):(i.Polyline=i.util.createClass(i.Object,{type:"polyline",points:null,exactBoundingBox:!1,cacheProperties:i.Object.prototype.cacheProperties.concat("points"),initialize:function(c,h){h=h||{},this.points=c||[],this.callSuper("initialize",h),this._setPositionDimensions(h)},_projectStrokeOnPoints:function(){return s(this.points,this,!0)},_setPositionDimensions:function(c){var h,l=this._calcDimensions(c),d=this.exactBoundingBox?this.strokeWidth:0;this.width=l.width-d,this.height=l.height-d,c.fromSVG||(h=this.translateToGivenOrigin({x:l.left-this.strokeWidth/2+d/2,y:l.top-this.strokeWidth/2+d/2},"left","top",this.originX,this.originY)),c.left===void 0&&(this.left=c.fromSVG?l.left:h.x),c.top===void 0&&(this.top=c.fromSVG?l.top:h.y),this.pathOffset={x:l.left+this.width/2+d/2,y:l.top+this.height/2+d/2}},_calcDimensions:function(){var c=this.exactBoundingBox?this._projectStrokeOnPoints():this.points,h=a(c,"x")||0,l=a(c,"y")||0;return{left:h,top:l,width:(e(c,"x")||0)-h,height:(e(c,"y")||0)-l}},toObject:function(c){return n(this.callSuper("toObject",c),{points:this.points.concat()})},_toSVG:function(){for(var c=[],h=this.pathOffset.x,l=this.pathOffset.y,d=i.Object.NUM_FRACTION_DIGITS,p=0,m=this.points.length;p<m;p++)c.push(t(this.points[p].x-h,d),",",t(this.points[p].y-l,d)," ");return["<"+this.type+" ","COMMON_PARTS",'points="',c.join(""),'" />\n']},commonRender:function(c){var h,l=this.points.length,d=this.pathOffset.x,p=this.pathOffset.y;if(!l||isNaN(this.points[l-1].y))return!1;c.beginPath(),c.moveTo(this.points[0].x-d,this.points[0].y-p);for(var m=0;m<l;m++)h=this.points[m],c.lineTo(h.x-d,h.y-p);return!0},_render:function(c){this.commonRender(c)&&this._renderPaintInOrder(c)},complexity:function(){return this.get("points").length}}),i.Polyline.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat(),i.Polyline.fromElementGenerator=function(c){return function(h,l,d){if(!h)return l(null);d||(d={});var p=i.parsePointsAttribute(h.getAttribute("points")),m=i.parseAttributes(h,i[c].ATTRIBUTE_NAMES);m.fromSVG=!0,l(new i[c](p,n(m,d)))}},i.Polyline.fromElement=i.Polyline.fromElementGenerator("Polyline"),i.Polyline.fromObject=function(c,h){return i.Object._fromObject("Polyline",c,h,"points")})}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.util.projectStrokeOnPoints;i.Polygon?i.warn("fabric.Polygon is already defined"):(i.Polygon=i.util.createClass(i.Polyline,{type:"polygon",_projectStrokeOnPoints:function(){return n(this.points,this)},_render:function(a){this.commonRender(a)&&(a.closePath(),this._renderPaintInOrder(a))}}),i.Polygon.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat(),i.Polygon.fromElement=i.Polyline.fromElementGenerator("Polygon"),i.Polygon.fromObject=function(a,e){i.Object._fromObject("Polygon",a,e,"points")})}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.util.array.min,a=i.util.array.max,e=i.util.object.extend,t=i.util.object.clone,s=i.util.toFixed;i.Path?i.warn("fabric.Path is already defined"):(i.Path=i.util.createClass(i.Object,{type:"path",path:null,cacheProperties:i.Object.prototype.cacheProperties.concat("path","fillRule"),stateProperties:i.Object.prototype.stateProperties.concat("path"),initialize:function(c,h){delete(h=t(h||{})).path,this.callSuper("initialize",h),this._setPath(c||[],h)},_setPath:function(c,h){this.path=i.util.makePathSimpler(Array.isArray(c)?c:i.util.parsePath(c)),i.Polyline.prototype._setPositionDimensions.call(this,h||{})},_renderPathCommands:function(c){var h,l=0,d=0,p=0,m=0,b=0,y=0,w=-this.pathOffset.x,T=-this.pathOffset.y;c.beginPath();for(var k=0,P=this.path.length;k<P;++k)switch((h=this.path[k])[0]){case"L":p=h[1],m=h[2],c.lineTo(p+w,m+T);break;case"M":l=p=h[1],d=m=h[2],c.moveTo(p+w,m+T);break;case"C":p=h[5],m=h[6],b=h[3],y=h[4],c.bezierCurveTo(h[1]+w,h[2]+T,b+w,y+T,p+w,m+T);break;case"Q":c.quadraticCurveTo(h[1]+w,h[2]+T,h[3]+w,h[4]+T),p=h[3],m=h[4],b=h[1],y=h[2];break;case"z":case"Z":p=l,m=d,c.closePath()}},_render:function(c){this._renderPathCommands(c),this._renderPaintInOrder(c)},toString:function(){return"#<fabric.Path ("+this.complexity()+'): { "top": '+this.top+', "left": '+this.left+" }>"},toObject:function(c){return e(this.callSuper("toObject",c),{path:this.path.map(function(h){return h.slice()})})},toDatalessObject:function(c){var h=this.toObject(["sourcePath"].concat(c));return h.sourcePath&&delete h.path,h},_toSVG:function(){return["<path ","COMMON_PARTS",'d="',i.util.joinPath(this.path),'" stroke-linecap="round" ',"/>\n"]},_getOffsetTransform:function(){var c=i.Object.NUM_FRACTION_DIGITS;return" translate("+s(-this.pathOffset.x,c)+", "+s(-this.pathOffset.y,c)+")"},toClipPathSVG:function(c){var h=this._getOffsetTransform();return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(),{reviver:c,additionalTransform:h})},toSVG:function(c){var h=this._getOffsetTransform();return this._createBaseSVGMarkup(this._toSVG(),{reviver:c,additionalTransform:h})},complexity:function(){return this.path.length},_calcDimensions:function(){for(var c,h,l=[],d=[],p=0,m=0,b=0,y=0,w=0,T=this.path.length;w<T;++w){switch((c=this.path[w])[0]){case"L":b=c[1],y=c[2],h=[];break;case"M":p=b=c[1],m=y=c[2],h=[];break;case"C":h=i.util.getBoundsOfCurve(b,y,c[1],c[2],c[3],c[4],c[5],c[6]),b=c[5],y=c[6];break;case"Q":h=i.util.getBoundsOfCurve(b,y,c[1],c[2],c[1],c[2],c[3],c[4]),b=c[3],y=c[4];break;case"z":case"Z":b=p,y=m}h.forEach(function(G){l.push(G.x),d.push(G.y)}),l.push(b),d.push(y)}var k=n(l)||0,P=n(d)||0;return{left:k,top:P,width:(a(l)||0)-k,height:(a(d)||0)-P}}}),i.Path.fromObject=function(c,h){if(typeof c.sourcePath=="string"){var l=c.sourcePath;i.loadSVGFromURL(l,function(d){var p=d[0];p.setOptions(c),h&&h(p)})}else i.Object._fromObject("Path",c,h,"path")},i.Path.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat(["d"]),i.Path.fromElement=function(c,h,l){var d=i.parseAttributes(c,i.Path.ATTRIBUTE_NAMES);d.fromSVG=!0,h(new i.Path(d.d,e(d,l)))})}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.util.array.min,a=i.util.array.max;i.Group||(i.Group=i.util.createClass(i.Object,i.Collection,{type:"group",strokeWidth:0,subTargetCheck:!1,cacheProperties:[],useSetOnGroup:!1,initialize:function(e,t,s){t=t||{},this._objects=[],s&&this.callSuper("initialize",t),this._objects=e||[];for(var c=this._objects.length;c--;)this._objects[c].group=this;if(s)this._updateObjectsACoords();else{var h=t&&t.centerPoint;t.originX!==void 0&&(this.originX=t.originX),t.originY!==void 0&&(this.originY=t.originY),h||this._calcBounds(),this._updateObjectsCoords(h),delete t.centerPoint,this.callSuper("initialize",t)}this.setCoords()},_updateObjectsACoords:function(){for(var e=this._objects.length;e--;)this._objects[e].setCoords(!0)},_updateObjectsCoords:function(e){e=e||this.getCenterPoint();for(var t=this._objects.length;t--;)this._updateObjectCoords(this._objects[t],e)},_updateObjectCoords:function(e,t){var s=e.left,c=e.top;e.set({left:s-t.x,top:c-t.y}),e.group=this,e.setCoords(!0)},toString:function(){return"#<fabric.Group: ("+this.complexity()+")>"},addWithUpdate:function(e){var t=!!this.group;return this._restoreObjectsState(),i.util.resetObjectTransform(this),e&&(t&&i.util.removeTransformFromObject(e,this.group.calcTransformMatrix()),this._objects.push(e),e.group=this,e._set("canvas",this.canvas)),this._calcBounds(),this._updateObjectsCoords(),this.dirty=!0,t?this.group.addWithUpdate():this.setCoords(),this},removeWithUpdate:function(e){return this._restoreObjectsState(),i.util.resetObjectTransform(this),this.remove(e),this._calcBounds(),this._updateObjectsCoords(),this.setCoords(),this.dirty=!0,this},_onObjectAdded:function(e){this.dirty=!0,e.group=this,e._set("canvas",this.canvas)},_onObjectRemoved:function(e){this.dirty=!0,delete e.group},_set:function(e,t){var s=this._objects.length;if(this.useSetOnGroup)for(;s--;)this._objects[s].setOnGroup(e,t);if(e==="canvas")for(;s--;)this._objects[s]._set(e,t);i.Object.prototype._set.call(this,e,t)},toObject:function(e){var t=this.includeDefaultValues,s=this._objects.filter(function(h){return!h.excludeFromExport}).map(function(h){var l=h.includeDefaultValues;h.includeDefaultValues=t;var d=h.toObject(e);return h.includeDefaultValues=l,d}),c=i.Object.prototype.toObject.call(this,e);return c.objects=s,c},toDatalessObject:function(e){var t,s=this.sourcePath;if(s)t=s;else{var c=this.includeDefaultValues;t=this._objects.map(function(l){var d=l.includeDefaultValues;l.includeDefaultValues=c;var p=l.toDatalessObject(e);return l.includeDefaultValues=d,p})}var h=i.Object.prototype.toDatalessObject.call(this,e);return h.objects=t,h},render:function(e){this._transformDone=!0,this.callSuper("render",e),this._transformDone=!1},shouldCache:function(){var e=i.Object.prototype.shouldCache.call(this);if(e){for(var t=0,s=this._objects.length;t<s;t++)if(this._objects[t].willDrawShadow())return this.ownCaching=!1,!1}return e},willDrawShadow:function(){if(i.Object.prototype.willDrawShadow.call(this))return!0;for(var e=0,t=this._objects.length;e<t;e++)if(this._objects[e].willDrawShadow())return!0;return!1},isOnACache:function(){return this.ownCaching||this.group&&this.group.isOnACache()},drawObject:function(e){for(var t=0,s=this._objects.length;t<s;t++)this._objects[t].render(e);this._drawClipPath(e,this.clipPath)},isCacheDirty:function(e){if(this.callSuper("isCacheDirty",e))return!0;if(!this.statefullCache)return!1;for(var t=0,s=this._objects.length;t<s;t++)if(this._objects[t].isCacheDirty(!0)){if(this._cacheCanvas){var c=this.cacheWidth/this.zoomX,h=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-c/2,-h/2,c,h)}return!0}return!1},_restoreObjectsState:function(){var e=this.calcOwnMatrix();return this._objects.forEach(function(t){i.util.addTransformToObject(t,e),delete t.group,t.setCoords()}),this},destroy:function(){return this._objects.forEach(function(e){e.set("dirty",!0)}),this._restoreObjectsState()},dispose:function(){this.callSuper("dispose"),this.forEachObject(function(e){e.dispose&&e.dispose()}),this._objects=[]},toActiveSelection:function(){if(this.canvas){var e=this._objects,t=this.canvas;this._objects=[];var s=this.toObject();delete s.objects;var c=new i.ActiveSelection([]);return c.set(s),c.type="activeSelection",t.remove(this),e.forEach(function(h){h.group=c,h.dirty=!0,t.add(h)}),c.canvas=t,c._objects=e,t._activeObject=c,c.setCoords(),c}},ungroupOnCanvas:function(){return this._restoreObjectsState()},setObjectsCoords:function(){return this.forEachObject(function(e){e.setCoords(!0)}),this},_calcBounds:function(e){for(var t,s,c,h,l=[],d=[],p=["tr","br","bl","tl"],m=0,b=this._objects.length,y=p.length;m<b;++m){for(c=(t=this._objects[m]).calcACoords(),h=0;h<y;h++)s=p[h],l.push(c[s].x),d.push(c[s].y);t.aCoords=c}this._getBounds(l,d,e)},_getBounds:function(e,t,s){var c=new i.Point(n(e),n(t)),h=new i.Point(a(e),a(t)),l=c.y||0,d=c.x||0,p=h.x-c.x||0,m=h.y-c.y||0;this.width=p,this.height=m,s||this.setPositionByOrigin({x:d,y:l},"left","top")},_toSVG:function(e){for(var t=["<g ","COMMON_PARTS"," >\n"],s=0,c=this._objects.length;s<c;s++)t.push("		",this._objects[s].toSVG(e));return t.push("</g>\n"),t},getSvgStyles:function(){var e=this.opacity!==void 0&&this.opacity!==1?"opacity: "+this.opacity+";":"",t=this.visible?"":" visibility: hidden;";return[e,this.getSvgFilter(),t].join("")},toClipPathSVG:function(e){for(var t=[],s=0,c=this._objects.length;s<c;s++)t.push("	",this._objects[s].toClipPathSVG(e));return this._createBaseClipPathSVGMarkup(t,{reviver:e})}}),i.Group.fromObject=function(e,t){var s=e.objects,c=i.util.object.clone(e,!0);delete c.objects,typeof s!="string"?i.util.enlivenObjects(s,function(h){var l=i.util.object.clone(e,!0);delete l.objects,i.util.enlivenObjectEnlivables(e,l,function(){t&&t(new i.Group(h,l,!0))})}):i.loadSVGFromURL(s,function(h){var l=i.util.groupSVGElements(h,e,s);l.set(c),t&&t(l)})})}(o),function(r){var i=r.fabric||(r.fabric={});i.ActiveSelection||(i.ActiveSelection=i.util.createClass(i.Group,{type:"activeSelection",initialize:function(n,a){a=a||{},this._objects=n||[];for(var e=this._objects.length;e--;)this._objects[e].group=this;a.originX&&(this.originX=a.originX),a.originY&&(this.originY=a.originY),this._calcBounds(),this._updateObjectsCoords(),i.Object.prototype.initialize.call(this,a),this.setCoords()},toGroup:function(){var n=this._objects.concat();this._objects=[];var a=i.Object.prototype.toObject.call(this),e=new i.Group([]);if(delete a.type,e.set(a),n.forEach(function(s){s.canvas.remove(s),s.group=e}),e._objects=n,!this.canvas)return e;var t=this.canvas;return t.add(e),t._activeObject=e,e.setCoords(),e},onDeselect:function(){return this.destroy(),!1},toString:function(){return"#<fabric.ActiveSelection: ("+this.complexity()+")>"},shouldCache:function(){return!1},isOnACache:function(){return!1},_renderControls:function(n,a,e){n.save(),n.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1,this.callSuper("_renderControls",n,a),(e=e||{}).hasControls===void 0&&(e.hasControls=!1),e.forActiveSelection=!0;for(var t=0,s=this._objects.length;t<s;t++)this._objects[t]._renderControls(n,e);n.restore()}}),i.ActiveSelection.fromObject=function(n,a){i.util.enlivenObjects(n.objects,function(e){delete n.objects,a&&a(new i.ActiveSelection(e,n,!0))})})}(o),function(r){var i=g.util.object.extend;r.fabric||(r.fabric={}),r.fabric.Image?g.warn("fabric.Image is already defined."):(g.Image=g.util.createClass(g.Object,{type:"image",strokeWidth:0,srcFromAttribute:!1,_lastScaleX:1,_lastScaleY:1,_filterScalingX:1,_filterScalingY:1,minimumScaleTrigger:.5,stateProperties:g.Object.prototype.stateProperties.concat("cropX","cropY"),cacheProperties:g.Object.prototype.cacheProperties.concat("cropX","cropY"),cacheKey:"",cropX:0,cropY:0,imageSmoothing:!0,initialize:function(n,a){a||(a={}),this.filters=[],this.cacheKey="texture"+g.Object.__uid++,this.callSuper("initialize",a),this._initElement(n,a)},getElement:function(){return this._element||{}},setElement:function(n,a){return this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._element=n,this._originalElement=n,this._initConfig(a),this.filters.length!==0&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters(),this},removeTexture:function(n){var a=g.filterBackend;a&&a.evictCachesForKey&&a.evictCachesForKey(n)},dispose:function(){this.callSuper("dispose"),this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._cacheContext=void 0,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach((function(n){g.util.cleanUpJsdomNode(this[n]),this[n]=void 0}).bind(this))},getCrossOrigin:function(){return this._originalElement&&(this._originalElement.crossOrigin||null)},getOriginalSize:function(){var n=this.getElement();return{width:n.naturalWidth||n.width,height:n.naturalHeight||n.height}},_stroke:function(n){if(this.stroke&&this.strokeWidth!==0){var a=this.width/2,e=this.height/2;n.beginPath(),n.moveTo(-a,-e),n.lineTo(a,-e),n.lineTo(a,e),n.lineTo(-a,e),n.lineTo(-a,-e),n.closePath()}},toObject:function(n){var a=[];this.filters.forEach(function(t){t&&a.push(t.toObject())});var e=i(this.callSuper("toObject",["cropX","cropY"].concat(n)),{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:a});return this.resizeFilter&&(e.resizeFilter=this.resizeFilter.toObject()),e},hasCrop:function(){return this.cropX||this.cropY||this.width<this._element.width||this.height<this._element.height},_toSVG:function(){var n,a=[],e=[],t=this._element,s=-this.width/2,c=-this.height/2,h="",l="";if(!t)return[];if(this.hasCrop()){var d=g.Object.__uid++;a.push('<clipPath id="imageCrop_'+d+'">\n','	<rect x="'+s+'" y="'+c+'" width="'+this.width+'" height="'+this.height+'" />\n',"</clipPath>\n"),h=' clip-path="url(#imageCrop_'+d+')" '}if(this.imageSmoothing||(l='" image-rendering="optimizeSpeed'),e.push("	<image ","COMMON_PARTS",'xlink:href="',this.getSvgSrc(!0),'" x="',s-this.cropX,'" y="',c-this.cropY,'" width="',t.width||t.naturalWidth,'" height="',t.height||t.height,l,'"',h,"></image>\n"),this.stroke||this.strokeDashArray){var p=this.fill;this.fill=null,n=["	<rect ",'x="',s,'" y="',c,'" width="',this.width,'" height="',this.height,'" style="',this.getSvgStyles(),'"/>\n'],this.fill=p}return this.paintFirst!=="fill"?a.concat(n,e):a.concat(e,n)},getSrc:function(n){var a=n?this._element:this._originalElement;return a?a.toDataURL?a.toDataURL():this.srcFromAttribute?a.getAttribute("src"):a.src:this.src||""},setSrc:function(n,a,e){return g.util.loadImage(n,function(t,s){this.setElement(t,e),this._setWidthHeight(),a&&a(this,s)},this,e&&e.crossOrigin),this},toString:function(){return'#<fabric.Image: { src: "'+this.getSrc()+'" }>'},applyResizeFilters:function(){var n=this.resizeFilter,a=this.minimumScaleTrigger,e=this.getTotalObjectScaling(),t=e.scaleX,s=e.scaleY,c=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!n||t>a&&s>a)return this._element=c,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=t,void(this._lastScaleY=s);g.filterBackend||(g.filterBackend=g.initFilterBackend());var h=g.util.createCanvasElement(),l=this._filteredEl?this.cacheKey+"_filtered":this.cacheKey,d=c.width,p=c.height;h.width=d,h.height=p,this._element=h,this._lastScaleX=n.scaleX=t,this._lastScaleY=n.scaleY=s,g.filterBackend.applyFilters([n],c,d,p,this._element,l),this._filterScalingX=h.width/this._originalElement.width,this._filterScalingY=h.height/this._originalElement.height},applyFilters:function(n){if(n=(n=n||this.filters||[]).filter(function(c){return c&&!c.isNeutralState()}),this.set("dirty",!0),this.removeTexture(this.cacheKey+"_filtered"),n.length===0)return this._element=this._originalElement,this._filteredEl=null,this._filterScalingX=1,this._filterScalingY=1,this;var a=this._originalElement,e=a.naturalWidth||a.width,t=a.naturalHeight||a.height;if(this._element===this._originalElement){var s=g.util.createCanvasElement();s.width=e,s.height=t,this._element=s,this._filteredEl=s}else this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,e,t),this._lastScaleX=1,this._lastScaleY=1;return g.filterBackend||(g.filterBackend=g.initFilterBackend()),g.filterBackend.applyFilters(n,this._originalElement,e,t,this._element,this.cacheKey),this._originalElement.width===this._element.width&&this._originalElement.height===this._element.height||(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height),this},_render:function(n){g.util.setImageSmoothing(n,this.imageSmoothing),this.isMoving!==!0&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(n),this._renderPaintInOrder(n)},drawCacheOnCanvas:function(n){g.util.setImageSmoothing(n,this.imageSmoothing),g.Object.prototype.drawCacheOnCanvas.call(this,n)},shouldCache:function(){return this.needsItsOwnCache()},_renderFill:function(n){var a=this._element;if(a){var e=this._filterScalingX,t=this._filterScalingY,s=this.width,c=this.height,h=Math.min,l=Math.max,d=l(this.cropX,0),p=l(this.cropY,0),m=a.naturalWidth||a.width,b=a.naturalHeight||a.height,y=d*e,w=p*t,T=h(s*e,m-y),k=h(c*t,b-w),P=-s/2,G=-c/2,V=h(s,m/e-d),N=h(c,b/t-p);a&&n.drawImage(a,y,w,T,k,P,G,V,N)}},_needsResize:function(){var n=this.getTotalObjectScaling();return n.scaleX!==this._lastScaleX||n.scaleY!==this._lastScaleY},_resetWidthHeight:function(){this.set(this.getOriginalSize())},_initElement:function(n,a){this.setElement(g.util.getById(n),a),g.util.addClass(this.getElement(),g.Image.CSS_CANVAS)},_initConfig:function(n){n||(n={}),this.setOptions(n),this._setWidthHeight(n)},_initFilters:function(n,a){n&&n.length?g.util.enlivenObjects(n,function(e){a&&a(e)},"fabric.Image.filters"):a&&a()},_setWidthHeight:function(n){n||(n={});var a=this.getElement();this.width=n.width||a.naturalWidth||a.width||0,this.height=n.height||a.naturalHeight||a.height||0},parsePreserveAspectRatioAttribute:function(){var n,a=g.util.parsePreserveAspectRatioAttribute(this.preserveAspectRatio||""),e=this._element.width,t=this._element.height,s=1,c=1,h=0,l=0,d=0,p=0,m=this.width,b=this.height,y={width:m,height:b};return!a||a.alignX==="none"&&a.alignY==="none"?(s=m/e,c=b/t):(a.meetOrSlice==="meet"&&(n=(m-e*(s=c=g.util.findScaleToFit(this._element,y)))/2,a.alignX==="Min"&&(h=-n),a.alignX==="Max"&&(h=n),n=(b-t*c)/2,a.alignY==="Min"&&(l=-n),a.alignY==="Max"&&(l=n)),a.meetOrSlice==="slice"&&(n=e-m/(s=c=g.util.findScaleToCover(this._element,y)),a.alignX==="Mid"&&(d=n/2),a.alignX==="Max"&&(d=n),n=t-b/c,a.alignY==="Mid"&&(p=n/2),a.alignY==="Max"&&(p=n),e=m/s,t=b/c)),{width:e,height:t,scaleX:s,scaleY:c,offsetLeft:h,offsetTop:l,cropX:d,cropY:p}}}),g.Image.CSS_CANVAS="canvas-img",g.Image.prototype.getSvgSrc=g.Image.prototype.getSrc,g.Image.fromObject=function(n,a){var e=g.util.object.clone(n);g.util.loadImage(e.src,function(t,s){s?a&&a(null,!0):g.Image.prototype._initFilters.call(e,e.filters,function(c){e.filters=c||[],g.Image.prototype._initFilters.call(e,[e.resizeFilter],function(h){e.resizeFilter=h[0],g.util.enlivenObjectEnlivables(e,e,function(){var l=new g.Image(t,e);a(l,!1)})})})},null,e.crossOrigin)},g.Image.fromURL=function(n,a,e){g.util.loadImage(n,function(t,s){a&&a(new g.Image(t,e),s)},null,e&&e.crossOrigin)},g.Image.ATTRIBUTE_NAMES=g.SHARED_ATTRIBUTES.concat("x y width height preserveAspectRatio xlink:href crossOrigin image-rendering".split(" ")),g.Image.fromElement=function(n,a,e){var t=g.parseAttributes(n,g.Image.ATTRIBUTE_NAMES);g.Image.fromURL(t["xlink:href"],a,i(e?g.util.object.clone(e):{},t))})}(o),g.util.object.extend(g.Object.prototype,{_getAngleValueForStraighten:function(){var r=this.angle%360;return r>0?90*Math.round((r-1)/90):90*Math.round(r/90)},straighten:function(){return this.rotate(this._getAngleValueForStraighten())},fxStraighten:function(r){var i=function(){},n=(r=r||{}).onComplete||i,a=r.onChange||i,e=this;return g.util.animate({target:this,startValue:this.get("angle"),endValue:this._getAngleValueForStraighten(),duration:this.FX_DURATION,onChange:function(t){e.rotate(t),a()},onComplete:function(){e.setCoords(),n()}})}}),g.util.object.extend(g.StaticCanvas.prototype,{straightenObject:function(r){return r.straighten(),this.requestRenderAll(),this},fxStraightenObject:function(r){return r.fxStraighten({onChange:this.requestRenderAllBound})}}),function(){function r(n,a){var e="precision "+a+" float;\nvoid main(){}",t=n.createShader(n.FRAGMENT_SHADER);return n.shaderSource(t,e),n.compileShader(t),!!n.getShaderParameter(t,n.COMPILE_STATUS)}function i(n){n&&n.tileSize&&(this.tileSize=n.tileSize),this.setupGLContext(this.tileSize,this.tileSize),this.captureGPUInfo()}g.isWebglSupported=function(n){if(g.isLikelyNode)return!1;n=n||g.WebglFilterBackend.prototype.tileSize;var a=document.createElement("canvas"),e=a.getContext("webgl")||a.getContext("experimental-webgl"),t=!1;if(e){g.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),t=g.maxTextureSize>=n;for(var s=["highp","mediump","lowp"],c=0;c<3;c++)if(r(e,s[c])){g.webGlPrecision=s[c];break}}return this.isSupported=t,t},g.WebglFilterBackend=i,i.prototype={tileSize:2048,resources:{},setupGLContext:function(n,a){this.dispose(),this.createWebGLCanvas(n,a),this.aPosition=new Float32Array([0,0,0,1,1,0,1,1]),this.chooseFastestCopyGLTo2DMethod(n,a)},chooseFastestCopyGLTo2DMethod:function(n,a){var e,t=window.performance!==void 0;try{new ImageData(1,1),e=!0}catch(b){e=!1}var s=typeof ArrayBuffer<"u",c=typeof Uint8ClampedArray<"u";if(t&&e&&s&&c){var h=g.util.createCanvasElement(),l=new ArrayBuffer(n*a*4);if(g.forceGLPutImageData)return this.imageBuffer=l,void(this.copyGLTo2D=he);var d,p,m={imageBuffer:l,destinationWidth:n,destinationHeight:a,targetCanvas:h};h.width=n,h.height=a,d=window.performance.now(),oe.call(m,this.gl,m),p=window.performance.now()-d,d=window.performance.now(),he.call(m,this.gl,m),p>window.performance.now()-d?(this.imageBuffer=l,this.copyGLTo2D=he):this.copyGLTo2D=oe}},createWebGLCanvas:function(n,a){var e=g.util.createCanvasElement();e.width=n,e.height=a;var t={alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1},s=e.getContext("webgl",t);s||(s=e.getContext("experimental-webgl",t)),s&&(s.clearColor(0,0,0,0),this.canvas=e,this.gl=s)},applyFilters:function(n,a,e,t,s,c){var h,l=this.gl;c&&(h=this.getCachedTexture(c,a));var d={originalWidth:a.width||a.originalWidth,originalHeight:a.height||a.originalHeight,sourceWidth:e,sourceHeight:t,destinationWidth:e,destinationHeight:t,context:l,sourceTexture:this.createTexture(l,e,t,!h&&a),targetTexture:this.createTexture(l,e,t),originalTexture:h||this.createTexture(l,e,t,!h&&a),passes:n.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:s},p=l.createFramebuffer();return l.bindFramebuffer(l.FRAMEBUFFER,p),n.forEach(function(m){m&&m.applyTo(d)}),function(m){var b=m.targetCanvas,y=b.width,w=b.height,T=m.destinationWidth,k=m.destinationHeight;y===T&&w===k||(b.width=T,b.height=k)}(d),this.copyGLTo2D(l,d),l.bindTexture(l.TEXTURE_2D,null),l.deleteTexture(d.sourceTexture),l.deleteTexture(d.targetTexture),l.deleteFramebuffer(p),s.getContext("2d").setTransform(1,0,0,1,0,0),d},dispose:function(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()},clearWebGLCaches:function(){this.programCache={},this.textureCache={}},createTexture:function(n,a,e,t){var s=n.createTexture();return n.bindTexture(n.TEXTURE_2D,s),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),t?n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t):n.texImage2D(n.TEXTURE_2D,0,n.RGBA,a,e,0,n.RGBA,n.UNSIGNED_BYTE,null),s},getCachedTexture:function(n,a){if(this.textureCache[n])return this.textureCache[n];var e=this.createTexture(this.gl,a.width,a.height,a);return this.textureCache[n]=e,e},evictCachesForKey:function(n){this.textureCache[n]&&(this.gl.deleteTexture(this.textureCache[n]),delete this.textureCache[n])},copyGLTo2D:oe,captureGPUInfo:function(){if(this.gpuInfo)return this.gpuInfo;var n=this.gl,a={renderer:"",vendor:""};if(!n)return a;var e=n.getExtension("WEBGL_debug_renderer_info");if(e){var t=n.getParameter(e.UNMASKED_RENDERER_WEBGL),s=n.getParameter(e.UNMASKED_VENDOR_WEBGL);t&&(a.renderer=t.toLowerCase()),s&&(a.vendor=s.toLowerCase())}return this.gpuInfo=a,a}}}(),function(){var r=function(){};function i(){}g.Canvas2dFilterBackend=i,i.prototype={evictCachesForKey:r,dispose:r,clearWebGLCaches:r,resources:{},applyFilters:function(n,a,e,t,s){var c=s.getContext("2d");c.drawImage(a,0,0,e,t);var h={sourceWidth:e,sourceHeight:t,imageData:c.getImageData(0,0,e,t),originalEl:a,originalImageData:c.getImageData(0,0,e,t),canvasEl:s,ctx:c,filterBackend:this};return n.forEach(function(l){l.applyTo(h)}),h.imageData.width===e&&h.imageData.height===t||(s.width=h.imageData.width,s.height=h.imageData.height),c.putImageData(h.imageData,0,0),h}}}(),g.Image=g.Image||{},g.Image.filters=g.Image.filters||{},g.Image.filters.BaseFilter=g.util.createClass({type:"BaseFilter",vertexSource:"attribute vec2 aPosition;\nvarying vec2 vTexCoord;\nvoid main() {\nvTexCoord = aPosition;\ngl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);\n}",fragmentSource:"precision highp float;\nvarying vec2 vTexCoord;\nuniform sampler2D uTexture;\nvoid main() {\ngl_FragColor = texture2D(uTexture, vTexCoord);\n}",initialize:function(r){r&&this.setOptions(r)},setOptions:function(r){for(var i in r)this[i]=r[i]},createProgram:function(r,i,n){i=i||this.fragmentSource,n=n||this.vertexSource,g.webGlPrecision!=="highp"&&(i=i.replace(/precision highp float/g,"precision "+g.webGlPrecision+" float"));var a=r.createShader(r.VERTEX_SHADER);if(r.shaderSource(a,n),r.compileShader(a),!r.getShaderParameter(a,r.COMPILE_STATUS))throw new Error("Vertex shader compile error for "+this.type+": "+r.getShaderInfoLog(a));var e=r.createShader(r.FRAGMENT_SHADER);if(r.shaderSource(e,i),r.compileShader(e),!r.getShaderParameter(e,r.COMPILE_STATUS))throw new Error("Fragment shader compile error for "+this.type+": "+r.getShaderInfoLog(e));var t=r.createProgram();if(r.attachShader(t,a),r.attachShader(t,e),r.linkProgram(t),!r.getProgramParameter(t,r.LINK_STATUS))throw new Error('Shader link error for "${this.type}" '+r.getProgramInfoLog(t));var s=this.getAttributeLocations(r,t),c=this.getUniformLocations(r,t)||{};return c.uStepW=r.getUniformLocation(t,"uStepW"),c.uStepH=r.getUniformLocation(t,"uStepH"),{program:t,attributeLocations:s,uniformLocations:c}},getAttributeLocations:function(r,i){return{aPosition:r.getAttribLocation(i,"aPosition")}},getUniformLocations:function(){return{}},sendAttributeData:function(r,i,n){var a=i.aPosition,e=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,e),r.enableVertexAttribArray(a),r.vertexAttribPointer(a,2,r.FLOAT,!1,0,0),r.bufferData(r.ARRAY_BUFFER,n,r.STATIC_DRAW)},_setupFrameBuffer:function(r){var i,n,a=r.context;r.passes>1?(i=r.destinationWidth,n=r.destinationHeight,r.sourceWidth===i&&r.sourceHeight===n||(a.deleteTexture(r.targetTexture),r.targetTexture=r.filterBackend.createTexture(a,i,n)),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,r.targetTexture,0)):(a.bindFramebuffer(a.FRAMEBUFFER,null),a.finish())},_swapTextures:function(r){r.passes--,r.pass++;var i=r.targetTexture;r.targetTexture=r.sourceTexture,r.sourceTexture=i},isNeutralState:function(){var r=this.mainParameter,i=g.Image.filters[this.type].prototype;if(r){if(Array.isArray(i[r])){for(var n=i[r].length;n--;)if(this[r][n]!==i[r][n])return!1;return!0}return i[r]===this[r]}return!1},applyTo:function(r){r.webgl?(this._setupFrameBuffer(r),this.applyToWebGL(r),this._swapTextures(r)):this.applyTo2d(r)},retrieveShader:function(r){return r.programCache.hasOwnProperty(this.type)||(r.programCache[this.type]=this.createProgram(r.context)),r.programCache[this.type]},applyToWebGL:function(r){var i=r.context,n=this.retrieveShader(r);r.pass===0&&r.originalTexture?i.bindTexture(i.TEXTURE_2D,r.originalTexture):i.bindTexture(i.TEXTURE_2D,r.sourceTexture),i.useProgram(n.program),this.sendAttributeData(i,n.attributeLocations,r.aPosition),i.uniform1f(n.uniformLocations.uStepW,1/r.sourceWidth),i.uniform1f(n.uniformLocations.uStepH,1/r.sourceHeight),this.sendUniformData(i,n.uniformLocations),i.viewport(0,0,r.destinationWidth,r.destinationHeight),i.drawArrays(i.TRIANGLE_STRIP,0,4)},bindAdditionalTexture:function(r,i,n){r.activeTexture(n),r.bindTexture(r.TEXTURE_2D,i),r.activeTexture(r.TEXTURE0)},unbindAdditionalTexture:function(r,i){r.activeTexture(i),r.bindTexture(r.TEXTURE_2D,null),r.activeTexture(r.TEXTURE0)},getMainParameter:function(){return this[this.mainParameter]},setMainParameter:function(r){this[this.mainParameter]=r},sendUniformData:function(){},createHelpLayer:function(r){if(!r.helpLayer){var i=document.createElement("canvas");i.width=r.sourceWidth,i.height=r.sourceHeight,r.helpLayer=i}},toObject:function(){var r={type:this.type},i=this.mainParameter;return i&&(r[i]=this[i]),r},toJSON:function(){return this.toObject()}}),g.Image.filters.BaseFilter.fromObject=function(r,i){var n=new g.Image.filters[r.type](r);return i&&i(n),n},function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.ColorMatrix=a(n.BaseFilter,{type:"ColorMatrix",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nvarying vec2 vTexCoord;\nuniform mat4 uColorMatrix;\nuniform vec4 uConstants;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor *= uColorMatrix;\ncolor += uConstants;\ngl_FragColor = color;\n}",matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],mainParameter:"matrix",colorsOnly:!0,initialize:function(e){this.callSuper("initialize",e),this.matrix=this.matrix.slice(0)},applyTo2d:function(e){var t,s,c,h,l,d=e.imageData.data,p=d.length,m=this.matrix,b=this.colorsOnly;for(l=0;l<p;l+=4)t=d[l],s=d[l+1],c=d[l+2],b?(d[l]=t*m[0]+s*m[1]+c*m[2]+255*m[4],d[l+1]=t*m[5]+s*m[6]+c*m[7]+255*m[9],d[l+2]=t*m[10]+s*m[11]+c*m[12]+255*m[14]):(h=d[l+3],d[l]=t*m[0]+s*m[1]+c*m[2]+h*m[3]+255*m[4],d[l+1]=t*m[5]+s*m[6]+c*m[7]+h*m[8]+255*m[9],d[l+2]=t*m[10]+s*m[11]+c*m[12]+h*m[13]+255*m[14],d[l+3]=t*m[15]+s*m[16]+c*m[17]+h*m[18]+255*m[19])},getUniformLocations:function(e,t){return{uColorMatrix:e.getUniformLocation(t,"uColorMatrix"),uConstants:e.getUniformLocation(t,"uConstants")}},sendUniformData:function(e,t){var s=this.matrix,c=[s[0],s[1],s[2],s[3],s[5],s[6],s[7],s[8],s[10],s[11],s[12],s[13],s[15],s[16],s[17],s[18]],h=[s[4],s[9],s[14],s[19]];e.uniformMatrix4fv(t.uColorMatrix,!1,c),e.uniform4fv(t.uConstants,h)}}),i.Image.filters.ColorMatrix.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.Brightness=a(n.BaseFilter,{type:"Brightness",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uBrightness;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor.rgb += uBrightness;\ngl_FragColor = color;\n}",brightness:0,mainParameter:"brightness",applyTo2d:function(e){if(this.brightness!==0){var t,s=e.imageData.data,c=s.length,h=Math.round(255*this.brightness);for(t=0;t<c;t+=4)s[t]=s[t]+h,s[t+1]=s[t+1]+h,s[t+2]=s[t+2]+h}},getUniformLocations:function(e,t){return{uBrightness:e.getUniformLocation(t,"uBrightness")}},sendUniformData:function(e,t){e.uniform1f(t.uBrightness,this.brightness)}}),i.Image.filters.Brightness.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.util.object.extend,a=i.Image.filters,e=i.util.createClass;a.Convolute=e(a.BaseFilter,{type:"Convolute",opaque:!1,matrix:[0,0,0,0,1,0,0,0,0],fragmentSource:{Convolute_3_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[9];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 3.0; h+=1.0) {\nfor (float w = 0.0; w < 3.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_3_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[9];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 3.0; h+=1.0) {\nfor (float w = 0.0; w < 3.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_5_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[25];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 5.0; h+=1.0) {\nfor (float w = 0.0; w < 5.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_5_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[25];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 5.0; h+=1.0) {\nfor (float w = 0.0; w < 5.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_7_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[49];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 7.0; h+=1.0) {\nfor (float w = 0.0; w < 7.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_7_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[49];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 7.0; h+=1.0) {\nfor (float w = 0.0; w < 7.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_9_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[81];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 9.0; h+=1.0) {\nfor (float w = 0.0; w < 9.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_9_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[81];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 9.0; h+=1.0) {\nfor (float w = 0.0; w < 9.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}"},retrieveShader:function(t){var s=Math.sqrt(this.matrix.length),c=this.type+"_"+s+"_"+(this.opaque?1:0),h=this.fragmentSource[c];return t.programCache.hasOwnProperty(c)||(t.programCache[c]=this.createProgram(t.context,h)),t.programCache[c]},applyTo2d:function(t){var s,c,h,l,d,p,m,b,y,w,T,k,P,G=t.imageData,V=G.data,N=this.matrix,A=Math.round(Math.sqrt(N.length)),O=Math.floor(A/2),B=G.width,W=G.height,H=t.ctx.createImageData(B,W),R=H.data,D=this.opaque?1:0;for(T=0;T<W;T++)for(w=0;w<B;w++){for(d=4*(T*B+w),s=0,c=0,h=0,l=0,P=0;P<A;P++)for(k=0;k<A;k++)p=w+k-O,(m=T+P-O)<0||m>=W||p<0||p>=B||(b=4*(m*B+p),y=N[P*A+k],s+=V[b]*y,c+=V[b+1]*y,h+=V[b+2]*y,D||(l+=V[b+3]*y));R[d]=s,R[d+1]=c,R[d+2]=h,R[d+3]=D?V[d+3]:l}t.imageData=H},getUniformLocations:function(t,s){return{uMatrix:t.getUniformLocation(s,"uMatrix"),uOpaque:t.getUniformLocation(s,"uOpaque"),uHalfSize:t.getUniformLocation(s,"uHalfSize"),uSize:t.getUniformLocation(s,"uSize")}},sendUniformData:function(t,s){t.uniform1fv(s.uMatrix,this.matrix)},toObject:function(){return n(this.callSuper("toObject"),{opaque:this.opaque,matrix:this.matrix})}}),i.Image.filters.Convolute.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.Grayscale=a(n.BaseFilter,{type:"Grayscale",fragmentSource:{average:"precision highp float;\nuniform sampler2D uTexture;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat average = (color.r + color.b + color.g) / 3.0;\ngl_FragColor = vec4(average, average, average, color.a);\n}",lightness:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uMode;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 col = texture2D(uTexture, vTexCoord);\nfloat average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;\ngl_FragColor = vec4(average, average, average, col.a);\n}",luminosity:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uMode;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 col = texture2D(uTexture, vTexCoord);\nfloat average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;\ngl_FragColor = vec4(average, average, average, col.a);\n}"},mode:"average",mainParameter:"mode",applyTo2d:function(e){var t,s,c=e.imageData.data,h=c.length,l=this.mode;for(t=0;t<h;t+=4)l==="average"?s=(c[t]+c[t+1]+c[t+2])/3:l==="lightness"?s=(Math.min(c[t],c[t+1],c[t+2])+Math.max(c[t],c[t+1],c[t+2]))/2:l==="luminosity"&&(s=.21*c[t]+.72*c[t+1]+.07*c[t+2]),c[t]=s,c[t+1]=s,c[t+2]=s},retrieveShader:function(e){var t=this.type+"_"+this.mode;if(!e.programCache.hasOwnProperty(t)){var s=this.fragmentSource[this.mode];e.programCache[t]=this.createProgram(e.context,s)}return e.programCache[t]},getUniformLocations:function(e,t){return{uMode:e.getUniformLocation(t,"uMode")}},sendUniformData:function(e,t){e.uniform1i(t.uMode,1)},isNeutralState:function(){return!1}}),i.Image.filters.Grayscale.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.Invert=a(n.BaseFilter,{type:"Invert",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uInvert;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nif (uInvert == 1) {\ngl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);\n} else {\ngl_FragColor = color;\n}\n}",invert:!0,mainParameter:"invert",applyTo2d:function(e){var t,s=e.imageData.data,c=s.length;for(t=0;t<c;t+=4)s[t]=255-s[t],s[t+1]=255-s[t+1],s[t+2]=255-s[t+2]},isNeutralState:function(){return!this.invert},getUniformLocations:function(e,t){return{uInvert:e.getUniformLocation(t,"uInvert")}},sendUniformData:function(e,t){e.uniform1i(t.uInvert,this.invert)}}),i.Image.filters.Invert.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.util.object.extend,a=i.Image.filters,e=i.util.createClass;a.Noise=e(a.BaseFilter,{type:"Noise",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uStepH;\nuniform float uNoise;\nuniform float uSeed;\nvarying vec2 vTexCoord;\nfloat rand(vec2 co, float seed, float vScale) {\nreturn fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);\n}\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;\ngl_FragColor = color;\n}",mainParameter:"noise",noise:0,applyTo2d:function(t){if(this.noise!==0){var s,c,h=t.imageData.data,l=h.length,d=this.noise;for(s=0,l=h.length;s<l;s+=4)c=(.5-Math.random())*d,h[s]+=c,h[s+1]+=c,h[s+2]+=c}},getUniformLocations:function(t,s){return{uNoise:t.getUniformLocation(s,"uNoise"),uSeed:t.getUniformLocation(s,"uSeed")}},sendUniformData:function(t,s){t.uniform1f(s.uNoise,this.noise/255),t.uniform1f(s.uSeed,Math.random())},toObject:function(){return n(this.callSuper("toObject"),{noise:this.noise})}}),i.Image.filters.Noise.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.Pixelate=a(n.BaseFilter,{type:"Pixelate",blocksize:4,mainParameter:"blocksize",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uBlocksize;\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nfloat blockW = uBlocksize * uStepW;\nfloat blockH = uBlocksize * uStepW;\nint posX = int(vTexCoord.x / blockW);\nint posY = int(vTexCoord.y / blockH);\nfloat fposX = float(posX);\nfloat fposY = float(posY);\nvec2 squareCoords = vec2(fposX * blockW, fposY * blockH);\nvec4 color = texture2D(uTexture, squareCoords);\ngl_FragColor = color;\n}",applyTo2d:function(e){var t,s,c,h,l,d,p,m,b,y,w,T=e.imageData,k=T.data,P=T.height,G=T.width;for(s=0;s<P;s+=this.blocksize)for(c=0;c<G;c+=this.blocksize)for(h=k[t=4*s*G+4*c],l=k[t+1],d=k[t+2],p=k[t+3],y=Math.min(s+this.blocksize,P),w=Math.min(c+this.blocksize,G),m=s;m<y;m++)for(b=c;b<w;b++)k[t=4*m*G+4*b]=h,k[t+1]=l,k[t+2]=d,k[t+3]=p},isNeutralState:function(){return this.blocksize===1},getUniformLocations:function(e,t){return{uBlocksize:e.getUniformLocation(t,"uBlocksize"),uStepW:e.getUniformLocation(t,"uStepW"),uStepH:e.getUniformLocation(t,"uStepH")}},sendUniformData:function(e,t){e.uniform1f(t.uBlocksize,this.blocksize)}}),i.Image.filters.Pixelate.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.util.object.extend,a=i.Image.filters,e=i.util.createClass;a.RemoveColor=e(a.BaseFilter,{type:"RemoveColor",color:"#FFFFFF",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec4 uLow;\nuniform vec4 uHigh;\nvarying vec2 vTexCoord;\nvoid main() {\ngl_FragColor = texture2D(uTexture, vTexCoord);\nif(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {\ngl_FragColor.a = 0.0;\n}\n}",distance:.02,useAlpha:!1,applyTo2d:function(t){var s,c,h,l,d=t.imageData.data,p=255*this.distance,m=new i.Color(this.color).getSource(),b=[m[0]-p,m[1]-p,m[2]-p],y=[m[0]+p,m[1]+p,m[2]+p];for(s=0;s<d.length;s+=4)c=d[s],h=d[s+1],l=d[s+2],c>b[0]&&h>b[1]&&l>b[2]&&c<y[0]&&h<y[1]&&l<y[2]&&(d[s+3]=0)},getUniformLocations:function(t,s){return{uLow:t.getUniformLocation(s,"uLow"),uHigh:t.getUniformLocation(s,"uHigh")}},sendUniformData:function(t,s){var c=new i.Color(this.color).getSource(),h=parseFloat(this.distance),l=[0+c[0]/255-h,0+c[1]/255-h,0+c[2]/255-h,1],d=[c[0]/255+h,c[1]/255+h,c[2]/255+h,1];t.uniform4fv(s.uLow,l),t.uniform4fv(s.uHigh,d)},toObject:function(){return n(this.callSuper("toObject"),{color:this.color,distance:this.distance})}}),i.Image.filters.RemoveColor.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass,e={Brownie:[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0],Vintage:[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0],Kodachrome:[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0],Technicolor:[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0],Polaroid:[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0],Sepia:[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0],BlackWhite:[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]};for(var t in e)n[t]=a(n.ColorMatrix,{type:t,matrix:e[t],mainParameter:!1,colorsOnly:!0}),i.Image.filters[t].fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric,n=i.Image.filters,a=i.util.createClass;n.BlendColor=a(n.BaseFilter,{type:"BlendColor",color:"#F95C63",mode:"multiply",alpha:1,fragmentSource:{multiply:"gl_FragColor.rgb *= uColor.rgb;\n",screen:"gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);\n",add:"gl_FragColor.rgb += uColor.rgb;\n",diff:"gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);\n",subtract:"gl_FragColor.rgb -= uColor.rgb;\n",lighten:"gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);\n",darken:"gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);\n",exclusion:"gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);\n",overlay:"if (uColor.r < 0.5) {\ngl_FragColor.r *= 2.0 * uColor.r;\n} else {\ngl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);\n}\nif (uColor.g < 0.5) {\ngl_FragColor.g *= 2.0 * uColor.g;\n} else {\ngl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);\n}\nif (uColor.b < 0.5) {\ngl_FragColor.b *= 2.0 * uColor.b;\n} else {\ngl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);\n}\n",tint:"gl_FragColor.rgb *= (1.0 - uColor.a);\ngl_FragColor.rgb += uColor.rgb;\n"},buildSource:function(e){return"precision highp float;\nuniform sampler2D uTexture;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ngl_FragColor = color;\nif (color.a > 0.0) {\n"+this.fragmentSource[e]+"}\n}"},retrieveShader:function(e){var t,s=this.type+"_"+this.mode;return e.programCache.hasOwnProperty(s)||(t=this.buildSource(this.mode),e.programCache[s]=this.createProgram(e.context,t)),e.programCache[s]},applyTo2d:function(e){var t,s,c,h,l,d,p,m=e.imageData.data,b=m.length,y=1-this.alpha;t=(p=new i.Color(this.color).getSource())[0]*this.alpha,s=p[1]*this.alpha,c=p[2]*this.alpha;for(var w=0;w<b;w+=4)switch(h=m[w],l=m[w+1],d=m[w+2],this.mode){case"multiply":m[w]=h*t/255,m[w+1]=l*s/255,m[w+2]=d*c/255;break;case"screen":m[w]=255-(255-h)*(255-t)/255,m[w+1]=255-(255-l)*(255-s)/255,m[w+2]=255-(255-d)*(255-c)/255;break;case"add":m[w]=h+t,m[w+1]=l+s,m[w+2]=d+c;break;case"diff":case"difference":m[w]=Math.abs(h-t),m[w+1]=Math.abs(l-s),m[w+2]=Math.abs(d-c);break;case"subtract":m[w]=h-t,m[w+1]=l-s,m[w+2]=d-c;break;case"darken":m[w]=Math.min(h,t),m[w+1]=Math.min(l,s),m[w+2]=Math.min(d,c);break;case"lighten":m[w]=Math.max(h,t),m[w+1]=Math.max(l,s),m[w+2]=Math.max(d,c);break;case"overlay":m[w]=t<128?2*h*t/255:255-2*(255-h)*(255-t)/255,m[w+1]=s<128?2*l*s/255:255-2*(255-l)*(255-s)/255,m[w+2]=c<128?2*d*c/255:255-2*(255-d)*(255-c)/255;break;case"exclusion":m[w]=t+h-2*t*h/255,m[w+1]=s+l-2*s*l/255,m[w+2]=c+d-2*c*d/255;break;case"tint":m[w]=t+h*y,m[w+1]=s+l*y,m[w+2]=c+d*y}},getUniformLocations:function(e,t){return{uColor:e.getUniformLocation(t,"uColor")}},sendUniformData:function(e,t){var s=new i.Color(this.color).getSource();s[0]=this.alpha*s[0]/255,s[1]=this.alpha*s[1]/255,s[2]=this.alpha*s[2]/255,s[3]=this.alpha,e.uniform4fv(t.uColor,s)},toObject:function(){return{type:this.type,color:this.color,mode:this.mode,alpha:this.alpha}}}),i.Image.filters.BlendColor.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric,n=i.Image.filters,a=i.util.createClass;n.BlendImage=a(n.BaseFilter,{type:"BlendImage",image:null,mode:"multiply",alpha:1,vertexSource:"attribute vec2 aPosition;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nuniform mat3 uTransformMatrix;\nvoid main() {\nvTexCoord = aPosition;\nvTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;\ngl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);\n}",fragmentSource:{multiply:"precision highp float;\nuniform sampler2D uTexture;\nuniform sampler2D uImage;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec4 color2 = texture2D(uImage, vTexCoord2);\ncolor.rgba *= color2.rgba;\ngl_FragColor = color;\n}",mask:"precision highp float;\nuniform sampler2D uTexture;\nuniform sampler2D uImage;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec4 color2 = texture2D(uImage, vTexCoord2);\ncolor.a = color2.a;\ngl_FragColor = color;\n}"},retrieveShader:function(e){var t=this.type+"_"+this.mode,s=this.fragmentSource[this.mode];return e.programCache.hasOwnProperty(t)||(e.programCache[t]=this.createProgram(e.context,s)),e.programCache[t]},applyToWebGL:function(e){var t=e.context,s=this.createTexture(e.filterBackend,this.image);this.bindAdditionalTexture(t,s,t.TEXTURE1),this.callSuper("applyToWebGL",e),this.unbindAdditionalTexture(t,t.TEXTURE1)},createTexture:function(e,t){return e.getCachedTexture(t.cacheKey,t._element)},calculateMatrix:function(){var e=this.image,t=e._element.width,s=e._element.height;return[1/e.scaleX,0,0,0,1/e.scaleY,0,-e.left/t,-e.top/s,1]},applyTo2d:function(e){var t,s,c,h,l,d,p,m,b,y,w,T=e.imageData,k=e.filterBackend.resources,P=T.data,G=P.length,V=T.width,N=T.height,A=this.image;k.blendImage||(k.blendImage=i.util.createCanvasElement()),y=(b=k.blendImage).getContext("2d"),b.width!==V||b.height!==N?(b.width=V,b.height=N):y.clearRect(0,0,V,N),y.setTransform(A.scaleX,0,0,A.scaleY,A.left,A.top),y.drawImage(A._element,0,0,V,N),w=y.getImageData(0,0,V,N).data;for(var O=0;O<G;O+=4)switch(l=P[O],d=P[O+1],p=P[O+2],m=P[O+3],t=w[O],s=w[O+1],c=w[O+2],h=w[O+3],this.mode){case"multiply":P[O]=l*t/255,P[O+1]=d*s/255,P[O+2]=p*c/255,P[O+3]=m*h/255;break;case"mask":P[O+3]=h}},getUniformLocations:function(e,t){return{uTransformMatrix:e.getUniformLocation(t,"uTransformMatrix"),uImage:e.getUniformLocation(t,"uImage")}},sendUniformData:function(e,t){var s=this.calculateMatrix();e.uniform1i(t.uImage,1),e.uniformMatrix3fv(t.uTransformMatrix,!1,s)},toObject:function(){return{type:this.type,image:this.image&&this.image.toObject(),mode:this.mode,alpha:this.alpha}}}),i.Image.filters.BlendImage.fromObject=function(e,t){i.Image.fromObject(e.image,function(s){var c=i.util.object.clone(e);c.image=s,t(new i.Image.filters.BlendImage(c))})}}(o),function(r){var i=r.fabric||(r.fabric={}),n=Math.pow,a=Math.floor,e=Math.sqrt,t=Math.abs,s=Math.round,c=Math.sin,h=Math.ceil,l=i.Image.filters,d=i.util.createClass;l.Resize=d(l.BaseFilter,{type:"Resize",resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3,getUniformLocations:function(p,m){return{uDelta:p.getUniformLocation(m,"uDelta"),uTaps:p.getUniformLocation(m,"uTaps")}},sendUniformData:function(p,m){p.uniform2fv(m.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),p.uniform1fv(m.uTaps,this.taps)},retrieveShader:function(p){var m=this.getFilterWindow(),b=this.type+"_"+m;if(!p.programCache.hasOwnProperty(b)){var y=this.generateShader(m);p.programCache[b]=this.createProgram(p.context,y)}return p.programCache[b]},getFilterWindow:function(){var p=this.tempScale;return Math.ceil(this.lanczosLobes/p)},getTaps:function(){for(var p=this.lanczosCreate(this.lanczosLobes),m=this.tempScale,b=this.getFilterWindow(),y=new Array(b),w=1;w<=b;w++)y[w-1]=p(w*m);return y},generateShader:function(p){for(var m=new Array(p),b=this.fragmentSourceTOP,y=1;y<=p;y++)m[y-1]=y+".0 * uDelta";return b+="uniform float uTaps["+p+"];\n",b+="void main() {\n",b+="  vec4 color = texture2D(uTexture, vTexCoord);\n",b+="  float sum = 1.0;\n",m.forEach(function(w,T){b+="  color += texture2D(uTexture, vTexCoord + "+w+") * uTaps["+T+"];\n",b+="  color += texture2D(uTexture, vTexCoord - "+w+") * uTaps["+T+"];\n",b+="  sum += 2.0 * uTaps["+T+"];\n"}),b+="  gl_FragColor = color / sum;\n",b+="}"},fragmentSourceTOP:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec2 uDelta;\nvarying vec2 vTexCoord;\n",applyTo:function(p){p.webgl?(p.passes++,this.width=p.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=p.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),p.destinationWidth=this.dW,this._setupFrameBuffer(p),this.applyToWebGL(p),this._swapTextures(p),p.sourceWidth=p.destinationWidth,this.height=p.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),p.destinationHeight=this.dH,this._setupFrameBuffer(p),this.applyToWebGL(p),this._swapTextures(p),p.sourceHeight=p.destinationHeight):this.applyTo2d(p)},isNeutralState:function(){return this.scaleX===1&&this.scaleY===1},lanczosCreate:function(p){return function(m){if(m>=p||m<=-p)return 0;if(m<11920929e-14&&m>-11920929e-14)return 1;var b=(m*=Math.PI)/p;return c(m)/m*c(b)/b}},applyTo2d:function(p){var m=p.imageData,b=this.scaleX,y=this.scaleY;this.rcpScaleX=1/b,this.rcpScaleY=1/y;var w,T=m.width,k=m.height,P=s(T*b),G=s(k*y);this.resizeType==="sliceHack"?w=this.sliceByTwo(p,T,k,P,G):this.resizeType==="hermite"?w=this.hermiteFastResize(p,T,k,P,G):this.resizeType==="bilinear"?w=this.bilinearFiltering(p,T,k,P,G):this.resizeType==="lanczos"&&(w=this.lanczosResize(p,T,k,P,G)),p.imageData=w},sliceByTwo:function(p,m,b,y,w){var T,k,P=p.imageData,G=.5,V=!1,N=!1,A=m*G,O=b*G,B=i.filterBackend.resources,W=0,H=0,R=m,D=0;for(B.sliceByTwo||(B.sliceByTwo=document.createElement("canvas")),((T=B.sliceByTwo).width<1.5*m||T.height<b)&&(T.width=1.5*m,T.height=b),(k=T.getContext("2d")).clearRect(0,0,1.5*m,b),k.putImageData(P,0,0),y=a(y),w=a(w);!V||!N;)m=A,b=O,y<a(A*G)?A=a(A*G):(A=y,V=!0),w<a(O*G)?O=a(O*G):(O=w,N=!0),k.drawImage(T,W,H,m,b,R,D,A,O),W=R,H=D,D+=O;return k.getImageData(W,H,y,w)},lanczosResize:function(p,m,b,y,w){var T=p.imageData.data,k=p.ctx.createImageData(y,w),P=k.data,G=this.lanczosCreate(this.lanczosLobes),V=this.rcpScaleX,N=this.rcpScaleY,A=2/this.rcpScaleX,O=2/this.rcpScaleY,B=h(V*this.lanczosLobes/2),W=h(N*this.lanczosLobes/2),H={},R={},D={};return function j(X){var U,z,ie,Z,Q,te,ee,re,ae,ne,ge;for(R.x=(X+.5)*V,D.x=a(R.x),U=0;U<w;U++){for(R.y=(U+.5)*N,D.y=a(R.y),Q=0,te=0,ee=0,re=0,ae=0,z=D.x-B;z<=D.x+B;z++)if(!(z<0||z>=m)){ne=a(1e3*t(z-R.x)),H[ne]||(H[ne]={});for(var me=D.y-W;me<=D.y+W;me++)me<0||me>=b||(ge=a(1e3*t(me-R.y)),H[ne][ge]||(H[ne][ge]=G(e(n(ne*A,2)+n(ge*O,2))/1e3)),(ie=H[ne][ge])>0&&(Q+=ie,te+=ie*T[Z=4*(me*m+z)],ee+=ie*T[Z+1],re+=ie*T[Z+2],ae+=ie*T[Z+3]))}P[Z=4*(U*y+X)]=te/Q,P[Z+1]=ee/Q,P[Z+2]=re/Q,P[Z+3]=ae/Q}return++X<y?j(X):k}(0)},bilinearFiltering:function(p,m,b,y,w){var T,k,P,G,V,N,A,O,B,W=0,H=this.rcpScaleX,R=this.rcpScaleY,D=4*(m-1),j=p.imageData.data,X=p.ctx.createImageData(y,w),U=X.data;for(P=0;P<w;P++)for(G=0;G<y;G++)for(V=H*G-(T=a(H*G)),N=R*P-(k=a(R*P)),B=4*(k*m+T),A=0;A<4;A++)O=j[B+A]*(1-V)*(1-N)+j[B+4+A]*V*(1-N)+j[B+D+A]*N*(1-V)+j[B+D+4+A]*V*N,U[W++]=O;return X},hermiteFastResize:function(p,m,b,y,w){for(var T=this.rcpScaleX,k=this.rcpScaleY,P=h(T/2),G=h(k/2),V=p.imageData.data,N=p.ctx.createImageData(y,w),A=N.data,O=0;O<w;O++)for(var B=0;B<y;B++){for(var W=4*(B+O*y),H=0,R=0,D=0,j=0,X=0,U=0,z=0,ie=(O+.5)*k,Z=a(O*k);Z<(O+1)*k;Z++)for(var Q=t(ie-(Z+.5))/G,te=(B+.5)*T,ee=Q*Q,re=a(B*T);re<(B+1)*T;re++){var ae=t(te-(re+.5))/P,ne=e(ee+ae*ae);ne>1&&ne<-1||(H=2*ne*ne*ne-3*ne*ne+1)>0&&(z+=H*V[3+(ae=4*(re+Z*m))],D+=H,V[ae+3]<255&&(H=H*V[ae+3]/250),j+=H*V[ae],X+=H*V[ae+1],U+=H*V[ae+2],R+=H)}A[W]=j/R,A[W+1]=X/R,A[W+2]=U/R,A[W+3]=z/D}return N},toObject:function(){return{type:this.type,scaleX:this.scaleX,scaleY:this.scaleY,resizeType:this.resizeType,lanczosLobes:this.lanczosLobes}}}),i.Image.filters.Resize.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.Contrast=a(n.BaseFilter,{type:"Contrast",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uContrast;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));\ncolor.rgb = contrastF * (color.rgb - 0.5) + 0.5;\ngl_FragColor = color;\n}",contrast:0,mainParameter:"contrast",applyTo2d:function(e){if(this.contrast!==0){var t,s=e.imageData.data,c=s.length,h=Math.floor(255*this.contrast),l=259*(h+255)/(255*(259-h));for(t=0;t<c;t+=4)s[t]=l*(s[t]-128)+128,s[t+1]=l*(s[t+1]-128)+128,s[t+2]=l*(s[t+2]-128)+128}},getUniformLocations:function(e,t){return{uContrast:e.getUniformLocation(t,"uContrast")}},sendUniformData:function(e,t){e.uniform1f(t.uContrast,this.contrast)}}),i.Image.filters.Contrast.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.Saturation=a(n.BaseFilter,{type:"Saturation",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uSaturation;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat rgMax = max(color.r, color.g);\nfloat rgbMax = max(rgMax, color.b);\ncolor.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;\ncolor.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;\ncolor.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;\ngl_FragColor = color;\n}",saturation:0,mainParameter:"saturation",applyTo2d:function(e){if(this.saturation!==0){var t,s,c=e.imageData.data,h=c.length,l=-this.saturation;for(t=0;t<h;t+=4)s=Math.max(c[t],c[t+1],c[t+2]),c[t]+=s!==c[t]?(s-c[t])*l:0,c[t+1]+=s!==c[t+1]?(s-c[t+1])*l:0,c[t+2]+=s!==c[t+2]?(s-c[t+2])*l:0}},getUniformLocations:function(e,t){return{uSaturation:e.getUniformLocation(t,"uSaturation")}},sendUniformData:function(e,t){e.uniform1f(t.uSaturation,-this.saturation)}}),i.Image.filters.Saturation.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.Vibrance=a(n.BaseFilter,{type:"Vibrance",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uVibrance;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat max = max(color.r, max(color.g, color.b));\nfloat avg = (color.r + color.g + color.b) / 3.0;\nfloat amt = (abs(max - avg) * 2.0) * uVibrance;\ncolor.r += max != color.r ? (max - color.r) * amt : 0.00;\ncolor.g += max != color.g ? (max - color.g) * amt : 0.00;\ncolor.b += max != color.b ? (max - color.b) * amt : 0.00;\ngl_FragColor = color;\n}",vibrance:0,mainParameter:"vibrance",applyTo2d:function(e){if(this.vibrance!==0){var t,s,c,h,l=e.imageData.data,d=l.length,p=-this.vibrance;for(t=0;t<d;t+=4)s=Math.max(l[t],l[t+1],l[t+2]),c=(l[t]+l[t+1]+l[t+2])/3,h=2*Math.abs(s-c)/255*p,l[t]+=s!==l[t]?(s-l[t])*h:0,l[t+1]+=s!==l[t+1]?(s-l[t+1])*h:0,l[t+2]+=s!==l[t+2]?(s-l[t+2])*h:0}},getUniformLocations:function(e,t){return{uVibrance:e.getUniformLocation(t,"uVibrance")}},sendUniformData:function(e,t){e.uniform1f(t.uVibrance,-this.vibrance)}}),i.Image.filters.Vibrance.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.Blur=a(n.BaseFilter,{type:"Blur",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec2 uDelta;\nvarying vec2 vTexCoord;\nconst float nSamples = 15.0;\nvec3 v3offset = vec3(12.9898, 78.233, 151.7182);\nfloat random(vec3 scale) {\nreturn fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);\n}\nvoid main() {\nvec4 color = vec4(0.0);\nfloat total = 0.0;\nfloat offset = random(v3offset);\nfor (float t = -nSamples; t <= nSamples; t++) {\nfloat percent = (t + offset - 0.5) / nSamples;\nfloat weight = 1.0 - abs(percent);\ncolor += texture2D(uTexture, vTexCoord + uDelta * percent) * weight;\ntotal += weight;\n}\ngl_FragColor = color / total;\n}",blur:0,mainParameter:"blur",applyTo:function(e){e.webgl?(this.aspectRatio=e.sourceWidth/e.sourceHeight,e.passes++,this._setupFrameBuffer(e),this.horizontal=!0,this.applyToWebGL(e),this._swapTextures(e),this._setupFrameBuffer(e),this.horizontal=!1,this.applyToWebGL(e),this._swapTextures(e)):this.applyTo2d(e)},applyTo2d:function(e){e.imageData=this.simpleBlur(e)},simpleBlur:function(e){var t,s,c=e.filterBackend.resources,h=e.imageData.width,l=e.imageData.height;c.blurLayer1||(c.blurLayer1=i.util.createCanvasElement(),c.blurLayer2=i.util.createCanvasElement()),t=c.blurLayer1,s=c.blurLayer2,t.width===h&&t.height===l||(s.width=t.width=h,s.height=t.height=l);var d,p,m,b,y=t.getContext("2d"),w=s.getContext("2d"),T=.06*this.blur*.5;for(y.putImageData(e.imageData,0,0),w.clearRect(0,0,h,l),b=-15;b<=15;b++)m=T*(p=b/15)*h+(d=(Math.random()-.5)/4),w.globalAlpha=1-Math.abs(p),w.drawImage(t,m,d),y.drawImage(s,0,0),w.globalAlpha=1,w.clearRect(0,0,s.width,s.height);for(b=-15;b<=15;b++)m=T*(p=b/15)*l+(d=(Math.random()-.5)/4),w.globalAlpha=1-Math.abs(p),w.drawImage(t,d,m),y.drawImage(s,0,0),w.globalAlpha=1,w.clearRect(0,0,s.width,s.height);e.ctx.drawImage(t,0,0);var k=e.ctx.getImageData(0,0,t.width,t.height);return y.globalAlpha=1,y.clearRect(0,0,t.width,t.height),k},getUniformLocations:function(e,t){return{delta:e.getUniformLocation(t,"uDelta")}},sendUniformData:function(e,t){var s=this.chooseRightDelta();e.uniform2fv(t.delta,s)},chooseRightDelta:function(){var e,t=1,s=[0,0];return this.horizontal?this.aspectRatio>1&&(t=1/this.aspectRatio):this.aspectRatio<1&&(t=this.aspectRatio),e=t*this.blur*.12,this.horizontal?s[0]=e:s[1]=e,s}}),n.Blur.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.Gamma=a(n.BaseFilter,{type:"Gamma",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec3 uGamma;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec3 correction = (1.0 / uGamma);\ncolor.r = pow(color.r, correction.r);\ncolor.g = pow(color.g, correction.g);\ncolor.b = pow(color.b, correction.b);\ngl_FragColor = color;\ngl_FragColor.rgb *= color.a;\n}",gamma:[1,1,1],mainParameter:"gamma",initialize:function(e){this.gamma=[1,1,1],n.BaseFilter.prototype.initialize.call(this,e)},applyTo2d:function(e){var t,s=e.imageData.data,c=this.gamma,h=s.length,l=1/c[0],d=1/c[1],p=1/c[2];for(this.rVals||(this.rVals=new Uint8Array(256),this.gVals=new Uint8Array(256),this.bVals=new Uint8Array(256)),t=0,h=256;t<h;t++)this.rVals[t]=255*Math.pow(t/255,l),this.gVals[t]=255*Math.pow(t/255,d),this.bVals[t]=255*Math.pow(t/255,p);for(t=0,h=s.length;t<h;t+=4)s[t]=this.rVals[s[t]],s[t+1]=this.gVals[s[t+1]],s[t+2]=this.bVals[s[t+2]]},getUniformLocations:function(e,t){return{uGamma:e.getUniformLocation(t,"uGamma")}},sendUniformData:function(e,t){e.uniform3fv(t.uGamma,this.gamma)}}),i.Image.filters.Gamma.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.Composed=a(n.BaseFilter,{type:"Composed",subFilters:[],initialize:function(e){this.callSuper("initialize",e),this.subFilters=this.subFilters.slice(0)},applyTo:function(e){e.passes+=this.subFilters.length-1,this.subFilters.forEach(function(t){t.applyTo(e)})},toObject:function(){return i.util.object.extend(this.callSuper("toObject"),{subFilters:this.subFilters.map(function(e){return e.toObject()})})},isNeutralState:function(){return!this.subFilters.some(function(e){return!e.isNeutralState()})}}),i.Image.filters.Composed.fromObject=function(e,t){var s=(e.subFilters||[]).map(function(h){return new i.Image.filters[h.type](h)}),c=new i.Image.filters.Composed({subFilters:s});return t&&t(c),c}}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.Image.filters,a=i.util.createClass;n.HueRotation=a(n.ColorMatrix,{type:"HueRotation",rotation:0,mainParameter:"rotation",calculateMatrix:function(){var e=this.rotation*Math.PI,t=i.util.cos(e),s=i.util.sin(e),c=1/3,h=Math.sqrt(c)*s,l=1-t;this.matrix=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],this.matrix[0]=t+l/3,this.matrix[1]=c*l-h,this.matrix[2]=c*l+h,this.matrix[5]=c*l+h,this.matrix[6]=t+c*l,this.matrix[7]=c*l-h,this.matrix[10]=c*l-h,this.matrix[11]=c*l+h,this.matrix[12]=t+c*l},isNeutralState:function(e){return this.calculateMatrix(),n.BaseFilter.prototype.isNeutralState.call(this,e)},applyTo:function(e){this.calculateMatrix(),n.BaseFilter.prototype.applyTo.call(this,e)}}),i.Image.filters.HueRotation.fromObject=i.Image.filters.BaseFilter.fromObject}(o),function(r){var i=r.fabric||(r.fabric={}),n=i.util.object.clone;if(i.Text)i.warn("fabric.Text is already defined");else{var a="fontFamily fontWeight fontSize text underline overline linethrough textAlign fontStyle lineHeight textBackgroundColor charSpacing styles direction path pathStartOffset pathSide pathAlign".split(" ");i.Text=i.util.createClass(i.Object,{_dimensionAffectingProps:["fontSize","fontWeight","fontFamily","fontStyle","lineHeight","text","charSpacing","textAlign","styles","path","pathStartOffset","pathSide","pathAlign"],_reNewline:/\r?\n/,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,type:"text",fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:"left",fontStyle:"normal",lineHeight:1.16,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},textBackgroundColor:"",stateProperties:i.Object.prototype.stateProperties.concat(a),cacheProperties:i.Object.prototype.cacheProperties.concat(a),stroke:null,shadow:null,path:null,pathStartOffset:0,pathSide:"left",pathAlign:"baseline",_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.315,overline:-.88},_fontSizeMult:1.13,charSpacing:0,styles:null,_measuringContext:null,deltaY:0,direction:"ltr",_styleProperties:["stroke","strokeWidth","fill","fontFamily","fontSize","fontWeight","fontStyle","underline","overline","linethrough","deltaY","textBackgroundColor"],__charBounds:[],CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,initialize:function(e,t){this.styles=t&&t.styles||{},this.text=e,this.__skipDimension=!0,this.callSuper("initialize",t),this.path&&this.setPathInfo(),this.__skipDimension=!1,this.initDimensions(),this.setCoords(),this.setupState({propertySet:"_dimensionAffectingProps"})},setPathInfo:function(){var e=this.path;e&&(e.segmentsInfo=i.util.getPathSegmentsInfo(e.path))},getMeasuringContext:function(){return i._measuringContext||(i._measuringContext=this.canvas&&this.canvas.contextCache||i.util.createCanvasElement().getContext("2d")),i._measuringContext},_splitText:function(){var e=this._splitTextIntoLines(this.text);return this.textLines=e.lines,this._textLines=e.graphemeLines,this._unwrappedTextLines=e._unwrappedLines,this._text=e.graphemeText,e},initDimensions:function(){this.__skipDimension||(this._splitText(),this._clearCache(),this.path?(this.width=this.path.width,this.height=this.path.height):(this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,this.height=this.calcTextHeight()),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.saveState({propertySet:"_dimensionAffectingProps"}))},enlargeSpaces:function(){for(var e,t,s,c,h,l,d,p=0,m=this._textLines.length;p<m;p++)if((this.textAlign==="justify"||p!==m-1&&!this.isEndOfWrapping(p))&&(c=0,h=this._textLines[p],(t=this.getLineWidth(p))<this.width&&(d=this.textLines[p].match(this._reSpacesAndTabs)))){s=d.length,e=(this.width-t)/s;for(var b=0,y=h.length;b<=y;b++)l=this.__charBounds[p][b],this._reSpaceAndTab.test(h[b])?(l.width+=e,l.kernedWidth+=e,l.left+=c,c+=e):l.left+=c}},isEndOfWrapping:function(e){return e===this._textLines.length-1},missingNewlineOffset:function(){return 1},toString:function(){return"#<fabric.Text ("+this.complexity()+'): { "text": "'+this.text+'", "fontFamily": "'+this.fontFamily+'" }>'},_getCacheCanvasDimensions:function(){var e=this.callSuper("_getCacheCanvasDimensions"),t=this.fontSize;return e.width+=t*e.zoomX,e.height+=t*e.zoomY,e},_render:function(e){var t=this.path;t&&!t.isNotVisible()&&t._render(e),this._setTextStyles(e),this._renderTextLinesBackground(e),this._renderTextDecoration(e,"underline"),this._renderText(e),this._renderTextDecoration(e,"overline"),this._renderTextDecoration(e,"linethrough")},_renderText:function(e){this.paintFirst==="stroke"?(this._renderTextStroke(e),this._renderTextFill(e)):(this._renderTextFill(e),this._renderTextStroke(e))},_setTextStyles:function(e,t,s){if(e.textBaseline="alphabetical",this.path)switch(this.pathAlign){case"center":e.textBaseline="middle";break;case"ascender":e.textBaseline="top";break;case"descender":e.textBaseline="bottom"}e.font=this._getFontDeclaration(t,s)},calcTextWidth:function(){for(var e=this.getLineWidth(0),t=1,s=this._textLines.length;t<s;t++){var c=this.getLineWidth(t);c>e&&(e=c)}return e},_renderTextLine:function(e,t,s,c,h,l){this._renderChars(e,t,s,c,h,l)},_renderTextLinesBackground:function(e){if(this.textBackgroundColor||this.styleHas("textBackgroundColor")){for(var t,s,c,h,l,d,p,m=e.fillStyle,b=this._getLeftOffset(),y=this._getTopOffset(),w=0,T=0,k=this.path,P=0,G=this._textLines.length;P<G;P++)if(t=this.getHeightOfLine(P),this.textBackgroundColor||this.styleHas("textBackgroundColor",P)){c=this._textLines[P],s=this._getLineLeftOffset(P),T=0,w=0,h=this.getValueOfPropertyAt(P,0,"textBackgroundColor");for(var V=0,N=c.length;V<N;V++)l=this.__charBounds[P][V],d=this.getValueOfPropertyAt(P,V,"textBackgroundColor"),k?(e.save(),e.translate(l.renderLeft,l.renderTop),e.rotate(l.angle),e.fillStyle=d,d&&e.fillRect(-l.width/2,-t/this.lineHeight*(1-this._fontSizeFraction),l.width,t/this.lineHeight),e.restore()):d!==h?(p=b+s+w,this.direction==="rtl"&&(p=this.width-p-T),e.fillStyle=h,h&&e.fillRect(p,y,T,t/this.lineHeight),w=l.left,T=l.width,h=d):T+=l.kernedWidth;d&&!k&&(p=b+s+w,this.direction==="rtl"&&(p=this.width-p-T),e.fillStyle=d,e.fillRect(p,y,T,t/this.lineHeight)),y+=t}else y+=t;e.fillStyle=m,this._removeShadow(e)}},getFontCache:function(e){var t=e.fontFamily.toLowerCase();i.charWidthsCache[t]||(i.charWidthsCache[t]={});var s=i.charWidthsCache[t],c=e.fontStyle.toLowerCase()+"_"+(e.fontWeight+"").toLowerCase();return s[c]||(s[c]={}),s[c]},_measureChar:function(e,t,s,c){var h,l,d,p,m=this.getFontCache(t),b=s+e,y=this._getFontDeclaration(t)===this._getFontDeclaration(c),w=t.fontSize/this.CACHE_FONT_SIZE;if(s&&m[s]!==void 0&&(d=m[s]),m[e]!==void 0&&(p=h=m[e]),y&&m[b]!==void 0&&(p=(l=m[b])-d),h===void 0||d===void 0||l===void 0){var T=this.getMeasuringContext();this._setTextStyles(T,t,!0)}return h===void 0&&(p=h=T.measureText(e).width,m[e]=h),d===void 0&&y&&s&&(d=T.measureText(s).width,m[s]=d),y&&l===void 0&&(l=T.measureText(b).width,m[b]=l,p=l-d),{width:h*w,kernedWidth:p*w}},getHeightOfChar:function(e,t){return this.getValueOfPropertyAt(e,t,"fontSize")},measureLine:function(e){var t=this._measureLine(e);return this.charSpacing!==0&&(t.width-=this._getWidthOfCharSpacing()),t.width<0&&(t.width=0),t},_measureLine:function(e){var t,s,c,h,l,d,p=0,m=this._textLines[e],b=new Array(m.length),y=0,w=this.path,T=this.pathSide==="right";for(this.__charBounds[e]=b,t=0;t<m.length;t++)s=m[t],h=this._getGraphemeBox(s,e,t,c),b[t]=h,p+=h.kernedWidth,c=s;if(b[t]={left:h?h.left+h.width:0,width:0,kernedWidth:0,height:this.fontSize},w){switch(d=w.segmentsInfo[w.segmentsInfo.length-1].length,(l=i.util.getPointOnPath(w.path,0,w.segmentsInfo)).x+=w.pathOffset.x,l.y+=w.pathOffset.y,this.textAlign){case"left":y=T?d-p:0;break;case"center":y=(d-p)/2;break;case"right":y=T?0:d-p}for(y+=this.pathStartOffset*(T?-1:1),t=T?m.length-1:0;T?t>=0:t<m.length;T?t--:t++)h=b[t],y>d?y%=d:y<0&&(y+=d),this._setGraphemeOnPath(y,h,l),y+=h.kernedWidth}return{width:p,numOfSpaces:0}},_setGraphemeOnPath:function(e,t,s){var c=e+t.kernedWidth/2,h=this.path,l=i.util.getPointOnPath(h.path,c,h.segmentsInfo);t.renderLeft=l.x-s.x,t.renderTop=l.y-s.y,t.angle=l.angle+(this.pathSide==="right"?Math.PI:0)},_getGraphemeBox:function(e,t,s,c,h){var l,d=this.getCompleteStyleDeclaration(t,s),p=c?this.getCompleteStyleDeclaration(t,s-1):{},m=this._measureChar(e,d,c,p),b=m.kernedWidth,y=m.width;this.charSpacing!==0&&(y+=l=this._getWidthOfCharSpacing(),b+=l);var w={width:y,left:0,height:d.fontSize,kernedWidth:b,deltaY:d.deltaY};if(s>0&&!h){var T=this.__charBounds[t][s-1];w.left=T.left+T.width+m.kernedWidth-m.width}return w},getHeightOfLine:function(e){if(this.__lineHeights[e])return this.__lineHeights[e];for(var t=this._textLines[e],s=this.getHeightOfChar(e,0),c=1,h=t.length;c<h;c++)s=Math.max(this.getHeightOfChar(e,c),s);return this.__lineHeights[e]=s*this.lineHeight*this._fontSizeMult},calcTextHeight:function(){for(var e,t=0,s=0,c=this._textLines.length;s<c;s++)e=this.getHeightOfLine(s),t+=s===c-1?e/this.lineHeight:e;return t},_getLeftOffset:function(){return this.direction==="ltr"?-this.width/2:this.width/2},_getTopOffset:function(){return-this.height/2},_renderTextCommon:function(e,t){e.save();for(var s=0,c=this._getLeftOffset(),h=this._getTopOffset(),l=0,d=this._textLines.length;l<d;l++){var p=this.getHeightOfLine(l),m=p/this.lineHeight,b=this._getLineLeftOffset(l);this._renderTextLine(t,e,this._textLines[l],c+b,h+s+m,l),s+=p}e.restore()},_renderTextFill:function(e){(this.fill||this.styleHas("fill"))&&this._renderTextCommon(e,"fillText")},_renderTextStroke:function(e){(this.stroke&&this.strokeWidth!==0||!this.isEmptyStyles())&&(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(e),e.save(),this._setLineDash(e,this.strokeDashArray),e.beginPath(),this._renderTextCommon(e,"strokeText"),e.closePath(),e.restore())},_renderChars:function(e,t,s,c,h,l){var d,p,m,b,y,w=this.getHeightOfLine(l),T=this.textAlign.indexOf("justify")!==-1,k="",P=0,G=this.path,V=!T&&this.charSpacing===0&&this.isEmptyStyles(l)&&!G,N=this.direction==="ltr",A=this.direction==="ltr"?1:-1,O=t.canvas.getAttribute("dir");if(t.save(),O!==this.direction&&(t.canvas.setAttribute("dir",N?"ltr":"rtl"),t.direction=N?"ltr":"rtl",t.textAlign=N?"left":"right"),h-=w*this._fontSizeFraction/this.lineHeight,V)return this._renderChar(e,t,l,0,s.join(""),c,h,w),void t.restore();for(var B=0,W=s.length-1;B<=W;B++)b=B===W||this.charSpacing||G,k+=s[B],m=this.__charBounds[l][B],P===0?(c+=A*(m.kernedWidth-m.width),P+=m.width):P+=m.kernedWidth,T&&!b&&this._reSpaceAndTab.test(s[B])&&(b=!0),b||(d=d||this.getCompleteStyleDeclaration(l,B),p=this.getCompleteStyleDeclaration(l,B+1),b=this._hasStyleChanged(d,p)),b&&(G?(t.save(),t.translate(m.renderLeft,m.renderTop),t.rotate(m.angle),this._renderChar(e,t,l,B,k,-P/2,0,w),t.restore()):(y=c,this._renderChar(e,t,l,B,k,y,h,w)),k="",d=p,c+=A*P,P=0);t.restore()},_applyPatternGradientTransformText:function(e){var t,s=i.util.createCanvasElement(),c=this.width+this.strokeWidth,h=this.height+this.strokeWidth;return s.width=c,s.height=h,(t=s.getContext("2d")).beginPath(),t.moveTo(0,0),t.lineTo(c,0),t.lineTo(c,h),t.lineTo(0,h),t.closePath(),t.translate(c/2,h/2),t.fillStyle=e.toLive(t),this._applyPatternGradientTransform(t,e),t.fill(),t.createPattern(s,"no-repeat")},handleFiller:function(e,t,s){var c,h;return s.toLive?s.gradientUnits==="percentage"||s.gradientTransform||s.patternTransform?(c=-this.width/2,h=-this.height/2,e.translate(c,h),e[t]=this._applyPatternGradientTransformText(s),{offsetX:c,offsetY:h}):(e[t]=s.toLive(e,this),this._applyPatternGradientTransform(e,s)):(e[t]=s,{offsetX:0,offsetY:0})},_setStrokeStyles:function(e,t){return e.lineWidth=t.strokeWidth,e.lineCap=this.strokeLineCap,e.lineDashOffset=this.strokeDashOffset,e.lineJoin=this.strokeLineJoin,e.miterLimit=this.strokeMiterLimit,this.handleFiller(e,"strokeStyle",t.stroke)},_setFillStyles:function(e,t){return this.handleFiller(e,"fillStyle",t.fill)},_renderChar:function(e,t,s,c,h,l,d){var p,m,b=this._getStyleDeclaration(s,c),y=this.getCompleteStyleDeclaration(s,c),w=e==="fillText"&&y.fill,T=e==="strokeText"&&y.stroke&&y.strokeWidth;(T||w)&&(t.save(),w&&(p=this._setFillStyles(t,y)),T&&(m=this._setStrokeStyles(t,y)),t.font=this._getFontDeclaration(y),b&&b.textBackgroundColor&&this._removeShadow(t),b&&b.deltaY&&(d+=b.deltaY),w&&t.fillText(h,l-p.offsetX,d-p.offsetY),T&&t.strokeText(h,l-m.offsetX,d-m.offsetY),t.restore())},setSuperscript:function(e,t){return this._setScript(e,t,this.superscript)},setSubscript:function(e,t){return this._setScript(e,t,this.subscript)},_setScript:function(e,t,s){var c=this.get2DCursorLocation(e,!0),h=this.getValueOfPropertyAt(c.lineIndex,c.charIndex,"fontSize"),l=this.getValueOfPropertyAt(c.lineIndex,c.charIndex,"deltaY"),d={fontSize:h*s.size,deltaY:l+h*s.baseline};return this.setSelectionStyles(d,e,t),this},_hasStyleChanged:function(e,t){return e.fill!==t.fill||e.stroke!==t.stroke||e.strokeWidth!==t.strokeWidth||e.fontSize!==t.fontSize||e.fontFamily!==t.fontFamily||e.fontWeight!==t.fontWeight||e.fontStyle!==t.fontStyle||e.deltaY!==t.deltaY},_hasStyleChangedForSvg:function(e,t){return this._hasStyleChanged(e,t)||e.overline!==t.overline||e.underline!==t.underline||e.linethrough!==t.linethrough},_getLineLeftOffset:function(e){var t=this.getLineWidth(e),s=this.width-t,c=this.textAlign,h=this.direction,l=0,d=this.isEndOfWrapping(e);return c==="justify"||c==="justify-center"&&!d||c==="justify-right"&&!d||c==="justify-left"&&!d?0:(c==="center"&&(l=s/2),c==="right"&&(l=s),c==="justify-center"&&(l=s/2),c==="justify-right"&&(l=s),h==="rtl"&&(l-=s),l)},_clearCache:function(){this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]},_shouldClearDimensionCache:function(){var e=this._forceClearCache;return e||(e=this.hasStateChanged("_dimensionAffectingProps")),e&&(this.dirty=!0,this._forceClearCache=!1),e},getLineWidth:function(e){if(this.__lineWidths[e]!==void 0)return this.__lineWidths[e];var t=this.measureLine(e).width;return this.__lineWidths[e]=t,t},_getWidthOfCharSpacing:function(){return this.charSpacing!==0?this.fontSize*this.charSpacing/1e3:0},getValueOfPropertyAt:function(e,t,s){var c=this._getStyleDeclaration(e,t);return c&&c[s]!==void 0?c[s]:this[s]},_renderTextDecoration:function(e,t){if(this[t]||this.styleHas(t)){for(var s,c,h,l,d,p,m,b,y,w,T,k,P,G,V,N,A=this._getLeftOffset(),O=this._getTopOffset(),B=this.path,W=this._getWidthOfCharSpacing(),H=this.offsets[t],R=0,D=this._textLines.length;R<D;R++)if(s=this.getHeightOfLine(R),this[t]||this.styleHas(t,R)){m=this._textLines[R],G=s/this.lineHeight,l=this._getLineLeftOffset(R),w=0,T=0,b=this.getValueOfPropertyAt(R,0,t),N=this.getValueOfPropertyAt(R,0,"fill"),y=O+G*(1-this._fontSizeFraction),c=this.getHeightOfChar(R,0),d=this.getValueOfPropertyAt(R,0,"deltaY");for(var j=0,X=m.length;j<X;j++)if(k=this.__charBounds[R][j],P=this.getValueOfPropertyAt(R,j,t),V=this.getValueOfPropertyAt(R,j,"fill"),h=this.getHeightOfChar(R,j),p=this.getValueOfPropertyAt(R,j,"deltaY"),B&&P&&V)e.save(),e.fillStyle=N,e.translate(k.renderLeft,k.renderTop),e.rotate(k.angle),e.fillRect(-k.kernedWidth/2,H*h+p,k.kernedWidth,this.fontSize/15),e.restore();else if((P!==b||V!==N||h!==c||p!==d)&&T>0){var U=A+l+w;this.direction==="rtl"&&(U=this.width-U-T),b&&N&&(e.fillStyle=N,e.fillRect(U,y+H*c+d,T,this.fontSize/15)),w=k.left,T=k.width,b=P,N=V,c=h,d=p}else T+=k.kernedWidth;U=A+l+w,this.direction==="rtl"&&(U=this.width-U-T),e.fillStyle=V,P&&V&&e.fillRect(U,y+H*c+d,T-W,this.fontSize/15),O+=s}else O+=s;this._removeShadow(e)}},_getFontDeclaration:function(e,t){var s=e||this,c=this.fontFamily,h=i.Text.genericFonts.indexOf(c.toLowerCase())>-1,l=c===void 0||c.indexOf("'")>-1||c.indexOf(",")>-1||c.indexOf('"')>-1||h?s.fontFamily:'"'+s.fontFamily+'"';return[i.isLikelyNode?s.fontWeight:s.fontStyle,i.isLikelyNode?s.fontStyle:s.fontWeight,t?this.CACHE_FONT_SIZE+"px":s.fontSize+"px",l].join(" ")},render:function(e){this.visible&&(this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(this._shouldClearDimensionCache()&&this.initDimensions(),this.callSuper("render",e)))},_splitTextIntoLines:function(e){for(var t=e.split(this._reNewline),s=new Array(t.length),c=["\n"],h=[],l=0;l<t.length;l++)s[l]=i.util.string.graphemeSplit(t[l]),h=h.concat(s[l],c);return h.pop(),{_unwrappedLines:s,lines:t,graphemeText:h,graphemeLines:s}},toObject:function(e){var t=a.concat(e),s=this.callSuper("toObject",t);return s.styles=n(this.styles,!0),s.path&&(s.path=this.path.toObject()),s},set:function(e,t){this.callSuper("set",e,t);var s=!1,c=!1;if(typeof e=="object")for(var h in e)h==="path"&&this.setPathInfo(),s=s||this._dimensionAffectingProps.indexOf(h)!==-1,c=c||h==="path";else s=this._dimensionAffectingProps.indexOf(e)!==-1,c=e==="path";return c&&this.setPathInfo(),s&&(this.initDimensions(),this.setCoords()),this},complexity:function(){return 1}}),i.Text.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("x y dx dy font-family font-style font-weight font-size letter-spacing text-decoration text-anchor".split(" ")),i.Text.DEFAULT_SVG_FONT_SIZE=16,i.Text.fromElement=function(e,t,s){if(!e)return t(null);var c=i.parseAttributes(e,i.Text.ATTRIBUTE_NAMES),h=c.textAnchor||"left";if((s=i.util.object.extend(s?n(s):{},c)).top=s.top||0,s.left=s.left||0,c.textDecoration){var l=c.textDecoration;l.indexOf("underline")!==-1&&(s.underline=!0),l.indexOf("overline")!==-1&&(s.overline=!0),l.indexOf("line-through")!==-1&&(s.linethrough=!0),delete s.textDecoration}"dx"in c&&(s.left+=c.dx),"dy"in c&&(s.top+=c.dy),"fontSize"in s||(s.fontSize=i.Text.DEFAULT_SVG_FONT_SIZE);var d="";"textContent"in e?d=e.textContent:"firstChild"in e&&e.firstChild!==null&&"data"in e.firstChild&&e.firstChild.data!==null&&(d=e.firstChild.data),d=d.replace(/^\s+|\s+$|\n+/g,"").replace(/\s+/g," ");var p=s.strokeWidth;s.strokeWidth=0;var m=new i.Text(d,s),b=m.getScaledHeight()/m.height,y=((m.height+m.strokeWidth)*m.lineHeight-m.height)*b,w=m.getScaledHeight()+y,T=0;h==="center"&&(T=m.getScaledWidth()/2),h==="right"&&(T=m.getScaledWidth()),m.set({left:m.left-T,top:m.top-(w-m.fontSize*(.07+m._fontSizeFraction))/m.lineHeight,strokeWidth:p!==void 0?p:1}),t(m)},i.Text.fromObject=function(e,t){var s=n(e),c=e.path;return delete s.path,i.Object._fromObject("Text",s,function(h){c?i.Object._fromObject("Path",c,function(l){h.set("path",l),t(h)},"path"):t(h)},"text")},i.Text.genericFonts=["sans-serif","serif","cursive","fantasy","monospace"],i.util.createAccessors&&i.util.createAccessors(i.Text)}}(o),g.util.object.extend(g.Text.prototype,{isEmptyStyles:function(r){if(!this.styles||r!==void 0&&!this.styles[r])return!0;var i=r===void 0?this.styles:{line:this.styles[r]};for(var n in i)for(var a in i[n])for(var e in i[n][a])return!1;return!0},styleHas:function(r,i){if(!this.styles||!r||r===""||i!==void 0&&!this.styles[i])return!1;var n=i===void 0?this.styles:{0:this.styles[i]};for(var a in n)for(var e in n[a])if(n[a][e][r]!==void 0)return!0;return!1},cleanStyle:function(r){if(!this.styles||!r||r==="")return!1;var i,n,a=this.styles,e=0,t=!0,s=0;for(var c in a){for(var h in i=0,a[c]){var l;e++,(l=a[c][h]).hasOwnProperty(r)?(n?l[r]!==n&&(t=!1):n=l[r],l[r]===this[r]&&delete l[r]):t=!1,Object.keys(l).length!==0?i++:delete a[c][h]}i===0&&delete a[c]}for(var d=0;d<this._textLines.length;d++)s+=this._textLines[d].length;t&&e===s&&(this[r]=n,this.removeStyle(r))},removeStyle:function(r){if(this.styles&&r&&r!==""){var i,n,a,e=this.styles;for(n in e){for(a in i=e[n])delete i[a][r],Object.keys(i[a]).length===0&&delete i[a];Object.keys(i).length===0&&delete e[n]}}},_extendStyles:function(r,i){var n=this.get2DCursorLocation(r);this._getLineStyle(n.lineIndex)||this._setLineStyle(n.lineIndex),this._getStyleDeclaration(n.lineIndex,n.charIndex)||this._setStyleDeclaration(n.lineIndex,n.charIndex,{}),g.util.object.extend(this._getStyleDeclaration(n.lineIndex,n.charIndex),i)},get2DCursorLocation:function(r,i){r===void 0&&(r=this.selectionStart);for(var n=i?this._unwrappedTextLines:this._textLines,a=n.length,e=0;e<a;e++){if(r<=n[e].length)return{lineIndex:e,charIndex:r};r-=n[e].length+this.missingNewlineOffset(e)}return{lineIndex:e-1,charIndex:n[e-1].length<r?n[e-1].length:r}},getSelectionStyles:function(r,i,n){r===void 0&&(r=this.selectionStart||0),i===void 0&&(i=this.selectionEnd||r);for(var a=[],e=r;e<i;e++)a.push(this.getStyleAtPosition(e,n));return a},getStyleAtPosition:function(r,i){var n=this.get2DCursorLocation(r);return(i?this.getCompleteStyleDeclaration(n.lineIndex,n.charIndex):this._getStyleDeclaration(n.lineIndex,n.charIndex))||{}},setSelectionStyles:function(r,i,n){i===void 0&&(i=this.selectionStart||0),n===void 0&&(n=this.selectionEnd||i);for(var a=i;a<n;a++)this._extendStyles(a,r);return this._forceClearCache=!0,this},_getStyleDeclaration:function(r,i){var n=this.styles&&this.styles[r];return n?n[i]:null},getCompleteStyleDeclaration:function(r,i){for(var n,a=this._getStyleDeclaration(r,i)||{},e={},t=0;t<this._styleProperties.length;t++)e[n=this._styleProperties[t]]=a[n]===void 0?this[n]:a[n];return e},_setStyleDeclaration:function(r,i,n){this.styles[r][i]=n},_deleteStyleDeclaration:function(r,i){delete this.styles[r][i]},_getLineStyle:function(r){return!!this.styles[r]},_setLineStyle:function(r){this.styles[r]={}},_deleteLineStyle:function(r){delete this.styles[r]}}),function(){function r(i){i.textDecoration&&(i.textDecoration.indexOf("underline")>-1&&(i.underline=!0),i.textDecoration.indexOf("line-through")>-1&&(i.linethrough=!0),i.textDecoration.indexOf("overline")>-1&&(i.overline=!0),delete i.textDecoration)}g.IText=g.util.createClass(g.Text,g.Observable,{type:"i-text",selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"",cursorDelay:1e3,cursorDuration:600,caching:!0,hiddenTextareaContainer:null,_reSpace:/\s|\n/,_currentCursorOpacity:0,_selectionDirection:null,_abortCursorAnimation:!1,__widthOfSpace:[],inCompositionMode:!1,initialize:function(i,n){this.callSuper("initialize",i,n),this.initBehavior()},setSelectionStart:function(i){i=Math.max(i,0),this._updateAndFire("selectionStart",i)},setSelectionEnd:function(i){i=Math.min(i,this.text.length),this._updateAndFire("selectionEnd",i)},_updateAndFire:function(i,n){this[i]!==n&&(this._fireSelectionChanged(),this[i]=n),this._updateTextarea()},_fireSelectionChanged:function(){this.fire("selection:changed"),this.canvas&&this.canvas.fire("text:selection:changed",{target:this})},initDimensions:function(){this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this.callSuper("initDimensions")},render:function(i){this.clearContextTop(),this.callSuper("render",i),this.cursorOffsetCache={},this.renderCursorOrSelection()},_render:function(i){this.callSuper("_render",i)},clearContextTop:function(i){if(this.isEditing&&this.canvas&&this.canvas.contextTop){var n=this.canvas.contextTop,a=this.canvas.viewportTransform;n.save(),n.transform(a[0],a[1],a[2],a[3],a[4],a[5]),this.transform(n),this._clearTextArea(n),i||n.restore()}},renderCursorOrSelection:function(){if(this.isEditing&&this.canvas&&this.canvas.contextTop){var i=this._getCursorBoundaries(),n=this.canvas.contextTop;this.clearContextTop(!0),this.selectionStart===this.selectionEnd?this.renderCursor(i,n):this.renderSelection(i,n),n.restore()}},_clearTextArea:function(i){var n=this.width+4,a=this.height+4;i.clearRect(-n/2,-a/2,n,a)},_getCursorBoundaries:function(i){i===void 0&&(i=this.selectionStart);var n=this._getLeftOffset(),a=this._getTopOffset(),e=this._getCursorBoundariesOffsets(i);return{left:n,top:a,leftOffset:e.left,topOffset:e.top}},_getCursorBoundariesOffsets:function(i){if(this.cursorOffsetCache&&"top"in this.cursorOffsetCache)return this.cursorOffsetCache;var n,a,e,t,s=0,c=0,h=this.get2DCursorLocation(i);e=h.charIndex,a=h.lineIndex;for(var l=0;l<a;l++)s+=this.getHeightOfLine(l);n=this._getLineLeftOffset(a);var d=this.__charBounds[a][e];return d&&(c=d.left),this.charSpacing!==0&&e===this._textLines[a].length&&(c-=this._getWidthOfCharSpacing()),t={top:s,left:n+(c>0?c:0)},this.direction==="rtl"&&(t.left*=-1),this.cursorOffsetCache=t,this.cursorOffsetCache},renderCursor:function(i,n){var a=this.get2DCursorLocation(),e=a.lineIndex,t=a.charIndex>0?a.charIndex-1:0,s=this.getValueOfPropertyAt(e,t,"fontSize"),c=this.scaleX*this.canvas.getZoom(),h=this.cursorWidth/c,l=i.topOffset,d=this.getValueOfPropertyAt(e,t,"deltaY");l+=(1-this._fontSizeFraction)*this.getHeightOfLine(e)/this.lineHeight-s*(1-this._fontSizeFraction),this.inCompositionMode&&this.renderSelection(i,n),n.fillStyle=this.cursorColor||this.getValueOfPropertyAt(e,t,"fill"),n.globalAlpha=this.__isMousedown?1:this._currentCursorOpacity,n.fillRect(i.left+i.leftOffset-h/2,l+i.top+d,h,s)},renderSelection:function(i,n){for(var a=this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,e=this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd,t=this.textAlign.indexOf("justify")!==-1,s=this.get2DCursorLocation(a),c=this.get2DCursorLocation(e),h=s.lineIndex,l=c.lineIndex,d=s.charIndex<0?0:s.charIndex,p=c.charIndex<0?0:c.charIndex,m=h;m<=l;m++){var b,y=this._getLineLeftOffset(m)||0,w=this.getHeightOfLine(m),T=0,k=0;if(m===h&&(T=this.__charBounds[h][d].left),m>=h&&m<l)k=t&&!this.isEndOfWrapping(m)?this.width:this.getLineWidth(m)||5;else if(m===l)if(p===0)k=this.__charBounds[l][p].left;else{var P=this._getWidthOfCharSpacing();k=this.__charBounds[l][p-1].left+this.__charBounds[l][p-1].width-P}b=w,(this.lineHeight<1||m===l&&this.lineHeight>1)&&(w/=this.lineHeight);var G=i.left+y+T,V=k-T,N=w,A=0;this.inCompositionMode?(n.fillStyle=this.compositionColor||"black",N=1,A=w):n.fillStyle=this.selectionColor,this.direction==="rtl"&&(G=this.width-G-V),n.fillRect(G,i.top+i.topOffset+A,V,N),i.topOffset+=b}},getCurrentCharFontSize:function(){var i=this._getCurrentCharIndex();return this.getValueOfPropertyAt(i.l,i.c,"fontSize")},getCurrentCharColor:function(){var i=this._getCurrentCharIndex();return this.getValueOfPropertyAt(i.l,i.c,"fill")},_getCurrentCharIndex:function(){var i=this.get2DCursorLocation(this.selectionStart,!0),n=i.charIndex>0?i.charIndex-1:0;return{l:i.lineIndex,c:n}}}),g.IText.fromObject=function(i,n){if(r(i),i.styles)for(var a in i.styles)for(var e in i.styles[a])r(i.styles[a][e]);g.Object._fromObject("IText",i,n,"text")}}(),be=g.util.object.clone,g.util.object.extend(g.IText.prototype,{initBehavior:function(){this.initAddedHandler(),this.initRemovedHandler(),this.initCursorSelectionHandlers(),this.initDoubleClickSimulation(),this.mouseMoveHandler=this.mouseMoveHandler.bind(this)},onDeselect:function(){this.isEditing&&this.exitEditing(),this.selected=!1},initAddedHandler:function(){var r=this;this.on("added",function(){var i=r.canvas;i&&(i._hasITextHandlers||(i._hasITextHandlers=!0,r._initCanvasHandlers(i)),i._iTextInstances=i._iTextInstances||[],i._iTextInstances.push(r))})},initRemovedHandler:function(){var r=this;this.on("removed",function(){var i=r.canvas;i&&(i._iTextInstances=i._iTextInstances||[],g.util.removeFromArray(i._iTextInstances,r),i._iTextInstances.length===0&&(i._hasITextHandlers=!1,r._removeCanvasHandlers(i)))})},_initCanvasHandlers:function(r){r._mouseUpITextHandler=function(){r._iTextInstances&&r._iTextInstances.forEach(function(i){i.__isMousedown=!1})},r.on("mouse:up",r._mouseUpITextHandler)},_removeCanvasHandlers:function(r){r.off("mouse:up",r._mouseUpITextHandler)},_tick:function(){this._currentTickState=this._animateCursor(this,1,this.cursorDuration,"_onTickComplete")},_animateCursor:function(r,i,n,a){var e;return e={isAborted:!1,abort:function(){this.isAborted=!0}},r.animate("_currentCursorOpacity",i,{duration:n,onComplete:function(){e.isAborted||r[a]()},onChange:function(){r.canvas&&r.selectionStart===r.selectionEnd&&r.renderCursorOrSelection()},abort:function(){return e.isAborted}}),e},_onTickComplete:function(){var r=this;this._cursorTimeout1&&clearTimeout(this._cursorTimeout1),this._cursorTimeout1=setTimeout(function(){r._currentTickCompleteState=r._animateCursor(r,0,this.cursorDuration/2,"_tick")},100)},initDelayedCursor:function(r){var i=this,n=r?0:this.cursorDelay;this.abortCursorAnimation(),this._currentCursorOpacity=1,this._cursorTimeout2=setTimeout(function(){i._tick()},n)},abortCursorAnimation:function(){var r=this._currentTickState||this._currentTickCompleteState,i=this.canvas;this._currentTickState&&this._currentTickState.abort(),this._currentTickCompleteState&&this._currentTickCompleteState.abort(),clearTimeout(this._cursorTimeout1),clearTimeout(this._cursorTimeout2),this._currentCursorOpacity=0,r&&i&&i.clearContext(i.contextTop||i.contextContainer)},selectAll:function(){return this.selectionStart=0,this.selectionEnd=this._text.length,this._fireSelectionChanged(),this._updateTextarea(),this},getSelectedText:function(){return this._text.slice(this.selectionStart,this.selectionEnd).join("")},findWordBoundaryLeft:function(r){var i=0,n=r-1;if(this._reSpace.test(this._text[n]))for(;this._reSpace.test(this._text[n]);)i++,n--;for(;/\S/.test(this._text[n])&&n>-1;)i++,n--;return r-i},findWordBoundaryRight:function(r){var i=0,n=r;if(this._reSpace.test(this._text[n]))for(;this._reSpace.test(this._text[n]);)i++,n++;for(;/\S/.test(this._text[n])&&n<this._text.length;)i++,n++;return r+i},findLineBoundaryLeft:function(r){for(var i=0,n=r-1;!/\n/.test(this._text[n])&&n>-1;)i++,n--;return r-i},findLineBoundaryRight:function(r){for(var i=0,n=r;!/\n/.test(this._text[n])&&n<this._text.length;)i++,n++;return r+i},searchWordBoundary:function(r,i){for(var n=this._text,a=this._reSpace.test(n[r])?r-1:r,e=n[a],t=g.reNonWord;!t.test(e)&&a>0&&a<n.length;)e=n[a+=i];return t.test(e)&&(a+=i===1?0:1),a},selectWord:function(r){r=r||this.selectionStart;var i=this.searchWordBoundary(r,-1),n=this.searchWordBoundary(r,1);this.selectionStart=i,this.selectionEnd=n,this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()},selectLine:function(r){r=r||this.selectionStart;var i=this.findLineBoundaryLeft(r),n=this.findLineBoundaryRight(r);return this.selectionStart=i,this.selectionEnd=n,this._fireSelectionChanged(),this._updateTextarea(),this},enterEditing:function(r){if(!this.isEditing&&this.editable)return this.canvas&&(this.canvas.calcOffset(),this.exitEditingOnOthers(this.canvas)),this.isEditing=!0,this.initHiddenTextarea(r),this.hiddenTextarea.focus(),this.hiddenTextarea.value=this.text,this._updateTextarea(),this._saveEditingProps(),this._setEditingProps(),this._textBeforeEdit=this.text,this._tick(),this.fire("editing:entered"),this._fireSelectionChanged(),this.canvas?(this.canvas.fire("text:editing:entered",{target:this}),this.initMouseMoveHandler(),this.canvas.requestRenderAll(),this):this},exitEditingOnOthers:function(r){r._iTextInstances&&r._iTextInstances.forEach(function(i){i.selected=!1,i.isEditing&&i.exitEditing()})},initMouseMoveHandler:function(){this.canvas.on("mouse:move",this.mouseMoveHandler)},mouseMoveHandler:function(r){if(this.__isMousedown&&this.isEditing){var i=this.getSelectionStartFromPointer(r.e),n=this.selectionStart,a=this.selectionEnd;(i===this.__selectionStartOnMouseDown&&n!==a||n!==i&&a!==i)&&(i>this.__selectionStartOnMouseDown?(this.selectionStart=this.__selectionStartOnMouseDown,this.selectionEnd=i):(this.selectionStart=i,this.selectionEnd=this.__selectionStartOnMouseDown),this.selectionStart===n&&this.selectionEnd===a||(this.restartCursorIfNeeded(),this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()))}},_setEditingProps:function(){this.hoverCursor="text",this.canvas&&(this.canvas.defaultCursor=this.canvas.moveCursor="text"),this.borderColor=this.editingBorderColor,this.hasControls=this.selectable=!1,this.lockMovementX=this.lockMovementY=!0},fromStringToGraphemeSelection:function(r,i,n){var a=n.slice(0,r),e=g.util.string.graphemeSplit(a).length;if(r===i)return{selectionStart:e,selectionEnd:e};var t=n.slice(r,i);return{selectionStart:e,selectionEnd:e+g.util.string.graphemeSplit(t).length}},fromGraphemeToStringSelection:function(r,i,n){var a=n.slice(0,r).join("").length;return r===i?{selectionStart:a,selectionEnd:a}:{selectionStart:a,selectionEnd:a+n.slice(r,i).join("").length}},_updateTextarea:function(){if(this.cursorOffsetCache={},this.hiddenTextarea){if(!this.inCompositionMode){var r=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text);this.hiddenTextarea.selectionStart=r.selectionStart,this.hiddenTextarea.selectionEnd=r.selectionEnd}this.updateTextareaPosition()}},updateFromTextArea:function(){if(this.hiddenTextarea){this.cursorOffsetCache={},this.text=this.hiddenTextarea.value,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords());var r=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value);this.selectionEnd=this.selectionStart=r.selectionEnd,this.inCompositionMode||(this.selectionStart=r.selectionStart),this.updateTextareaPosition()}},updateTextareaPosition:function(){if(this.selectionStart===this.selectionEnd){var r=this._calcTextareaPosition();this.hiddenTextarea.style.left=r.left,this.hiddenTextarea.style.top=r.top}},_calcTextareaPosition:function(){if(!this.canvas)return{x:1,y:1};var r=this.inCompositionMode?this.compositionStart:this.selectionStart,i=this._getCursorBoundaries(r),n=this.get2DCursorLocation(r),a=n.lineIndex,e=n.charIndex,t=this.getValueOfPropertyAt(a,e,"fontSize")*this.lineHeight,s=i.leftOffset,c=this.calcTransformMatrix(),h={x:i.left+s,y:i.top+i.topOffset+t},l=this.canvas.getRetinaScaling(),d=this.canvas.upperCanvasEl,p=d.width/l,m=d.height/l,b=p-t,y=m-t,w=d.clientWidth/p,T=d.clientHeight/m;return h=g.util.transformPoint(h,c),(h=g.util.transformPoint(h,this.canvas.viewportTransform)).x*=w,h.y*=T,h.x<0&&(h.x=0),h.x>b&&(h.x=b),h.y<0&&(h.y=0),h.y>y&&(h.y=y),h.x+=this.canvas._offset.left,h.y+=this.canvas._offset.top,{left:h.x+"px",top:h.y+"px",fontSize:t+"px",charHeight:t}},_saveEditingProps:function(){this._savedProps={hasControls:this.hasControls,borderColor:this.borderColor,lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,hoverCursor:this.hoverCursor,selectable:this.selectable,defaultCursor:this.canvas&&this.canvas.defaultCursor,moveCursor:this.canvas&&this.canvas.moveCursor}},_restoreEditingProps:function(){this._savedProps&&(this.hoverCursor=this._savedProps.hoverCursor,this.hasControls=this._savedProps.hasControls,this.borderColor=this._savedProps.borderColor,this.selectable=this._savedProps.selectable,this.lockMovementX=this._savedProps.lockMovementX,this.lockMovementY=this._savedProps.lockMovementY,this.canvas&&(this.canvas.defaultCursor=this._savedProps.defaultCursor,this.canvas.moveCursor=this._savedProps.moveCursor))},exitEditing:function(){var r=this._textBeforeEdit!==this.text,i=this.hiddenTextarea;return this.selected=!1,this.isEditing=!1,this.selectionEnd=this.selectionStart,i&&(i.blur&&i.blur(),i.parentNode&&i.parentNode.removeChild(i)),this.hiddenTextarea=null,this.abortCursorAnimation(),this._restoreEditingProps(),this._currentCursorOpacity=0,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this.fire("editing:exited"),r&&this.fire("modified"),this.canvas&&(this.canvas.off("mouse:move",this.mouseMoveHandler),this.canvas.fire("text:editing:exited",{target:this}),r&&this.canvas.fire("object:modified",{target:this})),this},_removeExtraneousStyles:function(){for(var r in this.styles)this._textLines[r]||delete this.styles[r]},removeStyleFromTo:function(r,i){var n,a,e=this.get2DCursorLocation(r,!0),t=this.get2DCursorLocation(i,!0),s=e.lineIndex,c=e.charIndex,h=t.lineIndex,l=t.charIndex;if(s!==h){if(this.styles[s])for(n=c;n<this._unwrappedTextLines[s].length;n++)delete this.styles[s][n];if(this.styles[h])for(n=l;n<this._unwrappedTextLines[h].length;n++)(a=this.styles[h][n])&&(this.styles[s]||(this.styles[s]={}),this.styles[s][c+n-l]=a);for(n=s+1;n<=h;n++)delete this.styles[n];this.shiftLineStyles(h,s-h)}else if(this.styles[s]){a=this.styles[s];var d,p,m=l-c;for(n=c;n<l;n++)delete a[n];for(p in this.styles[s])(d=parseInt(p,10))>=l&&(a[d-m]=a[p],delete a[p])}},shiftLineStyles:function(r,i){var n=be(this.styles);for(var a in this.styles){var e=parseInt(a,10);e>r&&(this.styles[e+i]=n[e],n[e-i]||delete this.styles[e])}},restartCursorIfNeeded:function(){this._currentTickState&&!this._currentTickState.isAborted&&this._currentTickCompleteState&&!this._currentTickCompleteState.isAborted||this.initDelayedCursor()},insertNewlineStyleObject:function(r,i,n,a){var e,t={},s=!1,c=this._unwrappedTextLines[r].length===i;for(var h in n||(n=1),this.shiftLineStyles(r,n),this.styles[r]&&(e=this.styles[r][i===0?i:i-1]),this.styles[r]){var l=parseInt(h,10);l>=i&&(s=!0,t[l-i]=this.styles[r][h],c&&i===0||delete this.styles[r][h])}var d=!1;for(s&&!c&&(this.styles[r+n]=t,d=!0),d&&n--;n>0;)a&&a[n-1]?this.styles[r+n]={0:be(a[n-1])}:e?this.styles[r+n]={0:be(e)}:delete this.styles[r+n],n--;this._forceClearCache=!0},insertCharStyleObject:function(r,i,n,a){this.styles||(this.styles={});var e=this.styles[r],t=e?be(e):{};for(var s in n||(n=1),t){var c=parseInt(s,10);c>=i&&(e[c+n]=t[c],t[c-n]||delete e[c])}if(this._forceClearCache=!0,a)for(;n--;)Object.keys(a[n]).length&&(this.styles[r]||(this.styles[r]={}),this.styles[r][i+n]=be(a[n]));else if(e)for(var h=e[i?i-1:1];h&&n--;)this.styles[r][i+n]=be(h)},insertNewStyleBlock:function(r,i,n){for(var a=this.get2DCursorLocation(i,!0),e=[0],t=0,s=0;s<r.length;s++)r[s]==="\n"?e[++t]=0:e[t]++;for(e[0]>0&&(this.insertCharStyleObject(a.lineIndex,a.charIndex,e[0],n),n=n&&n.slice(e[0]+1)),t&&this.insertNewlineStyleObject(a.lineIndex,a.charIndex+e[0],t),s=1;s<t;s++)e[s]>0?this.insertCharStyleObject(a.lineIndex+s,0,e[s],n):n&&this.styles[a.lineIndex+s]&&n[0]&&(this.styles[a.lineIndex+s][0]=n[0]),n=n&&n.slice(e[s]+1);e[s]>0&&this.insertCharStyleObject(a.lineIndex+s,0,e[s],n)},setSelectionStartEndWithShift:function(r,i,n){n<=r?(i===r?this._selectionDirection="left":this._selectionDirection==="right"&&(this._selectionDirection="left",this.selectionEnd=r),this.selectionStart=n):n>r&&n<i?this._selectionDirection==="right"?this.selectionEnd=n:this.selectionStart=n:(i===r?this._selectionDirection="right":this._selectionDirection==="left"&&(this._selectionDirection="right",this.selectionStart=i),this.selectionEnd=n)},setSelectionInBoundaries:function(){var r=this.text.length;this.selectionStart>r?this.selectionStart=r:this.selectionStart<0&&(this.selectionStart=0),this.selectionEnd>r?this.selectionEnd=r:this.selectionEnd<0&&(this.selectionEnd=0)}}),g.util.object.extend(g.IText.prototype,{initDoubleClickSimulation:function(){this.__lastClickTime=+new Date,this.__lastLastClickTime=+new Date,this.__lastPointer={},this.on("mousedown",this.onMouseDown)},onMouseDown:function(r){if(this.canvas){this.__newClickTime=+new Date;var i=r.pointer;this.isTripleClick(i)&&(this.fire("tripleclick",r),this._stopEvent(r.e)),this.__lastLastClickTime=this.__lastClickTime,this.__lastClickTime=this.__newClickTime,this.__lastPointer=i,this.__lastIsEditing=this.isEditing,this.__lastSelected=this.selected}},isTripleClick:function(r){return this.__newClickTime-this.__lastClickTime<500&&this.__lastClickTime-this.__lastLastClickTime<500&&this.__lastPointer.x===r.x&&this.__lastPointer.y===r.y},_stopEvent:function(r){r.preventDefault&&r.preventDefault(),r.stopPropagation&&r.stopPropagation()},initCursorSelectionHandlers:function(){this.initMousedownHandler(),this.initMouseupHandler(),this.initClicks()},doubleClickHandler:function(r){this.isEditing&&this.selectWord(this.getSelectionStartFromPointer(r.e))},tripleClickHandler:function(r){this.isEditing&&this.selectLine(this.getSelectionStartFromPointer(r.e))},initClicks:function(){this.on("mousedblclick",this.doubleClickHandler),this.on("tripleclick",this.tripleClickHandler)},_mouseDownHandler:function(r){!this.canvas||!this.editable||r.e.button&&r.e.button!==1||(this.__isMousedown=!0,this.selected&&(this.inCompositionMode=!1,this.setCursorByClick(r.e)),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection()))},_mouseDownHandlerBefore:function(r){!this.canvas||!this.editable||r.e.button&&r.e.button!==1||(this.selected=this===this.canvas._activeObject)},initMousedownHandler:function(){this.on("mousedown",this._mouseDownHandler),this.on("mousedown:before",this._mouseDownHandlerBefore)},initMouseupHandler:function(){this.on("mouseup",this.mouseUpHandler)},mouseUpHandler:function(r){if(this.__isMousedown=!1,!(!this.editable||this.group||r.transform&&r.transform.actionPerformed||r.e.button&&r.e.button!==1)){if(this.canvas){var i=this.canvas._activeObject;if(i&&i!==this)return}this.__lastSelected&&!this.__corner?(this.selected=!1,this.__lastSelected=!1,this.enterEditing(r.e),this.selectionStart===this.selectionEnd?this.initDelayedCursor(!0):this.renderCursorOrSelection()):this.selected=!0}},setCursorByClick:function(r){var i=this.getSelectionStartFromPointer(r),n=this.selectionStart,a=this.selectionEnd;r.shiftKey?this.setSelectionStartEndWithShift(n,a,i):(this.selectionStart=i,this.selectionEnd=i),this.isEditing&&(this._fireSelectionChanged(),this._updateTextarea())},getSelectionStartFromPointer:function(r){for(var i,n=this.getLocalPointer(r),a=0,e=0,t=0,s=0,c=0,h=0,l=this._textLines.length;h<l&&t<=n.y;h++)t+=this.getHeightOfLine(h)*this.scaleY,c=h,h>0&&(s+=this._textLines[h-1].length+this.missingNewlineOffset(h-1));e=this._getLineLeftOffset(c)*this.scaleX,i=this._textLines[c],this.direction==="rtl"&&(n.x=this.width*this.scaleX-n.x+e);for(var d=0,p=i.length;d<p&&(a=e,(e+=this.__charBounds[c][d].kernedWidth*this.scaleX)<=n.x);d++)s++;return this._getNewSelectionStartFromOffset(n,a,e,s,p)},_getNewSelectionStartFromOffset:function(r,i,n,a,e){var t=r.x-i,s=n-r.x,c=a+(s>t||s<0?0:1);return this.flipX&&(c=e-c),c>this._text.length&&(c=this._text.length),c}}),g.util.object.extend(g.IText.prototype,{initHiddenTextarea:function(){this.hiddenTextarea=g.document.createElement("textarea"),this.hiddenTextarea.setAttribute("autocapitalize","off"),this.hiddenTextarea.setAttribute("autocorrect","off"),this.hiddenTextarea.setAttribute("autocomplete","off"),this.hiddenTextarea.setAttribute("spellcheck","false"),this.hiddenTextarea.setAttribute("data-fabric-hiddentextarea",""),this.hiddenTextarea.setAttribute("wrap","off");var r=this._calcTextareaPosition();this.hiddenTextarea.style.cssText="position: absolute; top: "+r.top+"; left: "+r.left+"; z-index: -999; opacity: 0; width: 1px; height: 1px; font-size: 1px; paddingtop: "+r.fontSize+";",this.hiddenTextareaContainer?this.hiddenTextareaContainer.appendChild(this.hiddenTextarea):g.document.body.appendChild(this.hiddenTextarea),g.util.addListener(this.hiddenTextarea,"keydown",this.onKeyDown.bind(this)),g.util.addListener(this.hiddenTextarea,"keyup",this.onKeyUp.bind(this)),g.util.addListener(this.hiddenTextarea,"input",this.onInput.bind(this)),g.util.addListener(this.hiddenTextarea,"copy",this.copy.bind(this)),g.util.addListener(this.hiddenTextarea,"cut",this.copy.bind(this)),g.util.addListener(this.hiddenTextarea,"paste",this.paste.bind(this)),g.util.addListener(this.hiddenTextarea,"compositionstart",this.onCompositionStart.bind(this)),g.util.addListener(this.hiddenTextarea,"compositionupdate",this.onCompositionUpdate.bind(this)),g.util.addListener(this.hiddenTextarea,"compositionend",this.onCompositionEnd.bind(this)),!this._clickHandlerInitialized&&this.canvas&&(g.util.addListener(this.canvas.upperCanvasEl,"click",this.onClick.bind(this)),this._clickHandlerInitialized=!0)},keysMap:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorRight",36:"moveCursorLeft",37:"moveCursorLeft",38:"moveCursorUp",39:"moveCursorRight",40:"moveCursorDown"},keysMapRtl:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorLeft",36:"moveCursorRight",37:"moveCursorRight",38:"moveCursorUp",39:"moveCursorLeft",40:"moveCursorDown"},ctrlKeysMapUp:{67:"copy",88:"cut"},ctrlKeysMapDown:{65:"selectAll"},onClick:function(){this.hiddenTextarea&&this.hiddenTextarea.focus()},onKeyDown:function(r){if(this.isEditing){var i=this.direction==="rtl"?this.keysMapRtl:this.keysMap;if(r.keyCode in i)this[i[r.keyCode]](r);else{if(!(r.keyCode in this.ctrlKeysMapDown)||!r.ctrlKey&&!r.metaKey)return;this[this.ctrlKeysMapDown[r.keyCode]](r)}r.stopImmediatePropagation(),r.preventDefault(),r.keyCode>=33&&r.keyCode<=40?(this.inCompositionMode=!1,this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}},onKeyUp:function(r){!this.isEditing||this._copyDone||this.inCompositionMode?this._copyDone=!1:r.keyCode in this.ctrlKeysMapUp&&(r.ctrlKey||r.metaKey)&&(this[this.ctrlKeysMapUp[r.keyCode]](r),r.stopImmediatePropagation(),r.preventDefault(),this.canvas&&this.canvas.requestRenderAll())},onInput:function(r){var i=this.fromPaste;if(this.fromPaste=!1,r&&r.stopPropagation(),this.isEditing){var n,a,e,t,s,c=this._splitTextIntoLines(this.hiddenTextarea.value).graphemeText,h=this._text.length,l=c.length,d=l-h,p=this.selectionStart,m=this.selectionEnd,b=p!==m;if(this.hiddenTextarea.value==="")return this.styles={},this.updateFromTextArea(),this.fire("changed"),void(this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll()));var y=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value),w=p>y.selectionStart;b?(n=this._text.slice(p,m),d+=m-p):l<h&&(n=w?this._text.slice(m+d,m):this._text.slice(p,p-d)),a=c.slice(y.selectionEnd-d,y.selectionEnd),n&&n.length&&(a.length&&(e=this.getSelectionStyles(p,p+1,!1),e=a.map(function(){return e[0]})),b?(t=p,s=m):w?(t=m-n.length,s=m):(t=m,s=m+n.length),this.removeStyleFromTo(t,s)),a.length&&(i&&a.join("")===g.copiedText&&!g.disableStyleCopyPaste&&(e=g.copiedTextStyle),this.insertNewStyleBlock(a,p,e)),this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())}},onCompositionStart:function(){this.inCompositionMode=!0},onCompositionEnd:function(){this.inCompositionMode=!1},onCompositionUpdate:function(r){this.compositionStart=r.target.selectionStart,this.compositionEnd=r.target.selectionEnd,this.updateTextareaPosition()},copy:function(){this.selectionStart!==this.selectionEnd&&(g.copiedText=this.getSelectedText(),g.disableStyleCopyPaste?g.copiedTextStyle=null:g.copiedTextStyle=this.getSelectionStyles(this.selectionStart,this.selectionEnd,!0),this._copyDone=!0)},paste:function(){this.fromPaste=!0},_getClipboardData:function(r){return r&&r.clipboardData||g.window.clipboardData},_getWidthBeforeCursor:function(r,i){var n,a=this._getLineLeftOffset(r);return i>0&&(a+=(n=this.__charBounds[r][i-1]).left+n.width),a},getDownCursorOffset:function(r,i){var n=this._getSelectionForOffset(r,i),a=this.get2DCursorLocation(n),e=a.lineIndex;if(e===this._textLines.length-1||r.metaKey||r.keyCode===34)return this._text.length-n;var t=a.charIndex,s=this._getWidthBeforeCursor(e,t),c=this._getIndexOnLine(e+1,s);return this._textLines[e].slice(t).length+c+1+this.missingNewlineOffset(e)},_getSelectionForOffset:function(r,i){return r.shiftKey&&this.selectionStart!==this.selectionEnd&&i?this.selectionEnd:this.selectionStart},getUpCursorOffset:function(r,i){var n=this._getSelectionForOffset(r,i),a=this.get2DCursorLocation(n),e=a.lineIndex;if(e===0||r.metaKey||r.keyCode===33)return-n;var t=a.charIndex,s=this._getWidthBeforeCursor(e,t),c=this._getIndexOnLine(e-1,s),h=this._textLines[e].slice(0,t),l=this.missingNewlineOffset(e-1);return-this._textLines[e-1].length+c-h.length+(1-l)},_getIndexOnLine:function(r,i){for(var n,a,e=this._textLines[r],t=this._getLineLeftOffset(r),s=0,c=0,h=e.length;c<h;c++)if((t+=n=this.__charBounds[r][c].width)>i){a=!0;var l=t-n,d=t,p=Math.abs(l-i);s=Math.abs(d-i)<p?c:c-1;break}return a||(s=e.length-1),s},moveCursorDown:function(r){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",r)},moveCursorUp:function(r){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorUpOrDown("Up",r)},_moveCursorUpOrDown:function(r,i){var n=this["get"+r+"CursorOffset"](i,this._selectionDirection==="right");i.shiftKey?this.moveCursorWithShift(n):this.moveCursorWithoutShift(n),n!==0&&(this.setSelectionInBoundaries(),this.abortCursorAnimation(),this._currentCursorOpacity=1,this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorWithShift:function(r){var i=this._selectionDirection==="left"?this.selectionStart+r:this.selectionEnd+r;return this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,i),r!==0},moveCursorWithoutShift:function(r){return r<0?(this.selectionStart+=r,this.selectionEnd=this.selectionStart):(this.selectionEnd+=r,this.selectionStart=this.selectionEnd),r!==0},moveCursorLeft:function(r){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorLeftOrRight("Left",r)},_move:function(r,i,n){var a;if(r.altKey)a=this["findWordBoundary"+n](this[i]);else{if(!r.metaKey&&r.keyCode!==35&&r.keyCode!==36)return this[i]+=n==="Left"?-1:1,!0;a=this["findLineBoundary"+n](this[i])}if(typeof a!==void 0&&this[i]!==a)return this[i]=a,!0},_moveLeft:function(r,i){return this._move(r,i,"Left")},_moveRight:function(r,i){return this._move(r,i,"Right")},moveCursorLeftWithoutShift:function(r){var i=!0;return this._selectionDirection="left",this.selectionEnd===this.selectionStart&&this.selectionStart!==0&&(i=this._moveLeft(r,"selectionStart")),this.selectionEnd=this.selectionStart,i},moveCursorLeftWithShift:function(r){return this._selectionDirection==="right"&&this.selectionStart!==this.selectionEnd?this._moveLeft(r,"selectionEnd"):this.selectionStart!==0?(this._selectionDirection="left",this._moveLeft(r,"selectionStart")):void 0},moveCursorRight:function(r){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorLeftOrRight("Right",r)},_moveCursorLeftOrRight:function(r,i){var n="moveCursor"+r+"With";this._currentCursorOpacity=1,i.shiftKey?n+="Shift":n+="outShift",this[n](i)&&(this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorRightWithShift:function(r){return this._selectionDirection==="left"&&this.selectionStart!==this.selectionEnd?this._moveRight(r,"selectionStart"):this.selectionEnd!==this._text.length?(this._selectionDirection="right",this._moveRight(r,"selectionEnd")):void 0},moveCursorRightWithoutShift:function(r){var i=!0;return this._selectionDirection="right",this.selectionStart===this.selectionEnd?(i=this._moveRight(r,"selectionStart"),this.selectionEnd=this.selectionStart):this.selectionStart=this.selectionEnd,i},removeChars:function(r,i){i===void 0&&(i=r+1),this.removeStyleFromTo(r,i),this._text.splice(r,i-r),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()},insertChars:function(r,i,n,a){a===void 0&&(a=n),a>n&&this.removeStyleFromTo(n,a);var e=g.util.string.graphemeSplit(r);this.insertNewStyleBlock(e,n,i),this._text=[].concat(this._text.slice(0,n),e,this._text.slice(a)),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()}}),function(){var r=g.util.toFixed,i=/  +/g;g.util.object.extend(g.Text.prototype,{_toSVG:function(){var n=this._getSVGLeftTopOffsets(),a=this._getSVGTextAndBg(n.textTop,n.textLeft);return this._wrapSVGTextAndBg(a)},toSVG:function(n){return this._createBaseSVGMarkup(this._toSVG(),{reviver:n,noStyle:!0,withShadow:!0})},_getSVGLeftTopOffsets:function(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}},_wrapSVGTextAndBg:function(n){var a=this.getSvgTextDecoration(this);return[n.textBgRects.join(""),'		<text xml:space="preserve" ',this.fontFamily?'font-family="'+this.fontFamily.replace(/"/g,"'")+'" ':"",this.fontSize?'font-size="'+this.fontSize+'" ':"",this.fontStyle?'font-style="'+this.fontStyle+'" ':"",this.fontWeight?'font-weight="'+this.fontWeight+'" ':"",a?'text-decoration="'+a+'" ':"",'style="',this.getSvgStyles(!0),'"',this.addPaintOrder()," >",n.textSpans.join(""),"</text>\n"]},_getSVGTextAndBg:function(n,a){var e,t=[],s=[],c=n;this._setSVGBg(s);for(var h=0,l=this._textLines.length;h<l;h++)e=this._getLineLeftOffset(h),(this.textBackgroundColor||this.styleHas("textBackgroundColor",h))&&this._setSVGTextLineBg(s,h,a+e,c),this._setSVGTextLineText(t,h,a+e,c),c+=this.getHeightOfLine(h);return{textSpans:t,textBgRects:s}},_createTextCharSpan:function(n,a,e,t){var s=n!==n.trim()||n.match(i),c=this.getSvgSpanStyles(a,s),h=c?'style="'+c+'"':"",l=a.deltaY,d="",p=g.Object.NUM_FRACTION_DIGITS;return l&&(d=' dy="'+r(l,p)+'" '),['<tspan x="',r(e,p),'" y="',r(t,p),'" ',d,h,">",g.util.string.escapeXml(n),"</tspan>"].join("")},_setSVGTextLineText:function(n,a,e,t){var s,c,h,l,d,p=this.getHeightOfLine(a),m=this.textAlign.indexOf("justify")!==-1,b="",y=0,w=this._textLines[a];t+=p*(1-this._fontSizeFraction)/this.lineHeight;for(var T=0,k=w.length-1;T<=k;T++)d=T===k||this.charSpacing,b+=w[T],h=this.__charBounds[a][T],y===0?(e+=h.kernedWidth-h.width,y+=h.width):y+=h.kernedWidth,m&&!d&&this._reSpaceAndTab.test(w[T])&&(d=!0),d||(s=s||this.getCompleteStyleDeclaration(a,T),c=this.getCompleteStyleDeclaration(a,T+1),d=this._hasStyleChangedForSvg(s,c)),d&&(l=this._getStyleDeclaration(a,T)||{},n.push(this._createTextCharSpan(b,l,e,t)),b="",s=c,e+=y,y=0)},_pushTextBgRect:function(n,a,e,t,s,c){var h=g.Object.NUM_FRACTION_DIGITS;n.push("		<rect ",this._getFillAttributes(a),' x="',r(e,h),'" y="',r(t,h),'" width="',r(s,h),'" height="',r(c,h),'"></rect>\n')},_setSVGTextLineBg:function(n,a,e,t){for(var s,c,h=this._textLines[a],l=this.getHeightOfLine(a)/this.lineHeight,d=0,p=0,m=this.getValueOfPropertyAt(a,0,"textBackgroundColor"),b=0,y=h.length;b<y;b++)s=this.__charBounds[a][b],(c=this.getValueOfPropertyAt(a,b,"textBackgroundColor"))!==m?(m&&this._pushTextBgRect(n,m,e+p,t,d,l),p=s.left,d=s.width,m=c):d+=s.kernedWidth;c&&this._pushTextBgRect(n,c,e+p,t,d,l)},_getFillAttributes:function(n){var a=n&&typeof n=="string"?new g.Color(n):"";return a&&a.getSource()&&a.getAlpha()!==1?'opacity="'+a.getAlpha()+'" fill="'+a.setAlpha(1).toRgb()+'"':'fill="'+n+'"'},_getSVGLineTopOffset:function(n){for(var a,e=0,t=0;t<n;t++)e+=this.getHeightOfLine(t);return a=this.getHeightOfLine(t),{lineTop:e,offset:(this._fontSizeMult-this._fontSizeFraction)*a/(this.lineHeight*this._fontSizeMult)}},getSvgStyles:function(n){return g.Object.prototype.getSvgStyles.call(this,n)+" white-space: pre;"}})}(),function(r){var i=r.fabric||(r.fabric={});i.Textbox=i.util.createClass(i.IText,i.Observable,{type:"textbox",minWidth:20,dynamicMinWidth:2,__cachedLines:null,lockScalingFlip:!0,noScaleCache:!1,_dimensionAffectingProps:i.Text.prototype._dimensionAffectingProps.concat("width"),_wordJoiners:/[ \t\r]/,splitByGrapheme:!1,initDimensions:function(){this.__skipDimension||(this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.height=this.calcTextHeight(),this.saveState({propertySet:"_dimensionAffectingProps"}))},_generateStyleMap:function(n){for(var a=0,e=0,t=0,s={},c=0;c<n.graphemeLines.length;c++)n.graphemeText[t]==="\n"&&c>0?(e=0,t++,a++):!this.splitByGrapheme&&this._reSpaceAndTab.test(n.graphemeText[t])&&c>0&&(e++,t++),s[c]={line:a,offset:e},t+=n.graphemeLines[c].length,e+=n.graphemeLines[c].length;return s},styleHas:function(n,a){if(this._styleMap&&!this.isWrapping){var e=this._styleMap[a];e&&(a=e.line)}return i.Text.prototype.styleHas.call(this,n,a)},isEmptyStyles:function(n){if(!this.styles)return!0;var a,e,t=0,s=!1,c=this._styleMap[n],h=this._styleMap[n+1];for(var l in c&&(n=c.line,t=c.offset),h&&(s=h.line===n,a=h.offset),e=n===void 0?this.styles:{line:this.styles[n]})for(var d in e[l])if(d>=t&&(!s||d<a))for(var p in e[l][d])return!1;return!0},_getStyleDeclaration:function(n,a){if(this._styleMap&&!this.isWrapping){var e=this._styleMap[n];if(!e)return null;n=e.line,a=e.offset+a}return this.callSuper("_getStyleDeclaration",n,a)},_setStyleDeclaration:function(n,a,e){var t=this._styleMap[n];n=t.line,a=t.offset+a,this.styles[n][a]=e},_deleteStyleDeclaration:function(n,a){var e=this._styleMap[n];n=e.line,a=e.offset+a,delete this.styles[n][a]},_getLineStyle:function(n){var a=this._styleMap[n];return!!this.styles[a.line]},_setLineStyle:function(n){var a=this._styleMap[n];this.styles[a.line]={}},_wrapText:function(n,a){var e,t=[];for(this.isWrapping=!0,e=0;e<n.length;e++)t=t.concat(this._wrapLine(n[e],e,a));return this.isWrapping=!1,t},_measureWord:function(n,a,e){var t,s=0;e=e||0;for(var c=0,h=n.length;c<h;c++)s+=this._getGraphemeBox(n[c],a,c+e,t,!0).kernedWidth,t=n[c];return s},_wrapLine:function(n,a,e,t){var s=0,c=this.splitByGrapheme,h=[],l=[],d=c?i.util.string.graphemeSplit(n):n.split(this._wordJoiners),p="",m=0,b=c?"":" ",y=0,w=0,T=0,k=!0,P=this._getWidthOfCharSpacing();t=t||0,d.length===0&&d.push([]),e-=t;for(var G=0;G<d.length;G++)p=c?d[G]:i.util.string.graphemeSplit(d[G]),y=this._measureWord(p,a,m),m+=p.length,(s+=w+y-P)>e&&!k?(h.push(l),l=[],s=y,k=!0):s+=P,k||c||l.push(b),l=l.concat(p),w=c?0:this._measureWord([b],a,m),m++,k=!1,y>T&&(T=y);return G&&h.push(l),T+t>this.dynamicMinWidth&&(this.dynamicMinWidth=T-P+t),h},isEndOfWrapping:function(n){return!this._styleMap[n+1]||this._styleMap[n+1].line!==this._styleMap[n].line},missingNewlineOffset:function(n){return this.splitByGrapheme?this.isEndOfWrapping(n)?1:0:1},_splitTextIntoLines:function(n){for(var a=i.Text.prototype._splitTextIntoLines.call(this,n),e=this._wrapText(a.lines,this.width),t=new Array(e.length),s=0;s<e.length;s++)t[s]=e[s].join("");return a.lines=t,a.graphemeLines=e,a},getMinWidth:function(){return Math.max(this.minWidth,this.dynamicMinWidth)},_removeExtraneousStyles:function(){var n={};for(var a in this._styleMap)this._textLines[a]&&(n[this._styleMap[a].line]=1);for(var a in this.styles)n[a]||delete this.styles[a]},toObject:function(n){return this.callSuper("toObject",["minWidth","splitByGrapheme"].concat(n))}}),i.Textbox.fromObject=function(n,a){return i.Object._fromObject("Textbox",n,a,"text")}}(o),function(){var r=g.controlsUtils,i=r.scaleSkewCursorStyleHandler,n=r.scaleCursorStyleHandler,a=r.scalingEqually,e=r.scalingYOrSkewingX,t=r.scalingXOrSkewingY,s=r.scaleOrSkewActionName,c=g.Object.prototype.controls;if(c.ml=new g.Control({x:-.5,y:0,cursorStyleHandler:i,actionHandler:t,getActionName:s}),c.mr=new g.Control({x:.5,y:0,cursorStyleHandler:i,actionHandler:t,getActionName:s}),c.mb=new g.Control({x:0,y:.5,cursorStyleHandler:i,actionHandler:e,getActionName:s}),c.mt=new g.Control({x:0,y:-.5,cursorStyleHandler:i,actionHandler:e,getActionName:s}),c.tl=new g.Control({x:-.5,y:-.5,cursorStyleHandler:n,actionHandler:a}),c.tr=new g.Control({x:.5,y:-.5,cursorStyleHandler:n,actionHandler:a}),c.bl=new g.Control({x:-.5,y:.5,cursorStyleHandler:n,actionHandler:a}),c.br=new g.Control({x:.5,y:.5,cursorStyleHandler:n,actionHandler:a}),c.mtr=new g.Control({x:0,y:-.5,actionHandler:r.rotationWithSnapping,cursorStyleHandler:r.rotationStyleHandler,offsetY:-40,withConnection:!0,actionName:"rotate"}),g.Textbox){var h=g.Textbox.prototype.controls={};h.mtr=c.mtr,h.tr=c.tr,h.br=c.br,h.tl=c.tl,h.bl=c.bl,h.mt=c.mt,h.mb=c.mb,h.mr=new g.Control({x:.5,y:0,actionHandler:r.changeWidth,cursorStyleHandler:i,actionName:"resizing"}),h.ml=new g.Control({x:-.5,y:0,actionHandler:r.changeWidth,cursorStyleHandler:i,actionName:"resizing"})}}()},192:()=>{},898:()=>{},245:()=>{}},ti={};function Ke(f){var o=ti[f];if(o!==void 0)return o.exports;var u=ti[f]={exports:{}};return Ii[f](u,u.exports,Ke),u.exports}Ke.d=(f,o)=>{for(var u in o)Ke.o(o,u)&&!Ke.o(f,u)&&Object.defineProperty(f,u,{enumerable:!0,get:o[u]})},Ke.o=(f,o)=>Object.prototype.hasOwnProperty.call(f,o);var ai={};(()=>{let f;Ke.d(ai,{R:()=>f}),f=typeof document<"u"&&typeof window<"u"?Ke(653).fabric:{version:"5.2.1"}})();var ke=ai.R;/*!
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Camera Enhancer JS Edition
 * @website https://www.dynamsoft.com
 * @copyright Copyright 2022, Dynamsoft Corporation
 * @author Dynamsoft
 * @version 3.0.1 (js 20220803)
 * @fileoverview Dynamsoft JavaScript Library for Camera Enhancer
 * More info on DCE JS: https://www.dynamsoft.com/camera-enhancer/docs/programming/javascript/?ver=latest
 */function we(f,o,u,_){return new(u||(u=Promise))(function(v,C){function S(I){try{L(_.next(I))}catch(E){C(E)}}function x(I){try{L(_.throw(I))}catch(E){C(E)}}function L(I){var E;I.done?v(I.value):(E=I.value,E instanceof u?E:new u(function(F){F(E)})).then(S,x)}L((_=_.apply(f,o||[])).next())})}const _t=typeof self>"u";let tt,Be,at,gt,De;if(typeof navigator<"u"&&(tt=navigator,Be=tt.userAgent,at=tt.platform,gt=tt.mediaDevices),!_t){const f={init:function(){this.browser=this.searchString(this.dataBrowser)||"unknownBrowser",this.version=this.searchVersion(Be)||this.searchVersion(tt.appVersion)||0,this.OS=this.searchString(this.dataOS)||"unknownOS",this.OS=="Linux"&&Be.indexOf("Windows NT")!=-1&&(this.OS="HarmonyOS")},searchString:function(o){for(let u=0;u<o.length;u++){let _=o[u].string,v=o[u].prop;if(this.versionSearchString=o[u].versionSearch||o[u].identity,_){if(_.indexOf(o[u].subString)!=-1)return o[u].identity}else if(v)return o[u].identity}},searchVersion:function(o){let u=o.indexOf(this.versionSearchString);if(u!=-1)return parseFloat(o.substring(u+this.versionSearchString.length+1))},dataBrowser:[{string:Be,subString:"Edge",identity:"Edge"},{string:Be,subString:"OPR",identity:"OPR"},{string:Be,subString:"Chrome",identity:"Chrome"},{string:tt.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{string:Be,subString:"Firefox",identity:"Firefox"},{string:Be,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"}],dataOS:[{string:Be,subString:"HarmonyOS",identity:"HarmonyOS"},{string:Be,subString:"Android",identity:"Android"},{string:Be,subString:"iPhone",identity:"iPhone"},{string:at,subString:"Win",identity:"Windows"},{string:at,subString:"Mac",identity:"Mac"},{string:at,subString:"Linux",identity:"Linux"}]};f.init(),De={browser:f.browser,version:f.version,OS:f.OS}}_t&&(De={browser:"ssr",version:0,OS:"ssr"});const Ai=typeof WebAssembly<"u"&&Be&&!(/Safari/.test(Be)&&!/Chrome/.test(Be)&&/\(.+\s11_2_([2-6]).*\)/.test(Be)),Di=!(typeof Worker>"u"),hi=!(!gt||!gt.getUserMedia),Ri=async()=>{let f=!1;if(hi)try{(await gt.getUserMedia({video:!0})).getTracks().forEach(o=>{o.stop()}),f=!0}catch(o){}return f};De.browser==="Chrome"&&De.version>66||De.browser==="Safari"&&De.version>13||De.browser==="OPR"&&De.version>43||De.browser==="Edge"&&De.version;const Mi=(()=>{if(!_t&&document.currentScript){let f=document.currentScript.src,o=f.indexOf("?");if(o!=-1)f=f.substring(0,o);else{let u=f.indexOf("#");u!=-1&&(f=f.substring(0,u))}return f.substring(0,f.lastIndexOf("/")+1)}return"./"})();class ze{constructor(o,u){this._zIndex=null,this._drawingLayer=null,this._drawingLayerId=null,this._mapStyle=new Map,this.mapEvents=new Map([["select",[]],["deselect",[]]]),this.isDrawingItem=!0,this._setFabricObject(o),this._mediaType=o.type,this.styleSelector="default",this.styleId=u;for(let _ of ze.arrStyleSelectors)this._mapStyle.set(_,null)}get mediaType(){return this._mediaType}get drawingLayerId(){return this._drawingLayerId}_setFabricObject(o){this._fabricObject=o;const u=this.mapEvents;this._fabricObject.onSelect=()=>{this.styleSelector="selected";const _=this.mapEvents.get("select");for(let v of _)v&&v.apply(this)},this._fabricObject.onDeselect=()=>{this.styleSelector="default";const _=u.get("deselect");for(let v of _)v&&v.apply(this)},o.getDrawingItem=()=>this}_getFabricObject(){return this._fabricObject}on(o,u,_){const v=this.mapEvents.get(o);v.includes(u)||v.push(u)}off(o,u){const _=this.mapEvents.get(o),v=_.indexOf(u);v!==-1&&_.splice(v,1)}_setEditable(o){const u=this._fabricObject;o?(u.selectable=!0,u.evented=!0,u.hasControls=!0):(u.selectable=!1,u.evented=!1,u.hasControls=!1)}_extendSet(o,u){return!1}_extendGet(o){}set(o,u){this._extendSet(o,u)||(o==="x"?this._fabricObject.set("left",u):o==="y"?this._fabricObject.set("top",u):this._fabricObject.set(o,u)),["vertices","left","top","width","height","scaleX","scaleY","skewX","skewY","padding","angle","strokeWidth"].includes(o)&&this._fabricObject.setCoords()}get(o){let u=this._extendGet(o);return u===void 0&&(u=o==="x"?this._fabricObject.get("left"):o==="y"?this._fabricObject.get("top"):this._fabricObject.get(o)),u}}ze.arrMediaTypes=["rect","arc","polygon","image","text","line","path"],ze.arrStyleSelectors=["default","selected"];typeof document<"u"&&typeof window<"u"&&(ke.StaticCanvas.prototype.dispose=function(){return this.isRendering&&(ke.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(f){f.dispose&&f.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),ke.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},ke.Object.prototype.transparentCorners=!1,ke.Object.prototype.cornerSize=20,ke.Object.prototype.touchCornerSize=100,ke.Object.prototype.cornerColor="rgb(254,142,20)",ke.Object.prototype.cornerStyle="circle",ke.Object.prototype.strokeUniform=!0,ke.Object.prototype.hasBorders=!1,ke.ActiveSelection.prototype.onDeselect=function(){return this.getObjects().forEach(f=>{setTimeout(f.onDeselect,0)}),this.destroy(),!1},ke.Canvas.prototype.containerClass="",ke.Canvas.prototype.getPointer=function(f,o){if(this._absolutePointer&&!o)return this._absolutePointer;if(this._pointer&&o)return this._pointer;var u,_=this.upperCanvasEl,v=ke.util.getPointer(f,_),C=_.getBoundingClientRect(),S=C.width||0,x=C.height||0;S&&x||("top"in C&&"bottom"in C&&(x=Math.abs(C.top-C.bottom)),"right"in C&&"left"in C&&(S=Math.abs(C.right-C.left))),this.calcOffset(),v.x=v.x-this._offset.left,v.y=v.y-this._offset.top,o||(v=this.restorePointerVpt(v));var L=this.getRetinaScaling();if(L!==1&&(v.x/=L,v.y/=L),S!==0&&x!==0){var I=window.getComputedStyle(_).objectFit,E=_.width,F=_.height,M=S,q=x;u={width:E/M,height:F/q};var se,K,J=E/F,le=M/q;return I==="contain"?J>le?(se=M,K=M/J,{x:v.x*u.width,y:(v.y-(q-K)/2)*u.width}):(se=q*J,K=q,{x:(v.x-(M-se)/2)*u.height,y:v.y*u.height}):I==="cover"?J>le?{x:(E-u.height*M)/2+v.x*u.height,y:v.y*u.height}:{x:v.x*u.width,y:(F-u.width*q)/2+v.y*u.width}:{x:v.x*u.width,y:v.y*u.height}}return u={width:1,height:1},{x:v.x*u.width,y:v.y*u.height}});class Li{constructor(o,u,_,v){let C,S;switch(this.mapMediaType_Style=new Map,this.mode="viewer",this.onSelectionChange=null,this._arrDrwaingItem=[],this._arrFabricObject=[],this._visible=!0,o.hasOwnProperty("getFabricCanvas")?this.fabricCanvas=o.getFabricCanvas():(this.fabricCanvas=new ke.Canvas(o,v),this.fabricCanvas.setDimensions({width:"100%",height:"100%"},{cssOnly:!0}),this.fabricCanvas.lowerCanvasEl.className="",this.fabricCanvas.upperCanvasEl.className="",this.fabricCanvas.on("selection:created",function(x){const L=x.selected,I=[];for(let E of L){const F=E.getDrawingItem()._drawingLayer;F&&!I.includes(F)&&I.push(F)}for(let E of I){const F=[];for(let M of L){const q=M.getDrawingItem();q._drawingLayer===E&&F.push(q)}setTimeout(()=>{E.onSelectionChange&&E.onSelectionChange(F,[])},0)}}),this.fabricCanvas.on("before:selection:cleared",function(x){const L=this.getActiveObjects(),I=[];for(let E of L){const F=E.getDrawingItem()._drawingLayer;F&&!I.includes(F)&&I.push(F)}for(let E of I){const F=[];for(let M of L){const q=M.getDrawingItem();q._drawingLayer===E&&F.push(q)}setTimeout(()=>{const M=[];for(let q of F)E.hasDrawingItem(q)&&M.push(q);M.length>0&&E.onSelectionChange&&E.onSelectionChange([],M)},0)}}),this.fabricCanvas.on("selection:updated",function(x){const L=x.selected,I=x.deselected,E=[];for(let F of L){const M=F.getDrawingItem()._drawingLayer;M&&!E.includes(M)&&E.push(M)}for(let F of I){const M=F.getDrawingItem()._drawingLayer;M&&!E.includes(M)&&E.push(M)}for(let F of E){const M=[],q=[];for(let se of L){const K=se.getDrawingItem();K._drawingLayer===F&&M.push(K)}for(let se of I){const K=se.getDrawingItem();K._drawingLayer===F&&q.push(K)}setTimeout(()=>{F.onSelectionChange&&F.onSelectionChange(M,q)},0)}}),this.fabricCanvas.wrapperEl.style.position="absolute",o.getFabricCanvas=()=>this.fabricCanvas),this.id=u,this._mapDrawingStyles=_,u){case 1:C=_.get(1),S=_.get(5);break;case 2:C=_.get(2),S=_.get(6);break;case 3:C=_.get(3),S=_.get(7);break;default:C=_.get(4),S=_.get(8)}for(let x of ze.arrMediaTypes)this.mapMediaType_Style.set(x,{default:C,selected:S})}getId(){return this.id}_getDrawingStyle(o,u){if(typeof o!="number")throw new Error("Invalid style id.");const _=this._mapDrawingStyles.get(o);return _?u?JSON.parse(JSON.stringify(_)):_:null}setVisible(o){if(o){for(let u of this._arrFabricObject)u.visible=!0;this._visible=!0}else{for(let u of this._arrFabricObject)u.visible=!1;this._visible=!1}this.fabricCanvas.renderAll()}isVisible(){return this._visible}_getItemCurrentStyleId(o){return o.styleId?o.styleId:this.mapMediaType_Style.get(o._mediaType)[o.styleSelector].styleId}_getItemCurrentStyle(o){return o.styleId?this._getDrawingStyle(o.styleId):o._mapStyle.get(o.styleSelector)||null}_changeMediaTypeCurStyleInStyleSelector(o,u,_,v){let C;switch(o){case"rect":C=this.fabricCanvas.getObjects("rect");break;case"arc":C=this.fabricCanvas.getObjects("circle");break;case"polygon":C=this.fabricCanvas.getObjects("polygon");break;case"image":C=this.fabricCanvas.getObjects("image");break;case"text":C=this.fabricCanvas.getObjects("text");break;case"line":C=this.fabricCanvas.getObjects("line");break;case"path":C=this.fabricCanvas.getObjects("path")}for(let S of C){if(!this._arrFabricObject.includes(S))continue;const x=S.getDrawingItem();x.styleSelector===u&&this._changeItemStyle(x,_,!0)}v||this.fabricCanvas.renderAll()}_changeItemStyle(o,u,_){if(!o||!u)return;const v=o._getFabricObject();typeof o.styleId=="number"&&(u=this._getDrawingStyle(o.styleId)),v.strokeWidth=u.lineWidth,u.paintMode==="fill"?(v.fill=u.fillStyle,v.stroke=u.fillStyle):u.paintMode==="stroke"?(v.fill="transparent",v.stroke=u.strokeStyle):u.paintMode==="strokeAndFill"&&(v.fill=u.fillStyle,v.stroke=u.strokeStyle),v.fontFamily&&(v.fontFamily=u.fontFamily),v.fontSize&&(v.fontSize=u.fontSize),v.group||(v.dirty=!0),_||this.fabricCanvas.renderAll()}_updateGroupItem(o,u,_){if(!o||!u)return;const v=o.getChildItems();if(_==="add"){if(v.includes(u))return;const C=u._getFabricObject();if(this.fabricCanvas.getObjects().includes(C)){if(!this._arrFabricObject.includes(C))throw new Error("Existed in other drawing layers.");u._zIndex=null}else{let S;if(u.styleId)S=this._getDrawingStyle(u.styleId);else{S=this.mapMediaType_Style.get(u._mediaType)[o.styleSelector];const x=()=>{this._changeItemStyle(u,this.mapMediaType_Style.get(u._mediaType).selected,!0)},L=()=>{this._changeItemStyle(u,this.mapMediaType_Style.get(u._mediaType).default,!0)};u.on("select",x),u.on("deselect",L),u._funcChangeStyleToSelected=x,u._funcChangeStyleToDefault=L}u._drawingLayer=this,u._drawingLayerId=this.id,this._changeItemStyle(u,S,!0)}o._fabricObject.addWithUpdate(u._getFabricObject())}else{if(_!=="remove"||!v.includes(u))return;u._zIndex=null,u._drawingLayer=null,u._drawingLayerId=null,u.off("select",u._funcChangeStyleToSelected),u.off("deselect",u._funcChangeStyleToDefault),u._funcChangeStyleToSelected=null,u._funcChangeStyleToDefault=null,o._fabricObject.removeWithUpdate(u._getFabricObject())}this.fabricCanvas.renderAll()}_addDrawingItem(o,u){let _=o._getFabricObject();const v=this.fabricCanvas.getObjects();let C,S;if(v.includes(_)){if(this._arrFabricObject.includes(_))return;throw new Error("Existed in other drawing layers.")}if(o._mediaType==="group"){C=o.getChildItems();for(let I of C)if(I._drawingLayer&&I._drawingLayer!==this)throw new Error("The childItems of DT_Group have existed in other drawing layers.")}if(u&&typeof u=="object"&&!Array.isArray(u))for(let I in u)_.set(I,u[I]);if(C){for(let I of C){if(I.styleId)S=this._getDrawingStyle(I.styleId);else{const E=this.mapMediaType_Style.get(I._mediaType);for(let q of ze.arrStyleSelectors)I._mapStyle.set(q,E[q]);S=E.default;const F=()=>{this._changeItemStyle(I,this.mapMediaType_Style.get(I._mediaType).selected,!0)},M=()=>{this._changeItemStyle(I,this.mapMediaType_Style.get(I._mediaType).default,!0)};I.on("select",F),I.on("deselect",M),I._funcChangeStyleToSelected=F,I._funcChangeStyleToDefault=M}I._drawingLayer=this,I._drawingLayerId=this.id,this._changeItemStyle(I,S,!0)}_.dirty=!0,this.fabricCanvas.renderAll()}else{if(o.styleId)S=this._getDrawingStyle(o.styleId);else{const I=this.mapMediaType_Style.get(o._mediaType);for(let M of ze.arrStyleSelectors)o._mapStyle.set(M,I[M]);S=I.default;const E=()=>{this._changeItemStyle(o,this.mapMediaType_Style.get(o._mediaType).selected)},F=()=>{this._changeItemStyle(o,this.mapMediaType_Style.get(o._mediaType).default)};o.on("select",E),o.on("deselect",F),o._funcChangeStyleToSelected=E,o._funcChangeStyleToDefault=F}this._changeItemStyle(o,S)}o._zIndex=this.id,o._drawingLayer=this,o._drawingLayerId=this.id;const x=this._arrFabricObject.length;let L=v.length;if(x)L=v.indexOf(this._arrFabricObject[x-1])+1;else for(let I=0;I<v.length;I++)if(o._zIndex<v[I].getDrawingItem()._zIndex){L=I;break}this._arrDrwaingItem.push(o),this._arrFabricObject.push(_),this._visible?_.visible=!0:_.visible=!1,this.fabricCanvas.insertAt(_,L,!1)}addDrawingItem(o){if(!o||!o.isDrawingItem)throw TypeError("Illegal drawing item.");if(this.mode==="viewer")o._setEditable(!1);else{if(this.mode!=="editor")throw new Error("Illegal 'mode'.");o._setEditable(!0)}this._addDrawingItem(o)}addDrawingItems(o){for(let u of o)this.addDrawingItem(u)}removeDrawingItem(o){if(!o||!o.isDrawingItem)throw TypeError("Illegal drawing item.");if(!this.hasDrawingItem(o))return;if(o._zIndex=null,o._drawingLayer=null,o._drawingLayerId=null,o._mediaType==="group"){const _=o.getChildItems();for(let v of _)v._zIndex=null,v._drawingLayer=null,v._drawingLayerId=null,v.off("select",v._funcChangeStyleToSelected),v.off("deselect",v._funcChangeStyleToDefault),v._funcChangeStyleToSelected=null,v._funcChangeStyleToDefault=null,v._mapStyle.clear()}else o.off("select",o._funcChangeStyleToSelected),o.off("deselect",o._funcChangeStyleToDefault),o._funcChangeStyleToSelected=null,o._funcChangeStyleToDefault=null,o._mapStyle.clear();o.styleSelector==="selected"&&(this.fabricCanvas._activeObject=null,o.styleSelector="default");const u=o._getFabricObject();this.fabricCanvas.remove(u),this._arrDrwaingItem.splice(this._arrDrwaingItem.indexOf(o),1),this._arrFabricObject.splice(this._arrFabricObject.indexOf(u),1)}removeDrawingItems(o){for(let u of o)this.removeDrawingItem(u)}setDrawingItems(o){this.clearDrawingItems(),this.addDrawingItems(o)}getDrawingItems(){return this._arrDrwaingItem}getSelectedDrawingItems(){const o=this.fabricCanvas.getActiveObjects(),u=[];for(let _ of o)this._arrFabricObject.includes(_)&&u.push(_.getDrawingItem());return u}hasDrawingItem(o){if(!o||!o.isDrawingItem)throw TypeError("Illegal drawing item.");return this._arrDrwaingItem.includes(o)}clearDrawingItems(){this.removeDrawingItems(Array.from(this._arrDrwaingItem))}setDrawingStyle(o,u,_){let v,C;if(u=u?u.toLocaleLowerCase():"all",_=_?_.toLocaleLowerCase():"all",v=typeof o=="number"?this._getDrawingStyle(o):o,u==="all"){const S=this.mapMediaType_Style.keys();for(let x of S)if(C=this.mapMediaType_Style.get(x),_==="all")for(let L of ze.arrStyleSelectors){this._changeMediaTypeCurStyleInStyleSelector(x,L,v,!0),C[L]=v;for(let I of this._arrDrwaingItem)typeof I.styleId!="number"&&I._mapStyle.set(L,v)}else{this._changeMediaTypeCurStyleInStyleSelector(x,_,v,!0),C[_]=v;for(let L of this._arrDrwaingItem)typeof L.styleId!="number"&&L._mapStyle.set(_,v)}this.fabricCanvas.renderAll()}else if(C=this.mapMediaType_Style.get(u),_==="all")for(let S of ze.arrStyleSelectors){this._changeMediaTypeCurStyleInStyleSelector(u,S,v,!0),C[S]=v;for(let x of this._arrDrwaingItem)typeof x.styleId!="number"&&x._mediaType===u&&x._mapStyle.set(S,v)}else{this._changeMediaTypeCurStyleInStyleSelector(u,_,v,!0),C[_]=v;for(let S of this._arrDrwaingItem)typeof S.styleId!="number"&&S._mediaType===u&&S._mapStyle.set(_,v)}}setMode(o){if((o=o.toLocaleLowerCase())==="viewer"){for(let u of this._arrDrwaingItem)u._setEditable(!1);this.fabricCanvas.discardActiveObject(),this.fabricCanvas.renderAll(),this.mode="viewer"}else{if(o!=="editor")throw new RangeError("Invalid value.");for(let u of this._arrDrwaingItem)u._setEditable(!0);this.mode="editor"}this._manager._switchPointerEvent()}getMode(){return this.mode}_setDimensions(o,u){this.fabricCanvas.setDimensions(o,u)}_setObjectFit(o){if(o=o.toLowerCase(),!["contain","cover"].includes(o))throw new Error("Unsupported value '".concat(o,"'."));this.fabricCanvas.lowerCanvasEl.style.objectFit=o,this.fabricCanvas.upperCanvasEl.style.objectFit=o}_getObjectFit(){return this.fabricCanvas.lowerCanvasEl.style.objectFit}renderAll(){for(let o of this._arrDrwaingItem){const u=this._getItemCurrentStyle(o);this._changeItemStyle(o,u,!0)}this.fabricCanvas.renderAll()}dispose(){this.clearDrawingItems(),this._manager._arrDrawingLayer.length===1&&(this.fabricCanvas.wrapperEl.style.pointerEvents="none",this.fabricCanvas.dispose(),this._arrDrwaingItem.length=0,this._arrFabricObject.length=0)}}class ki{constructor(){this._arrDrawingLayer=[],this._mapDrawingStyles=new Map([[1,{id:1,lineWidth:2,fillStyle:"rgba(73, 173, 245, 0.3)",strokeStyle:"rgba(73, 173, 245, 1)",paintMode:"stroke",fontFamily:"sans-serif",fontSize:10}],[2,{id:2,lineWidth:2,fillStyle:"rgba(73, 245, 73, 0.3)",strokeStyle:"rgba(73, 245, 73, 0.9)",paintMode:"strokeAndFill",fontFamily:"sans-serif",fontSize:10}],[3,{id:3,lineWidth:2,fillStyle:"rgba(254, 180, 32, 0.3)",strokeStyle:"rgba(254, 180, 32, 0.9)",paintMode:"strokeAndFill",fontFamily:"sans-serif",fontSize:10}],[4,{id:4,lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"stroke",fontFamily:"sans-serif",fontSize:10}],[5,{id:5,lineWidth:2,fillStyle:"rgba(73, 173, 245, 0.3)",strokeStyle:"rgba(73, 173, 245, 1)",paintMode:"strokeAndFill",fontFamily:"sans-serif",fontSize:10}],[6,{id:6,lineWidth:2,fillStyle:"rgba(73, 245, 73, 0.3)",strokeStyle:"rgba(73, 245, 73, 0.9)",paintMode:"strokeAndFill",fontFamily:"sans-serif",fontSize:10}],[7,{id:7,lineWidth:2,fillStyle:"rgba(254, 180, 32, 0.3)",strokeStyle:"rgba(254, 180, 32, 1)",paintMode:"strokeAndFill",fontFamily:"sans-serif",fontSize:10}],[8,{id:8,lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"strokeAndFill",fontFamily:"sans-serif",fontSize:10}]]),this._defaultStyleTemplate={lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"stroke",fontFamily:"sans-serif",fontSize:10}}createDrawingStyle(o){let u;if(o.hasOwnProperty("id")){if(this._mapDrawingStyles.has(o.id))throw new Error("Existing drawing style id.");u=o.id}else{let v=100;for(;this._mapDrawingStyles.has(v);)v++;u=v}const _=JSON.parse(JSON.stringify(o));_.id=u;for(let v in this._defaultStyleTemplate)_.hasOwnProperty(v)||(_[v]=this._defaultStyleTemplate[v]);return this._mapDrawingStyles.set(u,_),_.id}_getDrawingStyle(o,u){if(typeof o!="number")throw new Error("Invalid style id.");const _=this._mapDrawingStyles.get(o);return _?u?JSON.parse(JSON.stringify(_)):_:null}getDrawingStyle(o){return this._getDrawingStyle(o,!0)}getDrawingStyles(){return JSON.parse(JSON.stringify(Array.from(this._mapDrawingStyles.values())))}_updateDrawingStyle(o,u){const _=this._mapDrawingStyles.get(o);if(_)for(let v in u)_.hasOwnProperty(v)&&(_[v]=u[v])}updateDrawingStyle(o,u){this._updateDrawingStyle(o,u);for(let _ of this._arrDrawingLayer)_.renderAll()}createDrawingLayer(o,u){const _=C=>{for(let S of this._arrDrawingLayer)if(S.getId()===C)return!0;return!1};if(u===void 0){for(let C=100;;C++)if(!_(C)){u=C;break}}else if(_(u))throw new Error("Existed drawing layer id.");const v=new Li(o,u,this._mapDrawingStyles,{enableRetinaScaling:!1});return v._manager=this,this._arrDrawingLayer.push(v),this._switchPointerEvent(),v}deleteDrwaingLayer(o){const u=this.getDrawingLayer(o);if(!u)return;const _=this._arrDrawingLayer;u.dispose(),_.splice(_.indexOf(u),1),this._switchPointerEvent()}clearDrawingLayers(){for(let o of this._arrDrawingLayer)o.dispose();this._arrDrawingLayer.length=0}getDrawingLayer(o){for(let u of this._arrDrawingLayer)if(u.getId()===o)return u;return null}getDrawingLayers(){return Array.from(this._arrDrawingLayer)}getSelectedDrawingItems(){if(!this._arrDrawingLayer.length)return;const o=this._arrDrawingLayer[0].fabricCanvas.getActiveObjects(),u=[];for(let _ of o)u.push(_.getDrawingItem());return u}setDimensions(o,u){this._arrDrawingLayer.length&&this._arrDrawingLayer[0]._setDimensions(o,u)}setObjectFit(o){for(let u of this._arrDrawingLayer)u&&u._setObjectFit(o)}getObjectFit(){return this._arrDrawingLayer.length?this._arrDrawingLayer[0]._getObjectFit():null}setVisible(o){this._arrDrawingLayer.length&&(this._arrDrawingLayer[0].fabricCanvas.wrapperEl.style.display=o?"block":"none")}_switchPointerEvent(){if(!this._arrDrawingLayer.length)return;let o=!1;for(let u of this._arrDrawingLayer)u.getMode()==="editor"&&(o=!0);this._arrDrawingLayer[0].fabricCanvas.wrapperEl.style.pointerEvents=o?"":"none"}}class Pi{constructor(o){this._controlTarget=null,this._arrUsers=[],this._mapAction_UserArgs=new Map,this._mapProperty_UserValue=new Map,this._mapAction_Callbacks=new Map,this._controlTarget=o}setControlTarget(o){this._controlTarget=o}getControlTarget(){return this._controlTarget}register(o){this._arrUsers.includes(o)||this._arrUsers.push(o)}logout(o){const u=this._arrUsers.indexOf(o);u!==-1&&(this.clearUserDisiredAction({user:o}),this.clearUserDisiredValue({user:o}),this._arrUsers.splice(u,1))}getRegisteredUsers(){return this._arrUsers}ifUserExisted(o){return this._arrUsers.includes(o)}setDisiredValue(o,u,_,v){if(!this._arrUsers.includes(o))throw new Error("Unregistered user.");v&&(this._controlTarget[u]=_),this._mapProperty_UserValue.get(u)?this._mapProperty_UserValue.get(u).set(o,_):this._mapProperty_UserValue.set(u,new Map([[o,_]]))}clearUserDisiredValue(o){if(o&&(o.user||o.property)){if(o.property&&o.user){const u=this._mapProperty_UserValue.get(o.property);if(!u)return;u.delete(o.user)}else if(o.property)this._mapProperty_UserValue.delete(o.property);else if(o.user)for(let u of this._mapProperty_UserValue.values())u.delete(o.user)}else this._mapProperty_UserValue=new Map}getValue(o){if(!this._controlTarget)throw new Error("Control target is not set.");return this._controlTarget[o]}getPropertyDisiredValue(o){if(this._mapProperty_UserValue.get(o)){const u=[],_=this._mapProperty_UserValue.get(o);for(let v of _.values())u.push(v);return u}return null}setDisiredAction(o,u,_,v){if(!this._arrUsers.includes(o))throw new Error("Unregistered user.");return _||(_=[]),v?this._controlTarget[u](..._):(this._mapAction_UserArgs.get(u)?this._mapAction_UserArgs.get(u).set(o,_):this._mapAction_UserArgs.set(u,new Map([[o,_]])),this._render(u))}clearUserDisiredAction(o){if(o&&(o.user||o.actionName)){if(o.actionName&&o.user){const u=this._mapAction_UserArgs.get(o.actionName);if(!u)return;u.delete(o.user)}else if(o.actionName)this._mapAction_UserArgs.delete(o.actionName);else if(o.user)for(let u of this._mapAction_UserArgs.values())u.delete(o.user);this.render()}else this._mapAction_UserArgs=new Map}addCallback(o,u){const _=this._mapAction_Callbacks.get(o);_?_.push(u):this._mapAction_Callbacks.set(o,[u])}removeCallback(o,u){const _=this._mapAction_Callbacks.get(o);if(!_)return;const v=_.indexOf(u);v!==-1&&_.splice(v,1)}clearCallback(o){o?this._mapAction_Callbacks.delete(o):this._mapAction_Callbacks.clear()}_fireCallback(o){const u=this._mapAction_Callbacks.get(o);if(u)for(let _ of u){if(!_)return;setTimeout(_.bind(this._controlTarget),0)}}_render(o){const u=this._mapAction_UserArgs.get(o);if(!u)throw new Error("Unrecorded action.");if(u.size===this._arrUsers.length){let _=[];for(let v of u.values())v.length>0&&(_=v);if(this._controlTarget[o]){const v=this._controlTarget[o](..._);return this._mapAction_UserArgs.delete(o),this._fireCallback(o),v}}}render(o){if(o)return this._render(o);for(let u of this._mapAction_UserArgs.keys())this._render(u)}}class de{constructor(){this._maxCvsSideLength=void 0,this._defaultMaxCvsSideLength=null,this._predefinedResolutions=[{width:160,height:120},{width:320,height:240},{width:480,height:360},{width:640,height:480},{width:800,height:600},{width:960,height:720},{width:1280,height:720},{width:1920,height:1080},{width:2560,height:1440},{width:3840,height:2160}],this._mapCameraResolutions=new Map,this._bWebGLSupported=!0,this.extraBindings=[],this._singleFrameMode=!(navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia),this._cvsSingleFrameMode=null,this._cvsOriginalImage=null,this._imgWidth=0,this._imgHeight=0,this._singleFrameModeIpt=null,this._clickIptSingleFrameMode=()=>{if(this.singleFrameMode){if(!this._singleFrameModeIpt){const o=document.createElement("input");this._singleFrameModeIpt=o,o.setAttribute("type","file"),o.setAttribute("accept",".jpg,.jpeg,.icon,.gif,.svg,.webp,.png,.bmp"),o.setAttribute("capture",""),o.addEventListener("change",()=>we(this,void 0,void 0,function*(){const u=o.files[0];o.value="";const _=yield(I=>we(this,void 0,void 0,function*(){let E=null,F=null;if(typeof createImageBitmap<"u")try{if(E=yield createImageBitmap(I),E)return E}catch(q){}var M;return E||(F=yield(M=I,new Promise((q,se)=>{let K=URL.createObjectURL(M),J=new Image;J.dbrObjUrl=K,J.src=K,J.onload=()=>{q(J)},J.onerror=le=>{se(new Error("Can't convert blob to image : "+(le instanceof Event?le.type:le)))}}))),F}))(u),v=_ instanceof HTMLImageElement?_.naturalWidth:_.width,C=_ instanceof HTMLImageElement?_.naturalHeight:_.height;this._imgWidth=v,this._imgHeight=C;const S=I=>{const E=Date.now();if(v===0||C===0)return null;const F=this._scanRegion,M=this.getFrameSize(v,C,F,this.maxCvsSideLength);if(!M)return null;let q,se;q=v!==M.sWidth||C!==M.sHeight,se=M.sWidth!==M.dWidth||M.sHeight!==M.dHeight;const K=(()=>!(!this._bWebGLSupported||se))(),J={data:null,region:F?JSON.parse(JSON.stringify(F)):null,sx:M.sx,sy:M.sy,width:M.dWidth,height:M.dHeight,colorMode:null,timeSpent:null,timeStamp:null,isCropped:q,toCanvas:this._toCanvas,_sWidth:M.sWidth,_sHeight:M.sHeight,_bUseWebGL:null};let le;try{le=this._getImageData(I,v,C,M,null,{targetColorMode:this.frameColorMode,bUseWebGL:K})}catch($){if($.name!=="WebGLError")throw $;le=this._getImageData(I,v,C,M,null,{targetColorMode:this.frameColorMode,bUseWebGL:!1})}if(!le)return null;const ue=Date.now();return de._onLog&&de._onLog("DCE: _getVideoFrame(region?) END: "+ue),J.data=le.data,J.colorMode=le.colorMode,J._bUseWebGL=le._bUseWebGL,J.timeSpent=ue-E,J.timeStamp=ue,J};(I=>{let E=this._cvsSingleFrameMode;if(!E){if(E=document.createElement("canvas"),E.style.pointerEvents="none",!this._video)throw new Error("'video' is null.");this._video.after(E),E.style.position="absolute",E.style.width="100%",E.style.height="100%",E.style.left="0",E.style.top="0",E.style.objectFit="contain",this._cvsSingleFrameMode=E}E.width==v&&E.height==C||(E.width=v,E.height=C);const F=E.getContext("2d");F.clearRect(0,0,E.width,E.height),F.drawImage(I,0,0)})(_),this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let I of this._arrScanRegionOverlays)I&&this._updateScanRegionOverlay(I);let x;this._updateDrawingLayersSize();try{x=S(_)}catch(I){throw I}const L=this.mapCameraEvents.get("singleFrameAcquired");for(let I of L)if(I)try{const E={data:new Uint8Array(x.data),region:JSON.parse(JSON.stringify(x.region)),sx:x.sx,sy:x.sy,width:x.width,height:x.height,colorMode:x.colorMode,timeSpent:x.timeSpent,timeStamp:x.timeStamp,isCropped:x.isCropped,toCanvas:x.toCanvas,_sWidth:x._sWidth,_sHeight:x._sHeight,_bUseWebGL:x._bUseWebGL};yield I.apply(this,[E])}catch(E){console.error(E)}})),o.style.position="fixed",o.style.left="-1px",o.style.top="-1px",o.style.width="1px",o.style.height="1px",o.style.backgroundColor="transparent",o.style.color="transparent",document.body.appendChild(o)}this._singleFrameModeIpt.click()}},this.styleEls=[],this._frameColorMode=void 0,this._defaultFrameColorMode="RGBA",this.currentFSColorMode="rgba",this.ifReuseArrayBufferView=!1,this.maxVideoCvsLength=3,this._reusedCvs=null,this._reusedWebGLCvs=null,this._reusedWebGLCtx=null,this._reusedDataContainer=null,this._webGLTexture=null,this._webGLProgramInfo=null,this._webGLBuffers=null,this._recordedStates={},this._toCanvas=function(){const o=document.createElement("canvas");let u;if(o.width=this.width,o.height=this.height,this.colorMode==="grey"){u=new Uint8ClampedArray(this.width*this.height*4);for(let v=0;v<u.length;v+=4)u[v]=this.data[v/4],u[v+1]=this.data[v/4],u[v+2]=this.data[v/4],u[v+3]=255}else u=new Uint8ClampedArray(this.data);const _=new ImageData(u,this.width,this.height);return o.getContext("2d").putImageData(_,0,0),o},this._onCameraSelChange=()=>we(this,void 0,void 0,function*(){yield this.selectCamera(this._selCam.value),this._bOpen||this.stop()}),this._onResolutionSelChange=()=>we(this,void 0,void 0,function*(){let o,u;if(this._selRsl&&this._selRsl.selectedIndex!=-1){let _=this._selRsl.options[this._selRsl.selectedIndex];o=_.getAttribute("data-width"),u=_.getAttribute("data-height")}yield this.setResolution(o,u),this._bOpen||this.stop()}),this._onCloseBtnClick=()=>{this.close(!0)},this._bOpen=!1,this.isCameraEnhancer=!0,this.isDisposed=!1,this.videoSrc=null,this.videoSettings={video:{width:{ideal:1280},height:{ideal:720},facingMode:{ideal:"environment"}}},this.iPlayRound=0,this.promisePlay=null,this._ifSaveLastUsedCamera=!1,this.ifSkipCameraInspection=!1,this._allCameras=[],this._currentCamera=null,this._videoTrack=null,this._lastDeviceId=void 0,this._vc_bPlayingVideoBeforeHide=!1,this._ev_documentHideEvent=()=>{document.visibilityState==="visible"?this._vc_bPlayingVideoBeforeHide&&(De.browser=="Firefox"?this.play():this._video.play(),this._vc_bPlayingVideoBeforeHide=!1):this._video&&!this._video.paused&&(this._vc_bPlayingVideoBeforeHide=!0,this._video.pause())},this._divVideoContainer=null,this._video=null,this.videoFit="contain",this._cvsScanRegion=null,this._divScanArea=null,this._divScanLight=null,this._bgLoading=null,this._selCam=null,this._bgCamera=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this._selMinLtr=null,this._optGotMinLtr=null,this.regionMaskFillStyle="rgba(0,0,0,0.5)",this.regionMaskStrokeStyle="rgb(254,142,20)",this.regionMaskLineWidth=2,this._bShowScanRegionMask=!0,this._bShowScanRegionLaser=void 0,this._defaultBShowScanRegionLaser=!1,this._scanRegion=null,this._arrScanRegionOverlays=[],this._layerBaseCvs=null,this._cvsViewDecorator=null,this._decoratorType=[],this._decoratorArea=null,this._viewDecoratorInfo={rectangle:{lineWidth:4,strokeStyle:"rgb(254,142,20)",fillStyle:"transparent",maskFillStyle:"transparent"},focus:{lineWidth:4,strokeStyle:"rgb(254,142,20)",fillStyle:"transparent",maskFillStyle:"transparent"},crossline:{lineWidth:2,strokeStyle:"rgb(254,142,20)"},crosshair:{lineWidth:4,strokeStyle:"rgb(254,142,20)"}},this._croppingRegions=void 0,this._defaultCroppingRegions=[null],this.bIncreaseRegionIndexAuto=!0,this._croppingRegionIndex=0,this._loopInterval=void 0,this._defaultLoopInterval=0,this._maxNumberOfFramesInBuffer=void 0,this._defaultMaxNumberOfFramesInBuffer=1,this._frameQueue=[],this._bFetchingLoopStarted=!1,this._refreshInterval=void 0,this._defaultRefreshInterval=-1,this._updateLayersTimeout=100,this._updateLayers=()=>{this._resizeTimeoutId&&clearTimeout(this._resizeTimeoutId),this._resizeTimeoutId=setTimeout(()=>{if(!this.isDisposed){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let o of this._arrScanRegionOverlays)o&&this._updateScanRegionOverlay(o);this._updateDrawingLayersSize()}},this._updateLayersTimeout)},this.mapCameraEvents=new Map([["cameraOpen",[]],["cameraClose",[]],["cameraChange",[]],["resolutionChange",[]],["played",[]],["singleFrameAcquired",[]],["frameAddedToBuffer",[]]]),this._controler=null}static getVersion(){return this._version}static detectEnvironment(){return we(this,void 0,void 0,function*(){return yield(async()=>({wasm:Ai,worker:Di,getUserMedia:hi,camera:await Ri(),browser:De.browser,version:De.version,OS:De.OS}))()})}static set engineResourcePath(o){if(this._hasEngineResourceLoaded)throw new Error("`engineResourcePath` is not allowed to change after `createInstance` is called.");de._engineResourcePath=(u=>{if(u==null&&(u="./"),!_t){let _=document.createElement("a");_.href=u,u=_.href}return u.endsWith("/")||(u+="/"),u})(o)}static get engineResourcePath(){return this._engineResourcePath}static isStorageAvailable(o){let u;try{u=window[o];const _="__storage_test__";return u.setItem(_,_),u.removeItem(_),!0}catch(_){return _ instanceof DOMException&&(_.code===22||_.code===1014||_.name==="QuotaExceededError"||_.name==="NS_ERROR_DOM_QUOTA_REACHED")&&u&&u.length!==0}}static isDCEFrame(o){return!(!o||typeof o!="object"||Array.isArray(o))&&"data"in o&&"region"in o&&"sx"in o&&"sy"in o&&"width"in o&&"height"in o&&"colorMode"in o&&"timeSpent"in o&&"timeStamp"in o&&"isCropped"in o&&"toCanvas"in o&&"_sWidth"in o&&"_sHeight"in o&&"_bUseWebGL"in o}set maxCvsSideLength(o){if(o<=0)throw new Error("Invalid value.");this._maxCvsSideLength=o}get maxCvsSideLength(){if(this._maxCvsSideLength!==void 0)return this._maxCvsSideLength;if(this._controler){const o=this._controler.getPropertyDisiredValue("maxCvsSideLength");if(o&&o.length===1)return o[0]}return this._defaultMaxCvsSideLength}static set defaultUIElementURL(o){de._defaultUIElementURL=o}static get defaultUIElementURL(){var o;return(o=de._defaultUIElementURL)===null||o===void 0?void 0:o.replace("@engineResourcePath/",de.engineResourcePath)}getUIElement(){return this.UIElement}setUIElement(o){return we(this,void 0,void 0,function*(){if(this._bOpen)throw new Error("It is not allowed to change the UIElement when the camera is open.");if(typeof o=="string"||o instanceof String){if(!o.trim().startsWith("<")){let _=yield fetch(o);if(!_.ok)throw Error("setUIElement(elementOrUrl): Network Error: "+_.statusText);o=yield _.text()}if(!o.trim().startsWith("<"))throw Error("setUIElement(elementOrUrl): Can't get valid HTMLElement.");let u=document.createElement("div");u.innerHTML=o;for(let _=0;_<u.childElementCount;++_){let v=u.children[_];v instanceof HTMLStyleElement&&(this.styleEls.push(v),document.head.append(v))}(o=u.childElementCount==1?u.children[0]:u).remove()}this.UIElement=o,this._uiOriginalState={display:o&&o.style.display,inDom:document.body.contains(o)}})}appendAndShowUI(){this.UIElement&&(this.UIElement.parentNode||(this.UIElement.style.position="fixed",this.UIElement.style.left="0",this.UIElement.style.top="0",document.body.append(this.UIElement)),this.UIElement.style.display=="none"&&(this.UIElement.style.display=""))}hideUI(){this.UIElement&&(this.UIElement.style.display="none")}get singleFrameMode(){return this._singleFrameMode}set singleFrameMode(o){if(this._bOpen)throw new Error("It is not allowed to change `singleFrameMode` when the camera is open.");this._singleFrameMode=o}set frameColorMode(o){this._frameColorMode=o}get frameColorMode(){if(this._frameColorMode!==void 0)return this._frameColorMode;if(this._controler){const o=this._controler.getPropertyDisiredValue("frameColorMode");if(o&&o.length===1)return o[0]}return this._defaultFrameColorMode}set bOpen(o){if(this._bOpen=o,o){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let u of this._arrScanRegionOverlays)u&&this._updateScanRegionOverlay(u);this._updateDrawingLayersSize(),this.ifShowScanRegionMask?this.showScanRegionMask():this.hideScanRegionMask(),this.ifShowScanRegionLaser?this.showScanRegionLaser():this.hideScanRegionLaser(),this.showViewDecorator(),this.showScanRegionOverlays(),this._drawingLayersManager.setVisible(!0)}}set ifSaveLastUsedCamera(o){o?de.isStorageAvailable("localStorage")?this._ifSaveLastUsedCamera=!0:(this._ifSaveLastUsedCamera=!1,console.warn("Local storage is unavailable")):this._ifSaveLastUsedCamera=!1}get ifSaveLastUsedCamera(){return this._ifSaveLastUsedCamera}get video(){return this._video}setVideoFit(o){if(o=o.toLowerCase(),!["contain","cover"].includes(o))throw new Error("Unsupported value '".concat(o,"'."));if(this.videoFit=o,this._video&&(this._video.style.objectFit=o,!this.singleFrameMode)){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let u of this._arrScanRegionOverlays)u&&this._updateScanRegionOverlay(u);this._drawingLayersManager.setObjectFit(o)}}getVideoFit(){return this.videoFit}set ifShowScanRegionMask(o){this._bShowScanRegionMask=o,o?this.showScanRegionMask():this.hideScanRegionMask()}get ifShowScanRegionMask(){return this._bShowScanRegionMask}showScanRegionMask(){this._cvsScanRegion&&(this._cvsScanRegion.style.display=="none"&&(this._cvsScanRegion.style.display=""),this._recordedStates.maskShow=!0)}hideScanRegionMask(){this._cvsScanRegion&&(this._cvsScanRegion.style.display="none",this._recordedStates.maskShow=!1)}set ifShowScanRegionLaser(o){this._bShowScanRegionLaser=o,o?this.showScanRegionLaser():this.hideScanRegionLaser()}get ifShowScanRegionLaser(){if(this._bShowScanRegionLaser!==void 0)return this._bShowScanRegionLaser;if(this._controler){const o=this._controler.getPropertyDisiredValue("ifShowScanRegionLaser");if(o&&o.length){let u=0;for(let _ of o)_||u++;return u!==this._controler.getRegisteredUsers().length}}return this._defaultBShowScanRegionLaser}showScanRegionLaser(){this._divScanLight&&(this._divScanLight.style.display=="none"&&(this._divScanLight.style.display="block"),this._recordedStates.laserShow=!0)}hideScanRegionLaser(){this._divScanLight&&(this._divScanLight.style.display="none",this._recordedStates.laserShow=!1)}_checkValidRegion(o){return o===null||!!o&&!!(o.hasOwnProperty("regionLeft")&&o.hasOwnProperty("regionTop")&&o.hasOwnProperty("regionRight")&&o.hasOwnProperty("regionBottom")&&o.hasOwnProperty("regionMeasuredByPercentage"))&&!(o.regionLeft<0||o.regionTop<0||o.regionRight<0||o.regionBottom<0)&&(!o.regionMeasuredByPercentage||!(o.regionLeft>100||o.regionTop>100||o.regionRight>100||o.regionBottom>100))}set scanRegion(o){if(!this._checkValidRegion(o))throw new Error("Invalid region.");this._scanRegion=JSON.parse(JSON.stringify(o)),this._updateScanRegionCanvas(),this._updateScanAreaDiv();for(let u of this._arrScanRegionOverlays)u&&this._updateScanRegionOverlay(u)}setScanRegion(o){this.scanRegion=o}getScanRegion(){return JSON.parse(JSON.stringify(this._scanRegion))}_calculateCvsSize(){if(!this._bOpen)return null;let o,u,_;if(this.singleFrameMode)o=this._imgWidth,u=this._imgHeight,_="contain";else{if(!this._video)return null;o=this._video.videoWidth,u=this._video.videoHeight,_=this.getVideoFit()}return{width:o,height:u,objectFit:_}}addScanRegionOverlayCanvas(){this._assertOpen();const o=document.createElement("canvas");if(this._updateScanRegionOverlay(o),!this._scanRegionOverlayContainer){const u=document.createElement("div");if(this._scanRegionOverlayContainer=u,u.style.position="absolute",u.style.left="0",u.style.top="0",u.style.width="100%",u.style.height="100%",u.style.overflow="hidden",u.style.pointerEvents="none",this._layerBaseCvs)this._layerBaseCvs.parentElement.after(u);else if(this._cvsScanRegion)this._cvsScanRegion.before(u);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(u);else{if(!this._video)throw new Error("'video' is null.");this._video.after(u)}this._recordedStates.overlayShow=!0}return this._scanRegionOverlayContainer.append(o),this._arrScanRegionOverlays.push(o),o}removeScanRegionOverlayCanvas(o){const u=this._arrScanRegionOverlays.indexOf(o);u!==-1&&(o.remove(),this._arrScanRegionOverlays.splice(u,1))}_updateScanRegionOverlay(o){if(!o)return;const u=this._calculateCvsSize();if(!u)return;const{width:_,height:v,objectFit:C}=u;if(_<=0||v<=0)return o.width=0,void(o.height=0);const S=this._getRegionInPixels(_,v,this._scanRegion),x=this.getFrameSize(_,v,this._scanRegion,this.maxCvsSideLength),L=x.dWidth,I=x.dHeight;o.width==L&&o.height==I||(o.width=L,o.height=I);const E=window.getComputedStyle(this._video),F=parseFloat(E.width),M=parseFloat(E.height),q=F/M,se=_/v;let K,J,le,ue,$=1;C==="contain"?(q<se?($=F/_,K=0,J=(M-v*$)/2):($=M/v,K=(F-_*$)/2,J=0),K+=S.regionLeft*$,J+=S.regionTop*$,le=(S.regionRight-S.regionLeft)*$,ue=(S.regionBottom-S.regionTop)*$):C==="cover"?(se>q?($=M/v,K=S.regionLeft*$-(_*$-F)/2,J=S.regionTop*$):($=F/_,K=S.regionLeft*$,J=S.regionTop*$-(v*$-M)/2),le=(S.regionRight-S.regionLeft)*$,ue=(S.regionBottom-S.regionTop)*$):(K=0,J=0,le=0,ue=0),o.style.position="absolute",o.style.left=K+"px",o.style.top=J+"px",o.style.width=le+"px",o.style.height=ue+"px"}showScanRegionOverlays(){this._scanRegionOverlayContainer&&(this._scanRegionOverlayContainer.style.display=="none"&&(this._scanRegionOverlayContainer.style.display=""),this._recordedStates.overlayShow=!0)}hideScanRegionOverlays(){this._scanRegionOverlayContainer&&(this._scanRegionOverlayContainer.style.display="none",this._recordedStates.overlayShow=!1)}setViewDecorator(o,u){if(!o)return void(this._cvsViewDecorator&&(this._cvsViewDecorator.remove(),this._cvsViewDecorator=null));this._assertOpen();let _=[];if(typeof o=="string"?_.push(o):Array.isArray(o)&&(_=JSON.parse(JSON.stringify(o))),!this._cvsViewDecorator){if(this._cvsViewDecorator=document.createElement("canvas"),this._cvsViewDecorator.style.pointerEvents="none",this._cvsScanRegion)this._cvsScanRegion.after(this._cvsViewDecorator);else if(this._scanRegionOverlayContainer)this._scanRegionOverlayContainer.after(this._cvsViewDecorator);else if(this._layerBaseCvs)this._layerBaseCvs.parentElement.after(this._cvsViewDecorator);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(this._cvsViewDecorator);else{if(!this._video)throw new Error("'video' is null.");this._video.after(this._cvsViewDecorator)}this._recordedStates.decoratorShow=!0}this._decoratorArea=JSON.parse(JSON.stringify(u)),this._decoratorType.length=0;const v=["rectangle","focus"],C=["crossline","crosshair"];let S=!1,x=!1;for(let L of _)L=L.toLowerCase(),v.includes(L)&&!S&&(S=!0,this._decoratorType.push(L)),C.includes(L)&&!x&&(x=!0,!this._decoratorType.includes(L)&&this._decoratorType.push(L));this._updateViewDecorator()}getViewDecorator(){return{type:JSON.parse(JSON.stringify(this._decoratorType)),area:JSON.parse(JSON.stringify(this._decoratorArea)),canvas:this._cvsViewDecorator}}showViewDecorator(){this._cvsViewDecorator&&(this._cvsViewDecorator.style.display=="none"&&(this._cvsViewDecorator.style.display=""),this._recordedStates.decoratorShow=!0)}hideViewDecorator(){this._cvsViewDecorator&&(this._cvsViewDecorator.style.display="none",this._recordedStates.decoratorShow=!1)}setViewDecoratorLineWidth(o,u){if(typeof o!="string")throw new Error("The 'type' should be a string.");if(o=o.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(o))throw new Error("The type of '".concat(o,"' doesn't exist."));if(!this._viewDecoratorInfo[o].hasOwnProperty("lineWidth"))throw new Error("It is not allowed to change the property 'lineWidth' when the decorator type is '".concat(o,"'."));this._viewDecoratorInfo[o].lineWidth=u,this._updateViewDecorator()}setViewDecoratorStrokeStyle(o,u){if(typeof o!="string")throw new Error("The 'type' should be a string.");if(o=o.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(o))throw new Error("The type of '".concat(o,"' doesn't exist."));if(!this._viewDecoratorInfo[o].hasOwnProperty("strokeStyle"))throw new Error("It is not allowed to change the property 'strokeStyle' when the decorator type is '".concat(o,"'."));this._viewDecoratorInfo[o].strokeStyle=u,this._updateViewDecorator()}setViewDecoratorFillStyle(o,u){if(typeof o!="string")throw new Error("The 'type' should be a string.");if(o=o.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(o))throw new Error("The type of '".concat(o,"' doesn't exist."));if(!this._viewDecoratorInfo[o].hasOwnProperty("fillStyle"))throw new Error("It is not allowed to change the property 'fillStyle' when the decorator type is '".concat(o,"'."));this._viewDecoratorInfo[o].fillStyle=u,this._updateViewDecorator()}setViewDecoratorMaskFillStyle(o,u){if(typeof o!="string")throw new Error("The 'type' should be a string.");if(o=o.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(o))throw new Error("The type of '".concat(o,"' doesn't exist."));if(!this._viewDecoratorInfo[o].hasOwnProperty("maskFillStyle"))throw new Error("It is not allowed to change the property 'maskFillStyle' when the decorator type is '".concat(o,"'."));this._viewDecoratorInfo[o].maskFillStyle=u,this._updateViewDecorator()}_updateViewDecorator(){if(!this._bOpen||!this._cvsViewDecorator||!this._decoratorArea)return;let o;if(this.singleFrameMode)o="contain";else{if(!this._video)return;o=this.getVideoFit()}const u=this._cvsViewDecorator;u.style.position="absolute",u.style.width="100%",u.style.height="100%",u.style.left="0",u.style.top="0",u.style.objectFit=o;const _=this.getVisibleRegion(!0),v=_.regionRight-_.regionLeft,C=_.regionBottom-_.regionTop;if(u.width==v&&u.height==C||(u.width=v,u.height=C),v<=0||C<=0)return;const S=u.getContext("2d");S.clearRect(0,0,u.width,u.height);const x=this._decoratorArea.x/100*v,L=this._decoratorArea.y/100*C,I=this._decoratorArea.width/100*v,E=this._decoratorArea.height/100*C;for(let F of this._decoratorType){if(F==="rectangle"){S.fillStyle=this._viewDecoratorInfo.rectangle.maskFillStyle,S.fillRect(0,0,u.width,u.height),S.clearRect(Math.round(x),Math.round(L),Math.round(I),Math.round(E)),S.fillStyle=this._viewDecoratorInfo.rectangle.fillStyle,S.fillRect(Math.round(x),Math.round(L),Math.round(I),Math.round(E)),S.lineWidth=this._viewDecoratorInfo.rectangle.lineWidth,S.strokeStyle=this._viewDecoratorInfo.rectangle.strokeStyle;const M=S.lineWidth/2;S.strokeRect(Math.round(x-M),Math.round(L-M),Math.round(I+S.lineWidth),Math.round(E+S.lineWidth))}if(F==="focus"){S.fillStyle=this._viewDecoratorInfo.focus.maskFillStyle,S.fillRect(0,0,u.width,u.height),S.clearRect(Math.round(x),Math.round(L),Math.round(I),Math.round(E)),S.fillStyle=this._viewDecoratorInfo.focus.fillStyle,S.fillRect(Math.round(x),Math.round(L),Math.round(I),Math.round(E)),S.lineWidth=this._viewDecoratorInfo.focus.lineWidth,S.strokeStyle=this._viewDecoratorInfo.focus.strokeStyle;const M=S.lineWidth/2,q=[0,.25,.75,1],se=[0,.25,.75,1];S.beginPath();for(let K=0;K<q.length;K++)if(K==0||K==3)for(let J=0;J<se.length;J+=2)S.moveTo(Math.round(x+q[K]*I),Math.round(L+se[J]*E)),S.lineTo(Math.round(x+q[K]*I),Math.round(L+se[J+1]*E));for(let K=0;K<se.length;K++)if(K==0||K==3)for(let J=0;J<q.length;J+=2)S.moveTo(Math.round(x+q[J]*I-M),Math.round(L+se[K]*E)),S.lineTo(Math.round(x+q[J+1]*I+M),Math.round(L+se[K]*E));S.stroke()}if(F==="crossline"&&(S.beginPath(),S.lineWidth=this._viewDecoratorInfo.crossline.lineWidth,S.strokeStyle=this._viewDecoratorInfo.crossline.strokeStyle,S.moveTo(Math.round(x),Math.round(L+E/2)),S.lineTo(Math.round(x+I),Math.round(L+E/2)),S.moveTo(Math.round(x+I/2),Math.round(L)),S.lineTo(Math.round(x+I/2),Math.round(L+E)),S.stroke()),F==="crosshair"){S.beginPath();const M=.05*Math.min(I,E);S.lineWidth=this._viewDecoratorInfo.crosshair.lineWidth,S.strokeStyle=this._viewDecoratorInfo.crosshair.strokeStyle,S.moveTo(Math.round(x+(I-M)/2),Math.round(L+E/2)),S.lineTo(Math.round(x+(I+M)/2),Math.round(L+E/2)),S.moveTo(Math.round(x+I/2),Math.round(L+(E-M)/2)),S.lineTo(Math.round(x+I/2),Math.round(L+(E+M)/2)),S.stroke()}}}getVisibleRegion(o){this._assertOpen();const u=this._calculateCvsSize();if(!u)return null;const{width:_,height:v,objectFit:C}=u;let S=(()=>{const x=parseFloat(window.getComputedStyle(this._video).width),L=parseFloat(window.getComputedStyle(this._video).height);let I,E={regionBottom:v,regionRight:_,regionLeft:0,regionTop:0,regionMeasuredByPercentage:!1};return C==="cover"?x/L<_/v?(I=L/v,E.regionLeft=Math.floor((_-x/I)/2),E.regionRight=Math.ceil(_-E.regionLeft),E.regionTop=0,E.regionBottom=v):(I=x/_,E.regionTop=Math.floor((v-L/I)/2),E.regionBottom=Math.ceil(v-E.regionTop),E.regionLeft=0,E.regionRight=_):C==="none"&&(x<_&&L<v?(E.regionLeft=Math.floor((_-x)/2),E.regionRight=Math.ceil(_-E.regionLeft),E.regionTop=Math.floor((v-L)/2),E.regionBottom=Math.ceil(v-E.regionTop)):x<_?(E.regionLeft=Math.floor((_-x)/2),E.regionRight=Math.ceil(_-E.regionLeft),E.regionTop=0,E.regionBottom=v):L<v&&(E.regionTop=Math.floor((v-L)/2),E.regionBottom=Math.ceil(v-E.regionTop),E.regionLeft=0,E.regionRight=_)),E})();return o?S.regionMeasuredByPercentage=!1:(S.regionBottom=Math.ceil(S.regionBottom/v*100),S.regionRight=Math.ceil(S.regionRight/_*100),S.regionLeft=Math.floor(S.regionLeft/_*100),S.regionTop=Math.floor(S.regionTop/v*100),S.regionMeasuredByPercentage=!0),S}setScanRegionMaskStyle(o){o&&(o.fillStyle&&(this.regionMaskFillStyle=o.fillStyle),o.strokeStyle&&(this.regionMaskStrokeStyle=o.strokeStyle),o.lineWidth&&(this.regionMaskLineWidth=o.lineWidth),this._updateScanRegionCanvas())}_getRegionInPixels(o,u,_){if(!(o<=0||u<=0))return _?_.regionMeasuredByPercentage?{regionLeft:Math.round(_.regionLeft/100*o),regionTop:Math.round(_.regionTop/100*u),regionRight:Math.round(_.regionRight/100*o),regionBottom:Math.round(_.regionBottom/100*u),regionMeasuredByPercentage:!1}:JSON.parse(JSON.stringify(_)):{regionLeft:0,regionTop:0,regionRight:o,regionBottom:u,regionMeasuredByPercentage:!1}}_updateScanRegionCanvas(){if(!this._bOpen)return;const o=this._calculateCvsSize();if(!o)return;const{width:u,height:_,objectFit:v}=o;if(u<=0||_<=0)return void(this._cvsScanRegion&&(this._cvsScanRegion.width=0,this._cvsScanRegion.height=0));const C=this._getRegionInPixels(u,_,this._scanRegion);this._cvsScanRegion||(this._cvsScanRegion=document.createElement("canvas"),this._cvsScanRegion.style.pointerEvents="none",this._scanRegionOverlayContainer?this._scanRegionOverlayContainer.after(this._cvsScanRegion):this._layerBaseCvs?this._layerBaseCvs.parentElement.after(this._cvsScanRegion):this._cvsSingleFrameMode?this._cvsSingleFrameMode.after(this._cvsScanRegion):this._video.after(this._cvsScanRegion),this._recordedStates.maskShow=!0);const S=this._cvsScanRegion;S.style.position="absolute",S.style.width="100%",S.style.height="100%",S.style.left="0",S.style.top="0",S.style.objectFit=v,S.width==u&&S.height==_||(S.width=u,S.height=_);const x=S.getContext("2d");if(x.clearRect(0,0,S.width,S.height),C.regionLeft!=0||C.regionRight!=u||C.regionTop!=0||C.regionBottom!=_){const L=C.regionLeft,I=C.regionTop,E=C.regionRight-C.regionLeft,F=C.regionBottom-C.regionTop;x.fillStyle=this.regionMaskFillStyle,x.fillRect(0,0,S.width,S.height),x.clearRect(Math.round(L),Math.round(I),Math.round(E),Math.round(F)),x.strokeStyle=this.regionMaskStrokeStyle,x.lineWidth=this.regionMaskLineWidth;const M=x.lineWidth/2;x.strokeRect(Math.round(L-M),Math.round(I-M),Math.round(E+x.lineWidth),Math.round(F+x.lineWidth))}}_updateScanAreaDiv(){if(!this._bOpen)return;const o=this._calculateCvsSize();if(!o)return;const{width:u,height:_,objectFit:v}=o;if(!this._divScanArea)return;if(u<=0||_<=0)return this._divScanArea.style.width="0",void(this._divScanArea.style.height="0");const C=this._getRegionInPixels(u,_,this._scanRegion),S=window.getComputedStyle(this._video),x=parseFloat(S.width),L=parseFloat(S.height),I=x/L,E=u/_;let F,M,q,se,K=1;if(v==="contain")I<E?(K=x/u,F=0,M=(L-_*K)/2):(K=L/_,F=(x-u*K)/2,M=0),F+=C.regionLeft*K,M+=C.regionTop*K,q=(C.regionRight-C.regionLeft)*K,se=(C.regionBottom-C.regionTop)*K;else if(v==="cover")if(I<E){K=L/_,F=C.regionLeft*K-(u*K-x)/2,F=Math.max(F,0),F=Math.min(F,parseFloat(S.width)),M=C.regionTop*K;let J=C.regionRight*K-(u*K-x)/2;J=Math.max(J,0),J=Math.min(J,parseFloat(S.width)),q=J-F,se=(C.regionBottom-C.regionTop)*K}else{K=x/u,F=C.regionLeft*K,M=C.regionTop*K-(_*K-L)/2,M=Math.max(M,0),M=Math.min(M,parseFloat(S.height));let J=C.regionBottom*K-(_*K-L)/2;J=Math.max(J,0),J=Math.min(J,parseFloat(S.height)),q=(C.regionRight-C.regionLeft)*K,se=J-M}else F=0,M=0,q=0,se=0;this._divScanArea.style.left=F+"px",this._divScanArea.style.top=M+"px",this._divScanArea.style.width=q+"px",this._divScanArea.style.height=se+"px"}set croppingRegions(o){this._croppingRegions=o,this._bFetchingLoopStarted&&(this.bIncreaseRegionIndexAuto&&(this._croppingRegionIndex=0),this._fetchingLoop(!1))}get croppingRegions(){if(this._croppingRegions!==void 0)return this._croppingRegions;if(this._controler){const o=this._controler.getPropertyDisiredValue("croppingRegions");if(o&&o.length===1)return o[0]}return this._defaultCroppingRegions}set croppingRegionIndex(o){o<0?(this.bIncreaseRegionIndexAuto=!0,this._croppingRegionIndex=0):(this.bIncreaseRegionIndexAuto=!1,this._croppingRegionIndex=o)}get croppingRegionIndex(){return this._croppingRegionIndex}set loopInterval(o){if(o<0)throw new Error("'Invalid value.");this._loopInterval=o,this._bFetchingLoopStarted&&this._fetchingLoop(!1)}get loopInterval(){if(this._loopInterval!==void 0)return this._loopInterval;if(this._controler){const o=this._controler.getPropertyDisiredValue("loopInterval");if(o&&o.length===1)return o[0]}return this._defaultLoopInterval}set maxNumberOfFramesInBuffer(o){if(o<=0)throw new Error("Invalid value.");for(this._maxNumberOfFramesInBuffer=o;this._frameQueue&&this._frameQueue.length>this.maxNumberOfFramesInBuffer;)this._frameQueue.shift()}get maxNumberOfFramesInBuffer(){if(this._maxNumberOfFramesInBuffer!==void 0)return this._maxNumberOfFramesInBuffer;if(this._controler){const o=this._controler.getPropertyDisiredValue("maxNumberOfFramesInBuffer");if(o&&o.length===1)return o[0]}return this._defaultMaxNumberOfFramesInBuffer}get numberOfFramesInBuffer(){return this._frameQueue.length}set refreshInterval(o){this._refreshInterval=o}get refreshInterval(){if(this._refreshInterval!==void 0)return this._refreshInterval;if(this._controler){const o=this._controler.getPropertyDisiredValue("refreshInterval");if(o&&o.length===1)return o[0]}return this._defaultRefreshInterval}static createInstance(o){return we(this,void 0,void 0,function*(){let u=new de;(typeof o=="string"||o instanceof String)&&(o=JSON.parse(o));for(let _ in o)u[_]=o[_];return this._hasEngineResourceLoaded=!0,de.onWarning&&(location&&location.protocol==="file:"?setTimeout(()=>{de.onWarning&&de.onWarning({id:1,message:"Not using HTTP protocol, the SDK may not work correctly."})},0):location&&location.protocol!=="https:"&&setTimeout(()=>{de.onWarning&&de.onWarning({id:2,message:"Not connected via SSL (HTTPS), the SDK may not work correctly."})},0)),u._drawingLayersManager=new ki,u})}play(o,u,_,v){return we(this,void 0,void 0,function*(){if(this._video&&this.videoSrc){yield new Promise((M,q)=>{this._video.onloadedmetadata=()=>we(this,void 0,void 0,function*(){this._video&&(this._video.onloadedmetadata=null,yield this._video.play(),M())}),typeof this.videoSrc=="string"||this.videoSrc instanceof String?this._video.src=this.videoSrc:this._video.srcObject=this.videoSrc,setTimeout(()=>q(new Error("Failed to play video. Timeout.")),4e3)});const E={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};this.playCallbackInfo=JSON.parse(JSON.stringify(E));const F=this.mapCameraEvents.get("played");for(let M of F){if(!M)continue;const q=JSON.parse(JSON.stringify(E));setTimeout(()=>M.apply(this,[q]),0)}return this._recordedStates.videoPlaying=!0,E}if(this.singleFrameMode)return v&&v.notTriggerSingleFrameClick||this._clickIptSingleFrameMode(),this.playCallbackInfo={width:0,height:0,deviceId:null},JSON.parse(JSON.stringify(this.playCallbackInfo));if(!this._video)return this.playCallbackInfo=null,null;const C=++this.iPlayRound;let S=null,x=0,L=0;if(this._currentCamera&&(S=this._currentCamera.deviceId),this._video&&(x=this._video.videoWidth,L=this._video.videoHeight),this.promisePlay&&(yield this.promisePlay,C<this.iPlayRound))return this.playCallbackInfo={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId},JSON.parse(JSON.stringify(this.playCallbackInfo));this.promisePlay=(()=>we(this,void 0,void 0,function*(){var E;try{let _e=function(he){return we(this,void 0,void 0,function*(){for(let r of ue){F(),r&&(yield new Promise(i=>setTimeout(i,r))),F();{const i=he.video.deviceId;pe=i?i.exact||i.ideal||i:null}try{de._onLog&&de._onLog("DCE: ask "+JSON.stringify(he)),J=yield navigator.mediaDevices.getUserMedia(he),F();break}catch(i){$=i,de._onLog&&de._onLog("DCE: "+i.message||i)}}})};this._video&&this._video.srcObject&&this.stop(),de._onLog&&de._onLog("DCE: ======before video========");const F=()=>{if(!this._video)throw J&&J.getTracks().forEach(he=>{he.stop()}),this._videoTrack=null,this._currentCamera=null,new Error("'video' is null.")},M=this.getVideoSettings();let q;typeof M.video=="boolean"&&(M.video={});const se=["rear","back","rck","arrire","trasera","trs","traseira","posteriore","","","","","","","","","","arka","achterzijde","","baksidan","bagside","sau","bak","tylny","takakamera","belakang","","","spate","hts","zadn","darrere","zadn","","stranja","belakang",""],K=()=>{for(let he of this._allCameras){let r=he.label.toLowerCase();if(r&&se.some(i=>r.indexOf(i)!=-1)&&/\b0(\b)?/.test(r)){delete M.video.facingMode,M.video.deviceId={ideal:he.deviceId};break}}M.video.deviceId||["Android","HarmonyOS"].indexOf(De.OS)==-1||(delete M.video.facingMode,M.video.deviceId={ideal:this._allCameras[this._allCameras.length-1].deviceId})};if(o)delete M.video.facingMode,M.video.deviceId={exact:o};else if(!M.video.deviceId){if(this._lastDeviceId)delete M.video.facingMode,M.video.deviceId={exact:this._lastDeviceId};else if(this.ifSaveLastUsedCamera&&de.isStorageAvailable&&window.localStorage.getItem("dce_last_camera_id")){delete M.video.facingMode,M.video.deviceId={exact:window.localStorage.getItem("dce_last_camera_id")};const he=JSON.parse(window.localStorage.getItem("dce_last_apply_width")),r=JSON.parse(window.localStorage.getItem("dce_last_apply_height"));he&&r&&(M.video.width=he,M.video.height=r)}else if(!this.ifSkipCameraInspection){if(M.video.facingMode){if(De.OS!=="iPhone"&&De.OS!=="Mac"&&(yield this.getAllCameras(!0)),!this._video)return null;let he=M.video.facingMode;he instanceof Array&&he.length&&(he=he[0]),he=he.exact||he.ideal||he,he==="environment"&&(q=!!M.video.facingMode,K())}}}let J;u&&(M.video.width={ideal:u}),_&&(M.video.height={ideal:_}),de._onLog&&de._onLog("DCE: ======try getUserMedia========");let le,ue=[0,500],$=null,pe=null;if(yield _e(M),!J&&(de._onLog&&de._onLog("DCE: ======try getUserMedia again========"),le=JSON.parse(JSON.stringify(M)),typeof le.video=="object"&&(De.OS=="iPhone"?(u>=1280||_>=1280?le.video.width=1280:u>=640||_>=640?le.video.width=640:(u<640||_<640)&&(le.video.width=320),delete le.video.height):q&&!M.video.deviceId?(delete le.video.facingMode,this._allCameras.length&&(le.video.deviceId={ideal:this._allCameras[this._allCameras.length-1].deviceId})):le.video=!0),de._onLog&&de._onLog("DCE: "+le),yield _e(le)),J||(ue=[1e3,2e3],yield _e(M)),J||(yield _e(le)),!J)throw $;const Se=()=>{const he=J.getVideoTracks();let r,i;if(he.length&&(r=this._videoTrack=he[0]),this._video&&r){const n=r.getSettings();if(n){for(let a of this._allCameras)if(n.deviceId===a.deviceId){a._checked=!0,a.label=r.label,i=a;break}}if(!i&&pe){for(let a of this._allCameras)if(pe==a.deviceId){r.label&&(a._checked=!0,a.label=r.label),i=a;break}}}this._currentCamera=i};if(yield this.getAllCameras(!0),F(),q){Se(),K();let he=M.video.deviceId;he&&(he=he.exact||he.ideal||he);let r=(E=this._currentCamera)===null||E===void 0?void 0:E.deviceId;!he||r&&he==r||(J.getTracks().forEach(i=>{i.stop()}),ue=[0,500,1e3,2e3],yield _e(M))}F(),yield(()=>we(this,void 0,void 0,function*(){de._onLog&&de._onLog("======play video========"),yield new Promise((he,r)=>{F(),this._video.onloadedmetadata=()=>we(this,void 0,void 0,function*(){F(),this._video.onloadedmetadata=null,yield this._video.play(),he()}),this._video.srcObject=J,setTimeout(()=>r(new Error("Failed to play video. Timeout.")),4e3)})}))(),F(),de._onLog&&de._onLog("DCE: ======played video========"),this._bgLoading&&(this._bgLoading.style.animationPlayState="paused");const g=this._video.videoWidth+"x"+this._video.videoHeight;this._optGotRsl&&(this._optGotRsl.setAttribute("data-width",this._video.videoWidth),this._optGotRsl.setAttribute("data-height",this._video.videoHeight),this._optGotRsl.innerText=g,this._selRsl&&this._optGotRsl.parentNode==this._selRsl&&(this._selRsl.value="got")),de._onLog&&de._onLog("DCE: got "+g),Se(),F(),this._renderSelCameraInfo();const ye={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};ye.deviceId&&(this._lastDeviceId=ye.deviceId,this.ifSaveLastUsedCamera&&de.isStorageAvailable&&(window.localStorage.setItem("dce_last_camera_id",this._lastDeviceId),M.video.width&&M.video.height&&(window.localStorage.setItem("dce_last_apply_width",JSON.stringify(M.video.width)),window.localStorage.setItem("dce_last_apply_height",JSON.stringify(M.video.height)))));const oe=this.mapCameraEvents.get("played");for(let he of oe){if(!he)continue;const r=JSON.parse(JSON.stringify(ye));setTimeout(()=>he.apply(this,[r]),0)}if(S&&S!=ye.deviceId){const he=this.mapCameraEvents.get("cameraChange");for(let r of he){if(!r)continue;const i=JSON.parse(JSON.stringify(ye));setTimeout(()=>r.apply(this,[i]),0)}}if(x&&L&&(x!=ye.width||L!=ye.height)){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let r of this._arrScanRegionOverlays)r&&this._updateScanRegionOverlay(r);this._cvsOriginalImage||this._updateDrawingLayersSize();const he=this.mapCameraEvents.get("resolutionChange");for(let r of he){if(!r)continue;const i=JSON.parse(JSON.stringify(ye));setTimeout(()=>r.apply(this,[i]),0)}}return this.promisePlay=null,ye}catch(F){throw this.promisePlay=null,this._bgLoading&&(this._bgLoading.style.display="none"),F.name==="NotFoundError"&&(DOMException?F=new DOMException("No camera available, please use a device with an accessible camera.",F.name):(F=new Error("No camera available, please use a device with an accessible camera.")).name="NotFoundError"),F}}))();const I=yield this.promisePlay;return this.playCallbackInfo=JSON.parse(JSON.stringify(I)),this._recordedStates.videoPlaying=!0,I})}resume(){return we(this,void 0,void 0,function*(){this._assertOpen(),yield this.play(),this.ifShowScanRegionLaser&&this.showScanRegionLaser()})}pause(){this._assertOpen(),this._video&&(this._video.pause(),this._recordedStates.videoPlaying=!1),this.ifShowScanRegionLaser&&this.hideScanRegionLaser()}_bindUI(){if(!this.UIElement)throw new Error("Need to define `UIElement` before opening.");const o=[this.UIElement];for(let u=0;u<o.length;++u)for(let _ of o[u].children)o.push(_);for(let u of o){if(!this._video&&u.classList.contains("dce-video-container")){this._divVideoContainer=u;const _=document.createElement("video");_.style.position="absolute",_.style.left="0",_.style.top="0",_.style.width="100%",_.style.height="100%",_.style.objectFit=this.getVideoFit(),_.setAttribute("playsinline","true"),_.setAttribute("muted","true"),u.prepend(_),this._video=_}else!this._divScanArea&&u.classList.contains("dce-scanarea")?this._divScanArea=u:!this._divScanLight&&u.classList.contains("dce-scanlight")?this._divScanLight=u:!this._bgLoading&&u.classList.contains("dce-bg-loading")?this._bgLoading=u:!this._bgCamera&&u.classList.contains("dce-bg-camera")?this._bgCamera=u:!this._selCam&&u.classList.contains("dce-sel-camera")?this._selCam=u:!this._selRsl&&u.classList.contains("dce-sel-resolution")?(this._selRsl=u,this.videoSrc||this.singleFrameMode||this._selRsl.options.length||(this._selRsl.innerHTML=[this._optGotRsl?"":'<option class="dce-opt-gotResolution" value="got"></option>','<option data-width="3840" data-height="2160">3840x2160</option>','<option data-width="1920" data-height="1080">1920x1080</option>','<option data-width="1280" data-height="720">1280x720</option>'].join(""),this._optGotRsl=this._optGotRsl||this._selRsl.options[0])):!this._optGotRsl&&u.classList.contains("dce-opt-gotResolution")?this._optGotRsl=u:!this._btnClose&&u.classList.contains("dce-btn-close")?this._btnClose=u:!this._selMinLtr&&u.classList.contains("dlr-sel-minletter")?(this._selMinLtr=u,this._selMinLtr.options.length||(this._selMinLtr.innerHTML=[this._optGotMinLtr?"":'<option class="dlr-opt-gotMinLtr" value="got"></option>','<option value="0" selected>any letter</option>','<option value="3">3+ letters</option>','<option value="5">5+ letters</option>','<option value="8">8+ letters</option>','<option value="12">12+ letters</option>','<option value="17">17+ letters</option>','<option value="30">30+ letters</option>','<option value="50">50+ letters</option>','<option value="80">80+ letters</option>','<option value="120">120+ letters</option>'].join(""),this._optGotMinLtr=this._optGotMinLtr||this._selMinLtr.options[0])):!this._optGotMinLtr&&u.classList.contains("dlr-opt-gotMinLtr")&&(this._optGotMinLtr=u);if(this.extraBindings&&this.extraBindings.length)for(let _ of this.extraBindings)try{_(u)}catch(v){}}if(!this._video)throw this._unbindUI(),Error("Can not find the video container element with class 'dce-video-container'");this.singleFrameMode?(this._video&&(this._video.addEventListener("click",this._clickIptSingleFrameMode),this._video.style.cursor="pointer",this._video.setAttribute("title","Take a photo")),this._selCam&&(this._selCam.style.display="none"),this._selRsl&&(this._selRsl.style.display="none"),this._selMinLtr&&(this._selMinLtr.style.display="none"),this._bgCamera&&(this._bgCamera.style.display="block")):(this._selCam&&(this._selCam.style.display="block",this._selCam.addEventListener("change",this._onCameraSelChange)),this._selRsl&&(this._selRsl.style.display="block",this._selRsl.addEventListener("change",this._onResolutionSelChange)),this._selMinLtr&&(this._selMinLtr.style.display="block"),this._bgLoading&&(this._bgLoading.style.display="block")),this._btnClose&&this._btnClose.addEventListener("click",this._onCloseBtnClick),document.addEventListener("visibilitychange",this._ev_documentHideEvent),window.ResizeObserver?(this._resizeObserver||(this._resizeObserver=new ResizeObserver(u=>{for(let _ of u)_.target===this._divVideoContainer&&this._updateLayers()})),this._divVideoContainer&&this._resizeObserver.observe(this._divVideoContainer)):window.addEventListener("resize",this._updateLayers)}_unbindUI(){this.singleFrameMode?(this._video&&(this._video.removeEventListener("click",this._clickIptSingleFrameMode),this._video.style.cursor="",this._video.removeAttribute("title")),this._bgCamera&&(this._bgCamera.style.display="none")):this._bgLoading&&(this._bgLoading.style.display="none"),this._selCam&&this._selCam.removeEventListener("change",this._onCameraSelChange),this._selRsl&&this._selRsl.removeEventListener("change",this._onResolutionSelChange),this._btnClose&&this._btnClose.removeEventListener("click",this._onCloseBtnClick),this.hideScanRegionLaser(),this.hideViewDecorator(),this.hideScanRegionOverlays(),this._drawingLayersManager.setVisible(!1),this._hideOriginalImageCvs(),this._video&&(this._video.onloadedmetadata=null,this._video.remove()),this._divVideoContainer=null,this._video=null,this._selCam=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this._selMinLtr=null,this._optGotMinLtr=null,this._divScanArea=null,this._divScanLight=null,this._cvsScanRegion&&(this._cvsScanRegion.remove(),this._cvsScanRegion=null),this._singleFrameModeIpt&&(this._singleFrameModeIpt.remove(),this._singleFrameModeIpt=null),this._cvsSingleFrameMode&&(this._cvsSingleFrameMode.remove(),this._cvsSingleFrameMode=null),document.removeEventListener("visibilitychange",this._ev_documentHideEvent),window.ResizeObserver?this._resizeObserver&&this._resizeObserver.disconnect():window.removeEventListener("resize",this._updateLayers)}_assertOpen(){if(!this._bOpen)throw Error("The camera is not open.")}open(o){return we(this,void 0,void 0,function*(){this.UIElement||(yield this.setUIElement(de.defaultUIElementURL)),this._bindUI(),o&&this.appendAndShowUI();let u=yield this.play();this.bOpen=!0;const _=this.mapCameraEvents.get("cameraOpen");for(let v of _){if(!v)continue;const C=JSON.parse(JSON.stringify(u));setTimeout(()=>v.apply(this,[C]),0)}return u})}close(o){if(!this._video)return;this.stop(),this._hideOriginalImage(!1),this._unbindUI(),o&&this.hideUI(),this.stopFetchingLoop(),this.bOpen=!1;const u=this.mapCameraEvents.get("cameraClose");for(let _ of u){if(!_)continue;const v={width:0,height:0,deviceId:null};setTimeout(()=>_.apply(this,[v]),0)}}stop(){this._video&&this._video.srcObject&&(de._onLog&&de._onLog("DCE: ======stop video========"),this._video.srcObject.getTracks().forEach(o=>{o.stop()}),this._video.srcObject=null,this._videoTrack=null,this._currentCamera=null),this._video&&this.videoSrc&&(de._onLog&&de._onLog("DCE: ======stop existing video========"),this._video.pause(),this._video.currentTime=0),this._bgLoading&&(this._bgLoading.style.animationPlayState=""),this._frameQueue.length=0,this._reusedCvs&&this._reusedCvs.ctx2d&&this._reusedCvs.ctx2d.clearRect(0,0,this._reusedCvs.width,this._reusedCvs.height),this.forceLoseContext()}getAllCameras(o){return we(this,void 0,void 0,function*(){let u=yield navigator.mediaDevices.enumerateDevices();if(!o&&u&&u.length&&!u[0].deviceId){let C=yield navigator.mediaDevices.getUserMedia({video:!0});u=yield navigator.mediaDevices.enumerateDevices(),C.getTracks().forEach(S=>{S.stop()}),C=null}const _=[],v=[];if(this._allCameras)for(let C of this._allCameras)C._checked&&v.push(C);for(let C=0;C<u.length;C++){let S,x=u[C];if(x.kind=="videoinput"){for(let L of v)x.deviceId==L.deviceId&&(S=L);S||(S={},S.deviceId=x.deviceId,S.label=x.label?x.label:"camera "+C),_.push(S)}}return this._allCameras=_,de._onLog&&de._onLog("DCE: "+JSON.stringify(this._allCameras)),Promise.resolve(_)})}_renderSelCameraInfo(){if(this._selCam&&(this._selCam.innerHTML=""),this._selCam){let o;for(let u of this._allCameras){let _=document.createElement("option");_.value=u.deviceId,_.innerText=u.label,this._selCam.append(_),u.deviceId&&this._currentCamera&&this._currentCamera.deviceId==u.deviceId&&(o=_)}this._selCam.value=o?o.value:""}}getSelectedCamera(){if(!this._bOpen){let o="";const u=this.videoSettings.video.deviceId;u&&(o=u.exact||u.ideal||u);for(let _ of this._allCameras)if(_.deviceId===o)return JSON.parse(JSON.stringify(_));return{deviceId:o,label:"",_checked:!1}}return this._currentCamera}selectCamera(o){return we(this,void 0,void 0,function*(){let u="";return o&&(u=o.deviceId||o),this.videoSettings.video.deviceId={exact:u},this._bOpen?yield this.play(o.deviceId||o):null})}getResolution(){if(this._bOpen)return[this._video.videoWidth,this._video.videoHeight];{let o=0,u=0;const _=this.videoSettings.video.width,v=this.videoSettings.video.height;return _&&(o=_.exact||_.ideal||_),v&&(u=v.exact||v.ideal||v),[o,u]}}setResolution(o,u){return we(this,void 0,void 0,function*(){let _,v;return o instanceof Array?(_=o[0],v=o[1]):(_=o,v=u),this.videoSettings.video.width={ideal:_},this.videoSettings.video.height={ideal:v},this._bOpen?yield this.play(null,_,v):null})}getResolutions(o){return we(this,void 0,void 0,function*(){let u="";const _=(C,S)=>{const x=this._mapCameraResolutions.get(C);if(!x||!x.length)return!1;for(let L of x)if(L[0]===S.width&&L[1]===S.height)return!0;return!1},v=(C,S,x)=>we(this,void 0,void 0,function*(){const L={video:{deviceId:{exact:C},width:{ideal:S},height:{ideal:x}}};let I=null;try{I=yield navigator.mediaDevices.getUserMedia(L)}catch(M){return null}if(!I)return null;const E=I.getVideoTracks();let F=null;try{const M=E[0].getSettings();F={width:M.width,height:M.height}}catch(M){const q=document.createElement("video");q.srcObject=I,F={width:q.videoWidth,height:q.videoHeight},q.srcObject=null}return E.forEach(M=>{M.stop()}),F});if(!this._bOpen){const C=this.videoSettings.video.deviceId;if(!C||(u=C.hasOwnProperty("exact")?this.videoSettings.video.deviceId.exact:C.hasOwnProperty("ideal")?this.videoSettings.video.deviceId.ideal:this.videoSettings.video.deviceId,!u))return null;let S=this._mapCameraResolutions.get(u);if(S&&!o)return this._mapCameraResolutions.get(u);this._mapCameraResolutions.set(u,[]),S=this._mapCameraResolutions.get(u);for(let x of this._predefinedResolutions){const L=yield v(u,x.width,x.height);L&&!_(u,L)&&S.push([L.width,L.height])}return S}if(this._currentCamera){u=this._currentCamera.deviceId;let C=this._mapCameraResolutions.get(u);if(C&&!o)return this._mapCameraResolutions.get(u);this._mapCameraResolutions.set(u,[]),C=this._mapCameraResolutions.get(u);const S=this.getConstraints();for(let x of this._predefinedResolutions){yield this._videoTrack.applyConstraints({width:{ideal:x.width},height:{ideal:x.height}});const L=this._videoTrack.getSettings(),I={width:L.width,height:L.height};_(u,I)||C.push([I.width,I.height])}return yield this._videoTrack.applyConstraints(S),C}return null})}on(o,u){if(!this.mapCameraEvents.has(o))throw new Error("Event '".concat(o,"' is not exists."));const _=this.mapCameraEvents.get(o);_.includes(u)||_.push(u)}off(o,u){if(!this.mapCameraEvents.has(o))throw new Error("Event '".concat(o,"' is not exists."));const _=this.mapCameraEvents.get(o),v=_.indexOf(u);v!==-1&&_.splice(v,1)}offAll(o){if(o){if(typeof o=="string"){const u=this.mapCameraEvents.get(o);u&&(u.length=0)}}else for(let u of this.mapCameraEvents.values())u&&(u.length=0)}getVideoSettings(){return JSON.parse(JSON.stringify(this.videoSettings))}updateVideoSettings(o){return this.videoSettings=JSON.parse(JSON.stringify(o)),this._lastDeviceId=null,this._bOpen?this.play():Promise.resolve()}isOpen(){return this._bOpen}getCapabilities(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getCapabilities()' is unavailable in singleFrameMode.");return this._videoTrack&&this._videoTrack.getCapabilities?this._videoTrack.getCapabilities():{}}getCameraSettings(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getCameraSettings()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings():null}getConstraints(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getConstraints()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getConstraints():null}applyConstraints(o){return we(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'applyConstraints()' is unavailable in singleFrameMode.");if(!this._videoTrack)throw new Error('"_videoTrack" is null.');if(!this._videoTrack.applyConstraints)throw Error("Not supported.");return yield this._videoTrack.applyConstraints(o)})}turnOnTorch(){return we(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'turnOnTorch()' is unavailable in singleFrameMode.");if(this.getCapabilities().torch)return yield this._videoTrack.applyConstraints({advanced:[{torch:!0}]});throw Error("Not supported.")})}turnOffTorch(){return we(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'turnOffTorch()' is unavailable in singleFrameMode.");if(this.getCapabilities().torch)return yield this._videoTrack.applyConstraints({advanced:[{torch:!1}]});throw Error("Not supported.")})}setColorTemperature(o){return we(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setColorTemperature()' is unavailable in singleFrameMode.");let u=this.getCapabilities().colorTemperature;if(!u)throw Error("Not supported.");return o<u.min?o=u.min:o>u.max&&(o=u.max),yield this._videoTrack.applyConstraints({advanced:[{colorTemperature:o}]})})}setExposureCompensation(o){return we(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setExposureCompensation()' is unavailable in singleFrameMode.");let u=this.getCapabilities().exposureCompensation;if(!u)throw Error("Not supported.");return o<u.min?o=u.min:o>u.max&&(o=u.max),yield this._videoTrack.applyConstraints({advanced:[{exposureCompensation:o}]})})}setZoom(o){return we(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setZoom()' is unavailable in singleFrameMode.");let u=this.getCapabilities().zoom;if(!u)throw Error("Not supported.");return o<u.min?o=u.min:o>u.max&&(o=u.max),yield this._videoTrack.applyConstraints({advanced:[{zoom:o}]})})}setFrameRate(o){return we(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setFrameRate()' is unavailable in singleFrameMode.");let u=this.getCapabilities().frameRate;if(!u)throw Error("Not supported.");return o<u.min?o=u.min:o>u.max&&(o=u.max),yield this._videoTrack.applyConstraints({width:{ideal:Math.max(this._video.videoWidth,this._video.videoHeight)},frameRate:o})})}getFrameRate(){return this.getCameraSettings().frameRate}setFocus(o,u){return we(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setFocus()' is unavailable in singleFrameMode.");const _=this.getCapabilities().focusMode,v=this.getCapabilities().focusDistance;if(!_||!_.includes(o)||!v)throw Error("Not supported.");return u?(u<v.min?u=v.min:u>v.max&&(u=v.max),yield this._videoTrack.applyConstraints({advanced:[{focusMode:o,focusDistance:u}]})):yield this._videoTrack.applyConstraints({advanced:[{focusMode:o}]})})}getFocus(){const o=this.getCameraSettings().focusMode;return o==="continuous"?{mode:o}:{mode:o,distance:this.getCameraSettings().focusDistance}}getFrameSize(o,u,_,v){if(!o||!u)return null;let C,S,x,L,I=o,E=u;const F={regionLeft:0,regionTop:0,regionRight:I,regionBottom:E,regionMeasuredByPercentage:!1};_?(_.regionMeasuredByPercentage?(F.regionLeft=_.regionLeft*I/100,F.regionTop=_.regionTop*E/100,F.regionRight=_.regionRight*I/100,F.regionBottom=_.regionBottom*E/100):(F.regionLeft=_.regionLeft,F.regionTop=_.regionTop,F.regionRight=_.regionRight,F.regionBottom=_.regionBottom),C=F.regionLeft,S=F.regionTop,I=Math.round(F.regionRight-F.regionLeft),E=Math.round(F.regionBottom-F.regionTop)):(C=0,S=0);const M=Math.max(I,E);if(v&&v>0&&M>v){const q=v/M;I>E?(x=v,L=Math.round(E*q)):(x=Math.round(I*q),L=v)}else x=I,L=E;return x<=0||L<=0?null:{sx:C,sy:S,sWidth:I,sHeight:E,dWidth:x,dHeight:L}}getFrame(){if(this.singleFrameMode)throw Error("'getFrame()' is unavailable in singleFrameMode.");if(this._assertOpen(),this.singleFrameMode)throw new Error("'getFrame()' is unavailable in singleFrameMode.");return this._getVideoFrame(this._scanRegion)}getImage(){const o=this.getFrame();return o.pixelFormat=o.colorMode,Object.assign(Object.assign({},o),{pixelFormat:o.colorMode})}_getVideoFrame(o,u){if(this.isDisposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(this._assertOpen(),this.singleFrameMode)throw new Error("'_getVideoFrame()' is unavailable in singleFrameMode.");const _=Date.now();de._onLog&&de._onLog("DCE: _getVideoFrame() START: "+_);const v=this._video.videoWidth,C=this._video.videoHeight;if(v===0||C===0)return null;const S=this.getFrameSize(v,C,o,this.maxCvsSideLength);if(!S)return null;let x,L;x=v!==S.sWidth||C!==S.sHeight,L=S.sWidth!==S.dWidth||S.sHeight!==S.dHeight;const I=(()=>!(!this._bWebGLSupported||L))(),E={data:null,region:o?JSON.parse(JSON.stringify(o)):null,sx:S.sx,sy:S.sy,width:S.dWidth,height:S.dHeight,colorMode:null,timeSpent:null,timeStamp:null,isCropped:x,toCanvas:this._toCanvas,_sWidth:S.sWidth,_sHeight:S.sHeight,_bUseWebGL:null};let F;try{F=this._getImageData(this._video,v,C,S,u,{targetColorMode:this.frameColorMode,bUseWebGL:I})}catch(q){if(q.name!=="WebGLError")throw q;de._onLog&&de._onLog("DCE: get WebGLError, try again in canvas."),F=this._getImageData(this._video,v,C,S,u,{targetColorMode:this.frameColorMode,bUseWebGL:!1})}if(!F)return null;const M=Date.now();return de._onLog&&de._onLog("DCE: _getVideoFrame() END: "+M),E.data=F.data,E.colorMode=F.colorMode,E._bUseWebGL=F._bUseWebGL,E.timeSpent=M-_,E.timeStamp=M,E}_getImageData(o,u,_,v,C,S){if(this.isDisposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(!u||!_)return null;de._onLog&&de._onLog("DCE: _getImageData(), START: "+Date.now());const{sx:x,sy:L,sWidth:I,sHeight:E,dWidth:F,dHeight:M}=v;let q;if(q=S&&S.targetColorMode?S.targetColorMode.toLowerCase():"rgba",S&&S.bUseWebGL){de._onLog&&de._onLog("DCE:  _getImageData() in WebGL."),this._reusedWebGLCvs||(this._reusedWebGLCvs=document.createElement("canvas"));const se=this._reusedWebGLCvs;se.width==u&&se.height==_||(se.width=u,se.height=_,this._reusedWebGLCtx&&this._reusedWebGLCtx.viewport(0,0,u,_));const K=this._reusedWebGLCtx||se.getContext("webgl",{antialias:!1})||se.getContext("experimental-webgl",{antialias:!1});if(!K){de._onLog&&de._onLog("DCE: WebGL unavailable."),this._reusedWebGLCtx=null,this._bWebGLSupported=!1;const $=new Error("WebGL error: unable to initialize WebGL. Your browser or machine may not support it.");throw $.name="WebGLError",$}if(K.enable(K.SCISSOR_TEST),K.scissor(x,L,F,M),!this._reusedWebGLCtx||q!==this.currentFSColorMode){this._reusedWebGLCtx=K;const $=oe=>{const he=oe.createBuffer();oe.bindBuffer(oe.ARRAY_BUFFER,he),oe.bufferData(oe.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,1,1,-1,1]),oe.STATIC_DRAW);const r=oe.createBuffer();return oe.bindBuffer(oe.ELEMENT_ARRAY_BUFFER,r),oe.bufferData(oe.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,0,2,3]),oe.STATIC_DRAW),{position:he,indices:r}},pe=oe=>{const he=oe.createTexture();return oe.bindTexture(oe.TEXTURE_2D,he),oe.texParameteri(oe.TEXTURE_2D,oe.TEXTURE_MAG_FILTER,oe.LINEAR),oe.texParameteri(oe.TEXTURE_2D,oe.TEXTURE_MIN_FILTER,oe.LINEAR),oe.texParameteri(oe.TEXTURE_2D,oe.TEXTURE_WRAP_S,oe.CLAMP_TO_EDGE),oe.texParameteri(oe.TEXTURE_2D,oe.TEXTURE_WRAP_T,oe.CLAMP_TO_EDGE),he},_e=(oe,he,r)=>{const i=Se(oe,oe.VERTEX_SHADER,he),n=Se(oe,oe.FRAGMENT_SHADER,r),a=oe.createProgram();return oe.attachShader(a,i),oe.attachShader(a,n),oe.linkProgram(a),oe.getProgramParameter(a,oe.LINK_STATUS)?a:(alert("Unable to initialize the shader program: "+oe.getProgramInfoLog(a)),null)},Se=(oe,he,r)=>{const i=oe.createShader(he);return oe.shaderSource(i,r),oe.compileShader(i),oe.getShaderParameter(i,oe.COMPILE_STATUS)?i:(alert("An error occurred compiling the shaders: "+oe.getShaderInfoLog(i)),oe.deleteShader(i),null)},be="\n                  attribute mediump vec2 aVertexPosition;\n                  varying mediump vec2 vDirection;\n          \n                  void main( void )\n                  {\n                      gl_Position = vec4(aVertexPosition, 1.0, 1.0) * 2.0;\n                      vDirection = aVertexPosition;\n                  }\n                ";let g;g=["rgba","rbga","grba","gbra","brga","bgra"].includes(q)?q.slice(0,3):"rgb";const ye=_e(K,be,"\n                    precision mediump float;\n\n                    varying mediump vec2 vDirection;\n                    uniform sampler2D uSampler;\n                    uniform lowp float uColorFactor;\n            \n                    void main(void)\n                    {\n                        vec4 sample = texture2D(uSampler, vec2(vDirection.x * 0.5 + 0.5, vDirection.y * 0.5 + 0.5));\n                        lowp float grey = 0.21 * sample.r + 0.71 * sample.g + 0.07 * sample.b;\n                        gl_FragColor = vec4(sample.".concat(g," * (1.0 - uColorFactor) + (grey * uColorFactor), sample.a);\n                    }\n                "));this._webGLProgramInfo={program:ye,attribLocations:{vertexPosition:K.getAttribLocation(ye,"aVertexPosition")},uniformLocations:{uSampler:K.getUniformLocation(ye,"uSampler"),uColorFactor:K.getUniformLocation(ye,"uColorFactor")}},this._webGLBuffers=$(K),this._webGLTexture=pe(K),this.currentFSColorMode=q}const J=($,pe,_e)=>{const Se=$.RGBA,be=$.RGBA,g=$.UNSIGNED_BYTE;$.bindTexture($.TEXTURE_2D,pe),$.texImage2D($.TEXTURE_2D,0,Se,be,g,_e)},le=($,pe,_e,Se)=>{$.clearColor(0,0,0,1),$.clearDepth(1),$.enable($.DEPTH_TEST),$.depthFunc($.LEQUAL),$.clear($.COLOR_BUFFER_BIT|$.DEPTH_BUFFER_BIT),$.bindBuffer($.ELEMENT_ARRAY_BUFFER,_e.indices),$.useProgram(pe.program);{const ye=$.FLOAT,oe=!1,he=0,r=0;$.bindBuffer($.ARRAY_BUFFER,_e.position),$.vertexAttribPointer(pe.attribLocations.vertexPosition,2,ye,oe,he,r),$.enableVertexAttribArray(pe.attribLocations.vertexPosition)}$.activeTexture($.TEXTURE0),$.bindTexture($.TEXTURE_2D,Se),$.uniform1i(pe.uniformLocations.uSampler,0),$.uniform1f(pe.uniformLocations.uColorFactor,q==="grey"||q==="grey32"?1:0);const be=$.UNSIGNED_SHORT;$.drawElements($.TRIANGLES,6,be,0)};let ue;if(J(K,this._webGLTexture,o),le(K,this._webGLProgramInfo,this._webGLBuffers,this._webGLTexture),C){if(C.length<F*M*4)return null;ue=C}else this.ifReuseArrayBufferView||q==="grey"?(this._reusedDataContainer&&this._reusedDataContainer.length===F*M*4||(this._reusedDataContainer=new Uint8Array(F*M*4)),ue=this._reusedDataContainer):ue=new Uint8Array(F*M*4);if(K.readPixels(x,L,F,M,K.RGBA,K.UNSIGNED_BYTE,ue),K.disable(K.SCISSOR_TEST),ue[3]!==255){de._onLog&&de._onLog("DCE: WebGL drawing incorrect."),this.forceLoseContext(),this._bWebGLSupported=!1;const $=new Error("WebGL error: incorrect WebGL drawing.");throw $.name="WebGLError",$}if(q==="grey"){let $=de._onLog?Date.now():0;if(ue=new Uint8Array(new Uint32Array(ue.buffer)),C){if(C.length<ue.length)return null;C.set(ue)}de._onLog&&de._onLog("DCE: Extract grey cost: "+(Date.now()-$))}return de._onLog&&de._onLog("DCE: _getImageData() in WebGL, END: "+Date.now()),{data:ue,colorMode:q,_bUseWebGL:!0}}{de._onLog&&de._onLog("DCE:  _getImageData() in canvas."),this._reusedCvs||(this._reusedCvs=document.createElement("canvas"));const se=this._reusedCvs;se.width===F&&se.height===M||(se.width=F,se.height=M),se.ctx2d||(se.ctx2d=se.getContext("2d"));const K=se.ctx2d;K.drawImage(o,x,L,I,E,0,0,F,M);let J=K.getImageData(0,0,se.width,se.height).data;if(["rbga","grba","gbra","brga","bgra"].includes(q)){const le=q.indexOf("r"),ue=q.indexOf("g"),$=q.indexOf("b");let pe=0;le===1||le===2?pe=le:ue===2&&(pe=ue);for(let _e=0;_e<J.length;_e+=4){let Se;pe&&(Se=J[_e+pe]),J[_e+le]=J[_e],J[_e+ue]=pe===1?Se:J[_e+1],J[_e+$]=pe===2?Se:J[_e+2]}}else if(q==="grey"||q==="grey32")for(let le=0;le<J.length;le+=4){const ue=.21*J[le]+.71*J[le+1]+.07*J[le+2];J[le]=ue,J[le+1]=ue,J[le+2]=ue}if(J=q==="grey"?new Uint8Array(new Uint32Array(J.buffer)):new Uint8Array(J.buffer),C){if(C.length<J.length)return null;C.set(J)}return de._onLog&&de._onLog("DCE: _getImageData() in canvas, END: "+Date.now()),{data:J,colorMode:q,_bUseWebGL:!1}}}getCurrentRegion(){let o=null;if(this._scanRegion)o=this._scanRegion;else if(this.croppingRegions){if(this._croppingRegionIndex>=this.croppingRegions.length||this._croppingRegionIndex<0)throw new Error("The 'croppingRegionIndex' is out of bounds.");o=this.croppingRegions[this._croppingRegionIndex],this.bIncreaseRegionIndexAuto&&++this._croppingRegionIndex>=this.croppingRegions.length&&(this._croppingRegionIndex=0)}return o}_fetchingLoop(o){if(this.isDisposed)return;if(!this._bOpen||!this.isFetchingLoopStarted())return void this.stopFetchingLoop();const u=()=>{de._onLog&&de._onLog("DCE: start fetching a frame: "+Date.now());const v=this.getCurrentRegion();let C=this._getVideoFrame(v);if(!C)return void(de._onLog&&de._onLog("DCE: get a invalid frame, abandon it: "+Date.now()));for(;this._frameQueue&&this._frameQueue.length>=this.maxNumberOfFramesInBuffer;)this._frameQueue.shift();this._frameQueue.push(C),de._onLog&&de._onLog("DCE: finish fetching a frame: "+Date.now());const S=this.mapCameraEvents.get("frameAddedToBuffer");for(let x of S)x&&setTimeout(x.bind(this),0)},_=()=>{this.isDisposed||(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this.refreshInterval<=0||(this._frameLoopTimeoutId2=setTimeout(()=>{this.isDisposed||(this._bOpen&&this.isFetchingLoopStarted()?(de._onLog&&de._onLog("DCE: second timeout executes: "+Date.now()),u(),_()):this.stopFetchingLoop())},this.refreshInterval)))};o&&(this._frameQueue.length<this.maxNumberOfFramesInBuffer?(u(),this.refreshInterval>0&&_()):this.refreshInterval>0?(u(),_()):this.refreshInterval===0?u():this.refreshInterval),this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId),this._frameLoopTimeoutId=setTimeout(()=>{this.isDisposed||this._fetchingLoop(!0)},this.loopInterval)}startFetchingLoop(){if(this.isDisposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(this._assertOpen(),this.singleFrameMode)throw Error("'startFetchingLoop()' is unavailable in singleFrameMode.");this.isFetchingLoopStarted()||(this._bFetchingLoopStarted=!0,this._recordedStates.fetchingLoopStart=!0,de._onLog&&de._onLog("start fetching loop: "+Date.now()),this._fetchingLoop(!0))}isFetchingLoopStarted(){return this._bFetchingLoopStarted}stopFetchingLoop(){this._bFetchingLoopStarted&&(de._onLog&&de._onLog("stop fetching loop: "+Date.now()),this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId),this._frameQueue.length=0,this._bFetchingLoopStarted=!1,this._recordedStates.fetchingLoopStart=!1)}getFrameFromBuffer(o){return this._frameQueue&&this._frameQueue.length?o?o<this._frameQueue.length?(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this._frameQueue.splice(o,1)[0]):void 0:(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this._frameQueue.shift()):null}forceLoseContext(){if(!this._reusedWebGLCtx)return;const o=this._reusedWebGLCtx;o&&!o.isContextLost()&&o.getExtension("WEBGL_lose_context")&&o.getExtension("WEBGL_lose_context").loseContext(),this._webGLTexture=null,this._webGLProgramInfo=null,this._webGLBuffers=null,this._reusedWebGLCtx=null,this._reusedWebGLCvs=null}_createDrawingLayerBaseCvs(){this._assertOpen();const o=this._calculateCvsSize();if(!o)throw new Error("Camera is not open.");const{width:u,height:_,objectFit:v}=o;if(u<=0||_<=0)throw new Error("Invalid dimension of video or image.");const C=document.createElement("canvas");if(C.width==u&&C.height==_||(C.width=u,C.height=_),C.style.objectFit=v,this._scanRegionOverlayContainer)this._scanRegionOverlayContainer.before(C);else if(this._cvsScanRegion)this._cvsScanRegion.before(C);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(C);else{if(!this._video)throw new Error("'_video' is lost.");this._video.after(C)}return C}_updateDrawingLayersSize(o){let u;if(u=o&&o.width&&o.height&&o.objectFit?{width:o.width,height:o.height,objectFit:o.objectFit}:this._calculateCvsSize(),!u)return;const{width:_,height:v,objectFit:C}=u;this._drawingLayersManager.setDimensions({width:_,height:v},{backstoreOnly:!0}),this._drawingLayersManager.setObjectFit(C)}_createDrawingLayer(o){this._layerBaseCvs||(this._layerBaseCvs=this._createDrawingLayerBaseCvs());const u=this._layerBaseCvs;return this._drawingLayersManager.createDrawingLayer(u,o)}createDrawingLayer(){return this._createDrawingLayer()}getDrawingLayer(o){return this._drawingLayersManager.getDrawingLayer(o)||([1,2,3].includes(o)?this._createDrawingLayer(o):null)}getDrawingLayers(){return this._drawingLayersManager.getDrawingLayers()}getSelectedDrawingItems(){return this._drawingLayersManager.getSelectedDrawingItems()}createDrawingStyle(o){return this._drawingLayersManager.createDrawingStyle(o)}getDrawingStyle(o){return this._drawingLayersManager.getDrawingStyle(o)}getDrawingStyles(){return this._drawingLayersManager.getDrawingStyles()}updateDrawingStyle(o,u){return this._drawingLayersManager.updateDrawingStyle(o,u)}clearDrawingLayers(){this._drawingLayersManager.clearDrawingLayers(),this._layerBaseCvs&&(this._layerBaseCvs.remove(),this._layerBaseCvs=null)}_createControler(){if(this._controler||(this._controler=new Pi(this)),this._controler)return this._controler}_destroyControler(){this._controler=null}setOriginalImage(o,u,_){if(!o||!u||!_)throw new Error("Invalid arguments");this._originalImageData={imageData:o,width:u,height:_};let v=this._cvsOriginalImage;v||(v=document.createElement("canvas"),v.style.position="absolute",v.style.width="100%",v.style.height="100%",v.style.left="0",v.style.top="0",v.style.backgroundColor="white",v.style.objectFit="contain",this._cvsOriginalImage=v),v.width===u&&v.height===_||(v.width=u,v.height=_);const C=v.getContext("2d");C.clearRect(0,0,v.width,v.height),o instanceof Uint8Array||o instanceof Uint8ClampedArray?(o instanceof Uint8Array&&(o=new Uint8ClampedArray(o)),C.putImageData(new ImageData(o,u,_),0,0)):o instanceof HTMLCanvasElement&&C.drawImage(o,0,0),document.body.contains(v)&&v.style.display===""&&this._updateDrawingLayersSize({width:u,height:_,objectFit:"contain"})}getOriginalImage(){return this._originalImageData?Object.assign({},this._originalImageData):null}deleteOriginalImage(){return we(this,void 0,void 0,function*(){yield this.hideOriginalImage(),this._cvsOriginalImage&&(this._cvsOriginalImage.remove(),this._cvsOriginalImage=null),this._originalImageData=null})}_showOriginalImageCvs(){this._cvsOriginalImage&&this._cvsOriginalImage.style.display=="none"&&(this._cvsOriginalImage.style.display="")}_hideOriginalImageCvs(){this._cvsOriginalImage&&(this._cvsOriginalImage.style.display="none")}showOriginalImage(){if(!this._originalImageData)throw new Error("No original image is set.");const o=this._cvsOriginalImage;if(o.style.display===""&&document.body.contains(o))return;const{width:u,height:_}=this._originalImageData;if(this._updateDrawingLayersSize({width:u,height:_,objectFit:"contain"}),this._bOpen&&(this._video&&!this._video.paused&&this._video.pause(),this._bFetchingLoopStarted&&(this.stopFetchingLoop(),this._recordedStates.fetchingLoopStart=!0),this.ifShowScanRegionMask&&this._cvsScanRegion&&(this._cvsScanRegion.style.display="none"),this.ifShowScanRegionLaser&&this._divScanLight&&(this._divScanLight.style.display="none"),this._cvsViewDecorator&&(this._cvsViewDecorator.style.display="none"),this._scanRegionOverlayContainer&&(this._scanRegionOverlayContainer.style.display="none"),this._selCam&&(this._selCam.parentElement.style.display="none")),!document.body.contains(o))if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(o);else{if(!this._video)throw new Error("'video' is null.");this._video.after(o)}this._showOriginalImageCvs()}_hideOriginalImage(o){return we(this,void 0,void 0,function*(){this._originalImageData&&this._cvsOriginalImage&&this._cvsOriginalImage.style.display!=="none"&&(this._updateDrawingLayersSize(),this._bOpen&&o&&(this._video&&this._recordedStates.videoPlaying&&(yield this.play(null,null,null,{notTriggerSingleFrameClick:!0})),this._recordedStates.fetchingLoopStart&&!this.singleFrameMode&&this.startFetchingLoop(),this.ifShowScanRegionMask&&this._cvsScanRegion&&this._recordedStates.maskShow&&this.showScanRegionMask(),this.ifShowScanRegionLaser&&this._divScanLight&&this._recordedStates.laserShow&&this.showScanRegionLaser(),this._cvsViewDecorator&&this._recordedStates.decoratorShow&&this.showViewDecorator(),this._scanRegionOverlayContainer&&this._recordedStates.overlayShow&&this.showScanRegionOverlays()),this._selCam&&(this._selCam.parentElement.style.display=""),this._hideOriginalImageCvs())})}hideOriginalImage(){return we(this,void 0,void 0,function*(){return this._hideOriginalImage(!0)})}dispose(o){this.UIElement&&(this._uiOriginalState&&this._uiOriginalState.inDom?this.UIElement.style.display=this._uiOriginalState.display:this.UIElement.style.display="none"),this.clearDrawingLayers(),this.close(),this.forceLoseContext(),this.setViewDecorator(null,null),this._scanRegionOverlayContainer&&this._scanRegionOverlayContainer.remove(),this._arrScanRegionOverlays.length=0,o&&this.UIElement&&this.UIElement.remove(),this.__proto__=null;for(let u in this)delete this[u];Object.defineProperty(this,"isCameraEnhancer",{value:!0}),Object.defineProperty(this,"isDisposed",{value:!0})}}de._jsVersion="3.0.1",de._jsEditVersion="20220803",de._version="JS "+de._jsVersion+"."+de._jsEditVersion,de.browserInfo=De,de._hasEngineResourceLoaded=!1,de._engineResourcePath=Mi,de._defaultUIElementURL="@engineResourcePath/dce.ui.html";Y.engineResourcePath="https://cdn.jsdelivr.net/npm/dynamsoft-javascript-barcode@9.2.13/dist/";de.defaultUIElementURL="https://cdn.jsdelivr.net/npm/dynamsoft-camera-enhancer@3.0.1/dist/dce.ui.html";class Bi extends li{constructor(){super(...arguments),this.reader=null,this.enhancer=null,this.decoding=!1}async toggleTorch(o){var u,_;if(this.enhancer)try{o.on?await((u=this.enhancer)===null||u===void 0?void 0:u.turnOnTorch()):await((_=this.enhancer)===null||_===void 0?void 0:_.turnOffTorch())}catch(v){throw new Error("Torch unsupported")}}async stopScan(){var o;try{this.stopDecoding(),(o=this.enhancer)===null||o===void 0||o.close(!0)}catch(u){throw u}}async pauseScan(){var o;try{this.stopDecoding(),(o=this.enhancer)===null||o===void 0||o.pause()}catch(u){throw u}}async resumeScan(){var o;try{await((o=this.enhancer)===null||o===void 0?void 0:o.resume()),this.startDecoding()}catch(u){throw u}}async destroy(){var o,u;this.stopDecoding(),(o=this.enhancer)===null||o===void 0||o.dispose(!0),(u=this.reader)===null||u===void 0||u.destroyContext(),this.enhancer=null,this.reader=null}async initialize(o){return this.reader===null?(o&&o.license&&(Y.license=o.license),this.enhancer=await de.createInstance(),this.reader=await Ye.createInstance(),await this.reader.updateRuntimeSettings("balance"),this.enhancer.on("played",u=>{this.notifyListeners("onPlayed",{resolution:u.width+"x"+u.height})}),await this.enhancer.setUIElement(de.defaultUIElementURL),this.enhancer.getUIElement().getElementsByClassName("dce-btn-close")[0].remove(),this.enhancer.getUIElement().getElementsByClassName("dce-sel-camera")[0].remove(),this.enhancer.getUIElement().getElementsByClassName("dce-sel-resolution")[0].remove(),this.enhancer.getUIElement().getElementsByClassName("dce-msg-poweredby")[0].remove()):console.log("Scanner already initialized."),{success:!0}}async captureAndDecode(){if(this.enhancer==null||this.reader==null||this.enhancer.isOpen()==!1||this.decoding==!0)return;let o=this.enhancer.getFrame();if(o){this.decoding=!0;let _=await this.reader.decode(o);this.decoding=!1;let v=[];for(let C=0;C<_.length;C++){let S=_[C],x,L=0,I=0;o.isCropped==!0&&(L=o.sx,I=o.sy),x={barcodeText:S.barcodeText,barcodeFormat:S.barcodeFormatString,barcodeBytesBase64:this.arrayBufferToBase64(S.barcodeBytes),x1:S.localizationResult.x1+L,y1:S.localizationResult.y1+I,x2:S.localizationResult.x2+L,y2:S.localizationResult.y2+I,x3:S.localizationResult.x3+L,y3:S.localizationResult.y3+I,x4:S.localizationResult.x4+L,y4:S.localizationResult.y4+I},v.push(x)}var u={results:v};this.notifyListeners("onFrameRead",u)}}async setScanRegion(o){var u;return(u=this.enhancer)===null||u===void 0||u.setScanRegion({regionLeft:o.left,regionTop:o.top,regionRight:o.right,regionBottom:o.bottom,regionMeasuredByPercentage:o.measuredByPercentage}),{success:!0}}async initRuntimeSettingsWithString(o){var u;o.template&&(await((u=this.reader)===null||u===void 0?void 0:u.initRuntimeSettingsWithString(o.template)),console.log("Using template"))}async startScan(){var o;await((o=this.enhancer)===null||o===void 0?void 0:o.open(!0)),this.startDecoding()}startDecoding(){this.interval&&clearInterval(this.interval),this.decoding=!1,this.interval=setInterval(this.captureAndDecode.bind(this),100)}stopDecoding(){this.interval&&clearInterval(this.interval),this.decoding=!1}arrayBufferToBase64(o){for(var u="",_=new Uint8Array(o),v=_.byteLength,C=0;C<v;C++)u+=String.fromCharCode(_[C]);return window.btoa(u)}async getAllCameras(){if(this.enhancer){let o=await this.enhancer.getAllCameras(),u=[];return o.forEach(_=>{u.push(_.label)}),{cameras:u}}return{message:"not initialized"}}async selectCamera(o){var u;if(this.enhancer){let _=await this.enhancer.getAllCameras();for(let v=0;v<_.length;v++){const C=_[v];if(C.label===o.cameraID)return await((u=this.enhancer)===null||u===void 0?void 0:u.selectCamera(C)),{success:!0}}return{message:"not found"}}else return{message:"not initialized"}}async getSelectedCamera(){return this.enhancer?{selectedCamera:this.enhancer.getSelectedCamera().label}:{message:"not initialized"}}async getResolution(){if(this.enhancer){let o=this.enhancer.getResolution();return{resolution:o[0]+"x"+o[1]}}else return{message:"not initialized"}}async setResolution(o){if(this.enhancer){let u=o.resolution,_=1280,v=720;return u==rt.RESOLUTION_480P?(_=640,v=480):u==rt.RESOLUTION_720P?(_=1280,v=720):u==rt.RESOLUTION_1080P?(_=1920,v=1080):u==rt.RESOLUTION_2K?(_=2560,v=1440):u==rt.RESOLUTION_4K&&(_=3840,v=2160),await this.enhancer.setResolution(_,v),{success:!0}}else return{message:"not initialized"}}async setZoom(o){return this.enhancer?(await this.enhancer.setZoom(o.factor),{success:!0}):{message:"not initialized"}}setFocus(o){throw new Error("Method not implemented.")}async setEngineResourcePath(o){Y.engineResourcePath=o}async setDefaultUIElementURL(o){de.defaultUIElementURL=o}async requestCameraPermission(){const o={video:!0,audio:!1},_=(await navigator.mediaDevices.getUserMedia(o)).getTracks();for(let v=0;v<_.length;v++)_[v].stop()}}export{Bi as DBRWeb};
